var $jscomp = $jscomp || {};
$jscomp.scope = {};
$jscomp.arrayIteratorImpl = function (a) {
  var c = 0;
  return function () {
    return c < a.length ? { done: !1, value: a[c++] } : { done: !0 };
  };
};
$jscomp.arrayIterator = function (a) {
  return { next: $jscomp.arrayIteratorImpl(a) };
};
$jscomp.makeIterator = function (a) {
  var c = "undefined" != typeof Symbol && Symbol.iterator && a[Symbol.iterator];
  return c ? c.call(a) : $jscomp.arrayIterator(a);
};
$jscomp.arrayFromIterator = function (a) {
  for (var c, b = []; !(c = a.next()).done; ) b.push(c.value);
  return b;
};
$jscomp.arrayFromIterable = function (a) {
  return a instanceof Array ? a : $jscomp.arrayFromIterator($jscomp.makeIterator(a));
};
$jscomp.ASSUME_ES5 = !1;
$jscomp.ASSUME_NO_NATIVE_MAP = !1;
$jscomp.ASSUME_NO_NATIVE_SET = !1;
$jscomp.SIMPLE_FROUND_POLYFILL = !1;
$jscomp.defineProperty =
  $jscomp.ASSUME_ES5 || "function" == typeof Object.defineProperties
    ? Object.defineProperty
    : function (a, c, b) {
        a != Array.prototype && a != Object.prototype && (a[c] = b.value);
      };
$jscomp.getGlobal = function (a) {
  return "undefined" != typeof window && window === a
    ? a
    : "undefined" != typeof global && null != global
      ? global
      : a;
};
$jscomp.global = $jscomp.getGlobal(this);
$jscomp.polyfill = function (a, c, b, d) {
  if (c) {
    b = $jscomp.global;
    a = a.split(".");
    for (d = 0; d < a.length - 1; d++) {
      var e = a[d];
      e in b || (b[e] = {});
      b = b[e];
    }
    a = a[a.length - 1];
    d = b[a];
    c = c(d);
    c != d &&
      null != c &&
      $jscomp.defineProperty(b, a, { configurable: !0, writable: !0, value: c });
  }
};
$jscomp.polyfill(
  "Array.from",
  function (a) {
    return a
      ? a
      : function (a, b, d) {
          b =
            null != b
              ? b
              : function (a) {
                  return a;
                };
          var c = [],
            f = "undefined" != typeof Symbol && Symbol.iterator && a[Symbol.iterator];
          if ("function" == typeof f) {
            a = f.call(a);
            for (var g = 0; !(f = a.next()).done; ) c.push(b.call(d, f.value, g++));
          } else for (f = a.length, g = 0; g < f; g++) c.push(b.call(d, a[g], g));
          return c;
        };
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "Math.asinh",
  function (a) {
    return a
      ? a
      : function (a) {
          a = Number(a);
          if (0 === a) return a;
          var b = Math.log(Math.abs(a) + Math.sqrt(a * a + 1));
          return 0 > a ? -b : b;
        };
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "Math.sinh",
  function (a) {
    if (a) return a;
    var c = Math.exp;
    return function (a) {
      a = Number(a);
      return 0 === a ? a : (c(a) - c(-a)) / 2;
    };
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "Math.sign",
  function (a) {
    return a
      ? a
      : function (a) {
          a = Number(a);
          return 0 === a || isNaN(a) ? a : 0 < a ? 1 : -1;
        };
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "Object.is",
  function (a) {
    return a
      ? a
      : function (a, b) {
          return a === b ? 0 !== a || 1 / a === 1 / b : a !== a && b !== b;
        };
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "Array.prototype.includes",
  function (a) {
    return a
      ? a
      : function (a, b) {
          var c = this;
          c instanceof String && (c = String(c));
          var e = c.length;
          b = b || 0;
          for (0 > b && (b = Math.max(b + e, 0)); b < e; b++) {
            var f = c[b];
            if (f === a || Object.is(f, a)) return !0;
          }
          return !1;
        };
  },
  "es7",
  "es3"
);
$jscomp.checkStringArgs = function (a, c, b) {
  if (null == a)
    throw new TypeError(
      "The 'this' value for String.prototype." + b + " must not be null or undefined"
    );
  if (c instanceof RegExp)
    throw new TypeError(
      "First argument to String.prototype." + b + " must not be a regular expression"
    );
  return a + "";
};
$jscomp.polyfill(
  "String.prototype.includes",
  function (a) {
    return a
      ? a
      : function (a, b) {
          return -1 !== $jscomp.checkStringArgs(this, a, "includes").indexOf(a, b || 0);
        };
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "Number.isNaN",
  function (a) {
    return a
      ? a
      : function (a) {
          return "number" === typeof a && isNaN(a);
        };
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "Number.isFinite",
  function (a) {
    return a
      ? a
      : function (a) {
          return "number" !== typeof a ? !1 : !isNaN(a) && Infinity !== a && -Infinity !== a;
        };
  },
  "es6",
  "es3"
);
$jscomp.findInternal = function (a, c, b) {
  a instanceof String && (a = String(a));
  for (var d = a.length, e = 0; e < d; e++) {
    var f = a[e];
    if (c.call(b, f, e, a)) return { i: e, v: f };
  }
  return { i: -1, v: void 0 };
};
$jscomp.polyfill(
  "Array.prototype.find",
  function (a) {
    return a
      ? a
      : function (a, b) {
          return $jscomp.findInternal(this, a, b).v;
        };
  },
  "es6",
  "es3"
);
$jscomp.SYMBOL_PREFIX = "jscomp_symbol_";
$jscomp.initSymbol = function () {
  $jscomp.initSymbol = function () {};
  $jscomp.global.Symbol || ($jscomp.global.Symbol = $jscomp.Symbol);
};
$jscomp.SymbolClass = function (a, c) {
  this.$jscomp$symbol$id_ = a;
  $jscomp.defineProperty(this, "description", { configurable: !0, writable: !0, value: c });
};
$jscomp.SymbolClass.prototype.toString = function () {
  return this.$jscomp$symbol$id_;
};
$jscomp.Symbol = (function () {
  function a(b) {
    if (this instanceof a) throw new TypeError("Symbol is not a constructor");
    return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX + (b || "") + "_" + c++, b);
  }
  var c = 0;
  return a;
})();
$jscomp.initSymbolIterator = function () {
  $jscomp.initSymbol();
  var a = $jscomp.global.Symbol.iterator;
  a || (a = $jscomp.global.Symbol.iterator = $jscomp.global.Symbol("Symbol.iterator"));
  "function" != typeof Array.prototype[a] &&
    $jscomp.defineProperty(Array.prototype, a, {
      configurable: !0,
      writable: !0,
      value: function () {
        return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this));
      },
    });
  $jscomp.initSymbolIterator = function () {};
};
$jscomp.initSymbolAsyncIterator = function () {
  $jscomp.initSymbol();
  var a = $jscomp.global.Symbol.asyncIterator;
  a || (a = $jscomp.global.Symbol.asyncIterator = $jscomp.global.Symbol("Symbol.asyncIterator"));
  $jscomp.initSymbolAsyncIterator = function () {};
};
$jscomp.iteratorPrototype = function (a) {
  $jscomp.initSymbolIterator();
  a = { next: a };
  a[$jscomp.global.Symbol.iterator] = function () {
    return this;
  };
  return a;
};
$jscomp.iteratorFromArray = function (a, c) {
  $jscomp.initSymbolIterator();
  a instanceof String && (a += "");
  var b = 0,
    d = {
      next: function () {
        if (b < a.length) {
          var e = b++;
          return { value: c(e, a[e]), done: !1 };
        }
        d.next = function () {
          return { done: !0, value: void 0 };
        };
        return d.next();
      },
    };
  d[Symbol.iterator] = function () {
    return d;
  };
  return d;
};
$jscomp.polyfill(
  "Array.prototype.keys",
  function (a) {
    return a
      ? a
      : function () {
          return $jscomp.iteratorFromArray(this, function (a) {
            return a;
          });
        };
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "String.prototype.startsWith",
  function (a) {
    return a
      ? a
      : function (a, b) {
          var c = $jscomp.checkStringArgs(this, a, "startsWith");
          a += "";
          var e = c.length,
            f = a.length;
          b = Math.max(0, Math.min(b | 0, c.length));
          for (var g = 0; g < f && b < e; ) if (c[b++] != a[g++]) return !1;
          return g >= f;
        };
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "Number.parseFloat",
  function (a) {
    return a || parseFloat;
  },
  "es6",
  "es3"
);
$jscomp.polyfill(
  "Math.log10",
  function (a) {
    return a
      ? a
      : function (a) {
          return Math.log(a) / Math.LN10;
        };
  },
  "es6",
  "es3"
);
var Module;
"object" !== typeof Module && (Module = {});
var JS9 = (function () {
  var a = {
    NAME: "JS9",
    VERSION: "3.6.2",
    COPYRIGHT: "Copyright (c) 2012-2022 Smithsonian Institution",
  };
  a.ABOUT =
    "JS9 " +
    a.VERSION +
    ": astronomical image display everywhere\nEric Mandel, Alexey Vikhlinin\ncontact: emandel@cfa.harvard.edu\n" +
    a.COPYRIGHT;
  a.DEFID = "JS9";
  a.WIDTH = 512;
  a.HEIGHT = 512;
  a.ANON = "Anonymous";
  a.PREFSFILE = "js9Prefs.json";
  a.WORKERFILE = "js9worker.js";
  a.ZINDEX = 0;
  a.SHAPEZINDEX = 4;
  a.MESSZINDEX = 80;
  a.BTNZINDEX = 90;
  a.MENUZINDEX = 1e3;
  a.COLORSIZE = 1024;
  a.SCALESIZE = 16384;
  a.INVSIZE = 1024;
  a.HISTSIZE = 16384;
  a.INSTALLDIR = "";
  a.TOROOT = "";
  a.PLUGINS = "";
  a.LIGHTWIN = "dhtml";
  a.ANTIALIAS = !1;
  a.SCALEIREG = !0;
  a.NOMOVE = 3;
  a.DBLCLICK0 = 5;
  a.DBLCLICK = 300;
  a.TIMEOUT = 250;
  a.SPINOUT = 250;
  a.WORKEROUT = 2e3;
  a.SUPERMENU = /^SUPERMENU_/;
  a.RESIZEDIST = 20;
  a.RESIZEFUDGE = 5;
  a.RAWID0 = "raw0";
  a.RAWIDX = "alt";
  a.IDFMT = "  (%s)";
  a.MINZOOM = 0.125;
  a.MAXZOOM = 32;
  a.ADDZOOM = 0.1;
  a.MODZOOM = 2;
  a.DIRZOOM = 1;
  a.CHROMEFILEWARNING = !0;
  a.CLIPBOARDERROR =
    "the local clipboard (which only holds data copied from within JS9) does not contain any content. Were you trying to paste something copied outside JS9?";
  a.CLIPBOARDERROR2 =
    "the local clipboard (which only holds data copied from within JS9) does not contain any regions";
  a.URLEXP = /^(https?|ftp):\/\//;
  a.WCSEXP = /^(fk4|fk5|icrs|galactic|ecliptic|image|physical|linear)$/;
  a.REGSIZE = 0;
  a.TOUCHSUPPORTED =
    Object.prototype.hasOwnProperty.call(window, "ontouchstart") ||
    0 < navigator.maxTouchPoints ||
    0 < navigator.msMaxTouchPoints;
  a.BROWSER = (function () {
    var a = navigator.platform,
      b = navigator.appName,
      d = navigator.userAgent,
      e = d.match(/version\/([.\d]+)/i),
      f = d.match(/(opera|chrome|safari|firefox)\/?\s*(\.?\d+(\.\d+)*)/i);
    f && null !== e && (f[2] = e[1]);
    f = f ? [f[1], f[2], a] : [b, navigator.appVersion, "-?", a];
    f.push(
      /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(d) ||
        ("MacIntel" === navigator.platform && 1 < navigator.maxTouchPoints)
    );
    return f;
  })();
  a.PIXEL_RATIO = (function () {
    var a = document.createElement("canvas").getContext("2d");
    return (
      (window.devicePixelRatio || 1) /
      (a.webkitBackingStorePixelRatio ||
        a.mozBackingStorePixelRatio ||
        a.msBackingStorePixelRatio ||
        a.oBackingStorePixelRatio ||
        a.backingStorePixelRatio ||
        1)
    );
  })();
  a.globalOpts = {
    helperType: "none",
    helperPort: 2718,
    requireHelper: !1,
    allinoneHelper: !1,
    processQueryParams: !0,
    quietReturn: !1,
    useWasm: !0,
    transforms: ["flip", "rot90", "rotate"],
    rotateRelative: !1,
    clickToFocus: !1,
    winType: "light",
    sortPreloads: !0,
    defcolor: "#00FF00",
    fits2fits: "never",
    requireFits2Fits: !1,
    localAccess: !0,
    prependJS9Dir: !0,
    dataDir: null,
    alerts: !0,
    valposTarget: null,
    valposWidth: "medium",
    valposDCoords: !1,
    internalValPos: !0,
    internalContrastBias: !0,
    containContrastBias: !1,
    arrowIncrement: 1,
    wcsCrosshair: !1,
    localLoadFormat: "image",
    remoteLoadMethod: "proxy",
    csvIncludeWCS: !0,
    regWhichDefault: "auto",
    regIncludeJSON: !0,
    regIncludeComments: !0,
    regListDCoords: !1,
    regSaveDCoords: !1,
    regExpandDCoords: !1,
    regCopyDCoords: !0,
    regArrowCrosshair: !0,
    regSaveWCS: "",
    regSaveFormat: "reg",
    regSaveWhich1: "all",
    regSaveWhich2: "selected",
    regMenuCreate: !0,
    regMenuSelection: "circle",
    regToClipboard: !1,
    regGroupConflict: "skip",
    regConfigAddParens: !0,
    regSyncTextColor: !0,
    regDisplay: "lightwin",
    reConfigSize: "medium",
    htimeout: 1e4,
    lhtimeout: 1e4,
    ehtimeout: 500,
    ehretries: 20,
    xtimeout: 6e5,
    extlist: "EVENTS STDEVT",
    imopts: "IMOPTS",
    imcmap: "IMCMAP",
    table: { xdim: 4096, ydim: 4096, bin: 1, bitpix: 32 },
    image: { xdim: 4096, ydim: 4096, bin: 1 },
    binMode: "s",
    reprojSwitches: "",
    reprojectLimits: !1,
    rotationCenter: "file",
    runOnCR: !0,
    clearImageMemory: "heap",
    helperProtocol: location.protocol,
    reloadRefresh: !1,
    reloadRefreshReg: !0,
    nextImageMask: !1,
    panMouseThreshold: 1,
    panzoomRefreshLimit: 500,
    panWithinDisplay: !1,
    pannerDirections: !0,
    magnifierRegions: !0,
    editRegions: !0,
    svgBorder: !0,
    unremoveReg: 100,
    resetEmptyShapeId: !1,
    maxMemory: 2e9,
    loadURL: "params/load.html",
    corsURL: "params/loadcors.html",
    proxyURL: "params/loadproxy.html",
    loadProxy: !1,
    imsectionURL: "params/imsection.html",
    postMessage: !1,
    localStorage: !0,
    waitType: "spinner",
    spinColor: "#FF0000",
    spinOpacity: 0.35,
    resize: !0,
    resizeHandle: !0,
    resizeRedisplay: !0,
    logoDisplay: !1,
    logo: "images/js9logo.png",
    lightWinPos: "center=1",
    lightWinClose: "ask",
    fallbackDisplay: !0,
    refreshDragDrop: !0,
    reduceMosaic: "js9",
    internalRegcnts: !0,
    reduceRegcnts: !0,
    plot3d: { cube: "*:*:all", mode: "avg", areaunits: "pixels", color: "green" },
    imexamLineHeight: 1,
    copyWcsPosFormat: "$ra $dec $sys",
    floatPrecision: 6,
    mouseActions: ["display value/position", "change contrast/bias", "pan the image"],
    touchActions: ["display value/position", "change contrast/bias", "pan the image"],
    keyboardActions: {
      a: "add last region selected in regions menu",
      b: "toggle selected region: source/background",
      c: "toggle crosshair",
      d: "send selected region to back",
      e: "toggle selected region: include/exclude",
      "M-e": "edit selected region(s)",
      i: "refresh image",
      I: "display full image",
      "M-i": "display selected cutouts",
      "M-k": "toggle keyboard actions plugin",
      l: "toggle active shape layers",
      "M-l": "new JS9 light window",
      m: "pan to mouse position",
      "M-m": "toggle mouse/touch plugin",
      "M-o": "open local file",
      P: "paste regions from local clipboard",
      p: "paste regions to current position",
      "M-,": "toggle preferences plugin",
      "M-p": "toggle preferences plugin",
      r: "copy region(s) to clipboard",
      s: "select region",
      S: "select all regions",
      "M-s": "toggle shape layers plugin",
      u: "undo remove of region(s)",
      U: "unselect all regions",
      x: "flip image around x axis",
      y: "flip image around y axis",
      9: "rotate image by 90 degrees",
      "/": "copy wcs position to clipboard",
      "?": "copy value and position to clipboard",
      0: "reset zoom",
      "=": "zoom in",
      "+": "zoom in",
      "-": "zoom out",
      "^": "raise region layer to top",
      ">": "display next image",
      "<": "display previous image",
      delete: "remove selected region",
      leftArrow: "move region/position left",
      upArrow: "move region/position up",
      rightArrow: "move region/position right",
      downArrow: "move region/position down",
    },
    mousetouchZoom: !1,
    mousetouchLimit: !0,
    metaClickPan: !0,
    statusBar: "$colorbar; $colormap; $mag; $scale ($scalemin,$scalemax); $wcssys; $image0",
    toolbarTooltips: !1,
    updateTitlebar: !0,
    centerDivs: ["JS9Menubar"],
    resizeDivs: ["JS9Menubar", "JS9Colorbar", "JS9Toolbar", "JS9Statusbar"],
    pinchWait: 8,
    pinchThresh: 6,
    xeqPlugins: !0,
    extendedPlugins: !0,
    intensivePlugins: !1,
    dynamicSelect: "click",
    dynamicHighlight: !0,
    corsProxy: "https://js9.si.edu/cgi-bin/CORS-proxy.cgi",
    simbadProxy: "https://js9.si.edu/cgi-bin/simbad-proxy.cgi",
    catalogs: {
      ras: ["RA", "_RAJ2000", "RAJ2000"],
      decs: ["Dec", "_DEJ2000", "DEJ2000"],
      shape: "circle",
      color: "yellow",
      width: 7,
      height: 7,
      radius: 3.5,
      r1: 5,
      r2: 3.5,
      wcssys: "ICRS",
      skip: "#\n",
      save: !0,
      tooltip: "$data.ra $data.dec",
    },
    topColormaps: "grey heat cool turbo viridis magma sls red green blue".split(" "),
    infoBox: "file object wcsfov wcscen wcspos impos physpos value regions progress".split(" "),
    infoBoxResize: !0,
    menuBar: "file edit view zoom scale color region wcs analysis help".split(" "),
    menubarStyle: "classic",
    menuPosition: "right-5 bottom-5",
    menuClickEvent: "mouseup",
    menuSelected: "check",
    menuImages: !0,
    userMenus: !1,
    userMenuDivider: "&nbsp;&nbsp;&nbsp;",
    imagesFileSubmenu: 5,
    toolBar: "annulus box circle ellipse line polygon text zoom+ zoom- zoom1 zoomtofit".split(" "),
    syncOps: "alignment colormap contrastbias flip pan regions rotate rot90 scale wcs zoom".split(
      " "
    ),
    syncReciprocate: !0,
    syncWCS: !0,
    hiddenPluginDivs: [],
    separate: { layout: "auto", leftMargin: 10, topMargin: 10 },
    imageTemplates: ".fits,.fts,.png,.jpg,.jpeg,.fz,.ftz,.gz",
    wcsUnits: {
      FK4: "sexagesimal",
      FK5: "sexagesimal",
      ICRS: "sexagesimal",
      galactic: "degrees",
      ecliptic: "degrees",
      linear: "degrees",
      physical: "pixels",
      image: "pixels",
    },
    wcsSetUpdatesDef: !0,
    wcsHlength: 256e3,
    regTemplates: ".reg",
    sessionTemplates: ".ses,.js9ses",
    colormapTemplates: ".cmap",
    catalogTemplates: ".cat,.tab",
    localTemplates: ".fits,.fts",
    controlsMatchRegion: !1,
    internalColorPicker: !0,
    newWindowWidth: 530,
    newWindowHeight: 625,
    debug: 0,
  };
  a.favorites = {
    scales: ["linear", "log", "histeq"],
    colormaps: ["cool", "heat", "viridis", "magma"],
    regions: ["annulus", "box", "circle", "ellipse"],
    wcs: ["FK5", "ICRS", "galactic:Galactic", "physical", "image"],
  };
  a.desktopOpts = { currentPath: !0, sessionPath: !0 };
  a.imageOpts = {
    inherit: !1,
    contrast: 1,
    bias: 0.5,
    invert: !1,
    exp: 1e3,
    colormap: "grey",
    overlay: !0,
    scale: "linear",
    scaleclipping: "dataminmax",
    scalemin: Number.NaN,
    scalemax: Number.NaN,
    flip: "none",
    rot90: 0,
    rotate: 0,
    zscalecontrast: 0.25,
    zscalesamples: 600,
    zscaleline: 120,
    wcssys: "native",
    lcs: "physical",
    valpos: !0,
    sigma: "none",
    opacity: 1,
    alpha: 255,
    nancolor: "#000000",
    nocolor: { red: 0, green: 0, blue: 0, alpha: 0 },
    zoom: 1,
    zooms: 6,
    topZooms: 2,
    wcsalign: !0,
    rotationMode: "relative",
    crosshair: !1,
    disable: [],
    ltvbug: !1,
    listonchange: !1,
    whichonchange: "selected",
  };
  a.regionOpts = {};
  a.catalogOpts = {};
  a.crosshairOpts = {};
  a.gridOpts = {};
  a.emscriptenOpts = {};
  a.fabricOpts = {};
  a.blendOpts = { active: !0, mode: "screen", opacity: 1 };
  a.maskOpts = {
    active: !1,
    mode: "overlay",
    opacity: 1,
    vopacity: 0,
    value: 0,
    syncops: ["flip", "pan", "rot90", "zoom"],
    invert: !1,
  };
  a.analOpts = {
    epattern: /^(ERROR:[^\n]*)\n/,
    dpathURL: "params/datapath.html",
    fpathURL: "params/filepath.html",
  };
  a.lightOpts = {
    nclick: 0,
    dhtml: {
      topid: "#dhtmlwindowholder",
      top: ".dhtmlwindow",
      drag: ".drag-contentarea",
      dragBar: ".drag-handle",
      format: "width=%spx,height=%spx,resize=%s,scrolling=0",
      textWin: "width=830px,height=400px,resize=1,scrolling=1",
      plotWin: "width=830px,height=420px,resize=1,scrolling=1",
      dpathWin: "width=830px,height=175px,resize=1,scrolling=1",
      lcloseWin: "width=512px,height=190px,resize=1,scrolling=1",
      paramWin: "width=830px,height=235px,resize=1,scrolling=1",
      regWin0: "width=640px,height=130px,resize=1,scrolling=1",
      regWin1: "width=640px,height=200px,resize=1,scrolling=1",
      regWin: "width=640px,height=470px,resize=1,scrolling=1",
      imageWin: "width=512px,height=598px,resize=1,scrolling=1",
      lineWin: "width=400px,height=60px,resize=1,scrolling=1",
    },
    lcloseURL: "params/lightclose.html",
  };
  a.textColorOpts = { regions: "#00FF00", info: "#00FF00", inimage: "#000000" };
  a.helpOpts = {
    user: { heading: "JS9Help", type: "help", url: "user.html", title: "User Manual" },
    install: { heading: "JS9Help", type: "help", url: "install.html", title: "Installing JS9" },
    webpage: {
      heading: "JS9Help",
      type: "help",
      url: "webpage.html",
      title: "Adding JS9 to a Web Page",
    },
    yourdata: {
      heading: "JS9Help",
      type: "help",
      url: "yourdata.html",
      title: "Adding Data to a Web Page",
    },
    localtasks: {
      heading: "JS9Help",
      type: "help",
      url: "localtasks.html",
      title: "Adding Local Analysis Tasks and Plugins",
    },
    helper: {
      heading: "JS9Help",
      type: "help",
      url: "helper.html",
      title: "Adding Server-side Analysis Tasks",
    },
    serverside: {
      heading: "JS9Help",
      type: "help",
      url: "serverside.html",
      title: "Server-side Analysis with JS9",
    },
    publicapi: {
      heading: "JS9Help",
      type: "help",
      url: "publicapi.html",
      title: "The JS9 Public API",
    },
    extmsg: { heading: "JS9Help", type: "help", url: "extmsg.html", title: "External Messaging" },
    desktop: { heading: "JS9Help", type: "help", url: "desktop.html", title: "JS9 on the Desktop" },
    python: {
      heading: "JS9Help",
      type: "help",
      url: "python.html",
      title: "JS9 with Python and Jupyter",
    },
    archives: {
      heading: "JS9Help",
      type: "help",
      url: "archives.html",
      title: "Accessing Data Archives",
    },
    preferences: {
      heading: "JS9Help",
      type: "help",
      url: "preferences.html",
      title: "Setting Site Preferences",
    },
    regions: { heading: "JS9Help", type: "help", url: "regions.html", title: "Regions Format" },
    changelog: { heading: "JS9Help", type: "help", url: "changelog.html", title: "ChangeLog" },
    repfile: {
      heading: "JS9Help",
      type: "help",
      url: "repfile.html",
      title: "Dealing with Large Files",
    },
    memory: {
      heading: "JS9Help",
      type: "help",
      url: "memory.html",
      title: "Dealing with Memory Limitations",
    },
    issues: { heading: "JS9Help", type: "help", url: "knownissues.html", title: "Known Issues" },
    security: {
      heading: "JS9Help",
      type: "help",
      url: "securityissues.html",
      title: "Security Issues",
    },
  };
  a.images = [];
  a.displays = [];
  a.colormaps = [];
  a.commands = [];
  a.plugins = [];
  a.preloads = [];
  a.auxFiles = [];
  a.supermenus = [];
  a.preloadwaiting = [];
  a.publics = {};
  a.helper = {};
  a.fits = {};
  a.userOpts = {};
  a.tmp = {};
  a.scales = "linear log histeq power sqrt squared asinh sinh".split(" ");
  a.wcssyss = "FK4 FK5 ICRS galactic ecliptic physical image native".split(" ");
  a.wcsunitss = ["degrees", "sexagesimal", "pixels"];
  a.regions = "annulus box circle cross ellipse line point polygon text".split(" ");
  a.bugs = {};
  a.bugs.hide_menu = !1;
  "Firefox" === a.BROWSER[0] && 0 <= a.BROWSER[2].search(/Linux/) && (a.bugs.firefox_linux = !0);
  "Safari" === a.BROWSER[0] && (a.bugs.webkit_resize = !0);
  /iPad|iPhone|iPod/.test(navigator.platform) &&
    /11_2_(?:[2-9])/.test(navigator.userAgent) &&
    (a.globalOpts.useWasm = !1);
  a.BROWSER[3] &&
    ((a.globalOpts.maxMemory = Math.min(a.globalOpts.maxMemory, 35e7)),
    (a.globalOpts.table.xdim = 2048),
    (a.globalOpts.table.ydim = 2048),
    (a.globalOpts.image.xdim = 2048),
    (a.globalOpts.image.ydim = 2048),
    (a.imageOpts.crosshair = !1),
    (a.globalOpts.reproj = { xdim: 2048, ydim: 2048 }),
    (a.lightOpts.dhtml.regWin0 = "width=660px,height=130px,resize=1,scrolling=1"),
    (a.lightOpts.dhtml.regWin1 = "width=660px,height=200px,resize=1,scrolling=1"),
    (a.lightOpts.dhtml.regWin = "width=660px,height=470px,resize=1,scrolling=1"));
  Object.prototype.hasOwnProperty.call(window, "Jupyter") && (a.globalOpts.useWasm = !1);
  if (
    window.electron &&
    (window.electron.hostFS && (a.hostFS = window.electron.hostFS),
    window.electron.multiElectron && (a.globalOpts.localStorage = !1),
    "function" === typeof window.eval &&
      (window.eval = function () {
        throw Error("For security reasons, Desktop JS9 does not support window.eval()");
      }),
    window.electron.cmdlineOpts)
  )
    try {
      a.cmdlineOpts = JSON.parse(window.electron.cmdlineOpts);
    } catch (c) {
      delete a.cmdlineOpts;
    }
  a.Image = function (c, b, d) {
    var e = this,
      f = null,
      g = 0,
      h = 0,
      l = function (b) {
        b = b || {};
        a.isNull(b.scaleclipping)
          ? "zscale" === e.params.scaleclipping
            ? e.zscale(!0)
            : "zmax" === e.params.scaleclipping && e.zscale("zmax")
          : "zscale" === b.scaleclipping
            ? e.zscale(!0)
            : "zmax" === b.scaleclipping && e.zscale("zmax");
        a.notNull(b.scalemin) && (e.params.scalemin = b.scalemin);
        a.notNull(b.scalemax) && (e.params.scalemax = b.scalemax);
      },
      m = function (b) {
        var c = a.globalOpts.imopts,
          d = a.globalOpts.imcmap,
          g = a.globalOpts.alerts;
        var h = /(annulus|box|circle|ellipse|line|polygon|point|text) *\(/;
        a.images.push(e);
        e.display.clearMessage();
        e.displayImage("all", f);
        e.notifyHelper();
        e.showShapeLayer("regions", !0, { local: !0 });
        f &&
          (((a.notNull(f.x) && a.notNull(f.y)) ||
            (a.notNull(f.px) && a.notNull(f.py)) ||
            (a.notNull(f.ra) && a.notNull(f.dec)) ||
            a.notNull(f.wcs)) &&
            e.setPan(f),
          f.regions &&
            (f.regions.match(h)
              ? e.addShapes("regions", f.regions)
              : a.LoadRegions(f.regions, { display: e.display })));
        a.globalOpts.alerts = !1;
        if (e.raw && e.raw.header && e.raw.header[d]) {
          try {
            var k = JSON.parse(e.raw.header[d]);
          } catch (y) {
            k = null;
          }
          if (k)
            try {
              a.AddColormap(k);
            } catch (y) {}
        }
        if (e.raw && e.raw.header && e.raw.header[d + "1"]) {
          var l = 1;
          for (h = ""; 100 > l; l++) {
            var m = d + String(l);
            if (e.raw.header[m]) h += e.raw.header[m];
            else break;
          }
          if (h) {
            try {
              k = JSON.parse(h);
            } catch (y) {
              k = null;
            }
            if (k)
              try {
                a.AddColormap(k);
              } catch (y) {}
          }
        }
        if (e.raw && e.raw.header && e.raw.header[c]) {
          try {
            k = JSON.parse(e.raw.header[c]);
          } catch (y) {
            k = null;
          }
          if (k)
            try {
              e.setParam("all", k);
            } catch (y) {}
        }
        if (e.raw && e.raw.header && e.raw.header[c + "1"]) {
          l = 1;
          for (h = ""; 100 > l; l++)
            if (((m = c + String(l)), e.raw.header[m])) h += e.raw.header[m];
            else break;
          if (h) {
            try {
              k = JSON.parse(h);
            } catch (y) {
              k = null;
            }
            if (k)
              try {
                e.setParam("all", k);
              } catch (y) {}
          }
        }
        a.globalOpts.alerts = g;
        e.xeqPlugins("image", "onimageload");
        e.setStatus("load", "complete");
        a.waiting(!1);
        if (b)
          try {
            a.xeqByName(b, window, e);
          } catch (y) {
            a.error("in image onload callback", y, !1);
          }
        if (a.preloadwaiting && a.preloadwaiting.length) {
          var q = a.preloadwaiting.length;
          b = e.proxyURL || e.file;
          for (k = l = 0; l < q; l++) {
            var z = a.preloadwaiting[l];
            b.match(z.id) || z.id.match(b) ? ((z.loaded = !0), (z.im = e)) : !1 === z.loaded && k++;
          }
          if (!k) {
            a.globalOpts.sortPreloads
              ? (a.images.sort(function (b, c) {
                  var d = 0,
                    e = 0;
                  for (l = 0; l < q; l++)
                    ((z = a.preloadwaiting[l]),
                      b.id === z.im.id && (d = l),
                      c.id === z.im.id && (e = l));
                  return d - e;
                }),
                (b = a.preloadwaiting[q - 1].im || e),
                b.displayImage())
              : (b = e);
            if (a.notNull(a.globalOpts.onpreload))
              try {
                a.xeqByName(a.globalOpts.onpreload, window, b);
              } catch (y) {
                a.error("in onpreload callback", y, !1);
              } finally {
                delete a.globalOpts.onpreload;
              }
            a.preloadwaiting = [];
          }
        }
        f && f.allext && e.hdus && 0 < e.hdus.length && e.displayExtension("all");
      };
    if (b)
      if ("object" === typeof b) {
        if (((f = b), f.display)) var k = f.display;
      } else k = b;
    k || (k = 0 < a.displays.length ? a.displays[0].id : a.DEFID);
    this.type = "image";
    this.display = a.lookupDisplay(k);
    this.params = {};
    this.regstack = [];
    this.tmp = {};
    this.groups = {};
    this.params.xeqonchange = !0;
    this.params = $.extend(!0, this.params, a.imageOpts, f);
    this.display.image &&
      ((this.params.inherit = this.display.image.params.inherit),
      this.params.inherit && (this.params = $.extend(!0, this.params, this.display.image.params)));
    b = a.globalOpts.xeqPlugins;
    k = this.params.overlay;
    a.globalOpts.xeqPlugins = !1;
    this.setColormap(this.params.colormap);
    this.params.overlay = k;
    a.globalOpts.xeqPlugins = b;
    this.displayMode = !0;
    this.clickState = 0;
    this.clickInRegion = !1;
    this.clickInLayer = null;
    this.queried = !1;
    f && f.proxyFile && (this.proxyFile = f.proxyFile);
    f && f.proxyParent && (this.proxyParent = f.proxyParent);
    f && f.proxyURL && (this.proxyURL = f.proxyURL);
    f && f.parentFile && (this.parentFile = f.parentFile);
    if (f && f.parent && ((this.parent = f.parent), this.parent.cardstr && this.parent.ncard)) {
      this.parent.raw = { header: {}, history: [], comments: [] };
      for (b = 0; b < this.parent.ncard; b++)
        ((k = this.parent.cardstr.slice(80 * b, 80 * (b + 1))),
          (k = a.cardpars(k)),
          void 0 !== k &&
            ("HISTORY" === k[0]
              ? (this.parent.raw.header[k[0] + "__" + g++] = k[1])
              : "COMMENT" === k[0]
                ? (this.parent.raw.header[k[0] + "__" + h++] = k[1])
                : (this.parent.raw.header[k[0]] = k[1])));
      this.parent.lcs = {};
      a.Image.prototype.initLCS.call(this.parent, this.parent.raw.header);
    }
    f && f.id && (this.id = f.id);
    this.iy = this.ix = 0;
    this.status = {};
    this.rgb = {};
    this.rgb.sect = { zoom: 1, ozoom: 1 };
    this.layers = {};
    this.zlayer = a.SHAPEZINDEX;
    this.lcs = {};
    this.aux = {};
    this.binning = { bin: 1, obin: 1 };
    this.raws = [];
    this.blend = $.extend(!0, {}, a.blendOpts);
    this.mask = $.extend(!0, {}, a.maskOpts);
    if (c)
      switch ((a.waiting(!0, this.display), typeof c)) {
        case "object":
          this.source = f && f.source ? f.source : "fits";
          this.mkRawDataFromHDU(c, $.extend({}, { file: c.file || c.filename }, f));
          l(f);
          this.params.zoom &&
            ((c = this.parseZoom(this.params.zoom)),
            (this.rgb.sect.zoom = c),
            (this.rgb.sect.ozoom = c));
          this.mkSection();
          f && f.rgbFile
            ? ((this.rgbFile = f.rgbFile),
              (this.png = { image: new Image() }),
              $(this.png.image)
                .on("load", function () {
                  if (e.png.image.width !== e.raw.width || e.png.image.height !== e.raw.height) {
                    var b = sprintf(
                      "rgb dims [%s,%s] don't match image [%s,%s]",
                      e.png.image.width,
                      e.png.image.height,
                      e.raw.width,
                      e.raw.height
                    );
                    a.error(b);
                  }
                  e.mkOffScreenCanvas();
                  m(d);
                })
                .on("error", function () {
                  a.waiting(!1);
                  a.error("could not load image: " + e.id);
                }),
              (this.png.image.src = this.rgbFile))
            : m(d);
          break;
        default:
          a.error("unknown specification type for Load: " + typeof c);
      }
  };
  a.Image.prototype.getImageData = function (a) {
    var b = null,
      c = this.fileDimensions(),
      e = c.xdim;
    c = c.ydim;
    if (a)
      if ("array" === a) b = Array.from(this.raw.data);
      else if ("base64" === a) {
        b = "";
        var f = new Uint8Array(this.raw.data.buffer),
          g = f.byteLength;
        for (a = 0; a < g; a++) b += String.fromCharCode(f[a]);
        b = window.btoa(b);
      } else b = this.raw.data;
    return {
      id: this.id,
      file: this.file,
      fits: this.fitsFile || "",
      source: this.source,
      imtab: this.imtab,
      width: this.raw.width,
      height: this.raw.height,
      bitpix: this.raw.bitpix,
      bin: this.binning.bin,
      header: this.raw.header,
      hdus: this.hdus,
      dwidth: this.display.width,
      dheight: this.display.height,
      fwidth: e,
      fheight: c,
      data: b,
    };
  };
  a.Image.prototype.closeImage = function (c) {
    var b,
      d = !1;
    var e = a.images.length;
    var f = a.Dysel.getDisplayOr(this.display);
    c = c || {};
    if ("string" === typeof c)
      try {
        c = JSON.parse(c);
      } catch (h) {
        a.error("can't parse closeImage opts: " + c, h);
      }
    this.setStatus("close", "closing");
    for (b = 0; b < e; b++) a.images[b].wcsim === this && (a.images[b].wcsim = null);
    for (b = 0; b < e; b++)
      a.images[b].mask.im === this &&
        ((a.images[b].mask.im = null), (a.images[b].mask.active = !1));
    for (b = 0; b < e; b++)
      if (this === a.images[b]) {
        e = a.images[b];
        e === e.display.image && (d = b + 1);
        if (d)
          for (g in (!1 !== c.clear && (e.display.clearMessage(), e.display.context.clear()),
          e.layers))
            Object.prototype.hasOwnProperty.call(e.layers, g) &&
              ("main" === e.layers[g].dlayer.dtype || e.display === f) &&
              e.showShapeLayer(g, !1, { local: !0 });
        e.xeqPlugins("image", "onimageclose");
        d && (e.display.image = null);
        switch (e.cmapObj.name) {
          case "red":
            e.display.rgb.rim = null;
            break;
          case "green":
            e.display.rgb.gim = null;
            break;
          case "blue":
            e.display.rgb.bim = null;
        }
        for (c = 0; c < e.raws.length; c++) {
          var g = e.raws[c];
          g.hdu &&
            g.hdu.fits &&
            ((f = a.lookupVfile(g.hdu.fits.vfile)), 1 >= f.length && a.cleanupFITSFile(g, !0));
          g.altwcs && this.freeWCS(g);
        }
        e.removeProxyFile();
        e.rgb = null;
        e.offscreen = null;
        e.raw = null;
        e.colorData = null;
        e.colorCells = null;
        e.psColors = null;
        e.psInverse = null;
        a.images.splice(b, 1);
        break;
      }
    if (d) {
      for (b = d -= 2; 0 <= b; b--)
        if (((e = a.images[b]), this.display === e.display)) {
          e.displayImage("all");
          e.refreshLayers();
          d = a.images.length;
          break;
        }
      for (b = a.images.length - 1; b > d; b--)
        if (((e = a.images[b]), this.display === e.display)) {
          e.displayImage("all");
          e.refreshLayers();
          break;
        }
    }
  };
  a.Image.prototype.mkOffScreenCanvas = function () {
    if (!this.png || !this.png.image) return this;
    this.offscreen = {};
    this.offscreen.canvas = document.createElement("canvas");
    this.offscreen.canvas.setAttribute("width", this.png.image.width);
    this.offscreen.canvas.setAttribute("height", this.png.image.height);
    this.offscreen.context = this.offscreen.canvas.getContext("2d");
    a.ANTIALIAS || (this.offscreen.context.imageSmoothingEnabled = !1);
    this.offscreen.context.drawImage(this.png.image, 0, 0);
    try {
      this.offscreen.img = this.offscreen.context.getImageData(
        0,
        0,
        this.png.image.width,
        this.png.image.height
      );
    } catch (c) {
      a.CHROMEFILEWARNING && "Chrome" === a.BROWSER[0] && "" === document.domain
        ? alert(
            "When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."
          )
        : alert("could not read off-screen image data [same-origin policy violation?]");
    }
    return this;
  };
  a.Image.prototype.useOffScreenCanvas = function () {
    return this.offscreen && (this.rgbFile || this.params.overlay);
  };
  a.Image.prototype.initLCS = function (c) {
    var b = [
      [0, 0, 0],
      [0, 0, 0],
      [0, 0, 0],
    ];
    c = c || this.raw.header;
    var d = c.CRPIX1 || 1,
      e = c.CRPIX2 || 1;
    if (c.LCSROTA2 && c.CROTA2) {
      var f = (-c.CROTA2 * Math.PI) / 180;
      var g = Math.sin(f);
      var h = Math.cos(f);
      f = [
        [0, 0, 0],
        [0, 0, 0],
        [0, 0, 0],
      ];
      f[0][0] = h;
      f[0][1] = -g;
      f[0][2] = 0;
      f[1][0] = g;
      f[1][1] = h;
      f[1][2] = 0;
      (g = a.invertMatrix3(f)) || (f = null);
    }
    b[0][0] = a.defNull(c.LTM1_1, 1);
    b[1][0] = c.LTM2_1 || 0;
    b[0][1] = c.LTM1_2 || 0;
    b[1][1] = a.defNull(c.LTM2_2, 1);
    b[2][0] = c.LTV1 || 0;
    b[2][1] = c.LTV2 || 0;
    if ("image" === this.imtab && this.params.ltvbug) {
      if (a.notNull(c.LTV1))
        for (h = 0; 2 > h; h++) {
          var l = Math.abs(b[0][h]);
          0 < l && 1 > l && (b[2][0] += 0.5 * l);
        }
      if (a.notNull(c.LTV2))
        for (h = 0; 2 > h; h++) ((l = Math.abs(b[1][h])), 0 < l && 1 > l && (b[2][1] += 0.5 * l));
    }
    this.lcs.physical = { forward: $.extend(!0, [], b), reverse: a.invertMatrix3(b) };
    this.lcs.physical.reverse
      ? f &&
        ((this.lcs.physical.frot = $.extend(!0, [], f)),
        (this.lcs.physical.rrot = $.extend(!0, [], g)),
        (this.lcs.physical.cx = d - b[2][0] - 1),
        (this.lcs.physical.cy = e - b[2][1] - 1))
      : delete this.lcs.physical;
    b[0][0] = a.defNull(c.DTM1_1, 1);
    b[1][0] = c.DTM2_1 || 0;
    b[0][1] = c.DTM1_2 || 0;
    b[1][1] = a.defNull(c.DTM2_2, 1);
    b[2][0] = c.DTV1 || 0;
    b[2][1] = c.DTV2 || 0;
    this.lcs.detector = { forward: $.extend(!0, [], b), reverse: a.invertMatrix3(b) };
    this.lcs.detector.reverse
      ? f &&
        ((this.lcs.detector.frot = $.extend(!0, [], f)),
        (this.lcs.detector.rrot = $.extend(!0, [], g)),
        (this.lcs.detector.cx = d - b[2][0] - 1),
        (this.lcs.detector.cy = e - b[2][1] - 1))
      : delete this.lcs.detector;
    b[0][0] = a.defNull(c.ATM1_1, 1);
    b[1][0] = c.ATM2_1 || 0;
    b[0][1] = c.ATM1_2 || 0;
    b[1][1] = a.defNull(c.ATM2_2, 1);
    b[2][0] = c.ATV1 || 0;
    b[2][1] = c.ATV2 || 0;
    this.lcs.amplifier = { forward: $.extend(!0, [], b), reverse: a.invertMatrix3(b) };
    this.lcs.amplifier.reverse
      ? f &&
        ((this.lcs.amplifier.frot = $.extend(!0, [], f)),
        (this.lcs.amplifier.rrot = $.extend(!0, [], g)),
        (this.lcs.amplifier.cx = d - b[2][0] - 1),
        (this.lcs.amplifier.cy = e - b[2][1] - 1))
      : delete this.lcs.amplifier;
    this.params && !this.lcs[this.params.lcs] && (this.params.lcs = "image");
    this.params &&
      !this.params.wcssys0 &&
      (this.setWCSSys("physical"), (this.params.wcssys0 = this.params.lcs));
    this.lcs.physical &&
      !this.lcs.ophysical &&
      (this.lcs.ophysical = $.extend(!0, {}, this.lcs.physical));
    return this;
  };
  a.Image.prototype.mkRawDataFromHDU = function (c, b) {
    var d = this,
      e,
      f,
      g,
      h;
    var l = (h = 0);
    b = b || {};
    if ($.isArray(c) || a.isTypedArray(c) || c instanceof ArrayBuffer) {
      $.isArray(c[0]) &&
        (c = c.reduce(function (a, b) {
          return a.concat(b);
        }));
      var m = { image: c };
    } else "object" === typeof c ? (m = c) : a.error("unknown or missing input for HDU creation");
    m.data && !m.image && (m.image = m.data);
    m.image || a.error("data missing from JS9 FITS object: " + JSON.stringify(m));
    2 > m.naxis && a.error("can't image a FITS file with less than 2 dimensions");
    if (this.raw) {
      var k = this.raw;
      var q = this.raw.width;
      var u = this.raw.height;
      var p = this.raw.bitpix;
      var n = this.params.wcssys;
      var x = this.params.wcsunits;
      this.freeWCS();
    }
    this.raws = this.raws || [];
    if ((g = this.raws.length)) {
      b.rawid = b.rawid || a.RAWIDX;
      for (e = f = 0; e < g; e++)
        if (b.rawid === this.raws[e].id) {
          var w = this.raws[e].from;
          this.raws[e] = { from: w, id: b.rawid };
          this.raw = this.raws[e];
          f++;
          break;
        }
      f || (this.raws.push({ from: "hdu", id: b.rawid }), (this.raw = this.raws[g]), (k = null));
    } else (this.raws.push({ from: "hdu" }), (this.raw = this.raws[g]), (this.raw.id = a.RAWID0));
    this.raw.hdu = m;
    m.axis
      ? ((this.raw.width = m.axis[1]), (this.raw.height = m.axis[2]))
      : m.naxis1 && m.naxis2
        ? ((this.raw.width = m.naxis1), (this.raw.height = m.naxis2))
        : q && u && ((this.raw.width = q), (this.raw.height = u));
    m.bitpix ? (this.raw.bitpix = m.bitpix) : p && (this.raw.bitpix = p);
    if ("base64" === m.encoding)
      for (
        w = window.atob(m.image),
          m.image = new ArrayBuffer(w.length),
          f = new Uint8Array(m.image),
          e = 0;
        e < w.length;
        e++
      )
        f[e] = w.charCodeAt(e);
    $.isArray(m.image[0]) &&
      (m.image = m.image.reduce(function (a, b) {
        return a.concat(b);
      }));
    switch (this.raw.bitpix) {
      case 8:
        this.raw.data = new Uint8Array(m.image);
        break;
      case 16:
        this.raw.data = new Int16Array(m.image);
        break;
      case -16:
        this.raw.data = new Uint16Array(m.image);
        break;
      case 32:
        this.raw.data = new Int32Array(m.image);
        break;
      case -32:
        this.raw.data = new Float32Array(m.image);
        break;
      case -64:
        this.raw.data = new Float64Array(m.image);
        break;
      default:
        a.error("unsupported bitpix: " + this.raw.bitpix);
    }
    this.raw.card = m.card;
    this.raw.cardstr = m.cardstr;
    this.raw.ncard = m.ncard;
    if (m.head) this.raw.header = m.head;
    else if (this.raw.card)
      for (this.raw.header = {}, f = this.raw.card.length, e = 0; e < f; e++)
        ((g = a.cardpars(this.raw.card[e])),
          void 0 !== g &&
            ("HISTORY" === g[0]
              ? (this.raw.header[g[0] + "__" + h++] = g[1])
              : "COMMENT" === g[0]
                ? (this.raw.header[g[0] + "__" + l++] = g[1])
                : (this.raw.header[g[0]] = g[1])));
    else if (this.raw.cardstr)
      for (this.raw.header = {}, f = this.raw.ncard, e = 0; e < f; e++)
        ((g = this.raw.cardstr.slice(80 * e, 80 * (e + 1))),
          (g = a.cardpars(g)),
          void 0 !== g &&
            ("HISTORY" === g[0]
              ? (this.raw.header[g[0] + "__" + h++] = g[1])
              : "COMMENT" === g[0]
                ? (this.raw.header[g[0] + "__" + l++] = g[1])
                : (this.raw.header[g[0]] = g[1])));
    else
      ((this.raw.header = {}),
        (this.raw.header.SIMPLE = !0),
        (this.raw.header.NAXIS = 2),
        (this.raw.header.NAXIS1 = this.raw.width),
        (this.raw.header.NAXIS2 = this.raw.height),
        (this.raw.header.BITPIX = this.raw.bitpix));
    e = this.raw.header;
    k ||
      this.parentFile ||
      this.parent ||
      (void 0 === e.LTV1 && void 0 === e.LTV2 && void 0 === e.LTM1_1 && void 0 === e.LTM2_2) ||
      ((this.parent = {}),
      (this.parent.raw = { header: $.extend(!0, {}, e) }),
      (this.parent.lcs = {}),
      a.Image.prototype.initLCS.call(this.parent, this.parent.raw.header));
    if (
      ("image" === m.imtab && void 0 !== m.x1 && 1 !== m.x1) ||
      (void 0 !== m.y1 && 1 !== m.y1) ||
      void 0 === m.bin ||
      1 !== m.bin
    )
      ((h = a.defNull(m.x1, 1)),
        (l = a.defNull(m.y1, 1)),
        (f = m.bin || 1),
        0 > f && (f = 1 / Math.abs(f)),
        a.notNull(e.NAXIS1) && (e.NAXIS1 /= f),
        a.notNull(e.NAXIS2) && (e.NAXIS2 /= f),
        a.notNull(e.CRPIX1) && (e.CRPIX1 = (e.CRPIX1 + 1 - h - 0.5) / f + 0.5),
        a.notNull(e.CRPIX2) && (e.CRPIX2 = (e.CRPIX2 + 1 - l - 0.5) / f + 0.5),
        a.notNull(e.CDELT1) && (e.CDELT1 *= f),
        a.notNull(e.CDELT2) && (e.CDELT2 *= f),
        a.notNull(e.CD1_1) && (e.CD1_1 *= f),
        a.notNull(e.CD1_2) && (e.CD1_2 *= f),
        a.notNull(e.CD2_1) && (e.CD2_1 *= f),
        a.notNull(e.CD2_2) && (e.CD2_2 *= f),
        (e.LTM1_1 = a.defNull(e.LTM1_1, 1)),
        (e.LTM1_1 /= f),
        (e.LTM2_1 = e.LTM2_1 || 0),
        (e.LTM2_1 /= f),
        (e.LTM1_2 = e.LTM1_2 || 0),
        (e.LTM1_2 /= f),
        (e.LTM2_2 = a.defNull(e.LTM2_2, 1)),
        (e.LTM2_2 /= f),
        (e.LTV1 = e.LTV1 || 0),
        (e.LTV1 = (e.LTV1 - h) / f + 0.5),
        (e.LTV2 = e.LTV2 || 0),
        (e.LTV2 = (e.LTV2 - l) / f + 0.5));
    b.lcsUseRota2 && (e.LCSROTA2 = !0);
    b.file && b.file !== this.file
      ? ((this.file = b.file), (this.id = null))
      : b.filename && b.filename !== this.file
        ? ((this.file = b.filename), (this.id = null))
        : m.file && m.file !== this.file && ((this.file = m.file), (this.id = null));
    this.file0 = this.file = a.cleanPath(this.file) || a.ANON + a.uniqueID();
    b.id && ((this.id0 = b.id), (this.id = a.getImageID(b.id, this.display.id, this)));
    this.id ||
      !this.file ||
      this.file.match(/\[.*[^a-zA-Z0-9_].*\]/) ||
      (b.extname || b.extnum
        ? (b.extname
            ? ((this.file = this.file.replace(/\[.*\]/, "")), (this.file += "[" + b.extname + "]"))
            : b.extnum &&
              0 < b.extnum &&
              ((this.file = this.file.replace(/\[.*\]/, "")), (this.file += "[" + b.extnum + "]")),
          m.fits &&
            (b.extname && (m.fits.extname = b.extname),
            b.extnum && 0 < b.extnum && (m.fits.extnum = b.extnum)))
        : m.fits
          ? m.fits.extname
            ? ((this.file = this.file.replace(/\[.*\]/, "")),
              (this.file += "[" + m.fits.extname + "]"))
            : m.fits.extnum &&
              0 < m.fits.extnum &&
              ((this.file = this.file.replace(/\[.*\]/, "")),
              (this.file += "[" + m.fits.extnum + "]"))
          : this.raw.header &&
            this.raw.header.EXTNAME &&
            ((this.file = this.file.replace(/\[.*\]/, "")),
            (this.file += "[" + this.raw.header.EXTNAME + "]")));
    this.id ||
      ((this.id0 = (this.parentFile || this.file).split("/").reverse()[0]),
      (this.id = a.getImageID(this.id0, this.display.id, this)));
    b.proxyFile && (this.proxyFile = b.proxyFile);
    this.raw.filter = b.filter || "";
    this.raw.columns = b.columns || "";
    this.imtab = m.imtab ? m.imtab : m.table ? "table" : "image";
    this.raw.imtab = this.imtab;
    void 0 !== m.dmin && void 0 !== m.dmax ? this.dataminmax(m.dmin, m.dmax) : this.dataminmax();
    this.object = this.raw.header.OBJECT;
    this.telescope = this.raw.header.TELESCOP;
    this.instrument = this.raw.header.INSTRUME;
    if (b.binstr)
      try {
        (w = b.binstr.split(/\s+/)) &&
          2 === w.length &&
          ("table" === this.imtab && m.table
            ? ((m.table.bin = parseFloat(w[0])), (m.table.binMode = w[1]))
            : ((m.bin = parseFloat(w[0])), (m.binMode = w[1])));
      } catch (t) {}
    this.binning.bin =
      "table" === this.imtab && m.table
        ? m.table.bin || 1
        : m.bin
          ? 0 < m.bin
            ? m.bin
            : 1 / Math.abs(m.bin)
          : 1;
    k || (this.binning.obin = this.binning.bin);
    n && this.setWCSSys(n);
    x && this.setWCSUnits(x);
    k &&
      k.header.CTYPE1 &&
      k.header.CTYPE2 &&
      this.raw.header.CTYPE1 &&
      this.raw.header.CTYPE2 &&
      (k.header.CTYPE1 !== this.raw.header.CTYPE1 || k.header.CTYPE2 !== this.raw.header.CTYPE2) &&
      this.initWCS();
    a.notNull(m.offscreen) && ((this.png = { image: m.offscreen }), this.mkOffScreenCanvas());
    this.initWCS();
    this.initLCS();
    try {
      if (b.hdus) this.hdus = b.hdus;
      else if (this.parentFile && a.helper.connected && a.helper.js9helper)
        ((c = {
          id: this.expandMacro("$id"),
          cmd: this.expandMacro("js9Xeq listhdus $filename"),
          image: this.file,
          fits: this.parentFile,
          rtype: "text",
        }),
          a.helper.send("listhdus", c, function (a) {
            if (!a.stderr && !a.errcode && a.stdout)
              try {
                d.hdus = JSON.parse(a.stdout);
              } catch (v) {
                d.hdus = null;
              }
          }));
      else if (this.raw.hdu && this.raw.hdu.fits && (w = a.listhdu(this.raw.hdu.fits.vfile)))
        try {
          this.hdus = JSON.parse(w);
        } catch (t) {
          this.hdus = null;
        }
    } catch (t) {}
    if (this.raw.hdu && this.raw.hdu.fits && this.raw.hdu.fits.vfile) {
      w = a.globalOpts.clearImageMemory;
      w = !1 === w ? ["never"] : !0 === w ? ["always"] : w.toLowerCase().split(/[,>]/);
      k = c = !1;
      e = 0;
      for (b = !1; e < w.length && !b; e++)
        switch (w[e]) {
          case "never":
            c = !1;
            b = !0;
            break;
          case "always":
            b = c = !0;
            break;
          case "heap":
            k = !0;
            break;
          case "auto":
            2 >= this.raw.header.NAXIS && (!this.hdus || 1 === this.hdus.length)
              ? (c = !0)
              : ((c = !1), (b = !0));
            break;
          case "nocube":
            2 >= this.raw.header.NAXIS ? (c = !0) : ((c = !1), (b = !0));
            break;
          case "noext":
            this.hdus && 1 !== this.hdus.length ? ((c = !1), (b = !0)) : (c = !0);
            break;
          case "size":
            w[e + 1]
              ? a.vsize(m.fits.vfile) > 1e6 * w[e + 1]
                ? (c = !0)
                : ((c = !1), (b = !0))
              : ((c = !1), (b = !0));
        }
      c
        ? (2 < a.DEBUG &&
            a.log("removing underlying FITS vfile for %s: %s", this.id, this.raw.hdu.fits.vfile),
          a.cleanupFITSFile(this.raw, !0))
        : k &&
          (2 < a.DEBUG && a.log("freeing heap space for %s: %s", this.id, this.raw.hdu.fits.vfile),
          a.cleanupFITSFile(this.raw, !1));
    }
    this.xeqPlugins("image", "onrawdata");
    return this;
  };
  a.Image.prototype.mkSection = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = this;
    d = this.rgb.sect;
    var f = function (a) {
        var b = e.display.canvas;
        return e.params.transformAngle
          ? ((b = Math.max(b.width, b.height)), Math.min(e.raw.width * a, b))
          : Math.min(e.raw.width * a, b.width);
      },
      g = function (a) {
        var b = e.display.canvas;
        return e.params.transformAngle
          ? ((b = Math.max(b.width, b.height)), Math.min(e.raw.height * a, b))
          : Math.min(e.raw.height * a, b.height);
      };
    d.ozoom = d.zoom;
    switch (b.length) {
      case 0:
        d.xcen = Math.floor(this.raw.width / 2);
        d.ycen = Math.floor(this.raw.height / 2);
        d.width = f(1);
        d.height = g(1);
        break;
      case 1:
        a.isNumber(b[0]) || a.error("invalid input for generating section: " + b[0]);
        d.zoom = parseFloat(b[0]);
        d.width = f(d.zoom);
        d.height = g(d.zoom);
        break;
      case 2:
        (a.isNumber(b[0]) && a.isNumber(b[1])) ||
          a.error("invalid input for generating section: " + b[0] + " " + b[1]);
        d.xcen = parseFloat(b[0]);
        d.ycen = parseFloat(b[1]);
        a.notNull(d.ix) && (d.width = f(d.zoom));
        a.notNull(d.iy) && (d.height = g(d.zoom));
        break;
      case 3:
        ((a.isNumber(b[0]) && a.isNumber(b[1]) && a.isNumber(b[2])) ||
          a.error("invalid input for generating section: " + b[0] + " " + b[1] + " " + b[2]),
          (d.xcen = parseFloat(b[0])),
          (d.ycen = parseFloat(b[1])),
          (d.zoom = parseFloat(b[2])),
          (d.width = f(d.zoom)),
          (d.height = g(d.zoom)));
    }
    delete d.ix;
    delete d.iy;
    d.x0 = d.xcen - d.width / (2 * d.zoom);
    d.y0 = d.ycen - d.height / (2 * d.zoom);
    d.x1 = d.xcen + d.width / (2 * d.zoom);
    d.y1 = d.ycen + d.height / (2 * d.zoom);
    0 > d.x0 &&
      (a.globalOpts.panWithinDisplay ? (d.x1 -= d.x0) : (d.ix = d.x0 * d.zoom), (d.x0 = 0));
    0 > d.y0 &&
      (a.globalOpts.panWithinDisplay ? (d.y1 -= d.y0) : (d.iy = d.y0 * d.zoom), (d.y0 = 0));
    d.x1 > this.raw.width &&
      (a.globalOpts.panWithinDisplay
        ? (d.x0 -= d.x1 - this.raw.width)
        : (d.ix = (d.x1 - this.raw.width) * d.zoom),
      (d.x1 = this.raw.width));
    d.y1 > this.raw.height &&
      (a.globalOpts.panWithinDisplay
        ? (d.y0 -= d.y1 - this.raw.height)
        : (d.iy = (d.y1 - this.raw.height) * d.zoom),
      (d.y1 = this.raw.height));
    0 < d.ix && 0 < d.x0 && ((b = Math.min(d.ix, d.x0)), (d.x0 -= b), (d.ix += b * d.zoom));
    0 > d.ix &&
      d.x1 < this.raw.width &&
      ((b = Math.min(this.raw.width - d.x1, Math.abs(d.ix))), (d.x1 += b), (d.ix -= b * d.zoom));
    0 < d.iy && 0 < d.y0 && ((b = Math.min(d.iy, d.y0)), (d.y0 -= b), (d.iy += b * d.zoom));
    0 > d.iy &&
      d.y1 < this.raw.height &&
      ((b = Math.min(this.raw.height - d.y1, Math.abs(d.iy))), (d.y1 += b), (d.iy -= b * d.zoom));
    d.x0 = Math.max(0, d.x0);
    d.x1 = Math.min(this.raw.width, d.x1);
    d.y0 = Math.max(0, d.y0);
    d.y1 = Math.min(this.raw.height, d.y1);
    d.x0 = Math.floor(d.x0);
    d.y0 = Math.floor(d.y0);
    d.x1 = Math.floor(d.x1);
    d.y1 = Math.floor(d.y1);
    d.width = Math.ceil((d.x1 - d.x0) * d.zoom);
    d.height = Math.ceil((d.y1 - d.y0) * d.zoom);
    if (0 >= d.width || 0 >= d.height)
      ((b = sprintf(
        "invalid image section: %s,%s [%s,%s, %s,%s, %s]",
        d.width,
        d.height,
        d.x0,
        d.y0,
        d.x1,
        d.y1,
        d.zoom
      )),
        a.error(b));
    this.params.zoom = d.zoom;
    return this;
  };
  a.Image.prototype.mkColorData = function () {
    var c,
      b = a.SCALESIZE,
      d = this.params.scalemin,
      e = this.params.scalemax,
      f = this.raw.width * this.raw.height,
      g = (b - 1) / (e - d);
    if ("static" === this.cmapObj.type) return this;
    if (!this.colorData || this.colorData.length < f) this.colorData = new Int32Array(f);
    var h = this.raw.data;
    var l = this.colorData;
    for (c = 0; c < f; c++) {
      var m = h[c];
      l[c] = m <= d ? 0 : m >= e ? b - 1 : Math.floor((m - d) * g + 0.5);
    }
    return this;
  };
  a.Image.prototype.calcContrastBias = function (c) {
    var b = this.params.bias,
      d = a.COLORSIZE,
      e = this.params.contrast;
    if (1e-4 > b - 0.5 && 1e-4 > e - 1) return c;
    this.params.invert && (b = 1 - b);
    c = Math.floor(((c / d - b) * e + 0.5) * d);
    return 0 > c ? 0 : c >= d ? d - 1 : c;
  };
  a.Image.prototype.mkColorCells = function () {
    var c,
      b = a.COLORSIZE;
    if ("static" === this.cmapObj.type) return this;
    this.colorCells || (this.colorCells = []);
    for (c = 0; c < b; c++) {
      var d = this.params.invert ? b - c - 1 : c;
      d = this.calcContrastBias(d);
      this.colorCells[c] = this.cmapObj.mkColorCell(d);
    }
    return this;
  };
  a.Image.prototype.mkScaledCells = function () {
    var c, b;
    var d = a.COLORSIZE;
    var e = a.SCALESIZE,
      f = a.INVSIZE;
    var g = a.HISTSIZE;
    if (!this.colorCells || "static" === this.cmapObj.type) return this;
    if (!this.psColors) {
      var h = (this.psColors = []);
      var l = this.params.nancolor;
      var m = [];
      "#" === l.charAt(0) && (l = l.slice(1));
      l = l.toUpperCase();
      for (c = b = 0; 6 > b; b += 2, c++) {
        var k = "0123456789ABCDEF".indexOf(l.charAt(b));
        var q = "0123456789ABCDEF".indexOf(l.charAt(b + 1));
        m[c] = 16 * k + q;
      }
      h[NaN] = m;
    }
    this.psInverse || ((this.psInverse = []), (this.psInverse[NaN] = 0));
    l = this.params.scalemax - this.params.scalemin;
    b = this.params.scalemin;
    switch (this.params.scale) {
      case "linear":
        for (h = 0; h < e; h++)
          ((c = h / e), (c = Math.floor(c * d)), (this.psColors[h] = this.colorCells[c]));
        for (h = 0; h < f; h++) ((c = h / f), (this.psInverse[h] = c * l + b));
        break;
      case "log":
        g = this.params.exp;
        for (h = 0; h < e; h++)
          ((c = Math.log((g * h) / e + 1) / Math.log(g)),
            (c = Math.floor(c * d)),
            c >= d && (c = d - 1),
            (this.psColors[h] = this.colorCells[c]));
        for (h = 0; h < f; h++)
          ((c = (Math.pow(g, h / f) - 1) / g), (this.psInverse[h] = c * l + b));
        break;
      case "power":
        g = this.params.exp;
        for (h = 0; h < e; h++)
          ((c = (Math.pow(g, h / e) - 1) / g),
            (c = Math.floor(c * d)),
            c >= d && (c = d - 1),
            (this.psColors[h] = this.colorCells[c]));
        for (h = 0; h < f; h++)
          ((c = Math.log((g * h) / f + 1) / Math.log(g)), (this.psInverse[h] = c * l + b));
        break;
      case "sqrt":
        for (h = 0; h < e; h++)
          ((c = h / e),
            (c = Math.floor(Math.sqrt(c) * d)),
            c >= d && (c = d - 1),
            (this.psColors[h] = this.colorCells[c]));
        for (h = 0; h < f; h++) ((c = h / f), (this.psInverse[h] = c * c * l + b));
        break;
      case "squared":
        for (h = 0; h < e; h++)
          ((c = h / e),
            (c = Math.floor(c * c * d)),
            c >= d && (c = d - 1),
            (this.psColors[h] = this.colorCells[c]));
        for (h = 0; h < f; h++) ((c = Math.sqrt(h / f)), (this.psInverse[h] = c * l + b));
        break;
      case "asinh":
        for (h = 0; h < e; h++)
          ((c = h / e),
            (c = Math.floor((Math.asinh(10 * c) / 3) * d)),
            c >= d && (c = d - 1),
            (this.psColors[h] = this.colorCells[c]));
        for (h = 0; h < f; h++)
          ((c = h / f), (c = Math.sinh(3 * c) / 10), (this.psInverse[h] = c * l + b));
        break;
      case "sinh":
        for (h = 0; h < e; h++)
          ((c = h / e),
            (c = Math.floor((Math.sinh(3 * c) / 10) * d)),
            c >= d && (c = d - 1),
            (this.psColors[h] = this.colorCells[c]));
        for (h = 0; h < f; h++)
          ((c = h / f), (c = Math.asinh(10 * c) / 3), (this.psInverse[h] = c * l + b));
        break;
      case "histeq":
        m = this.raw.data;
        var u = this.raw.width * this.raw.height;
        l = this.raw.dmax - this.raw.dmin;
        var p = this.raw.dmax;
        b = this.raw.dmin;
        var n = (c = 0);
        k = [];
        if (!this.hist || !this.hist.length) {
          this.hist = [];
          for (h = 0; h < g; h++) k[h] = 0;
          for (h = 0; h < u; h++)
            m[h] >= b &&
              m[h] <= p &&
              ((q = Math.floor(((m[h] - b) / l) * g + 0.5)), q < g && (k[q] += 1));
          for (h = 0; h < g; h++) n += k[h];
          q = n / g;
          for (h = m = 0; h < g && m < g; h++)
            for (this.hist[h] = m / g, c += k[h]; c >= q && m < g; ) ((c -= q), m++);
          for (c = (g - 1) / g; h < g; ) this.hist[h++] = c;
        }
        for (h = 0; h < e; h++)
          ((c = this.hist[(h * g) / e]),
            (c = Math.floor(c * d)),
            (this.psColors[h] = this.colorCells[c]));
        for (h = 0; h < f; h++) {
          d = h / f;
          for (q = 0; q < g - 1 && !(this.hist[q] > d); q++);
          c = q / g;
          this.psInverse[h] = c * l + b;
        }
        break;
      default:
        a.error("unknown scale '" + this.params.scale + "'");
    }
    return this;
  };
  a.Image.prototype.mkRGBImage = function () {
    var c,
      b,
      d,
      e,
      f = !1,
      g = null,
      h = null,
      l = null,
      m = !1,
      k = !1,
      q = !1,
      u = !1,
      p = [];
    if (!this.rgb) return this;
    !this.display.rgb.active ||
      (this !== this.display.rgb.rim &&
        this !== this.display.rgb.gim &&
        this !== this.display.rgb.bim) ||
      ((m = !0),
      this.display.rgb.rim && (g = this.display.rgb.rim),
      this.display.rgb.gim && (h = this.display.rgb.gim),
      this.display.rgb.bim && (l = this.display.rgb.bim));
    var n = this.display.context;
    var x = this.rgb;
    var w = x.sect;
    if (
      (this.MakeRGBImage && "function" === typeof this.MakeRGBImage && this.MakeRGBImage()) ||
      (this.MakePrimaryImage &&
        "function" === typeof this.MakePrimaryImage &&
        this.MakePrimaryImage())
    )
      return this;
    if (this.useOffScreenCanvas()) {
      var t = w.width / w.zoom;
      var v = w.height / w.zoom;
      var r = w.x0;
      var z = this.offscreen.canvas.height - 1 - (w.y0 + v);
      z = this.offscreen.context.getImageData(r, z, t, v);
      if (1 === w.zoom) x.img = z;
      else
        for (
          x.img = n.createImageData(w.width, w.height), x = x.img, d = c = 0;
          c < z.height;
          c++, d++
        ) {
          var y = c * z.width;
          var A = d * w.zoom;
          for (b = n = 0; n < z.width; n++, b++) {
            r = 4 * (y + n);
            var B = b * w.zoom;
            for (e = 0; e < w.zoom; e++) {
              var C = Math.floor(A + e);
              var D = C * w.width;
              for (C = 0; C < w.zoom; C++) {
                var E = Math.floor(B + C);
                E = 4 * (D + E);
                x.data[E] = z.data[r];
                x.data[E + 1] = z.data[r + 1];
                x.data[E + 2] = z.data[r + 2];
                x.data[E + 3] = z.data[r + 3];
              }
            }
          }
        }
      return this;
    }
    (x.img && x.img.width === w.width && x.img.height === w.height) ||
      (x.img = n.createImageData(w.width, w.height));
    x = x.img;
    var F = x.data.length - 4;
    if (!this.psColors && !this.staticObj) return this;
    var G =
      void 0 !== this.params.opacity
        ? Math.floor(255 * this.params.opacity)
        : void 0 !== this.params.alpha
          ? this.params.alpha
          : 255;
    if (this.mask.active && this.mask.im) {
      var J = this.mask.im;
      if ("mask" === this.mask.mode) {
        k = !0;
        var I = a.notNull(this.mask.vopacity) ? 255 * this.mask.vopacity : 0;
        var K = a.notNull(this.params.opacity) ? 255 * this.params.opacity : 255;
        this.mask.invert && ((G = I), (I = K), (K = G));
      } else if ("opacity" === this.mask.mode) q = !0;
      else if ("overlay" === this.mask.mode) {
        u = !0;
        var L = J.rgb.img;
        a.isNull(this.mask.opacity) && (this.mask.opacity = 1);
      }
    } else if (a.notNull(this.params.flooropacity) && !m) {
      var R = 255 * this.params.flooropacity;
      var M = this.params.floorvalue;
      f = !0;
    }
    var N = Math.max(1, Math.floor(1 / w.zoom));
    var P = w.zoom * N;
    c = Math.floor(w.y1 - 1);
    for (d = 0; c >= w.y0; c -= N, d++)
      for (y = c * this.raw.width, A = d * P, n = Math.floor(w.x0), b = 0; n < w.x1; n += N, b++) {
        k ? (G = J.raw.data[y + n] > this.mask.value ? K : I) : q && (G = 255 * J.raw.data[y + n]);
        if (m) {
          if (
            ((z = g ? g.colorData[y + n] : 0),
            (t = h ? h.colorData[y + n] : 0),
            (v = l ? l.colorData[y + n] : 0),
            a.isNull(z) || a.isNull(t) || a.isNull(v))
          )
            return (
              (this.display.rgb.active = !1),
              a.error("RGB images are incompatible. Turning off RGB mode.", "", !1),
              this.mkRGBImage(),
              this
            );
        } else this.staticObj || (r = this.colorData[y + n]);
        var Q = G;
        f && this.raw.data[y + n] <= M && (Q = R);
        B = b * P;
        for (e = 0; e < w.zoom; e++)
          for (C = Math.ceil(A + e), D = C * w.width, C = 0; C < w.zoom; C++)
            if (((E = Math.ceil(B + C)), (E = 4 * (D + E)), E <= F))
              if (m)
                ((x.data[E] = g ? g.psColors[z][0] : 0),
                  (x.data[E + 1] = h ? h.psColors[t][1] : 0),
                  (x.data[E + 2] = l ? l.psColors[v][2] : 0),
                  (x.data[E + 3] = G));
              else if (this.staticObj) {
                var H = this.raw.data[y + n];
                H = a.lookupStaticColor(this, H, p);
                x.data[E] = H.red;
                x.data[E + 1] = H.green;
                x.data[E + 2] = H.blue;
                x.data[E + 3] = H.alpha;
              } else if (void 0 !== this.psColors[r])
                if (u && L.data[E + 3]) {
                  H = (L.data[E + 3] / 255) * this.mask.opacity;
                  var O = 1 - H;
                  x.data[E] = L.data[E] * H + this.psColors[r][0] * O;
                  x.data[E + 1] = L.data[E + 1] * H + this.psColors[r][1] * O;
                  x.data[E + 2] = L.data[E + 2] * H + this.psColors[r][2] * O;
                  x.data[E + 3] = 255;
                } else
                  ((x.data[E] = this.psColors[r][0]),
                    (x.data[E + 1] = this.psColors[r][1]),
                    (x.data[E + 2] = this.psColors[r][2]),
                    (x.data[E + 3] = Q));
      }
    return this;
  };
  a.Image.prototype.blendImage = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b);
    d = e.next().value;
    var f = e.next().value;
    e = e.next().value;
    var g =
      /normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i;
    if (0 === b.length) return this.blend;
    if (!0 === d || !1 === d || "true" === d || "false" === d)
      return (
        "true" === d ? (d = !0) : "false" === d && (d = !1),
        (this.blend.active = d),
        this.xeqPlugins("image", "onimageblend"),
        this.display.blendMode && this.displayImage(),
        this
      );
    if (a.notNull(d) || a.notNull(f))
      (a.notNull(d) &&
        (g.test(d) || a.error("invalid composite/blend operation: " + d), (this.blend.mode = d)),
        a.notNull(f) &&
          ("string" === typeof f
            ? (f = parseFloat(f))
            : "number" !== typeof f && a.error("invalid opacity: " + f),
          (this.blend.opacity = Math.min(Math.max(f, 0), 1))),
        a.notNull(e) &&
          ("true" === e ? (e = !0) : "false" === e && (e = !1), (this.blend.active = e)),
        this.xeqPlugins("image", "onimageblend"),
        this.display.blendMode && this.blend.active && this.displayImage());
    return this;
  };
  a.Image.prototype.maskImage = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b);
    d = e.next().value;
    e = e.next().value;
    var f, g;
    if (!b.length) return this.mask;
    if (!0 === d || !1 === d || "true" === d || "false" === d)
      return (
        "true" === d ? (d = !0) : "false" === d && (d = !1),
        (this.mask.active = d),
        this.xeqPlugins("image", "onimagemask"),
        this.displayImage(),
        this
      );
    if ("string" === typeof d && "{" === d.charAt(0))
      try {
        d = JSON.parse(d);
      } catch (h) {
        a.error("can't parse JSON in maskImage: " + d, h);
      }
    a.isImage(d) || e || ((e = d), (d = null));
    d &&
      ((f = a.lookupImage(d)) || a.error("unknown image for maskImage: " + d),
      (this.raw.width === f.raw.width && this.raw.height === f.raw.height) ||
        a.error(
          "maskImage: mask dims (" +
            f.raw.width +
            "," +
            f.raw.height +
            ") don't match image dims (" +
            this.raw.width +
            "," +
            this.raw.height +
            ")"
        ),
      (this.mask.im = f),
      (this.mask.active = !0));
    if (e) {
      if ("string" === typeof e)
        try {
          e = JSON.parse(e);
        } catch (h) {
          a.error("can't parse JSON in maskImage: " + e, h);
        }
      for (g in e)
        if (Object.prototype.hasOwnProperty.call(e, g))
          switch (g) {
            case "opacity":
              this.mask.vopacity = e[g];
              break;
            default:
              this.mask[g] = e[g];
          }
    }
    !f ||
      (e && !1 === e.sync) ||
      "function" !== typeof this.syncImages ||
      this.syncImages(this.mask.syncops, [f]);
    (f || e) && this.displayImage();
  };
  a.Image.prototype.calcDisplayOffsets = function (c) {
    var b = this.rgb.sect;
    this.ix = (this.display.canvas.width - this.rgb.img.width) / 2;
    this.iy = (this.display.canvas.height - this.rgb.img.height) / 2;
    a.notNull(b.ix) && (this.ix -= b.ix / 2);
    a.notNull(b.iy) && (this.iy += b.iy / 2);
    this.ix = Math.floor(this.ix);
    this.iy = Math.floor(this.iy);
    if (c && this.wcsAlign()) {
      var d = this.wcsim;
      c = d.rgb.sect;
      d = a.pix2pix(d, this, d.getPan());
      var e = a.globalOpts.panWithinDisplay;
      a.globalOpts.panWithinDisplay = !0;
      this.tmp.ozoom = this.rgb.sect.ozoom;
      this.mkSection(d.x, d.y, c.zoom);
      this.rgb.sect.ozoom = this.tmp.ozoom;
      delete this.tmp.ozoom;
      a.globalOpts.panWithinDisplay = e;
      this.ix -= (b.xcen - (b.x0 + b.x1) / 2) * c.zoom;
      this.iy += (b.ycen - (b.y0 + b.y1) / 2) * c.zoom;
    }
    return this;
  };
  a.Image.prototype.putImage = function (c) {
    var b = this,
      d = this.rgb,
      e = this.display.context;
    c = c || {};
    "reproject" === this.rawDataLayer() &&
      c.wcsim &&
      ((this.wcsim = c.wcsim), (this.wcsim.isawcsim = !0));
    this.calcDisplayOffsets(!0);
    e.save();
    void 0 !== c.opacity && (e.globalAlpha = c.opacity);
    void 0 !== c.blend && (e.globalCompositeOperation = c.blend);
    if (this.params.transform) {
      c = this.params.transform;
      var f = this.display.width / 2;
      var g = this.display.height / 2;
      e.translate(f, g);
      e.transform(c[0][0], c[0][1], c[1][0], c[1][1], c[2][0], c[2][1]);
      e.translate(-f, -g);
    }
    e.drawImage(
      (function (c) {
        if (!b.offscreenRGB) {
          var d = document.createElement("canvas");
          var e = d.getContext("2d");
          a.ANTIALIAS || (e.imageSmoothingEnabled = !1);
          b.offscreenRGB = { canvas: d, context: e };
        }
        b.offscreenRGB.canvas.width = c.width;
        b.offscreenRGB.canvas.height = c.height;
        b.offscreenRGB.context.putImageData(c, 0, 0);
        return b.offscreenRGB.canvas;
      })(d.img),
      this.ix,
      this.iy
    );
    e.restore();
    return this;
  };
  a.Image.prototype.displayImage = function (c, b) {
    var d = 0;
    var e = [],
      f = {};
    if (!1 === c) return ((this.displayMode = !1), this);
    !0 === c && ((this.displayMode = !0), (c = "all"));
    if (!this.displayMode) return this;
    "object" === typeof c && ((b = c), (c = null));
    c
      ? "all" === c
        ? ((c = "colors,scaled,rgb,display,plugins"), (f.notify = !0))
        : "rgbonly" === c
          ? ((c = "rgb,nodisplay"), (f.notify = !0))
          : "display" === c && (f.notify = !0)
      : (c = "rgb");
    c.split(",").forEach(function (a, b, c) {
      a = a.trim();
      f[a] = !0;
      switch (a) {
        case "colors":
          f.scaled = !0;
          f.rgb = !0;
          break;
        case "scaled":
          f.rgb = !0;
      }
    });
    f.display = !0;
    f.plugins = !0;
    this.useOffScreenCanvas() && ((f.colors = !1), (f.scaled = !1));
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (h) {
        a.error("can't parse displayImage opts: " + b, h);
      }
    if (this.display.blendMode && !1 !== b.blendMode)
      for (c = 0; c < a.images.length; c++) {
        var g = a.images[c];
        g.display === this.display && g.blend.active && (e.push(g), d++);
      }
    f.colors && this.mkColorData();
    f.scaled && (this.mkColorCells(), this.mkScaledCells());
    if (f.rgb && (this.mkRGBImage(), d))
      for (c = e.length - 1; 0 <= c; c--) ((g = e[c]), g.mkRGBImage());
    if (f.nodisplay) return this;
    if (f.display) {
      this.display.context.clear();
      if (d) {
        for (c = e.length - 1; 0 <= c; c--) e[c].calcDisplayOffsets(!1);
        for (c = e.length - 1; 0 <= c; c--)
          ((g = e[c]),
            (d = { wcsim: b.wcsim, blend: g.blend.mode, opacity: g.blend.opacity }),
            g.putImage(d),
            g === this && g.displayShapeLayers());
      } else (this.putImage(b), this.displayShapeLayers());
      for (this.display.image = this; this.delayedShapes && this.delayedShapes.length; ) {
        this.tmp.syncRunning = !0;
        b = this.delayedShapes.shift();
        switch (b.mode) {
          case "add":
            this.addShapes(b.layer, b.shape, b.opts);
            break;
          case "change":
            this.changeShapes(b.layer, b.shape, b.opts);
        }
        delete this.tmp.syncRunning;
      }
      delete this.delayedShapes;
    }
    this.xeqPlugins("image", "onimagedisplay");
    return this;
  };
  a.Image.prototype.refreshImage = function (c, b) {
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (h) {
        a.error("can't parse refreshImage opts: " + b, h);
      }
    if (c && "string" !== typeof c) {
      b.rawid = b.rawid || a.RAWID0;
      "function" === typeof b && (b = { onrefresh: b });
      !b.onrefresh && a.imageOpts.onrefresh && (b.onrefresh = a.imageOpts.onrefresh);
      if (!b.resetSection) {
        var d = this.imageToLogicalPos({ x: this.rgb.sect.xcen, y: this.rgb.sect.ycen });
        if (this.validWCS()) {
          var e = a.pix2wcs(this.raw.wcs, this.rgb.sect.xcen, this.rgb.sect.ycen);
          var f = e.trim().split(/\s+/);
          var g = a.saostrtod(f[0]);
          a.isHMS(this.params.wcssys) && (g *= 15);
          f = a.saostrtod(f[1]);
        }
      }
      e = this.rgb.sect.zoom;
      this.binning.obin = this.binning.bin;
      this.mkRawDataFromHDU(c, b);
      b.resetSection
        ? (this.mkSection(), this.mkSection(e))
        : (this.validWCS() && a.notNull(g) && a.notNull(f)
            ? ((f = a.wcs2pix(this.raw.wcs, g, f).trim().split(/ +/)),
              (c = { x: parseFloat(f[0]), y: parseFloat(f[1]) }))
            : (c = this.logicalToImagePos({ x: d.x, y: d.y })),
          0 < c.x && c.x < this.raw.width && 0 < c.y && c.y < this.raw.height
            ? this.mkSection(c.x, c.y, e)
            : (this.mkSection(), this.mkSection(e)));
      this.displayImage("colors", b);
      this.reFlipRot();
      this.notifyHelper();
      if (b.refreshRegions || b.resetSection || this.binning.obin !== this.binning.bin)
        (this.refreshLayers(), this.updateShapes("regions", "all", "binning"));
      this.xeqPlugins("image", "onimagerefresh");
      a.waiting(!1);
      if (b.onrefresh)
        try {
          a.xeqByName(b.onrefresh, window, this);
        } catch (h) {
          a.error("in image refresh callback", h);
        }
      return this;
    }
    b.onrefresh && ((b.onload = b.onrefresh), delete b.onrefresh);
    b.refresh = this;
    e = document.domain ? c || this.file : c || this.fitsFile || this.file;
    a.Load(e, b, { display: this.display });
  };
  a.Image.prototype.fileDimensions = function () {
    if (this.parent && "BINTABLE" !== this.parent.raw.header.XTENSION) {
      var a = this.parent.raw.header.TABDIM1
        ? this.parent.raw.header.TABDIM1
        : this.parent.raw.header.NAXIS1;
      var b = this.parent.raw.header.TABDIM2
        ? this.parent.raw.header.TABDIM2
        : this.parent.raw.header.NAXIS2;
    } else
      ((a = this.raw.header.TABDIM1 ? this.raw.header.TABDIM1 : this.raw.header.NAXIS1),
        (b = this.raw.header.TABDIM2 ? this.raw.header.TABDIM2 : this.raw.header.NAXIS2));
    return { xdim: a, ydim: b };
  };
  a.Image.prototype.maybePhysicalToImage = function (c) {
    if ("image" === this.imtab && this.parent && this.parent.lcs && c.x && c.y) {
      c = { x: c.x, y: c.y };
      c = a.Image.prototype.logicalToImagePos.call(this.parent, c, "ophysical");
      var b = { x: Math.floor(c.x + 0.5), y: Math.floor(c.y + 0.5) };
    }
    return b;
  };
  a.Image.prototype.displaySection = function (c, b) {
    var d = this,
      e,
      f,
      g,
      h,
      l,
      m,
      k,
      q,
      u = function (b, c, d) {
        var e;
        a.isNull(b) ? a.isNull(c) || (e = c) : (e = b);
        return e || d;
      },
      p = function (c, e) {
        var f = "";
        k = $.extend(!0, {}, e || {});
        a.isNull(k.refreshRegions) && (k.refreshRegions = !0);
        a.isNull(k.resetSection) && (k.resetSection = !0);
        !1 !== k.waiting && a.waiting(!0, d.display);
        c.fits.extname
          ? (f = "[" + c.fits.extname + "]")
          : c.fits.extnum && 0 < c.fits.extnum
            ? (f = "[" + c.fits.extnum + "]")
            : d.parent &&
              (d.parent.extname
                ? (f = "[" + d.parent.extname + "]")
                : d.parent.extnum && 0 < d.parent.extnum && (f = "[" + d.parent.extnum + "]"));
        f &&
          (k.id || (k.id = d.id.replace(/\[.*\]/, "") + f),
          k.file || (k.file = d.file.replace(/\[.*\]/, "") + f));
        if (k.separate) {
          delete k.xcen;
          delete k.ycen;
          if ("string" === typeof k.separate) {
            f = k.separate.split(":");
            switch (f.length) {
              case 1:
                e = f[0];
                break;
              default:
                ((e = f[0]), (k.id = f[1]));
            }
            k.display = a.lookupDisplay(e);
          } else k.display = d.display;
          "parentFile" === g &&
            d.fitsFile &&
            ((e = a.lookupImage(d.fitsFile)),
            (k.parentFile = e && e.parentFile ? e.parentFile : d.fitsFile));
          l = d.listRegions("all", {
            mode: 1,
            includedcoords: !0,
            ignoreignore: !0,
            saveediting: !0,
            savewcsconfig: !0,
            saveid: !0,
          });
          b = k.ondisplaysection || k.onrefresh || b;
          m = new a.Image(c, k, b);
          m.binning.obin = m.binning.bin;
          l && !1 !== k.refreshRegions && m.addShapes("regions", l, { restoreid: !0 });
          d.reFlipRot();
          m.setStatus("displaySection", "complete");
        } else if ("string" === typeof k.refresh) {
          delete k.xcen;
          delete k.ycen;
          f = k.refresh.split(":");
          switch (f.length) {
            case 1:
              e = f[0];
              break;
            default:
              ((e = f[0]), (k.id = f[1]));
          }
          k.display = a.lookupDisplay(e);
          k.display.image
            ? ((k.rawid = d.raw.id),
              (k.onrefresh = k.ondisplaysection || k.onrefresh || b),
              k.display.image.refreshImage(c, k))
            : ("parentFile" === g &&
                d.fitsFile &&
                ((e = a.lookupImage(d.fitsFile)),
                (k.parentFile = e && e.parentFile ? e.parentFile : d.fitsFile)),
              (l = d.listRegions("all", {
                mode: 1,
                includedcoords: !0,
                ignoreignore: !0,
                saveediting: !0,
                savewcsconfig: !0,
                saveid: !0,
              })),
              (b = k.ondisplaysection || k.onrefresh || b),
              (m = new a.Image(c, k, b)),
              (m.binning.obin = m.binning.bin),
              l && m.addShapes("regions", l, { restoreid: !0 }),
              d.reFlipRot());
        } else
          ((k.rawid = d.raw.id),
            (k.onrefresh = k.ondisplaysection || k.onrefresh || b),
            d.refreshImage(c, k));
        d.setStatus("displaySection", "complete");
        a.waiting(!1);
      };
    (this.raw && this.raw.hdu && this.raw.hdu.fits) || a.error("invalid image for displaySection");
    c = c || {};
    if ("full" === c) {
      var n = this.fileDimensions();
      c = { xdim: n.xdim, ydim: n.ydim, xcen: 0, ycen: 0 };
    } else {
      if ("selected" === c) {
        this._selectShapes("regions", "selected", null, function (a) {
          a = a.pub;
          var c,
            e = 0,
            f = 0,
            g = 1e6,
            h = 0,
            l = 1e6,
            m = 0,
            u = a.shape;
          if (!d.parentFile && a.lcs) {
            a = a.lcs;
            var p = a.x;
            var q = a.y;
            if ((c = d.maybePhysicalToImage({ x: p, y: q }))) ((p = c.x), (q = c.y));
          } else ((p = a.x), (q = a.y));
          switch (u) {
            case "annulus":
              var n = 2 * a.radii[a.radii.length - 1];
              var x = 2 * a.radii[a.radii.length - 1];
              break;
            case "box":
              n = a.width;
              x = a.height;
              break;
            case "circle":
              n = 2 * a.radius;
              x = 2 * a.radius;
              break;
            case "cross":
              n = a.width;
              x = a.height;
              break;
            case "ellipse":
              n = 2 * a.r1;
              x = 2 * a.r2;
              break;
            case "polygon":
            case "line":
              for (n = 0; n < a.pts.length; n++)
                ((e += a.pts[n].x),
                  (f += a.pts[n].y),
                  a.pts[n].x > h && (h = a.pts[n].x),
                  a.pts[n].x < g && (g = a.pts[n].x),
                  a.pts[n].y > m && (m = a.pts[n].y),
                  a.pts[n].y < l && (l = a.pts[n].y));
              a.x = e / a.pts.length;
              a.y = f / a.pts.length;
              "line" === a.shape && 2 === a.pts.length
                ? ((n = Math.sqrt(
                    (a.pts[0].x - a.pts[1].x) * (a.pts[0].x - a.pts[1].x) +
                      (a.pts[0].y - a.pts[1].y) * (a.pts[0].y - a.pts[1].y)
                  )),
                  (x = 1))
                : ((n = h - g), (x = m - l));
              break;
            case "text":
              x = n = 10;
          }
          k = {
            xcen: p,
            ycen: q,
            xdim: n,
            ydim: x,
            from: "virtualFile",
            separate: !0,
            refreshRegions: !1,
            resetSection: !0,
          };
          d.displaySection(k, b);
        });
        return;
      }
      if ("string" === typeof c)
        try {
          c = JSON.parse(c);
        } catch (t) {
          a.error("can't parse displaySection opts: " + c, t);
        }
    }
    c.cubecol = c.cubecol || "";
    c.cubecol &&
      (c.id || (c.id = this.id.replace(/\[.*\]/, "") + " (cube: " + c.cubecol + ")"),
      c.file ||
        (c.file = this.file
          .split("/")
          .reverse()[0]
          .replace(/\[.*\]/, "")
          .replace(".fits", "_cube:" + c.cubecol + ".fits")
          .replace(".ftz", "_cube:" + c.cubecol + ".ftz")
          .replace(/:/g, "_")),
      !1 !== c.separate && (c.separate = !0));
    var x = c.separate ? $.extend(!0, {}, this.raw.hdu) : this.raw.hdu;
    (g = c.from) ||
      (g =
        this.parentFile && a.helper.connected && a.helper.js9helper ? "parentFile" : "virtualFile");
    if ("table" === this.imtab && x.table) n = x.table;
    else {
      n = {};
      n.bin = x.bin || 1;
      "parentFile" === g &&
        this.raw.header &&
        a.notNull(this.raw.header.LTM1_1) &&
        (n.bin = 1 / Math.abs(this.raw.header.LTM1_1));
      var w = { x: this.raw.width / 2, y: this.raw.height / 2 };
      w = this.imageToLogicalPos(w);
      n.xcen = Math.floor(w.x + 0.5 * (n.bin - 1));
      n.ycen = Math.floor(w.y + 0.5 * (n.bin - 1));
      if ((w = this.maybePhysicalToImage({ x: n.xcen, y: n.ycen })))
        ((n.xcen = w.x), (n.ycen = w.y));
      n.xdim = Math.floor(x.naxis1 * n.bin);
      n.ydim = Math.floor(x.naxis2 * n.bin);
      n.filter = this.raw.filter || "";
      n.columns = this.raw.columns || "";
    }
    if ("string" === typeof c.bin)
      switch (
        (c.bin.match(/[as]$/) && ((c.binMode = c.bin.slice(-1)), (c.bin = c.bin.slice(0, -1))),
        (w = n.bin || this.binning.bin),
        c.bin.charAt(0))
      ) {
        case "*":
        case "x":
        case "X":
          c.bin = w * parseFloat(c.bin.slice(1));
          break;
        case "/":
          c.bin = w / parseFloat(c.bin.slice(1));
          break;
        case "i":
        case "I":
          c.bin = 2 * w;
          break;
        case "o":
        case "O":
          c.bin = w / 2;
          break;
        default:
          a.isNumber(c.bin)
            ? (c.bin = parseFloat(c.bin))
            : a.error("invalid bin for displaySection: " + c.bin);
      }
    c.xcen = u(c.xcen, n.xcen, 0);
    c.ycen = u(c.ycen, n.ycen, 0);
    switch (this.imtab) {
      case "table":
        c.xdim = u(c.xdim, n.xdim, a.fits.options.table.xdim);
        c.ydim = u(c.ydim, n.ydim, a.fits.options.table.ydim);
        c.bin = u(c.bin, n.bin, a.fits.options.table.bin);
        break;
      default:
        ((c.xdim = u(c.xdim, n.xdim, a.fits.options.image.xdim)),
          (c.ydim = u(c.ydim, n.ydim, a.fits.options.image.ydim)),
          (c.bin = u(c.bin, n.bin, a.fits.options.image.bin)));
    }
    c.binMode = u(c.binMode, n.binMode, a.globalOpts.binMode);
    "string" === typeof c.bin &&
      (c.bin.match(/[as]$/) && (c.binMode = c.bin.slice(-1)), (c.bin = parseFloat(c.bin)));
    c.bin || (c.bin = 1);
    "image" === this.imtab && 0 < c.bin && 1 > c.bin && (c.bin = 1 / Math.floor(1 / c.bin + 0.5));
    c.filter = u(c.filter, n.filter, "");
    this.raw.filter = c.filter || "";
    c.columns = u(c.columns, n.columns, "");
    this.raw.columns = c.columns || "";
    !1 !== c.waiting && a.waiting(!0, this.display);
    this.setStatus("displaySection", "processing");
    window.setTimeout(function () {
      switch (g) {
        case "parentFile":
          f = d.proxyFile;
          q = [];
          q.push({ name: "xcen", value: c.xcen });
          delete c.xcen;
          q.push({ name: "ycen", value: c.ycen });
          delete c.ycen;
          q.push({ name: "xdim", value: c.xdim });
          q.push({ name: "ydim", value: c.ydim });
          void 0 !== c.xdim && (c.xdim = 0);
          void 0 !== c.ydim && (c.ydim = 0);
          c.binMode && ((c.bin = "" + c.bin + c.binMode), delete c.binMode);
          q.push({ name: "bin", value: c.bin });
          delete c.bin;
          e = (c.filter || "") + "@@" + (c.cols || "");
          q.push({ name: "filter", value: e });
          q.push({ name: "slice", value: c.slice || "" });
          delete c.slice;
          h = { id: d.expandMacro("$id"), image: d.file, fits: d.parentFile, rtype: "text" };
          h.cmd = "js9Xeq imsection " + d.parentFile;
          c.extension &&
            ((h.cmd = h.cmd.replace(/\[.*\]/, "")),
            (h.cmd += "[" + c.extension + "]"),
            delete c.extension);
          h.cmd += d.expandMacro(" $xdim@$xcen,$ydim@$ycen,$bin $filter $slice", q);
          a.helper.send("imsection", h, function (b) {
            b =
              "object" === typeof b
                ? b
                : 0 <= b.search(a.analOpts.epattern)
                  ? { stderr: b }
                  : { stdout: b };
            if (b.stderr) a.error(b.stderr);
            else if (b.errcode) a.error("in displaySection: " + b.errcode);
            else {
              var e = b.stdout.split(/\n/);
              b = a.cleanPath(e[0]);
              "/" !== b.charAt(0) && (b = a.InstallDir(b));
              c.proxyFile = b;
              f && f !== c.proxyFile && d.removeProxyFile(f);
              if (e[1]) {
                try {
                  var g = JSON.parse(e[1]);
                } catch (z) {
                  (a.log("couldn't parse imsection as JSON: %s", b), (g = null));
                }
                g &&
                  ((c.extname = g.extname),
                  (c.extnum = g.extnum),
                  (c.hdus = g.hdus),
                  (c.binstr = g.binstr),
                  (c.parent = g));
              }
              e[2] && ((g = a.cleanPath(e[2])), (c.parentFile = g));
              a.fetchURL(b, b, c, function (b) {
                a.cleanupFITSFile(d.raw, !0);
                !1 !== c.waiting && a.waiting(!0, d.display);
                a.fits.handleFITSFile(b, c, p);
              });
            }
          });
          break;
        case "virtualFile":
          a.cleanupFITSFile(d.raw, !1);
          a.getFITSImage(x.fits, x, c, function (a) {
            p(a, c);
          });
          break;
        default:
          a.error("image section cannot be extracted from this data file");
      }
    }, a.SPINOUT);
  };
  a.Image.prototype.displayExtension = function (c, b, d) {
    var e = this,
      f,
      g,
      h = function (c) {
        var f = $.extend(!0, {}, b);
        f.separate = !0;
        if (c === e.hdus.length) {
          if (d)
            try {
              a.xeqByName(d, window, e);
            } catch (p) {
              a.error("in displayExtension callback", p, !1);
            }
        } else {
          var g = e.hdus[c];
          "image" === g.type && 2 <= g.naxis
            ? e.displayExtension(g.hdu, f, function () {
                h(c + 1);
              })
            : h(c + 1);
        }
      };
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (k) {
        a.error("can't parse displayExtension opts: " + b, k);
      }
    b.waiting = !1;
    this.hdus || a.error("no FITS HDUs found for displayExtension()");
    a.isNull(c) && a.error("missing extname/extnum for displayExtension()");
    if ("all" === c) h(0);
    else {
      if ("string" === typeof c) {
        b.extension = c;
        var l = c.toLowerCase();
        for (g = f = 0; f < this.hdus.length; f++)
          if (this.hdus[f].name && this.hdus[f].name.toLowerCase() === l) {
            g++;
            break;
          }
        g || a.error("no FITS HDU " + c + " for displayExtension()");
      } else
        "number" === typeof c &&
          ((b.extension = c),
          this.hdus[c]
            ? (l = this.hdus[c].name || c.toString())
            : a.error("no FITS HDU " + c + " for displayExtension()"));
      if (b.separate) {
        f = "[" + l + "]";
        c = this.id.replace(/\[.*\]/, "") + f;
        for (g = f = 0; f < a.images.length; f++) {
          var m = a.images[f];
          if (c === m.id && 0 < $("#" + m.display.id).length && this.display.id === m.display.id) {
            g++;
            break;
          }
        }
        if (g) {
          m.displayImage("display", b);
          m.display.clearMessage();
          if (d)
            try {
              a.xeqByName(d, window, this);
            } catch (k) {
              a.error("in displayExtension callback", k, !1);
            }
          return;
        }
      }
      b.separate || a.cleanupFITSFile(this.raw, !1);
      this.displaySection(b, d);
      return this;
    }
  };
  a.Image.prototype.displaySlice = function (c, b, d) {
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (f) {
        a.error("can't parse displaySlice opts: " + b, f);
      }
    b.waiting = !1;
    a.isNull(c) && a.error("missing slice for displaySlice()");
    3 !== this.raw.header.NAXIS && a.error("3D image required for displaySlice()");
    if ("all" === c)
      for (c = 1; c <= this.raw.header.NAXIS3; c++) {
        var e = $.extend(!0, {}, b, { separate: !0 });
        this.displaySlice(c, e, d);
      }
    else {
      a.isNumber(c) ? (b.slice = "*:*:" + c) : (b.slice = c);
      if (b.separate)
        for (
          b.id = sprintf(
            "%s_%s",
            this.id
              .replace(/_?([0-9])+:x:x/, "")
              .replace(/_?x:([0-9])+:x/, "")
              .replace(/_?x:x:([0-9])+/, ""),
            b.slice.replace(/\*/g, "x")
          ),
            c = 0;
          c < a.images.length;
          c++
        )
          if (((e = a.images[c]), b.id === e.id && 0 < $("#" + e.display.id).length))
            return (e.displayImage("display", { display: e }), this);
      a.cleanupFITSFile(this.raw, !1);
      this.displaySection(b, d);
    }
    return this;
  };
  a.Image.prototype.toArray = function (c) {
    var b;
    c = c || {};
    c.simple = !0;
    var d = $.extend(!0, {}, this.raw.header);
    if (a.notNull(c.sect)) {
      var e = c.sect;
      d.NAXIS1 = e.x1 - e.x0;
      d.NAXIS2 = e.y1 - e.y0;
      a.notNull(d.CRPIX1) && (d.CRPIX1 -= e.x0);
      a.notNull(d.CRPIX2) && (d.CRPIX2 -= e.y0);
      a.notNull(d.LTV1) && (d.LTV1 -= e.x0);
      a.notNull(d.LTV2) && (d.LTV2 -= e.y0);
      var f = Math.abs(this.raw.bitpix / 8);
      var g = (e.x1 - e.x0) * f;
      var h = g * (e.y1 - e.y0);
      h = new ArrayBuffer(h);
      h = new Uint8Array(h);
      var l = e.y0;
      for (b = 0; l < e.y1; l++, b++)
        a.memcpy(h.buffer, b * g, this.raw.data.buffer, (l * this.raw.width + e.x0) * f, g);
    } else h = this.raw.data.buffer;
    d = a.raw2FITS({ header: d }, c);
    c = 2880 - (d.length % 2880);
    2880 === c && (c = 0);
    for (l = 0; l < c; l++) d += " ";
    c = 2880 - (h.byteLength % 2880);
    2880 === c && (c = 0);
    l = new ArrayBuffer(d.length + h.byteLength + c);
    var m = new Uint8Array(l);
    for (l = 0; l < d.length; l++) m[l] = d.charCodeAt(l);
    if (0 < new Int8Array(new Int16Array([1]).buffer)[0]) {
      f = d.length;
      g = Math.abs(this.raw.bitpix) / 8;
      var k = new Uint8Array(h);
      for (l = 0; l < k.byteLength; l += g)
        for (b = l + g - 1, e = 0; e < g; b--, e++) m[f++] = k[b];
    } else m.set(new Uint8Array(h), d.length);
    f = d.length + h.byteLength;
    for (l = 0; l < c; l++) m[f++] = 0;
    return m;
  };
  a.Image.prototype.wcsAlign = function () {
    return this.wcsim && this.params.wcsalign && this.display === this.wcsim.display;
  };
  a.Image.prototype.getPan = function () {
    var c = this.rgb.sect,
      b = (c.x0 + c.x1) / 2,
      d = (c.y0 + c.y1) / 2;
    a.notNull(c.ix) && (b += c.ix / (2 * c.zoom));
    a.notNull(c.iy) && (d += c.iy / (2 * c.zoom));
    return {
      x: b,
      y: d,
      ox: c.xcen,
      oy: c.ycen,
      x0: c.x0,
      y0: c.y0,
      x1: c.x1,
      y1: c.y1,
      ix: c.ix || 0,
      iy: c.iy || 0,
    };
  };
  a.Image.prototype.setPan = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b);
    d = e.next().value;
    e = e.next().value;
    if (!(0 <= $.inArray("pan", this.params.disable))) {
      0 === b.length && ((d = this.raw.width / 2), (e = this.raw.height / 2));
      if (1 === b.length && "string" === typeof d)
        if ("mouse" === d && this.ipos) ((d = this.ipos.x), (e = this.ipos.y));
        else
          try {
            d = JSON.parse(d);
          } catch (m) {
            a.error("can't parse setPan JSON: " + d, m);
          }
      if ("object" === typeof d) {
        b = d;
        a.notNull(b.x) && a.notNull(b.y) && ((d = b.x), (e = b.y));
        a.notNull(b.px) &&
          a.notNull(b.py) &&
          ((e = this.logicalToImagePos({ x: b.px, y: b.py })), (d = e.x), (e = e.y));
        if ("string" === typeof b.wcs) {
          var f = b.wcs.trim().split(/ +/);
          b.ra = f[0];
          b.dec = f[1];
          3 <= f.length && (b.wcssys = f[2]);
        }
        if (this.validWCS() && a.notNull(b.ra) && a.notNull(b.dec)) {
          if (b.wcssys) {
            var g = this.getWCSSys();
            var h = a.globalOpts.xeqPlugins;
            a.globalOpts.xeqPlugins = !1;
            this.setWCSSys(b.wcssys, !1);
          }
          "string" === typeof b.ra &&
            ((b.ra = a.saostrtod(b.ra)), a.isHMS(this.params.wcssys) && (b.ra *= 15));
          "string" === typeof b.dec && (b.dec = a.saostrtod(b.dec));
          f = a.wcs2pix(this.raw.wcs, b.ra, b.dec).trim().split(/ +/);
          d = parseFloat(f[0]);
          e = parseFloat(f[1]);
          g && (this.setWCSSys(g, !1), (a.globalOpts.xeqPlugins = h));
        }
      }
      (a.isNumber(d) && a.isNumber(e)) || a.error("invalid input for setPan: " + d + " " + e);
      if (this.wcsAlign() || this.isawcsim) {
        var l = a.globalOpts.panWithinDisplay;
        a.globalOpts.panWithinDisplay = !0;
      }
      this.mkSection(d, e);
      if (this.wcsAlign() || this.isawcsim) {
        for (g = 0; g < a.images.length; g++)
          ((h = a.images[g]),
            h !== this &&
              h.display === this.display &&
              (h.wcsim === this || this.wcsim === h || (h.wcsim && h.wcsim === this.wcsim)) &&
              (h.params.wcsalign || this.params.wcsalign) &&
              ((b = a.pix2pix(this, h, { x: d, y: e })), h.mkSection(b.x, b.y)));
        a.globalOpts.panWithinDisplay = l;
      }
      this.displayImage("rgb");
      this.refreshLayers();
      a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetpan");
      return this;
    }
  };
  a.Image.prototype.getZoom = function () {
    return this.rgb.sect.zoom;
  };
  a.Image.prototype.parseZoom = function (c) {
    var b = [];
    var d = this.rgb.sect.zoom;
    switch (typeof c) {
      case "string":
        switch (c.charAt(0)) {
          case "*":
          case "x":
          case "X":
            var e = d * parseFloat(c.slice(1));
            break;
          case "/":
            e = d / parseFloat(c.slice(1));
            break;
          case "I":
          case "i":
            e = 2 * d;
            break;
          case "O":
          case "o":
            e = d / 2;
            break;
          case "T":
          case "t":
            if (this.params.transformAngle) {
              d = -this.params.transformAngle;
              c = { x: -this.raw.width / 2, y: this.raw.height / 2 };
              b[0] = a.rotatePoint(c, d);
              c = { x: this.raw.width / 2, y: this.raw.height / 2 };
              b[1] = a.rotatePoint(c, d);
              c = { x: -this.raw.width / 2, y: -this.raw.height / 2 };
              b[2] = a.rotatePoint(c, d);
              c = { x: this.raw.width / 2, y: -this.raw.height / 2 };
              b[3] = a.rotatePoint(c, d);
              for (c = 0; c < b.length; c++) {
                if (a.isNull(f) || b[c].x < f) var f = b[c].x;
                if (a.isNull(g) || b[c].x > g) var g = b[c].x;
                if (a.isNull(e) || b[c].y < e) e = b[c].y;
                if (a.isNull(h) || b[c].y > h) var h = b[c].y;
              }
              f = g - f;
              e = h - e;
            } else ((f = this.raw.width), (e = this.raw.height));
            e = Math.min(this.display.width / f, this.display.height / e);
            e = Math.round(1e6 * (e + 1e-7)) / 1e6;
            break;
          default:
            e = parseFloat(c);
        }
        break;
      case "number":
        e = c;
        break;
      default:
        return;
    }
    return e;
  };
  a.Image.prototype.setZoom = function (c) {
    var b;
    if (!(0 <= $.inArray("zoom", this.params.disable))) {
      (b = this.parseZoom(c)) || a.error("invalid input for setZoom: " + c);
      if (this.wcsAlign() || this.isawcsim) {
        var d = a.globalOpts.panWithinDisplay;
        a.globalOpts.panWithinDisplay = !0;
      }
      this.mkSection(b);
      if (this.wcsAlign() || this.isawcsim) {
        for (c = 0; c < a.images.length; c++) {
          var e = a.images[c];
          if (
            e !== this &&
            e.display === this.display &&
            (e.wcsim === this || this.wcsim === e || (e.wcsim && e.wcsim === this.wcsim)) &&
            (e.params.wcsalign || this.params.wcsalign)
          ) {
            var f = a.pix2pix(this, e, this.getPan());
            e.mkSection(f.x, f.y, b);
          }
        }
        a.globalOpts.panWithinDisplay = d;
      }
      this.displayImage("rgb");
      this.refreshLayers();
      a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetzoom");
      return this;
    }
  };
  a.Image.prototype.alignPanZoom = function (c, b) {
    var d;
    if (c) {
      "string" === typeof c &&
        ((d = a.getImage(c)) ? (c = d) : a.error("unknown image for alignPanZoom: " + c));
      b = b || {};
      d = c.getPan();
      var e = c.rgb.sect.zoom || 1;
      if ((b = a.notNull(b.syncwcs) ? b.syncwcs : a.globalOpts.syncWCS)) {
        var f = this.raw.wcsinfo || { cdelt1: 1, crot: 0 };
        b = c.raw.wcsinfo || { cdelt1: 1, crot: 0 };
        this.setPan(a.pix2pix(c, this, { x: d.ox, y: d.oy }));
        this.setZoom((e * f.cdelt1) / b.cdelt1);
        this.setRotate(b.crot - f.crot);
      } else (this.setPan({ x: d.ox, y: d.oy }), this.setZoom(e));
      return this;
    }
  };
  a.Image.prototype.getNorthIsUp = function (c) {
    var b = {},
      d = {
        galactic: {
          ra: 15 * a.saostrtod("12h51m26.00s"),
          dec: a.saostrtod("27d7m42.0s"),
          wcssys: "FK5",
        },
        ecliptic: {
          ra: 15 * a.saostrtod("18h0m0.0s"),
          dec: a.saostrtod("66d33m38.55s"),
          wcssys: "ICRS",
        },
      };
    var e = this.raw.wcsinfo || { cdelt1: 1, cdelt2: 1, crot: 0 };
    c || (c = this.getWCSSys());
    b.angle = 0;
    0 < e.cdelt1 && (b.flip = "x");
    0 > e.cdelt2 && (b.flip = (b.flip || "") + "y");
    switch (c) {
      case "galactic":
      case "ecliptic":
        break;
      default:
        return (e.crot && (b.angle = -e.crot), b);
    }
    e = a.globalOpts.xeqPlugins;
    a.globalOpts.xeqPlugins = !1;
    this.setWCSSys(d[c].wcssys, !1);
    var f = a
      .pix2wcs(this.raw.wcs, this.raw.width / 2, this.raw.height / 2)
      .trim()
      .split(/\s+/);
    var g = a.saostrtod(f[0]);
    a.isHMS() && (g *= 15);
    f = a.saostrtod(f[1]);
    b.angle = a.angdist(g, f, d[c].ra, d[c].dec);
    a.notNull(this.raw.wcsinfo.crot) && (b.angle -= this.raw.wcsinfo.crot);
    this.setWCSSys(c, !1);
    a.globalOpts.xeqPlugins = e;
    return b;
  };
  a.Image.prototype.getTransform = function () {
    return this.params.transform;
  };
  a.Image.prototype.setTransform = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = 0;
    var e = 1;
    b = $jscomp.makeIterator(b).next().value;
    (this && this.raw && this.raw.header) || a.error("invalid image for setTransform");
    if ("reset" === b)
      (delete this.params.transform,
        delete this.params.transformInverse,
        delete this.params.transformAngle,
        delete this.params.transformScale);
    else {
      var f = [
        [1, 0, 0],
        [0, 1, 0],
        [0, 0, 1],
      ];
      for (b = 0; b < a.globalOpts.transforms.length; b++)
        switch (a.globalOpts.transforms[b]) {
          case "flip":
            switch (this.params.flip) {
              case "x":
                var g = [
                  [-1, 0, 0],
                  [0, 1, 0],
                  [0, 0, 1],
                ];
                f = a.matrixMultiply(f, g);
                e = -1;
                break;
              case "y":
                g = [
                  [1, 0, 0],
                  [0, -1, 0],
                  [0, 0, 1],
                ];
                f = a.matrixMultiply(f, g);
                e = -1;
                break;
              case "xy":
                ((g = [
                  [-1, 0, 0],
                  [0, -1, 0],
                  [0, 0, 1],
                ]),
                  (f = a.matrixMultiply(f, g)));
            }
            break;
          case "rot90":
            if (a.notNull(this.params.rot90)) {
              var h = (this.params.rot90 * Math.PI) / 180;
              g = Math.cos(h);
              h = Math.sin(h);
              g = [
                [g, -h, 0],
                [h, g, 0],
                [0, 0, 1],
              ];
              f = a.matrixMultiply(f, g);
              d += this.params.rot90;
            }
            break;
          case "rotate":
            a.notNull(this.params.rotate) &&
              ((h = (this.params.rotate * Math.PI) / 180),
              (g = Math.cos(h)),
              (h = Math.sin(h)),
              (g = [
                [g, -h, 0],
                [h, g, 0],
                [0, 0, 1],
              ]),
              (f = a.matrixMultiply(f, g)),
              (d += this.params.rotate));
        }
      this.params.transform = f;
      this.params.transformInverse = a.invertMatrix3(f);
      this.params.transformAngle = e * d;
      this.params.transformScale = e;
      return this;
    }
  };
  a.Image.prototype.getFlip = function () {
    return this.params.flip;
  };
  a.Image.prototype.setFlip = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = $jscomp.makeIterator(b);
    var e = b.next().value;
    b = b.next().value;
    if (a.isNull(e)) return this;
    if ("reset" === e) return ((this.params.flip = "none"), this.setFlip(0));
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (m) {
        a.error("can't parse setFlip opts: " + b, m);
      }
    this.xeqStashSave("setFlip", [e]);
    d = this.params;
    var f = 0,
      g = 0,
      h = "";
    var l = (e + (this.params.flip || "")).split("");
    for (e = 0; e < l.length; e++)
      switch (l[e]) {
        case "x":
          f++;
          break;
        case "y":
          g++;
      }
    1 === f % 2 && (h += "x");
    1 === g % 2 && (h += "y");
    d.flip = h || "none";
    this.setTransform();
    this.displayImage("all", b);
    this.refreshLayers();
    a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetflip");
    return this;
  };
  a.Image.prototype.getRotate = function () {
    return this.params.rotate;
  };
  a.Image.prototype.setRotate = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = $jscomp.makeIterator(b);
    b = d.next().value;
    d = d.next().value;
    if (a.isNull(b)) return this;
    if ("reset" === b) return ((this.params.rotate = 0), this.setRotate(0));
    if ("string" === typeof b && b.match(/north/i)) {
      var e = this.getNorthIsUp();
      b = e.angle;
      a.notNull(e.flip) && this.setParam("flip", e.flip);
    }
    "string" === typeof b && (b = parseFloat(b));
    a.isNumber(b) || a.error("invalid rotation for setRotate: " + b);
    (this && this.raw && this.raw.header) || a.error("invalid image for setRotate");
    d = d || {};
    if ("string" === typeof d)
      try {
        d = JSON.parse(d);
      } catch (f) {
        a.error("can't parse setRotate opts: " + d, f);
      }
    this.xeqStashSave("setRotate", [b]);
    e = this.params;
    for (a.globalOpts.rotateRelative && (b += this.params.rotate || 0); 0 > b; ) b += 360;
    for (; 360 <= b; ) b -= 360;
    e.rotate = b;
    this.setTransform();
    this.params.transformAngle &&
      this.display.canvas.width !== this.display.canvas.height &&
      this.mkSection(this.getZoom());
    this.displayImage("all", d);
    this.refreshLayers();
    a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetrotate");
    return this;
  };
  a.Image.prototype.getRot90 = function () {
    return this.params.rot90;
  };
  a.Image.prototype.setRot90 = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = $jscomp.makeIterator(b);
    b = d.next().value;
    d = d.next().value;
    if (a.isNull(b)) return this;
    if ("reset" === b) return ((this.params.rot90 = 0), this.setRot90(0));
    "string" === typeof b && (b = parseFloat(b));
    (this && this.raw && this.raw.header) || a.error("invalid image for setRot90");
    d = d || {};
    if ("string" === typeof d)
      try {
        d = JSON.parse(d);
      } catch (f) {
        a.error("can't parse setRot90 opts: " + d, f);
      }
    switch (b) {
      case 0:
        b = 0;
        break;
      case 1:
        b = 90;
        break;
      case -1:
        b = -90;
        break;
      case 90:
        break;
      case -90:
        break;
      default:
        a.error("invalid setRot90 rotation value: " + b + " (use: +/1, +/90)");
    }
    this.xeqStashSave("setRot90", [b]);
    var e = this.params;
    for (b += this.params.rot90 || 0; 0 > b; ) b += 360;
    for (; 360 <= b; ) b -= 360;
    270 === b && (b = -90);
    e.rot90 = b;
    this.setTransform();
    this.params.transformAngle &&
      this.display.canvas.width !== this.display.canvas.height &&
      this.mkSection(this.getZoom());
    this.displayImage("all", d);
    this.refreshLayers();
    a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetrot90");
    return this;
  };
  a.Image.prototype.reFlipRot = function () {
    var a = this.params.flip;
    var b = this.params.rot90,
      d = this.params.rotate;
    if ("none" !== a) {
      this.params.flip = "none";
      var e = a.split("");
      for (a = 0; a < e.length; a++) ("x" !== e[a] && "y" !== e[a]) || this.setFlip(e[a]);
    }
    if (b)
      for (
        this.params.rot90 = 0, e = Math.floor(Math.abs(b) / 90), d = Math.sign(b), a = 0;
        a < e;
        a++
      )
        this.setRot90(d);
    d && this.setRotate(d);
    return this;
  };
  a.Image.prototype.refreshLayers = function (a) {
    for (var b in this.layers)
      Object.prototype.hasOwnProperty.call(this.layers, b) &&
        this.layers[b].show &&
        this.layers[b].opts.panzoom &&
        (a && a[b] && (a[b].refresh = !0), this.refreshShapes(b));
  };
  a.Image.prototype.imageToLogicalPos = function (a, b) {
    var c = "image",
      e = a.x;
    var f = a.y;
    b = b || this.params.lcs || "image";
    switch (b) {
      case "physical":
        if (this.lcs.physical) {
          c = b;
          var g = this.lcs.physical.reverse;
          var h = this.lcs.physical.rrot;
          var l = this.lcs.physical.cx;
          var m = this.lcs.physical.cy;
        }
        break;
      case "detector":
        this.lcs.detector &&
          ((c = b),
          (g = this.lcs.detector.reverse),
          (h = this.lcs.detector.rrot),
          (l = this.lcs.detector.cx),
          (m = this.lcs.detector.cy));
        break;
      case "amplifier":
        this.lcs.amplifier &&
          ((c = b),
          (g = this.lcs.amplifier.reverse),
          (h = this.lcs.amplifier.rrot),
          (l = this.lcs.amplifier.cx),
          (m = this.lcs.amplifier.cy));
    }
    g &&
      ((e = a.x * g[0][0] + a.y * g[1][0] + g[2][0]),
      (f = a.x * g[0][1] + a.y * g[1][1] + g[2][1]),
      h &&
        ((a = l + (e - l) * h[0][0] + (f - m) * h[1][0] + h[2][0]),
        (f = m + (e - l) * h[0][1] + (f - m) * h[1][1] + h[2][1]),
        (e = a)),
      "table" === this.imtab &&
        ((h = 0 > this.raw.bitpix ? 0.5 : 1),
        void 0 !== this.raw.header.TABMIN1 && (e = e - h + this.raw.header.TABMIN1),
        void 0 !== this.raw.header.TABMIN2 && (f = f - h + this.raw.header.TABMIN2)));
    return { x: e, y: f, sys: c };
  };
  a.Image.prototype.logicalToImagePos = function (a, b) {
    var c = { x: a.x, y: a.y };
    var e = this.raw.header.CRPIX1 || 1;
    var f = this.raw.header.CRPIX2 || 1;
    b = b || this.params.lcs || "image";
    switch (b) {
      case "ophysical":
        if (this.lcs.ophysical) {
          var g = this.lcs.ophysical.forward;
          var h = this.lcs.ophysical.frot;
        } else this.lcs.physical && ((g = this.lcs.physical.forward), (h = this.lcs.physical.frot));
        break;
      case "physical":
        this.lcs.physical && ((g = this.lcs.physical.forward), (h = this.lcs.physical.frot));
        break;
      case "detector":
        this.lcs.detector && ((g = this.lcs.detector.forward), (h = this.lcs.detector.frot));
        break;
      case "amplifier":
        this.lcs.amplifier && ((g = this.lcs.amplifier.forward), (h = this.lcs.amplifier.frot));
    }
    g &&
      ("table" === this.imtab &&
        ((b = 0 > this.raw.bitpix ? 0.5 : 1),
        void 0 !== this.raw.header.TABMIN1 && (a.x = a.x - this.raw.header.TABMIN1 + b),
        void 0 !== this.raw.header.TABMIN2 && (a.y = a.y - this.raw.header.TABMIN2 + b)),
      (c.x = a.x * g[0][0] + a.y * g[1][0] + g[2][0]),
      (c.y = a.x * g[0][1] + a.y * g[1][1] + g[2][1]),
      h &&
        ((a = e + (c.x - e) * h[0][0] + (c.y - f) * h[1][0] + h[2][0]),
        (h = f + (c.x - e) * h[0][1] + (c.y - f) * h[1][1] + h[2][1]),
        (c.x = a),
        (c.y = h)));
    return c;
  };
  a.Image.prototype.displayToImagePos = function (a) {
    var b = this.rgb.sect,
      c = this.rgb.img.height;
    var e = this.display.width / 2;
    var f = this.display.height / 2;
    if (this.params.transformInverse) {
      var g = this.params.transformInverse;
      var h = a.x - e;
      a = a.y - f;
      e = h * g[0][0] + a * g[1][0] + e;
      g = h * g[0][1] + a * g[1][1] + f;
    } else ((e = a.x), (g = a.y));
    return {
      x: (e - this.ix + 0.5) / b.zoom + b.x0 + 0.5,
      y: (c - (g - this.iy + 0.5)) / b.zoom + b.y0 + 0.5,
    };
  };
  a.Image.prototype.imageToDisplayPos = function (a) {
    var b = this.rgb.sect;
    var c = this.rgb.img.height;
    var e = this.display.width / 2,
      f = this.display.height / 2;
    var g = (a.x - 0.5 - b.x0) * b.zoom + this.ix - 0.5;
    c = (b.y0 - (a.y - 0.5)) * b.zoom + c + this.iy - 0.5;
    this.params.transform &&
      ((a = this.params.transform),
      (b = g - e),
      (c -= f),
      (g = b * a[0][0] + c * a[1][0] + e),
      (c = b * a[0][1] + c * a[1][1] + f));
    return { x: g, y: c };
  };
  a.Image.prototype.logicalToDisplayPos = function (a, b, d) {
    return this.imageToDisplayPos(this.logicalToImagePos(a, b, d));
  };
  a.Image.prototype.displayToLogicalPos = function (a) {
    return this.imageToLogicalPos(this.displayToImagePos(a));
  };
  a.Image.prototype.getWCSSys = function () {
    if (this.params.wcssys) return this.params.wcssys;
  };
  a.Image.prototype.setWCSSys = function (c, b) {
    if (!(0 <= $.inArray("wcs", this.params.disable)))
      return (
        a.isNull(b) && (b = a.globalOpts.wcsSetUpdatesDef),
        "image" === c
          ? ((this.params.wcssys = "image"),
            (this.params.wcsunits = "pixels"),
            (a.wcsunits.image = "pixels"))
          : "physical" === c
            ? ((this.params.wcssys = "physical"),
              (this.params.wcsunits = "pixels"),
              b && (a.globalOpts.wcsUnits.physical = "pixels"))
            : this.validWCS() &&
              ("native" === c && (c = this.params.wcssys0), (c = a.wcssys(this.raw.wcs, c))) &&
              ((this.params.wcssys = c.trim()),
              (c = a.globalOpts.wcsUnits[this.params.wcssys] || "sexagesimal"),
              this.setWCSUnits(c, b)),
        a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetwcssys"),
        this
      );
  };
  a.Image.prototype.initWCS = function (c) {
    var b,
      d,
      e = a.globalOpts.wcsHlength,
      f =
        /(WCSNAME|WCSAXES|CRVAL[0-9]|CRPIX[0-9]|PC[0-9]_[0-9]|CDELT[0-9]|CD[0-9]_[0-9]|CTYPE[0-9]|CUNIT[0-9]|CRVAL[0-9]|PV[0-9]_[0-9]|PS[0-9]_[0-9]|RADESYS|LONPOLE|LATPOLE)([A-Z])/;
    if (!this.raw.header) return this;
    c = c || this.raw.header;
    this.freeWCS();
    this.raw.altwcs = {};
    var g = "default";
    this.raw.altwcs[g] = {};
    this.raw.altwcs[g].header = c;
    for (b in c)
      Object.prototype.hasOwnProperty.call(c, b) &&
        (d = b.match(f)) &&
        d.length &&
        ((g = d[2]),
        this.raw.altwcs[g] ||
          ((this.raw.altwcs[g] = {}), (this.raw.altwcs[g].header = $.extend({}, c))),
        "RADESYS" === d[1] && (d[1] = "RADECSYS"),
        (this.raw.altwcs[g].header[d[1]] = c[d[0]]));
    for (b in this.raw.altwcs)
      if (Object.prototype.hasOwnProperty.call(this.raw.altwcs, b)) {
        c = a.raw2FITS(this.raw.altwcs[b].header);
        g = c.length + 1;
        try {
          var h = a.vmalloc(g);
        } catch (l) {
          a.error("can't malloc for wcsinit: " + g, l);
        }
        try {
          a.vstrcpy(c, h);
        } catch (l) {
          a.error("can't copy for wcsinit: " + g, l);
        }
        this.raw.altwcs[b].wcs = a.initwcs(h, e);
        a.vfree(h);
        if (0 < this.raw.altwcs[b].wcs)
          try {
            this.raw.altwcs[b].wcsinfo = JSON.parse(a.wcsinfo(this.raw.altwcs[b].wcs));
          } catch (l) {}
      }
    this.setWCS("default");
    return this;
  };
  a.Image.prototype.freeWCS = function (c) {
    var b;
    c = c || this.raw;
    if (c.altwcs)
      for (b in c.altwcs)
        Object.prototype.hasOwnProperty.call(c.altwcs, b) &&
          0 < c.altwcs[b].wcs &&
          (a.freewcs(c.altwcs[b].wcs), (c.altwcs[b].wcs = null));
  };
  a.Image.prototype.getWCS = function () {
    var a;
    for (a in this.raw.altwcs)
      if (
        Object.prototype.hasOwnProperty.call(this.raw.altwcs, a) &&
        this.raw.wcs === this.raw.altwcs[a].wcs
      ) {
        var b = $.extend(!0, {}, this.raw.altwcs[a].wcsinfo);
        b.version = a;
        b.wcsname = this.raw.altwcs[a].header.WCSNAME;
        return b;
      }
    return null;
  };
  a.Image.prototype.setWCS = function (c) {
    var b;
    c = c || "default";
    if (!this.raw || !this.raw.altwcs) return this;
    for (b in this.raw.altwcs)
      if (Object.prototype.hasOwnProperty.call(this.raw.altwcs, b)) {
        var d = this.raw.altwcs[b].header.WCSNAME;
        if (c === b || c === d)
          return (
            0 >= this.raw.altwcs[b].wcs && a.error("invalid WCS for version: %s", c),
            (this.raw.wcs = this.raw.altwcs[b].wcs),
            (this.raw.wcsinfo = this.raw.altwcs[b].wcsinfo),
            (c =
              this.raw.wcsinfo && this.raw.wcsinfo.radecsys
                ? this.raw.wcsinfo.radecsys
                : "native" !== this.params.wcssys
                  ? this.params.wcssys.trim()
                  : this.params.lcs),
            this.setWCSSys(c),
            this.params.wcssys0 || (this.params.wcssys0 = c),
            this.setWCSUnits(this.params.wcsunits),
            this
          );
      }
    a.error("could not find WCS version: " + c);
  };
  a.Image.prototype.validWCS = function () {
    return this.raw && this.raw.wcs && 0 < this.raw.wcs;
  };
  a.Image.prototype.getWCSUnits = function () {
    return this.params.wcsunits ? this.params.wcsunits : "pixels";
  };
  a.Image.prototype.setWCSUnits = function (c, b) {
    if (!(0 <= $.inArray("wcs", this.params.disable))) {
      a.isNull(b) && (b = a.globalOpts.wcsSetUpdatesDef);
      if ("pixels" === c)
        (a.isWCSSys(this.params.wcssys) && (this.params.wcssys = "physical"),
          (this.params.wcsunits = "pixels"),
          b && (a.globalOpts.wcsUnits[this.params.wcssys] = "pixels"));
      else if (this.validWCS()) {
        if (a.notWCS(this.params.wcssys)) {
          var d = a.imageOpts.wcssys;
          this.setWCSSys(d);
        }
        if ((c = a.wcsunits(this.raw.wcs, c)))
          ((this.params.wcsunits = c.trim()),
            b && (a.globalOpts.wcsUnits[this.params.wcssys] = this.params.wcsunits));
      }
      a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetwcsunits");
      return this;
    }
  };
  a.Image.prototype.notifyHelper = function () {
    var c = this,
      b,
      d;
    var e = new RegExp("^" + a.ANON + "[0-9]*");
    var f = a.INSTALLDIR ? new RegExp("^" + a.INSTALLDIR) : null;
    if (a.helper.connected && !this.file.match(e)) {
      switch (a.helper.type) {
        case "get":
        case "post":
          a.helper.pageid ||
            a.helper.send("pageid", null, function (b) {
              b &&
                b
                  .trim()
                  .match(
                    /^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/
                  ) &&
                ((a.helper.pageid = b), (a.helper.js9helper = "js9helper"));
            });
      }
      e = this.file;
      "/" !== e.charAt(0) && f && (d = this.file.replace(f, ""));
      a.helper.send("image", { image: e, image2: d }, function (d) {
        if ("object" === typeof d) {
          var e = d.stdout;
          d.stderr && 1 < a.DEBUG && a.log(d.stderr);
        } else e = d;
        e &&
          ((d = e.trim().match(/(?:[^\s[]+|\[[^\]]*\])+/g)[1]),
          "?" !== d &&
            (a.globalOpts.dataDir
              ? ((e = d.lastIndexOf("/") + 1),
                (c.fitsFile = a.globalOpts.dataDir + "/" + d.slice(e)))
              : ((c.fitsFile = d),
                c.fitsFile.includes("/") ||
                  ((b = c.file.match(/.*\//)) &&
                    b.length &&
                    ((d = new RegExp("^" + a.INSTALLDIR)),
                    (b = b[0].replace(d, "")),
                    (c.fitsFile = b + c.fitsFile))),
                a.globalOpts.prependJS9Dir &&
                  (c.fitsFile &&
                    !c.fitsFile.match(/^\${JS9_DIR}/) &&
                    "/" !== c.fitsFile.charAt(0) &&
                    (c.fitsFile = "${JS9_DIR}/" + c.fitsFile),
                  c.parentFile &&
                    !c.parentFile.match(/^\${JS9_DIR}/) &&
                    "/" !== c.parentFile.charAt(0) &&
                    (c.parentFile = "${JS9_DIR}/" + c.parentFile))),
            1 < a.DEBUG && a.log("JS9 fitsFile: %s %s", c.file, c.fitsFile)),
          c.fitsFile && (c.fitsFile = a.cleanPath(c.fitsFile)),
          c.parentFile && (c.parentFile = a.cleanPath(c.parentFile)),
          c.queried || (c.queryHelper("all"), (c.queried = !0)));
      });
    }
    return this;
  };
  a.Image.prototype.queryHelper = function (c) {
    var b = this;
    c = c || "all";
    !a.helper.connected ||
      ("all" !== c && "getAnalysis" !== c) ||
      this.analysisPackages ||
      a.helper.send("getAnalysis", { fits: this.fitsFile }, function (c) {
        if (c)
          try {
            b.analysisPackages = JSON.parse(c);
          } catch (e) {
            a.log("can't get analysis", e);
          }
      });
    return this;
  };
  a.Image.prototype.expandMacro = function (c, b) {
    var d = this,
      e;
    if (c)
      return c.replace(/\${?([a-zA-Z][a-zA-Z0-9_()]+)}?/g, function (c, g, h) {
        h = function (b) {
          var c = d.params.wcssys;
          if (b)
            switch (b) {
              case "wcs":
                a.notWCS(c) && (d.params.wcssys = d.params.wcssys0);
                break;
              case "physical":
              case "image":
                d.params.wcssys = b;
            }
          return c;
        };
        var f = function (a) {
            var b;
            "table" === d.imtab
              ? d.raw.hdu &&
                d.raw.hdu.table.filter &&
                !a.match(d.raw.hdu.table.filter) &&
                (a = a.match(/\]\[/)
                  ? a.slice(0, -1) + "&&" + d.raw.hdu.table.filter + "]"
                  : a + ("[" + d.raw.hdu.table.filter + "]"))
              : "image" === d.imtab &&
                ((b = d.file.match(/\[.*\]/))
                  ? (a = a.match(/\[.*\]/) ? a.replace(/\[.*\]/, b) : a + b)
                  : d.raw && d.raw.hdu && d.raw.hdu.slice
                    ? ((b = d.raw.hdu.slice.replace(/:/g, ",").replace(/([0-9][0-9]*)/, "$1:$1")),
                      (a += "[" + b + "]"))
                    : d.raw && d.raw.header && 2 < d.raw.header.NAXIS && (a += "[*,*,1:1]"));
            return a;
          },
          m = g.split("(");
        m[1] && (m[1] = m[1].replace(/\)$/, ""));
        switch (m[0]) {
          case "id":
            var k = d.display.divjq.attr("id");
            break;
          case "image0":
            k = d.id.replace(/\[EVENTS\]/i, "");
            break;
          case "image":
            k = d.id;
            break;
          case "filename":
            "all" == m[1] && d.fitsFile && d.raw && d.raw.header && 3 === d.raw.header.NAXIS
              ? (k = d.fitsFile)
              : d.parentFile && "this" !== m[1]
                ? d.raw && d.raw.filter
                  ? ((k = d.parentFile),
                    k.match(/\[.*\]/) || (k += "[EVENTS]"),
                    (k += "[" + d.raw.filter + "]"))
                  : (k = f(d.parentFile))
                : d.fitsFile
                  ? (k = f(d.fitsFile))
                  : a.error("no FITS file for " + d.id);
            break;
          case "fits":
            d.fitsFile || a.error("no FITS file for " + d.id);
            k = f(d.fitsFile);
            break;
          case "parent":
            d.parentFile || a.error("no parent FITS file for " + d.id);
            k = d.parentFile;
            break;
          case "ext":
            d.fitsFile
              ? ((k = d.fitsFile.match(/\[.*\]/)), null === k && (k = ""))
              : a.error("no FITS file for " + d.id);
            break;
          case "imcenter":
            k = d.displayToLogicalPos({ x: d.display.width / 2, y: d.display.height / 2 });
            k = k.x + "," + k.y;
            break;
          case "wcscenter":
            k = d.displayToImagePos({ x: d.display.width / 2, y: d.display.height / 2 });
            k = a.pix2wcs(d.raw.wcs, k.x, k.y).replace(/\s+/g, ",");
            break;
          case "sregions":
            c = h(m[1]);
            k = d
              .listRegions("source", { mode: 0, includedcoords: a.globalOpts.regExpandDCoords })
              .replace(/\s+/g, "");
            c && (d.params.wcssys = c);
            break;
          case "bregions":
            c = h(m[1]);
            k = d
              .listRegions("background", { mode: 0, includedcoords: a.globalOpts.regExpandDCoords })
              .replace(/\s+/g, "");
            c && (d.params.wcssys = c);
            break;
          case "regions":
            c = h(m[1]);
            k = d
              .listRegions("all", { mode: 0, includedcoords: a.globalOpts.regExpandDCoords })
              .replace(/\s+/g, "");
            c && (d.params.wcssys = c);
            break;
          case "mag":
            k = d.params.zoom ? sprintf("%s%", 100 * d.params.zoom) : "?";
            break;
          default:
            if (b)
              for (e = b.length, h = 0; h < e; h++)
                if (b[h].name === g) {
                  k = b[h].value;
                  break;
                }
            if (void 0 === k && d && void 0 !== d.params[g])
              switch (g) {
                case "wcsunits":
                  switch (d.params[g]) {
                    case "sexagesimal":
                      k = "hms";
                      break;
                    case "degrees":
                      k = "deg";
                      break;
                    default:
                      k = d.params[g];
                  }
                  break;
                case "scaleclipping":
                  switch (d.params[g]) {
                    case "dataminmax":
                      k = "data";
                      break;
                    default:
                      k = d.params[g];
                  }
                  break;
                case "colormap":
                  k = d.useOffScreenCanvas() ? "overlay" : d.params[g];
                  break;
                default:
                  k =
                    "number" === typeof d.params[g] && d.params[g] !== Math.floor(d.params[g])
                      ? d.params[g].toFixed(2)
                      : d.params[g];
              }
            void 0 === k && (k = c);
        }
        return k;
      });
  };
  a.Image.prototype.lookupAnalysis = function (a) {
    var b,
      c,
      e = null;
    if (this.analysisPackages) {
      for (c = 0; c < this.analysisPackages.length && !e; c++) {
        var f = this.analysisPackages[c];
        for (b = 0; b < f.length; b++) {
          e = f[b];
          if (e.xclass && e.xclass + ":" + e.name === a) break;
          e = null;
        }
      }
      if (e) return e;
      for (c = 0; c < this.analysisPackages.length && !e; c++)
        for (f = this.analysisPackages[c], b = 0; b < f.length; b++) {
          e = f[b];
          if (e.name === a) break;
          e = null;
        }
    }
    return e;
  };
  a.Image.prototype.validateAnalysis = function (c) {
    var b,
      d = /imVar\((.*),(.*)\)/,
      e = /js9Var\((.*),(.*)\)/;
    var f = /fitsHeader\(([A-Za-z0-9_]+),(.*)\)/;
    var g = /winVar\((.*),(.*)\)/,
      h = function (a, b) {
        return a && b ? String(a).toUpperCase() === String(b).toUpperCase() : !1;
      };
    if (!c.title || !c.name || c.hidden) return !1;
    if (c.files) {
      if (
        (c.files.match(/^fits$/) && !this.fitsFile) ||
        (c.files.match(/^table$/) && "table" !== this.imtab) ||
        (c.files.match(/^image$/) && "image" !== this.imtab)
      )
        return !1;
      if ((b = c.files.match(f)))
        if (((f = this.raw.header[b[1].toUpperCase()]), !h(f, b[2]))) return !1;
      if ((b = c.files.match(g))) if (((f = a.varByName(b[1], window)), !h(f, b[2]))) return !1;
      if ((b = c.files.match(e))) if (((f = a.varByName(b[1], a)), !h(f, b[2]))) return !1;
      if ((b = c.files.match(d))) if (((f = a.varByName(b[1], this)), !h(f, b[2]))) return !1;
    }
    return !0;
  };
  a.Image.prototype.getAnalysis = function () {
    var a,
      b,
      d = [];
    if (!this.analysisPackages) return d;
    for (b = 0; b < this.analysisPackages.length; b++) {
      var e = this.analysisPackages[b];
      for (a = 0; a < e.length; a++) {
        var f = e[a];
        this.validateAnalysis(f) && d.push(f);
      }
    }
    return d;
  };
  a.Image.prototype.runAnalysis = function (c, b, d) {
    var e = this,
      f,
      g,
      h = {},
      l = function (b, c) {
        a.helper || a.error(b, c);
        switch (a.helper.type) {
          case "nodejs":
          case "socket.io":
            a.helper.socket && "polling" === a.helper.socket.io.engine.transport.name
              ? window.setTimeout(function () {
                  a.error(b, c);
                }, 0)
              : a.error(b, c);
            break;
          default:
            a.error(b, c);
        }
      };
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (m) {
        a.error("can't parse runAnalysis opts: " + b, m);
      }
    d = d || a.globalOpts.analysisFunc;
    if (a.helper.connected && this.analysisPackages) {
      if ((f = this.lookupAnalysis(c))) {
        f.action && (h.cmd = this.expandMacro(f.action, b));
        if (f.keys)
          for (h.keys = {}, c = 0; c < f.keys.length; c++)
            h.keys[f.keys[c]] = this.expandMacro("$" + f.keys[c], b);
        h.id = this.expandMacro("$id");
        h.image = this.file;
        h.fits = this.fitsFile;
        h.rtype = f.rtype;
        switch (a.helper.type) {
          case "nodejs":
          case "socket.io":
            c = f.xclass ? f.xclass + ":" + f.name : f.name;
            break;
          default:
            c = "runAnalysis";
        }
        a.waiting(!0, this.display);
        this.setStatus("runAnalysis", "processing");
        a.helper.send(c, h, function (c) {
          var k;
          var m =
            "object" === typeof c
              ? c
              : 0 <= c.search(a.analOpts.epattern)
                ? { stderr: c }
                : { stdout: c };
          m.errcode = m.errcode || 0;
          if (d) d.call(e, m.stdout, m.stderr, m.errcode, f);
          else {
            if (m.stderr)
              if (((c = m.stderr), 0 <= c.search(/WARNING:/i) && 0 > c.search(/ERROR:/i))) a.log(c);
              else {
                l(c, a.analOpts.epattern);
                return;
              }
            else if (m.errcode)
              if (((c = "ERROR: running " + f.name + " [" + m.errcode + "]"), m.stdout)) a.log(c);
              else {
                l(c, a.analOpts.epattern);
                return;
              }
            switch (f.rtype) {
              case "text":
              case void 0:
                e.displayAnalysis("text", m.stdout, { divid: a.globalOpts.analysisDiv });
                break;
              case "plot":
                e.displayAnalysis("plot", m.stdout, { divid: a.globalOpts.analysisDiv });
                break;
              case "alert":
                m.stdout && alert(m.stdout);
                break;
              case "fits":
                (k = m.stdout.split(/\s+/)) &&
                  k[0] &&
                  ((c = a.cleanPath(k[0])),
                  "/" !== c.charAt(0) && (c = a.InstallDir(c)),
                  (m = { proxyFile: c }),
                  k[1] && ((k = a.cleanPath(k[1])), (m.parentFile = k), (m.proxyParent = k)),
                  (m.fits2fits = !1),
                  (m.fixpath = !1),
                  a.Load(c, m, { display: e.display }));
                break;
              case "regions":
                if ((k = m.stdout.split(/\s+/)) && k[0]) {
                  if (1 < k.length)
                    try {
                      g = JSON.parse(k[1]);
                    } catch (u) {
                      g = null;
                    }
                  g = g || {};
                  "boolean" === typeof g.remove && (g.remove = "all");
                  "string" === g.type
                    ? (g.remove && e.removeShapes("regions", g.remove),
                      e.addShapes("regions", k[0], b))
                    : ((c = a.cleanPath(k[0])),
                      "/" !== c.charAt(0) && (c = a.InstallDir(c)),
                      (h = { responseType: "text" }),
                      a.fetchURL(null, c, h, function (a, b) {
                        g.remove && e.removeShapes("regions", g.remove);
                        e.addShapes("regions", a, b);
                      }));
                }
                break;
              case "catalog":
                (k = m.stdout.split(/\s+/)) &&
                  k[0] &&
                  ((c = a.cleanPath(k[0])),
                  (h = { responseType: "text" }),
                  a.fetchURL(null, c, h, function (a, b) {
                    e.loadCatalog(null, a, b);
                  }));
                break;
              case "none":
                break;
              default:
                a.error("unknown analysis result type: " + f.rtype);
            }
          }
          e.setStatus("runAnalysis", "complete");
          a.waiting(!1);
        });
        return this;
      }
      a.error("could not find analysis task: " + c);
    }
  };
  a.Image.prototype.displayAnalysis = function (c, b, d) {
    var e = this,
      f,
      g;
    var h = a.lightOpts[a.LIGHTWIN];
    var l = function () {
      var b = a.Plot.opts.title;
      if (p && n) {
        $(a.lightOpts[a.LIGHTWIN].topid).arrive("#plotConfigForm", { onceOnly: !0 }, function () {
          a.Plot.initConfigForm.call(e, n, u);
        });
        var c = a.allinone ? a.allinone.plotConfigHTML : a.InstallDir(a.Plot.opts.configURL);
        n.winid = e.displayAnalysis("params", c, {
          title: b,
          winformat: "width=368px,height=110px,resize=1,scrolling=1",
        });
      }
    };
    d = d || {};
    if ("string" === typeof d)
      try {
        d = JSON.parse(d);
      } catch (x) {
        a.error("can't parse displayAnalysis opts: " + d, x);
      }
    var m = d.winformat;
    d.divid && 0 < $("#" + d.divid).length && (f = $("#" + d.divid));
    var k = d.title || "";
    this &&
      !k &&
      ((d = this.fitsFile || this.id || ""),
      (d = d.split("/").reverse()[0]),
      (k = "AnalysisResults: " + d + sprintf(a.IDFMT, this.display.id)));
    d = "Analysis_" + a.uniqueID();
    switch (c) {
      case "text":
        b =
          "<div class='JS9Analysis'></div><pre class='JS9AnalysisText'>" +
          ((b || "") + "</pre></div>");
        if (f) (f.html(b), window.electron && a.searchbar(f[0]));
        else {
          m = m || h.textWin;
          var q = a.lightWin(d, "inline", b, k, m);
          window.electron && a.searchbar(q);
        }
        break;
      case "plot":
        if (b && "string" === typeof b)
          try {
            var u = JSON.parse(b);
          } catch (x) {
            a.error("can't plot return data: " + b, x);
          }
        else "object" === typeof b && (u = b);
        if (!u) return;
        u.curscale = { x: "linear", y: "linear" };
        b =
          "<div id='" +
          d +
          "' class='JS9Analysis'><div id='" +
          d +
          "Plot' class='JS9Plot' ></div></div>";
        f ? f.html(b) : ((m = m || h.plotWin), (q = a.lightWin(d, "inline", b, k, m)));
        var p = $("#" + d + " #" + d + "Plot");
        f && (p.css("width", f.css("width")), p.css("height", f.css("height")), p.css("margin", 0));
        if (u.data) {
          switch (a.globalOpts.plotLibrary) {
            case "plotly":
              h = $.extend(!0, {}, a.Plot.opts, u.opts);
              u.label && (h.title = u.label);
              b = { x: [], y: [], type: "scatter" };
              3 <= u.data[0].length &&
                ((b.error_y = { type: "data", array: [], visible: !0 }),
                u.points &&
                  u.points.yerr &&
                  u.points.yerr.color &&
                  (b.error_y.color = u.points.yerr.color));
              for (m = 0; m < u.data.length; m++)
                (b.x.push(u.data[m][0]),
                  b.y.push(u.data[m][1]),
                  b.error_y && b.error_y.array && b.error_y.array.push(u.data[m][2]));
              a.Plot.opts.annotate && u.annotations && (h.annotations = a.Plot.annotate(u));
              "log" === h.xscale &&
                ((h.xaxis = h.xaxis || {}),
                (h.xaxis.type = "log"),
                (h.xaxis.autorange = !0),
                (u.curscale.x = "log"));
              "log" === h.yscale &&
                ((h.yaxis = h.yaxis || {}),
                (h.yaxis.type = "log"),
                (h.yaxis.autorange = !0),
                (u.curscale.y = "log"));
              try {
                Plotly.newPlot(p.attr("id"), [b], h);
              } catch (x) {
                a.error("can't plot data (plotly)", x);
              }
              break;
            default:
              h = $.extend(!0, {}, a.Plot.opts, u.opts);
              a.Plot.opts.annotate &&
                u.annotations &&
                (h.zoomStack.func = function (b, c) {
                  a.Plot.annotate(p, b, u);
                });
              u.color = u.color || h.color;
              "log" === u.xscale &&
                ((h.xaxis = h.xaxis || {}),
                (h.xaxis.transform = a.Plot.logfunc),
                (h.xaxis.inverseTransform = a.Plot.expfunc),
                (u.curscale.x = "log"));
              "log" === u.yscale &&
                ((h.yaxis = h.yaxis || {}),
                (h.yaxis.transform = a.Plot.logfunc),
                (h.yaxis.inverseTransform = a.Plot.expfunc),
                (u.curscale.y = "log"));
              try {
                var n = $.plot(p, [u], h);
              } catch (x) {
                a.error("can't plot data (flot)", x);
              }
              a.Plot.opts.annotate && u.annotations && a.Plot.annotate(p, n, u);
          }
          p.css("outline", "none");
          p.attr("tabindex", 0);
          p.on("keydown", function (b) {
            b = a.eventToCharStr(b);
            switch (b) {
              case "c":
                l();
                break;
              case "x":
              case "y":
                ((g = "linear" !== u.curscale[b] ? "linear" : "log"),
                  a.Plot.rescale(p, n, u, b, g));
            }
          });
          m = $("<img src='" + a.InstallDir("images/gears.png") + "'>");
          m.on("click", l);
          b = $("<div class='JS9PlotGear'>");
          b.append(m);
          p.append(b);
        }
        break;
      case "params":
      case "regions":
      case "textline":
        f
          ? a.allinone
            ? f.html(b)
            : $.ajax({
                url: b,
                cache: !1,
                dataType: "text",
                success: function (a) {
                  f.html(a);
                },
              })
          : ((m =
              "params" === c
                ? m || h.paramWin
                : "regions" === c
                  ? "small" === a.globalOpts.regConfigSize
                    ? m || h.regWin0
                    : m || h.regWin
                  : m || h.dpathWin),
            (q = a.allinone ? "inline" : "ajax"),
            (q = a.lightWin(d, q, b, k, m)));
    }
    return q;
  };
  a.Image.prototype.saveFITS = function (c, b) {
    if (Object.prototype.hasOwnProperty.call(window, "saveAs")) {
      c = c ? c.replace(/\.fz$/i, "").replace(/(png|jpg|jpeg)$/i, "fits") : "js9.fits";
      b = b || {};
      if ("string" === typeof b) {
        try {
          var d = JSON.parse(b);
        } catch (f) {
          d = null;
        }
        d && (b = d);
      }
      if ("display" === b || "display" === b.source) {
        b = this.displayToImagePos({ x: 0, y: this.rgb.img.height });
        var e = this.displayToImagePos({ x: this.rgb.img.width, y: 0 });
        b = { x0: b.x, y0: b.y, x1: e.x, y1: e.y };
        e = this.toArray({ notab: !0, twoaxes: !0, sect: b });
      } else
        "virtual" === b || "virtual" === b.source
          ? this.raw.hdu && this.raw.hdu.fits && this.raw.hdu.fits.vfile
            ? (e = a.vread(this.raw.hdu.fits.vfile, "binary"))
            : a.error("no virtual file available to save")
          : (e = this.toArray({ notab: !0, twoaxes: !0 }));
      b = new Blob([e], { type: "application/octet-binary" });
      a.saveAs(b, c);
    } else a.error("no saveAs() available to save FITS file");
    return c;
  };
  a.Image.prototype.saveIMG = function (c, b, d) {
    var e;
    if (Object.prototype.hasOwnProperty.call(window, "saveAs")) {
      if ("number" === typeof d) {
        var f = d;
        d = null;
      } else if ("string" === typeof d) {
        if (a.isNumber(d)) ((f = parseFloat(d)), (d = null));
        else
          try {
            d = JSON.parse(d);
          } catch (k) {
            d = null;
          }
        d && (f = d.quality);
      }
      d = d || {};
      c = c || "js9.png";
      b = b || "image/png";
      var g = this.display.width;
      var h = this.display.height;
      var l = document.createElement("canvas");
      l.setAttribute("width", g);
      l.setAttribute("height", h);
      var m = l.getContext("2d");
      "image" === d.source
        ? m.putImageData(this.rgb.img, 0, 0)
        : m.drawImage(this.display.canvas, 0, 0);
      if (!1 !== d.layers)
        for (e in this.layers)
          Object.prototype.hasOwnProperty.call(this.layers, e) &&
            "main" === this.layers[e].dlayer.dtype &&
            this.layers[e].show &&
            ((d = this.layers[e].dlayer.canvasjq[0]), m.drawImage(d, 0, 0, g, h));
      a.notNull(f) && (0 > f || 1 < f) && (f = 0.95);
      l.toBlob(
        function (b) {
          a.saveAs(b, c);
        },
        b,
        f
      );
    } else a.error("no saveAs() available for saving image");
    return c;
  };
  a.Image.prototype.savePNG = function (a, b) {
    a = a || "js9.png";
    a.match(/\.png$/) || (a += ".png");
    return this.saveIMG(a, "image/png", b);
  };
  a.Image.prototype.saveJPEG = function (a, b) {
    a = a || "js9.jpg";
    a.match(/\.jpg$/) || a.match(/\.jpeg$/) || (a += ".jpg");
    return this.saveIMG(a, "image/jpeg", b);
  };
  a.Image.prototype.updateValpos = function (c, b) {
    var d = null;
    var e = function (a, b) {
      var c = "";
      b = b || 3;
      0 > a && ((a = Math.abs(a)), (c = "-"));
      for (a = "" + a; a.length < b; ) a = "0" + a;
      return c + a;
    };
    if (this.params.valpos) {
      void 0 === b && (b = !0);
      if (this.valpos)
        return (
          b && this.display.displayMessage("info", this.valpos, a.globalOpts.valposTarget),
          this.valpos
        );
      var f = { x: c.x, y: c.y, sys: "image" };
      var g = this.imageToLogicalPos(c);
      var h = this.imageToDisplayPos(c);
      h.sys = "display";
      var l = "image" === this.params.wcssys ? f : g;
      d = this.raw.data[Math.floor(c.y - 0.5) * this.raw.width + Math.floor(c.x - 0.5)];
      switch (this.raw.bitpix) {
        case 8:
        case 16:
        case -16:
        case 32:
          var m = e(d);
          break;
        case -32:
        case -64:
          m = a.floatFormattedString(d, this.params.precision, 3);
          break;
        default:
          m = e(d);
      }
      e = m;
      var k = l.x.toFixed(3) + " " + l.y.toFixed(3) + " (" + l.sys + ")";
      a.globalOpts.valposDCoords &&
        "image" === l.sys &&
        (k +=
          "&nbsp;&nbsp;&nbsp;&nbsp;" + h.x.toFixed(3) + " " + h.y.toFixed(3) + " (" + h.sys + ")");
      var q = e + "&nbsp;&nbsp;&nbsp;&nbsp;" + k;
      d = {
        ix: f.x,
        iy: f.y,
        ipos: f.x.toFixed(2) + "\t\t " + f.y.toFixed(2),
        isys: "image",
        px: g.x,
        py: g.y,
        ppos: g.x.toFixed(2) + "\t\t " + g.y.toFixed(2),
        psys: "physical",
        dx: h.x,
        dy: h.y,
        dpos: h.x.toFixed(2) + "\t\t " + h.y.toFixed(2),
        dsys: "display",
        cx: l.x,
        cy: l.y,
        cpos: l.x.toFixed(2) + "\t\t " + l.y.toFixed(2),
        csys: l.sys,
        ra: "",
        dec: "",
        wcspos: "",
        wcssys: "",
        racen: "",
        deccen: "",
        wcsfov: "",
        wcspix: "",
        val: d,
        val3: m,
        id: this.id,
        file: this.file,
        object: this.object || "",
      };
      if (this.telescope || this.instrument)
        (d.object && (d.object += "  "),
          (d.object += "("),
          this.telescope && ((d.object += this.telescope), this.instrument && (d.object += ", ")),
          this.instrument && (d.object += this.instrument),
          (d.object += ")"));
      if (
        this.validWCS() &&
        a.isWCSSys(this.params.wcssys) &&
        ((c = a.pix2wcs(this.raw.wcs, c.x, c.y).trim().split(/\s+/)),
        (q = c[0] + " " + c[1] + " (" + (c[2] || "wcs") + ")"),
        (q = e + "&nbsp;&nbsp;&nbsp;&nbsp;" + q + "&nbsp;&nbsp;&nbsp;&nbsp;" + k),
        (d.ra = c[0]),
        (d.dec = c[1]),
        (d.wcspos = c[0] + "\t " + c[1]),
        (d.wcssys = c[2]),
        this.raw.wcsinfo)
      ) {
        c = Math.abs(this.raw.wcsinfo.cdelt1);
        h = Math.abs(this.raw.wcsinfo.cdelt2);
        f = 1 / 60;
        if (this.raw.header.CUNIT1) var u = this.raw.header.CUNIT1;
        if (!u || u.match(/^deg/i))
          1 <= c || 1 <= h
            ? (u = "deg")
            : c >= f || h >= f
              ? ((u = "'"), (c *= 60), (h *= 60))
              : ((u = '"'), (c *= 3600), (h *= 3600));
        l = this.rgb.sect;
        f = ((l.x1 - l.x0) * c).toFixed(0);
        h = ((l.y1 - l.y0) * h).toFixed(0);
        d.wcsfov = "" + f + u + " \u00d7 " + h + u;
        f = (c / l.zoom).toFixed(3);
        d.wcspix = "" + f + u + "/pix";
        d.wcsfovpix = d.wcsfov + "  (" + d.wcspix + ")";
        c = a
          .pix2wcs(this.raw.wcs, (l.x1 + l.x0) / 2, (l.y1 + l.y0) / 2)
          .trim()
          .split(/\s+/);
        d.racen = c[0];
        d.deccen = c[1];
        d.wcscen = c[0] + "\t " + c[1];
      }
      d.vstrsmall = e + "&nbsp;&nbsp;&nbsp;&nbsp;" + k;
      d.vstr = q;
      d.vstrmedium = q;
      d.vstrlarge = q + "&nbsp;&nbsp;&nbsp;&nbsp;" + this.file;
      b && this.display.displayMessage("info", d, a.globalOpts.valposTarget);
    }
    return d;
  };
  a.Image.prototype.toggleValpos = function () {
    this.params.valpos = !this.params.valpos;
    this.params.valpos || this.display.clearMessage();
  };
  a.Image.prototype.getColormap = function () {
    if (this.cmapObj)
      return {
        colormap: this.cmapObj.name,
        contrast: this.params.contrast,
        bias: this.params.bias,
      };
  };
  a.Image.prototype.setColormap = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = this,
      f = $jscomp.makeIterator(b);
    d = f.next().value;
    var g = f.next().value;
    f = f.next().value;
    var h = function (b) {
        if (e.cmapObj)
          switch (e.cmapObj.name) {
            case "red":
              e.display.rgb.rim === e && (e.display.rgb.rim = null);
              break;
            case "green":
              e.display.rgb.gim === e && (e.display.rgb.gim = null);
              break;
            case "blue":
              e.display.rgb.bim === e && (e.display.rgb.bim = null);
          }
        delete e.staticObj;
        e.cmapObj = a.lookupColormap(b);
        e.params.colormap = e.cmapObj.name;
        "static" === e.cmapObj.type && (e.staticObj = $.extend(!0, {}, e.cmapObj));
        switch (b) {
          case "red":
            e.display.rgb.rim = e;
            break;
          case "green":
            e.display.rgb.gim = e;
            break;
          case "blue":
            e.display.rgb.bim = e;
        }
        e.params.overlay = !1;
      },
      l = function (a, b) {
        a = parseFloat(a);
        Number.isNaN(a) || (e.params.contrast = a);
        b = parseFloat(b);
        Number.isNaN(b) || (e.params.bias = b);
      },
      m = function (a) {
        var b, c;
        for (b = 0; b < a.length; b++)
          if ($.isArray(a[b]) && "string" === typeof a[b][0])
            for (c = 0; c < e.staticObj.colors.length; c++) {
              var d = e.staticObj.colors[c];
              if (a[b][0] === d.name) {
                switch (a[b].length) {
                  case 2:
                    !1 === a[b][1] || "false" === a[b][1]
                      ? (d.active = !1)
                      : !0 === a[b][1] || "true" === a[b][1]
                        ? (d.active = !0)
                        : ((c = parseFloat(a[b][1])), 0 < c && 1 >= c && (c *= 255), (d.alpha = c));
                    break;
                  case 3:
                    ((d.min = parseFloat(a[b][1])),
                      Number.isNaN(d.min) && (d.min = -Infinity),
                      (d.max = parseFloat(a[b][2])),
                      Number.isNaN(d.max) && (d.max = Infinity));
                }
                break;
              }
            }
        e.params.overlay = !1;
      };
    if (!(0 <= $.inArray("colormap", this.params.disable) && this.cmapObj)) {
      switch (b.length) {
        case 1:
          switch (d) {
            case "rgb":
              this.display.rgb.active = !this.display.rgb.active;
              break;
            case "overlay":
              this.offscreen && (this.params.overlay = !this.params.overlay);
              break;
            case "invert":
              this.params.invert = !this.params.invert;
              break;
            case "reset":
              this.params.invert = a.imageOpts.invert;
              this.params.contrast = a.imageOpts.contrast;
              this.params.bias = a.imageOpts.bias;
              break;
            default:
              if (this.cmapObj && "static" === this.cmapObj.type)
                if ($.isArray(d)) m(d);
                else if ("string" === typeof d && "[" === d.charAt(0))
                  try {
                    var k = JSON.parse(d);
                    m(k);
                  } catch (q) {
                    a.error("can't parse JSON in setColormap: " + d, q);
                  }
                else h(d);
              else "string" === typeof d && h(d);
          }
          break;
        case 2:
          a.isNumber(d) && a.isNumber(g)
            ? l(d, g)
            : this.cmapObj && "static" === this.cmapObj.type && (h(d), m(g));
          break;
        case 3:
          (h(d), l(g, f));
      }
      this.displayImage("colors");
      this.xeqStashDiscard("filterRGBImage");
      a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetcolormap");
      return this;
    }
  };
  a.Image.prototype.getScale = function () {
    if (this.params.scale)
      return {
        scale: this.params.scale,
        scalemin: this.params.scalemin,
        scalemax: this.params.scalemax,
        scaleclipping: this.params.scaleclipping,
      };
  };
  a.Image.prototype.setScale = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = this,
      f = $jscomp.makeIterator(b);
    d = f.next().value;
    var g = f.next().value;
    f = f.next().value;
    var h = function (b) {
      a.scales.includes(b)
        ? (e.params.scale = b)
        : "dataminmax" === b
          ? ((e.params.scaleclipping = "dataminmax"),
            (e.params.scalemin = e.raw.dmin),
            (e.params.scalemax = e.raw.dmax))
          : "zscale" === b
            ? ((void 0 !== e.params.z1 && void 0 !== e.params.z2) || e.zscale(!1),
              (e.params.scaleclipping = "zscale"),
              (e.params.scalemin = e.params.z1),
              (e.params.scalemax = e.params.z2))
            : "zmax" === b
              ? (void 0 === e.params.z1 && e.zscale(!1),
                (e.params.scaleclipping = "zmax"),
                (e.params.scalemin = e.params.z1),
                (e.params.scalemax = e.raw.dmax))
              : "user" === b
                ? (e.params.scaleclipping = "user")
                : a.error("unknown scale: " + b);
    };
    if (!(0 <= $.inArray("scale", this.params.disable))) {
      if (b.length) {
        switch (b.length) {
          case 1:
            h(d);
            break;
          case 2:
            this.params.scalemin = parseFloat(d);
            this.params.scalemax = parseFloat(g);
            this.params.scaleclipping = "user";
            break;
          default:
            (h(d),
              "zscale" !== d &&
                "zmax" !== d &&
                ((this.params.scalemin = parseFloat(g)),
                (this.params.scalemax = parseFloat(f)),
                (this.params.scaleclipping = "user")));
        }
        this.params.precision = a.floatPrecision(this.params.scalemin, this.params.scalemax);
        this.displayImage("colors");
      }
      a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetscale");
      return this;
    }
  };
  a.Image.prototype.getOpacity = function () {
    var c = {};
    a.notNull(this.params.opacity) ? (c.opacity = this.params.opacity) : (c.opacity = 1);
    a.notNull(this.params.flooropacity) &&
      ((c.flooropacity = this.params.flooropacity), (c.floorvalue = this.params.floorvalue));
    return c;
  };
  a.Image.prototype.setOpacity = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b);
    d = e.next().value;
    var f = e.next().value;
    e = e.next().value;
    if (!(0 <= $.inArray("opacity", this.params.disable))) {
      if (b.length) {
        switch (b.length) {
          case 1:
            "string" === typeof d
              ? "reset" === d.toLowerCase()
                ? (this.params.opacity = 1)
                : "resetfloor" === d.toLowerCase()
                  ? (delete this.params.floorvalue, delete this.params.flooropacity)
                  : "resetall" === d.toLowerCase() &&
                    ((this.params.opacity = 1),
                    delete this.params.floorvalue,
                    delete this.params.flooropacity)
              : a.isNumber(d) && (this.params.opacity = parseFloat(d));
            break;
          case 2:
            a.isNumber(d) &&
              a.isNumber(f) &&
              ((this.params.floorvalue = parseFloat(d)),
              (this.params.flooropacity = parseFloat(f)));
            break;
          case 3:
            (a.isNumber(d) && (this.params.opacity = parseFloat(d)),
              a.isNumber(f) &&
                a.isNumber(e) &&
                ((this.params.floorvalue = parseFloat(f)),
                (this.params.flooropacity = parseFloat(e))));
        }
        ("number" === typeof d || ("string" === typeof d && !d.match(/reset/))) &&
          this.mask.active &&
          this.mask.im &&
          (this.mask.active = !1);
        this.displayImage("colors");
      }
      a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onsetopacity");
      return this;
    }
  };
  a.Image.prototype.getParam = function (a) {
    return a ? ("all" === a ? this.params : this.params[a]) : null;
  };
  a.Image.prototype.setParam = function (c, b) {
    if (!c) return null;
    b = "true" === b ? !0 : "false" === b ? !1 : a.isNumber(b) ? parseFloat(b) : b;
    if ("all" === c && "object" === typeof b) {
      $.extend(!0, this.params, b);
      if (b.colormap || b.contrast || b.bias)
        ((c = this.getColormap()),
          (b.colormap = b.colormap || c.colormap),
          (b.contrast = b.contrast || c.contrast),
          (b.bias = b.bias || c.bias),
          this.setColormap(b.colormap, b.contrast, b.bias));
      if (b.scale || b.scalemin || b.scalemax)
        ((c = this.getScale()),
          (b.scale = b.scale || c.scale),
          (b.scalemin = b.scalemin || c.scalemin),
          (b.scalemax = b.scalemax || c.scalemax),
          this.setScale(b.scale, b.scalemin, b.scalemax));
      b.flip && (this.setFlip("reset"), this.setFlip(b.flip));
      b.rot90 && (this.setRot90("reset"), this.setRot90(b.rot90));
      b.rotate && (this.setRotate("reset"), this.setRotate(b.rotate));
      b.invert && ((this.params.invert = b.invert), this.displayImage("colors"));
      b.zoom && this.setZoom(b.zoom);
      b.wcssys && this.setWCSSys(b.wcssys);
      b.wcsunits && this.setWCSUnits(b.wcsunits);
      return this.params;
    }
    if ("disable" === c) {
      $.isArray(b) || (b = [b]);
      for (c = 0; c < b.length; c++) {
        var d = $.inArray(b[c], this.params.disable);
        0 > d && this.params.disable.push(b[c]);
      }
      return this.params.disable;
    }
    if ("enable" === c) {
      $.isArray(b) || (b = [b]);
      for (c = 0; c < b.length; c++)
        ((d = $.inArray(b[c], this.params.disable)), 0 <= d && this.params.disable.splice(d, 1));
      return this.params.disable;
    }
    d = this.params[c];
    this.params[c] = b;
    switch (c) {
      case "colormap":
        this.setColormap(b);
        break;
      case "invert":
        this.displayImage("colors");
        break;
      case "contrast":
        c = this.getColormap();
        this.setColormap(c.colormap, b, c.bias);
        break;
      case "bias":
        c = this.getColormap();
        this.setColormap(c.colormap, c.contrast, b);
        break;
      case "overlay":
        this.displayImage("colors");
        break;
      case "flip":
        this.setFlip("reset");
        this.setFlip(b);
        break;
      case "rot90":
        this.setRot90("reset");
        this.setRot90(b);
        break;
      case "rotate":
        this.setRotate("reset");
        this.setRotate(b);
        break;
      case "scale":
        this.setScale(b);
        break;
      case "scalemin":
        c = this.getScale();
        this.setScale("user", b, c.scalemax);
        break;
      case "scalemax":
        c = this.getScale();
        this.setScale("user", c.scalemin, b);
        break;
      case "scaleclipping":
        c = this.getScale();
        this.setScale(b, c.scalemin, c.scalemax);
        break;
      case "wcssys":
        this.setWCSSys(b);
        break;
      case "wcsunits":
        this.setWCSUnits(b);
        break;
      case "zoom":
        this.setZoom(b);
    }
    return d;
  };
  a.Image.prototype.copyParams = function (c, b, d) {
    var e,
      f = [];
    if (c) {
      d = d || {};
      if ("string" === typeof c && "[" === c.charAt(0))
        try {
          c = JSON.parse(c);
        } catch (k) {
          a.error("can't parse JSON in copyParams: " + c, k);
        }
      $.isArray(c) || (c = [c]);
      var g = $.inArray("regions", c);
      0 <= g && (c.splice(g, 1), c.unshift("regions"));
      b = b || a.images;
      if ("string" === typeof b && "[" === b.charAt(0))
        try {
          b = JSON.parse(b);
        } catch (k) {
          a.error("can't parse JSON in copyParams: " + b, k);
        }
      $.isArray(b) || (b = [b]);
      for (g = 0; g < b.length; g++) {
        var h = b[g];
        "string" === typeof h &&
          ((h = a.lookupImage(h)) || a.error("unknown image for copyParams"));
        if (h !== this) {
          h !== h.display.image && 0 > $.inArray(h.display.image, f) && f.push(h.display.image);
          try {
            for (e = 0; e < c.length; e++) {
              var l = c[e];
              switch (l) {
                case "alignment":
                  h.alignPanZoom(this);
                  break;
                case "contrastbias":
                  var m = this.getParam("contrast");
                  h.setParam("contrast", m);
                  m = this.getParam("bias");
                  h.setParam("bias", m);
                  break;
                case "pan":
                  m = this.getPan();
                  h.setPan(a.pix2pix(this, h, { x: m.ox, y: m.oy }));
                  break;
                case "regions":
                  this.copyRegions(h);
                  break;
                case "shapes":
                  d.layer && this.copyShapes(d.layer, h);
                  break;
                case "wcs":
                  m = this.getParam("wcssys");
                  h.setParam("wcssys", m);
                  m = this.getParam("wcsunits");
                  h.setParam("wcsunits", m);
                  break;
                default:
                  ((m = this.getParam(l)), h.setParam(l, m));
              }
            }
          } catch (k) {
            a.error("could not copy params for " + h.id);
          } finally {
            if (f.length) for (g = 0; g < f.length; g++) f[g].displayImage();
          }
        }
      }
    }
  };
  a.Image.prototype.getStatus = function (c) {
    if (!a.isNull(c) && "string" === typeof c)
      switch (c.toLowerCase()) {
        case "close":
          return this.status.close;
        case "displaysection":
        case "displayextension":
          return this.status.displaySection;
        case "createmosaic":
          return this.status.createMosaic;
        case "load":
        case "preload":
          return a.fetchURL.status ? a.fetchURL.status : this.status.load;
        case "loadcatalog":
          return this.status.loadCatalog;
        case "loadcolormap":
          return this.status.loadColormap;
        case "loadproxy":
          return this.status.loadProxy;
        case "loadregions":
          return this.status.loadRegions;
        case "loadsession":
          return this.status.loadSession;
        case "reproject":
        case "reprojectdata":
        case "rotate":
        case "rotatedata":
          return this.status.reprojectData;
        case "runanalysis":
          return this.status.runAnalysis;
        case "separate":
          return this.status.separate;
        case "uploadfitsfile":
          return this.status.uploadFITSFile;
      }
  };
  a.Image.prototype.setStatus = function (c, b) {
    if (a.notNull(c) && a.notNull(b))
      switch (b) {
        case "error":
        case "complete":
          delete this.status.cur;
          break;
        default:
          this.status.cur = c;
      }
    this.status[c] = b;
  };
  a.Image.prototype.dataminmax = function (c, b) {
    var d = this.raw;
    var e = this.params;
    var f = this.raw.data;
    var g = Number.isNaN(e.scalemin) || !Number.isFinite(e.scalemin) || a.isNull(e.scalemin);
    var h = Number.isNaN(e.scalemax) || !Number.isFinite(e.scalemax) || a.isNull(e.scalemax);
    if ("dataminmax" === e.scaleclipping) {
      if (d.dmin === e.scalemin || a.isNull(d.dmin)) g = !0;
      if (d.dmax === e.scalemax || a.isNull(d.dmax)) h = !0;
    }
    if (a.notNull(c) && a.notNull(b)) ((d.dmin = c), (d.dmax = b));
    else if (((d.dmin = Number.MAX_VALUE), (d.dmax = Number.MIN_VALUE), 0 < d.bitpix))
      if (void 0 !== d.header.BLANK) {
        var l = d.header.BLANK;
        for (c = 0; c < f.length; c++)
          ((b = f[c]), b !== l && (b < d.dmin && (d.dmin = b), b > d.dmax && (d.dmax = b)));
      } else
        for (c = 0; c < f.length; c++)
          ((b = f[c]), b < d.dmin && (d.dmin = b), b > d.dmax && (d.dmax = b));
    else
      for (c = 0; c < f.length; c++)
        ((b = f[c]),
          !Number.isNaN(b) &&
            Number.isFinite(b) &&
            (b < d.dmin && (d.dmin = b), b > d.dmax && (d.dmax = b)));
    g && (e.scalemin = d.dmin);
    h && (e.scalemax = d.dmax);
    e.precision = a.floatPrecision(e.scalemin, e.scalemax);
    return this;
  };
  a.Image.prototype.zscale = function (c) {
    if (!a.zscale || !this.raw || !this.raw.data) return this;
    var b = this.raw.data;
    var d = b.length * b.BYTES_PER_ELEMENT;
    try {
      var e = a.vmalloc(d);
    } catch (f) {
      a.error("image too large for zscale malloc: " + d, f);
    }
    try {
      a.vmemcpy(new Uint8Array(b.buffer), e);
    } catch (f) {
      a.error("can't copy image to zscale heap: " + d, f);
    }
    b = a.zscale(
      e,
      this.raw.width,
      this.raw.height,
      this.raw.bitpix,
      this.params.zscalecontrast,
      this.params.zscalesamples,
      this.params.zscaleline
    );
    a.vfree(e);
    e = b.trim().split(/\s+/);
    this.params.z1 = parseFloat(e[0]);
    this.params.z2 = parseFloat(e[1]);
    "zmax" === c
      ? ((this.params.scalemin = this.params.z1), (this.params.scalemax = this.raw.dmax))
      : c && ((this.params.scalemin = this.params.z1), (this.params.scalemax = this.params.z2));
    this.params.precision = a.floatPrecision(this.params.scalemin, this.params.scalemax);
    return this;
  };
  a.Image.prototype.countsInRegions = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = this,
      f,
      g;
    d = "field";
    var h = "",
      l = function (b, c) {
        var d = /(annulus|box|circle|ellipse|line|polygon|point|text) *\(/;
        if (!b) return c;
        if ("string" === typeof b) {
          var f = e.expandMacro(b);
          if (!f) return c;
          if (f.match(d)) return f;
        }
        ((d = e.getShapes("regions", b)) && d.length) || a.error("no regions found: " + b);
        f = "";
        for (b = 0; b < d.length; b++) {
          var g = d[b];
          e.params.wcssys
            ? (f || (f = g.wcssys || ""), (f += "; " + g.wcsstr))
            : (f || (f = g.imsys || ""), (f += "; " + g.imstr));
        }
        return f || c;
      };
    (this.raw.hdu && this.raw.hdu.fits && this.raw.hdu.fits.vfile) ||
      a.error("no virtual file available for regcnts: " + this.id);
    for (f = 0; f < b.length; f++) {
      var m = b[f];
      if ("string" === typeof m && "{" === m.charAt(0))
        try {
          b[f] = JSON.parse(m);
        } catch (q) {
          a.error("can't parse JSON arg in regcnts: " + m, q);
        }
    }
    switch (b.length) {
      case 0:
        break;
      case 1:
        "object" === typeof b[0] ? (g = b[0]) : (d = l(b[0], "field"));
        break;
      case 2:
        d = l(b[0], "field");
        "object" === typeof b[1] ? (g = b[1]) : (h = l(b[1], ""));
        break;
      default:
        ((d = l(b[0], "field")), (h = l(b[1], "")), (g = b[2]));
    }
    g = g || {};
    g.reduce = g.reduce || a.globalOpts.reduceRegcnts;
    g.dim = g.dim || Math.max(a.globalOpts.image.xdim, a.globalOpts.image.ydim);
    f = g.cmdswitches || "";
    b = this.raw.hdu.fits.vfile;
    (m = this.file.match(/\[.*\]/)) && (b += m);
    "table" === this.imtab
      ? (m = this.raw.hdu.table.filter) &&
        !b.match(m) &&
        (b = b.match(/\]\[/) ? b.slice(0, -1) + "&&" + m + "]" : b + ("[" + m + "]"))
      : 3 === this.raw.header.NAXIS &&
        0 > f.search(/(^| )-c/) &&
        (f += " -c " + (this.raw.hdu.slice || 1));
    if (
      g.reduce &&
      !this.parentFile &&
      3 > this.raw.header.NAXIS &&
      ((m = this.fileDimensions()), (m = Math.floor(Math.max(m.xdim, m.ydim) / g.dim + 0.5)), 1 < m)
    )
      if ("table" === this.imtab) f += " -b " + m;
      else {
        var k = "bin" + m + "_" + b.split("/").reverse()[0];
        a.imsection(b, k, "0@0,0@0," + m, "");
        b = k;
      }
    a.waiting(!0, this.display);
    m = a.regcnts(b, d, h, f);
    a.waiting(!1);
    k && a.vunlink(k);
    (m.match(/^ERROR/) || m.match(/FITSIO status/)) && a.error(m);
    g.lightwin && this.displayAnalysis("text", m, { divid: a.globalOpts.analysisDiv });
    return m;
  };
  a.Image.prototype.radialProfile = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = [];
    var f = { cmdswitches: "-G -j -r" };
    for (d = 0; d < b.length; d++)
      if ("object" === typeof b[d]) {
        var g = $.extend(!0, {}, b[d], f);
        e.push(g);
        var h = g;
      } else e.push(b[d]);
    g || e.push(f);
    h = h || {};
    if ((d = this.countsInRegions.apply(this, $jscomp.arrayFromIterable(e))))
      try {
        var l = JSON.parse(d);
      } catch (m) {
        a.error("can't parse regcnts JSON", m);
      }
    (l && l.columnUnits && l.columnUnits.radii) || a.error("no radii available for radial profile");
    d = l.columnUnits.radii;
    b = l.columnUnits.surfBrightness;
    g = h.color || "green";
    e = h.errorcolor || "red";
    h = a.isNull(h.errorbars) || h.errorbars ? "y" : "n";
    h = {
      color: sprintf("%s", g),
      label: sprintf("surface brightness(%s) vs. radius(%s)", b, d),
      points: { errorbars: sprintf("%s", h), yerr: { show: "true", color: sprintf("%s", e) } },
      data: [],
    };
    for (d = 0; d < l.backgroundSubtractedResults.length; d++)
      ((b = l.backgroundSubtractedResults[d]),
        ("undefined" === b.radius2 || "NA" === b.radius2 || b.radius1 > b.radius2) &&
          a.error("radial profile source region must be an annulus"),
        (b = [(b.radius1 + b.radius2) / 2, b.surfBrightness, b.surfError]),
        h.data.push(b));
    return this.displayAnalysis("plot", h, { divid: a.globalOpts.analysisDiv });
  };
  a.Image.prototype.plot3d = function (c, b, d) {
    var e,
      f,
      g = [];
    (this.raw.header && 3 === this.raw.header.NAXIS) ||
      a.error("plot3d requires a data cube with 3 dimensions");
    d = $.extend(!0, {}, d, a.globalOpts.plot3d);
    d.cube = d.cube || "*:*:all";
    var h = d.cube.split(":");
    for (e = 0; e < h.length; e++)
      if ("all" === h[e]) {
        var l = e + 1;
        break;
      }
    l || a.error("plot3d requires specification of cube's third index");
    d.cmdswitches = "-j -c " + d.cube;
    h = d.mode || "avg";
    d.areaunits
      ? d.areaunits.match(/^p/)
        ? ((d.areaunits = "pixels"), (d.cmdswitches += " -p"))
        : d.areaunits.match(/^a/)
          ? (d.areaunits = "arcsec")
          : ((d.areaunits = "pixels"), (d.cmdswitches += " -p"))
      : ((d.areaunits = "pixels"), (d.cmdswitches += " -p"));
    e = d.color || "green";
    if ((c = this.countsInRegions(c, b, d)))
      try {
        var m = JSON.parse(c);
      } catch (q) {
        a.error("can't parse regcnts results: " + c, q);
      }
    m || a.error("no regcnts info available for plot3d");
    c = (c = this.raw.header["CTYPE" + String(l)]) ? c.toLowerCase() : "slice";
    b =
      "avg" === h
        ? "pixels" === d.areaunits
          ? "counts/pixel**2"
          : "counts/arcsec**2"
        : "summed counts";
    b = { color: sprintf("%s", e), label: sprintf("%s vs %s ", b, c), data: [] };
    var k = this.raw.header["CRVAL" + String(l)] || 0;
    l = this.raw.header["CDELT" + String(l)] || 1;
    for (e = 0; e < m.source.cubeSlices; e++) {
      c = "backgroundSubtractedResults" + String(e + 1);
      for (f = g[e] = 0; f < m[c].length; f++)
        g[e] = "avg" === h ? g[e] + m[c][f].surfBrightness : g[e] + m[c][f].netCounts;
      c = [e * l + k, g[e]];
      b.data.push(c);
    }
    return this.displayAnalysis("plot", b, { divid: d.divid || a.globalOpts.analysisDiv });
  };
  a.Image.prototype.rawDataLayer = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b);
    d = e.next().value;
    e = e.next().value;
    if (!b.length) return this.raw.id;
    d = d || {};
    if ("string" === typeof d)
      if ("function" === typeof e) d = { rawid: d };
      else {
        var f = d;
        for (b = 0; b < this.raws.length; b++) {
          var g = this.raws[b];
          if (f === g.id) {
            if ("remove" === e) {
              f === a.RAWID0 && a.error("can't remove primary (raw0) data layer");
              if (g.hdu && g.hdu.fits) {
                var h = a.lookupVfile(g.hdu.fits.vfile);
                1 >= h.length && a.cleanupFITSFile(g, !0);
              }
              this.raw = this.raws[0];
              if (g.current0 && g.current0.id)
                for (h = 0; h < this.raws.length; h++)
                  if (g.current0.id === this.raws[h].id) {
                    this.raw = this.raws[h];
                    break;
                  }
              for (h = 0; h < a.images.length; h++)
                (d = a.images[h]) && d.xeqstash && d.xeqStashDiscard(f);
              this.raws.splice(b, 1);
            } else this.raw = g;
            this.raw.header.BITPIX && (this.raw.bitpix = this.raw.header.BITPIX);
            this.imtab = this.raw.imtab || this.imtab;
            this.params.scalemin = void 0;
            this.params.scalemax = void 0;
            this.dataminmax();
            this.mkSection();
            this.initWCS();
            this.initLCS();
            this.displayImage("all");
            this.refreshLayers();
            a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onrawdatalayer");
            return !0;
          }
        }
        return !1;
      }
    if ("function" !== typeof e) return !1;
    var l = d.rawid || a.RAWIDX;
    void 0 === d.oraw && (d.oraw = "current0");
    if ("current" === d.oraw) f = this.raw;
    else if ("current0" === d.oraw) f = this.raw.id === l ? this.raw.current0 : this.raw;
    else
      for (b = 0; b < this.raws.length; b++)
        if (((g = this.raws[b]), d.oraw === g.id)) {
          f = g;
          break;
        }
    f || (f = this.raws[0]);
    g = -1;
    for (b = 0; b < this.raws.length; b++)
      if (l === this.raws[b].id) {
        h = this.raws[b];
        g = b;
        break;
      }
    if (0 > g || d.alwaysCopy) {
      h = $.extend(!0, {}, f);
      h.current0 = f;
      if (d.bitpix) {
        switch (d.bitpix) {
          case 8:
            h.data = new Uint8Array(f.height * f.width);
            break;
          case 16:
            h.data = new Int16Array(f.height * f.width);
            break;
          case -16:
            h.data = new Uint16Array(f.height * f.width);
            break;
          case 32:
            h.data = new Int32Array(f.height * f.width);
            break;
          case -32:
            h.data = new Float32Array(f.height * f.width);
            break;
          case -64:
            h.data = new Float64Array(f.height * f.width);
            break;
          default:
            a.error("unsupported bitpix: " + d.bitpix);
        }
        var m = h.width * h.height;
        for (b = 0; b < m; b++) h.data[b] = f.data[b];
        h.bitpix = d.bitpix;
      } else
        switch (f.bitpix) {
          case 8:
            h.data = new Uint8Array(f.data);
            break;
          case 16:
            h.data = new Int16Array(f.data);
            break;
          case -16:
            h.data = new Uint16Array(f.data);
            break;
          case 32:
            h.data = new Int32Array(f.data);
            break;
          case -32:
            h.data = new Float32Array(f.data);
            break;
          case -64:
            h.data = new Float64Array(f.data);
            break;
          default:
            a.error("unsupported bitpix: " + f.bitpix);
        }
      h.id = l;
      h.from = d.from || h.from || "func";
    }
    e.call(this, f, h, d) &&
      (0 <= g ? (this.raws[g] = h) : this.raws.push(h),
      (this.raw = h),
      this.raw.header.bitpix && (this.raw.bitpix = this.raw.header.bitpix),
      !1 !== d.dataminmax && this.dataminmax(),
      d.updatewcs && (this.initWCS(), this.initLCS()),
      d.resetpan && this.setPan(),
      this.refreshLayers(),
      this.displayImage("all", d),
      this.reFlipRot());
    return !0;
  };
  a.Image.prototype.gaussBlurData = function (c, b) {
    void 0 === c && a.error("missing sigma value for gaussBlurData");
    this.params.sigma = c;
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (d) {
        a.error("can't parse gaussBlur opts: " + b, d);
      }
    b.bitpix = -64 === this.raw.bitpix ? -64 : -32;
    b.oraw = "current0";
    b.alwaysCopy = !0;
    b.rawid = b.rawid || "gaussBlur";
    b.sigma = c;
    this.xeqStashSave("gaussBlurData", [c], b.rawid);
    this.rawDataLayer(b, function (b, e) {
      switch (e.bitpix) {
        case -32:
          var d = new Float32Array(e.data);
          break;
        case -64:
          d = new Float64Array(e.data);
          break;
        default:
          a.error("invalid temp bitpix for gaussBlur: " + e.bitpix);
      }
      gaussBlur(d, e.data, e.width, e.height, c);
      return !0;
    });
    return this;
  };
  a.Image.prototype.imarithData = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b),
      f = e.next().value;
    d = e.next().value;
    e = e.next().value;
    if (!b.length) return "add sub mul div min max reset".split(" ");
    e = e || {};
    if ("string" === typeof e)
      try {
        e = JSON.parse(e);
      } catch (g) {
        a.error("can't parse imarith opts: " + e, g);
      }
    e.rawid = e.rawid || "imarith";
    if ("reset" === f || "remove" === f) this.rawDataLayer(e.rawid, "remove");
    else {
      (void 0 !== f && void 0 !== d) || a.error("missing arg(s) for image arithmetic");
      this.xeqStashSave("imarithData", b.slice(), e.rawid);
      switch (f) {
        case "add":
        case "sub":
        case "mul":
        case "div":
        case "min":
        case "max":
          e.op = f;
          break;
        default:
          a.error("invalid operator for image arithmetic: " + f);
      }
      "object" === typeof d
        ? ((this.raw.width === d.raw.width && this.raw.height === d.raw.height) ||
            a.error("images must be the same size for image arithmetic"),
          (e.argtype = "image"),
          (e.argval = d))
        : a.isNumber(d)
          ? ((e.argtype = "value"), (e.argval = d))
          : ((b = a.lookupImage(d)) || a.error("imarith arg1 must be an image or a constant: " + d),
            (e.argval = b),
            (e.argtype = "image"));
      "div" === e.op &&
        "value" === e.argtype &&
        0 === e.argval &&
        a.error("imarith can't divide by zero (nor can anyone else)");
      if (!e.bitpix)
        switch (e.argtype) {
          case "image":
            e.bitpix =
              0 < this.raw.bitpix && 0 < e.argval.raw.bitpix
                ? Math.max(this.raw.bitpix, e.argval.raw.bitpix)
                : 0 > this.raw.bitpix && 0 > e.argval.raw.bitpix
                  ? Math.min(this.raw.bitpix, e.argval.raw.bitpix)
                  : 0 > this.raw.bitpix && 0 < e.argval.raw.bitpix
                    ? this.raw.bitpix
                    : e.argval.raw.bitpix;
            break;
          case "value":
            e.bitpix = -64 === this.raw.bitpix ? -64 : -32;
        }
      e.alwaysCopy = !0;
      e.oraw = "current";
      this.rawDataLayer(e, function (b, c, d) {
        switch (d.argtype) {
          case "image":
            b = d.argval.raw.data;
            switch (d.op) {
              case "add":
                for (d = 0; d < c.data.length; d++) c.data[d] += b[d];
                break;
              case "sub":
                for (d = 0; d < c.data.length; d++) c.data[d] -= b[d];
                break;
              case "mul":
                for (d = 0; d < c.data.length; d++) c.data[d] *= b[d];
                break;
              case "div":
                for (d = 0; d < c.data.length; d++) c.data[d] = 0 === b[d] ? 0 : c.data[d] / b[d];
                break;
              case "min":
                for (d = 0; d < c.data.length; d++) c.data[d] = Math.min(c.data[d], b[d]);
                break;
              case "max":
                for (d = 0; d < c.data.length; d++) c.data[d] = Math.max(c.data[d], b[d]);
                break;
              default:
                a.error("unknown operation for imarith: " + d.op);
            }
            break;
          case "value":
            b = d.argval;
            switch (d.op) {
              case "add":
                for (d = 0; d < c.data.length; d++) c.data[d] += b;
                break;
              case "sub":
                for (d = 0; d < c.data.length; d++) c.data[d] -= b;
                break;
              case "mul":
                for (d = 0; d < c.data.length; d++) c.data[d] *= b;
                break;
              case "div":
                for (d = 0; d < c.data.length; d++) c.data[d] = 0 === b ? 0 : c.data[d] / b;
                break;
              case "min":
                for (d = 0; d < c.data.length; d++) c.data[d] = Math.min(c.data[d], b);
                break;
              case "max":
                for (d = 0; d < c.data.length; d++) c.data[d] = Math.max(c.data[d], b);
                break;
              default:
                a.error("unknown op for imarith: " + d.op);
            }
            break;
          default:
            a.error("unknown arg type for imarith: " + d.argtype);
        }
        return !0;
      });
      return this;
    }
  };
  a.Image.prototype.shiftData = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b);
    d = e.next().value;
    var f = e.next().value;
    e = e.next().value;
    (void 0 !== d && void 0 !== f) || a.error("missing translation value(s) for shiftData");
    e = e || {};
    if ("string" === typeof e)
      try {
        e = JSON.parse(e);
      } catch (g) {
        a.error("can't parse shift opts: " + e, g);
      }
    e.rawid = e.rawid || "shift";
    e.x = parseFloat(d);
    e.y = parseFloat(f);
    this.xeqStashSave("shiftData", b.slice(), e.rawid);
    this.rawDataLayer(e, function (a, b, c) {
      var d = a.data.BYTES_PER_ELEMENT;
      void 0 === b.xoff && (b.xoff = 0);
      void 0 === b.yoff && (b.yoff = 0);
      b.xoff += c.x;
      b.yoff += c.y;
      if (!c.fill || "clear" === c.fill) {
        if (0 < b.bitpix) {
          var e = c.blank || b.header.BLANK || 0;
          b.header.BLANK = e;
        } else e = NaN;
        if ("function" === typeof b.data.fill) b.data.fill(e);
        else for (c = 0; c < b.data.length; c++) b.data[c] = e;
      }
      for (c = 0; c < a.height; c++) {
        var f = c + b.yoff;
        if (!(0 > f || f >= a.height)) {
          var g = 0;
          var h = g + b.xoff;
          e = a.width;
          0 > h && ((g -= h), (e += h), (h = 0));
          h + e > a.width && (e -= h + e - a.width);
          if (0 >= e) return !1;
          g = (c * a.width + g) * d;
          g = new Uint8Array(a.data.buffer, g, e * d);
          h = (f * a.width + h) * d;
          e = new Uint8Array(b.data.buffer, h, e * d);
          e.set(g);
        }
      }
      return !0;
    });
    return this;
  };
  a.Image.prototype.rotateData = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e, f;
    var g = (e = 0);
    d = $jscomp.makeIterator(b);
    var h = d.next().value,
      l = d.next().value;
    (this.raws && this.raws[0]) || a.error("no raw data for reprojection");
    d = this.raws[0];
    (d.header && d.wcsinfo) || a.error("no WCS info available for reprojection");
    l = l || {};
    if ("string" === typeof l)
      try {
        l = JSON.parse(l);
      } catch (u) {
        a.error("can't parse rotate opts: " + l, u);
      }
    l.stash = "rotateData";
    l.rawid = "rotate";
    l.oraw = a.RAWID0;
    !0 !== l.resetSection && (l.resetSection = !1);
    var m = d.header;
    var k = $.extend(!0, {}, m);
    l.center = l.center || a.globalOpts.rotationCenter;
    if ("file" !== l.center && this.validWCS()) {
      var q = this.getPan();
      (f = a.pix2wcs(this.raw.wcs, q.x, q.y).trim().split(/\s+/)) &&
        1 < f.length &&
        ((k.CRPIX1 = q.x),
        (k.CRPIX2 = q.y),
        (k.CRVAL1 = a.saostrtod(f[0])),
        a.isHMS(this.params.wcssys) && (k.CRVAL1 *= 15),
        (k.CRVAL2 = a.saostrtod(f[1])));
    }
    d.wcsinfo && ((e = d.wcsinfo.cdelt1 || 0), (g = d.wcsinfo.cdelt2 || 0));
    if ("string" === typeof h)
      switch (h.toLowerCase()) {
        case "northisup":
        case "northup":
          h = 0;
          0 < e && (e = -e);
          0 > g && (g = -g);
          break;
        default:
          h = parseInt(h, 10);
      }
    a.notNull(m.CD1_1)
      ? ((g = -((h * Math.PI) / 180)),
        (e = Math.sin(g)),
        (g = Math.cos(g)),
        (k.CD1_1 = m.CD1_1 * g + m.CD1_2 * e),
        (k.CD1_2 = m.CD1_1 * -e + m.CD1_2 * g),
        (k.CD2_1 = m.CD2_1 * g + m.CD2_2 * e),
        (k.CD2_2 = m.CD2_1 * -e + m.CD2_2 * g))
      : ((k.CROTA2 = h), (k.CDELT1 = e), (k.CDELT2 = g));
    l.lcsUseRota2 = !0;
    d.wcsinfo && (k.ptype = d.wcsinfo.ptype);
    this.xeqStashSave("rotateData", b.slice(), l.rawid);
    return this.reprojectData(k, l);
  };
  a.Image.prototype.reproject = function (c, b) {
    var d,
      e,
      f,
      g = !1;
    var h = {};
    var l =
      /SIMPLE|BITPIX|NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/;
    var m = /TAN|SIN|ZEA|STG|ARC/,
      k = function (b, c) {
        if (!c) return b;
        b = $.extend(!0, {}, b);
        a.isNull(b.CRVAL1) && !a.isNull(c.crval1) && (b.CRVAL1 = c.crval1);
        a.isNull(b.CRVAL2) && !a.isNull(c.crval2) && (b.CRVAL2 = c.crval2);
        a.isNull(b.CRPIX1) && !a.isNull(c.crpix1) && (b.CRPIX1 = c.crpix1);
        a.isNull(b.CRPIX2) && !a.isNull(c.crpix2) && (b.CRPIX2 = c.crpix2);
        a.isNull(b.CDELT1) && !a.isNull(c.cdelt1) && (b.CDELT1 = c.cdelt1);
        a.isNull(b.CDELT2) && !a.isNull(c.cdelt2) && (b.CDELT2 = c.cdelt2);
        a.isNull(b.CROTA2) && !a.isNull(c.crot) && (b.CROTA2 = c.crot);
        return b;
      };
    if (a.reproject && c && this !== c) {
      (this.raws && this.raws[0]) || a.error("no raw data for reprojection");
      var q = this.raws[0];
      (q.header && q.wcsinfo) || a.error("no WCS info available for reprojection");
      b = b || {};
      var u = $.extend(!0, {}, q.header);
      for (p in u) Object.prototype.hasOwnProperty.call(u, p) && l.test(p) && delete u[p];
      if ("object" === typeof c) {
        c.raw && c.raw.header
          ? (d = c.raw.header)
          : c.BITPIX && c.NAXIS1 && c.NAXIS2
            ? (d = c)
            : a.error("invalid wcs object input to reproject()");
        for (p in d) Object.prototype.hasOwnProperty.call(d, p) && l.test(p) && (h[p] = d[p]);
        u = $.extend(!0, {}, h, u);
        if (!u.NAXIS || !u.NAXIS1 || !u.NAXIS2) return;
        u.NAXIS1 = Math.min(u.NAXIS1, a.globalOpts.image.xdim);
        u.NAXIS2 = Math.min(u.NAXIS2, a.globalOpts.image.ydim);
        var p = a.raw2FITS(u, { addcr: !0 });
        u = "wcs_" + a.uniqueID() + ".txt";
        a.vfile(u, p);
        a.globalOpts.reprojectLimits &&
          ((p = a.globalOpts.image.xdim),
          (h = a.globalOpts.image.ydim),
          (l = a.globalOpts.image.xdim * a.globalOpts.image.ydim),
          q.header.NAXIS1 * q.header.NAXIS2 > l &&
            a.error(
              "the max reproject size is " +
                p +
                " * " +
                h +
                ". You can use the Bin/Filter/Section plugin to extract a section, then save it as FITS and reproject the smaller image."
            ));
      } else u = c;
      try {
        if (!m.test(q.wcsinfo.ptype)) {
          var n = k(q.header, q.wcsinfo);
          var x = "owcs_" + a.uniqueID() + ".txt";
          a.vfile(x, a.raw2FITS(n, { addcr: !0 }));
          var w = "awcs_" + a.uniqueID() + ".txt";
          var t = a.tanhdr(x, w, "");
          1 < a.DEBUG && a.log("tanhdr (input): %s %s -> %s", x, w, t);
          a.vunlink(x);
          0 <= t.search(/\[struct stat="OK"/) &&
            ((b.cmdswitches = b.cmdswitches || ""), (b.cmdswitches += " -i " + w));
        }
        if ((c.raw && !m.test(c.raw.wcsinfo.ptype)) || (c.ptype && !m.test(c.ptype))) {
          n = k(d, c.raw.wcsinfo);
          x = "owcs_" + a.uniqueID() + ".txt";
          a.vfile(x, a.raw2FITS(n, { addcr: !0 }));
          var v = "awcs_" + a.uniqueID() + ".txt";
          t = a.tanhdr(x, v, "");
          1 < a.DEBUG && a.log("tanhdr (reproj): %s %s -> %s", x, v, t);
          a.vunlink(x);
          0 <= t.search(/\[struct stat="OK"/) && (a.vunlink(u), (u = v));
        }
      } catch (A) {}
      if (q.hdu && q.hdu.fits.vfile)
        ((c = q.hdu.fits.vfile),
          q.hdu.fits.extname
            ? (c += "[" + q.hdu.fits.extname + "]")
            : q.hdu.fits.extnum && 0 < q.hdu.fits.extnum && (c += "[" + q.hdu.fits.extnum + "]"));
      else {
        var r = this.toArray();
        c = this.id.replace(/\.png$/, "_png.fits");
        a.vfile(c, r);
      }
      v = this.id
        .replace(/\[.*\]/, "")
        .replace(/\.png$/i, ".fits")
        .replace(/\.fz$/i, "")
        .replace(/\.gz$/i, "");
      v = "reproj_" + a.uniqueID() + "_" + v;
      d = b.rawid || "reproject";
      for (
        x = 0;
        x < this.raws.length && ((n = this.raws[x]), n.id !== d || !a.cleanupFITSFile(n, !0));
        x++
      );
      q.hdu &&
        "table" === q.hdu.imtab &&
        q.hdu.table &&
        !c.match(/\[bin /) &&
        (c.match(/\[EVENTS\]/) || (c += "[EVENTS]"),
        (n = q.hdu.table),
        (q = Math.floor(n.xcen - n.xdim / 2 + 1)),
        (x = Math.floor(n.xcen + n.xdim / 2)),
        (d = Math.floor(n.ycen - n.ydim / 2 + 1)),
        (n = Math.floor(n.ycen + n.ydim / 2)),
        (c += "[bin X=" + q + ":" + x + ",Y=" + d + ":" + n + "]"));
      try {
        var z = v.lastIndexOf(".");
        0 <= z && (e = v.substring(0, z) + "_area" + v.substring(z));
        var y = b.cmdswitches || "";
        y += " -a 0 " + a.globalOpts.reprojSwitches;
        t = a.reproject(c, v, u, y);
        1 < a.DEBUG && a.log("reproject: %s %s %s [%s] -> %s", c, v, u, y, t);
        a.vunlink(e);
        a.vunlink(u);
        w && a.vunlink(w);
        r && a.vunlink(c);
        0 > t.search(/\[struct stat="OK"/) &&
          ((g = !0),
          (f = t.match(/msg="(.*)"/)) && f[1] ? a.error(f[1] + " (from mProjectPP)") : a.error(t));
      } catch (A) {
        if (g) return;
        a.vunlink(e);
        a.vunlink(u);
        t ? a.error(t) : a.error("WCS reproject failed", A);
      }
      return v;
    }
  };
  a.Image.prototype.reprojectData = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = this,
      f;
    d = $jscomp.makeIterator(b);
    var g = d.next().value,
      h = d.next().value;
    if (g && a.reproject) {
      if ("string" === typeof g) {
        if ("all" === g) {
          for (b = 0; b < a.images.length; b++)
            ((d = a.images[b]), this.display.id === d.display.id && d.reprojectData(this));
          return;
        }
        (d = a.getImage(g)) ? (g = d) : a.error("unknown WCS for reproject: " + g);
      }
      if (this !== g) {
        h = h || {};
        if ("string" === typeof h)
          try {
            h = JSON.parse(h);
          } catch (l) {
            a.error("can't parse reproject opts: " + h, l);
          }
        h.rawid || this.xeqStashSave("reprojectData", b.slice(), "reproject");
        h.stash || (h.stash = "reprojectData");
        a.waiting(!0, this.display);
        this.setStatus("reprojectData", "processing");
        window.setTimeout(function () {
          var b = function (b) {
            e.xeqPlugins("image", "onreprojectdata");
            c = c || {};
            c.refreshRegions = !0;
            !1 !== h.resetSection && (c.resetSection = !0);
            h.lcsUseRota2 && (c.lcsUseRota2 = !0);
            e.refreshImage(b, c);
            e.setStatus("reprojectData", "complete");
            e.xeqStashCall(e.xeqstash, [h.stash, "reprojectData"]);
            if ("function" === typeof h.onreproject)
              try {
                a.xeqByName(h.onreproject, window, e);
              } catch (q) {
                a.error("in onreproject callback", q, !1);
              }
          };
          h = h || {};
          b = h.reprojHandler || b;
          if ((f = e.reproject(g, h))) {
            var c = $.extend(!0, {}, a.fits.options, h);
            c.rawid = c.rawid || "reproject";
            g.raw && g.raw.header && (c.wcsim = g);
            try {
              a.handleFITSFile(f, c, b);
            } catch (k) {
              a.error("can't process reprojected FITS file", k);
            }
          }
        }, a.SPINOUT);
        return this;
      }
    }
  };
  a.Image.prototype.filterRGBImage = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e;
    d = $jscomp.makeIterator(b).next().value;
    var f = [];
    if (!d) {
      for (e in a.ImageFilters)
        Object.prototype.hasOwnProperty.call(a.ImageFilters, e) && f.push(e);
      return f;
    }
    switch (d) {
      case "reset":
        return (this.setColormap("reset"), this);
      case "median":
        d = "medianFilter";
        break;
      case "edge":
        d = "edgeDetect";
    }
    a.ImageFilters[d] || a.error("JS9 image filter '" + d + "' not available");
    this.xeqStashSave("filterRGBImage", b.slice());
    b.shift();
    b.unshift(this.display.context, this.rgb.img);
    try {
      a.ImageFilters[d].apply(a.ImageFilters, $jscomp.arrayFromIterable(b));
    } catch (g) {
      a.error("JS9 image filter '" + d + "' failed", g);
    }
    this.displayImage("display");
    a.globalOpts.extendedPlugins && this.xeqPlugins("image", "onfilterrgbimage");
    return this;
  };
  a.Image.prototype.moveToDisplay = function (c) {
    var b,
      d,
      e = 0,
      f = this.display;
    var g = a.lookupDisplay(c);
    (c && g) || a.error("could not find display: " + c);
    this.display.clearMessage();
    this.display.context.clear();
    this.xeqPlugins("image", "onimageclear");
    for (b in f.layers)
      Object.prototype.hasOwnProperty.call(f.layers, b) &&
        ("main" !== f.layers[b].dtype || g.layers[b] || g.newShapeLayer(b, f.layers[b].opts));
    if (g.image)
      for (b in g.layers)
        Object.prototype.hasOwnProperty.call(g.layers, b) &&
          "main" === g.layers[b].dtype &&
          g.image.showShapeLayer(b, !1, { local: !0 });
    for (b in this.layers)
      Object.prototype.hasOwnProperty.call(this.layers, b) &&
        ((c = this.layers[b]),
        (d = g.layers[b])
          ? (this.showShapeLayer(b, !1, { local: !0 }),
            (c.dlayer = d),
            (c.divjq = d.divjq),
            (c.canvasjq = d.canvasjq),
            (c.canvas = d.canvas))
          : delete this.layers[b]);
    this.display = g;
    this.display.image = this;
    this.mkSection();
    this.displayImage("all");
    for (b in this.layers)
      Object.prototype.hasOwnProperty.call(this.layers, b) &&
        this.showShapeLayer(b, !0, { local: !0 });
    f.rgb.rim === this && ((f.rgb.rim = null), (g.rgb.rim = this));
    f.rgb.gim === this && ((f.rgb.gim = null), (g.rgb.gim = this));
    f.rgb.bim === this && ((f.rgb.bim = null), (g.rgb.bim = this));
    f.image = null;
    this.refreshLayers();
    for (b = 0; b < a.images.length; b++)
      if (((g = a.images[b]), f === g.display)) {
        g.display.image = null;
        g.displayImage("all");
        g.refreshLayers();
        e++;
        break;
      }
    !e &&
      f.winid &&
      f.winid.close &&
      ((b = $.inArray(f, a.displays)), 0 <= b && a.displays.splice(b, 1), f.winid.close());
    return this;
  };
  a.Image.prototype.saveSession = function (c, b) {
    var d,
      e,
      f,
      g,
      h,
      l,
      m = function (b) {
        var c = {};
        if (window.electron) {
          var k = new RegExp("^" + window.electron.currentDir + "/");
          c.file = b.file.replace(k, "");
        } else c.file = b.file;
        c.dwidth = b.display.width;
        c.dheight = b.display.height;
        c.params = $.extend(!0, {}, b.params);
        c.tmp = {};
        "active" === b.tmp.gridStatus && (c.tmp.gridStatus = "active");
        h = b.imageToLogicalPos({ x: b.rgb.sect.xcen, y: b.rgb.sect.ycen });
        (l = b.maybePhysicalToImage(h)) && (h = l);
        c.sect = {};
        c.sect.xcen = h.x;
        c.sect.ycen = h.y;
        c.sect.xdim = b.raw.width;
        c.sect.ydim = b.raw.height;
        c.sect.zoom = b.rgb.sect.zoom;
        c.layers = [];
        for (g in b.layers)
          Object.prototype.hasOwnProperty.call(b.layers, g) &&
            ((d = b.layers[g]),
            (e = d.dlayer),
            "main" === e.dtype &&
              "crosshair" !== g &&
              "grid" !== g &&
              ((f = {}),
              (f.name = g),
              (f.json = e.canvas.toJSON(e.el)),
              (f.dopts = $.extend(!0, {}, e.opts)),
              d.catalog && (f.catalog = d.catalog),
              d.starbase && (f.starbase = JSON.stringify(d.starbase)),
              c.layers.push(f)),
            e.canvas.forEachObject(function (b) {
              b.params &&
                b.params.winid &&
                ($(b.params.winid).is(":visible")
                  ? a.error(
                      "please close your region dialog box(es) to avoid a JSON circular reference error when saving this session"
                    )
                  : (b.params.winid = null));
            }));
        c.blend = b.blend;
        c.xeqstash = b.xeqstash;
        b.wcsim && b.wcsim.id && (c.wcsim = b.wcsim.id);
        delete c.params.display;
        c.params.rot90 = 0;
        c.params.flip = "none";
        c.params.crosshair = !1;
        return c;
      };
    Object.prototype.hasOwnProperty.call(window, "saveAs") ||
      a.error("no saveAs() available to save session");
    c = c || "js9.ses";
    c.match(/\.ses$/) || (c += ".ses");
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (p) {
        a.error("can't parse session opts: " + b, p);
      }
    a.waiting(!0, this.display);
    var k = { images: [] };
    if ("display" === b.mode)
      for (b = 0; b < a.images.length; b++) {
        var q = a.images[b];
        q.display.id === this.display.id && k.images.push(m(q));
      }
    else k.images.push(m(this));
    k.display = { blendMode: this.display.blendMode };
    k.globals = $.extend(!0, {}, a.globalOpts);
    delete k.globals.rgb;
    k.cmaps = [];
    for (b = 0; b < a.colormaps.length; b++)
      "user" === a.colormaps[b].source && k.cmaps.push(a.colormaps[b]);
    try {
      var u = JSON.stringify(k, null, 4);
    } catch (p) {
      a.error("can't create json file for save session", p);
    }
    k = new Blob([u], { type: "application/json" });
    a.saveAs(k, c);
    a.waiting(!1);
    return c;
  };
  a.Image.prototype.xeqStashSave = function (c, b, d, e) {
    var f, g;
    e = e || "image";
    this.xeqstash = this.xeqstash || [];
    for (f = 0; f < b.length; f++)
      "object" === typeof b[f] &&
        (b[f] instanceof a.Image
          ? (b[f] = b[f].id)
          : b[f] instanceof a.Display && (b[f] = b[f].id));
    switch (c) {
      case "setRot90":
        f = this.xeqstash.length;
        if (1 <= f && this.xeqstash[f - 1] && this.xeqstash[f - 1].args[0] === -b[0])
          return (this.xeqstash.pop(), this);
        break;
      case "setFlip":
        f = this.xeqstash.length;
        if (1 <= f && this.xeqstash[f - 1] && this.xeqstash[f - 1].args[0] === b[0])
          return (this.xeqstash.pop(), this);
        break;
      default:
        for (f = 0; f < this.xeqstash.length; f++)
          if ((g = this.xeqstash[f]) && g.func === c && g.context === e)
            return ((g.args = b), this);
    }
    this.xeqstash.push({ func: c, args: b, id: d, context: e });
    return this;
  };
  a.Image.prototype.xeqStashCall = function (c, b) {
    var d = this,
      e,
      f = function (b, c) {
        var e = c.context || "image";
        try {
          switch (e) {
            case "image":
              d[b].apply(d, $jscomp.arrayFromIterable(c.args));
              break;
            case "display":
              d.display[b].apply(d.display, $jscomp.arrayFromIterable(c.args));
              break;
            default:
              d[b].apply(d, $jscomp.arrayFromIterable(c.args));
          }
        } catch (q) {
          a.error("error executing stash: " + b, q, !1);
        }
      };
    c = c || this.xeqstash;
    if ($.isArray(c))
      for (e = 0; e < c.length; e++) {
        var g = c[e];
        var h = g.func;
        0 <= $.inArray(h, b) || f(h, g);
      }
    else
      for (h in c)
        !Object.prototype.hasOwnProperty.call(c, h) ||
          0 <= $.inArray(h, b) ||
          ((g = c[h]), f(h, g));
  };
  a.Image.prototype.xeqStashDiscard = function (a) {
    var b;
    if (this.xeqstash)
      if ($.isArray(this.xeqstash))
        for (b = this.xeqstash.length - 1; 0 <= b; b--)
          (a !== this.xeqstash[b].func && a !== this.xeqstash[b].id) || this.xeqstash.splice(b, 1);
      else
        for (b in this.xeqstash)
          Object.prototype.hasOwnProperty.call(this.xeqstash, b) &&
            (a === b || a === this.xeqstash[b].id) &&
            delete this.xeqstash[b];
  };
  a.Image.prototype.xeqPlugins = function (c, b, d) {
    var e,
      f = function (a, b) {
        a = "JS9:" + a;
        $(document).trigger(a, b);
      };
    if (c && b && a.globalOpts.xeqPlugins) {
      var g = this.display.pluginInstances;
      for (e in g)
        if (Object.prototype.hasOwnProperty.call(g, e)) {
          var h = g[e];
          var l = h.plugin.opts;
          if (h.isActive(b) && "function" === typeof l[b]) {
            this.callingPlugin = b;
            switch (c) {
              case "image":
                try {
                  (l[b].call(h, this), f(b, { im: this }));
                } catch (k) {
                  h.errLog(b, k);
                }
                break;
              case "region":
              case "shape":
                try {
                  (l[b].call(h, this, d), f(b, { im: this, xreg: d }));
                } catch (k) {
                  h.errLog(b, k);
                }
                break;
              case "keydown":
              case "keypress":
                var m = d.originalEvent || d;
                try {
                  (l[b].call(h, this, this.ipos, m), f(b, { im: this, ipos: this.ipos, evt: m }));
                } catch (k) {
                  h.errLog(b, k);
                }
                break;
              case "mouse":
                if (!this.clickInRegion || l[b + "_inRegion"]) {
                  m = d.originalEvent || d;
                  try {
                    (l[b].call(h, this, this.ipos, m), f(b, { im: this, ipos: this.ipos, evt: m }));
                  } catch (k) {
                    h.errLog(b, k);
                  }
                }
            }
            delete this.callingPlugin;
          }
        }
      return this;
    }
  };
  a.Image.prototype.uploadFITSFile = function () {
    var c = this,
      b,
      d = function (b) {
        delete a.worker.uploadActive;
        window.setTimeout(function () {
          a.progress(!1);
        }, 1e3);
        b.stderr
          ? a.error(b.stderr)
          : b.stdout &&
            ((c.fitsFile = b.stdout.trim()),
            (c.proxyFile = c.fitsFile),
            a.globalOpts.prependJS9Dir &&
              !c.fitsFile.match(/^\${JS9_DIR}/) &&
              "/" !== c.fitsFile.charAt(0) &&
              (c.fitsFile = "${JS9_DIR}/" + c.fitsFile),
            c.queryHelper("all"));
      };
    if (
      a.worker &&
      ("nodejs" === a.helper.type || "socket.io" === a.helper.type) &&
      this.raw.hdu &&
      this.raw.hdu.fits &&
      this.raw.hdu.fits.vfile
    ) {
      a.worker.uploadActive && a.error("only one upload allowed at a time");
      var e = this.raw.hdu.fits.vfile;
      a.helper.send("quotacheck", null, function (f) {
        (f.stderr || f.errcode) && a.error(f.stderr || "from quotacheck: " + f.errcode);
        b = a.vread(e, "binary");
        a.worker.socketio(function () {
          a.worker.uploadActive = !0;
          a.progress(!0, c.display);
          a.worker.send("uploadFITS", [e, b], d, [b.buffer]);
        });
      });
      return this;
    }
  };
  a.Image.prototype.removeProxyFile = function (c) {
    var b = this;
    if ("boolean" === typeof c) var d = c;
    else if ("string" === typeof c) {
      if (c.match(/^\//)) return;
      var e = new RegExp("^" + a.INSTALLDIR);
      e = c.replace(e, "");
      if (e.match(/\.\./)) return;
      e = c;
    } else {
      if (!this.proxyFile) return;
      e = this.proxyFile;
      this.proxyParent && (e = e + " " + this.proxyParent);
    }
    e &&
      a.Send("removeproxy", { cmd: "js9Xeq removeproxy " + e }, function (a) {
        d &&
          a &&
          "OK" === a.stdout.trim() &&
          ((b.proxyFile = null),
          (b.proxyParent = null),
          (b.fitsFile = null),
          (b.analysisPackages = null),
          b.queryHelper("all"));
      });
  };
  a.Image.prototype.starbaseToShapes = function (c, b) {
    var d = this,
      e,
      f,
      g,
      h = a.globalOpts.catalogs;
    var l = a.globalOpts.catalogs.ras;
    var m = a.globalOpts.catalogs.decs;
    var k = [],
      q = function (b, c) {
        return (b = a.wcs2pix(d.raw.wcs, b, c).trim().split(/ +/)) && b.length
          ? { x: parseFloat(b[0]), y: parseFloat(b[1]) }
          : null;
      };
    var u = function (a, b, c, d) {
      var e;
      if (void 0 !== d) var h = d;
      else {
        h = -1;
        for (e = 0; e < c.length; e++) {
          for (d = 0; d < b.length; d++)
            if (c[e].toLowerCase() === b[d].toLowerCase()) {
              h = a[b[d]];
              break;
            }
          if (0 <= h) break;
        }
        if (0 > h)
          for (f = c[0], g = new RegExp("^" + f, "i"), d = 0; d < b.length; d++)
            if (b[d].match(g)) {
              h = a[b[d]];
              break;
            }
        if (0 > h)
          for (f = c[0], g = new RegExp(".*" + f + ".*", "i"), d = 0; d < b.length; d++)
            if (b[d].match(g)) {
              h = a[b[d]];
              break;
            }
      }
      return h;
    };
    if (c && c.data && c.headline) {
      var p = c.data;
      var n = c.headline;
      var x = c.delims;
      b = b || {};
      l = u(c, n, l, b.xcol);
      0 > l && a.error("can't find an RA column (see Preferences:catalogs)");
      var w = u(c, n, m, b.ycol);
      0 > w && a.error("can't find a Dec column (see Preferences:catalogs)");
      u = b.shape || h.shape || "circle";
      switch (u) {
        case "box":
          var t = function () {
            return { width: b.width || h.width || 7, height: b.height || h.height || 7 };
          };
          break;
        case "circle":
          t = function () {
            return { radius: b.radius || h.radius || 3.5 };
          };
          break;
        case "ellipse":
          t = function () {
            return { r1: b.r1 || h.r1 || 3.5, r2: b.r2 || h.r2 || 3.5 };
          };
          break;
        default:
          t = function () {
            return { width: b.width || 7, height: b.height || 7 };
          };
      }
      var v = this.getWCSSys();
      var r = b.wcssys ? b.wcssys : h.wcssys ? h.wcssys : "ICRS";
      this.setWCSSys(r, !1);
      for (m = c = 0; c < p.length; c++) {
        var z = p[c][l];
        var y = p[c][w];
        "\x00" !== x[l] &&
          ":h ".includes(x[l]) &&
          "galactic" !== r &&
          "ecliptic" !== r &&
          (z *= 15);
        if ((e = q(z, y))) {
          var A = t();
          A = {
            id: c.toString(),
            shape: u,
            x: e.x,
            y: e.y,
            width: A.width,
            height: A.height,
            radius: A.radius,
            r1: A.r1,
            r2: A.r2,
            angle: 0,
            data: { ra: z, dec: y },
          };
          if (!1 !== b.save && !1 !== a.globalOpts.catalogs.save)
            for (e = 0; e <= n.length; e++) n[e] && (A.data[n[e]] = p[c][e]);
          b.color && (A.color = b.color);
          k[m++] = A;
        }
      }
      this.setWCSSys(v, !1);
      return k;
    }
  };
  a.Image.prototype.loadCatalog = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b);
    d = e.next().value;
    var f = e.next().value;
    e = e.next().value;
    var g = $.extend(!0, {}, a.Catalogs.opts),
      h = a.globalOpts.catalogs;
    1 === b.length && "string" !== typeof d && ((f = d), (d = null));
    2 === b.length && "string" !== typeof d && ((e = f), (f = d), (d = null));
    if (f) {
      h.tooltip && (g.tooltip = h.tooltip);
      e = e || {};
      if ("string" === typeof e)
        try {
          e = JSON.parse(e);
        } catch (m) {
          a.error("can't parse catalog opts: " + e, m);
        }
      e.color = e.color || h.color || "#00FF00";
      e.wcssys = e.wcssys || h.wcssys;
      e.updateWCS = !0;
      b = {
        convFuncs: {
          def: function (b) {
            var c = {};
            c.val = a.saostrtod(b);
            c.delim = String.fromCharCode(a.saodtype());
            if (("\x00" !== c.delim && " \t-.:hdmsr'\"".includes(c.delim)) || a.isNumber(b))
              return c;
            c.val = b;
            return c;
          },
        },
        units: e.units || h.units,
        skip: e.skip || h.skip,
      };
      try {
        var l = new a.Starbase(f, b);
      } catch (m) {
        a.error("could not parse catalog. Is it in tab-separated column format?");
      }
      (l && l.data && l.data.length) || a.error("no objects found in catalog");
      b = this.starbaseToShapes(l, e);
      b.length
        ? ((d = d || "catalog_" + a.uniqueID()),
          this.display.newShapeLayer(d, g),
          this.removeShapes(d),
          (this.layers[d].catalog = f),
          (this.layers[d].starbase = l),
          this.addShapes(d, b, e))
        : a.error("no catalog objects found");
      return this;
    }
  };
  a.Image.prototype.saveCatalog = function (c, b) {
    b = b || this.activeShapeLayer();
    (this.layers[b] && this.layers[b].catalog) ||
      (b && "undefined" !== b
        ? a.error("no catalog available: " + b)
        : a.error("no active catalog available"));
    var d = new Blob([this.layers[b].catalog], { type: "text/plain;charset=utf-8" });
    c = c || b + ".cat";
    c.match(/\.cat$/) || (c += ".cat");
    Object.prototype.hasOwnProperty.call(window, "saveAs")
      ? a.saveAs(d, c)
      : a.error("no saveAs() available to save catalog");
    return c;
  };
  a.Image.prototype.wcs2wcs = function (c, b, d, e) {
    var f = this.getWCSSys();
    var g = this.getWCSUnits();
    c = c || f;
    b = b || f;
    if ("string" === typeof d) {
      var h = a.strtoscaled(d);
      a.isHMS(c, h.dtype) && (h.dval *= 15);
      d = h.dval;
    }
    "string" === typeof e && ((h = a.strtoscaled(e)), (e = h.dval));
    h = this.setWCSSys(c, !1).getWCSSys();
    "native" !== c && h !== c && a.error("unknown or invalid wcs: " + c);
    d = a.wcs2pix(this.raw.wcs, d, e).trim().split(/ +/);
    c = parseFloat(d[0]);
    d = parseFloat(d[1]);
    this.setWCSSys(b, !1);
    this.setWCSUnits("degrees", !1);
    c = a.pix2wcs(this.raw.wcs, c, d).trim();
    this.setWCSUnits(g, !1);
    f !== b && this.setWCSSys(f, !1);
    return c;
  };
  a.Image.prototype.wcs2imlen = function (c) {
    var b = 1;
    if (c) {
      c = a.strtoscaled(c);
      var d = this.raw.wcsinfo || { cdelt1: 1, cdelt2: 1 };
      void 0 !== d.cdelt1 ? (b = d.cdelt1) : void 0 !== d.cdelt2 && (b = d.cdelt2);
      switch (this.params.wcssys) {
        case "image":
          break;
        case "physical":
          this.lcs &&
            this.lcs.physical &&
            ((b = Math.sqrt(
              Math.pow(this.lcs.physical.forward[0][0], 2) +
                Math.pow(this.lcs.physical.forward[0][1], 2)
            )),
            (c.dval = Math.abs(c.dval * b)));
          break;
        default:
          c.dtype && "." !== c.dtype && "\x00" !== c.dtype && (c.dval = Math.abs(c.dval / b));
      }
      return c.dval;
    }
  };
  a.Colormap = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b);
    d = e.next().value;
    var f = e.next().value,
      g = e.next().value;
    e = e.next().value;
    if (d) {
      this.name = d;
      switch (b.length) {
        case 2:
          $.isArray(f[0]) && "number" === typeof f[0][0]
            ? ((this.type = "lut"), (this.colors = f))
            : ((this.type = "static"), (this.colors = a.parseStaticColors(f)));
          break;
        case 4:
          this.type = "sao";
          this.vertices = [f, g, e];
          break;
        default:
          a.error("colormap requires a colormap name and 1 or 3 array args");
      }
      this.source = a.inited ? "user" : "core";
      for (b = 0; b < a.colormaps.length; b++)
        if (a.colormaps[b].name === this.name) {
          a.colormaps[b] = this;
          var h = !0;
          break;
        }
      h || a.colormaps.push(this);
      1 < a.DEBUG && a.log("JS9 colormap:  %s", this.name);
    }
  };
  a.Colormap.prototype.mkColorCell = function (c) {
    var b = a.COLORSIZE;
    var d = [0, 0, 0];
    switch (this.type) {
      case "sao":
        var e = c / b;
        for (c = 0; 3 > c; c++) {
          var f = this.vertices[c];
          var g = f.length;
          for (b = 0; b < g && !(f[b][0] > e); b++);
          b =
            0 === b
              ? f[0][1]
              : b === g
                ? f[g - 1][1]
                : (g = (f[b][1] - f[b - 1][1]) / (f[b][0] - f[b - 1][0]))
                  ? g * (e - f[b - 1][0]) + f[b - 1][1]
                  : f[b][1];
          d[c] = 255 * b;
        }
        break;
      case "lut":
        e = this.colors.length;
        c = Math.floor((c * e) / b);
        0 > c
          ? ((d[0] = 255 * this.colors[0][0]),
            (d[1] = 255 * this.colors[0][1]),
            (d[2] = 255 * this.colors[0][2]))
          : c < e
            ? ((d[0] = 255 * this.colors[c][0]),
              (d[1] = 255 * this.colors[c][1]),
              (d[2] = 255 * this.colors[c][2]))
            : ((d[0] = 255 * this.colors[e - 1][0]),
              (d[1] = 255 * this.colors[e - 1][1]),
              (d[2] = 255 * this.colors[e - 1][2]));
        break;
      case "static":
        break;
      default:
        a.error("unknown colormap type");
    }
    return d;
  };
  a.Display = function (c) {
    var b = this;
    this.divjq = c instanceof jQuery ? c : "object" === typeof c ? $(c) : $("#" + c);
    this.divjq.attr("id") || this.divjq.attr("id", a.DEFID);
    this.id = this.divjq.attr("id");
    this.tmp = {};
    this.rgb = { active: !1, rim: null, gim: null, bim: null };
    this.divjq.addClass("JS9");
    this.width = this.divjq.attr("data-width");
    this.width || (this.width = a.WIDTH);
    this.divjq.css("width", this.width);
    this.width = parseInt(this.divjq.css("width"), 10);
    this.height = this.divjq.attr("data-height");
    this.height || (this.height = a.HEIGHT);
    this.divjq.css("height", this.height);
    this.height = parseInt(this.divjq.css("height"), 10);
    this.width0 = this.width;
    this.height0 = this.height;
    this.canvas = document.createElement("canvas");
    this.canvasjq = $(this.canvas)
      .addClass("JS9Image")
      .attr("id", this.id + "Image")
      .attr("width", this.width)
      .attr("height", this.height)
      .css("z-index", a.ZINDEX);
    this.displayConjq = $("<div>")
      .addClass("JS9Container")
      .css("z-index", a.ZINDEX)
      .attr("tabindex", "0")
      .append(this.canvasjq)
      .appendTo(this.divjq);
    a.allinone ||
      ((this.iconjq = $("<div>")
        .addClass("JS9Logo")
        .css("display", "none")
        .css("z-index", a.ZINDEX + 1)
        .appendTo(this.divjq)),
      (this.iconimgjs = $("<img>")
        .addClass("JS9Logo")
        .attr("src", a.InstallDir(a.globalOpts.logo))
        .attr("alt", "js9")
        .attr("title", "js9")
        .appendTo(this.iconjq)),
      a.globalOpts.logoDisplay && this.iconjq.css("display", "block"));
    a.globalOpts.resizeHandle &&
      Object.prototype.hasOwnProperty.call(window, "ResizeSensor") &&
      (this.divjq.css("resize", "both").css("overflow", "hidden"),
      a.bugs.webkit_resize &&
        ((this.owidth = parseInt(this.divjq.css("width"), 10)),
        (this.oheight = parseInt(this.divjq.css("height"), 10)),
        this.divjq
          .css("width", this.width + a.RESIZEFUDGE)
          .css("height", this.height + a.RESIZEFUDGE)),
      (this.resizeSensor = new ResizeSensor(this.divjq, function () {
        var c = b.divjq.width(),
          e = b.divjq.height();
        a.bugs.webkit_resize && ((c -= a.RESIZEFUDGE), (e -= a.RESIZEFUDGE));
        b.resize(c, e);
      })));
    this.context = this.canvas.getContext("2d");
    a.ANTIALIAS || (this.context.imageSmoothingEnabled = !1);
    this.tooltip = $("<div>")
      .attr("id", "tooltip_" + this.id)
      .addClass("JS9Tooltip")
      .appendTo(this.divjq);
    this.image = null;
    this.pluginInstances = {};
    this.layers = {};
    this.initMessages();
    this.blendMode = !1;
    this.mouseActions = a.globalOpts.mouseActions.slice(0);
    this.touchActions = a.globalOpts.touchActions.slice(0);
    this.divjq.on("mouseenter", this, function (b) {
      return a.mouseEnterCB(b);
    });
    this.divjq.on("mouseover", this, function (b) {
      return a.mouseOverCB(b);
    });
    this.divjq.on("mousedown touchstart", this, function (b) {
      return a.mouseDownCB(b);
    });
    this.divjq.on("mousemove touchmove", this, function (b) {
      return a.mouseMoveCB(b);
    });
    this.divjq.on("mouseup touchend", this, function (b) {
      return a.mouseUpCB(b);
    });
    this.divjq.on("mouseout", this, function (b) {
      return a.mouseOutCB(b);
    });
    this.divjq.on("keypress", this, function (b) {
      return a.keyPressCB(b);
    });
    this.divjq.on("keydown", this, function (b) {
      return a.keyDownCB(b);
    });
    this.divjq.on("keyup", this, function (b) {
      return a.keyUpCB(b);
    });
    this.divjq.on("wheel", this, function (b) {
      return a.wheelCB(b);
    });
    this.divjq.on("dragenter", this, function (c) {
      return a.dragenterCB(b.id, c);
    });
    this.divjq.on("dragover", this, function (c) {
      return a.dragoverCB(b.id, c);
    });
    this.divjq.on("dragexit", this, function (c) {
      return a.dragexitCB(b.id, c);
    });
    this.divjq.on("drop", this, function (c) {
      return a.dragdropCB(b.id, c);
    });
    this.divjq.on("contextmenu", this, function () {
      return !1;
    });
    this.addFileDialog("Load", a.globalOpts.imageTemplates);
    this.addFileDialog("RefreshImage", a.globalOpts.imageTemplates);
    this.addFileDialog("LoadRegions", a.globalOpts.regTemplates);
    this.addFileDialog("LoadSession", a.globalOpts.sessionTemplates);
    this.addFileDialog("LoadColormap", a.globalOpts.colormapTemplates);
    this.addFileDialog("LoadCatalog", a.globalOpts.catalogTemplates);
    a.displays.push(this);
    this.displayConjq.focus();
    a.DEBUG && a.log("JS9 display:  %s", this.id);
  };
  a.Display.prototype.addFileDialog = function (c, b) {
    var d = this;
    if (c && a.publics[c]) {
      var e = "openLocal" + c + "-" + this.id;
      var f = $("<div>").addClass("JS9Hidden").appendTo(this.divjq);
      f = $("<input>").attr("type", "file").attr("id", e).attr("multiple", !0).appendTo(f);
      b && f.attr("accept", b);
      f.on("change", function (b) {
        var e = b.currentTarget;
        if (e.files.length)
          switch (c) {
            case "Load":
            case "RefreshImage":
              var f = { localAccess: !0 };
              a.waiting(!0, d);
          }
        for (b = 0; b < e.files.length; b++) a.publics[c](e.files[b], f, { display: d.id });
        e.value = null;
        return !1;
      });
    }
  };
  a.Display.prototype.initMessages = function () {
    this.messageContainer = $("<div>")
      .addClass("JS9Container")
      .css("z-index", a.MESSZINDEX)
      .appendTo(this.divjq);
    this.infoArea = $("<div>").addClass("JS9Message").appendTo(this.messageContainer);
    this.regionsArea = $("<div>").addClass("JS9Message").appendTo(this.messageContainer);
    this.progressArea = $("<div>")
      .addClass("JS9Progress")
      .addClass("JS9Message")
      .appendTo(this.messageContainer);
    this.progressBar = $("<progress>")
      .addClass("JS9ProgressBar")
      .attr("value", 0)
      .attr("max", 100)
      .attr("name", "progress")
      .appendTo(this.progressArea);
    try {
      this.messageContainer.draggable({
        start: function (c, b) {
          this.oicb = a.globalOpts.internalContrastBias;
          a.globalOpts.internalContrastBias = !1;
        },
        stop: function (c, b) {
          a.globalOpts.internalContrastBias = this.oicb;
        },
      });
    } catch (c) {}
    return this;
  };
  a.Display.prototype.displayPlugin = function (c) {
    var b = this,
      d;
    if ("string" === typeof c)
      for (d = 0; d < a.plugins.length; d++) {
        var e = a.plugins[d];
        if (e.name === c) {
          c = e;
          break;
        }
      }
    ("object" === typeof c && c.name) || a.error("unknown plugin type for displayPlugin");
    var f = this.pluginInstances[c.name];
    switch (a.globalOpts.winType) {
      case "light":
        var g = a.lightOpts[a.LIGHTWIN];
        if (!f || !f.status) {
          var h = c.name.replace(/\s/g, "_");
          d = this.id + "_" + h + "_lightDiv";
          e = this.id + "_" + h + "_outerDiv";
          h = this.id + "_" + h + "_innerDiv";
          if (!f) {
            var l = $("<div>").attr("id", e).css("display", "none").appendTo($(this.divjq));
            $("<div>")
              .addClass(c.name)
              .attr("id", h)
              .attr("data-js9id", this.divjq.attr("id"))
              .css("height", "100%")
              .css("width", "100%")
              .appendTo(l);
          }
          l = c.opts.winDims[0] || a.WIDTH;
          var m = c.opts.winDims[1] || a.HEIGHT;
          var k = c.opts.winResize ? "1" : "0";
          g = sprintf(g.format, l, m, k);
          l =
            c.opts.toolbarHTML && 0 <= c.opts.toolbarHTML.search(/\$title/)
              ? ""
              : c.opts.winTitle || "";
          l += sprintf(a.IDFMT, this.id);
          e = a.lightWin(d, "div", e, l, g);
          d = $("#" + d + " #" + h);
          f = a.instantiatePlugin(d, c, e);
          f.winHandle.onclose = function () {
            f.winHandle.hide();
            f.status = "inactive";
            if (c.opts.onpluginclose)
              try {
                c.opts.onpluginclose.call(f, b.image);
              } catch (q) {
                a.log("onplugincloseCB: %s [%s]\n%s", c.name, q.message, a.strace(q));
              }
            return !1;
          };
          f.status = "active";
          if (c.opts.onplugindisplay)
            try {
              c.opts.onplugindisplay.call(f, this.image);
            } catch (q) {
              a.log("onplugindisplayCB: %s [%s]\n%s", c.name, q.message, a.strace(q));
            }
        } else if ("inactive" === f.status) {
          if (f.winHandle && (f.winHandle.show(), (f.status = "active"), c.opts.onplugindisplay))
            try {
              c.opts.onplugindisplay.call(f, this.image);
            } catch (q) {
              a.log("onplugindisplayCB: %s [%s]\n%s", c.name, q.message, a.strace(q));
            }
        } else if (
          "active" === f.status &&
          f.winHandle &&
          (f.winHandle.hide(), (f.status = "inactive"), c.opts.onpluginclose)
        )
          try {
            c.opts.onpluginclose.call(f, this.image);
          } catch (q) {
            a.log("onplugincloseCB: %s [%s]\n%s", c.name, q.message, a.strace(q));
          }
        break;
      case "new":
        a.error("external window support for plugins not yet implemented");
    }
  };
  a.Display.prototype.displayLoadForm = function (c) {
    var b = this,
      d = a.globalOpts.localLoadFormat,
      e = a.globalOpts.remoteLoadMethod,
      f =
        !a.allinone &&
        "none" !== a.globalOpts.helperType &&
        a.globalOpts.workDir &&
        a.globalOpts.loadProxy;
    c = c || { local: !0, remote: !0 };
    a.isNull(c.title) &&
      ((c.title = ""),
      c.local && (c.title = "Open "),
      c.remote && (c.title && (c.title += "or "), (c.title += "Retrieve ")),
      (c.title += "an Image "),
      c.local && (c.title += "or Auxiliary File"));
    c.winformat = c.winformat || "width=640px,height=300px,resize=1,scrolling=1";
    var g = a.allinone ? a.allinone.loadHTML : a.InstallDir(a.globalOpts.loadURL);
    $(a.lightOpts[a.LIGHTWIN].topid).arrive(".loadForm", { onceOnly: !0 }, function (a) {
      var g = $(a).data("localfile") || b.tmp.localfile;
      a = $(a).data("remotefile") || b.tmp.remotefile;
      c.local &&
        ($(h).find(".localfile").removeClass("nodisplay"),
        $(h).find(".localdoc").removeClass("nodisplay"),
        g && $(h).find('input[name="localfile"]').val(g),
        $(h)
          .find("input[value=" + d + "]")
          .click());
      c.remote &&
        ($(h).find(".remotefile").removeClass("nodisplay"),
        $(h).find(".remotedoc").removeClass("nodisplay"),
        a && $(h).find('input[name="remotefile"]').val(a),
        f
          ? $(h)
              .find("input[value=" + e + "]")
              .click()
          : ($(h).find('input[value="cors"]').click(),
            $(h).find('input[value="proxy"]').prop("disabled", !0)));
    });
    var h = a.Image.prototype.displayAnalysis.call(null, "params", g, c);
    $(h).data("dispid", this.id);
  };
  a.Display.prototype.resize = function (c, b, d) {
    var e,
      f,
      g = function (a) {
        a.left += l;
        a.top += m;
        a.setCoords();
      };
    a.globalOpts.resize || a.error("display resize not enabled");
    if (!c && !b) return { width: this.width, height: this.height };
    if ("full" === c) {
      if (((d = b), window.innerWidth && (c = window.innerWidth), window.innerHeight))
        for (b = window.innerHeight, e = 0; e < a.globalOpts.centerDivs.length; e++) {
          var h = a.globalOpts.centerDivs[e];
          this.pluginInstances[h] && (b -= this.pluginInstances[h].divjq.height());
        }
    } else
      "image" === c
        ? (this.image || a.error("can't resize display to 'image' without an image"),
          (d = b),
          (c = this.image.raw.width),
          (b = this.image.raw.height))
        : "reset" === c && ((d = b), (c = this.width0 || c), (b = this.height0 || b));
    c = Math.floor(c);
    b = b ? Math.floor(b) : c;
    (10 > c || 10 > b) && a.error("invalid dimension(s) passed to display resize");
    if (c === this.width && b === this.height) return this;
    d = d || {};
    if ("string" === typeof d)
      try {
        d = JSON.parse(d);
      } catch (q) {
        a.error("can't parse resize opts: " + d, q);
      }
    e = c;
    var l = (e - this.width) / 2;
    var m = (b - this.height) / 2;
    var k = this.width;
    this.width = e;
    this.height = b;
    this.divjq.css("width", e);
    this.divjq.css("height", b);
    this.canvasjq.attr("width", e);
    this.canvasjq.attr("height", b);
    a.bugs.webkit_resize &&
      !this.resizing &&
      ((this.owidth = Math.min(this.owidth, e)), (this.oheight = Math.min(this.oheight, b)));
    0 <= $.inArray("JS9Menubar", a.globalOpts.resizeDivs) &&
      (a.isNull(d.resizeMenubar) || d.resizeMenubar) &&
      (h = this.pluginInstances.JS9Menubar) &&
      $("#" + this.id + "Menubar").css("width", e);
    0 <= $.inArray("JS9Toolbar", a.globalOpts.resizeDivs) &&
      (a.isNull(d.resizeToolbar) || d.resizeToolbar) &&
      (h = this.pluginInstances.JS9Toolbar) &&
      (h.divjq.attr("data-width", String(e) + "px"), a.Toolbar.init.call(h));
    0 <= $.inArray("JS9Colorbar", a.globalOpts.resizeDivs) &&
      (a.isNull(d.resizeColorbar) || d.resizeColorbar) &&
      (h = this.pluginInstances.JS9Colorbar) &&
      (h.divjq.attr("data-width", String(e) + "px"), a.Colorbar.init.call(h));
    0 <= $.inArray("JS9Statusbar", a.globalOpts.resizeDivs) &&
      (a.isNull(d.resizeStatusbar) || d.resizeStatusbar) &&
      (h = this.pluginInstances.JS9Statusbar) &&
      ($("#" + this.id + "Statusbar").css("width", e),
      h.statusBar &&
        h.statusBar.match(/\$colorbar/) &&
        !1 !== d.resizeStatusbarColorbar &&
        ((h.colorwidth = Math.max(h.colorwidth + c - k, a.Statusbar.COLORWIDTH)),
        a.Statusbar.display.call(h, this.image, { reinit: !0 })));
    for (f in this.layers)
      Object.prototype.hasOwnProperty.call(this.layers, f) &&
        ((c = this.layers[f]),
        "main" === c.dtype &&
          (c.divjq.css("width", e),
          c.divjq.css("height", b),
          c.canvasjq.attr("width", e),
          c.canvasjq.attr("height", b),
          c.canvas.setWidth(e),
          c.canvas.setHeight(b),
          c.canvas.calcOffset()));
    for (e = 0; e < a.images.length; e++)
      if (
        ((b = a.images[e]),
        b.mkSection(),
        b.display &&
          this === b.display &&
          (b.resize
            ? ((b.resize.left += l), (b.resize.top += m))
            : (b.resize = { left: l, top: m }),
          b === b.display.image))
      )
        for (f in b.layers)
          Object.prototype.hasOwnProperty.call(b.layers, f) &&
            ((c = b.layers[f]),
            "main" !== c.dlayer.type ||
              c.json ||
              (c.canvas.getObjects().forEach(g), c.canvas.renderAll()));
    a.bugs.webkit_resize &&
      this.divjq
        .css("width", this.width + a.RESIZEFUDGE)
        .css("height", this.height + a.RESIZEFUDGE);
    !this.image ||
      (!a.globalOpts.resizeRedisplay && this.resizing) ||
      (this.image.displayImage("all", d), this.image.refreshLayers());
    d.center && this.center();
    return this;
  };
  a.Display.prototype.inResize = function (c) {
    return a.globalOpts.resizeHandle &&
      c.x + a.RESIZEDIST >= this.divjq.width() &&
      c.y + a.RESIZEDIST >= this.divjq.height()
      ? !0
      : !1;
  };
  a.Display.prototype.center = function () {
    var c = this.divjq,
      b;
    var d = c.offset().top;
    var e = c.height(),
      f = $(window).height();
    var g = c.offset().left;
    c = c.width();
    var h = $(window).width();
    for (b = 0; b < a.globalOpts.centerDivs.length; b++) {
      var l = a.globalOpts.centerDivs[b];
      this.pluginInstances[l] &&
        ((l = this.pluginInstances[l].divjq), (e += l.height()), (d = Math.min(l.offset().top, d)));
    }
    d = e < f ? d - (f / 2 - e / 2) : d;
    g = c < h ? g - (h / 2 - c / 2) : g;
    $("html, body").animate({ scrollTop: d, scrollLeft: g }, 250);
    return this;
  };
  a.Display.prototype.gather = function (c) {
    var b;
    c = c || {};
    if ("string" === typeof c)
      try {
        c = JSON.parse(c);
      } catch (g) {
        a.error("can't parse gather opts: " + c, g);
      }
    var d = c.images || a.images;
    for (c = 0; c < d.length; c++)
      if ((b = "number" === typeof d[c] ? a.images[d[c]] : d[c]) && b.display !== this) {
        var e = b.display;
        var f = e.divjq.closest(".JS9GridItem");
        b.moveToDisplay(this);
        0 < f.length &&
          ((b = $.inArray(e, a.displays)), 0 <= b && a.displays.splice(b, 1), f.remove());
      }
    a.globalOpts.extendedPlugins && this.image && this.image.xeqPlugins("image", "ongatherdisplay");
  };
  a.Display.prototype.separate = function (c) {
    var b = this,
      d,
      e,
      f,
      g = 0,
      h = 0,
      l = 0,
      m = 1,
      k,
      q,
      u,
      p,
      n,
      x,
      w,
      t,
      v,
      r,
      z,
      y,
      A,
      B,
      C,
      D = {},
      E = /_sep[0-9][0-9]*/,
      F = a.globalOpts.separate,
      G = function (b, c, d) {
        c || a.error("can't init separation ops: no 'from' id");
        k = d.layout || a.globalOpts.separate.layout || "auto";
        q = d.leftMargin || F.leftMargin || 0;
        u = d.topMargin || F.topMargin || 0;
        "auto" === k && 0 < b.divjq.closest(".JS9GridContainer").length && (k = "grid");
        "grid" === k &&
          (CSS.supports("display", "grid")
            ? ((f = b.divjq.closest(".JS9GridContainer")), 0 < f.length && (p = f))
            : (k = "auto"));
        switch (k) {
          case "auto":
            l = 1;
            h = 0;
            break;
          case "horizontal":
            l = 1;
            h = 0;
            break;
          case "vertical":
            l = 0;
            h = 1;
            break;
          default:
            ((l = 1), (h = 0));
        }
        n = 43;
        x = 0;
        w = $("#" + c);
        t = $("#" + c + "Menubar");
        0 < t.length &&
          (t.isactive = "visible" === t.closest(".JS9PluginContainer").css("visibility"));
        v = $("#" + c + "Toolbar");
        0 < v.length &&
          (v.isactive = "visible" === v.closest(".JS9PluginContainer").css("visibility"));
        r = $("#" + c + "Statusbar");
        0 < r.length &&
          (r.isactive = "visible" === r.closest(".JS9PluginContainer").css("visibility"));
        z = $("#" + c + "Colorbar");
        0 < z.length &&
          !r.length &&
          (z.isactive = "visible" === z.closest(".JS9PluginContainer").css("visibility"));
        0 < w.length &&
          ((y = w.width()),
          (A = w.height()),
          (B = w.offset().top - $(window).scrollTop() - 5),
          (C = w.offset().left - $(document).scrollLeft()),
          t.isactive && ((A += t.height()), (B -= t.height())),
          v.isactive && ((A += v.height()), (B -= v.height())),
          r.isactive
            ? ((A += r.height()), (B -= r.height()))
            : z.isactive && ((A += z.height()), (B -= z.height()), (B += 7)));
      },
      J = function (a, b) {
        if (a) {
          if (0 < w.length) {
            var c = "";
            t.isactive &&
              (c += sprintf(
                "<div class='JS9Menubar' id='%sMenubar' data-width=%s></div>",
                b,
                w.width()
              ));
            v.isactive &&
              (c += sprintf(
                "<div class='JS9Toolbar' id='%sToolbar' data-width=%s></div>",
                b,
                w.width()
              ));
            c += sprintf(
              "<div class='JS9' id='%s' data-width=%s data-height=%s></div>",
              b,
              w.width(),
              w.height()
            );
            r.isactive
              ? (c += sprintf(
                  "<div style='margin-top: 2px;'><div class='JS9Statusbar' id='%sStatusbar' data-width=%s></div></div>",
                  b,
                  w.width()
                ))
              : z.isactive &&
                (c += sprintf(
                  "<div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar' data-width=%s></div></div>",
                  b,
                  w.width()
                ));
          }
          "auto" === k && C + y * (l + 0.5) > window.innerWidth && (h++, (l = 0));
          var d = sprintf(
            "width=%s,height=%s,top=%s,left=%s,resize=1,scolling=1",
            y,
            A,
            B + (A + u + n) * h,
            C + (y + q + x) * l
          );
          "auto" === k || "horizontal" === k ? l++ : "vertical" === k && h++;
        }
        return { id: b, html: c, winopts: d };
      },
      I = function (f) {
        var h;
        var l = g++;
        f.length > l
          ? (l = "number" === typeof f[l] ? a.images[f[l]] : f[l]) && l.display === b
            ? (l.displayImage("all"),
              void 0 === d
                ? ((d = l.display.id), G(l.display, d, c), !1 === c.firstinplace && g--, I(f))
                : ((e =
                    "string" === typeof c.idbase
                      ? (h = c.idbase + m++)
                      : d.replace(E, "") + "_sep" + a.uniqueID()),
                  (D[e] = l),
                  (l = J(d, e)),
                  h && (l.id = h),
                  "grid" === k
                    ? ($("<div>")
                        .prop("id", l.id + "GridItem")
                        .addClass("JS9GridItem")
                        .append($(l.html))
                        .appendTo(p),
                      a.AddDivs(l.id),
                      D[l.id].moveToDisplay(l.id),
                      I(f))
                    : ($(a.lightOpts[a.LIGHTWIN].topid).arrive(
                        "#" + e,
                        { onceOnly: !0 },
                        function (a) {
                          h = $(a).attr("id");
                          window.setTimeout(function () {
                            D[h].moveToDisplay(h);
                            I(f);
                          }, 0);
                        }
                      ),
                      a.LoadWindow(null, { id: l.id }, "light", l.html, l.winopts))))
            : I(f)
          : a.globalOpts.extendedPlugins &&
            b.image &&
            b.image.xeqPlugins("image", "onseparatedisplay");
      };
    c = c || {};
    if ("string" === typeof c)
      try {
        c = JSON.parse(c);
      } catch (K) {
        a.error("can't parse separate opts: " + c, K);
      }
    I(c.images || a.images);
  };
  a.Display.prototype.nextImage = function (c) {
    var b,
      d = [],
      e = [];
    c = c || 1;
    if (!this.image) return this;
    var f = this.image.pos;
    if (!a.globalOpts.nextImageMask)
      for (b = 0; b < a.images.length; b++) {
        var g = a.images[b];
        g.display === this && g.mask.active && g.mask.im && e.push(g.mask.im);
      }
    for (b = 0; b < a.images.length; b++)
      ((g = a.images[b]),
        g.display === this && ((!a.globalOpts.nextImageMask && 0 <= $.inArray(g, e)) || d.push(g)));
    if (1 >= d.length) return this;
    for (g = 0; g < d.length && this.image !== d[g]; g++);
    for (c = g + c; c >= d.length; ) c -= d.length;
    for (; 0 > c; ) c += d.length;
    g !== c &&
      ((g = d[c]),
      g.displayImage("all"),
      g.refreshLayers(),
      g.display.clearMessage(),
      f && ((f = g.displayToImagePos(f)), (g.valpos = null), (g.valpos = g.updateValpos(f, !0))));
    return this;
  };
  a.Display.prototype.loadSession = function (c, b) {
    var d = this,
      e,
      f,
      g = {},
      h = function (c) {
        var e,
          h = function () {
            var b = w.canvas.getObjects();
            b && "undefined" !== typeof b.length && (c.layers[w.layerName].nshape = b.length + 1);
            a.Fabric.updateChildren(w, null, "objects");
            c.refreshLayers();
          };
        var k = g[c.file] || {};
        k.blend && (c.blend = $.extend(!0, {}, k.blend));
        k.tmp && (c.tmp = $.extend(!0, {}, k.tmp));
        k.wcsim && (c.wcsim = a.lookupImage(k.wcsim));
        if (k.layers && k.layers.length)
          for (e = 0; e < k.layers.length; e++) {
            var l = k.layers[e];
            var m = l.name;
            if (
              !(0 <= $.inArray("regions", c.params.disable) && "regions" === m) &&
              "crosshair" !== m &&
              "grid" !== m
            ) {
              var w = d.newShapeLayer(m, l.dopts);
              c.addShapes(m, []);
              w.canvas.loadFromJSON(l.json, h);
              l.catalog && (c.layers[m].catalog = l.catalog);
              if (l.starbase)
                try {
                  c.layers[m].starbase = JSON.parse(l.starbase);
                } catch (t) {}
            }
          }
        c.tmp && "active" === c.tmp.gridStatus && c.displayCoordGrid(!0);
        a.notNull(f) &&
          (--f,
          0 === f &&
            a.images.sort(function (a, b) {
              var c = 0,
                d = 0;
              g[a.file] && (c = g[a.file].i);
              g[b.file] && (d = g[b.file].i);
              return c - d;
            }));
        k.xeqstash && c.xeqStashCall(k.xeqstash);
        a.globalOpts.extendedPlugins && c.xeqPlugins("image", "onsessionload");
        if ("function" === typeof b.onsessionload)
          try {
            a.xeqByName(b.onsessionload, window, c);
          } catch (t) {
            a.error("in onsessionload callback", t, !1);
          }
      },
      l = function (c) {
        c.file || a.error("session does not contain a filename");
        e = $.extend(!0, {}, c);
        delete e.params.display;
        e.params.crosshair = !1;
        e.params.onload = h;
        c = e.file;
        e.sect &&
          ((e.params.xcen = e.sect.xcen),
          (e.params.ycen = e.sect.ycen),
          (e.params.xdim = e.sect.xdim),
          (e.params.ydim = e.sect.ydim),
          (e.params.zoom = e.sect.zoom),
          delete e.sect);
        window.electron &&
          a.desktopOpts.sessionPath &&
          b.sessionPath &&
          "/" !== e.file.charAt(0) &&
          !e.file.match(a.URLEXP) &&
          (c = a.fixPath(b.sessionPath + e.file, b));
        g[c] = e;
        a.Load(c, e.params, { display: d.id });
      },
      m = function (b) {
        var c, e;
        b.globalOpts && ($.extend(!0, a.globalOpts, b.globalOpts), delete b.globalOpts);
        if (b.cmaps)
          for (c = 0; c < b.cmaps.length; c++) {
            var g = b.cmaps[c];
            if (g.name) {
              var h =
                0 <= $.inArray(g.name, a.globalOpts.topColormaps)
                  ? { toplevel: !0 }
                  : { toplevel: !1 };
              a.AddColormap(g, h);
            }
          }
        if (b.images)
          for (f = b.images.length, c = 0; c < b.images.length; c++)
            ((b.images[c].i = c), l(b.images[c]));
        else l(b);
        if (b.display)
          for (e in b.display)
            if (Object.prototype.hasOwnProperty.call(b.display, e))
              switch (e) {
                case "blendMode":
                  a.BlendDisplay(b.display[e], { display: d });
                  break;
                default:
                  d[e] = b.display[e];
              }
      };
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (k) {
        a.error("can't parse loadSession opts: " + b, k);
      }
    a.waiting(!0, this);
    "object" === typeof c
      ? m(c)
      : $.ajax({
          url: c,
          cache: !1,
          dataType: "json",
          mimeType: "application/json",
          async: !1,
          success: function (a) {
            m(a);
          },
          error: function (b, d, e) {
            a.error("could not load session: " + c, e);
          },
        });
    return this;
  };
  a.Display.prototype.displayMessage = function (a, b, d) {};
  a.Display.prototype.clearMessage = function (a) {};
  a.Display.prototype.createMosaic = function (c, b) {
    var d = this,
      e,
      f,
      g,
      h,
      l = this.image,
      m = function () {
        var b;
        for (b = 0; b < h.length; b++) a.vunlink(h[b]);
      },
      k = function (b, c) {
        var d;
        0 > c.search(/\[struct stat="OK"/) &&
          (a.waiting(!1),
          m(),
          (d = c.match(/msg="(.*)"/)) && d[1]
            ? a.error(d[1] + " (from " + b + ")")
            : a.error(c || "unknown " + b + " failure"));
      },
      q = function (b, c) {
        c = c || {};
        var e = $.extend(!0, {}, c);
        !1 !== c.waiting && a.waiting(!0, d);
        e.display = d.id;
        b = new a.Image(b, e);
        l.setStatus("createMosaic", "complete");
        b.setStatus("createMosaic", "complete");
        a.waiting(!1);
        if (c.onmosaic)
          try {
            a.xeqByName(c.onmosaic, window, b);
          } catch (w) {
            a.error("in create mosaic callback", w, !1);
          }
      },
      u = function (c) {
        for (var d = [], e = 0; e < arguments.length; ++e) d[e - 0] = arguments[e];
        if (b.verbose || 1 < a.DEBUG)
          ((d = sprintf.apply(null, $jscomp.arrayFromIterable(d))), a.log(d));
      };
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (p) {
        a.error("can't parse createMosaic opts: " + b, p);
      }
    b.reduce = b.reduce || a.globalOpts.reduceMosaic;
    b.dim = b.dim || Math.max(a.globalOpts.image.xdim, a.globalOpts.image.ydim);
    if (c)
      if ("string" === typeof c)
        if ("current" === c) c = this.image ? [this.image] : [];
        else if ("all" === c)
          for (c = [], e = 0; e < a.images.length; e++)
            a.images[e].display.id === this.id && c.push(a.images[e]);
        else c = [c];
      else $.isArray(c) || a.error("unknown input type for createMosaic()");
    else c = this.image ? [this.image] : [];
    c.length || a.error("no images specified for createMosaic()");
    for (e = 0; e < c.length; e++)
      ("string" === typeof c[e] &&
        ((f = a.lookupImage(c[e])) ? (c[e] = f) : a.error("unknown image for mosaic: " + c[e])),
        (f = c[e]),
        (f.raw.hdu && f.raw.hdu.fits && f.raw.hdu.fits.vfile) ||
          a.error("no virtual file available for mosaic: " + f.id));
    a.waiting(!0, this);
    l.setStatus("createMosaic", "processing");
    window.setTimeout(function () {
      var d = a.uniqueID();
      var f = function (a) {
        return "mosaic_" + d + "_" + a;
      };
      var l = f("in.lst");
      var w = f("in.tbl");
      var t = f("in.hdr");
      var v = f("bin.lst");
      var r = f("bin.tbl");
      var z = f("out.lst");
      var y = f("out.tbl");
      var A = f("out.hdr");
      f = c[0].id
        .replace(/\[.*\]/, "")
        .replace(/\.fz$/i, "")
        .replace(/\.gz$/i, "")
        .replace(/\.fits$/i, "_mosaic.fits");
      var B = f.replace(/\.fits$/, "_area.fits");
      h = [l, w, t, v, r, z, y, A, B];
      B =
        "|                                                    fname|\n|                                                     char|\n";
      for (e = 0; e < c.length; e++) B += c[e].raw.hdu.fits.vfile + "\n";
      a.vfile(l, B);
      l = a.imgtbl(l, ".", w, "-C");
      k("mImgtbl", l);
      a.vsize(w) || a.error("no image data found with which to construct a mosaic");
      l = a.makehdr(w, t, "");
      k("mMakeHdr", l);
      if ("js9" === b.reduce) {
        B = a.vread(t).split("\n");
        for (e = t = 0; e < B.length; e++)
          switch (((l = B[e].split("=")), l[0].trim())) {
            case "NAXIS1":
              t = Math.max(t, parseFloat(l[1].trim()));
              break;
            case "NAXIS2":
              t = Math.max(t, parseFloat(l[1].trim()));
          }
        g = Math.max(1, Math.floor(t / b.dim + 0.5));
        B =
          "|                                                    fname|\n|                                                     char|\n";
        w = a.vread(w);
        w = w.trim().split("\n");
        w.splice(0, 3);
        for (e = 0; e < w.length; e++)
          if (
            ((l = w[e].trim().split(/\s+/)), (t = l[l.length - 2]), (l = l[l.length - 1]), t && l)
          ) {
            var C = l + "[" + t + "]";
            var D = l
              .split("/")
              .reverse()[0]
              .replace(/\.(g|f)z$/, "");
            t = "bin_" + t + "_" + D;
            h.push(t);
            l = "0@0,0@0," + g;
            u("bin %s [%s]", C, g);
            a.imsection(C, t, l, "");
            B += t + "\n";
          }
        a.vfile(v, B);
        l = a.imgtbl(v, ".", r, "-C");
        k("mImgtbl", l);
        a.vsize(r) || a.error("no image data found to construct a mosaic");
        l = a.makehdr(r, A, "");
        k("mMakeHdr", l);
        w = a.vread(r);
      } else ((l = a.shrinkhdr(b.dim, t, A)), k("mShrinkHdr", l), (w = a.vread(w)));
      w = w.trim().split("\n");
      w.splice(0, 3);
      B =
        "|                                                    fname|\n|                                                     char|\n";
      for (e = 0; e < w.length; e++)
        ((l = w[e].trim().split(/\s+/)),
          (t = l[l.length - 2]),
          (l = l[l.length - 1]),
          t &&
            l &&
            ((v = "-a 1"),
            "shrink" === b.reduce && (v += " -h " + t),
            (v += " " + a.globalOpts.reprojSwitches),
            (D = l
              .split("/")
              .reverse()[0]
              .replace(/\.(g|f)z$/, "")),
            (r = "reproj_" + t + "_" + D),
            (B += r + "\n"),
            h.push(r),
            h.push(r.replace(/\.fits$/i, "_area.fits")),
            u("reproject: %s [%s] -> %s", l, t, r),
            (l = a.reproject(l, r, A, v)),
            k("mProjectPP", l)));
      a.vfile(z, B);
      l = a.imgtbl(z, ".", y, "");
      k("mImgtbl", l);
      a.vsize(y) || a.error("no FITS files were added to output table for mosaic");
      u("create mosaic: %s", f);
      l = a.madd(y, A, f, "");
      k("mAdd", l);
      m();
      z = $.extend(!0, {}, a.fits.options, b);
      z.image = { xdim: 0, ydim: 0 };
      z.file = f;
      a.fits.handleFITSFile(f, z, q);
    }, a.SPINOUT);
    return this;
  };
  a.Display.prototype.moveImageInStack = function (c, b) {
    var d, e, f, g;
    for (e = d = 0; d < a.images.length; d++)
      if (
        (a.images[d].display.id === this.id && (c === e && (f = d), b === e && (g = d), e++),
        a.notNull(f) && a.notNull(g))
      ) {
        a.images.splice(g, 0, a.images.splice(f, 1)[0]);
        break;
      }
  };
  a.Command = function (c) {
    for (var b in c) Object.prototype.hasOwnProperty.call(c, b) && (this[b] = c[b]);
    c.name || a.error("command has no name");
    c.get || c.set || a.error("command requires get and/or set routine");
    a.commands.push(this);
    1 < a.DEBUG && a.log("JS9 command:  %s", this.name);
  };
  a.Command.prototype.getDisplayInfo = function (a) {
    a && a.id && ((this.display = a), (this.image = a.image));
    return this;
  };
  a.Command.prototype.getWhich = function (a) {
    return this.get && !this.set
      ? "get"
      : this.set && !this.get
        ? "set"
        : this.which
          ? this.which(a)
          : 0 === a.length
            ? "get"
            : "set";
  };
  a.Helper = function () {
    "file:" === a.globalOpts.helperProtocol && (a.globalOpts.helperProtocol = "http:");
    (document.domain && "localhost" !== document.domain) ||
      (a.globalOpts.htimeout = a.globalOpts.lhtimeout);
    a.globalOpts.helperProtocol.match(/\/\/$/) || (a.globalOpts.helperProtocol += "//");
    this.helper = this.connected = !1;
    this.type =
      a.allinone && !a.globalOpts.allinoneHelper ? "none" : a.globalOpts.helperType || "sock.io";
    this.pageid = null;
    this.connect();
  };
  a.Helper.prototype.connectinfo = function () {
    if (null === a.helper.connected) return "notConfigured";
    if (a.helper.connected) {
      var c = "connected " + a.helper.type + " " + a.helper.url;
      a.helper.pageid && (c += "<p>" + a.helper.pageid);
      return c;
    }
    return "notConnected " + a.helper.type;
  };
  a.Helper.prototype.connect = function (c) {
    var b = this,
      d = a.globalOpts.ehretries,
      e = a.globalOpts.ehtimeout,
      f = function (c, d) {
        b.connected = !1;
        b.helper = !1;
        b.ready = !0;
        $(document).trigger("JS9:helperReady", { type: "socket.io", status: "error" });
        c = c || "timeout";
        (d && "timeout" !== d) || (d = "or connection refused");
        d === c && (c = "");
        "error" === d && (d = "is the helper running?");
        a.globalOpts.requireHelper
          ? a.error("helper connect error: " + c + " (" + d + ")")
          : a.DEBUG && a.log("JS9 helper connect error: " + c + " (" + d + ")");
      },
      g = function (c) {
        $.ajax({
          url: c,
          dataType: "script",
          timeout: a.globalOpts.htimeout,
          cache: !0,
          success: function () {
            var c = {
              reconnection: !0,
              reconnectionDelay: 1e3,
              reconnectionDelayMax: 1e4,
              reconnectionAttempts: 100,
              timeout: a.globalOpts.htimeout,
            };
            "undefined" === typeof io
              ? f("socket io object is undefined", null)
              : ((b.socket = io.connect(b.url, c)),
                b.socket.on("connect", function () {
                  var c;
                  b.connected = !0;
                  b.helper = !0;
                  var d = [];
                  for (c = 0; c < a.displays.length; c++) d.push(a.displays[c].id);
                  b.socket.emit("initialize", { displays: d, pageid: b.pageid }, function (c) {
                    b.pageid = c.pageid;
                    b.js9helper = c.js9helper;
                    a.globalOpts.dataPathModify = c.dataPathModify;
                    b.ready = !0;
                    $(document).trigger("JS9:helperReady", { type: "socket.io", status: "OK" });
                    a.DEBUG && a.log("JS9 helper: connect: " + b.type);
                  });
                  $(document).trigger("JS9:connected", { type: "socket.io", status: "OK" });
                }),
                b.socket.on("connect_error", function () {
                  b.connected = !1;
                  b.helper = !1;
                  1 < a.DEBUG && a.log("JS9 helper: connect error");
                }),
                b.socket.on("connect_timeout", function () {
                  b.connected = !1;
                  b.helper = !1;
                  1 < a.DEBUG && a.log("JS9 helper: connect timeout");
                }),
                b.socket.on("disconnect", function (c) {
                  b.connected = !1;
                  b.helper = !1;
                  1 < a.DEBUG && a.log("JS9 helper: disconnect: " + c);
                  "io server disconnect" === c &&
                    (1 < a.DEBUG && a.log("JS9 helper: manual reconnect"), b.socket.connect());
                }),
                b.socket.on("reconnect", function () {
                  b.connected = !0;
                  b.helper = !0;
                  1 < a.DEBUG && a.log("JS9 helper: reconnect");
                }),
                b.socket.on("msg", a.msgHandler));
          },
          error: function (a, b, c) {
            f(b, c);
          },
        });
      },
      h = function (a, b, c) {
        $.ajax({
          url: a,
          dataType: "jsonp",
          success: function () {
            g(b);
          },
          error: function () {
            0 < --c
              ? window.setTimeout(function () {
                  h(a, b, c);
                }, e)
              : f();
          },
        });
      };
    c && (this.type = c);
    if (this.socket) {
      try {
        this.socket.disconnect();
      } catch (l) {
        a.log("warning: can't disconnect from socket");
      }
      this.socket = null;
    }
    a.globalOpts.helperURL
      ? 0 <= a.globalOpts.helperURL.search(/:\/\//)
        ? (this.url = a.globalOpts.helperURL)
        : (this.url = a.globalOpts.helperProtocol + a.globalOpts.helperURL)
      : (this.url = document.domain
          ? location.origin
            ? location.origin
            : a.globalOpts.helperProtocol + document.domain
          : a.globalOpts.helperProtocol + "localhost");
    this.baseurl = this.url;
    switch (this.type) {
      case "none":
        this.connected = null;
        this.ready = !0;
        $(document).trigger("JS9:helperReady", { type: "none", status: "OK" });
        break;
      case "get":
      case "post":
        a.globalOpts.helperCGI || a.error("cgi script name missing for helper");
        this.url += "/" + a.globalOpts.helperCGI;
        this.helper = this.connected = !0;
        a.DEBUG && a.log("JS9 helper: connect: " + this.type);
        this.ready = !0;
        $(document).trigger("JS9:helperReady", { type: "get", status: "OK" });
        break;
      case "sock.io":
      case "nodejs":
        a.globalOpts.helperPort || a.error("port missing for helper");
        this.url = this.url.replace(/:[0-9][0-9]*$/, "") + ":" + a.globalOpts.helperPort;
        c = 2 >= a.DEBUG ? "socket.io.min.js" : "socket.io.js";
        this.sockurl = this.url + "/socket.io/" + c;
        window.electron
          ? ((this.aliveurl = this.url + "/alive"), h(this.aliveurl, this.sockurl, d))
          : g(this.sockurl);
        break;
      default:
        a.error("unknown helper type: " + this.type);
    }
  };
  a.Helper.prototype.send = function (c, b, d) {
    var e = this;
    if (!this.connected) return null;
    if (b && "object" === typeof b) {
      try {
        b.cookie = document.cookie;
      } catch (f) {
        delete b.cookie;
      }
      a.globalOpts.dataPath && !b.dataPath && (b.dataPath = a.globalOpts.dataPath + ":.");
    } else b = { dataPath: "." };
    a.TOROOT && (b.dataPath += ":" + a.TOROOT);
    switch (this.type) {
      case "get":
      case "post":
        b.key = c;
        a.helper.pageid && (b.pageid = a.helper.pageid);
        a.DEBUG && a.log("JS9 cgi helper [%s, %s]: %s", this.type, JSON.stringify(b), this.url);
        $.ajax({
          url: this.url,
          type: this.type.toUpperCase(),
          data: b,
          dataType: "text",
          success: function (b) {
            "string" === typeof b && 0 <= b.search(a.analOpts.epattern) && a.log(b);
            d && d(b);
          },
          error: function (b, c, d) {
            a.DEBUG && a.log("JS9 helper: " + e.type + " failure: " + c + " " + d);
          },
        });
        break;
      case "sock.io":
      case "nodejs":
        a.helper.socket.emit(c, b, d);
    }
    return this;
  };
  a.WebWorker = function (c) {
    var b = this,
      d = function () {
        b.worker.onmessage = a.WebWorker.prototype.msgHandler.bind(b);
        b.handlers = [];
      };
    c.match(a.URLEXP)
      ? a.fetchURL(null, c, null, function (a) {
          b.worker = new Worker(URL.createObjectURL(a));
          d();
        })
      : ((this.worker = new Worker(c)), d());
  };
  a.WebWorker.prototype.msgHandler = function (c) {
    var b = a.helper,
      d = c.data;
    switch (d.cmd) {
      case "progress":
        a.progress(d.result.value, d.result.max);
        break;
      case "initsocketio":
        if ("OK" === d.result)
          for (this.sockinit = !0, c = 0; c < this.handlers.length; c++) {
            var e = this.handlers[c];
            if (e.id === d.id) {
              e.func(d.result);
              this.handlers.splice(c, 1);
              break;
            }
          }
        break;
      case "uploadFITS":
        for (c = 0; c < this.handlers.length; c++)
          if (((e = this.handlers[c]), e.id === d.id)) {
            e.func(d.result);
            this.handlers.splice(c, 1);
            break;
          }
        break;
      case "connect_error":
      case "connect_timeout":
        delete a.worker.uploadActive;
        a.progress(!1);
        1 < a.DEBUG && a.log("JS9 worker socketio: " + d.cmd);
        break;
      case "disconnect":
        delete a.worker.uploadActive;
        a.progress(!1);
        d.result = d.result || "JS9 worker socket was disconnected";
        window.setTimeout(function () {
          a.worker.send("initsocketio", [b.url, b.pageid], function () {
            d.alert ? alert(d.result) : 1 < a.DEBUG && a.log(d.result);
          });
        }, a.WORKEROUT);
        break;
      case "error":
        (delete a.worker.uploadActive, a.progress(!1), a.error(d.result || "in web worker"));
    }
  };
  a.WebWorker.prototype.send = function (c, b, d, e) {
    var f = c + a.uniqueID(),
      g = { id: f, cmd: c, args: b };
    d && ((b = b || []), this.handlers.push({ id: f, cmd: c, args: b, func: d }));
    e ? this.worker.postMessage(g, e) : this.worker.postMessage(g);
  };
  a.WebWorker.prototype.socketio = function (c) {
    var b = a.helper;
    a.worker.send("initsocketio", [b.url, b.pageid], function (b) {
      "OK" === b ? c && c() : a.error("can't init socket.io for JS9 worker: " + b);
    });
  };
  a.WebWorker.prototype.terminate = function () {
    this.worker.terminate();
  };
  fabric.major_version = parseFloat(fabric.version.split(".")[0]);
  fabric.minor_version = parseFloat(fabric.version.split(".")[1]);
  fabric.patch_version = parseFloat(fabric.version.split(".")[2]);
  a.Fabric = {};
  a.Fabric.elements =
    "cornerSize cornerColor cornerStyle borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint lockMovementX lockMovementY lockRotation lockScalingX lockScalingY lockUniScaling selectable hasBorders params pub".split(
      " "
    );
  a.Fabric.opts = {
    originX: "center",
    originY: "center",
    strokeWidth: 2,
    selectionLineWidth: 2,
    borderColor: "#00EEFF",
    cornerColor: "#00EEFF",
    cornerSize: fabric.isTouchSupported ? 10 : 6,
    cornerStyle: "circle",
    hasControls: !0,
    hasRotatingPoint: !0,
    hasBorders: !0,
    transparentCorners: !1,
    centeredScaling: !0,
    strokeUniform: !0,
    selectable: !0,
    padding: 0,
    canvas: { selection: !0 },
    fill: "transparent",
    objectCaching: !1,
  };
  a.Fabric.rescaleStrokeWidth = function (a, b) {
    var c = (this.scaleX + this.scaleY) / 2;
    4 <= fabric.major_version ||
      (3 === fabric.major_version && 6 === fabric.minor_version && 3 <= fabric.patch_version) ||
      (2 <= fabric.major_version &&
        this.params &&
        "annulus" !== this.params.shape &&
        "cross" !== this.params.shape) ||
      ((a = a || 1),
      (a *= c),
      !b && this.params && (b = this.params.sw1),
      b &&
        ("group" === this.type
          ? this.forEachObject(function (c) {
              c.rescaleBorder(a, b);
            })
          : this.set("strokeWidth", b / a)));
  };
  a.Fabric.rescaleEvenly = function () {
    if (this.params && this.scaleX !== this.scaleY)
      switch (this.params.shape) {
        case "annulus":
        case "circle":
          var a = this.params.lastscale || 1;
          this.scaleX !== a
            ? (this.scaleY = this.scaleX)
            : this.scaleY !== a && (this.scaleX = this.scaleY);
          this.params.lastscale = this.scaleX;
      }
  };
  fabric.Object.prototype.rescaleBorder = a.Fabric.rescaleStrokeWidth;
  fabric.Object.prototype.rescaleEvenly = a.Fabric.rescaleEvenly;
  a.Fabric.newShapeLayer = function (c, b, d) {
    var e = this,
      f = function (a, b) {
        var d = k.display.image;
        var e = k.canvas.getActiveObject();
        var f = {};
        if (d)
          if (a.params) ("activeSelection" === e.type && (f.group = e), d._updateShape(c, a, f, b));
          else if ("activeSelection" === a.type || ("group" === a.type && !a.params)) {
            var g = a.getObjects();
            for (e = 0; e < g.length; e++) {
              var h = g[e];
              h.params && ((f.group = a), d._updateShape(c, h, f, b));
            }
          }
      },
      g = function (a) {
        e.image && k.display.image._updateMultiDialogs(a);
      },
      h = function (b, c) {
        b.params.sel = null;
        b.display.image && (b.display.image.layer = null);
        if (c) {
          switch (c.type) {
            case "polyline":
            case "polygon":
              a.Fabric.removePolygonAnchors(b, c);
          }
          f(c, "unselect");
          g(-1);
        }
      },
      l = function (b, d) {
        b.params.sel && d.params && b.params.sel !== d && h(b, b.params.sel);
        b.display.image && (b.display.image.layer = c);
        if (d) {
          switch (d.type) {
            case "polyline":
            case "polygon":
              (a.Fabric.addPolygonAnchors(b, d), b.canvas.renderAll());
          }
          d.polyparams ? (b.params.sel = d.polyparams.polygon) : d.params && (b.params.sel = d);
          f(d, "select");
          g(1);
        }
      },
      m = function (b, c, d) {
        b.params.sel && b.params.sel !== c && h(b, b.params.sel);
        var e = b.canvas.getActiveObjects();
        for (d = 0; d < e.length; d++) {
          var k = e[d];
          if (k.params && k.params.parent && k.params.parent.obj) {
            var l = k.params.parent.obj;
            0 > $.inArray(l, e) && c.addWithUpdate(l);
          }
          if (k.params && k.params.children)
            for (l = 0; l < k.params.children.length; l++) {
              var m = k.params.children[l].obj;
              0 > $.inArray(m, e) && c.addWithUpdate(m);
            }
          switch (k.type) {
            case "polyline":
            case "polygon":
              k.params && a.Fabric.removePolygonAnchors(b, k);
          }
          f(k, "select");
        }
        b.canvas.renderAll();
        g(1);
      };
    if (e && c) {
      if (e.layers[c]) return e.layers[c];
      e.layers[c] = {};
      var k = e.layers[c];
      k.layerName = c;
      k.params = [];
      k.params.sel = null;
      k.params.sellayer = null;
      d ? (k.dtype = "other") : ((k.dtype = "main"), (d = e.divjq));
      var q = d.attr("id") + "-" + c.replace(/\s+/, "_") + "-shapeLayer";
      k.display = e;
      k.opts = $.extend(!0, {}, b);
      k.opts.canvas = k.opts.canvas || {};
      void 0 === k.opts.canvas.selection && (k.opts.canvas.selection = !0);
      k.el = a.Fabric.elements;
      k.divjq = $("<div>").addClass("JS9Container").css("z-index", 0).appendTo(d);
      k.canvasjq = $("<canvas>")
        .addClass("JS9Layer")
        .attr("id", q)
        .attr("width", d.css("width"))
        .attr("height", d.css("height"))
        .appendTo(k.divjq);
      a.bugs.webkit_resize &&
        "main" === k.dtype &&
        k.canvasjq.attr("width", e.width).attr("height", e.height);
      k.canvas = new fabric.Canvas(k.canvasjq[0]);
      k.canvas.renderOnAddRemove = !1;
      k.canvas.preserveObjectStacking = !0;
      k.opts.movable
        ? ((k.opts.lockMovementX = !1),
          (k.opts.lockMovementY = !1),
          (k.opts.selectable = !0),
          (k.opts.evented = !0))
        : !1 === k.opts.movable &&
          ((k.opts.lockMovementX = !0),
          (k.opts.lockMovementY = !0),
          (k.opts.selectable = !1),
          (k.opts.evented = !1));
      void 0 === k.opts.changeable &&
        void 0 !== k.opts.fixinplace &&
        (k.opts.changeable = !k.opts.fixinplace);
      void 0 === k.opts.changeable &&
        void 0 !== k.opts.locked &&
        (k.opts.changeable = !k.opts.locked);
      k.opts.changeable
        ? ((k.opts.hasControls = !0),
          (k.opts.hasRotatingPoint = !0),
          (k.opts.hasBorders = !0),
          (k.opts.lockMovementX = !1),
          (k.opts.lockMovementY = !1),
          (k.opts.lockRotation = !1),
          (k.opts.lockScalingX = !1),
          (k.opts.lockScalingY = !1),
          (k.opts.lockUniScaling = !1),
          (k.opts.selectable = !0),
          (k.opts.evented = !0),
          (k.opts.usekeyboard = !0))
        : !1 === k.opts.changeable &&
          ((k.opts.hasControls = !1),
          (k.opts.hasRotatingPoint = !1),
          (k.opts.hasBorders = !1),
          (k.opts.lockMovementX = !0),
          (k.opts.lockMovementY = !0),
          (k.opts.lockRotation = !0),
          (k.opts.lockScalingX = !0),
          (k.opts.lockScalingY = !0),
          (k.opts.lockUniScaling = !0),
          (k.opts.selectable = !1),
          (k.opts.evented = !1),
          (k.opts.usekeyboard = !1));
      k.opts.selectable && (k.opts.canvas.selection = !0);
      if (
        k.opts.onmousedown ||
        k.opts.onmouseup ||
        k.opts.onmousemove ||
        k.opts.tooltip ||
        k.opts.onmouseover ||
        k.opts.onmouseout
      ) {
        k.opts.evented = !0;
        if (k.opts.onmousedown)
          k.canvas.on("mouse:down", function (b) {
            if (k.display.image && b.target) {
              var d = b.target,
                e = d.params;
              if (!e || (e && !1 !== e.changeable))
                ("main" === k.dtype &&
                  ((k.display.image.clickInRegion = !0), (k.display.image.clickInLayer = c)),
                  k.opts.onmousedown.call(k.canvas, k.display.image, d.pub, b.e, d));
            } else if ((k.canvas._selection = k.canvas.selection))
              k.canvas.selection = a.specialKey(b.e);
          });
        else
          k.canvas.on("mouse:down", function (b) {
            if ((k.canvas._selection = k.canvas.selection)) k.canvas.selection = a.specialKey(b.e);
          });
        if (k.opts.onmouseup)
          k.canvas.on("mouse:up", function (a) {
            k.display.image &&
              a.target &&
              k.opts.onmouseup.call(k.canvas, k.display.image, a.target.pub, a.e, a.target);
            k.canvas.selection = k.canvas._selection || k.canvas.selection;
          });
        else
          k.canvas.on("mouse:up", function () {
            k.canvas.selection = k.canvas._selection || k.canvas.selection;
          });
        if (k.opts.onmousemove)
          k.canvas.on("mouse:move", function (a) {
            k.display.image &&
              a.target &&
              k.opts.onmousemove.call(k.canvas, k.display.image, a.target.pub, a.e, a.target);
          });
        if (k.opts.onmouseover)
          k.canvas.on("mouse:over", function (a) {
            k.display.image &&
              a.target &&
              k.opts.onmouseover.call(k.canvas, k.display.image, a.target.pub, a.e, a.target);
          });
        if (k.opts.onmouseout)
          k.canvas.on("mouse:out", function (a) {
            k.display.image &&
              a.target &&
              k.opts.onmouseout.call(k.canvas, k.display.image, a.target.pub, a.e, a.target);
          });
        if (k.opts.onmousedblclick)
          k.canvas.on("mouse:dblclick", function (a) {
            k.display.image &&
              a.target &&
              k.opts.onmousedblclick.call(k.canvas, k.display.image, a.target.pub, a.e, a.target);
          });
        k.opts.tooltip &&
          (k.canvas.on("mouse:over", function (b) {
            k.display.image &&
              b.target &&
              a.tooltip(
                b.target.left + b.target.width + 2,
                b.target.top + b.target.height + 2,
                k.opts.tooltip,
                k.display.image,
                b.target.pub,
                b.e,
                b.target
              );
          }),
          k.canvas.on("mouse:out", function (b) {
            k.display.image &&
              b.target &&
              a.tooltip(
                b.target.left,
                b.target.top,
                null,
                k.display.image,
                b.target.pub,
                b.e,
                b.target
              );
          }));
      } else
        (k.canvas.on("mouse:down", function (b) {
          if ((k.canvas._selection = k.canvas.selection)) k.canvas.selection = a.specialKey(b.e);
        }),
          k.canvas.on("mouse:up", function () {
            k.canvas.selection = k.canvas._selection || k.canvas.selection;
          }));
      "function" === typeof k.opts.ongroupcreate &&
        ((k.opts.canvas.selection = !0),
        (k.opts.selectable = !0),
        k.canvas.on("selection:created", function (a) {
          var b = [],
            c = [];
          k.display.image &&
            a.target &&
            "group" === a.target.type &&
            (a.target.forEachObject(function (a) {
              a.pub && (c.push(a), b.push(a.pub));
            }),
            k.opts.ongroupcreate.call(k.canvas, k.display.image, b, a.e, c));
        }));
      k.canvas.on("object:modified", function (b) {
        var c = [];
        if (b.target) {
          var d = b.target;
          a.Fabric.updateChildren(k, d, "deltas");
          if (
            k.opts.sortOverlapping &&
            (d.setCoords(),
            k.canvas.forEachObject(function (a) {
              a !== d &&
                d.intersectsWithObject(a) &&
                ((e = a.getScaledWidth()),
                (f = a.getScaledHeight()),
                c.push({ obj: a, siz: e * f }));
            }),
            c.length)
          ) {
            var e = d.getScaledWidth();
            var f = d.getScaledHeight();
            c.push({ obj: d, siz: e * f });
            c.sort(function (a, b) {
              return a.siz < b.siz ? -1 : a.siz > b.siz ? 1 : 0;
            });
            var g = c.length;
            for (b = 0; b < g; b++)
              try {
                c[b].obj.sendToBack();
              } catch (v) {}
          }
        }
      });
      k.canvas.on("object:scaling", function (b) {
        b.target &&
          ((b = b.target),
          b.rescaleEvenly(),
          b.rescaleBorder(),
          a.Fabric.updateChildren(k, b, "scaling"));
      });
      k.canvas.on("object:moving", function (b) {
        b.target && a.Fabric.updateChildren(k, b.target, "moving");
      });
      k.canvas.on("object:rotating", function (b) {
        b.target && a.Fabric.updateChildren(k, b.target, "rotating");
      });
      k.canvas.on("selection:created", function (b) {
        if (b.target && !a.globalOpts.skipSelectionProcessing) {
          var c = b.target;
          "activeSelection" === c.type || ("group" === c.type && !c.params) ? m(k, c, b) : l(k, c);
        }
      });
      k.canvas.on("selection:updated", function (b) {
        if (b.target && !a.globalOpts.skipSelectionProcessing) {
          var c = b.target;
          "activeSelection" === c.type || ("group" === c.type && !c.params) ? m(k, c, b) : l(k, c);
        }
      });
      k.canvas.on("before:selection:cleared", function (b) {
        if (b.target && !a.globalOpts.skipSelectionProcessing)
          if (((b = b.target), "activeSelection" === b.type || ("group" === b.type && !b.params))) {
            b = k;
            var c;
            var d = b.canvas.getActiveObjects();
            for (c = 0; c < d.length; c++) {
              var e = d[c];
              h(b, e);
            }
            g(-1);
          } else h(k, b);
      });
      if (k.divjq.closest(a.lightOpts[a.LIGHTWIN].drag).length)
        if (fabric.isTouchSupported)
          k.divjq.on("touchstart", function () {
            k.canvas.calcOffset();
          });
        else
          k.divjq.on("mouseenter", function () {
            k.canvas.calcOffset();
          });
      return k;
    }
  };
  a.Fabric.showShapeLayer = function (c, b, d) {
    var e = this,
      f,
      g;
    var h = 0;
    if ((g = this.getShapeLayer(c))) {
      d = d || {};
      if ("string" === typeof d)
        try {
          d = JSON.parse(d);
        } catch (k) {
          a.error("can't parse showShapeLayer opts: " + d, k);
        }
      var l = g.canvas;
      var m = this.display.layers[c];
      if (a.isNull(b)) return g.show;
      if (!0 === b || "true" === b) {
        if (!d.local && ((g.show = !0), this !== this.display.image)) return;
        g.show && (l.selection = g.opts.canvas.selection);
        g.json &&
          g.show &&
          l.loadFromJSON(g.json, function () {
            var b, d;
            a.Fabric.updateChildren(g.dlayer, null, "objects");
            e.resize &&
              (l.getObjects().forEach(function (a) {
                a.left += e.resize.left;
                a.top += e.resize.top;
                a.setCoords();
              }),
              l.calcOffset());
            g.zindex = Math.abs(g.zindex);
            m.divjq.css("z-index", g.zindex);
            for (b in e.layers)
              if (
                Object.prototype.hasOwnProperty.call(e.layers, b) &&
                c !== b &&
                e.layers[b].show
              ) {
                var f = e.display.layers[b];
                f.divjq.css("z-index") < g.zindex &&
                  (d = f.canvas.getActiveObject()) &&
                  (a.Fabric.removePolygonAnchors(f, d),
                  f.canvas.getActiveObject() && f.canvas.discardActiveObject());
              }
            e.restoreSelection(c);
          });
        for (f in this.layers)
          Object.prototype.hasOwnProperty.call(this.layers, f) && this.layers[f].json && h++;
        h || (this.resize = null);
        this.xeqPlugins("shape", "onshapelayershow", c);
      } else {
        if (!d.local && this !== this.display.image) {
          g.show = !1;
          return;
        }
        if (g.show) {
          b = l.getObjects();
          for (f = b.length; f--; )
            ((h = b[f]),
              h.params &&
                (h.params.winid && (h.params.winid.close(), (h.params.winid = null)),
                h.params.anchors && a.Fabric.removePolygonAnchors(g.dlayer, h)));
          b = l.toJSON(g.dlayer.el);
          g.json = JSON.stringify(b);
          this.saveSelection(c);
          l.selection = !1;
          m && ((g.zindex = -Math.abs(g.zindex)), m.divjq.css("z-index", g.zindex));
          l.clear();
        }
        d.local || (g.show = !1);
        this.xeqPlugins("shape", "onshapelayerhide", c);
      }
      return this;
    }
  };
  a.Fabric.displayShapeLayers = function () {
    var a;
    if (this !== this.display.image) {
      if (this.display.image && this.display.image.layers)
        for (a in this.display.image.layers)
          Object.prototype.hasOwnProperty.call(this.display.image.layers, a) &&
            this.display.image.showShapeLayer(a, !1, { local: !0 });
      if (this.layers)
        for (a in this.layers)
          Object.prototype.hasOwnProperty.call(this.layers, a) &&
            this.showShapeLayer(a, !0, { local: !0 });
    }
  };
  a.Fabric.toggleShapeLayers = function () {
    var a, b;
    if (this.toggleLayers) {
      for (a in this.layers)
        Object.prototype.hasOwnProperty.call(this.layers, a) &&
          (b = this.layers[a]) &&
          this.toggleLayers[a] &&
          this.showShapeLayer(a, !0);
      delete this.toggleLayers;
    } else
      for (a in ((this.toggleLayers = {}), this.layers))
        Object.prototype.hasOwnProperty.call(this.layers, a) &&
          "crosshair" !== a &&
          (b = this.layers[a]) &&
          b.show &&
          "main" === b.dlayer.dtype &&
          ((this.toggleLayers[a] = !0), this.showShapeLayer(a, !1));
  };
  a.Fabric.getShapeLayer = function (a, b) {
    if (!a) return null;
    var c = this.layers[a];
    if (!c) {
      b = this.display.layers[a];
      if (!b) return null;
      this.layers[a] = {};
      c = this.layers[a];
      c.show = !0;
      c.nshape = 0;
      c.dlayer = b;
      c.opts = c.dlayer.opts;
      c.canvas = c.dlayer.canvas;
      c.canvas.calcOffset();
    }
    return c;
  };
  a.Fabric.activeShapeLayer = function (a) {
    var b, c;
    if (a)
      if ($.isArray(a)) {
        var e = 0;
        for (b = this.zlayer - 1; e < a.length; e++) {
          var f = this.layers[a[e]];
          "main" === f.dlayer.dtype &&
            ((f.zindex = b--),
            f.show ? c || (c = a[e]) : (f.zindex = -f.zindex),
            f.dlayer.divjq.css("z-index", f.zindex));
        }
        a = c;
      } else {
        if ((f = this.layers[a]) && f.show) {
          c = f.zindex;
          f.zindex = this.zlayer - 1;
          f.dlayer.divjq.css("z-index", f.zindex);
          for (e in this.layers)
            Object.prototype.hasOwnProperty.call(this.layers, e) &&
              ((b = this.layers[e]),
              b !== f &&
                b.zindex === f.zindex &&
                "main" === b.dlayer.dtype &&
                ((b.zindex = c), b.dlayer.divjq.css("z-index", b.zindex)));
          this.xeqPlugins("shape", "onshapelayeractive", a);
        }
        a = this;
      }
    else {
      for (e in this.layers)
        Object.prototype.hasOwnProperty.call(this.layers, e) &&
          ((b = this.layers[e]),
          "main" === b.dlayer.dtype && (void 0 === f || b.zindex > f) && ((f = b.zindex), (c = e)));
      a = c;
    }
    return a;
  };
  a.Fabric._parseShapeOptions = function (c, b, d) {
    var e,
      f = {},
      g = {};
    if (b.remove) return { remove: b.remove };
    var h = b.parent || (d && d.params && d.params.parent);
    delete b.parent;
    b.restoreid || delete b.id;
    delete b.restoreid;
    g.tags = [];
    if (b.tags)
      if ("string" === typeof b.tags) {
        var l = b.tags.toLowerCase().split(",");
        for (e = 0; e < l.length; e++) g.tags[e] = l[e].trim();
      } else if ($.isArray(b.tags))
        for (e = 0; e < b.tags.length; e++) g.tags[e] = b.tags[e].trim();
    if (a.notNull(b.angle)) {
      if (!h)
        switch (b.shape) {
          case "box":
          case "cross":
          case "ellipse":
          case "text":
            if (this.raw.wcsinfo) this.raw.wcsinfo.crot && (b.angle += this.raw.wcsinfo.crot);
            else if (a.notNull(this.raw.header.LTM1_1) || a.notNull(this.raw.header.LTM1_2)) {
              try {
                var m = Math.atan((this.raw.header.LTM1_2 || 0) / (this.raw.header.LTM1_1 || 0));
              } catch (w) {
                m = 0;
              }
              m && ((m = (180 * -m) / Math.PI), (b.angle += m));
            }
            a.notNull(this.params.transformAngle) && (b.angle += this.params.transformAngle);
            a.notNull(this.params.transformScale) && (b.angle *= this.params.transformScale);
        }
      f.angle = -b.angle;
    }
    void 0 !== b.dx && void 0 !== b.dy && ((f.left = b.dx), (f.top = b.dy));
    void 0 !== b.x &&
      void 0 !== b.y &&
      ((m = this.imageToDisplayPos(b)), (f.left = m.x), (f.top = m.y));
    void 0 !== b.px &&
      void 0 !== b.py &&
      ((m = this.logicalToDisplayPos({ x: b.px, y: b.py })), (f.left = m.x), (f.top = m.y));
    "string" === typeof b.wcs &&
      ((m = b.wcs.trim().split(/ +/)),
      (b.ra = m[0]),
      (b.dec = m[1]),
      3 <= m.length && (b.wcssys = m[2]));
    if (this.validWCS() && a.notNull(b.ra) && a.notNull(b.dec)) {
      if (b.wcssys) {
        var k = this.getWCSSys();
        var q = a.globalOpts.xeqPlugins;
        a.globalOpts.xeqPlugins = !1;
        this.setWCSSys(b.wcssys, !1);
      } else
        b._wcssys &&
          ((k = this.getWCSSys()),
          (q = a.globalOpts.xeqPlugins),
          (a.globalOpts.xeqPlugins = !1),
          this.setWCSSys(b._wcssys, !1),
          delete b._wcssys);
      "string" === typeof b.ra &&
        ((b.ra = a.saostrtod(b.ra)), a.isHMS(this.params.wcssys) && (b.ra *= 15));
      "string" === typeof b.dec && (b.dec = a.saostrtod(b.dec));
      m = a.wcs2pix(this.raw.wcs, b.ra, b.dec).trim().split(/ +/);
      k && (this.setWCSSys(k, !1), (a.globalOpts.xeqPlugins = q));
      m = this.imageToDisplayPos({ x: parseFloat(m[0]), y: parseFloat(m[1]) });
      f.left = m.x;
      f.top = m.y;
    }
    void 0 !== b.left && (f.left = b.left);
    void 0 !== b.top && (f.top = b.top);
    void 0 === f.left &&
      !0 !== b.noLeftTop &&
      (f.left = d && void 0 !== d.left ? d.left : this.display.canvasjq.attr("width") / 2 - 1);
    void 0 === f.top &&
      !0 !== b.noLeftTop &&
      (f.top = d && void 0 !== d.top ? d.top : this.display.canvasjq.attr("height") / 2 - 1 + 1);
    b.deltax && (f.left += b.deltax);
    b.deltay && (f.top -= b.deltay);
    c = "main" !== this.display.layers[c].dtype || b.preservedcoords ? 1 : this.rgb.sect.zoom;
    if ("" === b.strokeDashes || "" === b.strokeDashArray) b.strokeDashArray = [];
    "" === b.strokeWidth && (b.strokeWidth = a.Fabric.opts.strokeWidth);
    switch (b.shape) {
      case "annulus":
        g.radii = [];
        if (void 0 !== b.radii)
          if ("string" === typeof b.radii)
            for (g.radii = b.radii.replace(/ /g, "").split(","), q = e = 0; e < g.radii.length; e++)
              "" !== g.radii[e] &&
                (b.sizeScale && (g.radii[e] *= b.sizeScale),
                (g.radii[q++] = this.wcs2imlen(g.radii[e])));
          else {
            if (((g.radii = b.radii), b.sizeScale))
              for (e = 0; e < g.radii.length; e++) g.radii[e] *= b.sizeScale;
          }
        else
          for (
            b.ireg &&
              a.SCALEIREG &&
              (a.notNull(b.iradius) && (b.iradius /= c), a.notNull(b.oradius) && (b.oradius /= c)),
              b.sizeScale &&
                (a.notNull(b.iradius) && (b.iradius *= b.sizeScale),
                a.notNull(b.oradius) && (b.oradius *= b.sizeScale)),
              c = (b.oradius - b.iradius) / b.nannuli,
              k = b.nannuli + 1,
              e = 0;
            e < k;
            e++
          )
            ((q = b.iradius + c * e), b.sizeScale && (q *= b.sizeScale), g.radii.push(q));
        break;
      case "box":
      case "cross":
        b.ireg &&
          a.SCALEIREG &&
          (a.notNull(b.width) && (b.width /= c), a.notNull(b.height) && (b.height /= c));
        b.sizeScale &&
          (a.notNull(b.width) && (b.width *= b.sizeScale),
          a.notNull(b.height) && (b.height *= b.sizeScale));
        break;
      case "circle":
        b.ireg && a.SCALEIREG && a.notNull(b.radius) && (b.radius /= c);
        b.sizeScale && a.notNull(b.radius) && (b.radius *= b.sizeScale);
        break;
      case "ellipse":
        b.ireg && a.SCALEIREG && (a.notNull(b.r1) && (b.r1 /= c), a.notNull(b.r2) && (b.r2 /= c));
        b.sizeScale &&
          (a.notNull(b.r1) && (b.r1 *= b.sizeScale), a.notNull(b.r2) && (b.r2 *= b.sizeScale));
        break;
      case "point":
        switch (b.ptshape) {
          case "box":
            b.width = 2 * b.ptsize;
            b.height = 2 * b.ptsize;
            break;
          case "circle":
            b.radius = b.ptsize;
            break;
          case "ellipse":
            ((b.rx = b.ptsize), (b.ry = b.ptsize / 2));
        }
        b.lockRotation = !0;
        b.lockScalingX = !0;
        b.lockScalingY = !0;
        b.lockUniScaling = !0;
        b.hasControls = !1;
        b.hasRotatingPoint = !1;
        b.hasBorders = !0;
        break;
      case "line":
      case "polygon":
        if (a.notNull(b.wcspts) && this.validWCS()) {
          b.pts = [];
          b.wcssys &&
            ((k = this.getWCSSys()),
            (q = a.globalOpts.xeqPlugins),
            (a.globalOpts.xeqPlugins = !1),
            this.setWCSSys(b.wcssys, !1));
          for (e = 0; e < b.wcspts.length; e++)
            ((m = a.wcs2pix(this.raw.wcs, b.wcspts[e].ra, b.wcspts[e].dec).trim().split(/ +/)),
              b.pts.push({ x: parseFloat(m[0]), y: parseFloat(m[1]) }));
          k && (this.setWCSSys(k, !1), (a.globalOpts.xeqPlugins = q));
        }
        if (b.pts && b.pts.length) {
          if ("string" === typeof b.pts) {
            m = b.pts.replace(/ /g, "").split(",");
            k = m.length;
            if ("string" === typeof m[0]) for (e = 0; e < k; e++) m[e] = parseFloat(m[e]);
            b.pts = [];
            for (q = e = 0; e < k; e += 2, q++) b.pts[q] = { x: m[e], y: m[e + 1] };
          }
          k = b.pts.length;
          for (e = 0; e < k; e++)
            ((q = b.pts[e]),
              a.notNull(q.x) && a.notNull(q.y)
                ? (b.pts[e] = this.imageToDisplayPos(b.pts[e]))
                : a.notNull(q.dx) &&
                  a.notNull(q.dy) &&
                  ((b.pts[e].x = q.dx),
                  delete b.pts[e].dx,
                  (b.pts[e].y = q.dy),
                  delete b.pts[e].dy));
          b.left && b.top
            ? (q = { x: b.left, y: b.top })
            : b.dx && b.dy
              ? (q = { x: b.dx, y: b.dy })
              : ((q = a.centerPolygon(b.pts)), (f.left = q.x), (f.top = q.y));
          b.points = [];
          for (e = 0; e < k; e++)
            ((m = { x: (b.pts[e].x - q.x) / c, y: (b.pts[e].y - q.y) / c }), b.points.push(m));
        } else
          (d && d.points && d.points.length) ||
            ("polygon" === b.shape && b.polypoints
              ? (b.points = b.points || b.polypoints)
              : "line" === b.shape && b.linepoints && (b.points = b.points || b.linepoints));
        if (b.ireg && a.SCALEIREG)
          for (k = b.points.length, e = 0; e < k; e++) ((b.points[e].x /= c), (b.points[e].y /= c));
    }
    for (n in b)
      if (Object.prototype.hasOwnProperty.call(b, n))
        switch (n) {
          case "tags":
          case "x":
          case "y":
          case "px":
          case "py":
          case "deltax":
          case "deltay":
          case "ra":
          case "dec":
          case "pts":
          case "left":
          case "top":
          case "angle":
          case "radii":
          case "ireg":
            break;
          case "type":
          case "originX":
          case "originY":
          case "width":
          case "height":
          case "scaleX":
          case "scaleY":
          case "flipX":
          case "flipY":
          case "opacity":
          case "cornerSize":
          case "transparentCorners":
          case "hoverCursor":
          case "padding":
          case "borderColor":
          case "cornerColor":
          case "centeredScaling":
          case "centeredRotation":
          case "fill":
          case "fillRule":
          case "backgroundColor":
          case "stroke":
          case "strokeWidth":
          case "strokeDashArray":
          case "strokeLineCap":
          case "strokeLineJoin":
          case "strokeMiterLimit":
          case "shadow":
          case "borderOpacityWhenMoving":
          case "borderScaleFactor":
          case "borderDashArray":
          case "transformMatrix":
          case "minScaleLimit":
          case "selectable":
          case "evented":
          case "visible":
          case "hasControls":
          case "hasBorders":
          case "hasRotatingPoint":
          case "rotatingPointOffset":
          case "perPixelTargetFind":
          case "includeDefaultValues":
          case "clipTo":
          case "lockMovementX":
          case "lockMovementY":
          case "lockRotation":
          case "lockScalingX":
          case "lockScalingY":
          case "lockUniScaling":
          case "send":
          case "radius":
          case "rx":
          case "ry":
          case "points":
          case "selectionLineWidth":
          case "fontFamily":
          case "fontSize":
          case "fontStyle":
          case "fontWeight":
          case "text":
          case "textDecoration":
          case "textAlign":
          case "lineHeight":
          case "textBackgroundColor":
          case "textOpts":
          case "groupid":
            f[n] = b[n];
            break;
          case "shape":
            var u = b[n];
            break;
          default:
            g[n] = b[n];
        }
    if (!(b = g.color || f.stroke)) {
      b = g.tags;
      e = g.tagcolors;
      var p;
      e = e || {};
      for (p in e)
        if (Object.prototype.hasOwnProperty.call(e, p)) {
          var n = p.split("_");
          if (0 === $(b).not(n).length && 0 === $(n).not(b).length) {
            var x = e[p];
            break;
          }
        }
      if (!x)
        for (p in e)
          if (
            Object.prototype.hasOwnProperty.call(e, p) &&
            ((n = p.split("_")), 0 === $(b).not(n).length)
          ) {
            x = e[p];
            break;
          }
      if (!x)
        for (p in e)
          if (
            Object.prototype.hasOwnProperty.call(e, p) &&
            ((n = p.split("_")), 0 === $(n).not(b).length)
          ) {
            x = e[p];
            break;
          }
      b = x = x || (d && d.get("stroke")) || e.defcolor || a.globalOpts.defcolor || "#000000";
    }
    f.stroke = b;
    f.selectColor = f.stroke;
    if (!0 === a.globalOpts.controlsMatchRegion || "corner" === a.globalOpts.controlsMatchRegion)
      f.cornerColor = f.stroke;
    if (!0 === a.globalOpts.controlsMatchRegion || "border" === a.globalOpts.controlsMatchRegion)
      f.borderColor = f.stroke;
    void 0 === g.changeable && void 0 !== g.fixinplace && (g.changeable = !g.fixinplace);
    void 0 === g.changeable && void 0 !== g.locked && (g.changeable = !g.locked);
    if (void 0 !== g.changeable || void 0 !== g.editing)
      ((d = void 0 !== g.editing ? g.editing : !g.changeable),
        (f.lockMovementX = d),
        (f.lockMovementY = d),
        (f.lockRotation = d),
        (f.lockScalingX = d),
        (f.lockScalingY = d),
        (f.hasControls = !d),
        (f.hasRotatingPoint = !d),
        (f.hasBorders = !d));
    void 0 !== g.movable && ((d = !g.movable), (f.lockMovementX = d), (f.lockMovementY = d));
    void 0 !== g.resizable && ((d = g.resizable), (f.hasControls = d), (f.hasBorders = d));
    void 0 !== g.rotatable &&
      ((d = !g.rotatable),
      void 0 === f.lockRotation && ((f.lockRotation = d), (f.hasRotatingPoint = !d)));
    void 0 !== g.editing && (f.visible = !g.editing);
    return { shape: u, opts: f, params: g };
  };
  a.Fabric._exportShapeOptions = function (a) {
    return "object" !== typeof a
      ? []
      : Object.keys(a).filter(function (b) {
          switch (b) {
            case "top":
            case "left":
            case "width":
            case "height":
            case "radii":
            case "radius":
            case "rx":
            case "ry":
            case "angle":
            case "panzoom":
            case "iradius":
            case "oradius":
            case "nannuli":
            case "aradius1":
            case "aradius2":
            case "configURL":
            case "sortOverlapping":
            case "tagcolors":
            case "pts":
            case "ptshape":
            case "ptsize":
            case "linepoints":
            case "polypoints":
            case "responseType":
            case "display":
            case "tags":
            case "r1":
            case "r2":
            case "x":
            case "y":
            case "dx":
            case "dy":
            case "px":
            case "py":
            case "ra":
            case "dec":
            case "shape":
            case "parent":
            case "rtn":
            case "_wcssys":
            case "file":
            case "savefile":
            case "savewhich":
            case "saveformat":
            case "saveselection":
            case "savewcs":
            case "send":
            case "listonchange":
            case "multitext":
              return !1;
            case "text":
              return "text" === a.shape ? !1 : !0;
            case "editing":
              return a.editing;
            default:
              return !0;
          }
        });
  };
  a.Fabric._handleChildText = function (c, b, d) {
    if ("regions" === c)
      if (
        ((d = d || {}),
        "text" !== b.params.shape && d.text && (!b.params.children || !b.params.children.length))
      ) {
        var e = (b.height * b.scaleX) / 2 - 12;
        e =
          1e-6 > Math.abs(b.angle)
            ? { x: b.left, y: b.top - e }
            : a.rotatePoint({ x: b.left, y: b.top - e }, b.angle, { x: b.left, y: b.top });
        var f = this.displayToImagePos(e);
        e = {
          x: f.x,
          y: f.y,
          angle: -b.angle,
          color: b.stroke,
          text: d.text,
          tags: b.params.tags,
          parent: "TBD",
          rtn: "object",
        };
        d.textOpts && (e = $.extend(!0, {}, e, d.textOpts));
        var g = this.addShapes(c, "text", e);
        g.params.parent = {
          id: b.params.id,
          obj: b,
          dleft: b.left - g.left,
          dtop: b.top - g.top,
          lastscalex: b.scaleX,
          lastscaley: b.scaleY,
          lastangle: b.angle,
          textheight: 12,
        };
        this._updateShape(c, g, null, "child", g.params);
        void 0 !== d.strokeWidth && (g.params.parent.strokeWidth = d.strokeWidth);
        if (f.x !== e.x || f.y !== e.y) g.params.parent.moved = !0;
        d.textOpts &&
          void 0 !== d.textOpts.ra &&
          void 0 !== d.textOpts.dec &&
          (g.params.hasTextOpts = !0);
        b.params.children.push({ id: g.params.id, obj: g });
        this._updateShape(c, b, null, "addchild", b.params);
      } else if (
        b.params.children &&
        0 < b.params.children.length &&
        (a.notNull(d.text) || a.notNull(d.textOpts) || a.notNull(d.color))
      )
        for (g = 0; g < b.params.children.length; g++)
          ((f = b.params.children[g].obj),
            (e = $.extend(!0, {}, d.textOpts || {})),
            a.notNull(d.text) && (e.text = d.text),
            a.globalOpts.regSyncTextColor &&
              !e.color &&
              !1 !== d.synctextcolor &&
              a.notNull(d.color) &&
              (e.color = d.color),
            0 < Object.keys(e).length && this.changeShapes(c, f.params.id, e));
  };
  a.Fabric.addShapes = function (c, b, d) {
    var e,
      f,
      g = {},
      h = [],
      l = {};
    if (!(0 <= $.inArray("regions", this.params.disable) && "regions" === c)) {
      d = d || {};
      if ("string" === typeof d)
        try {
          d = JSON.parse(d);
        } catch (r) {
          a.error("can't parse shape opts: " + d, r);
        }
      if (this.display.image !== this)
        ((this.delayedShapes = this.delayedShapes || []),
          this.delayedShapes.push({ layer: c, shape: b, mode: "add", opts: d }));
      else {
        if (d.file && a.globalOpts.reloadRefreshReg)
          try {
            this.removeShapes("regions", d.file);
          } catch (r) {}
        if ((e = this.getShapeLayer(c)) && e.show) {
          var m = e.canvas;
          if ("string" === typeof b) {
            var k = this.parseRegions(b, d);
            b = "string" === typeof k ? [{ shape: k }] : k;
          } else if (!$.isArray(b))
            if ("object" === typeof b) b = [b];
            else return;
          if (a.isNull(e.zindex) || Number.isNaN(e.zindex)) {
            if ("main" === this.display.layers[c].dtype)
              switch (c) {
                case a.Crosshair.LAYERNAME:
                case a.Grid.LAYERNAME:
                  e.zindex = 1;
                  break;
                default:
                  e.zindex = this.zlayer++;
              }
            else e.zindex = a.SHAPEZINDEX;
            var q = this.display.layers[c];
            q.divjq.css("z-index", e.zindex);
            this.xeqPlugins("shape", "onshapelayercreate", c);
          }
          var u = $.extend(!0, {}, a.Fabric.opts, e.opts, d);
          for (q = 0; q < b.length; q++) {
            var p = b[q];
            !0 === p.preservedcoords &&
              ((a.isNull(p.dx) || a.isNull(p.dy)) &&
                $.isArray(p.pts) &&
                a.isNull(p.pts[0].dx) &&
                a.error("preservedcoords requires positions in display coords"),
              (p.sticky = !0),
              (p.preservedcoords = Object.keys(p)),
              (p.wcsconfig = { wcssys: "image" }));
            var n = $.extend(!0, {}, u, p);
            var x = this._parseShapeOptions(c, n);
            if (x.remove) {
              if (!0 === x.remove || "true" === x.remove) x.remove = "all";
              if (!1 !== x.remove && "false" !== x.remove) {
                this.removeShapes(c, x.remove);
                continue;
              }
            }
            if (x.shape) {
              n = x.opts;
              g = x.params;
              void 0 === g.id && (g.id = ++e.nshape);
              void 0 === g.wcsconfig && (g.wcsconfig = { wcssys: this.getWCSSys() });
              g.exports = this._exportShapeOptions(d).concat(this._exportShapeOptions(p));
              g.parent = null;
              g.children = [];
              n.stroke && ((n.color = n.stroke), (n.stroke = a.colorToHex(n.stroke)));
              e.opts.noCenteredScaling &&
                0 <= $.inArray(x.shape, e.opts.noCenteredScaling) &&
                (n.centeredScaling = !1);
              switch (x.shape) {
                case "annulus":
                  g.shape = "annulus";
                  k = n.top;
                  x = n.left;
                  n.top = 0;
                  n.left = 0;
                  var w = [];
                  if (g.radii)
                    for (p = 0; p < g.radii.length; p++)
                      ((n.radius = g.radii[p]), w.push(new fabric.Circle(n)));
                  n.top = k;
                  n.left = x;
                  n.width = 2 * n.radius;
                  n.height = 2 * n.radius;
                  k = new fabric.Group(w, n);
                  break;
                case "box":
                  g.shape = "box";
                  k = new fabric.Rect(n);
                  break;
                case "circle":
                  g.shape = "circle";
                  k = new fabric.Circle(n);
                  break;
                case "cross":
                  g.shape = "cross";
                  k = n.top;
                  x = n.left;
                  p = n.angle;
                  w = n.width / 2;
                  var t = n.height / 2;
                  var v = [];
                  n.left = 0;
                  n.top = 0;
                  n.angle = 0;
                  n.points = [
                    { x: -w, y: 0 },
                    { x: w, y: 0 },
                  ];
                  v.push(new fabric.Polyline(n.points, n));
                  n.points = [
                    { x: 0, y: -t },
                    { x: 0, y: t },
                  ];
                  v.push(new fabric.Polyline(n.points, n));
                  n.top = k;
                  n.left = x;
                  n.angle = p;
                  k = new fabric.Group(v, n);
                  break;
                case "ellipse":
                  g.shape = "ellipse";
                  n.rx = g.r1;
                  n.ry = g.r2;
                  k = new fabric.Ellipse(n);
                  break;
                case "point":
                  g.shape = "point";
                  switch (g.ptshape) {
                    case "box":
                      k = new fabric.Rect(n);
                      break;
                    case "circle":
                      k = new fabric.Circle(n);
                      break;
                    case "ellipse":
                      k = new fabric.Ellipse(n);
                      break;
                    default:
                      k = new fabric.Rect(n);
                  }
                  break;
                case "line":
                  g.shape = "line";
                  k = new fabric.Polyline(n.points, n);
                  break;
                case "polygon":
                  g.shape = "polygon";
                  k = new fabric.Polygon(n.points, n, !0);
                  break;
                case "text":
                  g.shape = "text";
                  g.text = n.text || "Double-click to add text here";
                  n.fill = n.stroke;
                  n.strokeWidth = 0;
                  k = new fabric.Text(g.text, n);
                  break;
                default:
                  a.error("unknown shape: " + x.shape);
              }
              m.add(k);
              g.layerName = c;
              g.sw1 = Math.max(1, Math.floor(k.strokeWidth + 0.5));
              g.listonchange = !1;
              k.params = g;
              x =
                "main" !== this.display.layers[c].dtype || k.params.preservedcoords
                  ? 1
                  : this.rgb.sect.zoom;
              if (e.opts.panzoom)
                switch (g.shape) {
                  case "point":
                  case "text":
                    break;
                  default:
                    k.scale(x);
                }
              k.rescaleBorder();
              !1 === k.params.changeable && m.sendToBack(k);
              this._handleChildText(c, k, n);
              "TBD" !== d.parent && this._updateShape(c, k, null, "add", g);
              if (d.onaddshapes && k.pub)
                try {
                  a.xeqByName(d.onaddshapes, this, this, k.pub);
                } catch (r) {
                  a.error("in onaddshapes callback", r, !1);
                }
              h.push(k);
              n.groupid && ((l[n.groupid] = l[n.groupid] || []), l[n.groupid].push(k));
            }
          }
          for (f in l)
            Object.prototype.hasOwnProperty.call(l, f) &&
              this.groupShapes(c, l[f], { groupid: f, select: !1 });
          (void 0 === g.redraw || g.redraw) && m.renderAll();
          return "object" === d.rtn ? k : "objs" === d.rtn ? h : g.id;
        }
      }
    }
  };
  a.Fabric._parseShapes = function (c, b, d) {
    var e = this;
    if (!this.layers || !c || !this.layers[c]) return null;
    var f = this.layers[c].canvas;
    d = d || {};
    a.tmp.regSelect = { layer: c, im: this, all: [] };
    f.getObjects().forEach(function (b) {
      b.params
        ? b.params.parent || a.tmp.regSelect.all.push(b.params.id)
        : "group" === b.type && (b = e.lookupGroup(b)) && a.tmp.regSelect.all.push(b);
    });
    try {
      regSelect.parse(b);
    } catch (g) {
      a.error("parsing selection filter: " + b, g);
    }
    if (d.saveselection && b)
      switch (b.trim()) {
        case "all":
        case "saved":
        case "selected":
          break;
        default:
          this.layers[c].selection = b;
      }
    b = a.tmp.regSelect.ids;
    delete a.tmp.regSelect;
    return b;
  };
  a.Fabric._selectShapes = function (c, b, d, e) {
    var f = this,
      g,
      h,
      l = [],
      m = function (a, b) {
        0 > $.inArray(a, l) && (e.call(f, a, b), l.push(a));
      },
      k = function (a) {
        var b;
        if (!a) return [];
        var c = a.length;
        do {
          for (b = 0; c--; ) {
            var d = a[c];
            "group" !== d.type ||
              d.params ||
              (a.splice.apply(a, [c, 1].concat($jscomp.arrayFromIterable(d.getObjects()))), b++);
          }
          c = a.length;
        } while (b);
        return a;
      },
      q = function (a, b) {
        var c,
          d,
          e = [],
          f = [];
        var g = b.length;
        for (c = 0; c < g; c++) {
          var h = b[c];
          ("activeSelection" === h.type || ("group" === h.type && !h.params)) && e.push(h);
        }
        var k = e.length;
        (d = a.getActiveObject()) &&
          ("activeSelection" === d.type || ("group" === d.type && !d.params) || (d = null));
        if (k || d)
          for (c = 0; c < g; c++) {
            var l = b[c];
            for (a = 0; a < k; a++) ((h = e[a]), h.contains(l) && (f[c] = h));
            f[c] || (d && d.contains(l) && (f[c] = d));
          }
        return f;
      },
      u = function (a) {
        var b;
        for (b = 0; b < n.length; b++) {
          var c = n[b];
          if ("activeSelection" === c.type || ("group" === c.type && !c.params)) {
            if (c.contains(a)) return c;
          } else if (c.params && c === a) return w[b];
        }
        return null;
      };
    if (!this.layers || !c || !this.layers[c]) return null;
    "function" !== typeof e && a.error("selectShapes requires a callback");
    d = d || {};
    var p = this.layers[c].canvas;
    b || (b = p.getActiveObject() && "auto" === a.globalOpts.regWhichDefault ? "selected" : "all");
    if ("string" === typeof b && b.startsWith("["))
      try {
        b = JSON.parse(b);
      } catch (y) {
        a.error("can't parse array selection");
      }
    if ("string" === typeof b) {
      if (this.layers[c].selection) {
        if ("and" === d.saved) b = "(saved) && (" + b + ")";
        else if ("or" === d.saved || !0 === d.saved) b = "(saved) || (" + b + ")";
        b = b.replace(/saved/gi, this.layers[c].selection);
      }
      if (b.match(/&|\||!/)) b = this._parseShapes(c, b, d);
      else if (d.saveselection && b)
        switch (b.trim()) {
          case "all":
          case "saved":
          case "selected":
            break;
          default:
            this.layers[c].selection = b;
        }
    }
    $.isArray(b) || (b = [b]);
    for (h = 0; h < b.length; h++) {
      var n = p.getObjects();
      var x = n.length;
      var w = q(p, n);
      var t = b[h];
      "string" === typeof t && /^[1-9]\d*$/.test(t) && (t = parseInt(t, 10));
      var v = { group: null, canvas: p, layer: c };
      switch (typeof t) {
        case "object":
          for (; x--; ) {
            var r = n[x];
            if (r === t) {
              v.group = w[x];
              m(r, v);
              break;
            }
          }
          break;
        case "number":
          for (; x--; )
            if (((r = n[x]), r.params && t === r.params.id)) {
              v.group = w[x];
              m(r, v);
              break;
            }
          break;
        case "string":
          if ("selected" === t)
            for (x = k(p.getActiveObjects()), g = x.length; g--; )
              ((r = x[g]), (v.group = u(r)), r.params && !r.params.parent && m(r, v));
          else
            for (; x--; )
              if (((r = n[x]), "group" === r.type && !r.params))
                t === this.lookupGroup(r) || "all" === t.toLowerCase()
                  ? ((v.group = r),
                    !1 !== d.transparentgroup
                      ? r.forEachObject(function (a) {
                          a.params && !a.params.parent && m(a, v);
                        })
                      : m(r, v))
                  : r.forEachObject(function (a) {
                      a.params && t === a.params.file && m(a, v);
                    });
              else if (
                r.params &&
                ((g = r.stroke.toLowerCase()), !r.params.parent || "child" === t || "All" === t) &&
                ("child" !== t || r.params.parent)
              )
                if (((v.group = w[x]), "all" === t.toLowerCase())) m(r, v);
                else if (t.toLowerCase() === g || a.colorToHex(t).toLowerCase() === g) m(r, v);
                else if (t === r.params.shape) m(r, v);
                else if (t === r.params.file) m(r, v);
                else if ("object" === typeof r.params.data && t === r.params.data.syncid) m(r, v);
                else if ("child" === t && r.params.parent) m(r, v);
                else if ("dcoords" === t && r.params.preservedcoords) m(r, v);
                else if ("nodcoords" === t && !r.params.preservedcoords) m(r, v);
                else if ("parent" === t && r.params.children && r.params.children.length) m(r, v);
                else if (
                  0 <= $.inArray(t, a.wcssyss) &&
                  r.params.wcsconfig &&
                  r.params.wcsconfig.wcssys === t
                )
                  m(r, v);
                else if (r.params.tags)
                  for (g = 0; g < r.params.tags.length; g++) {
                    var z = r.params.tags[g];
                    t.match(/^\/.*\/$/) && z.match(new RegExp(t.slice(1, -1)))
                      ? m(r, v)
                      : t === z && m(r, v);
                  }
      }
    }
    return this;
  };
  a.Fabric.selectShapes = function (c, b, d) {
    var e,
      f = [];
    if ((e = this.getShapeLayer(c))) {
      var g = e.canvas;
      d = d || {};
      if ("string" === typeof d)
        try {
          d = JSON.parse(d);
        } catch (h) {
          a.error("can't parse selectShapes opts: " + d, h);
        }
      a.isNull(d.transparentgroup) && (d.transparentgroup = !1);
      a.isNull(d.saveselection) && (d.saveselection = !0);
      b = b || "all";
      if ("reset" === b)
        return (
          delete e.selection,
          !1 !== d.activateselection &&
            (g.getActiveObject() && g.discardActiveObject(), g.renderAll()),
          this
        );
      this._selectShapes(c, b, d, function (a) {
        !(0 > $.inArray(a, f)) || (a.params && a.params.groupid) || f.push(a);
      });
      f.length &&
        (g.getActiveObject() && g.discardActiveObject(),
        (c = 1 === f.length ? f[0] : new fabric.ActiveSelection(f, { canvas: g })),
        g.setActiveObject(c),
        g.renderAll());
      return this;
    }
  };
  a.Fabric.unselectShapes = function (a, b, d) {
    if (this.getShapeLayer(a) && this.layers[a])
      return b && "all" !== b && "selected" !== b
        ? this.selectShapes(a, (this.layers[a].selection || "selected") + " && !(" + b + ")", d)
        : this.selectShapes(a, "reset");
  };
  a.Fabric.updateShapes = function (a, b, d, e) {
    var c = this;
    this._selectShapes(a, b, null, function (b, f) {
      c._updateShape(a, b, f, d, e);
    });
    return this;
  };
  a.Fabric._updateMultiDialogs = function (a) {
    var b = this;
    $("form[class*='regionsConfigForm']").each(function (c, e) {
      c = $(e).data("multi");
      var d = $(e).data("winid");
      e = $(e).data("im");
      c &&
        d &&
        e === b &&
        !1 !== e.tmp.updateMulti &&
        e.initRegionsForm(null, { winid: d, multi: c, setmode: a });
    });
  };
  a.Fabric._updateShape = function (c, b, d, e, f) {
    var g = this,
      h,
      l,
      m,
      k = {},
      q = this.layers[c],
      u = /^(child||export|unexport|move|mouseout)$/;
    var p = function (a) {
      return a.toFixed(2);
    };
    var n = function (b, c, d, e, f, g, h) {
      var k = a.pix2wcs(b, d.x, d.y).trim().split(/\s+/);
      h.rastr = k[0];
      h.decstr = k[1];
      h.wcssys = k[2];
      var l = a.strtoscaled(k[0]);
      a.isHMS(k[2], l.dtype) && (l.dval *= 15);
      var m = a.strtoscaled(k[1]);
      h.ra = l.dval;
      h.dec = m.dval;
      if (!1 !== g.updateWCS && (g.updateWCS || c.opts.updateWCS)) {
        h.wcsstr = a.reg2wcs(b, e, a.REGSIZE).replace(/;$/, "");
        "line" === d.shape && f && (h.wcsstr = h.wcsstr.replace(/} *$/, f + "}"));
        k = h.wcsstr.replace(/.*\(/, "").replace(/\).*/, "").split(",");
        for (b = 0; b < k.length; b++) k[b] = k[b].trim();
        h.wcsposstr = [k[0], k[1]];
        switch (d.shape) {
          case "annulus":
            h.wcssizestr = [k[k.length - 1]];
            break;
          case "box":
          case "cross":
            h.wcssizestr = [k[2], k[3]];
            break;
          case "circle":
            h.wcssizestr = [k[2]];
            break;
          case "ellipse":
            h.wcssizestr = [k[2], k[3]];
            break;
          case "line":
          case "polygon":
            for (h.wcspts = [], b = 0; b < k.length; b += 2)
              ((l = a.strtoscaled(k[b])),
                a.isHMS(h.wcssys, l.dtype) && (l.dval *= 15),
                (m = a.strtoscaled(k[b + 1])),
                h.wcspts.push({ ra: l.dval, dec: m.dval }));
        }
      }
    };
    if (b && b.params) {
      d = d || {};
      f = f || {};
      e = e || "update";
      var x =
        "main" !== this.display.layers[c].dtype || b.params.preservedcoords
          ? 1
          : this.rgb.sect.zoom;
      k.mode = e;
      k.id = b.params.id;
      k.groupid = b.params.groupid;
      k.shape = b.params.shape;
      k.layer = c;
      k.color = b.color || b.stroke;
      k.tags = b.params.tags;
      k.sticky = b.params.sticky;
      k.preservedcoords = b.params.preservedcoords;
      b.params.ignore && (k.ignore = !0);
      k.parent = b.params.parent ? b.params.parent.obj.params.id : null;
      k.child = b.params.children && b.params.children.length ? b.params.children[0].id : null;
      var w = b.getCenterPoint();
      var t = { x: 0, y: 0 };
      if (
        d.group &&
        ((t = d.group.getCenterPoint()),
        (w = { x: t.x + w.x * d.group.scaleX, y: t.y + w.y * d.group.scaleY }),
        d.group.angle && (w = a.rotatePoint(w, d.group.angle, t)),
        "activeSelection" !== d.group.type)
      ) {
        if ((m = q.canvas.getActiveObject()) && "activeSelection" === m.type) {
          var v = m.getObjects();
          var r = v.length;
          for (h = 0; h < r; h++)
            if (v[h] === d.group) {
              var z = m.getCenterPoint();
              break;
            }
        }
        z || (m = null);
        m &&
          ((w = { x: z.x + w.x * m.scaleX, y: z.y + w.y * m.scaleY }),
          m.angle && (w = a.rotatePoint(w, m.angle, z)));
      }
      k.preservedcoords && ((k.dx = w.x), (k.dy = w.y));
      h = this.displayToImagePos(w);
      k.x = h.x;
      k.y = h.y;
      k.lcs = this.imageToLogicalPos(h);
      "export" !== e &&
        b.params.wcsconfig &&
        ("image" === b.params.wcsconfig.wcssys
          ? (l = "image")
          : "physical" === b.params.wcsconfig.wcssys && (l = "physical"));
      "image" === l || ("image" === this.params.wcssys && "physical" !== l)
        ? ((k.imsys = "image"), (h = k.x), (v = k.y), (l = 1))
        : ((k.imsys = k.lcs.sys),
          (h = k.lcs.x),
          (v = k.lcs.y),
          (l = Math.sqrt(
            Math.pow(this.lcs.physical.reverse[0][0], 2) +
              Math.pow(this.lcs.physical.reverse[0][1], 2)
          )));
      k.angle = -b.angle;
      d.group && (k.angle -= d.group.angle);
      m && (k.angle -= m.angle);
      m = k.angle;
      if (!k.parent)
        switch (k.shape) {
          case "box":
          case "cross":
          case "ellipse":
          case "text":
            if (
              (a.notNull(this.params.transformScale) && (k.angle /= this.params.transformScale),
              a.notNull(this.params.transformAngle) && (k.angle -= this.params.transformAngle),
              this.raw.wcsinfo)
            )
              this.raw.wcsinfo.crot && (k.angle -= this.raw.wcsinfo.crot);
            else if (a.notNull(this.raw.header.LTM1_1) || a.notNull(this.raw.header.LTM1_2)) {
              try {
                var y = Math.atan((this.raw.header.LTM1_2 || 0) / (this.raw.header.LTM1_1 || 0));
              } catch (E) {
                y = 0;
              }
              y && ((y = (180 * -y) / Math.PI), (k.angle -= y));
            }
        }
      for (; 0 > k.angle; ) k.angle += 360;
      for (; 360 <= k.angle; ) k.angle -= 360;
      w = b.scaleX / x;
      y = b.scaleY / x;
      d.group && ((w *= d.group.scaleX), (y *= d.group.scaleY));
      switch (k.shape) {
        case "annulus":
          k.shape = "annulus";
          k.radii = [];
          "image" !== k.imsys && (k.lcs.radii = []);
          k.imstr = "annulus(" + p(h) + "," + p(v) + ",";
          var A = "annulus " + k.x + " " + k.y + " ";
          v = b.getObjects();
          r = v.length;
          for (h = 0; h < r; h++)
            ((t = v[h].radius * w),
              (y = t * l),
              (k.imstr += p(y)),
              (A = a.REGSIZE
                ? A + (k.x + " " + k.y + " " + (k.x + t) + " " + k.y + " ")
                : A + (t + " ")),
              (k.imstr = h === r - 1 ? k.imstr + ")" : k.imstr + ","),
              k.radii.push(t),
              "image" !== k.imsys && k.lcs.radii.push(y));
          break;
        case "box":
        case "cross":
          k.width = b.width * w;
          k.height = b.height * y;
          y = k.width * l;
          A = k.height * l;
          "image" !== k.imsys && ((k.lcs.width = y), (k.lcs.height = A));
          k.imstr =
            k.shape +
            "(" +
            p(h) +
            "," +
            p(v) +
            "," +
            p(y) +
            "," +
            p(A) +
            "," +
            k.angle.toFixed(4) +
            ")";
          A = a.REGSIZE
            ? k.shape +
              " " +
              k.x +
              " " +
              k.y +
              " " +
              k.x +
              " " +
              k.y +
              " " +
              (k.x + k.width) +
              " " +
              k.y +
              " " +
              k.x +
              " " +
              k.y +
              " " +
              k.x +
              " " +
              (k.y + k.height) +
              " " +
              (k.angle * Math.PI) / 180
            : k.shape +
              " " +
              k.x +
              " " +
              k.y +
              " " +
              k.width +
              " " +
              k.height +
              " " +
              (k.angle * Math.PI) / 180;
          break;
        case "circle":
          k.radius = b.radius * w;
          y = k.radius * l;
          "image" !== k.imsys && (k.lcs.radius = y);
          k.imstr = "circle(" + p(h) + "," + p(v) + "," + p(y) + ")";
          A = a.REGSIZE
            ? "circle " +
              k.x +
              " " +
              k.y +
              " " +
              k.x +
              " " +
              k.y +
              " " +
              (k.x + k.radius) +
              " " +
              k.y
            : "circle " + k.x + " " + k.y + " " + k.radius;
          break;
        case "ellipse":
          k.r1 = (b.width * w) / 2;
          k.r2 = (b.height * y) / 2;
          y = k.r1 * l;
          A = k.r2 * l;
          "image" !== k.imsys && ((k.lcs.r1 = y), (k.lcs.r2 = A));
          k.imstr =
            "ellipse(" +
            p(h) +
            "," +
            p(v) +
            "," +
            p(y) +
            "," +
            p(A) +
            "," +
            k.angle.toFixed(4) +
            ")";
          A = a.REGSIZE
            ? "ellipse " +
              k.x +
              " " +
              k.y +
              " " +
              k.x +
              " " +
              k.y +
              " " +
              (k.x + k.r1) +
              " " +
              k.y +
              " " +
              k.x +
              " " +
              k.y +
              " " +
              k.x +
              " " +
              (k.y + k.r2) +
              " " +
              (k.angle * Math.PI) / 180
            : "ellipse " +
              k.x +
              " " +
              k.y +
              " " +
              k.r1 +
              " " +
              k.r2 +
              " " +
              (k.angle * Math.PI) / 180;
          break;
        case "point":
          k.width = b.width * w;
          k.height = b.height * y;
          y = k.width * l;
          A = k.height * l;
          "image" !== k.imsys && ((k.lcs.width = y), (k.lcs.height = A));
          k.imstr = "point(" + p(h) + "," + p(v) + ")";
          A = "point " + k.x + " " + k.y;
          break;
        case "line":
        case "polygon":
          k.imstr = k.shape + "(";
          A = k.shape + " ";
          k.pts = [];
          "image" !== k.imsys && (k.lcs.pts = []);
          for (h = 0; h < b.points.length; h++)
            if (
              (0 < h && ((k.imstr += ","), (A += " ")),
              (y = this.displayToImagePos({
                x: t.x + b.left + b.points[h].x * b.scaleX,
                y: t.y + b.top + b.points[h].y * b.scaleY,
              })),
              (y = a.rotatePoint(y, m, { x: k.x, y: k.y })),
              "image" === k.imsys
                ? (k.imstr += p(y.x) + "," + p(y.y))
                : ((x = this.imageToLogicalPos(y)),
                  (d = x.x),
                  (x = x.y),
                  (k.imstr += p(d) + "," + p(x)),
                  k.lcs.pts.push({ x: d, y: x })),
              (A += y.x + " " + y.y),
              k.pts.push(y),
              "line" === k.shape)
            )
              if (0 === h) var B = 0;
              else
                ((d = k.pts[h - 1]),
                  (B += Math.sqrt((y.x - d.x) * (y.x - d.x) + (y.y - d.y) * (y.y - d.y))));
          if ("line" === k.shape && a.notNull(B)) {
            k.imstr += ') {"size":' + p(B) + ',"units":"pixels"';
            if (2 === k.pts.length) {
              for (
                y = (180 * Math.atan2(k.pts[1].y - k.pts[0].y, k.pts[1].x - k.pts[0].x)) / Math.PI;
                0 > y;

              )
                y += 360;
              var C = ',"posang":' + y.toFixed(4) + ',"posunits":"degrees"';
              k.imstr += C;
            }
            k.imstr += "}";
          } else k.imstr += ")";
          k.angle = 0;
          break;
        case "text":
          ((k.imstr =
            "text(" + p(h) + "," + p(v) + ',"' + b.text + '",' + k.angle.toFixed(4) + ")"),
            (A = "text " + k.x + " " + k.y + ' "' + b.text + '" ' + (k.angle * Math.PI) / 180),
            (k.text = b.text));
      }
      this.validWCS() &&
        (n(this.raw.wcs, q, k, A, C, f, k),
        "export" !== e &&
          b.params.wcsconfig &&
          b.params.wcsconfig.wcssys &&
          ((p = a.globalOpts.xeqPlugins),
          (a.globalOpts.xeqPlugins = !1),
          (t = this.getWCSSys()),
          a.notWCS(b.params.wcsconfig.wcssys) ||
            (this.setWCSSys(b.params.wcsconfig.wcssys, !1),
            n(this.raw.wcs, q, k, A, C, f, b.params.wcsconfig)),
          (k.wcsconfig = $.extend(!0, {}, b.params.wcsconfig)),
          this.setWCSSys(t, !1),
          (a.globalOpts.xeqPlugins = p)));
      k.data = b.params.data;
      b.set("pub", k);
      b.params.winid &&
        ($(b.params.winid).is(":visible") ? this.initRegionsForm(b) : (b.params.winid = null));
      if (f.nocb) return k;
      (function () {
        var d = function (b) {
          try {
            ((g.params.xeqonchange = !1), a.xeqByName(b, window, g, k));
          } catch (G) {
            a.log("error in onchange: %s [%s]\n%s", g.id, G.message, a.strace(G));
          } finally {
            g.params.xeqonchange = !0;
          }
        };
        b.params.parent ||
          e.match(u) ||
          (g.params.xeqonchange &&
            q.show &&
            (q.opts.onchange
              ? d(q.opts.onchange)
              : "regions" === c && a.Regions.opts.onchange && d(a.Regions.opts.onchange)),
          (d = "on" + c + "change"),
          g.xeqPlugins("shape", d, k));
      })();
      if ("regions" === c && a.globalOpts.regToClipboard) {
        switch (e) {
          case "update":
            h = k.parent || k.id;
            break;
          default:
            h = null;
        }
        if (a.notNull(h)) {
          try {
            var D = this.listRegions(h, { mode: 1, includedcoords: !0 });
          } catch (E) {
            D = null;
          }
          D && (a.clipboard = D);
        }
      }
      "regions" === c && "wcs" === e && this._updateMultiDialogs(!0);
      return k;
    }
  };
  a.Fabric.lookupGroup = function (a, b) {
    var c;
    b = b || "regions";
    if (!this.getShapeLayer(b)) return null;
    b = this.layers[b].canvas;
    if ("string" === typeof a) {
      var e = b.getObjects();
      for (b = 0; b < e.length; b++) {
        var f = e[b];
        if ("group" === f.type && !f.params) {
          var g = f.getObjects();
          for (c = 0; c < g.length; c++) {
            var h = g[c];
            if (h.params && h.params.groupid === a) return f;
          }
        }
      }
    } else if (
      "object" === typeof a &&
      "group" === a.type &&
      !a.params &&
      (e = a.getObjects()) &&
      e.length &&
      e[0] &&
      e[0].params
    )
      return e[0].params.groupid;
    return null;
  };
  a.Fabric.listGroups = function (c, b, d) {
    var e = "";
    d = d || "regions";
    var f = this.getShapeLayer(d);
    if (!f) return e;
    c = c || "all";
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (m) {
        a.error("can't parse listGroups opts: " + b, m);
      }
    b = b || {};
    var g = f.canvas.getObjects();
    for (f = 0; f < g.length; f++) {
      var h = g[f];
      if ("group" === h.type && !h.params) {
        var l = h.getObjects()[0].params.groupid;
        if ("all" === c || c === l)
          !1 === b.includeregions
            ? (e += l + ";")
            : ((h =
                this.getShapes(d, l, { format: "text", includejson: !1, includecomments: !0 }) +
                ";;"),
              (h = h.substring(h.indexOf(";") + 1)),
              (e += l + ":;" + h));
      }
    }
    a.notNull(b.mode) && 0 < b.mode && this.display.displayMessage("regions", e);
    return e.replace(/;\s*/g, "\n").replace(/\n\n$/, "\n");
  };
  a.Fabric.groupShapes = function (c, b, d) {
    var e = this,
      f,
      g,
      h,
      l = [];
    var m = this.getShapeLayer(c);
    if (!m) return 0;
    d = d || {};
    if ("string" === typeof d)
      try {
        d = JSON.parse(d);
      } catch (q) {
        a.error("can't parse groupShapes opts: " + d, q);
      }
    m = m.canvas;
    var k = (function (a) {
      var b = 1;
      for (a = a.groupid || "group_" + b; e.lookupGroup(a); )
        ((b += 1), (a = a.replace(/_[0-9][0-9]*$/, "") + ("_" + b)));
      return a;
    })(d);
    this._selectShapes(c, b, d, function (b) {
      if (0 > $.inArray(b, l)) {
        g = !1;
        if (b.params.groupid)
          switch (a.globalOpts.regGroupConflict) {
            case "skip":
              h = b.params.groupid;
              g = !0;
              break;
            default:
              ((f = sprintf(
                "%s can only be a member of one group [%s,%s]",
                "regions" === c ? "regions" : "shapes",
                b.params.id,
                b.params.groupid
              )),
                a.error(f));
          }
        g ||
          ((b.params.groupid = k),
          0 > $.inArray("groupid", b.params.exports) && b.params.exports.push("groupid"),
          l.push(b));
      }
    });
    if (!l.length) return h;
    m.getActiveObject() && m.discardActiveObject();
    b = new fabric.ActiveSelection(l, { canvas: m });
    a.globalOpts.skipSelectionProcessing = !0;
    m.setActiveObject(b);
    m.getActiveObject().toGroup();
    !1 === d.select && m.getActiveObject() && m.discardActiveObject();
    delete a.globalOpts.skipSelectionProcessing;
    m.renderAll();
    this.groups[c] = this.groups[c] || [];
    this.groups[c].push(k);
    return k;
  };
  a.Fabric.ungroupShapes = function (c, b, d) {
    var e, f;
    var g = this.getShapeLayer(c);
    if (!g || !this.layers[c]) return this;
    a.isNull(b) && a.error("ungroup requires a group id or selection");
    d = d || {};
    var h = g.canvas;
    var l = h.getObjects();
    for (g = 0; g < l.length; g++) {
      var m = l[g];
      if ("group" === m.type && !m.params) {
        var k = m.getObjects();
        for (f = e = 0; e < k.length; e++) {
          var q = k[e];
          if (q.params && ("all" === b || b === q.params.groupid)) {
            f ||
              (h.getActiveObject() && h.discardActiveObject(),
              (a.globalOpts.skipSelectionProcessing = !0),
              h.setActiveObject(m),
              h.getActiveObject().toActiveSelection(),
              d.select || h.discardActiveObject(),
              h.requestRenderAll(),
              delete a.globalOpts.skipSelectionProcessing,
              f++);
            delete q.params.groupid;
            var u = $.inArray("groupid", q.params.exports);
            0 <= u && q.params.exports.splice(u, 1);
          }
        }
      }
    }
    this.groups[c] && ((u = $.inArray(b, this.groups[c])), 0 <= u && this.groups[c].splice(u, 1));
    return this;
  };
  a.Fabric.removeShapes = function (c, b, d) {
    var e = this,
      f,
      g,
      h = !1,
      l = { mode: 1, includedcoords: !0 },
      m = [],
      k = [];
    if ((f = this.getShapeLayer(c))) {
      var q = f.canvas;
      d = d || {};
      q.getActiveObject() && (g = q.getActiveObjects());
      "regions" === c &&
        a.globalOpts.unremoveReg &&
        (this.regstack.push(this.listRegions(b, l, c)),
        this.regstack.length > a.globalOpts.unremoveReg &&
          (this.regstack = this.regstack.slice(0, a.globalOpts.unremoveReg)));
      this._selectShapes(c, b, d, function (a, b) {
        if (
          !(
            (!1 === a.params.removable && !d.overrideRemovable) ||
            (a.params.sticky && !1 === d.sticky)
          )
        ) {
          e._updateShape(c, a, b, "remove");
          a.params.winid && (a.params.winid.close(), (a.params.winid = null));
          if (a.params.parent) {
            var f = a.params.parent.obj;
            for (b = f.params.children.length - 1; 0 <= b; b--)
              if (a === f.params.children[b].obj) {
                f.params.children.splice(b, 1);
                break;
              }
          }
          for (b = 0; b < a.params.children.length; b++)
            ((f = a.params.children[b].obj), m.push(f));
          a.params.groupid && 0 > $.inArray(a.params.groupid, k) && k.push(a.params.groupid);
          g && !h && 0 <= $.inArray(a, g) && (h = !0);
          m.push(a);
        }
      });
      h && q.discardActiveObject();
      for (b = 0; b < k.length; b++) this.ungroupShapes(c, k[b]);
      for (b = 0; b < m.length; b++) q.remove(m[b]);
      q.renderAll();
      !q.size() && a.globalOpts.resetEmptyShapeId && (f.nshape = 0);
      return this;
    }
  };
  a.Fabric.getShapes = function (c, b, d) {
    var e = {},
      f = [];
    d = d || {};
    if ("string" === typeof d)
      try {
        d = JSON.parse(d);
      } catch (l) {
        a.error("can't parse getShapes opts: " + d, l);
      }
    if ("regions" === c && ("text" === d.format || "csv" === d.format || "regions" === d.format)) {
      d.mode = d.mode || 1;
      b = this.listRegions(b, d);
      if ("csv" === d.format) {
        var g = b.split(";");
        c = 0;
        for (b = ""; c < g.length; c++)
          if (g[c])
            if (g[c].toLowerCase().match(a.WCSEXP)) d.includewcs && (b += g[c].trim() + "\n");
            else {
              var h = g[c].replace(/\(/, ",").replace(/\).*/, "").trim();
              b += h + "\n";
            }
      } else "regions" === d.format && (b = b.replace(/ *; */g, "\n"));
      return b;
    }
    this._selectShapes(c, b, d, function (a) {
      e = a.pub || {};
      d.includeObj && (e.obj = a);
      f.push(e);
    });
    f.sort(function (a, b) {
      return (a.id || 0) - (b.id || 0);
    });
    return f;
  };
  a.Fabric.changeShapes = function (c, b, d) {
    var e = this,
      f,
      g,
      h,
      l,
      m,
      k,
      q,
      u,
      p,
      n,
      x,
      w = [],
      t = [];
    if ((m = this.getShapeLayer(c)) && d) {
      if ("string" === typeof d)
        try {
          d = JSON.parse(d);
        } catch (z) {
          a.error("can't parse shape opts: " + d, z);
        }
      if (this.display.image !== this)
        ((this.delayedShapes = this.delayedShapes || []),
          this.delayedShapes.push({ layer: c, shape: b, mode: "change", opts: d }));
      else {
        var v = m.canvas;
        var r = v.getActiveObject();
        a.isNull(d.saveselection) && (d.saveselection = !0);
        this._selectShapes(c, b, d, function (b, y) {
          u =
            "main" !== e.display.layers[c].dtype || b.params.preservedcoords ? 1 : e.rgb.sect.zoom;
          d.radii && (b.params.radii = []);
          d.tags && (b.params.tags = []);
          void 0 !== d.locked && delete b.params.changeable;
          l = $.extend(!0, {}, b.params, d);
          h = e._parseShapeOptions(c, l, b);
          if (h.remove) {
            if (!0 === h.remove || "true" === h.remove) h.remove = "all";
            if (!1 !== h.remove && "false" !== h.remove) {
              e.removeShapes(c, h.remove || "all");
              return;
            }
          }
          if (h.opts.send)
            switch (h.opts.send) {
              case "front":
                v.sendToFront(r);
                v.getActiveObject() && v.discardActiveObject();
                break;
              case "back":
                (v.sendToBack(r), v.getActiveObject() && v.discardActiveObject());
            }
          p = e._exportShapeOptions(d).filter(function (a) {
            return !Object.prototype.hasOwnProperty.call(b.params.exports, a);
          });
          h.params.exports = b.params.exports.concat(p);
          h.opts.stroke &&
            ((h.opts.color = h.opts.stroke), (h.opts.stroke = a.colorToHex(h.opts.stroke)));
          switch (b.params.shape) {
            case "text":
              h.opts.stroke && (h.opts.fill = h.opts.stroke);
              h.opts.strokeWidth = 0;
              break;
            case "line":
            case "polygon":
              h.opts.points && h.opts.points.length && (b.angle = 0);
          }
          b.set(h.opts);
          b.params = $.extend(!1, {}, b.params, h.params);
          h.opts.strokeWidth && (b.params.sw1 = h.opts.strokeWidth);
          switch (b.params.shape) {
            case "annulus":
              if (d.radii && d.radii.length) {
                b.forEachObject(function (a) {
                  w.push(a);
                });
                k = w.length;
                for (f = 0; f < k; f++) (b.remove(w[f]), v.remove(w[f]));
                k = b.params.radii.length;
                q = 0;
                n = $.extend(!0, {}, d);
                n.stroke = n.stroke || b.get("stroke");
                n.strokeWidth = n.strokeWidth || b.get("strokeWidth");
                n.strokeDashArray = n.strokeDashArray || b.get("strokeDashArray");
                for (f = 0; f < k; f++)
                  ((n.radius = b.params.radii[f]),
                    (g = new fabric.Circle(n)),
                    (q = Math.max(q, b.params.radii[f])),
                    b.add(g));
                b.scaleX = u;
                b.scaleY = u;
                b.width = 2 * q;
                b.height = 2 * q;
                r === b && v.setActiveObject(b);
              }
              break;
            case "box":
              d.width && (b.scaleX = u);
              d.height && (b.scaleY = u);
              break;
            case "circle":
              d.radius && ((b.scaleX = u), (b.scaleY = u));
              break;
            case "cross":
              n = $.extend(!0, {}, d);
              n.stroke = n.stroke || b.get("stroke");
              n.width &&
                ((b.scaleX = u),
                (t[0] = [
                  { x: -n.width / 2, y: 0 },
                  { x: n.width / 2, y: 0 },
                ]),
                delete n.width);
              n.height &&
                ((b.scaleY = u),
                (t[1] = [
                  { x: 0, y: -n.height / 2 },
                  { x: 0, y: n.height / 2 },
                ]),
                delete n.height);
              n.angle && delete n.angle;
              b.forEachObject(function (a, b) {
                x = $.extend(!0, {}, n);
                t[b] && (x.points = t[b]);
                a.set(x);
              });
              break;
            case "ellipse":
              d.r1 && ((b.rx = b.params.r1), (b.scaleX = u), (b.width = 2 * b.rx));
              d.r2 && ((b.ry = b.params.r2), (b.scaleY = u), (b.height = 2 * b.ry));
              break;
            case "line":
            case "polygon":
              if ((d.points && d.points.length) || (d.pts && d.pts.length))
                ((b.scaleX = u), (b.scaleY = u));
              r === b &&
                (a.Fabric.removePolygonAnchors(m.dlayer, b),
                a.Fabric.addPolygonAnchors(m.dlayer, b));
              a.resetPolygonCenter(b);
              break;
            case "text":
              d.text && (b.params.text = d.text);
          }
          b.rescaleBorder();
          !1 === b.params.changeable && v.sendToBack(b);
          a.Fabric.updateChildren(m.dlayer, b, "moving");
          a.Fabric.updateChildren(m.dlayer, b, "scaling");
          a.Fabric.updateChildren(m.dlayer, b, "rotating");
          a.Fabric.updateChildren(m.dlayer, b, "deltas");
          b.setCoords();
          e._handleChildText(c, b, d);
          e._updateShape(c, b, y, "update");
          if (d.onchangeshapes && b.pub)
            try {
              a.xeqByName(d.onchangeshapes, e, e, b.pub);
            } catch (A) {
              a.error("in onchangeshapes callback", A, !1);
            }
        });
        "selected" === b && r && "activeSelection" === r.type && r.addWithUpdate();
        (void 0 === d.redraw || d.redraw) && v.renderAll();
        return this;
      }
    }
  };
  a.Fabric.refreshShapes = function (c) {
    if (c) {
      var b = {
        mode: 1,
        sticky: !1,
        ignoreignore: !0,
        saveediting: !0,
        savewcsconfig: !0,
        saveid: !0,
      };
      var d = a.globalOpts.xeqPlugins;
      a.globalOpts.xeqPlugins = !1;
      var e = this.getWCSSys();
      "image" === e &&
        (this.validWCS() ? this.setWCSSys("native", !1) : this.setWCSSys("physical", !1));
      if (this.tmp.panzoomRefresh && this.tmp.panzoomRefresh[c])
        this.tmp.panzoomRefresh[c].regstr
          ? this.tmp.panzoomRefresh[c].refresh &&
            ((b = this.tmp.panzoomRefresh[c].regstr), this.addShapes(c, b, { restoreid: !0 }))
          : ((b = this.listRegions("all", b, c)),
            (this.tmp.panzoomRefresh[c] = { regstr: b, refresh: !1 }),
            this.removeShapes(c, "all", { overrideRemovable: !0, sticky: !1 }));
      else if ((b = this.listRegions("all", b, c)))
        (this.saveSelection(c),
          this.removeShapes(c, "all", { overrideRemovable: !0, sticky: !1 }),
          this.addShapes(c, b, { restoreid: !0 }),
          this.restoreSelection(c));
      "image" === e && (this.setWCSSys(e, !1), this.updateShapes(c, "all", "refresh"));
      a.globalOpts.xeqPlugins = d;
      return this;
    }
  };
  a.Fabric.copyShapes = function (c, b, d) {
    var e = [];
    if (this.getShapeLayer(c)) {
      if ("object" === typeof b) e.push(b);
      else if ("all" === b)
        for (b = 0; b < a.images.length; b++) this !== a.images[b] && e.push(a.images[b]);
      else (b = a.lookupImage(b)) && e.push(b);
      if (e.length) {
        d = this.listRegions(d, { mode: 1, includedcoords: a.globalOpts.regCopyDCoords }, c);
        for (b = 0; b < e.length; b++) {
          var f = this.display.layers[c] ? this.display.layers[c].opts : a.Regions.opts;
          e[b].display.newShapeLayer(c, f);
          e[b].addShapes(c, d);
        }
        return this;
      }
    }
  };
  a.Fabric._addPolygonPoint = function (c, b, d) {
    var e = Number.MAX_VALUE;
    if (b && b.points) {
      d = a.eventToDisplayPos(d);
      var f = b.getCenterPoint().x;
      var g = b.getCenterPoint().y;
      f = (d.x - f) / b.get("scaleX");
      var h = (d.y - g) / b.get("scaleY");
      for (g = (-b.get("angle") * Math.PI) / 180; g > 2 * Math.PI; ) g -= 2 * Math.PI;
      d = Math.cos(g) * f - Math.sin(g) * h;
      h = Math.sin(g) * f + Math.cos(g) * h;
      f = b.points;
      for (g = 0; g < f.length; g++) {
        var l = f[g];
        var m = f[(g + 1) % f.length];
        var k = l.x < m.x ? l.x : m.x;
        var q = l.y < m.y ? l.y : m.y;
        var u = l.x > m.x ? l.x : m.x;
        var p = l.y > m.y ? l.y : m.y;
        var n = l.x - m.x;
        l = l.y - m.y;
        var x = Math.sqrt(n * n + l * l);
        0 !== x && ((n /= x), (l /= x));
        x = d - m.x;
        var w = h - m.y;
        x = x * n + w * l;
        n = m.x + n * x;
        m = m.y + l * x;
        n < k ? (n = k) : n > u && (n = u);
        m < q ? (m = q) : m > p && (m = p);
        k = (n - d) * (n - d) + (m - h) * (m - h);
        if (k < e) {
          e = k;
          var t = n;
          var v = m;
          var r = g === f.length ? 0 : g;
        }
      }
      c = this.getShapeLayer(c);
      a.Fabric.removePolygonAnchors(c.dlayer, b);
      f.splice(r + 1, 0, { x: t, y: v });
      switch (b.type) {
        case "polyline":
        case "polygon":
          (a.Fabric.addPolygonAnchors(c.dlayer, b), c.dlayer.canvas.renderAll());
      }
      b.polyparams
        ? (c.dlayer.params.sel = b.polyparams.polygon)
        : b.params && (c.dlayer.params.sel = b);
    }
  };
  a.Fabric._removePolygonPoint = function (c, b) {
    if (b && b.polyparams) {
      var d = b.polyparams.polygon;
      var e = d.points;
      if (!(("polygon" === d.type && 3 >= e.length) || ("polyline" === d.type && 2 >= e.length))) {
        var f = b.polyparams.point;
        delete b.polyparams.point;
        c = this.getShapeLayer(c);
        a.Fabric.removePolygonAnchors(c.dlayer, d);
        e.splice(f, 1);
        a.resetPolygonCenter(d);
        c.canvas.setActiveObject(d);
      }
    }
  };
  a.Fabric.addPolygonAnchors = function (c, b) {
    var d,
      e = {},
      f = c.canvas,
      g = function (b) {
        if (b.target && b.target.polyparams) var d = b.target;
        else
          b.transform &&
            b.transform.target &&
            b.transform.target.polyparams &&
            (d = b.transform.target);
        if (d && ((b = d.polyparams.polygon), !1 !== b.params.changeable)) {
          var g = b.get("points");
          var h = d.polyparams.point;
          void 0 !== h &&
            void 0 !== g[h] &&
            (b.angle
              ? (e = a.rotatePoint({ x: d.left, y: d.top }, -b.angle, { x: b.left, y: b.top }))
              : ((e.x = d.left), (e.y = d.top)),
            (g[h].x = (e.x - b.left) / b.scaleX),
            (g[h].y = (e.y - b.top) / b.scaleY),
            a.resetPolygonCenter(b),
            c.display.image &&
              ((d = c.display.image),
              d._updateShape(b.params.layerName, b, null, "update"),
              (d.params.listonchange || b.params.listonchange) && d.listRegions(b, { mode: 2 })),
            f.renderAll());
        }
      },
      h = function (b) {
        var c,
          d = {};
        for (c = 0; c < b.params.anchors.length; c++)
          ((d.x = b.left + b.points[c].x * b.scaleX),
            (d.y = b.top + b.points[c].y * b.scaleY),
            b.angle && (d = a.rotatePoint(d, b.angle, { x: b.left, y: b.top })),
            b.params.anchors[c].set({ left: d.x, top: d.y, angle: b.angle }),
            b.params.anchors[c].setCoords());
        b._calcDimensions(!0);
        f.renderAll();
      };
    if (!b.params.anchors && !1 !== b.params.changeable) {
      b.params.anchors = [];
      for (d = 0; d < b.points.length; d++) {
        e.x = b.left + b.points[d].x * b.scaleX;
        e.y = b.top + b.points[d].y * b.scaleY;
        b.angle && (e = a.rotatePoint(e, b.angle, b.getCenterPoint()));
        var l = new fabric.Rect({
          left: e.x,
          top: e.y,
          hasControls: !1,
          hasRotatingPoint: !1,
          hasBorders: !1,
          selectable: !0,
          fill: b.get("stroke"),
          hoverCursor: "pointer",
          width: a.Fabric.opts.cornerSize + 2,
          height: a.Fabric.opts.cornerSize + 2,
          padding: 2,
        });
        l.on("moving", g);
        l.polyparams = {};
        l.polyparams.polygon = b;
        l.polyparams.point = d;
        b.params.anchors[d] = l;
        f.add(l);
      }
      b.on("moving", function () {
        h(b);
      });
      b.on("rotating", function () {
        h(b);
      });
      b.on("scaling", function () {
        h(b);
      });
      b.setCoords();
    }
  };
  a.Fabric.removePolygonAnchors = function (a, b) {
    var c = a.canvas;
    if (b && b.params && b.params.anchors) {
      for (a = 0; a < b.params.anchors.length; a++) c.remove(b.params.anchors[a]);
      delete b.params.anchors;
    }
  };
  a.Fabric._ungroupAnnulus = function (a, b) {
    var c, e;
    if ((e = this.getShapeLayer(a))) {
      this.editAnnulus = { annulus: b.params.id, ids: [] };
      var f = {
        top: b.top,
        left: b.left,
        lockMovementX: !0,
        lockMovementY: !0,
        stroke: b.stroke,
        strokeDashArray: [3, 1],
      };
      var g = b.getObjects();
      g.sort(function (b, a) {
        return a.radius - b.radius;
      });
      for (c = 0; c < g.length; c++) {
        f.radius = g[c].radius;
        0 === f.radius && (f.radius = 1e-6);
        f.ignore = !0;
        var h = this.addShapes(a, "circle", f);
        this.editAnnulus.ids.push(h);
      }
      f = { editing: !0 };
      this.changeShapes(a, b, f);
      e.canvas.getActiveObject() === b && e.canvas.discardActiveObject();
      e.canvas.sendToBack(b);
      e.canvas.renderAll();
    }
  };
  a.Fabric._regroupAnnulus = function (a, b) {
    var c,
      e = [];
    if (this.editAnnulus && (c = this.getShapeLayer(a))) {
      if ("boolean" === typeof b) var f = b;
      else "object" === typeof b && (f = b.shiftKey);
      b = { editing: !1 };
      if (!f) {
        c.canvas.getObjects().forEach(function (a) {
          a.params && "circle" === a.params.shape && e.push(a);
        });
        b.radii = [];
        var g = [].concat($jscomp.arrayFromIterable(this.editAnnulus.ids));
        for (f = e.length - 1; 0 <= f; f--) {
          var h = e[f].params.id;
          for (c = g.length - 1; 0 <= c; c--) {
            var l = g[c];
            if (h === l) {
              1e-6 === e[f].pub.radius && (e[f].pub.radius = 0);
              b.radii.push(e[f].pub.radius);
              g.splice(c, 1);
              break;
            }
          }
          if (!g.length) break;
        }
        b.radii.sort(function (a, b) {
          return a - b;
        });
      }
      this.changeShapes(a, this.editAnnulus.annulus, b);
      this.removeShapes(a, this.editAnnulus.ids);
      delete this.editAnnulus;
    }
  };
  a.Fabric.updateChildren = function (c, b, d) {
    var e, f;
    if ("regions" === c.layerName)
      if ("objects" === d) {
        var g = {};
        c.canvas.getObjects().forEach(function (a) {
          a.params && (a.params.parent || a.params.children.length) && (g[a.params.id] = a);
        });
        c.canvas.getObjects().forEach(function (a) {
          if (a.params)
            for (
              a.params.parent && (a.params.parent.obj = g[a.params.parent.id]), e = 0;
              e < a.params.children.length;
              e++
            )
              a.params.children[e].obj = g[a.params.children[e].id];
        });
      } else if (b && b.params)
        if ("deltas" === d) {
          if (b.params.parent) {
            var h = b.params.parent;
            h.dleft = h.obj.left - b.left;
            h.dtop = h.obj.top - b.top;
            h.moved = !0;
          }
        } else
          for (e = 0; e < b.params.children.length; e++) {
            var l = b.params.children[e].obj;
            h = l.params.parent;
            switch (d) {
              case "moving":
                l.left = b.left - h.dleft;
                l.top = b.top - h.dtop;
                break;
              case "rotating":
                for (f = b.angle; 0 > f; ) f += 360;
                for (; 360 <= f; ) f -= 360;
                var m = f - h.lastangle;
                var k = a.rotatePoint({ x: l.left, y: l.top }, m, { x: b.left, y: b.top });
                l.left = k.x;
                l.top = k.y;
                h.dleft = b.left - l.left;
                h.dtop = b.top - l.top;
                for (l.angle += m; 0 > l.angle; ) l.angle += 360;
                for (; 360 <= l.angle; ) l.angle -= 360;
                h.lastangle = f;
                break;
              case "scaling":
                ((h.dleft *= b.scaleX / h.lastscalex),
                  (h.dtop = (b.scaleY / h.lastscaley) * (h.dtop - h.textheight) + h.textheight),
                  (h.lastscalex = b.scaleX),
                  (h.lastscaley = b.scaleY),
                  (h.moved = !0),
                  (l.left = b.left - h.dleft),
                  (l.top = b.top - h.dtop));
            }
            l.setCoords();
            c.display.image && c.display.image.updateShapes(c.layerName, l, "updatechild");
          }
  };
  a.resetPolygonCenter = function (c) {
    var b = {};
    var d = c._calcDimensions();
    var e = (d.left + d.width / 2) * c.scaleX;
    d = (d.top + d.height / 2) * c.scaleY;
    c.angle
      ? (b = a.rotatePoint({ x: c.left + e, y: c.top + d }, c.angle, { x: c.left, y: c.top }))
      : ((b.x = c.left + e), (b.y = c.top + d));
    e /= c.scaleX;
    var f = d / c.scaleY;
    for (d = 0; d < c.points.length; d++) ((c.points[d].x -= e), (c.points[d].y -= f));
    c.left = b.x;
    c.top = b.y;
    b = c._calcDimensions();
    c.width = b.width;
    c.height = b.height;
    c.pathOffset = { x: b.left + c.width / 2, y: b.top + c.height / 2 };
    c.setCoords();
  };
  a.Fabric.saveSelection = function (a) {
    var b,
      c = [];
    if ((b = this.getShapeLayer(a))) {
      var e = b.canvas.getActiveObjects();
      for (a = 0; a < e.length; a++) {
        var f = e[a];
        f.params && !1 !== f.params.changeable && c.push(f.params.id);
      }
      c.length && (b.savesel = c);
    }
  };
  a.Fabric.restoreSelection = function (a) {
    var b,
      c,
      e,
      f = [];
    if ((e = this.getShapeLayer(a)) && e.savesel && e.savesel.length) {
      var g = e.canvas;
      g.getObjects().forEach(function (a) {
        for (b = 0; b < e.savesel.length; b++)
          if (((c = e.savesel[b]), a.params && a.params.id === c)) {
            f.push(a);
            break;
          }
      });
      if (f.length) {
        var h = new fabric.ActiveSelection(f, { canvas: g });
        g.setActiveObject(h);
        "regions" === a && ((this.clickInRegion = !0), (this.clickInLayer = "regions"));
        this.updateShapes(a, f, "restore");
      }
      delete e.savesel;
    }
  };
  a.Fabric.print = function (c) {
    var b,
      d = "",
      e = 0,
      f = sprintf(
        "width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",
        this.display.canvasjq.attr("width"),
        this.display.canvasjq.attr("height")
      );
    c = c || {};
    if ("string" === typeof c)
      try {
        c = JSON.parse(c);
      } catch (m) {
        a.error("can't parse print opts: " + c, m);
      }
    var g = this.display.canvas.toDataURL("image/png");
    var h = "<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>";
    var l = sprintf("<div style='position:absolute; left:%spx; top:%spx'>", 0, e);
    h += l + "<img src='" + g + "'></div>";
    for (b in this.layers)
      Object.prototype.hasOwnProperty.call(this.layers, b) &&
        ((g = this.layers[b]),
        "main" === g.dlayer.dtype && g.show && (h += "" + l + g.dlayer.canvas.toSVG() + "</div>"));
    (void 0 === c.colorbar || c.colorbar) &&
      (c = this.display.pluginInstances.JS9Colorbar) &&
      c.isActive() &&
      ((e += 2),
      (g = c.colorbarjq[0].toDataURL("image/png")),
      (e += this.display.height),
      (l = sprintf("<div style='position:absolute; left:%spx; top:%spx'>", 0, e)),
      (h += l + "<img src='" + g + "'></div>"),
      c.textjq &&
        c.textjq[0] &&
        ((g = c.textjq[0].toDataURL("image/png")),
        (e += c.colorbarjq.height() + 1),
        (l = sprintf("<div style='position:absolute; left:%spx; top:%spx'>", 0, e)),
        (h += l + "<img style='width:" + this.display.width + "px;'src='" + g + "'></div>")));
    h += "</body></html>";
    window.electron && (d = "data:text/html," + h);
    (l = window.open(d, this.id, f))
      ? l.document
        ? (l.document.open(), l.document.write(h), l.document.close())
        : a.error("no method available for drawing image into print window")
      : a.error("could not create print window (check your pop-up blockers)");
  };
  a.Fabric.initGraphics = function () {
    a.Display.prototype.newShapeLayer = a.Fabric.newShapeLayer;
    a.Image.prototype._selectShapes = a.Fabric._selectShapes;
    a.Image.prototype._updateShape = a.Fabric._updateShape;
    a.Image.prototype._parseShapes = a.Fabric._parseShapes;
    a.Image.prototype._parseShapeOptions = a.Fabric._parseShapeOptions;
    a.Image.prototype._exportShapeOptions = a.Fabric._exportShapeOptions;
    a.Image.prototype._handleChildText = a.Fabric._handleChildText;
    a.Image.prototype._addPolygonPoint = a.Fabric._addPolygonPoint;
    a.Image.prototype._removePolygonPoint = a.Fabric._removePolygonPoint;
    a.Image.prototype._ungroupAnnulus = a.Fabric._ungroupAnnulus;
    a.Image.prototype._regroupAnnulus = a.Fabric._regroupAnnulus;
    a.Image.prototype._updateMultiDialogs = a.Fabric._updateMultiDialogs;
    a.Image.prototype.addShapes = a.Fabric.addShapes;
    a.Image.prototype.updateShapes = a.Fabric.updateShapes;
    a.Image.prototype.getShapes = a.Fabric.getShapes;
    a.Image.prototype.changeShapes = a.Fabric.changeShapes;
    a.Image.prototype.removeShapes = a.Fabric.removeShapes;
    a.Image.prototype.refreshShapes = a.Fabric.refreshShapes;
    a.Image.prototype.copyShapes = a.Fabric.copyShapes;
    a.Image.prototype.selectShapes = a.Fabric.selectShapes;
    a.Image.prototype.unselectShapes = a.Fabric.unselectShapes;
    a.Image.prototype.groupShapes = a.Fabric.groupShapes;
    a.Image.prototype.ungroupShapes = a.Fabric.ungroupShapes;
    a.Image.prototype.listGroups = a.Fabric.listGroups;
    a.Image.prototype.lookupGroup = a.Fabric.lookupGroup;
    a.Image.prototype.saveSelection = a.Fabric.saveSelection;
    a.Image.prototype.restoreSelection = a.Fabric.restoreSelection;
    a.Image.prototype.getShapeLayer = a.Fabric.getShapeLayer;
    a.Image.prototype.showShapeLayer = a.Fabric.showShapeLayer;
    a.Image.prototype.activeShapeLayer = a.Fabric.activeShapeLayer;
    a.Image.prototype.displayShapeLayers = a.Fabric.displayShapeLayers;
    a.Image.prototype.toggleShapeLayers = a.Fabric.toggleShapeLayers;
    a.Image.prototype.print = a.Fabric.print;
  };
  a.Fabric.initGraphics();
  a.MouseTouch = {};
  a.MouseTouch.CLASS = "JS9";
  a.MouseTouch.NAME = "MouseTouch";
  a.MouseTouch.WIDTH = 512;
  a.MouseTouch.HEIGHT = 220;
  a.MouseTouch.BASE = a.MouseTouch.CLASS + a.MouseTouch.NAME;
  a.MouseTouch.mouseText = [];
  a.MouseTouch.mouseText[0] = "Move mouse, no buttons pressed:";
  a.MouseTouch.mouseText[1] = "Move mouse, primary button pressed:";
  a.MouseTouch.mouseText[2] = "Move mouse, secondary button pressed:";
  a.MouseTouch.touchText = [];
  a.MouseTouch.touchText[0] = "Touch move, with one finger:";
  a.MouseTouch.touchText[1] = "Touch move, with two fingers:";
  a.MouseTouch.touchText[2] = "Touch move, with three fingers:";
  a.MouseTouch.textHTML = "<div style='float: left'>%s</div>";
  a.MouseTouch.actionHTML = "<div style='float: left'><b>%s</b></div>";
  a.MouseTouch.actionid = function (a, b) {
    return (a + "_" + b).replace(/[^A-Za-z0-9_]/g, "_");
  };
  a.MouseTouch.addText = function (c, b) {
    b = sprintf(a.MouseTouch.textHTML, b);
    return $("<div>")
      .addClass(a.MouseTouch.BASE + "Text")
      .html(b)
      .appendTo(c);
  };
  a.MouseTouch.addAction = function (c, b, d) {
    b = a.MouseTouch.actionid(b, d);
    d = sprintf(a.MouseTouch.actionHTML, d);
    return $("<div>")
      .addClass(a.MouseTouch.BASE + "Action")
      .attr("id", b)
      .html(d)
      .appendTo(c);
  };
  a.MouseTouch.isPinch = function (c, b) {
    var d,
      e,
      f = a.globalOpts.pinchWait,
      g = a.globalOpts.pinchThresh;
    if (!c) return -1;
    b = c.display;
    if (!a.globalOpts.mousetouchZoom || 2 !== c.pos.touches.length) return -1;
    switch (b.ispinch) {
      case -1:
      case 1:
        return b.ispinch;
    }
    c = Math.sqrt(
      (c.pos.touches[0].x - c.pos.touches[1].x) * (c.pos.touches[0].x - c.pos.touches[1].x) +
        (c.pos.touches[0].y - c.pos.touches[1].y) * (c.pos.touches[0].y - c.pos.touches[1].y)
    );
    b.dist0 || (b.dist0 = c);
    b.deltas.push(Math.floor(c - b.dist0));
    if (b.deltas.length >= f) {
      c = 1;
      for (e = d = 0; c < f; c++)
        b.deltas[c] > b.deltas[c - 1] ? d++ : b.deltas[c] < b.deltas[c - 1] && e++;
      b.ispinch = d >= g || e >= g ? 1 : -1;
      b.lastzoom = 0;
      return b.ispinch;
    }
    return 0;
  };
  a.MouseTouch.Actions = {};
  a.MouseTouch.Actions["display value/position"] = function (c, b, d) {
    !a.specialKey(d) &&
      a.globalOpts.internalValPos &&
      c &&
      b &&
      0 < b.x &&
      0 < b.y &&
      b.x <= c.raw.width &&
      b.y <= c.raw.height &&
      (c.valpos = c.updateValpos(b, !0));
  };
  a.MouseTouch.Actions["change contrast/bias"] = function (c, b, d) {
    if (
      a.globalOpts.internalContrastBias &&
      c &&
      b &&
      "static" !== c.cmapObj.type &&
      ((b = c.display),
      !(
        (c.pos0 &&
          c.pos &&
          Math.abs(c.pos0.x - c.pos.x) < a.NOMOVE &&
          Math.abs(c.pos0.y - c.pos.y) < a.NOMOVE) ||
        c.clickInRegion ||
        a.specialKey(d) ||
        c.useOffScreenCanvas()
      ))
    ) {
      var e = a.eventToDisplayPos(d, c.posOffset);
      d = Math.floor(e.x + 0.5);
      e = Math.floor(e.y + 0.5);
      (a.globalOpts.containContrastBias &&
        (0 > d || 0 > e || d >= b.canvas.width || e >= b.canvas.height)) ||
        ((c.params.bias = d / b.canvas.width),
        (c.params.contrast = (e / b.canvas.height) * 10),
        a.bugs.firefox_linux
          ? window.setTimeout(function () {
              c.displayImage("scaled", { blendMode: !1 });
            }, 0)
          : c.displayImage("scaled", { blendMode: !1 }),
        c.xeqStashDiscard("filterRGBImage"),
        a.globalOpts.extendedPlugins && c.xeqPlugins("image", "onchangecontrastbias"));
    }
  };
  a.MouseTouch.Actions["change contrast/bias"].stop = function (a, b, d) {
    a.display.blendMode && a.displayImage("rgb");
  };
  a.MouseTouch.Actions["wheel zoom"] = function (c, b) {
    var d,
      e = a.globalOpts.panzoomRefreshLimit,
      f = 0;
    var g = b.originalEvent.deltaY * Math.sign(a.DIRZOOM);
    if (
      c &&
      a.globalOpts.mousetouchZoom &&
      ((c.tmp.wheelzooms = c.tmp.wheelzooms || 0), 0 === c.tmp.wheelzooms++ % a.MODZOOM)
    ) {
      b = c.getZoom();
      g = 0 > g ? Math.min(a.MAXZOOM, b + a.ADDZOOM) : Math.max(a.MINZOOM, b - a.ADDZOOM);
      if (a.globalOpts.mousetouchLimit) {
        var h = Math.min(c.display.width / c.raw.width, c.display.height / c.raw.height);
        if (h > g && b > g) return;
      }
      g = Math.round(100 * (g + 1e-5)) / 100;
      for (d in c.layers)
        Object.prototype.hasOwnProperty.call(c.layers, d) &&
          c.layers[d].show &&
          c.layers[d].opts.panzoom &&
          c.layers[d].canvas.size() > e &&
          ((c.tmp.panzoomRefresh = c.tmp.panzoomRefresh || {}),
          (c.tmp.panzoomRefresh[d] = {}),
          f++);
      c.tmp.panzoomTimeout && (clearTimeout(c.tmp.panzoomTimeout), delete c.tmp.panzoomTimeout);
      if (f || c.tmp.panzoomRefresh)
        c.tmp.panzoomTimeout = setTimeout(function () {
          c.refreshLayers(c.tmp.panzoomRefresh);
          delete c.tmp.panzoomRefresh;
        }, a.TIMEOUT);
      c.setZoom(g);
    }
  };
  a.MouseTouch.Actions["pan the image"] = function (c, b, d) {
    var e;
    var f = a.globalOpts.panMouseThreshold;
    d = a.globalOpts.panzoomRefreshLimit;
    if (c) {
      b = c.rgb.sect;
      var g = (c.pos0.x - c.pos.x) / b.zoom;
      var h = (c.pos0.y - c.pos.y) / b.zoom;
      if (Math.abs(g) >= f || Math.abs(h) >= f) {
        "x" === c.params.flip
          ? (g = -g)
          : "y" === c.params.flip
            ? (h = -h)
            : "xy" === c.params.flip && ((g = -g), (h = -h));
        90 === c.params.rot90
          ? ((f = g), (g = -h), (h = f))
          : 180 === c.params.rot90
            ? ((g = -g), (h = -h))
            : -90 === c.params.rot90 && ((f = g), (g = h), (h = -f));
        g = { x: b.xcen + g, y: b.ycen - h };
        c.params.rotate && (g = a.rotatePoint(g, -c.params.rotate, { x: b.xcen, y: b.ycen }));
        for (e in c.layers)
          Object.prototype.hasOwnProperty.call(c.layers, e) &&
            c.layers[e].show &&
            c.layers[e].opts.panzoom &&
            c.layers[e].canvas.size() > d &&
            ((c.tmp.panzoomRefresh = c.tmp.panzoomRefresh || {}), (c.tmp.panzoomRefresh[e] = {}));
        c.setPan(g);
        c.pos0 = c.pos;
      }
    }
  };
  a.MouseTouch.Actions.pinch = function (c, b, d) {
    c &&
      ((b = c.display),
      (d =
        (b.zoom0 *
          Math.sqrt(
            (c.pos.touches[0].x - c.pos.touches[1].x) * (c.pos.touches[0].x - c.pos.touches[1].x) +
              (c.pos.touches[0].y - c.pos.touches[1].y) * (c.pos.touches[0].y - c.pos.touches[1].y)
          )) /
        b.dist0),
      (d = Math.max(a.MINZOOM, Math.min(a.MAXZOOM, Math.round(100 * (d + 1e-5)) / 100))),
      d !== b.lastzoom && c.setZoom(d),
      (b.lastzoom = d));
  };
  a.MouseTouch.Actions.start = function (c, b, d) {
    c &&
      ((b = c.display),
      (b.ispinch = 0),
      (b.dist0 = 0),
      (b.zoom0 = c.rgb.sect.zoom),
      (b.deltas = []));
    b = a.MouseTouch.getAction(c, d);
    a.MouseTouch.Actions[b] &&
      a.MouseTouch.Actions[b].start &&
      a.MouseTouch.Actions[b].start(c, c.ipos, d);
  };
  a.MouseTouch.Actions.stop = function (c, b, d) {
    b = a.MouseTouch.getAction(c, d);
    a.MouseTouch.Actions[b] &&
      a.MouseTouch.Actions[b].stop &&
      a.MouseTouch.Actions[b].stop(c, c.ipos, d);
  };
  a.MouseTouch.getAction = function (c, b) {
    if (!c) return e;
    var d = c.display;
    switch (c.clickState) {
      case 0:
        var e = d.mouseActions[0];
        break;
      case 1:
        e = d.mouseActions[1];
        break;
      case 2:
        e = d.mouseActions[2];
        break;
      case -1:
        e = d.touchActions[0];
        break;
      case -2:
        switch (a.MouseTouch.isPinch(c, b)) {
          case -1:
            e = d.touchActions[1];
            break;
          case 1:
            e = "pinch";
        }
        break;
      case -3:
        e = d.touchActions[2];
    }
    return e;
  };
  a.MouseTouch.action = function (c, b, d) {
    if ((d = d || a.MouseTouch.getAction(c, b)) && a.MouseTouch.Actions[d])
      a.MouseTouch.Actions[d](c, c.ipos, b);
  };
  a.MouseTouch.mousetouchzoom = function (c, b) {
    c = a.lookupDisplay(c);
    b = b.checked;
    c && (a.globalOpts.mousetouchZoom = b);
  };
  a.MouseTouch.init = function () {
    var c = this,
      b;
    this.divjq.html("");
    this.divjq.addClass("JS9PluginScrolling");
    this.mousetouchContainer = $("<div>")
      .addClass(a.MouseTouch.BASE + "Container")
      .attr("id", this.id + "MouseTouchContainer")
      .appendTo(this.divjq);
    var d = sprintf(
      "<div class='%s'><span><b>Drag an action to reconfigure JS9 mouse/touch events:</b></span><p>",
      a.MouseTouch.BASE + "Header"
    );
    this.mousetouchHeadContainer = $("<span style='float: left'>")
      .addClass(a.MouseTouch.BASE + "Container")
      .attr("id", this.id + "MouseTouchHeadContainer")
      .html(d)
      .appendTo(this.mousetouchContainer);
    this.mousetouchTextContainer = $("<span style='float: left'>")
      .addClass(a.MouseTouch.BASE + "Container")
      .attr("id", this.id + "MouseTouchTextContainer")
      .appendTo(this.mousetouchContainer);
    this.mousetouchActionContainer = $("<span style='float: left'>")
      .addClass(a.MouseTouch.BASE + "Container")
      .attr("id", this.id + "MouseTouchActionContainer")
      .appendTo(this.mousetouchContainer);
    if (a.TOUCHSUPPORTED) {
      this.mousetouchTouchTextContainer = $("<div>")
        .addClass(a.MouseTouch.BASE + "TextContainer")
        .attr("id", this.id + "TouchTextContainer")
        .html("")
        .appendTo(this.mousetouchTextContainer);
      for (b = 0; b < a.MouseTouch.touchText.length; b++)
        a.MouseTouch.addText.call(
          this,
          this.mousetouchTouchTextContainer,
          a.MouseTouch.touchText[b]
        );
      for (b = a.MouseTouch.touchText.length; b < this.display.touchActions.length; b++)
        a.MouseTouch.addText.call(this, this.mousetouchMouseTextContainer, "&nbsp;");
      this.mousetouchTouchContainer = $("<div>")
        .addClass(a.MouseTouch.BASE + "ActionContainer")
        .attr("id", this.id + "TouchContainer")
        .html("")
        .appendTo(this.mousetouchActionContainer);
      for (b = 0; b < this.display.touchActions.length; b++)
        ((d = this.display.touchActions[b]),
          a.MouseTouch.addAction.call(this, this.mousetouchTouchContainer, "touch", d));
      this.mousetouchTouchContainer.sortable({
        start: function (a, b) {
          c.oidx = b.item.index();
        },
        stop: function (a, b) {
          a = b.item.index();
          b = c.display.touchActions.splice(c.oidx, 1)[0];
          c.display.touchActions.splice(a, 0, b);
          delete c.oidx;
        },
      });
    }
    if (!/iPad|iPhone|iPod/.test(navigator.platform)) {
      this.mousetouchMouseTextContainer = $("<div>")
        .addClass(a.MouseTouch.BASE + "TextContainer")
        .attr("id", this.id + "MouseTextContainer")
        .appendTo(this.mousetouchTextContainer);
      for (b = 0; 3 > b; b++)
        a.MouseTouch.addText.call(
          this,
          this.mousetouchMouseTextContainer,
          a.MouseTouch.mouseText[b]
        );
      for (b = 3; b < this.display.mouseActions.length; b++)
        a.MouseTouch.addText.call(this, this.mousetouchMouseTextContainer, "&nbsp;");
      this.mousetouchMouseContainer = $("<div>")
        .addClass(a.MouseTouch.BASE + "ActionContainer")
        .attr("id", this.id + "MouseContainer")
        .html("")
        .appendTo(this.mousetouchActionContainer);
      for (b = 0; b < this.display.mouseActions.length; b++)
        ((d = this.display.mouseActions[b]),
          a.MouseTouch.addAction.call(this, this.mousetouchMouseContainer, "mouse", d));
      this.mousetouchMouseContainer.sortable({
        start: function (a, b) {
          c.oidx = b.item.index();
        },
        stop: function (a, b) {
          a = b.item.index();
          b = c.display.mouseActions.splice(c.oidx, 1)[0];
          c.display.mouseActions.splice(a, 0, b);
          delete c.oidx;
        },
      });
    }
    d = sprintf(
      "<p><div class='%s'>Use mouse wheel or pinch to zoom:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' value='1' onclick='javascript:JS9.MouseTouch.mousetouchzoom(\"%s\", this);'></div>",
      a.MouseTouch.BASE + "Footer",
      this.display.id
    );
    this.mousetouchFootContainer = $("<span style='float: left'>")
      .addClass(a.MouseTouch.BASE + "Container")
      .attr("id", this.id + "MouseTouchFootContainer")
      .html(d)
      .appendTo(this.mousetouchContainer);
    a.globalOpts.mousetouchZoom && this.mousetouchContainer.find("input").attr("checked", !0);
  };
  a.Regions = {};
  a.Regions.CLASS = "JS9";
  a.Regions.NAME = "Regions";
  a.Regions.opts = {
    updateWCS: !0,
    panzoom: !0,
    tags: "source,include",
    strokeWidth: 2,
    iradius: 15,
    oradius: 30,
    nannuli: 1,
    width: 60,
    height: 60,
    radius: 30,
    r1: 30,
    r2: 20,
    ptshape: "box",
    ptsize: 2,
    linepoints: [
      { x: -30, y: 30 },
      { x: 30, y: -30 },
    ],
    polypoints: [
      { x: -30, y: 30 },
      { x: 30, y: 30 },
      { x: 0, y: -30 },
    ],
    fontFamily: "Helvetica",
    fontSize: 14,
    fontStyle: "normal",
    fontWeight: 300,
    textAlign: "left",
    angle: 0,
    aradius1: 4,
    aradius2: 8,
    configURL: "./params/regionsconfig.html",
    saveURL: "./params/regionssave.html",
    sortOverlapping: !0,
    title: "Edit region",
    noCenteredScaling: ["box", "line"],
    tagcolors: {
      include_source: "#00FF00",
      exclude_source: "#FF0000",
      include_background: "#FFD700",
      exclude_background: "#FF8C00",
      source: "#00FF00",
      background: "#FFD700",
      defcolor: "#00FF00",
    },
    onmousedblclick: function (c, b, d, e) {
      (((b = e.params) && !b.winid && !b.ignore) ||
        (!b && "activeSelection" === e.type) ||
        (!b && "group" === e.type)) &&
        a.globalOpts.editRegions &&
        c.displayRegionsForm(e);
    },
    onmousedown: function (c, b, d, e) {
      b = e.params;
      a.specialKey(d) &&
        (b && c._regroupAnnulus(b.layerName, d),
        "polygon" === e.type || "polyline" === e.type
          ? (c._addPolygonPoint(b.layerName, e, d), c._updateShape(b.layerName, e, null, "update"))
          : e.polyparams && e.polyparams.polygon
            ? ((d = e.polyparams.polygon),
              c._removePolygonPoint(d.params.layerName, e),
              c._updateShape(d.params.layerName, d, null, "update"))
            : b && "annulus" === b.shape && c._ungroupAnnulus(b.layerName, e));
    },
    onmouseup: function () {
      var a,
        b = [];
      this.getActiveObject() && b.push(this.getActiveObject());
      b.push(this.getActiveObjects());
      for (a = 0; a < b.length; a++)
        b[a].polyparams && this.setActiveObject(b[a].polyparams.polygon);
    },
    onchange: null,
  };
  a.Regions.init = function (c) {
    a.Image.prototype.parseRegions = a.Regions.parseRegions;
    a.Image.prototype.saveRegions = a.Regions.saveRegions;
    a.Image.prototype.listRegions = a.Regions.listRegions;
    a.Image.prototype.copyRegions = a.Regions.copyRegions;
    a.Image.prototype.changeRegionTags = a.Regions.changeRegionTags;
    a.Image.prototype.toggleRegionTags = a.Regions.toggleRegionTags;
    a.Image.prototype.unremoveRegions = a.Regions.unremoveRegions;
    a.Image.prototype.initRegionsForm = a.Regions.initConfigForm;
    a.Image.prototype.displayRegionsForm = a.Regions.displayConfigForm;
    a.Image.prototype.processRegionsForm = a.Regions.processConfigForm;
    var b = this.display.newShapeLayer(c || "regions", a.Regions.opts);
    b.canvas.on("mouse:up", function () {
      var a,
        c = [];
      if (b.display.image) {
        var f = b.display.image;
        c.push(b.canvas.getActiveObjects());
        for (a = 0; a < c.length; a++)
          if (c[a].params) {
            f.params.listonchange
              ? "all" === f.params.whichonchange
                ? f.listRegions("all", { mode: 2 })
                : f.listRegions("selected", { mode: 2 })
              : c[a].params.listonchange && f.listRegions("selected", { mode: 2 });
            break;
          }
      }
    });
    return this;
  };
  a.Regions.displayConfigForm = function (c, b) {
    var d = this,
      e = 0,
      f = a.Regions.opts.title;
    if (this && ((b = b || {}), c || this.getShapes("regions").length)) {
      b.type = b.type || "config";
      switch (b.type) {
        case "save":
          var g = a.allinone ? a.allinone.regionsSaveHTML : a.InstallDir(a.Regions.opts.saveURL);
          f = "Save regions";
          var h = a.lightOpts[a.LIGHTWIN].regWin1;
          break;
        default:
          if (
            ((g = a.allinone
              ? a.allinone.regionsConfigHTML
              : a.InstallDir(a.Regions.opts.configURL)),
            !c || (!c.params && "activeSelection" === c.type) || (!c.params && "group" === c.type))
          )
            b.multi = !0;
      }
      if (
        b.multi &&
        ($("form[class='regionsConfigForm']").each(function (a, c) {
          a = $(c).data("multi");
          var f = $(c).data("winid");
          c = $(c).data("im");
          a && f && c === d && ((b.winid = f), c.initRegionsForm(null, b), e++);
        }),
        (f = f.replace(/regions?/, "selected regions")),
        e)
      )
        return;
      $(a.lightOpts[a.LIGHTWIN].topid).arrive(".regionsConfigForm", { onceOnly: !0 }, function () {
        b.firsttime = !0;
        c && c.params && d.updateShapes("regions", c, "wcsconfig");
        d.initRegionsForm(c, b);
      });
      b.winid = this.displayAnalysis("regions", g, { title: f, winformat: h });
      c && c.params && (c.params.winid = b.winid);
    }
  };
  a.Regions.initConfigForm = function (c, b) {
    var d = this,
      e,
      f,
      g,
      h,
      l,
      m,
      k,
      q = !1,
      u = this.raw.wcsinfo || { cdelt1: 1, cdelt2: 1 };
    var p = { type: "multi", pub: { shape: "multi", wcsconfig: {} }, params: {} };
    var n = function (a) {
        if (void 0 !== a)
          return (
            "number" === typeof a && 0 !== a % 1 && (a = Math.round(1e4 * (a + 1e-5)) / 1e4),
            String(a)
          );
      },
      x = function (a) {
        var b = String.fromCharCode(13, 10);
        return "string" === typeof a ? a.replace(/\\n/g, b) : a;
      };
    if (c && c.pub)
      var w =
        c.pub.wcsconfig && c.pub.wcsconfig.wcssys ? c.pub.wcsconfig.wcssys : this.params.wcssys;
    else ((w = this.params.wcssys), (c = p));
    var t = !1 === c.params.changeable;
    b = b || {};
    if (c.params.winid) var v = c.params.winid;
    else b.winid && (v = b.winid);
    if (v) {
      var r = "#" + $(v).attr("id") + " .regionsConfigForm ";
      if ($(r).length) {
        q = $(r).data("multi") ? !0 : b.multi;
        $(r + "." + c.pub.shape).each(function (a, b) {
          $(b).removeClass("nodisplay");
        });
        $(r + ".val").each(function (b, k) {
          g = "";
          f = $(k).attr("name");
          switch (f) {
            case "x":
            case "y":
              c.pub.lcs && void 0 !== c.pub.lcs[f]
                ? (g = n(c.pub.lcs[f]))
                : void 0 !== c.pub[f] && (g = n(c.pub[f]));
              break;
            case "radii":
              c.pub.radii &&
                (g =
                  !a.notWCS(w) && c.pub.wcsconfig && c.pub.wcsconfig.wcsstr
                    ? c.pub.wcsconfig.wcsstr
                        .replace(/^annulus\(/, "")
                        .replace(/\)$/, "")
                        .split(",")
                        .slice(2)
                        .join(",")
                    : c.pub.imstr
                        .replace(/^annulus\(/, "")
                        .replace(/\)$/, "")
                        .split(",")
                        .slice(2)
                        .join(","));
              break;
            case "pts":
              c.pub.pts
                ? c.pub.pts.forEach(function (a) {
                    g && (g += ", ");
                    g += a.x.toFixed(2) + ", " + a.y.toFixed(2);
                  })
                : c.pub.imstr && (g = c.pub.imstr.replace(/^.*\(/, "").replace(/\)$/, ""));
              break;
            case "linelength":
              if (c.pub.pts && 2 === c.pub.pts.length) {
                l = c.pub.pts[0];
                m = c.pub.pts[1];
                g = n(Math.sqrt((m.x - l.x) * (m.x - l.x) + (m.y - l.y) * (m.y - l.y)));
                switch (w) {
                  case "image":
                  case "physical":
                    break;
                  default:
                    ((g *= Math.abs(u.cdelt1)), (g *= Math.abs(u.cdelt2)));
                }
                g = n(g);
                d.tmp.linelength = g;
              }
              break;
            case "lineangle":
              if (c.pub.pts && 2 === c.pub.pts.length) {
                l = c.pub.pts[0];
                m = c.pub.pts[1];
                for (g = (180 * Math.atan2(m.y - l.y, m.x - l.x)) / Math.PI; 0 > g; ) g += 360;
                g = n(g);
                d.tmp.lineangle = g;
              }
              break;
            case "fontFamily":
              c.getFontFamily && (g = c.getFontFamily());
              break;
            case "fontSize":
              c.getFontSize && (g = c.getFontSize());
              break;
            case "fontStyle":
              c.getFontStyle && (g = c.getFontStyle());
              break;
            case "fontWeight":
              c.getFontWeight && (g = c.getFontWeight());
              break;
            case "colorPicker":
              g =
                void 0 !== c.pub.color
                  ? a.colorToHex(c.pub.color)
                  : $(r).data("colorpicker") || a.globalOpts.defcolor;
              break;
            case "color":
              q ||
                (void 0 !== c.pub.color
                  ? (g = n(c.pub.color))
                  : $(r).data("colorpicker") && (g = $(r).data("colorpicker")));
              break;
            case "strokeWidth":
              g = c.params.sw1 ? c.params.sw1 : $(r).data("strokewidth") || "";
              break;
            case "strokeDashes":
              c.strokeDashArray
                ? ((g = c.strokeDashArray.join(" ")), g.match(/NaN/) && (g = ""))
                : (g = $(r).data("strokedashes") || "");
              break;
            case "regstr":
              g =
                !a.notWCS(w) && c.pub.wcsconfig && c.pub.wcsconfig.wcsstr
                  ? c.pub.wcsconfig.wcssys + ";" + c.pub.wcsconfig.wcsstr
                  : c.pub.imsys + ";" + c.pub.imstr;
              break;
            case "xpos":
              switch (w) {
                case "image":
                  c.pub.preservedcoords && void 0 !== c.pub.dx
                    ? (g = sprintf("d%.1f", c.pub.dx))
                    : void 0 !== c.pub.x && (g = sprintf("%.1f", c.pub.x));
                  break;
                case "physical":
                  c.pub.lcs
                    ? (g = sprintf("%.1f", c.pub.lcs.x))
                    : void 0 !== c.pub.x && (g = sprintf("%.1f", c.pub.x));
                  break;
                default:
                  c.pub.wcsconfig && a.notNull(c.pub.wcsconfig.ra)
                    ? (g = sprintf("%.6f", c.pub.wcsconfig.ra))
                    : void 0 !== c.pub.x && (g = sprintf("%.1f", c.pub.x));
              }
              $(r + "[name='" + f + "']").prop("readonly", t);
              break;
            case "ypos":
              switch (w) {
                case "image":
                  c.pub.preservedcoords && void 0 !== c.pub.dy
                    ? (g = sprintf("d%.1f", c.pub.dy))
                    : void 0 !== c.pub.y && (g = sprintf("%.1f", c.pub.y));
                  break;
                case "physical":
                  c.pub.lcs
                    ? (g = sprintf("%.1f", c.pub.lcs.y))
                    : void 0 !== c.pub.y && (g = sprintf("%.1f", c.pub.y));
                  break;
                default:
                  c.pub.wcsconfig && a.notNull(c.pub.wcsconfig.dec)
                    ? (g = sprintf("%.6f", c.pub.wcsconfig.dec))
                    : void 0 !== c.pub.y && (g = sprintf("%.1f", c.pub.y));
              }
              $(r + "[name='" + f + "']").prop("readonly", t);
              break;
            case "radius":
            case "oradius":
            case "length":
            case "width":
            case "r1":
              switch (w) {
                case "image":
                  void 0 !== c.pub[f] && (g = n(c.pub[f]));
                  break;
                case "physical":
                  c.pub.lcs && void 0 !== c.pub.lcs[f] && (g = n(c.pub.lcs[f]));
                  break;
                default:
                  c.pub.wcsconfig && a.notNull(c.pub.wcsconfig.wcssizestr)
                    ? (g = n(c.pub.wcsconfig.wcssizestr[0]))
                    : void 0 !== c.pub[f] && (g = n(c.pub[f]));
              }
              $(r + "[name='" + f + "']").prop("readonly", t);
              break;
            case "height":
            case "r2":
              switch (w) {
                case "image":
                  void 0 !== c.pub[f] && (g = n(c.pub[f]));
                  break;
                case "physical":
                  c.pub.lcs && void 0 !== c.pub.lcs[f] && (g = n(c.pub.lcs[f]));
                  break;
                default:
                  c.pub.wcsconfig && a.notNull(c.pub.wcsconfig.wcssizestr)
                    ? (g = n(c.pub.wcsconfig.wcssizestr[1]))
                    : void 0 !== c.pub[f] && (g = n(c.pub[f]));
              }
              $(r + "[name='" + f + "']").prop("readonly", t);
              break;
            case "wcssys":
            case "savewcs":
              z = $(r).find("[name='" + f + "']");
              if (!z.find("option").length)
                for (e = 0; e < a.wcssyss.length; e++)
                  z.append("<option>" + a.wcssyss[e] + "</option>");
              h = "savewcs" === f ? a.globalOpts.regSaveWCS || w : w;
              z.find("option").each(function (a, b) {
                h === b.value && (g = b.value);
              });
              break;
            case "wcsunits":
              c.pub.wcsunits && (g = c.pub.wcsunits);
              break;
            case "childtext":
              c.params.children &&
                0 < c.params.children.length &&
                (g = x(c.params.children[0].obj.text));
              break;
            case "text":
              void 0 !== c.pub[f] && (g = x(n(c.pub[f])));
              break;
            case "id":
              q
                ? (g = "selected")
                : void 0 !== c.pub.id &&
                  ((g = String(c.pub.id)), $(k).css("width", g.length + "ch"));
              break;
            case "tags":
              void 0 !== c.pub[f] && (g = n(c.pub[f]));
              break;
            case "savefile":
              g = $(r).data("savefile") || d.tmp.saveregionsFile || "js9.reg";
              window.electron && !g.match(/.*\//) && (g = window.electron.currentDir + "/" + g);
              break;
            case "selectfilter":
              g = $(r).data("selectfilter");
              break;
            case "selectshape":
            case "selectcolor":
            case "selecttag":
            case "selectwcs":
            case "selectgroup":
              a.Regions.regionsConfigSetSelectMenu(d, $(r), f);
              break;
            default:
              void 0 !== c.pub[f] && (g = n(c.pub[f]));
          }
          $(k).val(g);
        });
        (q || !this.raw.wcs || 0 > this.raw.wcs) && $(r).find("[name='wcssys']").hide();
        "text" !== c.type && c.params.children && $(r + ".childtext").removeClass("nodisplay");
        if (b.firsttime) {
          window.electron && $(r).find(".rsavebrowse, .rconfigbrowse").removeClass("nodisplay");
          q
            ? ($(r).find("label[for='savecur']").text("sel"),
              $(r).find("input[id='savecur']").data("tooltip", "save selected regions"),
              $(r).find("[id='selectreg']").prop("checked", !0))
            : $(r).find(".checkboxes").removeClass("nodisplay");
          if (a.favorites.wcs && a.favorites.wcs.length) {
            var z = $(r).find(".rwcsbuttons").removeClass("nodisplay");
            var y = z.find(".rwcsbuttoncontainer");
            if (y.length && !y.find(".rwcsbutton").length) {
              for (e = 0; e < a.favorites.wcs.length; e++) {
                p = a.favorites.wcs[e];
                var A = "string" === typeof p ? p.split(":") : p;
                p = A[0];
                A = A[1] || p;
                if ("save" === b.type) {
                  var B = "rsavecol_R" + (e + 2);
                  var C = "rsaveradio";
                } else ((B = "rconfigcol_R" + (e + 2)), (C = "rconfigradio"));
                y.append(
                  "<span class='rconfigcol_R rwcsbutton " +
                    B +
                    "'>\n                                <input type='radio'\n                                       id='rwcsbutton_" +
                    p +
                    "'\n                                       name='rwcsbutton'\n                                       class='rwcsradio " +
                    C +
                    "}'\n                                       value='" +
                    p +
                    "'\n                                       data-tooltip='save using " +
                    p +
                    ' wcs\'\n                                       onclick=\'\n                                           $(this).closest("form")\n                                           .find("[name=savewcs]")\n                                           .val("' +
                    p +
                    '")\n                                           .trigger("change");\'>\n                                <label for=\'rwcsbutton_' +
                    p +
                    "'>" +
                    A +
                    "</label>\n                                </span>"
                );
              }
              $(r)
                .find(".rwcsbuttons")
                .find("[value='" + w + "']")
                .prop("checked", !0);
            }
          }
          (a.globalOpts.internalColorPicker && $.fn.spectrum.inputTypeColorSupport()) ||
            ((z = $(r).find("input[name='colorPicker']")),
            z.spectrum({ showButtons: !1, showInput: !1, preferredFormat: "hex6" }),
            z.on("move.spectrum", function (a, b) {
              a = b.toHexString();
              $(r).find("input[name='color']").val(a);
              $(r).data("colorpicker", a);
            }));
        }
        void 0 === c.params.listonchange && (c.params.listonchange = !1);
        c.params.listonchange
          ? $(r + "[name='listonchange']").prop("checked", !0)
          : $(r + "[name='listonchange']").prop("checked", !1);
        !1 !== c.params.changeable
          ? $(r + "[name='locked']").prop("checked", !1)
          : $(r + "[name='locked']").prop("checked", !0);
        c.params.sticky
          ? $(r + "[name='sticky']").prop("checked", !0)
          : $(r + "[name='sticky']").prop("checked", !1);
        $(r + "[id='includejson']").prop("checked", a.globalOpts.regIncludeJSON);
        $(r + "[id='includecomments']").prop("checked", a.globalOpts.regIncludeComments);
        $(r + "[id='savedcoords']").prop("checked", a.globalOpts.regSaveDCoords);
        $(r + "[id='includewcs']").prop("checked", a.globalOpts.csvIncludeWCS);
        $(r).find("input[name='saveformat']").prop("checked", !1);
        $(r)
          .find("input[value='" + a.globalOpts.regSaveFormat + "']")
          .prop("checked", !0);
        $(r).find("input[name='rwcsbutton']").prop("checked", !1);
        $(r)
          .find("input[value='" + (a.globalOpts.regSaveWCS || w) + "']")
          .prop("checked", !0);
        p =
          "save" === b.type
            ? "save" + a.globalOpts.regSaveWhich1
            : "save" + a.globalOpts.regSaveWhich2;
        $(r + "[id='" + p + "']").prop("checked", !0);
        "save" === b.type && $(r).find("input[name='savefile']").trigger("change");
        $(r).find("input[name='strokeMenu']").prop("selectedIndex", 0);
        $(r).find("input[name='dashesMenu']").prop("selectedIndex", 0);
        if (q)
          if (
            ($(r).find(".regid").hide(),
            $(r).find(".edit").hide(),
            $(r).find(".childtext").hide(),
            $(r).find(".multi").removeClass("nodisplay"),
            0 >= b.setmode)
          )
            ($(r).find("[name='multitext']").val(""),
              $(r).find('input[name="color"]').val(""),
              $(r).find('input[name="strokeWidth"]').val(""),
              $(r).find('input[name="strokeDashes"]').val(""),
              $(r).data("strokewidth", ""),
              $(r).data("strokedashes", ""),
              0 > b.setmode &&
                ($(r).find("[name='selectfilter']").val(""), $(r).data("selectfilter", "")));
          else if (
            (y = this.layers.regions.canvas.getActiveObject()) &&
            "group" === y.type &&
            !y.params
          ) {
            if ((p = y.getObjects()) && p.length && p[0] && p[0].params)
              var D = p[0].params.groupid;
            D
              ? ($(r).find("[name='selectfilter']").val(D),
                $(r).data("selectfilter", D),
                (p = this.listGroups(D)),
                (A = p.substring(p.indexOf("\n") + 1)),
                $(r).find("[name='multitext']").val(A))
              : $(r).find("[name='multitext']").val("");
          } else if (y) {
            y = this.layers.regions.canvas.getActiveObjects();
            e = 0;
            p = [];
            for (A = ""; e < y.length; e++)
              ((D = y[e]),
                "group" !== D.type || D.params ? p.push(D) : (A += this.lookupGroup(D) + "\n"));
            B = this.listRegions(p, { mode: 1, includejson: !1, includecomments: !1 }).replace(
              / *; */g,
              "\n"
            );
            if ((A += B.substring(B.indexOf("\n") + 1)))
              ((C = "selected"),
                $(r).find("[name='selectfilter']").val(C),
                $(r).data("selectfilter", C),
                $(r).find("[name='multitext']").val(A));
          } else {
            if (
              ((p = $(r).find("[name='selectfilter']").val() || "selected"),
              (A = this.listRegions(p, { mode: 1, includejson: !1, includecomments: !1 }).replace(
                / *; */g,
                "\n"
              )))
            )
              ($(r).find("[name='selectfilter']").val(p),
                $(r).data("selectfilter", p),
                $(r).find("[name='multitext']").val(A));
          }
        else
          switch (
            ($(r)
              .find("input:text[readonly]")
              .css("border-color", "#A5A5A5")
              .css("background", "#E9E9E9"),
            $(r)
              .find("input:text:not([readonly])")
              .css("border-color", "#E9E9E9")
              .css("background", "white"),
            c.pub.shape)
          ) {
            case "box":
            case "cross":
            case "ellipse":
              $(r + ".angle").removeClass("nodisplay");
              break;
            case "text":
              $(r + ".textangle").removeClass("nodisplay");
              break;
            case "line":
              c.pub.pts && 2 === c.pub.pts.length
                ? ($(r + ".linelength").removeClass("nodisplay"),
                  $(r + ".lineangle").removeClass("nodisplay"))
                : ($(r + ".linelength").addClass("nodisplay"),
                  $(r + ".lineangle").addClass("nodisplay"));
          }
        $(r + ".xtrareg").addClass("nodisplay");
        $(r + ".xtracsv").addClass("nodisplay");
        $(r + ".xtrasvg").addClass("nodisplay");
        $(r + ".xtra" + a.globalOpts.regSaveFormat).removeClass("nodisplay");
        $(r).data("im", this);
        $(r).data("shape", c);
        $(r).data("winid", v);
        $(r).data("multi", q);
        a.BROWSER[3]
          ? ((v = "touchstart"), (D = "touchend"))
          : ((v = "mouseover"), (D = "mouseout"));
        if ("save" === b.type)
          $(r).on(v, function () {
            $(r).find("input[name='savefile']").focus();
          });
        $(r).data("tooltipInit") ||
          ($(r).data("tooltipInit", !0),
          $(".rconfigcol_R, .rsavecol_R").on(v, function (b) {
            var c = b.currentTarget;
            b = $(c).find("input, textarea, span").data("tooltip");
            c = $(c).closest(a.lightOpts[a.LIGHTWIN].top).find(a.lightOpts[a.LIGHTWIN].dragBar);
            b &&
              c.length &&
              ((k = $(c)[0].childNodes[0].nodeValue.replace(/:.*/, "")),
              ($(c)[0].childNodes[0].nodeValue = k + ": " + b));
          }),
          $(".rconfigcol_R, .rsavecol_R").on(D, function (b) {
            b = $(b.currentTarget)
              .closest(a.lightOpts[a.LIGHTWIN].top)
              .find(a.lightOpts[a.LIGHTWIN].dragBar);
            b.length &&
              ((k = $(b)[0].childNodes[0].nodeValue.replace(/:.*/, "")),
              ($(b)[0].childNodes[0].nodeValue = k));
          }));
      }
    }
  };
  a.Regions.processConfigForm = function (c, b, d) {
    var e,
      f = 1;
    var g = { type: "multi", pub: { shape: "multi" }, params: {} };
    var h = d.length,
      l = {},
      m = this.raw.wcsinfo || { cdelt1: 1, cdelt2: 1 },
      k = function (a) {
        if (void 0 !== a)
          return (
            "number" === typeof a && 0 !== a % 1 && (a = Math.round(1e4 * (a + 1e-5)) / 1e4),
            String(a)
          );
      },
      q = function (a, b) {
        return w ? !0 : void 0 === a ? !1 : k(a) !== k(b);
      },
      u = function (b, c, d) {
        if ("remove" === c) return "selected" === d;
        if ("childtext" === c)
          return b.params.children && 0 < b.params.children.length
            ? b.params.children[0].obj && b.params.children[0].obj.params
              ? d !== b.params.children[0].obj.params.text
              : !1
            : d !== b.params.text;
        if ("strokeWidth" === c) return b.params && b.params.sw1 ? d !== b.params.sw1 : !0;
        if ("strokeDashes" === c) {
          if (b.strokeDashArray) return JSON.stringify(b.strokeDashArray) !== JSON.stringify(d);
          if ($.isArray(d))
            switch (d.length) {
              case 0:
                return !1;
              case 1:
                return "" !== d[0];
              default:
                return "" !== d[0] && "" !== d[1];
            }
          else return "" !== d;
        }
        if ("tags" !== c && "" === d) return !1;
        if (("misc" === c && "" !== d) || ("radii" === c && b.params.radii)) return !0;
        if ("angle" === c) return b.angle !== -parseFloat(d);
        if ("ix" === c)
          return b.pub.preservedcoords && "d" === d.charAt(0).toLowerCase()
            ? q(b.pub.dx, a.saostrtod(d.substring(1)))
            : q(b.pub.x, a.saostrtod(d));
        if ("iy" === c)
          return b.pub.preservedcoords && "d" === d.charAt(0).toLowerCase()
            ? q(b.pub.dy, a.saostrtod(d.substring(1)))
            : q(b.pub.y, a.saostrtod(d));
        if ("px" === c && b.pub.lcs) return q(b.pub.lcs.x.toFixed(1), d);
        if ("py" === c && b.pub.lcs) return q(b.pub.lcs.y.toFixed(1), d);
        if ("ra" === c)
          return b.pub.wcsconfig && b.pub.wcsconfig.wcsposstr
            ? q(a.saostrtod(b.pub.wcsconfig.wcsposstr[0]), a.saostrtod(d))
            : b.pub.wcsposstr
              ? q(a.saostrtod(b.pub.wcsposstr[0]), a.saostrtod(d))
              : !1;
        if ("dec" === c) {
          if (b.pub.wcsconfig && b.pub.wcsconfig.wcsposstr)
            return q(a.saostrtod(b.pub.wcsconfig.wcsposstr[1]), a.saostrtod(d));
          if (b.pub.wcsposstr) return q(a.saostrtod(b.pub.wcsposstr[1]), a.saostrtod(d));
        }
        return "sticky" === c
          ? w
            ? !1
            : q(b.pub.sticky || !1, d)
          : "locked" === c
            ? w
              ? !1
              : !1 !== b.params.changeable
                ? !1 === d
                : !0 === d
            : "listonchange" === c && w
              ? !1
              : b.pub.lcs && void 0 !== b.pub.lcs[c]
                ? q(b.pub.lcs[c], d)
                  ? !0
                  : !1
                : q(b.pub[c], d) || q(b.params[c], d) || q(b[c], d)
                  ? !0
                  : !1;
      },
      p = function (b) {
        return "true" === b ? !0 : "false" === b ? !1 : a.isNumber(b) ? parseFloat(b) : b;
      },
      n = function (a) {
        var b = String.fromCharCode(13, 10);
        return "string" === typeof a ? a.replace(/\\n/g, b) : a;
      };
    this.lcs &&
      this.lcs.physical &&
      (f = Math.sqrt(
        Math.pow(this.lcs.physical.forward[0][0], 2) + Math.pow(this.lcs.physical.forward[0][1], 2)
      ));
    if (b && b.pub)
      var x =
        b.pub.wcsconfig && b.pub.wcsconfig.wcssys ? b.pub.wcsconfig.wcssys : this.params.wcssys;
    else ((x = this.params.wcssys), (b = g));
    var w = $(c).data("multi");
    g = b.pub.layer || "regions";
    for (e = 0; e < h; e++) {
      var t = d[e].name;
      var v = d[e].value;
      if ("xpos" === t || "ypos" === t)
        switch (x) {
          case "image":
            t = "i" + t.charAt(0);
            break;
          case "physical":
            t = "p" + t.charAt(0);
            break;
          default:
            t = this.validWCS() ? ("xpos" === t ? "ra" : "dec") : "xpos" === t ? "ix" : "iy";
        }
      switch (t) {
        case "multitext":
        case "colorPicker":
        case "savefile":
        case "rwcsbutton":
        case "savewcs":
        case "saveformat":
        case "includejson":
        case "includecomments":
        case "savewhich":
        case "savedcoords":
          break;
        case "text":
          "text" === b.type && u(b, t, v) && (l[t] = n(v));
          break;
        case "selectfilter":
          if (v && v !== $(c).data("selectfilter")) {
            $(c).data("selectfilter", v);
            this.lookupGroup(v) ? this.groupShapes(g, v) : this.selectShapes(g, v);
            return;
          }
          break;
        case "strokeDashes":
          if ("" === v) l.strokeDashArray = [];
          else {
            var r = v.trim().split(/\s+/);
            if ((w && v) || u(b, t, r))
              l.strokeDashArray =
                0 === r.length
                  ? []
                  : r.map(function (a) {
                      return parseInt(a, 10);
                    });
          }
          break;
        case "strokeWidth":
          if ("" === v) l[t] = "";
          else if (a.isNumber(v))
            if (((r = parseInt(v, 10)), 0 >= r)) l[t] = "";
            else if ((w && v) || (!w && u(b, t, r))) l[t] = p(r);
          break;
        case "color":
          "" === v ? (l[t] = "") : u(b, t, v) && (l[t] = p(v));
          break;
        case "tags":
          w ? v && (l[t] = '""' === v || "''" === v ? "" : p(v)) : u(b, t, v) && (l[t] = p(v));
          break;
        case "childtext":
          "text" !== b.type && u(b, t, v) && (l.text = n(v));
          break;
        case "ix":
          u(b, t, v) &&
            (b.pub.preservedcoords && "d" === v.charAt(0).toLowerCase()
              ? ((l.dx = p(v.substring(1))),
                void 0 === l.dy && void 0 !== b.pub.dy && (l.dy = b.pub.dy))
              : ((l.x = p(v)), void 0 === l.y && void 0 !== b.pub.y && (l.y = b.pub.y)));
          break;
        case "iy":
          u(b, t, v) &&
            (b.pub.preservedcoords && "d" === v.charAt(0).toLowerCase()
              ? ((l.dy = p(v.substring(1))),
                void 0 === l.dx && void 0 !== b.pub.dx && (l.dx = b.pub.dx))
              : ((l.y = p(v)), void 0 === l.x && void 0 !== b.pub.x && (l.x = b.pub.x)));
          break;
        case "px":
          u(b, t, v) && ((l.px = p(v)), void 0 === l.py && b.pub.lcs && (l.py = b.pub.lcs.y));
          break;
        case "py":
          u(b, t, v) && ((l.py = p(v)), void 0 === l.px && b.pub.lcs && (l.px = b.pub.lcs.x));
          break;
        case "ra":
          u(b, t, v) &&
            ((l.ra = v),
            void 0 === l.dec &&
              (b.pub.wcsconfig && b.pub.wcsconfig.wcsposstr
                ? (l.dec = b.pub.wcsconfig.wcsposstr[1])
                : b.pub.wcsposstr && (l.dec = b.pub.wcsposstr[1])));
          break;
        case "dec":
          u(b, t, v) &&
            ((l.dec = v),
            void 0 === l.ra &&
              (b.pub.wcsconfig && b.pub.wcsconfig.wcsposstr
                ? (l.ra = b.pub.wcsconfig.wcsposstr[0])
                : b.pub.wcsposstr && (l.ra = b.pub.wcsposstr[0])),
            void 0 === l.wcssys && (l.wcssys = x));
          break;
        case "wcssys":
          break;
        case "radius":
        case "length":
        case "width":
        case "r1":
          switch (x) {
            case "image":
              u(b, t, v) && (l[t] = p(v));
              break;
            case "physical":
              u(b, t, v) && (l[t] = p(v) * f);
              break;
            default:
              ((r = a.strtoscaled(v)),
                (v =
                  "." === r.dtype && "galactic" !== x && "ecliptic" !== x
                    ? r.dval
                    : Math.abs(r.dval / m.cdelt1)),
                (t = t.replace("wcs", "")),
                u(b, t, v) && (l[t] = p(v)));
          }
          break;
        case "height":
        case "r2":
          switch (x) {
            case "image":
              u(b, t, v) && (l[t] = p(v));
              break;
            case "physical":
              u(b, t, v) && (l[t] = p(v) * f);
              break;
            default:
              ((r = a.strtoscaled(v)),
                (v =
                  "." === r.dtype && "galactic" !== x && "ecliptic" !== x
                    ? r.dval
                    : Math.abs(r.dval / m.cdelt2)),
                (t = t.replace("wcs", "")),
                u(b, t, v) && (l[t] = p(v)));
          }
          break;
        case "radii":
          u(b, t, v) && (l[t] = v);
          break;
        case "linelength":
          if (b.pub.pts && 2 === b.pub.pts.length && a.isNumber(v) && v !== this.tmp.linelength) {
            v = parseFloat(v);
            switch (x) {
              case "image":
              case "physical":
                break;
              default:
                void 0 !== m.cdelt1
                  ? (v /= Math.abs(m.cdelt1))
                  : void 0 !== m.cdelt2 && (v /= Math.abs(m.cdelt2));
            }
            l.pts ? ((t = l.pts[0]), (r = l.pts[1])) : ((t = b.pub.pts[0]), (r = b.pub.pts[1]));
            if (0 <= $.inArray("line", a.Regions.opts.noCenteredScaling)) {
              var z = Math.sqrt((t.x - r.x) * (t.x - r.x) + (t.y - r.y) * (t.y - r.y));
              var y = t.x - (v * (t.x - r.x)) / z;
              v = t.y - (v * (t.y - r.y)) / z;
              l.pts = [t, { x: y, y: v }];
            } else
              ((y = { x: (t.x + r.x) / 2, y: (t.y + r.y) / 2 }),
                (z = parseFloat(this.tmp.lineangle) || 0),
                (t.x = y.x - v / 2),
                (t.y = y.y),
                (r.x = y.x + v / 2),
                (r.y = y.y),
                (l.pts = [a.rotatePoint(t, z, y), a.rotatePoint(r, z, y)]));
          }
          break;
        case "lineangle":
          b.pub.pts &&
            2 === b.pub.pts.length &&
            a.isNumber(v) &&
            v !== this.tmp.lineangle &&
            ((z = parseFloat(v) - parseFloat(this.tmp.lineangle) || 0),
            l.pts ? ((t = l.pts[0]), (r = l.pts[1])) : ((t = b.pub.pts[0]), (r = b.pub.pts[1])),
            0 <= $.inArray("line", a.Regions.opts.noCenteredScaling)
              ? (l.pts = [t, a.rotatePoint(r, z, t)])
              : ((y = { x: (t.x + r.x) / 2, y: (t.y + r.y) / 2 }),
                (l.pts = [a.rotatePoint(t, z, y), a.rotatePoint(r, z, y)])));
          break;
        case "remove":
          u(b, t, v) && (w ? (l[t] = "selected") : void 0 !== b.pub.id && (l[t] = b.pub.id));
          break;
        case "locked":
          u(b, t, !p(v)) && (l.changeable = !p(v));
          break;
        case "misc":
          if (v.trim())
            try {
              var A = JSON.parse(v);
              $.extend(l, A);
            } catch (B) {
              a.error("invalid json: " + v);
            }
          break;
        default:
          u(b, t, v) && (l[t] = p(v));
      }
    }
    0 < Object.keys(l).length &&
      ((c = w
        ? $(c).find("[name='selectfilter']").val() || "selected"
        : $(c).find("[name='id']").val() || b),
      this.changeShapes(g, c, l),
      this.initRegionsForm(b, { multi: w }));
  };
  a.Regions.regionsConfigSetSelectFilter = function (c, b) {
    var d = [];
    var e = [],
      f = [],
      g = c.closest("form"),
      h = g.find("[name='selectfilter']"),
      l = g.data("im");
    g = function (a) {
      if (!a) return "";
      a = a.trim();
      return "(" === a.charAt(0) && ")" === a.charAt(a.length - 1) ? a : "(" + a + ")";
    };
    if (l) {
      f = l.listGroups("all", { includeregions: !1 }).split("\n");
      var m = c.val().trim();
      var k = h.val().trim();
      if ("other" === b && "saved" === m)
        ((b = l.layers.regions.selection || "") && k && (b = g(b) + " && " + g(k)), h.val("" + b));
      else {
        k && (d = k.split(/\s+/));
        if (d.length && ((d = d[d.length - 1]), !m.match(/[&|]/) && !d.match(/[&|!]/))) {
          switch (b) {
            case "regions":
              e = a.regions;
              break;
            case "wcssys":
              e = a.wcssyss;
              break;
            case "groups":
              e = f;
              break;
            case "ops":
              e = ["!", "&&", "||"];
          }
          m =
            0 <= $.inArray(d, e)
              ? "|| " + m
              : 0 <= $.inArray(d, f) || 0 <= $.inArray(m, f)
                ? "|| " + m
                : "&& " + m;
        }
        d = k + " " + m;
        if (a.globalOpts.regConfigAddParens) {
          d = d.split("||");
          if (2 <= d.length)
            for (k = 0; k < d.length; k++)
              ((b = d[k].trim()), 0 < b.indexOf("&&") ? (d[k] = g(b)) : (d[k] = b));
          d = d.join(" || ").replace(/  */g, " ");
        }
        h.val(d);
      }
      c.prop("selectedIndex", 0);
    }
  };
  a.Regions.regionsConfigSetSelectMenu = function (a, b, d) {
    var c, f;
    d.match(/^select/) || (d = "select" + d);
    b = b.find("[name='" + d + "']");
    var g = b[0];
    for (c = g.options.length - 1; 1 <= c; c--) g.remove(c);
    g = a.getShapes("regions", "all");
    switch (d) {
      case "selectshape":
        a = 0;
        for (f = []; a < g.length; a++)
          ((c = g[a].shape),
            0 > $.inArray(c, f) && (b.append("<option>" + c + "</option>"), f.push(c)));
        break;
      case "selectcolor":
        a = 0;
        for (f = []; a < g.length; a++)
          ((c = g[a].color),
            0 > $.inArray(c, f) && (b.append("<option>" + c + "</option>"), f.push(c)));
        break;
      case "selecttag":
        a = 0;
        for (f = []; a < g.length; a++)
          for (c = g[a].tags, d = 0; d < c.length; d++)
            0 > $.inArray(c[d], f) && (b.append("<option>" + c[d] + "</option>"), f.push(c[d]));
        break;
      case "selectwcs":
        a = 0;
        for (f = []; a < g.length; a++)
          g[a].wcsconfig &&
            ((c = g[a].wcsconfig.wcssys),
            0 > $.inArray(c, f) && (b.append("<option>" + c + "</option>"), f.push(c)));
        break;
      case "selectgroup":
        if ((c = a.listGroups("all", { includeregions: !1 })))
          for (g = c.split("\n"), a = 0; a < g.length; a++)
            b.append("<option>" + g[a] + "</option>");
    }
  };
  a.Regions.regionsConfigSetSelectOrGroup = function (c, b, d, e) {
    var f = b.find('[name="selectfilter"]');
    var g = b.find('[name="multitext"]'),
      h = f.val().trim();
    if (c) {
      var l = c.layers.regions.canvas;
      !1 === e && (c.tmp.updateMulti = !1);
      h ||
        (f.val(""),
        g.val(""),
        b.data("selectfilter", ""),
        l.getActiveObject() && l.discardActiveObject(),
        l.renderAll(),
        (d = "clear"));
      d || (d = c.lookupGroup(h) ? "group" : "select");
      switch (d) {
        case "select":
          b.data("selectfilter", h);
          c.selectShapes("regions", h, { transparentgroup: !1 });
          break;
        case "group":
          b.data("selectfilter", h);
          d = c.groupShapes("regions", h);
          f.val(d);
          g.val(c.listGroups(d));
          if ((f = c.lookupGroup(d)))
            (l.setActiveObject(f),
              l.renderAll(),
              a.Regions.regionsConfigSetSelectMenu(c, b, "selectgroup"));
          break;
        case "ungroup":
          c.ungroupShapes("regions", h);
          f.val("");
          g.val("");
          b.data("selectfilter", "");
          l.getActiveObject() && l.discardActiveObject();
          a.Regions.regionsConfigSetSelectMenu(c, b, "selectgroup");
          break;
        case "clear":
          (b.find('input[name="color"]').val(""),
            b.find('input[name="strokeWidth"]').val(""),
            b.find('input[name="strokeDashes"]').val(""),
            b.data("strokewidth", ""),
            b.data("strokedashes", ""));
      }
      delete c.tmp.updateMulti;
    }
  };
  a.Regions.pasteFromClipboard = function (c) {
    var b,
      d = 0,
      e = 0;
    if (this) {
      (b = a.CopyFromClipboard().trim()) || a.error(a.CLIPBOARDERROR);
      if (b.match(/(annulus|box|circle|cross|ellipse|line|polygon|point|text) *\(/)) {
        var f = a.globalOpts.regToClipboard;
        a.globalOpts.regToClipboard = !1;
        var g = this.addShapes("regions", b, { rtn: "objs" });
        if (c) {
          var h = g.length;
          for (c = 0; c < h; c++) ((d += g[c].pub.x), (e += g[c].pub.y));
          d /= h;
          e /= h;
          for (c = 0; c < h; c++) {
            var l = g[c].pub.x - d + this.ipos.x;
            var m = g[c].pub.y - e + this.ipos.y;
            this.changeShapes("regions", g[c].pub.id, { x: l, y: m });
          }
        }
        a.globalOpts.regToClipboard = f;
      } else a.error(a.CLIPBOARDERROR2);
      return b;
    }
  };
  a.Regions.listRegions = function (c, b, d) {
    var e = this,
      f,
      g,
      h,
      l,
      m = "";
    var k = "none";
    var q = !1,
      u = [];
    var p = {};
    var n = [],
      x = [],
      w = function (c, d) {
        var f,
          g = {},
          h = c.params,
          k = h.children,
          l = h.exports;
        for (f = 0; f < l.length; f++) {
          var m = l[f];
          if (("text" !== m || "text" === c.type) && "textOpts" !== m) {
            if ("strokeDashArray" === m && c.strokeDashArray) {
              var n = c.strokeDashArray.join("");
              if ("" === n || n.match(/NaN/)) continue;
            }
            ("id" === m && b.file) ||
              ("wcsconfig" === m && b.file) ||
              ("data" === m && "object" === typeof h.data && !1 === h.data.doexport && b.file) ||
              ("strokeWidth" === m && h.sw1
                ? (g[m] = h.sw1)
                : void 0 !== c[m]
                  ? (g[m] = c[m])
                  : void 0 !== h[m]
                    ? (g[m] = h[m])
                    : d && void 0 !== d[m] && (g[m] = d[m]));
          }
        }
        if (0 < k.length && k[0].obj.text) {
          n = k[0].obj;
          g.text = n.text;
          g.textOpts = w(n);
          if (c.angle !== n.angle) {
            if (
              ((g.textOpts.angle = -n.angle),
              "circle" === c.params.shape || "annulus" === c.params.shape)
            )
              n.params.hasTextOpts = !0;
          } else
            0 === n.angle ||
              ("circle" !== c.params.shape && "annulus" !== c.params.shape) ||
              ((g.textOpts.angle = -n.angle), (n.params.hasTextOpts = !0));
          if (n.params.parent.moved || n.params.hasTextOpts)
            n.pub.ra && n.pub.dec
              ? (r && z && r !== z
                  ? ((n = e.wcs2wcs(r, z, n.pub.ra, n.pub.dec)),
                    (n = n.trim().split(/\s+/)),
                    (d = a.saostrtod(n[0])),
                    a.isHMS(z) && (d *= 15),
                    (n = a.saostrtod(n[1])))
                  : ((d = n.pub.ra), (n = n.pub.dec)),
                (g.textOpts.ra = d),
                (g.textOpts.dec = n))
              : n.pub.lcs
                ? ((g.textOpts.px = n.pub.lcs.x), (g.textOpts.py = n.pub.lcs.y))
                : ((g.textOpts.x = n.pub.x), (g.textOpts.y = n.pub.y));
          g.textOpts.color === c.stroke && delete g.textOpts.color;
          g.textOpts.text && delete g.textOpts.text;
          Object.keys(g.textOpts).length || delete g.textOpts;
        }
        return g;
      };
    b = b || {};
    if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (D) {
        a.error("can't parse listRegions opts: " + b, D);
      }
    var t = b.mode;
    a.isNull(t) && (t = 3);
    d = d || "regions";
    if (this.getShapeLayer(d)) {
      if (b.wcssys || b.wcsunits) {
        var v = a.globalOpts.xeqPlugins;
        a.globalOpts.xeqPlugins = !1;
        if (b.wcssys) {
          var r = this.getWCSSys();
          this.setWCSSys(b.wcssys, !1);
          var z = this.getWCSSys();
        }
        if (b.wcsunits) {
          var y = this.getWCSUnits();
          this.setWCSUnits(b.wcsunits, !1);
        }
        this.updateShapes(d, c, "export");
      }
      a.isNull(b.includedcoords) && (b.includedcoords = a.globalOpts.regListDCoords);
      u = this.getShapes(d, c, { includeObj: !0 });
      var A = u.length;
      if (t)
        for (f = 0; f < A; f++) {
          var B = u[f];
          if ((g = B.tags.join(",")) && "source,include" !== g && "include,source" !== g) {
            q = !0;
            break;
          }
        }
      for (C in a.Regions.opts.tagcolors)
        Object.prototype.hasOwnProperty.call(a.Regions.opts.tagcolors, C) &&
          x.push(a.Regions.opts.tagcolors[C]);
      for (f = 0; f < A; f++)
        if (((B = u[f]), (p = B.obj), (n = []), !B.sticky || !1 !== b.sticky))
          if (!B.preservedcoords || b.includedcoords)
            if (!B.ignore || b.ignoreignore)
              if ($.isArray(p.params.preservedcoords)) {
                for (g = 0; g < p.params.preservedcoords.length; g++) {
                  var C = p.params.preservedcoords[g];
                  switch (C) {
                    case "pts":
                      0 > $.inArray("dx", n) && n.push("dx");
                      0 > $.inArray("dy", n) && n.push("dy");
                      0 > $.inArray("points", n) && n.push("points");
                      break;
                    default:
                      n.push(C);
                  }
                }
                "none" !== k && (m += "; ");
                "image" !== k && ((m += "image"), (m += "; "));
                m += B.shape + "({";
                for (l = g = 0; g < n.length; g++)
                  if (((C = n[g]), "shape" !== C && "sticky" !== C && "wcsconfig" !== C)) {
                    "pts" === C &&
                      ((C = "dx"),
                      p.params.preservedcoords.push("dy"),
                      p.params.preservedcoords.push("points"));
                    if ("preservedcoords" === C) k = !0;
                    else if (a.notNull(B[C])) k = B[C];
                    else if (a.notNull(p[C])) k = p[C];
                    else
                      switch (C) {
                        case "dx":
                          k = p.left;
                          break;
                        case "dy":
                          k = p.top;
                          break;
                        case "color":
                          k = p.stroke;
                          break;
                        default:
                          k = null;
                      }
                    if (k)
                      switch ((0 < l++ && (m += ","), (m += '"' + C + '":'), typeof k)) {
                        case "string":
                          m += '"' + k + '"';
                          break;
                        case "object":
                          try {
                            m += JSON.stringify(k);
                          } catch (D) {
                            a.error("can't parse: " + k, D);
                          }
                          break;
                        default:
                          m += "" + k;
                      }
                  }
                m += "})";
                k = "image";
              } else
                ((g = B.tags.join(",")),
                  (C = g.includes("exclude") ? "-" : ""),
                  (p = w(p, B)),
                  b.saveid ? (p.id = B.id) : delete p.id,
                  b.savewcsconfig && B.wcsconfig && 0 < Object.keys(B.wcsconfig).length
                    ? (p.wcsconfig = $.extend(!0, {}, B.wcsconfig))
                    : delete p.wcsconfig,
                  B.color && !x.includes(B.color) && (p.color = B.color),
                  q && (h = " # " + g),
                  b.saveediting || delete p.editing,
                  B.wcsstr && a.isWCSSys(this.params.wcssys)
                    ? ("wcs" !== k &&
                        ("none" !== k && (m += "; "),
                        (m = B.wcssys ? m + B.wcssys : m + this.params.wcssys),
                        (k = "wcs")),
                      (m += "; " + C + B.wcsstr))
                    : B.imstr &&
                      (k !== B.imsys &&
                        ("none" !== k && (m += "; "), (m += B.imsys), (k = B.imsys)),
                      (m += "; " + C + B.imstr)),
                  !1 !== b.includejson &&
                    1 === t % 2 &&
                    0 < Object.keys(p).length &&
                    ("line" === B.shape && (m = m.replace(/ *{[^{}]*}$/, "")),
                    (m += " " + JSON.stringify(p))),
                  h && (m += h));
      !1 === b.includecomments && (m = m.replace(/ *#[^;]*/g, ""));
      if (r || y)
        (r && this.setWCSSys(r, !1),
          y && this.setWCSUnits(y, !1),
          this.updateShapes(d, c, "export"),
          (a.globalOpts.xeqPlugins = v));
      1 < t && this.display.displayMessage("regions", m);
      return m;
    }
  };
  a.Regions.copyRegions = function (a, b) {
    return this.copyShapes("regions", a, b);
  };
  a.Regions.parseRegions = function (c, b) {
    var d = this,
      e,
      f,
      g = [],
      h = /^-?(annulus|box|circle|cross|ellipse|line|polygon|point|text)$/,
      l = /^(fk4|fk5|icrs|galactic|ecliptic|image|physical|linear)$/,
      m = /^(image|physical)$/,
      k = /[dr:]/,
      q = /\(\s*([^)]+?)\s*\)/,
      u = /(\{.*\})/,
      p = /\s*,\s*/,
      n = /#(?![a-zA-Z0-9]{6}['"])/,
      x = function (a) {
        return "0" === a || "false" === a.toLowerCase() ? !1 : !0;
      },
      w = function (a) {
        for (
          var b,
            c,
            d,
            e = {},
            f = /([a-zA-Z][a-zA-Z0-9_]*)\s*=\s*(\d+(\s*\d+)*|[^ '"{]+|['"{][^'"}]*['"}])/g,
            g = {
              color: function (a) {
                return { color: a };
              },
              dash: function (a) {
                if (a) return { strokeDashArray: [3, 1] };
              },
              dashlist: function (a) {
                if (a) {
                  var b = a.split(" ");
                  for (a = 0; a < b.length; a++) b[a] = parseFloat(b[a]);
                  return { strokeDashArray: b };
                }
              },
              delete: function (a) {
                return { removable: x(a) };
              },
              edit: function (a) {
                return { selectable: x(a) };
              },
              fixed: function (a) {
                return { zoomable: !x(a) };
              },
              font: function (a) {
                var b = {};
                a = a.split(" ");
                var c = a.length;
                1 <= c && (b.fontFamily = a[0]);
                2 <= c && (b.fontSize = parseFloat(a[1]));
                3 <= c && (b.fontStyle = a[2]);
                4 <= c && (b.fontWeight = a[3]);
                return b;
              },
              highlite: function (a) {
                return { hasControls: x(a), hasBorders: x(a), hasRotatingPoint: x(a) };
              },
              move: function (a) {
                return { movable: x(a) };
              },
              rotate: function (a) {
                return { rotatable: x(a) };
              },
              resize: function (a) {
                return { resizable: x(a) };
              },
              changeable: function (a) {
                return { changeable: x(a) };
              },
              select: function (a) {
                return { selectable: x(a) };
              },
              text: function (a) {
                return { text: a };
              },
              tag: function (a) {
                return { tags: a };
              },
              width: function (a) {
                return { strokeWidth: parseFloat(a) };
              },
            };
          null !== (b = f.exec(a));

        )
          if (
            ((c = b[1].toLowerCase()),
            (b = b[2].replace(/^['"{]|['"}]$/g, "")),
            Object.prototype.hasOwnProperty.call(g, c) && "function" === typeof g[c])
          )
            for (d in ((c = g[c](b)), c))
              Object.prototype.hasOwnProperty.call(c, d) &&
                ("tags" === d && Object.prototype.hasOwnProperty.call(e, d)
                  ? (e[d] += "," + c[d])
                  : (e[d] = c[d]));
          else e[c] = b;
        if ((a = a.replace(f, ""))) e._comment = a.trim();
        return e;
      },
      t = function (b) {
        var c,
          d = { opts: {}, args: [], isregion: 0 };
        b.includes("(")
          ? (d.cmd = b.split("(")[0].trim().toLowerCase())
          : b.includes("{")
            ? (d.cmd = b.split("{")[0].trim().toLowerCase())
            : b.includes("#")
              ? (d.cmd = b.split("#")[0].trim().toLowerCase())
              : (d.cmd = b.trim().toLowerCase());
        d.cmd && (d.isregion = 0 <= d.cmd.search(h));
        var e = b.trim().split(n);
        if ((c = u.exec(e[0])) && c[0])
          try {
            d.opts = JSON.parse(c[0].trim());
          } catch (M) {
            a.error("can't parse opts: " + c[0], M);
          }
        d.comment = e[1];
        if (d.comment) {
          var f = w(d.comment.trim());
          void 0 !== f._comment && ((d.comment = f._comment), delete f._comment);
        }
        f && (d.opts = $.extend({}, f, d.opts));
        (c = q.exec(b)) && c[0].match(u) ? (d.args = []) : c && c[1] && (d.args = c[1].split(p));
        d.isregion &&
          d.cmd.startsWith("-") &&
          ((d.cmd = d.cmd.slice(1)),
          d.comment
            ? d.comment.match(/exclude/) || (d.comment += ",exclude")
            : (d.comment = "exclude"));
        return d;
      },
      v = function (b, c) {
        var e = {};
        if ("d" === b.charAt(0).toLowerCase() && "d" === c.charAt(0).toLowerCase())
          return ((e.dx = parseFloat(b.substring(1))), (e.dy = parseFloat(c.substring(1))), e);
        b = a.strtoscaled(b);
        c = a.strtoscaled(c);
        (!b.dtype.match(k) && !c.dtype.match(k)) || A || z.match(m) || ((C = !0), (y = z));
        if (A || C)
          return (
            a.isHMS(y, b.dtype) && (b.dval *= 15),
            "r" === b.dtype && (b.dval = (180 * b.dval) / Math.PI),
            "r" === c.dtype && (c.dval = (180 * c.dval) / Math.PI),
            (c = a.wcs2pix(d.raw.wcs, b.dval, c.dval).split(/ +/)),
            (e.x = parseFloat(c[0])),
            (e.y = parseFloat(c[1])),
            e
          );
        if ("physical" === y)
          return ((c = d.logicalToImagePos({ x: b.dval, y: c.dval })), (e.x = c.x), (e.y = c.y), e);
        e.x = b.dval;
        e.y = c.dval;
        return e;
      },
      r = function (b, c) {
        b = a.strtoscaled(b);
        var e = d.raw.wcsinfo || { cdelt1: 1, cdelt2: 1 };
        !b.dtype.match(k) || A || z.match(m) || ((C = !0), (y = z));
        A || C
          ? ("r" === b.dtype && (b.dval = (180 * b.dval) / Math.PI),
            0 !== a.REGSIZE && a.error("region size based on ang sep is not implemented"),
            (b.dval = Math.abs(b.dval / e["cdelt" + c])))
          : "physical" === y &&
            d.lcs &&
            d.lcs.physical &&
            ((c = Math.sqrt(
              Math.pow(d.lcs.physical.forward[0][0], 2) + Math.pow(d.lcs.physical.forward[0][1], 2)
            )),
            (b.dval = Math.abs(b.dval * c)));
        return b.dval;
      };
    c = c.trim();
    if (!c.match(/(\(|\{|#|;|\n)/)) return c;
    var z = this.getWCSSys();
    b = this.getWCSUnits();
    var y = "physical";
    var A = a.isWCSSys(y);
    var B = c.split(/\n|;/);
    for (c = 0; c < B.length; c++)
      if ("#" !== B[c].trim().substr(0, 1)) {
        var C = !1;
        var D = t(B[c]);
        var E = D.args.length;
        if (D.isregion) {
          var F = $.extend(!0, {}, D.opts);
          F.shape = D.cmd;
          F.wcsconfig = F.wcsconfig || { wcssys: y };
          2 <= E &&
            "line" !== F.shape &&
            "polygon" !== F.shape &&
            $.extend(F, v(D.args[0], D.args[1]));
          F.textOpts &&
            void 0 !== F.textOpts.ra &&
            void 0 !== F.textOpts.dec &&
            (F.textOpts._wcssys = y);
          switch (D.cmd) {
            case "annulus":
              if (0 < E) for (F.radii = [], e = 2; e < E; e++) F.radii.push(r(D.args[e], 1));
              break;
            case "box":
            case "cross":
              3 <= E && (F.width = r(D.args[2], 1));
              4 <= E && (F.height = r(D.args[3], 2));
              5 <= E && (F.angle = a.strtoscaled(D.args[4]).dval);
              break;
            case "circle":
              3 <= E && (F.radius = r(D.args[2], 1));
              break;
            case "ellipse":
              3 <= E && (F.r1 = r(D.args[2], 1));
              4 <= E && (F.r2 = r(D.args[3], 2));
              5 <= E && (F.angle = a.strtoscaled(D.args[4]).dval);
              break;
            case "line":
            case "polygon":
              if (0 < E)
                for (F.pts = [], f = e = 0; e < E; e += 2, f++) {
                  var G = v(D.args[e], D.args[e + 1]);
                  a.notNull(G.dx) && a.notNull(G.dy)
                    ? (F.pts[f] = { dx: G.dx, dy: G.dy })
                    : (F.pts[f] = { x: G.x, y: G.y });
                }
              break;
            case "text":
              (3 <= E && (F.text = D.args[2].replace(/^['"]/, "").replace(/["']$/, "")),
                4 <= E && (F.angle = a.strtoscaled(D.args[3]).dval));
          }
          D.comment && (F.tags = D.comment);
          g.push(F);
        } else
          D.cmd.match(l)
            ? ((e = a.globalOpts.xeqPlugins),
              (a.globalOpts.xeqPlugins = !1),
              this.setWCSSys(D.cmd, !1),
              (a.globalOpts.xeqPlugins = e),
              (y = this.getWCSSys()),
              (A = a.isWCSSys(y)))
            : ("remove" !== D.cmd && "delete" !== D.cmd) || g.push({ remove: !0 });
      }
    e = a.globalOpts.xeqPlugins;
    a.globalOpts.xeqPlugins = !1;
    this.setWCSSys(z, !1);
    this.setWCSUnits(b);
    a.globalOpts.xeqPlugins = e;
    return g;
  };
  a.Regions.saveRegions = function (c, b, d) {
    var e, f, g;
    c && (f = c.match(/\.([^.]*)$/)) && f[1] && f[1].match(/^(reg|svg|csv)$/) && (e = f[1]);
    if ("object" === typeof d) {
      var h = d;
      d = null;
    } else if (d && "string" === typeof d) {
      try {
        h = JSON.parse(d);
      } catch (u) {
        h = null;
      }
      h && (d = null);
    }
    h &&
      (a.notNull(h.layer) && (d = h.layer),
      a.notNull(h.type) && (e = h.type),
      a.notNull(h.format) && (e = h.format));
    h = h || {};
    d = d || "regions";
    e = e || "reg";
    this.layers[d] || a.error("can't find layer for saveRegions: " + d);
    c || (c = "regions" !== d ? "js9_" + d + "." + e : "js9." + e);
    switch (e) {
      case "svg":
        try {
          a.globalOpts.svgBorder &&
            (g = this.addShapes(d, "box", {
              left: this.rgb.img.width / 2,
              top: this.rgb.img.height / 2,
              width: this.rgb.img.width,
              height: this.rgb.img.height,
              color: "black",
              strokeWidth: 1,
              tags: "SVGBorder",
            }));
          var l = this.layers[d].dlayer.canvas.toSVG();
          a.globalOpts.svgBorder && this.removeShapes(d, g);
        } catch (u) {
          a.error("can't convert layer to SVG: " + d);
        }
        break;
      case "csv":
        try {
          h.mode = 1;
          h.file = c;
          a.isNull(h.includewcs) && (h.includewcs = a.globalOpts.csvIncludeWCS);
          a.isNull(h.savedcoords) && (h.includedcoords = a.globalOpts.regSaveDCoords);
          var m = this.listRegions(b, h, d);
          f = m.split(";");
          var k = 0;
          for (l = ""; k < f.length; k++)
            if (f[k])
              if (f[k].toLowerCase().match(a.WCSEXP)) h.includewcs && (l += f[k].trim() + "\n");
              else {
                var q = f[k].replace(/\(/, ",").replace(/\).*/, "").trim();
                l += q + "\n";
              }
        } catch (u) {
          a.error("can't convert layer to region: " + d);
        }
        break;
      default:
        try {
          ((h.mode = 1),
            (h.file = c),
            a.isNull(h.includejson) && (h.includejson = a.globalOpts.regIncludeJSON),
            a.isNull(h.includecomments) && (h.includecomments = a.globalOpts.regIncludeComments),
            a.notNull(h.savedcoords)
              ? (h.includedcoords = h.savedcoords)
              : (h.includedcoords = a.globalOpts.regSaveDCoords),
            (m = this.listRegions(b, h, d).replace(/; */g, "\n")),
            (l =
              !1 !== h.includecomments
                ? "# Region file format: JS9 version 1.0\n" + m + "\n"
                : m + "\n"));
        } catch (u) {
          a.error("can't convert layer to region: " + d);
        }
    }
    b = new Blob([l], { type: "text/plain;charset=utf-8" });
    Object.prototype.hasOwnProperty.call(window, "saveAs")
      ? a.saveAs(b, c)
      : a.error("no saveAs() available to save region file");
    return (this.tmp.saveregionsFile = c);
  };
  a.Regions.unremoveRegions = function () {
    var a = this.regstack.pop();
    return a ? this.addShapes("regions", a) : null;
  };
  a.Regions.changeRegionTags = function (a, b, d) {
    var c;
    a = a || "all";
    b = b || [];
    d = d || [];
    $.isArray(b) ||
      (b = b.split(",").map(function (a) {
        return a.trim();
      }));
    $.isArray(d) ||
      (d = d.split(",").map(function (a) {
        return a.trim();
      }));
    var f = this.getShapes("regions", a);
    for (a = 0; a < f.length; a++) {
      var g = f[a].tags;
      var h = [];
      for (c = 0; c < b.length; c++) 0 > $.inArray(b[c], g) && h.push(b[c]);
      for (c = 0; c < g.length; c++) 0 > $.inArray(g[c], d) && h.push(g[c]);
      this.changeShapes("regions", f[a].id, { tags: h });
    }
  };
  a.Regions.toggleRegionTags = function (a, b, d) {
    var c;
    var f = this.getShapes("regions", a || "all");
    for (a = 0; a < f.length; a++) {
      var g = f[a].tags;
      var h = "";
      for (c = 0; c < g.length; c++)
        if (g[c] === b) {
          h = g[c] = d;
          break;
        } else if (g[c] === d) {
          h = g[c] = b;
          break;
        }
      h && this.changeShapes("regions", f[a].id, { tags: g });
    }
  };
  a.Plot = {};
  a.Plot.CLASS = "JS9";
  a.Plot.NAME = "Plot";
  a.Plot.opts = {
    annotate: !1,
    annotateColor: "#FF0000",
    color: "blue",
    zoomStack: { enabled: !0 },
    selection: { mode: "xy" },
    series: { clickable: !0, hoverable: !0, lines: { show: !0 }, points: { show: !1 } },
    legend: { backgroundColor: null, backgroundOpacity: 0 },
    xaxis: { autorange: !0 },
    yaxis: { autorange: !0 },
    title: "Plot Configuration",
    configURL: "./params/plotconfig.html",
  };
  a.Plot.logfunc = function (a) {
    return 0 === a ? 0 : Math.log(a);
  };
  a.Plot.expfunc = function (a) {
    return 0 === a ? 0 : Math.exp(a);
  };
  a.Plot.rescale = function (c, b, d, e, f, g, h) {
    switch (a.globalOpts.plotLibrary) {
      case "flot":
        switch (e) {
          case "x":
            var l = b.getAxes().xaxis;
            break;
          case "y":
            l = b.getAxes().yaxis;
        }
        switch (f) {
          case "linear":
            l.options.transform = null;
            l.options.inverseTransform = null;
            d.curscale[e] = f;
            break;
          case "log":
            ((l.options.transform = a.Plot.logfunc),
              (l.options.inverseTransform = a.Plot.expfunc),
              (d.curscale[e] = f));
        }
        a.isNumber(g) ? (l.options.min = Number.parseFloat(g)) : "" == g && (l.options.min = null);
        a.isNumber(h) ? (l.options.max = Number.parseFloat(h)) : "" == h && (l.options.max = null);
        b.setupGrid();
        b.draw();
        break;
      case "plotly":
        switch (e) {
          case "x":
            var m = { xaxis: { type: f, autorange: !0 } };
            d.curscale[e] = f;
            break;
          case "y":
            ((m = { yaxis: { type: f, autorange: !0 } }), (d.curscale[e] = f));
        }
        Plotly.restyle(c.attr("id"), m);
    }
  };
  a.Plot.annotate = function (c, b, d) {
    var e;
    var f = [];
    var g = d.data,
      h = d.annotations.color || a.Plot.opts.annotateColor,
      l = function (a, b) {
        if (!a.text) return null;
        var c = a.x || 0;
        if ("%Y" === a.y.toUpperCase())
          for (a = 1; a < b.length - 1; a++) {
            if (b[a][0] > c) {
              var d = Math.max(b[a - 1][1], b[a][1], b[a + 1][1]);
              break;
            }
          }
        else d = a.y;
        return { x: c, y: d };
      };
    switch (a.globalOpts.plotLibrary) {
      case "flot":
        var m = -25;
        c.find(".plotAnnotation").remove();
        for (e = 0; e < d.annotations.data.length; e++) {
          var k = d.annotations.data[e];
          var q = l(k, g);
          f = b.pointOffset({ x: q.x, y: q.y });
          0 > f.left ||
            f.left > c.width() ||
            ((k = sprintf(
              "<div class='plotAnnotation' style='position: absolute; left: %spx; top:%spx; color: %s; font-size: small'>%s</div>",
              f.left,
              f.top + m,
              h,
              "&darr;" + k.text
            )),
            c.append(k));
        }
        break;
      case "plotly":
        m = -30;
        for (e = 0; e < d.annotations.data.length; e++)
          if (((k = d.annotations.data[e]), (q = l(k, g))))
            ((c = {
              x: q.x,
              y: q.y,
              xref: "x",
              yref: "y",
              text: k.text,
              arrowcolor: h,
              font: { color: h },
              showarrow: !0,
              arrowhead: 2,
              ax: 0,
              ay: m,
            }),
              f.push(c));
        return f;
    }
  };
  a.Plot.initConfigForm = function (c, b) {
    var d,
      e,
      f = function (a) {
        if (void 0 !== a)
          return (
            "number" === typeof a && 0 !== a % 1 && (a = Math.round(100 * (a + 0.001)) / 100),
            String(a)
          );
      };
    if (c && b) {
      var g = c.winid;
      var h = "#" + $(g).attr("id") + " #plotConfigForm ";
      "flot" === a.globalOpts.plotLibrary &&
        ($(h + ".val").each(function (g, h) {
          d = "";
          e = $(h).attr("name");
          switch (e) {
            case "xscale":
              a.notNull(b.curscale.x) && (d = f(b.curscale.x));
              break;
            case "xmin":
              a.notNull(c.getAxes().xaxis.options.min) && (d = f(c.getAxes().xaxis.options.min));
              break;
            case "xmax":
              a.notNull(c.getAxes().xaxis.options.max) && (d = f(c.getAxes().xaxis.options.max));
              break;
            case "yscale":
              a.notNull(b.curscale.y) && (d = f(b.curscale.y));
              break;
            case "ymin":
              a.notNull(c.getAxes().yaxis.options.min) && (d = f(c.getAxes().yaxis.options.min));
              break;
            case "ymax":
              a.notNull(c.getAxes().yaxis.options.max) && (d = f(c.getAxes().yaxis.options.max));
          }
          $(h).val(d);
        }),
        $(h).data("im", this),
        $(h).data("plot", c),
        $(h).data("pobj", b),
        $(h).data("winid", g),
        $(h).data("tooltipInit") ||
          ($(h).data("tooltipInit", !0),
          a.BROWSER[3]
            ? ((g = "touchstart"), (h = "touchend"))
            : ((g = "mouseover"), (h = "mouseout")),
          $(".plotcol_P").on(g, function (b) {
            var c = b.currentTarget;
            b = $(c).find("input").data("tooltip");
            c = $(c).closest(a.lightOpts[a.LIGHTWIN].top).find(a.lightOpts[a.LIGHTWIN].dragBar);
            b &&
              c.length &&
              ((b = a.Plot.opts.title + ": " + b), ($(c)[0].childNodes[0].nodeValue = b));
          }),
          $(".plotcol_P").on(h, function (b) {
            b = $(b.currentTarget)
              .closest(a.lightOpts[a.LIGHTWIN].top)
              .find(a.lightOpts[a.LIGHTWIN].dragBar);
            b.length && ($(b)[0].childNodes[0].nodeValue = a.Plot.opts.title);
          })));
    }
  };
  a.Plot.processConfigForm = function (c, b, d, e) {
    var f = e.length;
    switch (a.globalOpts.plotLibrary) {
      case "plotly":
        return;
    }
    for (c = 0; c < f; c++) {
      var g = e[c].name;
      var h = e[c].value;
      switch (g) {
        case "xscale":
          "" === h && (h = "linear");
          a.Plot.rescale(null, b, d, "x", h);
          break;
        case "xmin":
          a.Plot.rescale(null, b, d, "x", null, h, null);
          break;
        case "xmax":
          a.Plot.rescale(null, b, d, "x", null, null, h);
          break;
        case "yscale":
          "" === h && (h = "linear");
          a.Plot.rescale(null, b, d, "y", h);
          break;
        case "ymin":
          a.Plot.rescale(null, b, d, "y", null, h, null);
          break;
        case "ymax":
          a.Plot.rescale(null, b, d, "y", null, null, h);
      }
    }
    a.Plot.initConfigForm.call(this, b, d);
  };
  a.plotOpts = a.Plot.opts;
  a.Catalogs = {};
  a.Catalogs.CLASS = "JS9";
  a.Catalogs.NAME = "Catalogs";
  a.Catalogs.opts = {
    hasControls: !1,
    hasRotatingPoint: !1,
    hasBorders: !1,
    lockMovementX: !0,
    lockMovementY: !0,
    lockRotation: !0,
    lockScalingX: !0,
    lockScalingY: !0,
    lockUniScaling: !0,
    selectable: !1,
    canvas: { selection: !1 },
    updateWCS: !1,
    panzoom: !0,
    shape: "circle",
    strokeWidth: 2,
    width: 10,
    height: 10,
    radius: 5,
    eradius: { x: 5, y: 3 },
    angle: 0,
    tagcolors: { defcolor: "#00FF00" },
    sortOverlapping: !1,
  };
  a.Crosshair = {};
  a.Crosshair.CLASS = "JS9";
  a.Crosshair.NAME = "Crosshair";
  a.Crosshair.LAYERNAME = "crosshair";
  a.Crosshair.opts = {
    hasControls: !1,
    hasRotatingPoint: !1,
    hasBorders: !1,
    lockMovementX: !0,
    lockMovementY: !0,
    lockRotation: !0,
    lockScalingX: !0,
    lockScalingY: !0,
    lockUniScaling: !0,
    selectable: !1,
    canvas: { selection: !1 },
    updateWCS: !1,
    panzoom: !1,
    arrowSize: 14,
    strokeWidth: 1,
    color: "#00FF00",
    sortOverlapping: !1,
    hiddenPts: {
      pts: [
        { x: -9999, y: -9999 },
        { x: -9999, y: -9900 },
      ],
    },
  };
  a.Crosshair.display = function (c, b, d) {
    var e = a.Crosshair.LAYERNAME;
    if (
      c &&
      ((d = /iPad|iPhone|iPod/.test(navigator.platform) ? !0 : d.shiftKey),
      c.tmp.arrowCrosshair || (d && !c.tmp.shiftKey && c.crosshair && c.params.crosshair))
    ) {
      if (c.tmp.arrowCrosshair && !c.params.crosshair) {
        var f = a.Crosshair.opts.arrowSize / c.rgb.sect.zoom;
        d = b.x - f;
        var g = b.x + f;
        var h = b.y - f;
        var l = b.y + f;
      } else ((d = 0), (g = c.raw.width), (h = 0), (l = c.raw.height));
      g = {
        pts: [
          { x: d, y: b.y },
          { x: g, y: b.y },
        ],
        redraw: !1,
      };
      c.changeShapes(e, c.crosshair.h, g);
      d = {
        pts: [
          { x: b.x, y: h },
          { x: b.x, y: l },
        ],
        redraw: !0,
      };
      c.changeShapes(e, c.crosshair.v, d);
      c.crosshair.visible = !0;
      if (a.globalOpts.wcsCrosshair && c.validWCS()) {
        h = a.pix2wcs(c.raw.wcs, b.x, b.y).trim().split(/\s+/);
        var m = a.saostrtod(h[0]);
        a.isHMS(c.params.wcssys) && (m *= 15);
        var k = a.saostrtod(h[1]);
        for (b = 0; b < a.displays.length; b++)
          if (
            (f = a.displays[b].image) &&
            f !== c &&
            f.crosshair &&
            f.params.crosshair &&
            f.validWCS()
          ) {
            g = f.raw.width;
            l = f.raw.height;
            try {
              var q = a.wcs2pix(f.raw.wcs, m, k);
            } catch (u) {
              q = null;
            }
            q &&
              ((h = q.trim().split(/\s+/)),
              (d = parseFloat(h[0])),
              (h = parseFloat(h[1])),
              0 < d &&
                d < g &&
                0 < h &&
                h < l &&
                ((g = {
                  pts: [
                    { x: 0, y: h },
                    { x: g, y: h },
                  ],
                  redraw: !1,
                }),
                f.changeShapes(e, f.crosshair.h, g),
                (d = {
                  pts: [
                    { x: d, y: 0 },
                    { x: d, y: l },
                  ],
                  redraw: !0,
                }),
                f.changeShapes(e, f.crosshair.v, d),
                (f.crosshair.visible = !0)));
          }
      }
    }
  };
  a.Crosshair.hide = function (c, b, d) {
    b = a.Crosshair.LAYERNAME;
    d = a.Crosshair.opts.hiddenPts;
    c &&
      ((c.crosshair && c.crosshair.visible) || c.tmp.arrowCrosshairVisible) &&
      (c.changeShapes(b, c.crosshair.h, d),
      c.changeShapes(b, c.crosshair.v, d),
      (c.crosshair.visible = !1),
      delete c.tmp.arrowCrosshairVisible);
  };
  a.Crosshair.create = function (c) {
    var b = a.Crosshair.opts.hiddenPts,
      d = a.Crosshair.LAYERNAME;
    c &&
      !c.crosshair &&
      ((c.crosshair = {}),
      (c.crosshair.h = c.addShapes(d, "line", b)),
      (c.crosshair.v = c.addShapes(d, "line", b)),
      (c.crosshair.visible = !1));
  };
  a.Crosshair.keyaction = function (a, b, d) {
    a && d && d.shiftKey && (a.tmp.shiftKey = !0);
  };
  a.Crosshair.keyup = function (a, b, d) {
    a && a.tmp.shiftKey && d && !d.shiftKey && delete a.tmp.shiftKey;
  };
  a.Crosshair.init = function () {
    var c,
      b = a.Crosshair.LAYERNAME;
    for (c = 0; c < a.displays.length; c++)
      a.displays[c].layers.crosshair || a.displays[c].newShapeLayer(b, a.Crosshair.opts);
    return this;
  };
  a.Image.prototype.toggleCrosshair = function () {
    this.params.crosshair = !this.params.crosshair;
    this.params.crosshair || a.Crosshair.hide(this);
  };
  a.Image.prototype.toggleWCSCrosshair = function () {
    a.globalOpts.wcsCrosshair = !a.globalOpts.wcsCrosshair;
  };
  a.Grid = {};
  a.Grid.CLASS = "JS9";
  a.Grid.NAME = "Grid";
  a.Grid.LAYERNAME = "grid";
  a.Grid.opts = {
    movable: !1,
    cover: "display",
    reduceDims: !0,
    strokeWidth: 1,
    margin: 0,
    labelMargin: 10,
    stride: 32,
    raLines: 8,
    raSkip: 0,
    raAngle: 0,
    decLines: 8,
    decSkip: 0,
    decAngle: 90,
    sexaPrec: 1,
    degPrec: 3,
    lineColor: "#00FFFF",
    labelColor: "#00FFFF",
    labelFontFamily: "Helvetica, sans-serif",
    labelFontSize: 11,
    labelFontStyle: "normal",
    labelFontWeight: 300,
    labelRAOffx: 3,
    labelRAOffy: -1,
    labelDecOffx: -14,
    labelDecOffy: 6,
  };
  a.Grid.limits = function (a, b, d, e) {
    a = d - b;
    a = 1 < a ? 10 : 0.1 < a ? 100 : 0.01 < a ? 1e3 : 0.001 < a ? 1e4 : 1e-4 < a ? 1e5 : 1e6;
    b = Math.floor(b * a) / a;
    d = Math.ceil(d * a) / a;
    return { lo: b, hi: d, inc: Math.ceil(((d - b) / e) * a) / a };
  };
  a.Grid.getLabel = function (c, b, d) {
    var e,
      f = !1;
    switch (c.wcsunits) {
      case "sexagesimal":
        "ra" === d && "galactic" !== c.wcssys && "ecliptic" !== c.wcssys && (b /= 15);
        b = a.saodtostr(b, ":", c.sexaPrec);
        var g = b.split(":");
        if (c.last[d])
          for (b = "", e = 0; e < g.length; e++)
            if ((b && (b += ":"), f || g[e] !== c.last[d][e])) ((b += g[e]), (f = !0));
        c.last[d] = $.extend({}, g);
        break;
      default:
        b = b.toFixed(c.degPrec);
    }
    b = b.replace(/0+$/, "");
    c = b.indexOf(".");
    0 > c ? (b += ".0") : c === b.length - 1 && (b += "0");
    return (b = b.replace(/:\.0/, ":0.0"));
  };
  a.Grid.display = function (c, b) {
    var d, e, f, g;
    var h = this.display;
    var l = this.raw;
    var m = [
      { ra: 0, dec: 0 },
      { ra: 0, dec: 0 },
      { ra: 0, dec: 0 },
      { ra: 0, dec: 0 },
    ];
    if (a.isNull(c))
      switch (this.tmp.gridStatus) {
        case "inactive":
        case void 0:
          return !1;
        case "active":
        case "processing":
          return !0;
        default:
          return !0;
      }
    this.removeShapes(a.Grid.LAYERNAME);
    if (!1 === c || !this.raw.wcs || 0 >= this.raw.wcs) this.tmp.gridStatus = "inactive";
    else {
      b = b || {};
      if ("string" === typeof b)
        try {
          b = JSON.parse(b);
        } catch (C) {
          a.error("can't parse displayCoordGrid JSON", C);
        }
      this.tmp.gridStatus = "processing";
      c = $.extend(!0, {}, a.Grid.opts, b);
      c.wcsunits = this.getWCSUnits();
      c.wcssys = this.getWCSSys();
      c.last = {};
      a.wcsunits(this.raw.wcs, "degrees");
      if ("image" === c.cover) {
        var k = [
          Math.max(1, Math.floor(l.width / h.width)),
          Math.max(1, Math.floor(l.height / h.height)),
        ];
        b = [
          { x: 0, y: 0 },
          { x: l.width - 1, y: l.height - 1 },
        ];
      } else {
        k = c.reduceDims
          ? l.width < l.height
            ? [l.width / l.height, 1]
            : l.height < l.width
              ? [1, l.height / l.width]
              : [1, 1]
          : [1, 1];
        b = [];
        var q = { x: this.ix + c.margin, y: this.iy - c.margin };
        var u = this.displayToImagePos(q);
        b[0] = { x: u.x, y: u.y };
        q = { x: h.width - 1 - this.ix - c.margin, y: h.height - 1 - this.iy - c.margin };
        u = this.displayToImagePos(q);
        b[1] = { x: u.x, y: u.y };
      }
      var p = a.pix2wcs(l.wcs, b[0].x, b[0].y).trim().split(/\s+/);
      m[0].ra = a.saostrtod(p[0]);
      m[0].dec = a.saostrtod(p[1]);
      p = a.pix2wcs(l.wcs, b[0].x, b[1].y).trim().split(/\s+/);
      m[1].ra = a.saostrtod(p[0]);
      m[1].dec = a.saostrtod(p[1]);
      p = a.pix2wcs(l.wcs, b[1].x, b[0].y).trim().split(/\s+/);
      m[2].ra = a.saostrtod(p[0]);
      m[2].dec = a.saostrtod(p[1]);
      p = a.pix2wcs(l.wcs, b[1].x, b[1].y).trim().split(/\s+/);
      m[3].ra = a.saostrtod(p[0]);
      m[3].dec = a.saostrtod(p[1]);
      h = m[0].ra;
      u = m[0].dec;
      b = m[0].ra;
      var n = m[0].dec;
      for (p = 1; 4 > p; p++)
        ((h = Math.min(h, m[p].ra)),
          (u = Math.min(u, m[p].dec)),
          (b = Math.max(b, m[p].ra)),
          (n = Math.max(n, m[p].dec)));
      p = a.Grid.limits.call(this, c, h, b, c.raLines * k[0]);
      h = p.lo;
      b = p.hi;
      m = p.inc;
      p = a.Grid.limits.call(this, c, u, n, c.decLines * k[1]);
      u = p.lo;
      n = p.hi;
      var x = p.inc;
      a.wcsunits(this.raw.wcs, c.wcsunits);
      var w = Math.abs(this.raw.wcsinfo.cdelt1);
      var t = w * a.Grid.opts.stride;
      var v = b - t;
      var r = Math.abs(this.raw.wcsinfo.cdelt2);
      var z = r * a.Grid.opts.stride;
      var y = n - z;
      p = "image;";
      for (f = h; f <= b; f += m) {
        var A = "line(";
        var B = r;
        q = e = 0;
        for (g = u; g <= n; g += B)
          (d = a.wcs2pix(l.wcs, f, g).trim().split(/ +/)) &&
            d.length &&
            ((k = parseFloat(d[0])),
            (d = parseFloat(d[1])),
            k >= -c.margin && k <= l.width + c.margin && d >= -c.margin && d <= l.height + c.margin
              ? ((A += String(k + 1 + "," + d + 1 + ", ")),
                q++,
                0 === e ? ((e = 1), g < y && (B = z)) : 1 === e && g > y && ((e = 2), (B = r)))
              : 1 === e && ((e = 2), (g -= B), (B = r)));
        1 < q && ((p += A.replace(/,\s+$/, ") ")), (p += ' {"color": "' + c.lineColor + '"};'));
      }
      for (g = u; g <= n; g += x) {
        A = "line(";
        B = w;
        q = e = 0;
        for (f = h; f <= b; f += B)
          (d = a.wcs2pix(l.wcs, f, g).trim().split(/ +/)) &&
            d.length &&
            ((k = parseFloat(d[0])),
            (d = parseFloat(d[1])),
            k >= -c.margin && k <= l.width + c.margin && d >= -c.margin && d <= l.height + c.margin
              ? ((A += String(k + 1 + "," + d + 1 + ", ")),
                q++,
                0 === e ? ((e = 1), f < v && (B = t)) : 1 === e && f > v && ((e = 2), (B = w)))
              : 1 === e && ((e = 2), (f -= B), (B = w)));
        1 < q && ((p += A.replace(/,\s+$/, ") ")), (p += ' {"color": "' + c.lineColor + '"};'));
      }
      e = c.labelDecOffx / this.rgb.sect.zoom;
      B = c.labelDecOffy / this.rgb.sect.zoom;
      w = 0;
      f = t = h;
      for (A = 0; f <= b; f += m) {
        for (g = u; g <= n; g += x)
          (d = a.wcs2pix(l.wcs, f, g).trim().split(/ +/)) &&
            d.length &&
            ((k = parseFloat(d[0])),
            (d = parseFloat(d[1])),
            (q = this.imageToDisplayPos({ x: k, y: d })),
            q.x > this.ix + c.labelMargin &&
              q.x < this.rgb.img.width + this.ix - c.labelMargin &&
              q.y > this.iy + c.labelMargin &&
              q.y < this.rgb.img.height + this.iy - c.labelMargin &&
              (w >= c.decSkip
                ? ((p += sprintf(
                    'text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',
                    k + e,
                    d + B,
                    a.Grid.getLabel.call(this, c, g, "dec"),
                    c.decAngle,
                    c.labelColor,
                    c.labelFontFamily,
                    c.labelFontSize,
                    c.labelFontStyle,
                    c.labelFontWeight
                  )),
                  A++)
                : (f !== t && w++, (t = f))));
        if (A) break;
      }
      e = c.labelRAOffx / this.rgb.sect.zoom;
      B = c.labelRAOffy / this.rgb.sect.zoom;
      w = 0;
      g = t = u;
      for (A = 0; g <= n; g += x) {
        for (f = h; f <= b; f += m)
          (d = a.wcs2pix(l.wcs, f, g).trim().split(/ +/)) &&
            d.length &&
            ((k = parseFloat(d[0])),
            (d = parseFloat(d[1])),
            (q = this.imageToDisplayPos({ x: k, y: d })),
            q.x > this.ix + c.labelMargin &&
              q.x < this.rgb.img.width + this.ix - c.labelMargin &&
              q.y > this.iy + c.labelMargin &&
              q.y < this.rgb.img.height + this.iy - c.labelMargin &&
              (w >= c.raSkip
                ? ((p += sprintf(
                    'text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',
                    k + e,
                    d + B,
                    a.Grid.getLabel.call(this, c, f, "ra"),
                    c.raAngle,
                    c.labelColor,
                    c.labelFontFamily,
                    c.labelFontSize,
                    c.labelFontStyle,
                    c.labelFontWeight
                  )),
                  A++)
                : (g !== t && w++, (t = g))));
        if (A) break;
      }
      this.addShapes(a.Grid.LAYERNAME, p, c);
      this.tmp.gridStatus = "active";
    }
  };
  a.Grid.toggle = function (a) {
    if (a)
      switch (a.tmp.gridStatus) {
        case void 0:
        case null:
        case "inactive":
          a.displayCoordGrid(!0);
          break;
        case "active":
          a.displayCoordGrid(!1);
      }
  };
  a.Grid.regrid = function (a) {
    a && "active" === a.tmp.gridStatus && "complete" === a.status.load && a.displayCoordGrid(!0);
  };
  a.Grid.init = function (c) {
    c = $.extend(!0, {}, a.Catalogs.opts, a.Grid.opts, c);
    this.display.newShapeLayer(a.Grid.LAYERNAME, c).canvas.on("mouse:up", function () {
      return !1;
    });
  };
  a.Image.prototype.displayCoordGrid = a.Grid.display;
  a.isImage = function (c) {
    return ("object" === typeof c &&
      a.notNull(c.id) &&
      a.notNull(c.raw) &&
      a.notNull(c.rgb) &&
      a.notNull(c.params) &&
      a.notNull(c.display)) ||
      ("string" === typeof c && a.lookupImage(c))
      ? !0
      : !1;
  };
  a.Dysel = {};
  a.Dysel.CLASS = "JS9";
  a.Dysel.NAME = "Dysel";
  a.Dysel.display = null;
  a.Dysel.plugins = [];
  a.Dysel.init = function (a) {};
  a.Dysel.unhighlightSelection = function () {
    a.bugs.webkit_resize
      ? $(".JS9").find(".JS9Image").removeClass("JS9Highlight")
      : $(".JS9").removeClass("JS9Highlight");
  };
  a.Dysel.highlightSelection = function (c) {
    c &&
      a.Dysel.retrievePlugins().length &&
      1 !== a.displays.length &&
      (a.Dysel.unhighlightSelection(),
      (c = c.display),
      a.bugs.webkit_resize
        ? $(c.divjq).find(".JS9Image").addClass("JS9Highlight")
        : $(c.divjq).addClass("JS9Highlight"));
  };
  a.Dysel.addPlugins = function (c) {
    a.Dysel.plugins.push(c);
  };
  a.Dysel.retrievePlugins = function () {
    return a.Dysel.plugins;
  };
  a.Dysel.getDisplay = function (c) {
    return a.Dysel.retrievePlugins().length
      ? "previous" === c
        ? a.Dysel.odisplay
        : a.Dysel.display
      : null;
  };
  a.Dysel.getDisplayOr = function (c) {
    return "previous" === c ? a.Dysel.getDisplay(c) : a.Dysel.getDisplay() || c;
  };
  a.Dysel.select = function (c) {
    c &&
      a.Dysel.retrievePlugins().length &&
      ((a.Dysel.odisplay = a.Dysel.display),
      (a.Dysel.display = c),
      c.image &&
        (a.Dysel.highlightSelection(c.image),
        c.image.xeqPlugins("image", "ondynamicselect", null)));
  };
  a.Dysel.imageload = function (c) {
    c && a.Dysel.select(c.display);
  };
  a.Dysel.imageclose = function (c) {
    var b, d;
    if (c && (d = a.Dysel.getDisplay()) && d.image === c) {
      for (d = b = 0; b < a.images.length; b++) c.display === a.images[b].display && d++;
      if (1 >= d)
        for (b = 0; b < a.displays.length; b++)
          if (((d = a.displays[b]), c.display !== d && d.image)) {
            a.Dysel.select(a.displays[b]);
            break;
          }
    }
  };
  a.getDynamicDisplayOr = a.Dysel.getDisplayOr;
  a.Titlebar = {};
  a.Titlebar.CLASS = "JS9";
  a.Titlebar.NAME = "Titlebar";
  a.Titlebar.init = function (c) {
    a.Titlebar.title || (a.Titlebar.title = document.title);
  };
  a.Titlebar.imageload = function (c) {
    c &&
      a.globalOpts.updateTitlebar &&
      ((a.Titlebar.imid = window.electron ? c.fitsFile || c.file || c.id : c.id),
      (document.title = a.Titlebar.title + ": " + a.Titlebar.imid));
  };
  a.Titlebar.imagedisplay = function (c) {
    c &&
      c.id !== a.Titlebar.imid &&
      a.globalOpts.updateTitlebar &&
      ((a.Titlebar.imid = window.electron ? c.fitsFile || c.file || c.id : c.id),
      (document.title = a.Titlebar.title + ": " + a.Titlebar.imid));
  };
  a.Titlebar.imageclose = function () {
    a.globalOpts.updateTitlebar && (document.title = a.Titlebar.title);
  };
  Math.log10 =
    Math.log10 ||
    function (a) {
      return Math.log(a) / Math.LN10;
    };
  "function" !== typeof Object.create &&
    (Object.create = function (a) {
      var b = function () {};
      b.prototype = a;
      return new b();
    });
  Math.asinh =
    Math.asinh ||
    function (a) {
      return -Infinity === a ? a : Math.log(a + Math.sqrt(a * a + 1));
    };
  Math.sinh =
    Math.sinh ||
    function (a) {
      return (Math.exp(a) - Math.exp(-a)) / 2;
    };
  Array.prototype.includes ||
    Object.defineProperty(Array.prototype, "includes", {
      value: function (a, b) {
        if (null == this) throw new TypeError('"this" is null or not defined');
        var c = Object(this),
          e = c.length >>> 0;
        if (0 === e) return !1;
        b |= 0;
        for (b = Math.max(0 <= b ? b : e - Math.abs(b), 0); b < e; ) {
          var f = c[b],
            g = a;
          if (f === g || ("number" === typeof f && "number" === typeof g && isNaN(f) && isNaN(g)))
            return !0;
          b++;
        }
        return !1;
      },
    });
  a.getRawCopy = function (c, b) {
    var d = $.extend(!0, {}, c);
    d.bitpix = b || c.bitpix;
    switch (d.bitpix) {
      case 8:
        d.data = new Uint8Array(c.data);
        break;
      case 16:
        d.data = new Int16Array(c.data);
        break;
      case -16:
        d.data = new Uint16Array(c.data);
        break;
      case 32:
        d.data = new Int32Array(c.data);
        break;
      case -32:
        d.data = new Float32Array(c.data);
        break;
      case -64:
        d.data = new Float64Array(c.data);
        break;
      default:
        a.error("unsupported bitpix: " + d.bitpix);
    }
    return d;
  };
  a.getRawLine = function (c, b, d, e) {
    switch (c.bitpix) {
      case 8:
        var f = new Uint8Array(c.data.buffer, b, c.width);
        var g = new Uint8Array(d.data.buffer, e, c.width);
        break;
      case 16:
      case -16:
        f = new Uint16Array(c.data.buffer, b, c.width);
        g = new Uint16Array(d.data.buffer, e, c.width);
        break;
      case 32:
        f = new Uint32Array(c.data.buffer, b, c.width);
        g = new Uint32Array(d.data.buffer, e, c.width);
        break;
      case -32:
        f = new Float32Array(c.data.buffer, b, c.width);
        g = new Float32Array(d.data.buffer, e, c.width);
        break;
      case -64:
        f = new Float64Array(c.data.buffer, b, c.width);
        g = new Float64Array(d.data.buffer, e, c.width);
        break;
      default:
        a.error("unsupported bitpix: " + c.bitpix);
    }
    return [f, g];
  };
  a.memcpy = function (a, b, d, e, f) {
    a = new Uint8Array(a, b, f);
    d = new Uint8Array(d, e, f);
    a.set(d);
  };
  a.jupyterFocus = function (a, b) {
    Object.prototype.hasOwnProperty.call(window, "Jupyter") &&
      ((a = a instanceof jQuery ? a : $(a)),
      a.find(b || "input, textarea").each(function (a, b) {
        Jupyter.keyboard_manager.register_events($(b));
      }));
  };
  a.getImageID = function (c, b, d) {
    var e,
      f = 0,
      g = 1,
      h = a.images.length,
      l = /.*<([0-9][0-9]*)>$/,
      m = /<[0-9][0-9]*>/;
    c = a.cleanPath(c.replace(m, ""), "id");
    for (e = 0; e < h; e++) {
      var k = a.images[e];
      k.display.id === b &&
        k !== d &&
        c === k.id0.replace(m, "") &&
        (k.id &&
          0 <= k.id.search(l) &&
          ((k = k.id.replace(l, "$1")), (g = Math.max(g, parseInt(k, 10)))),
        f++);
    }
    return f ? c + "<" + String(g + 1) + ">" : c;
  };
  a.uniqueID = (function () {
    var a = 1;
    return function () {
      return a++;
    };
  })();
  a.waiting = function (c, b) {
    switch (c) {
      case !0:
        if (
          Object.prototype.hasOwnProperty.call(window, "Spinner") &&
          "spinner" === a.globalOpts.waitType
        ) {
          if (b)
            if ("object" === typeof b) var d = b.divjq[0];
            else "string" === typeof b && (c = a.lookupDisplay(b)) && (d = c.divjq[0]);
          d || (d = $("body").get(0));
          a.spinner ||
            ((a.spinner = {}),
            (c = { color: a.globalOpts.spinColor, opacity: a.globalOpts.spinOpacity }),
            (a.spinner.spinner = new Spinner(c)));
          a.spinner.spinner.spin(d);
        } else $("body").addClass("waiting");
        break;
      case !1:
        Object.prototype.hasOwnProperty.call(window, "Spinner") &&
        "spinner" === a.globalOpts.waitType
          ? a.spinner && a.spinner.spinner.stop()
          : $("body").removeClass("waiting");
    }
  };
  a.progress = function (c, b) {
    if ("boolean" === typeof c || "string" === typeof c)
      switch (c) {
        case !0:
        case "indeterminate":
          b && ((a.progress.display = b), a.progress.display.displayMessage("progress", c));
          break;
        case !1:
        case "":
          a.progress.display &&
            (a.progress.display.clearMessage("progress"), delete a.progress.display);
      }
    else
      "number" === typeof c &&
        a.progress.display &&
        a.progress.display.displayMessage("progress", [c, b]);
  };
  a.msgHandler = function (c, b) {
    var d = [];
    var e = c.cmd,
      f = c.id,
      g = a.globalOpts.alerts,
      h = a.globalOpts.quietReturn ? "" : "OK";
    b && (a.globalOpts.alerts = !1);
    if (a.publics[e]) {
      $.isArray(c.args) || (c.args = [c.args]);
      for (d = 0; d < c.args.length; d++)
        if ("''" === c.args[d] || '""' === c.args[d]) c.args[d] = "";
      d = $.extend(!0, [], c.args);
      a: {
        var l = d;
        if (f) {
          if (0 < l.length) {
            c = l[l.length - 1];
            if ("string" === typeof c)
              try {
                var m = JSON.parse(c);
              } catch (q) {
                m = null;
              }
            else "object" === typeof c && (m = c);
            if (
              m &&
              "object" === typeof m &&
              Object.prototype.hasOwnProperty.call(m, "display") &&
              1 === Object.keys(m).length
            ) {
              l.pop();
              break a;
            }
          }
          m = { display: f };
        } else m = null;
      }
      switch (e) {
        case "RunAnalysis":
          b && (1 === d.length && d.push(null), d.push(b));
      }
      m && d.push(m);
      try {
        var k = a.publics[e].apply(a.publics, $jscomp.arrayFromIterable(d));
      } catch (q) {
        k = "ERROR: " + q.message;
      }
      if (b) {
        a.globalOpts.alerts = g;
        if (k instanceof a.Display || k instanceof a.Image) k = k.id;
        switch (e) {
          case "NewShapeLayer":
            k && k.layerName && (k = k.layerName);
            break;
          case "RunAnalysis":
            k.match(/^ERROR:/) || (b = null);
        }
        b && b(k);
      }
      return k;
    }
    if (e && "#" !== e) {
      m = a.lookupCommand(e);
      l = a.lookupDisplay(f, !1);
      if (m && l)
        switch (
          (m.getDisplayInfo(l),
          c.args ? (d = $.extend(!0, [], c.args)) : c.paramlist && (d = c.paramlist.split(/ +/)),
          m.getWhich(d))
        ) {
          case "get":
            try {
              k = m.get(d) || "";
            } catch (q) {
              k = "ERROR: " + q.message;
            }
            break;
          case "set":
            try {
              k = m.set(d) || h;
            } catch (q) {
              k = "ERROR: " + q.message;
            }
            break;
          default:
            k = "ERROR: unknown cmd type for '" + e + "'";
        }
      else
        (m || (k = "ERROR: unknown cmd '" + e + "'"),
          l || (k = "ERROR: unknown display (" + f + ")"));
      if (b) {
        a.globalOpts.alerts = g;
        if (k instanceof a.Display || k instanceof a.Image) k = k.id;
        b(k);
      }
      return k;
    }
    b && b("");
    b && (a.globalOpts.alerts = g);
  };
  a.lightWin = function (c, b, d, e, f) {
    f = f || "";
    switch (a.LIGHTWIN) {
      case "dhtml":
        f.match(/(left|top|center)=/) || (f && (f += ","), (f += "" + a.globalOpts.lightWinPos));
        var g = dhtmlwindow.open(c, b, d, e, f);
        /iPad|iPhone|iPod/.test(navigator.platform) &&
          $("#" + c + " " + a.lightOpts[a.LIGHTWIN].drag)
            .css("-webkit-overflow-scrolling", "touch")
            .css("overflow-y", "scroll");
        $("#" + c + " " + a.lightOpts[a.LIGHTWIN].dragBar)
          .on("dblclick", function () {
            g.close();
          })
          .on("touchend", function (b) {
            var c = new Date().getTime(),
              d = $(b.currentTarget).data("lasttime");
            d && c - d > a.DBLCLICK0 && c - d < a.DBLCLICK && g.close();
            $(b.currentTarget).data("lasttime", c);
          });
        $("#" + c + " " + a.lightOpts[a.LIGHTWIN].dragBar).on("touchend", function () {
          dhtmlwindow.distancex || dhtmlwindow.distancey
            ? 0 < a.lightOpts.nclick && (a.lightOpts.nclick = 0)
            : 2 <= a.lightOpts.nclick
              ? (alert("trouble closing this window? double-tap the window handle"),
                (a.lightOpts.nclick = -1))
              : 0 <= a.lightOpts.nclick && a.lightOpts.nclick++;
        });
    }
    return g;
  };
  a.checkNew = function (c) {
    c || a.error("internal failure in a JS9 constructor");
  };
  a.specialKey = function (a) {
    return a.metaKey || a.ctrlKey;
  };
  a.strace = function (c) {
    var b = "";
    1 < a.DEBUG && (b = c.stack || c.stacktrace || "");
    return b;
  };
  a.floatToString = function (c) {
    return "number" === typeof c
      ? sprintf("%g", parseFloat(c.toFixed(a.globalOpts.floatPrecision)))
      : "string" === typeof c
        ? c
        : String(c);
  };
  a.floatPrecision = function (a, b) {
    return Math.max(Math.floor(Math.log10(Math.abs(a))), Math.floor(Math.log10(Math.abs(b))));
  };
  a.floatFormattedString = function (a, b, d) {
    var c = "";
    if (void 0 === a) return c;
    -2 > b
      ? ((b = "%." + String(2 + d) + "e"), (c = sprintf(b, a)))
      : 0 > b
        ? (c = a.toFixed(Math.abs(b) + 3 + d))
        : 2 > b
          ? ((b = "%." + String(b + d) + "f"), (c = sprintf(b, a)))
          : 5 > b
            ? (c = a.toFixed(0 + d))
            : ((b = "%." + String(2 + d) + "e"), (c = sprintf(b, a)));
    return c;
  };
  a.centerPolygon = function (a) {
    var b;
    if (a && a.length) {
      var c = a.length;
      for (b = 0; b < c; b++) {
        if (void 0 === e || a[b].x < e) var e = a[b].x;
        if (void 0 === f || a[b].x > f) var f = a[b].x;
        if (void 0 === g || a[b].y < g) var g = a[b].y;
        if (void 0 === h || a[b].y > h) var h = a[b].y;
      }
      return { x: (e + f) / 2, y: (g + h) / 2 };
    }
  };
  a.centroidPolygon = function (a, b) {
    var c = 0,
      e = 0,
      f = 0,
      g = 0,
      h = 0,
      l = [];
    if (a && a.length) {
      var m = a.length;
      if (b) {
        for (b = 0; b < m; b++) ((g += a[b].x), (h += a[b].y));
        return { x: g / m, y: h / m };
      }
      for (b = 0; b < m; b++) ((l[b] = {}), (l[b].x = a[b].x), (l[b].y = a[b].y));
      l[m] = {};
      l[m].x = l[0].x;
      l[m].y = l[0].y;
      for (b = 0; b < m; b++)
        ((a = l[b].x * l[b + 1].y - l[b + 1].x * l[b].y),
          (c += a),
          (e += (l[b].x + l[b + 1].x) * a),
          (f += (l[b].y + l[b + 1].y) * a));
      m = c / 2;
      return { x: e / (6 * m), y: f / (6 * m) };
    }
  };
  a.lookupImage = function (c, b) {
    var d,
      e,
      f = a.images.length;
    if (!c) return null;
    window.electron && (e = window.electron.currentDir + "/" + c);
    for (d = 0; d < f; d++) {
      var g = a.images[d];
      if (
        (c === g ||
          c === g.id ||
          c === g.file ||
          c === g.file.replace(/\[.*\]$/, "") ||
          e === g.file ||
          e === g.file.replace(/\[.*\]$/, "") ||
          c === g.file0 ||
          c === a.TOROOT + g.file ||
          (g.fitsFile && c === g.fitsFile)) &&
        0 < $("#" + g.display.id).length
      ) {
        var h = g.display.id;
        if (!b || ("string" === typeof b && b === h) || ("object" === typeof b && b.id === h))
          return g;
      }
    }
    return null;
  };
  a.lookupDisplay = function (c, b) {
    var d,
      e = new RegExp("[-_]?(" + a.PLUGINS + ")$");
    void 0 === b && (b = !0);
    if (c && 0 > c.toString().search(a.SUPERMENU)) {
      for (d = 0; d < a.displays.length; d++)
        if (c === a.displays[d] || c === a.displays[d].id || c === a.displays[d].oid)
          return a.displays[d];
      if ("string" === typeof c)
        for (c = c.replace(e, ""), d = 0; d < a.displays.length; d++)
          if (c === a.displays[d] || c === a.displays[d].id || c === a.displays[d].oid)
            return a.displays[d];
      if (b) a.error("can't find JS9 display with id: " + c);
      else return null;
    }
    return a.displays[0];
  };
  a.getImage = function (c) {
    var b = a.lookupImage(c);
    !b && (c = a.lookupDisplay(c, !1)) && (b = c.image);
    return b;
  };
  a.lookupVfile = function (c) {
    var b,
      d,
      e = [];
    if (!c) return e;
    for (b = 0; b < a.images.length; b++) {
      var f = a.images[b];
      for (d = 0; d < f.raws.length; d++) {
        var g = f.raws[d];
        g.hdu && g.hdu.fits && c === g.hdu.fits.vfile && e.push({ im: f, raw: g, idx: d });
      }
    }
    return e;
  };
  a.loadScript = function (a, b, d) {
    var c = document.getElementsByTagName("head")[0],
      f = document.createElement("script");
    f.type = "text/javascript";
    b && (f.onload = b);
    d && (f.onerror = d);
    f.src = a;
    c.appendChild(f);
  };
  a.fetchURL = function (c, b, d, e) {
    var f = new XMLHttpRequest();
    d = d || {};
    c || b || a.error("invalid url specification for fetchURL");
    b || ((b = c), (c = /([^\\/]+)$/.exec(b)[1]));
    c || (c = /([^\\/]+)$/.exec(b)[1]);
    var g = d.allowCache || b.match(/\?/) ? b : b + "?r=" + Math.random();
    g = g.replace(/^\${JS9_DIR}\//, a.INSTALLDIR);
    f.open("GET", g, !0);
    f.responseType = d.responseType ? d.responseType : "blob";
    a.globalOpts.xtimeout && (f.timeout = a.globalOpts.xtimeout);
    f.onload = function () {
      if (4 === f.readyState)
        if (200 === f.status || 0 === f.status)
          if ((delete a.fetchURL.status, "blob" === f.responseType)) {
            var g = new Blob([f.response]);
            c.match("://")
              ? (g.name = c.split("/").reverse()[0].replace(/\?.*$/, ""))
              : (g.name = c);
            "uc" === g.name && (g.name = "google_" + a.uniqueID() + ".fits");
            e ? e(g, d) : a.Load(g, d);
          } else d.display ? e(f.response, d, { display: d.display }) : e(f.response, d);
        else
          404 === f.status
            ? a.error("could not find " + b)
            : a.error("can't load: " + b + " " + f.statusText + " " + f.status);
    };
    f.onerror = function () {
      a.error("cannot load: " + b + " ... please check the url/pathname");
    };
    f.ontimeout = function () {
      a.error("timeout awaiting response from server: " + b);
    };
    a.fetchURL.status = "processing";
    try {
      f.send();
    } catch (h) {
      a.error("request to load " + b + " failed", h);
    }
  };
  a.saveAs = function (c, b) {
    var d;
    if (window.electron) {
      (d = b.match(/.*\//)) && d[0] && ((d = d[0]), a.SaveDir(d, { onceOnly: !0 }));
      var e = b.split("/").reverse()[0];
      window.setTimeout(function () {
        try {
          saveAs(c, e);
        } catch (f) {
          a.error("could not saveAs", f);
        }
      }, a.TIMEOUT);
    } else
      try {
        saveAs(c, b);
      } catch (f) {
        a.error("could not saveAs", f);
      }
  };
  a.fitsLibrary = function (c) {
    if (!c) return a.fits.name;
    var b = c.toLowerCase();
    switch (b) {
      case "astroem":
      case "cfitsio":
        a.fits = Astroem;
        a.fits.options = a.fits.options || {};
        a.fits.options.handler = a.NewFitsImage;
        a.fits.options.error = a.error;
        a.userOpts.fits
          ? ((a.fits.options.extlist = a.userOpts.fits.extlist),
            (a.fits.options.table = {
              xdim: a.userOpts.fits.xdim,
              ydim: a.userOpts.fits.ydim,
              bin: a.userOpts.fits.bin || 1,
            }),
            (a.fits.options.image = {
              xdim: a.userOpts.fits.ixdim || a.userOpts.fits.xmax,
              ydim: a.userOpts.fits.iydim || a.userOpts.fits.ymax,
              bin: a.userOpts.fits.ibin || 1,
            }))
          : ((a.fits.options.extlist = a.globalOpts.extlist),
            (a.fits.options.table = { bin: a.globalOpts.table.bin || 1 }),
            a.notNull(a.globalOpts.table.xdim)
              ? (a.fits.options.table.xdim = a.globalOpts.table.xdim)
              : a.notNull(a.globalOpts.dims) && (a.fits.options.table.xdim = a.globalOpts.dims[0]),
            a.notNull(a.globalOpts.table.ydim)
              ? (a.fits.options.table.ydim = a.globalOpts.table.ydim)
              : a.notNull(a.globalOpts.dims) && (a.fits.options.table.ydim = a.globalOpts.dims[1]),
            (a.fits.options.image = { bin: a.globalOpts.image.bin || 1 }),
            a.notNull(a.globalOpts.image.xdim)
              ? (a.fits.options.image.xdim = a.globalOpts.image.xdim)
              : a.notNull(a.globalOpts.xmax) && (a.fits.options.image.xdim = a.globalOpts.xmax),
            a.notNull(a.globalOpts.image.ydim)
              ? (a.fits.options.image.ydim = a.globalOpts.image.ydim)
              : a.notNull(a.globalOpts.ymax) && (a.fits.options.image.ydim = a.globalOpts.ymax));
        a.fits.maxFITSMemory &&
          a.globalOpts.maxMemory &&
          a.fits.maxFITSMemory(a.globalOpts.maxMemory);
        break;
      default:
        a.error("unknown fits library: " + c);
    }
    a.fits.ready = !0;
    a.fits.name = b;
    a.fits.options.error = a.error;
    a.fits.options.waiting = a.waiting;
    return b;
  };
  a.handleFITSFile = function (c, b, d) {
    a.fits.handleFITSFile
      ? a.fits.handleFITSFile(c, b, d)
      : a.error("no FITS module available to process FITS file");
  };
  a.cleanupFITSFile = function (c, b) {
    var d;
    a.hostFS && (d = new RegExp("^" + a.hostFS));
    return a.fits.cleanupFITSFile && c && c.hdu && c.hdu.fits
      ? (d && c.hdu.fits.vfile && c.hdu.fits.vfile.match(d) && (b = !1),
        a.fits.cleanupFITSFile(c.hdu.fits, b),
        !0)
      : !1;
  };
  a.handleImageFile = function (c, b, d) {
    var e = new FileReader();
    b = $.extend(!0, {}, a.fits.options, b);
    d = d || a.Load;
    e.onload = function (a) {
      var e,
        f,
        l,
        m = new Image();
      m.onload = function () {
        var a = 0;
        var g = document.createElement("canvas");
        var h = g.getContext("2d");
        var p = m.height,
          n = m.width;
        g.width = n;
        g.height = p;
        h.drawImage(m, 0, 0);
        e = h.getImageData(0, 0, n, p).data;
        f = new Float32Array(p * n);
        for (h = 0; h < p; h++)
          for (g = 0; g < n; g++) {
            var x = 0.299 * e[a] + 0.587 * e[a + 1] + 0.114 * e[a + 2];
            f[(p - h) * n + g] = x;
            a += 4;
          }
        l = {
          filename: c.name,
          naxis: 2,
          axis: [0, n, p],
          bitpix: -32,
          bin: 1,
          head: { SIMPLE: !0, BITPIX: -32, NAXIS: 2, NAXIS1: n, NAXIS2: p },
          data: f,
          offscreen: m,
        };
        l.dmin = Number.MAX_VALUE;
        l.dmax = Number.MIN_VALUE;
        for (a = 0; a < p * n; a++)
          !Number.isNaN(l.data[a]) &&
            Number.isFinite(l.data[a]) &&
            ((l.dmin = Math.min(l.dmin, l.data[a])), (l.dmax = Math.max(l.dmax, l.data[a])));
        b.source = "img";
        d(l, b);
      };
      m.src = a.target.result;
    };
    e.readAsDataURL(c);
  };
  a.getFITSImage = function (c, b, d, e) {
    a.fits.getFITSImage
      ? a.fits.getFITSImage(c, b, d, e)
      : a.error("no FITS module available to process FITS image");
  };
  a.fits2fits = function (c, b, d, e) {
    var f,
      g = {};
    d = d || {};
    var h = a.notNull(d.fits2fits) ? d.fits2fits : a.globalOpts.fits2fits;
    !0 === h ? (h = "always") : !1 === h && (h = "never");
    if (h.match(/never/i)) return !1;
    if (!a.helper.connected || ("nodejs" !== a.helper.type && "socket.io" !== a.helper.type))
      return (
        "always" === h &&
          a.globalOpts.requireFits2Fits &&
          a.error("can't run fits2fits without connected JS9 helper"),
        !1
      );
    if (!a.helper.js9helper)
      if (a.globalOpts.requireFits2Fits) a.error("js9helper not found for fits2fits processing");
      else return !1;
    if (!a.globalOpts.workDir)
      return (
        a.globalOpts.requireFits2Fits && a.error("can't run fits2fits without a workdir"),
        !1
      );
    var l = d.xdim || a.fits.options.image.xdim || a.fits.options.table.xdim;
    var m = d.ydim || a.fits.options.image.ydim || a.fits.options.table.ydim;
    var k = d.bin || a.fits.options.image.bin || a.fits.options.table.bin;
    var q = d.binMode || a.globalOpts.binMode;
    q = "a" === q ? "a" : "";
    "string" === typeof k && (k.match(/[as]$/) && (q = k.slice(-1)), (k = parseInt(k, 10)));
    k = Math.max(1, k || 1);
    a.notNull(d.xcen) && a.notNull(d.ycen)
      ? (g.sect = l + "@" + d.xcen + "," + m + "@" + d.ycen + "," + k + q)
      : (g.sect = l + "," + m + "," + k + q);
    m = h.toLowerCase().split(/[>,]/);
    for (l = 0; l < m.length; l++)
      switch (m[l]) {
        case "size":
          m[l + 1] && (a.isNumber(m[l + 1]) && (g.maxsize = 1e6 * parseFloat(m[l + 1])), l++);
      }
    g.fits = a.cleanPath(b);
    g.parent = !0;
    a.waiting(!0, c);
    a.helper.send("fits2fits", g, function (b) {
      b =
        "object" === typeof b
          ? b
          : 0 <= b.search(a.analOpts.epattern)
            ? { stderr: b }
            : { stdout: b };
      b.stderr && a.error(b.stderr, a.analOpts.epattern);
      if (b.stdout) {
        b.stdout.match(/^ERROR:/) &&
          (a.globalOpts.requireFits2Fits ? a.error(b.stdout) : (b.stdout = g.fits));
        var h = b.stdout.split(/\n/);
        b = a.cleanPath(h[0]);
        if (b === g.fits) var k = $.extend(!0, {}, d);
        else {
          "/" !== b.charAt(0) && (b = a.InstallDir(b));
          k = $.extend(!0, {}, d);
          delete k.xcen;
          delete k.ycen;
          delete k.bin;
          void 0 !== k.xdim && (k.xdim = 0);
          void 0 !== k.ydim && (k.ydim = 0);
          k.source = "fits2fits";
          k.proxyFile = b;
          if (h[1]) {
            try {
              f = JSON.parse(h[1]);
            } catch (x) {}
            f &&
              ((k.extname = f.extname), (k.extnum = f.extnum), (k.hdus = f.hdus), (k.parent = f));
          }
          h[2] &&
            ((h = a.cleanPath(h[2])),
            (k.parentFile = h),
            k.extname
              ? ((k.parentFile = k.parentFile.replace(/\[.*\]/, "")),
                (k.parentFile += "[" + k.extname + "]"))
              : k.extnum &&
                0 < k.extnum &&
                ((k.parentFile = k.parentFile.replace(/\[.*\]/, "")),
                (k.parentFile.file += "[" + k.extnum + "]")));
          e && (k.onload = e);
        }
        k.fits2fits = !1;
        a.Load(b, k, { display: c });
      }
    });
    return !0;
  };
  a.lookupColormap = function (c, b) {
    var d;
    void 0 === b && (b = !0);
    c || (c = a.imageOpts.colormap);
    if (c)
      for (d = 0; d < a.colormaps.length; d++) if (a.colormaps[d].name === c) return a.colormaps[d];
    if (b) a.error("unknown colormap '" + c + "'");
    else return null;
  };
  a.lookupCommand = function (c) {
    var b;
    if (c) {
      var d = c.toLowerCase();
      for (b = 0; b < a.commands.length; b++)
        if (((c = a.commands[b]), c.name === d || c.alias === d || c.alias2 === d)) return c;
    }
    return null;
  };
  a.error = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = $jscomp.makeIterator(b);
    d = e.next().value;
    var f = e.next().value;
    e = e.next().value;
    var g,
      h,
      l,
      m = "",
      k = "",
      q = !0;
    a.waiting(!1);
    "processing" === a.fetchURL.status && (a.fetchURL.status = "error");
    for (h = 0; h < a.images.length; h++) {
      var u = a.images[h];
      (l = u.status.cur) && u.status[l] && u.setStatus(l, "error");
    }
    "string" === typeof f
      ? (f = d.match(f))
        ? f[1]
          ? (d = f[1])
          : f[0] && (d = f[0])
        : (q = !1)
      : "object" === typeof f && (g = f);
    3 > b.length && (e = !0);
    if (
      q &&
      (g && g.message ? (d += " (" + g.message + ")") : d && (g = Error(d)),
      (b = a.strace(g)) && (k = "\n\nStacktrace:\n" + b),
      a.globalOpts.alerts &&
        (d && "string" === typeof d && 0 > d.search(/ERROR/) && (m = "JS9 ERROR: "),
        alert(m + (d + k))),
      e)
    )
      throw g;
  };
  a.log = function (a) {
    for (var b = [], c = 0; c < arguments.length; ++c) b[c - 0] = arguments[c];
    void 0 !== window.console &&
      void 0 !== window.console.log &&
      console.log.apply(console, $jscomp.arrayFromIterable(b));
  };
  a.eventToCharStr = function (c) {
    var b = { 37: "leftArrow", 38: "upArrow", 39: "rightArrow", 40: "downArrow", 8: "delete" },
      d = {
        188: "44",
        109: "45",
        190: "46",
        191: "47",
        192: "96",
        220: "92",
        222: "39",
        221: "93",
        219: "91",
        173: "45",
        187: "61",
        186: "59",
        189: "45",
      },
      e = {
        96: "~",
        49: "!",
        50: "@",
        51: "#",
        52: "$",
        53: "%",
        54: "^",
        55: "&",
        56: "*",
        57: "(",
        48: ")",
        45: "_",
        61: "+",
        91: "{",
        93: "}",
        92: "|",
        59: ":",
        39: '"',
        44: "<",
        46: ">",
        47: "?",
      };
    var f = "number" === typeof c ? c : c.which || c.keyCode;
    var g = String(f);
    Object.prototype.hasOwnProperty.call(d, g) && (f = d[g]);
    f =
      !c.shiftKey && 65 <= f && 90 >= f
        ? String.fromCharCode(f + 32)
        : !c.shiftKey && Object.prototype.hasOwnProperty.call(b, f)
          ? b[f]
          : c.shiftKey && Object.prototype.hasOwnProperty.call(e, f)
            ? e[f]
            : String.fromCharCode(f);
    a.specialKey(c) && (f = "M-" + f);
    return f;
  };
  a.eventToDisplayPos = function (a, b) {
    a || (a = window.event);
    if (a.target) var c = a.target;
    else a.srcElement && (c = a.srcElement);
    3 === c.nodeType && (c = c.parentNode);
    b = b || $(c).offset();
    if (a.originalEvent)
      if (a.originalEvent.touches && a.originalEvent.touches.length) {
        var e = a.originalEvent.touches;
        c = e[0].pageX;
        var f = e[0].pageY;
      } else
        a.originalEvent.changedTouches && a.originalEvent.changedTouches.length
          ? ((e = a.originalEvent.changedTouches), (c = e[0].pageX), (f = e[0].pageY))
          : ((c = a.pageX), (f = a.pageY));
    else ((c = a.pageX), (f = a.pageY));
    a = b.left + 1;
    b = b.top + 1;
    f = { x: Math.floor(c - a), y: Math.floor(f - b) };
    if (e && e.length)
      for (f.touches = [{ x: f.x, y: f.y }], c = 1; c < e.length; c++)
        f.touches[c] = { x: Math.floor(e[c].pageX - a), y: Math.floor(e[c].pageY - b) };
    return f;
  };
  a.pix2pix = function (c, b, d) {
    if (!c || !b || 0 >= c.raw.wcs || 0 >= b.raw.wcs) return d;
    var e = d.x;
    d = d.y;
    var f = a.pix2wcs(c.raw.wcs, e, d).trim().split(/\s+/);
    var g = a.saostrtod(f[0]);
    a.isHMS(c.params.wcssys) && (g *= 15);
    c = a.saostrtod(f[1]);
    f = a.wcs2pix(b.raw.wcs, g, c).trim().split(/\s+/);
    b = parseFloat(f[0]);
    c = parseFloat(f[1]);
    0.5 > Math.abs(b - e) && (b = e);
    0.5 > Math.abs(c - d) && (c = d);
    return { x: b, y: c };
  };
  a.angdist = function (a, b, d, e) {
    var c = function (a, b) {
      var c = [],
        d = Math.cos(b);
      c[0] = Math.cos(a) * d;
      c[1] = Math.sin(a) * d;
      c[2] = Math.sin(b);
      return c;
    };
    a = c((a * Math.PI) / 180, (b * Math.PI) / 180);
    d = c((d * Math.PI) / 180, (e * Math.PI) / 180);
    return (
      (180 *
        -(function (a, b) {
          var c = a[0];
          var d = a[1];
          a = a[2];
          var e = Math.sqrt(c * c + d * d + a * a);
          0 != e && ((c /= e), (d /= e), (a /= e));
          e = b[0];
          var f = b[1];
          var g = b[2];
          b = f * c - e * d;
          c = g * (c * c + d * d) - a * (e * c + f * d);
          return 0 != b || 0 != c ? Math.atan2(b, c) : 0;
        })(a, d)) /
      Math.PI
    );
  };
  a.rotatePoint = function (a, b, d) {
    d = d || { x: 0, y: 0 };
    b = (Math.PI * b) / 180;
    var c = Math.cos(b);
    b = Math.sin(b);
    return {
      x: c * (a.x - d.x) - b * (a.y - d.y) + d.x,
      y: b * (a.x - d.x) + c * (a.y - d.y) + d.y,
    };
  };
  a.matrixMultiply = function (a, b) {
    var c,
      e,
      f,
      g = a.length,
      h = a[0].length,
      l = b[0].length;
    var m = Array(g);
    for (c = 0; c < g; ++c)
      for (m[c] = Array(l), e = 0; e < l; ++e)
        for (f = m[c][e] = 0; f < h; ++f) m[c][e] += a[c][f] * b[f][e];
    return m;
  };
  a.invertMatrix3 = function (a) {
    var b,
      c,
      e = 0,
      f = 0,
      g = a[0][0] * a[1][1],
      h = [
        [0, 0, 0],
        [0, 0, 0],
        [0, 0, 0],
      ];
    for (b = 0; 3 > b; b++)
      for (c = 0; 2 > c; c++) if (void 0 === a[b][c] || Number.isNaN(a[b][c])) return null;
    0 <= g ? (e += g) : (f += g);
    g = -a[0][1] * a[1][0];
    0 <= g ? (e += g) : (f += g);
    b = e + f;
    if (0 === b || 1e-15 > Math.abs(b / (e - f))) return null;
    b = 1 / b;
    h[0][0] = a[1][1] * b;
    h[1][0] = -a[1][0] * b;
    h[0][1] = -a[0][1] * b;
    h[1][1] = a[0][0] * b;
    h[2][0] = -(a[2][0] * h[0][0] + a[2][1] * h[1][0]);
    h[2][1] = -(a[2][0] * h[0][1] + a[2][1] * h[1][1]);
    return h;
  };
  a.isNumber = function (a) {
    return !isNaN(parseFloat(a)) && isFinite(a);
  };
  a.notNull = function (a) {
    return void 0 !== a && null !== a;
  };
  a.isNull = function (a) {
    return void 0 === a || null === a;
  };
  a.defNull = function (c, b) {
    return a.notNull(c) ? c : b;
  };
  a.isWCSSys = function (a) {
    return "image" !== a && "physical" !== a;
  };
  a.notWCS = function (a) {
    return "image" === a || "physical" === a;
  };
  a.isHMS = function (c, b) {
    b = b || String.fromCharCode(a.saodtype());
    return (":" === b || "h" === b) && "galactic" !== c && "ecliptic" !== c;
  };
  a.ishealpix = function (a) {
    return (
      a &&
      "table" === a.imtab &&
      a.raw &&
      a.raw.header &&
      a.raw.header.CTYPE1 &&
      a.raw.header.CTYPE1.match(/--HPX/i)
    );
  };
  a.cardpars = function (c) {
    var b = c.slice(0, 8).trim();
    if ("HISTORY" === b || "COMMENT" === b) return [b, c.slice(9).trim()];
    if ("=" === c[8])
      return (
        (c = c.slice(10).replace(/'/g, " ").replace(/ \/.*/, "").trim()),
        "T" === c ? (c = !0) : "F" === c ? (c = !1) : a.isNumber(c) && (c = parseFloat(c)),
        [b, c]
      );
  };
  a.raw2FITS = function (c, b) {
    var d,
      e = !1,
      f = "",
      g = {};
    var h = function (a, b, c, d) {
      var e = a;
      if ("XTENSION" !== b || c) {
        var f = new RegExp(b + " *= *(-?[-+]?[0-9]*.?[0-9]*([eE][-+]?[0-9]+)?) *");
        a ? ((a = a.replace(f, "$1")), (a = parseFloat(a))) : (a = void 0);
        a !== c && (e = sprintf("%-8s= %20s / %-47s", b, c, d || ""));
      } else e = sprintf("%s  = %20s / %-47s", "SIMPLE", "T", "file does conform to FITS standard");
      g[b] = !0;
      return e;
    };
    if (!c) return f;
    b = b || {};
    "boolean" === typeof b && (b = { addcr: b });
    if (c.card || c.cardstr) {
      var l = c.header || {};
      var m = c.card ? c.card.length : c.ncard;
      for (d = 0; d < m; d++) {
        var k = c.card ? c.card[d].slice(0, 80) : c.cardstr.slice(80 * d, 80 * (d + 1));
        if (!b.notab || !k.match(/^TAB(TYP|MIN|MAX|DIM)[1,2]/)) {
          if (k.match(/^XTENSION/) && 0 === d && b.simple) f += h(k, "XTENSION");
          else if (k.match(/^BITPIX /) && c.bitpix) f += h(k, "BITPIX", c.bitpix, "bits/pixel");
          else if (k.match(/^NAXIS1 /) && c.width) f += h(k, "NAXIS1", c.width, "x image dim");
          else if (k.match(/^NAXIS2 /) && c.height) f += h(k, "NAXIS2", c.height, "y image dim");
          else if (k.match(/^CRPIX1 /) && a.notNull(l.CRPIX1))
            f += h(k, "CRPIX1", l.CRPIX1, "ref point");
          else if (k.match(/^CRPIX2 /) && a.notNull(l.CRPIX2))
            f += h(k, "CRPIX2", l.CRPIX2, "ref point");
          else if (k.match(/^CDELT1 /) && a.notNull(l.CDELT1))
            f += h(k, "CDELT1", l.CDELT1, "deg/pixel");
          else if (k.match(/^CDELT2 /) && a.notNull(l.CDELT2))
            f += h(k, "CDELT2", l.CDELT2, "deg/pixel");
          else if (k.match(/^CD1_1 /) && a.notNull(l.CD1_1))
            f += h(k, "CD1_1", l.CD1_1, "WCS matrix value");
          else if (k.match(/^CD1_2 /) && a.notNull(l.CD1_2))
            f += h(k, "CD1_2", l.CD1_2, "WCS matrix value");
          else if (k.match(/^CD2_1 /) && a.notNull(l.CD2_1))
            f += h(k, "CD2_1", l.CD2_1, "WCS matrix value");
          else if (k.match(/^CD2_2 /) && a.notNull(l.CD2_2))
            f += h(k, "CD2_2", l.CD2_2, "WCS matrix value");
          else if (k.match(/^LTV1 /) && a.notNull(l.LTV1))
            f += h(k, "LTV1", l.LTV1, "IRAF ref. point");
          else if (k.match(/^LTV2 /) && a.notNull(l.LTV2))
            f += h(k, "LTV2", l.LTV2, "IRAF ref. point");
          else if (k.match(/^LTM1_1 /) && a.notNull(l.LTM1_1))
            f += h(k, "LTM1_1", l.LTM1_1, "IRAF matrix value");
          else if (k.match(/^LTM1_2 /) && a.notNull(l.LTM1_2))
            f += h(k, "LTM1_2", l.LTM1_2, "IRAF matrix value");
          else if (k.match(/^LTM2_1 /) && a.notNull(l.LTM2_1))
            f += h(k, "LTM2_1", l.LTM2_1, "IRAF matrix value");
          else if (k.match(/^LTM2_2 /) && a.notNull(l.LTM2_2))
            f += h(k, "LTM2_2", l.LTM2_2, "IRAF matrix value");
          else if (b.twoaxes && k.match(/^NAXIS /)) f += h(k, "NAXIS", 2, "number of data axes");
          else if (b.twoaxes && k.match(/^(NAXIS|CRPIX|CRVAL|CTYPE|CUNIT|CDELT)[34567]/)) continue;
          else if (b.twoaxes && k.match(/^(DATASUM|CHECKSUM)/)) continue;
          else
            "END " === k.substring(0, 4)
              ? (a.notNull(l.LTV1) &&
                  !g.LTV1 &&
                  ((f += h(null, "LTV1", l.LTV1, "IRAF ref. point")), b.addcr && (f += "\n")),
                a.notNull(l.LTV2) &&
                  !g.LTV2 &&
                  ((f += h(null, "LTV2", l.LTV2, "IRAF ref. point")), b.addcr && (f += "\n")),
                a.notNull(l.LTM1_1) &&
                  !g.LTM1_1 &&
                  ((f += h(null, "LTM1_1", l.LTM1_1, "IRAF matrix value")), b.addcr && (f += "\n")),
                a.notNull(l.LTM1_2) &&
                  !g.LTM1_2 &&
                  ((f += h(null, "LTM1_2", l.LTM1_2, "IRAF matrix value")), b.addcr && (f += "\n")),
                a.notNull(l.LTM2_1) &&
                  !g.LTM2_1 &&
                  ((f += h(null, "LTM2_1", l.LTM2_1, "IRAF matrix value")), b.addcr && (f += "\n")),
                a.notNull(l.LTM2_2) &&
                  !g.LTM2_2 &&
                  ((f += h(null, "LTM2_2", l.LTM2_2, "IRAF matrix value")), b.addcr && (f += "\n")),
                (f += k),
                (e = !0))
              : (f += k);
          b.addcr && (f += "\n");
        }
      }
    } else if (c.header || c.BITPIX) {
      c = c.header ? c.header : c;
      if (void 0 !== c.SIMPLE || void 0 !== c.simple)
        ((d = void 0 !== c.SIMPLE ? c.SIMPLE : c.simple),
          !0 === d ? (d = "T") : !1 === d && (d = "F"),
          (f += sprintf("%-8s= %20s / %-47s", "SIMPLE", d, "conforms to FITS standard")),
          b.addcr && (f += "\n"));
      if (void 0 !== c.BITPIX || void 0 !== c.bitpix)
        ((d = void 0 !== c.BITPIX ? c.BITPIX : c.bitpix),
          (f += sprintf("%-8s= %20s / %-47s", "BITPIX", d, "bits/pixel")),
          b.addcr && (f += "\n"));
      for (k in c)
        if (
          Object.prototype.hasOwnProperty.call(c, k) &&
          "js9Protocol" !== k &&
          "js9Endian" !== k &&
          "SIMPLE" !== k &&
          "simple" !== k &&
          "BITPIX" !== k &&
          "bitpix" !== k
        ) {
          "END" === k && (e = !0);
          if (k.match(/HISTORY__[0-9]+/)) f += sprintf("HISTORY %-72s", c[k]);
          else if (k.match(/COMMENT__[0-9]+/)) f += sprintf("COMMENT %-72s", c[k]);
          else {
            d = c[k];
            !0 === d
              ? (d = "T")
              : !1 === d
                ? (d = "F")
                : "" === d
                  ? (d = "' '")
                  : Number.isNaN(d)
                    ? (d = "NaN")
                    : a.isNumber(d) || "'" === d.charAt(0) || (d = "'" + d + "'");
            h = sprintf("%-8s= %20s", k, d);
            m = 80 - h.length;
            if (0 < m) for (d = 0; d < m; d++) h += " ";
            f += h;
          }
          b.addcr && (f += "\n");
        }
    }
    e || ((f += sprintf("%-8s%-72s", "END", " ")), b.addcr && (f += "\n"));
    return f;
  };
  a.hdus2Str = function (c) {
    var b,
      d = "";
    if (!c) return d;
    for (b = 0; b < c.length; b++) {
      var e = c[b];
      var f = e.name ? e.name : 0 === b ? "Primary" : "N/A";
      d += sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s", e.hdu, f, e.type);
      switch (e.type) {
        case "image":
          d += sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d", e.bitpix, e.naxis);
          if (e.naxes.length) {
            d += "&#09;<b>axes</b>: [";
            for (f = 0; f < e.naxes.length; f++)
              ((d += sprintf("%d", e.naxes[f])), f !== e.naxes.length - 1 && (d += ", "));
            d += "]";
          }
          break;
        case "table":
        case "ascii":
          f = "&#09;";
          9 >= e.rows && (f += "&#09;");
          d += sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [", e.rows, f);
          for (f = 0; f < e.cols.length; f++)
            ((d += "" + e.cols[f].name),
              a.notNull(e.cols[f].min) &&
                a.notNull(e.cols[f].max) &&
                (d += ":" + e.cols[f].min + ":" + e.cols[f].max),
              f !== e.cols.length - 1 && (d += ", "));
          d += "]";
      }
      d += "\n\n";
    }
    return d;
  };
  CanvasRenderingContext2D.prototype.clear =
    CanvasRenderingContext2D.prototype.clear ||
    function (a) {
      a && (this.save(), this.setTransform(1, 0, 0, 1, 0, 0));
      this.clearRect(0, 0, this.canvas.width, this.canvas.height);
      a && this.restore();
    };
  a.searchbar = function (c, b) {
    c = $(c);
    var d = function (a) {
        g.unmark({
          done: function () {
            g.mark(a, {
              caseSensitive: l.opts.matchcase,
              diacritics: l.opts.diacritics,
              accuracy: l.opts.matchwords ? "exactly" : "partially",
              wildcards: l.opts.matchwildcards ? "enabled" : "disabled",
              done: function () {
                l.results = g.find("mark");
                l.currentIndex = 0;
                f();
              },
            });
          },
        });
      },
      e = function (a) {
        var b = a.prop("data-btn");
        l.opts[b]
          ? (a.removeClass("JS9SearchButton-false"), a.addClass("JS9SearchButton-true"))
          : (a.removeClass("JS9SearchButton-true"), a.addClass("JS9SearchButton-false"));
      },
      f = function () {
        if (l.results.length) {
          var a = l.results.eq(l.currentIndex);
          l.results.removeClass("current");
          a.length &&
            (a.addClass("current"), (a = a.position().top), 0 > a || a > h.height()) &&
            ((a = a + h.scrollTop() - 50), h.scrollTop(a));
        }
      };
    b = b || ".JS9AnalysisText";
    if (c.is(b)) var g = c;
    else if (((g = c.find(b)), !g.length)) return;
    var h = c.find(a.lightOpts[a.LIGHTWIN].drag);
    h.length || (h = c);
    var l = h.find(".JS9Searchbar");
    if (l.length) l.css("display", "block");
    else {
      l = $("<div>").addClass("JS9Searchbar").appendTo(h);
      l.opts = { matchcase: !1, matchdiacritics: !1, matchwords: !1, matchwildcards: !1 };
      var m = $("<input type='search'>").addClass("JS9SearchInput").appendTo(l);
      m.on("input", function () {
        d(this.value);
      });
      l.opts.matchwildcards
        ? m.prop("placeholder", "sea*rch template?")
        : m.prop("placeholder", "search term(s)");
      b = $("<button>")
        .addClass("JS9SearchButton")
        .prop("data-btn", "next")
        .html("&darr;")
        .appendTo(l);
      var k = $("<button>")
        .addClass("JS9SearchButton")
        .prop("data-btn", "prev")
        .html("&uarr;")
        .appendTo(l);
      b.add(k).on("click", function () {
        l.results &&
          l.results.length &&
          ((l.currentIndex += $(this).is(k) ? -1 : 1),
          0 > l.currentIndex && (l.currentIndex = l.results.length - 1),
          l.currentIndex > l.results.length - 1 && (l.currentIndex = 0),
          f());
      });
      var q = $("<button>")
        .addClass("JS9SearchButton JS9SearchButton-" + l.opts.matchcase)
        .prop("data-btn", "matchcase")
        .html("Match Case")
        .appendTo(l);
      q.on("click", function () {
        l.opts.matchcase = !l.opts.matchcase;
        e(q);
        d(m.val());
      });
      e(q);
      var u = $("<button>")
        .addClass("JS9SearchButton JS9SearchButton-" + l.opts.matchdiacritics)
        .prop("data-btn", "matchdiacritics")
        .html("Match Diacritics")
        .appendTo(l);
      u.on("click", function () {
        l.opts.matchdiacritics = !l.opts.matchdiacritics;
        e(u);
        d(m.val());
      });
      e(u);
      var p = $("<button>")
        .addClass("JS9SearchButton JS9SearchButton-" + l.opts.matchwords)
        .prop("data-btn", "matchwords")
        .html("Whole Words")
        .appendTo(l);
      p.on("click", function () {
        l.opts.matchwords = !l.opts.matchwords;
        e(p);
        d(m.val());
      });
      e(p);
      var n = $("<button>")
        .addClass("JS9SearchButton JS9SearchButton-" + l.opts.matchwildcards)
        .prop("data-btn", "matchwildcards")
        .html("Wildcards")
        .appendTo(l);
      n.on("click", function () {
        l.opts.matchwildcards = !l.opts.matchwildcards;
        l.opts.matchwildcards
          ? m.prop("placeholder", "sea*rch template?")
          : m.prop("placeholder", "search term(s)");
        e(n);
        d(m.val());
      });
      e(n);
      $("<button>")
        .addClass("JS9SearchButton")
        .prop("data-btn", "close")
        .html("Close")
        .appendTo(l)
        .on("click", function () {
          g.unmark();
          m.val("");
          l.css("display", "none");
        });
      h.css("outline", "none");
      h.attr("tabindex", "0");
      h.on("keydown", function (b) {
        var c = String.fromCharCode(b.which || b.keyCode);
        a.specialKey(b) &&
          "F" === c &&
          ("none" === l.css("display")
            ? (l.css("display", "block"), m.focus())
            : (g.unmark(), m.val(""), l.css("display", "none")));
      });
    }
  };
  a.tooltip = function (c, b, d, e, f, g) {
    var h = function (b) {
      return b.replace(/\$([a-zA-Z0-9_./]+)/g, function (b, c, d) {
        c = c.split(".");
        switch (c[0]) {
          case "im":
            d = e;
            break;
          case "xreg":
            d = f;
            break;
          case "evt":
            d = g;
            break;
          case "data":
            d = f.data;
            break;
          default:
            return b;
        }
        for (b = 1; b < c.length; b++) ((d = d[c[b]]), (d = a.isNumber(d) ? d.toFixed(6) : d));
        void 0 === d && (d = "");
        return d;
      });
    };
    d
      ? ((d = h(d)),
        e.display.tooltip.html(d),
        (h = e.display.tooltip.width()),
        (d = e.display.tooltip.height()),
        (c = Math.max(2, Math.min(c, e.display.width - (h + 10)))),
        (b = Math.max(2, Math.min(b, e.display.height - (d + 10)))),
        e.display.tooltip.css({ left: c, top: b, display: "inline-block" }))
      : e.display.tooltip.html("").css({ left: -9999, display: "none" });
  };
  a.xeqByName = function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = $jscomp.makeIterator(b);
    var e = d.next().value;
    d = d.next().value;
    b = b.slice(2);
    var f = typeof e;
    switch (f) {
      case "function":
        return e.apply(d, b);
      case "string":
        f = e.split(".");
        var g = f.pop();
        for (e = 0; e < f.length; e++) d = d[f[e]];
        return d[g].apply(d, $jscomp.arrayFromIterable(b));
      default:
        a.error("unknown func type: " + f);
    }
  };
  a.varByName = function (c, b) {
    b = b || a;
    var d = c.split(".");
    var e = d.pop();
    for (c = 0; c < d.length; c++) if (((b = b[d[c]]), !b)) return null;
    return b[e];
  };
  a.mergePrefs = function (c) {
    var b,
      d = !1;
    for (b in c)
      if (Object.prototype.hasOwnProperty.call(c, b))
        if ("config" === b) "merge" === c[b].objects && (d = !0);
        else if (Object.prototype.hasOwnProperty.call(a, b)) {
          var e = typeof a[b];
          var f = typeof c[b];
          if (e === f || "string" === f)
            switch (e) {
              case "object":
                $.isArray(c[b])
                  ? (a[b] = c[b])
                  : d
                    ? $.extend(!0, a[b], c[b])
                    : $.extend(a[b], c[b]);
                break;
              case "number":
              case "string":
                a[b] = c[b];
            }
        }
  };
  a.loadPrefs = function (c, b) {
    $.ajax({
      url: c,
      cache: !1,
      dataType: "json",
      mimeType: "application/json",
      async: !1,
      success: function (b) {
        a.mergePrefs(b);
      },
      error: function (d, e, f) {
        b && a.log("JS9 prefs file not available: %s", c);
      },
    });
  };
  a.isTypedArray = function (a) {
    a = Object.prototype.toString.call(a);
    return Object.prototype.hasOwnProperty.call(
      {
        "[object Int8Array]": !0,
        "[object Uint8Array]": !0,
        "[object Uint8ClampedArray]": !0,
        "[object Int16Array]": !0,
        "[object Uint16Array]": !0,
        "[object Int32Array]": !0,
        "[object Uint32Array]": !0,
        "[object Float32Array]": !0,
        "[object Float64Array]": !0,
      },
      a
    );
  };
  a.Starbase = function (a, b) {
    var c,
      e,
      f = 0;
    var g = function (a) {
      var b;
      for (b = 0; b < a.length; b++) if (null === a[b].match(/^-+$/)) return 0;
      return b;
    };
    var h = function (a) {
      return a;
    };
    this.head = {};
    this.convFuncs = [];
    this.data = [];
    this.delims = [];
    if (a) {
      b = b || {};
      a = a.replace(/\s+$/, "").split("\n");
      if (b.skip && (c = b.skip.split("")) && c.length)
        for (; f < a.length && (c[0] === a[f][0] || ("\n" === c[1] && "" === a[f])); f++);
      if (void 0 !== a[f] && void 0 !== a[f + 1]) {
        this.headline = a[f++].trim().split(/ *\t */);
        b.units && (this.unitline = a[f++].trim().split(/ *\t */));
        this.dashline = a[f++].trim().split(/ *\t */);
        for (e = g(this.dashline); 0 === e || e !== this.headline.length; )
          (b.units
            ? ((this.headline = this.unitline), (this.unitline = this.dashline))
            : (this.headline = this.dashline),
            (this.dashline = a[f++].trim().split(/ *\t */)),
            (e = g(this.dashline)));
        for (g = 0; g < this.headline.length; g++)
          ((this.headline[g] = this.headline[g].replace(/\./g, "_")),
            (this.convFuncs[g] =
              b.convFuncs && b.convFuncs[this.headline[g]]
                ? b.convFuncs[this.headline[g]]
                : b.convFuncs && b.convFuncs.def
                  ? b.convFuncs.def
                  : h));
        for (
          b = 0;
          f < a.length && (!c || !c.length || (c[0] !== a[f][0] && ("\n" !== c[1] || "" !== a[f])));
          f++, b++
        )
          for (this.data[b] = a[f].split("\t"), g = 0; g < this.data[b].length; g++)
            ((h = this.convFuncs[g](this.data[b][g])),
              (this.data[b][g] = h.val),
              (this.delims[g] = h.delim || null));
        for (g = 0; g < this.headline.length; g++) this[this.headline[g]] = g;
      }
    }
  };
  a.colorToHex = function (a) {
    var b = {
      aliceblue: "#f0f8ff",
      antiquewhite: "#faebd7",
      aqua: "#00ffff",
      aquamarine: "#7fffd4",
      azure: "#f0ffff",
      beige: "#f5f5dc",
      bisque: "#ffe4c4",
      black: "#000000",
      blanchedalmond: "#ffebcd",
      blue: "#0000ff",
      blueviolet: "#8a2be2",
      brown: "#a52a2a",
      burlywood: "#deb887",
      cadetblue: "#5f9ea0",
      chartreuse: "#7fff00",
      chocolate: "#d2691e",
      coral: "#ff7f50",
      cornflowerblue: "#6495ed",
      cornsilk: "#fff8dc",
      crimson: "#dc143c",
      cyan: "#00ffff",
      darkblue: "#00008b",
      darkcyan: "#008b8b",
      darkgoldenrod: "#b8860b",
      darkgray: "#a9a9a9",
      darkgreen: "#006400",
      darkkhaki: "#bdb76b",
      darkmagenta: "#8b008b",
      darkolivegreen: "#556b2f",
      darkorange: "#ff8c00",
      darkorchid: "#9932cc",
      darkred: "#8b0000",
      darksalmon: "#e9967a",
      darkseagreen: "#8fbc8f",
      darkslateblue: "#483d8b",
      darkslategray: "#2f4f4f",
      darkturquoise: "#00ced1",
      darkviolet: "#9400d3",
      deeppink: "#ff1493",
      deepskyblue: "#00bfff",
      dimgray: "#696969",
      dodgerblue: "#1e90ff",
      firebrick: "#b22222",
      floralwhite: "#fffaf0",
      forestgreen: "#228b22",
      fuchsia: "#ff00ff",
      gainsboro: "#dcdcdc",
      ghostwhite: "#f8f8ff",
      gold: "#ffd700",
      goldenrod: "#daa520",
      gray: "#808080",
      green: "#008000",
      greenyellow: "#adff2f",
      honeydew: "#f0fff0",
      hotpink: "#ff69b4",
      "indianred ": "#cd5c5c",
      indigo: "#4b0082",
      ivory: "#fffff0",
      khaki: "#f0e68c",
      lavender: "#e6e6fa",
      lavenderblush: "#fff0f5",
      lawngreen: "#7cfc00",
      lemonchiffon: "#fffacd",
      lightblue: "#add8e6",
      lightcoral: "#f08080",
      lightcyan: "#e0ffff",
      lightgoldenrodyellow: "#fafad2",
      lightgrey: "#d3d3d3",
      lightgreen: "#90ee90",
      lightpink: "#ffb6c1",
      lightsalmon: "#ffa07a",
      lightseagreen: "#20b2aa",
      lightskyblue: "#87cefa",
      lightslategray: "#778899",
      lightsteelblue: "#b0c4de",
      lightyellow: "#ffffe0",
      lime: "#00ff00",
      limegreen: "#32cd32",
      linen: "#faf0e6",
      magenta: "#ff00ff",
      maroon: "#800000",
      mediumaquamarine: "#66cdaa",
      mediumblue: "#0000cd",
      mediumorchid: "#ba55d3",
      mediumpurple: "#9370d8",
      mediumseagreen: "#3cb371",
      mediumslateblue: "#7b68ee",
      mediumspringgreen: "#00fa9a",
      mediumturquoise: "#48d1cc",
      mediumvioletred: "#c71585",
      midnightblue: "#191970",
      mintcream: "#f5fffa",
      mistyrose: "#ffe4e1",
      moccasin: "#ffe4b5",
      navajowhite: "#ffdead",
      navy: "#000080",
      oldlace: "#fdf5e6",
      olive: "#808000",
      olivedrab: "#6b8e23",
      orange: "#ffa500",
      orangered: "#ff4500",
      orchid: "#da70d6",
      palegoldenrod: "#eee8aa",
      palegreen: "#98fb98",
      paleturquoise: "#afeeee",
      palevioletred: "#d87093",
      papayawhip: "#ffefd5",
      peachpuff: "#ffdab9",
      peru: "#cd853f",
      pink: "#ffc0cb",
      plum: "#dda0dd",
      powderblue: "#b0e0e6",
      purple: "#800080",
      rebeccapurple: "#663399",
      red: "#ff0000",
      rosybrown: "#bc8f8f",
      royalblue: "#4169e1",
      saddlebrown: "#8b4513",
      salmon: "#fa8072",
      sandybrown: "#f4a460",
      seagreen: "#2e8b57",
      seashell: "#fff5ee",
      sienna: "#a0522d",
      silver: "#c0c0c0",
      skyblue: "#87ceeb",
      slateblue: "#6a5acd",
      slategray: "#708090",
      snow: "#fffafa",
      springgreen: "#00ff7f",
      steelblue: "#4682b4",
      tan: "#d2b48c",
      teal: "#008080",
      thistle: "#d8bfd8",
      tomato: "#ff6347",
      turquoise: "#40e0d0",
      violet: "#ee82ee",
      wheat: "#f5deb3",
      white: "#ffffff",
      whitesmoke: "#f5f5f5",
      yellow: "#ffff00",
      yellowgreen: "#9acd3",
      antiquewhite1: "#ffefdb",
      antiquewhite2: "#eedfcc",
      antiquewhite3: "#cdc0b0",
      antiquewhite4: "#8b8378",
      cadetblue1: "#98f5ff",
      cadetblue2: "#8ee5ee",
      cadetblue3: "#7ac5cd",
      cadetblue4: "#53868b",
      darkgoldenrod1: "#ffb90f",
      darkgoldenrod2: "#eead0e",
      darkgoldenrod3: "#cd950c",
      darkgoldenrod4: "#8b6508",
      darkgrey: "#a9a9a9",
      darkolivegreen1: "#caff70",
      darkolivegreen2: "#bcee68",
      darkolivegreen3: "#a2cd5a",
      darkolivegreen4: "#6e8b3d",
      darkorange1: "#ff7f00",
      darkorange2: "#ee7600",
      darkorange3: "#cd6600",
      darkorange4: "#8b4500",
      darkorchid1: "#bf3eff",
      darkorchid2: "#b23aee",
      darkorchid3: "#9a32cd",
      darkorchid4: "#68228b",
      darkseagreen1: "#c1ffc1",
      darkseagreen2: "#b4eeb4",
      darkseagreen3: "#9bcd9b",
      darkseagreen4: "#698b69",
      darkslategray1: "#97ffff",
      darkslategray2: "#8deeee",
      darkslategray3: "#79cdcd",
      darkslategray4: "#528b8b",
      darkslategrey: "#2f4f4f",
      deeppink1: "#ff1493",
      deeppink2: "#ee1289",
      deeppink3: "#cd1076",
      deeppink4: "#8b0a50",
      deepskyblue1: "#00bfff",
      deepskyblue2: "#00b2ee",
      deepskyblue3: "#009acd",
      deepskyblue4: "#00688b",
      dimgrey: "#696969",
      dodgerblue1: "#1e90ff",
      dodgerblue2: "#1c86ee",
      dodgerblue3: "#1874cd",
      dodgerblue4: "#104e8b",
      hotpink1: "#ff6eb4",
      hotpink2: "#ee6aa7",
      hotpink3: "#cd6090",
      hotpink4: "#8b3a62",
      indianred: "#cd5c5c",
      indianred1: "#ff6a6a",
      indianred2: "#ee6363",
      indianred3: "#cd5555",
      indianred4: "#8b3a3a",
      lavenderblush1: "#fff0f5",
      lavenderblush2: "#eee0e5",
      lavenderblush3: "#cdc1c5",
      lavenderblush4: "#8b8386",
      lemonchiffon1: "#fffacd",
      lemonchiffon2: "#eee9bf",
      lemonchiffon3: "#cdc9a5",
      lemonchiffon4: "#8b8970",
      lightblue1: "#bfefff",
      lightblue2: "#b2dfee",
      lightblue3: "#9ac0cd",
      lightblue4: "#68838b",
      lightcyan1: "#e0ffff",
      lightcyan2: "#d1eeee",
      lightcyan3: "#b4cdcd",
      lightcyan4: "#7a8b8b",
      lightgoldenrod: "#eedd82",
      lightgoldenrod1: "#ffec8b",
      lightgoldenrod2: "#eedc82",
      lightgoldenrod3: "#cdbe70",
      lightgoldenrod4: "#8b814c",
      lightgray: "#d3d3d3",
      lightpink1: "#ffaeb9",
      lightpink2: "#eea2ad",
      lightpink3: "#cd8c95",
      lightpink4: "#8b5f65",
      lightsalmon1: "#ffa07a",
      lightsalmon2: "#ee9572",
      lightsalmon3: "#cd8162",
      lightsalmon4: "#8b5742",
      lightskyblue1: "#b0e2ff",
      lightskyblue2: "#a4d3ee",
      lightskyblue3: "#8db6cd",
      lightskyblue4: "#607b8b",
      lightslateblue: "#8470ff",
      lightslategrey: "#778899",
      lightsteelblue1: "#cae1ff",
      lightsteelblue2: "#bcd2ee",
      lightsteelblue3: "#a2b5cd",
      lightsteelblue4: "#6e7b8b",
      lightyellow1: "#ffffe0",
      lightyellow2: "#eeeed1",
      lightyellow3: "#cdcdb4",
      lightyellow4: "#8b8b7a",
      mediumorchid1: "#e066ff",
      mediumorchid2: "#d15fee",
      mediumorchid3: "#b452cd",
      mediumorchid4: "#7a378b",
      mediumpurple1: "#ab82ff",
      mediumpurple2: "#9f79ee",
      mediumpurple3: "#8968cd",
      mediumpurple4: "#5d478b",
      mistyrose1: "#ffe4e1",
      mistyrose2: "#eed5d2",
      mistyrose3: "#cdb7b5",
      mistyrose4: "#8b7d7b",
      navajowhite1: "#ffdead",
      navajowhite2: "#eecfa1",
      navajowhite3: "#cdb38b",
      navajowhite4: "#8b795e",
      navyblue: "#000080",
      olivedrab1: "#c0ff3e",
      olivedrab2: "#b3ee3a",
      olivedrab3: "#9acd32",
      olivedrab4: "#698b22",
      orangered1: "#ff4500",
      orangered2: "#ee4000",
      orangered3: "#cd3700",
      orangered4: "#8b2500",
      palegreen1: "#9aff9a",
      palegreen2: "#90ee90",
      palegreen3: "#7ccd7c",
      palegreen4: "#548b54",
      paleturquoise1: "#bbffff",
      paleturquoise2: "#aeeeee",
      paleturquoise3: "#96cdcd",
      paleturquoise4: "#668b8b",
      palevioletred1: "#ff82ab",
      palevioletred2: "#ee799f",
      palevioletred3: "#cd6889",
      palevioletred4: "#8b475d",
      peachpuff1: "#ffdab9",
      peachpuff2: "#eecbad",
      peachpuff3: "#cdaf95",
      peachpuff4: "#8b7765",
      rosybrown1: "#ffc1c1",
      rosybrown2: "#eeb4b4",
      rosybrown3: "#cd9b9b",
      rosybrown4: "#8b6969",
      royalblue1: "#4876ff",
      royalblue2: "#436eee",
      royalblue3: "#3a5fcd",
      royalblue4: "#27408b",
      seagreen1: "#54ff9f",
      seagreen2: "#4eee94",
      seagreen3: "#43cd80",
      seagreen4: "#2e8b57",
      skyblue1: "#87ceff",
      skyblue2: "#7ec0ee",
      skyblue3: "#6ca6cd",
      skyblue4: "#4a708b",
      slateblue1: "#836fff",
      slateblue2: "#7a67ee",
      slateblue3: "#6959cd",
      slateblue4: "#473c8b",
      slategray1: "#c6e2ff",
      slategray2: "#b9d3ee",
      slategray3: "#9fb6cd",
      slategray4: "#6c7b8b",
      slategrey: "#708090",
      springgreen1: "#00ff7f",
      springgreen2: "#00ee76",
      springgreen3: "#00cd66",
      springgreen4: "#008b45",
      steelblue1: "#63b8ff",
      steelblue2: "#5cacee",
      steelblue3: "#4f94cd",
      steelblue4: "#36648b",
      violetred: "#d02090",
      violetred1: "#ff3e96",
      violetred2: "#ee3a8c",
      violetred3: "#cd3278",
      violetred4: "#8b2252",
      webgray: "#808080",
      webgreen: "#008000",
      webgrey: "#808080",
      webmaroon: "#800000",
      webpurple: "#800080",
      x11gray: "#bebebe",
      x11green: "#00ff00",
      x11grey: "#bebebe",
      x11maroon: "#b03060",
      x11purple: "#a020f0",
      aquamarine1: "#7fffd4",
      aquamarine2: "#76eec6",
      aquamarine3: "#66cdaa",
      aquamarine4: "#458b74",
      azure1: "#f0ffff",
      azure2: "#e0eeee",
      azure3: "#c1cdcd",
      azure4: "#838b8b",
      bisque1: "#ffe4c4",
      bisque2: "#eed5b7",
      bisque3: "#cdb79e",
      bisque4: "#8b7d6b",
      blue1: "#0000ff",
      blue2: "#0000ee",
      blue3: "#0000cd",
      blue4: "#00008b",
      brown1: "#ff4040",
      brown2: "#ee3b3b",
      brown3: "#cd3333",
      brown4: "#8b2323",
      burlywood1: "#ffd39b",
      burlywood2: "#eec591",
      burlywood3: "#cdaa7d",
      burlywood4: "#8b7355",
      chartreuse1: "#7fff00",
      chartreuse2: "#76ee00",
      chartreuse3: "#66cd00",
      chartreuse4: "#458b00",
      chocolate1: "#ff7f24",
      chocolate2: "#ee7621",
      chocolate3: "#cd661d",
      chocolate4: "#8b4513",
      coral1: "#ff7256",
      coral2: "#ee6a50",
      coral3: "#cd5b45",
      coral4: "#8b3e2f",
      cornsilk1: "#fff8dc",
      cornsilk2: "#eee8cd",
      cornsilk3: "#cdc8b1",
      cornsilk4: "#8b8878",
      cyan1: "#00ffff",
      cyan2: "#00eeee",
      cyan3: "#00cdcd",
      cyan4: "#008b8b",
      firebrick1: "#ff3030",
      firebrick2: "#ee2c2c",
      firebrick3: "#cd2626",
      firebrick4: "#8b1a1a",
      gold1: "#ffd700",
      gold2: "#eec900",
      gold3: "#cdad00",
      gold4: "#8b7500",
      goldenrod1: "#ffc125",
      goldenrod2: "#eeb422",
      goldenrod3: "#cd9b1d",
      goldenrod4: "#8b6914",
      gray0: "#000000",
      gray1: "#030303",
      gray10: "#1a1a1a",
      gray100: "#ffffff",
      gray11: "#1c1c1c",
      gray12: "#1f1f1f",
      gray13: "#212121",
      gray14: "#242424",
      gray15: "#262626",
      gray16: "#292929",
      gray17: "#2b2b2b",
      gray18: "#2e2e2e",
      gray19: "#303030",
      gray2: "#050505",
      gray20: "#333333",
      gray21: "#363636",
      gray22: "#383838",
      gray23: "#3b3b3b",
      gray24: "#3d3d3d",
      gray25: "#404040",
      gray26: "#424242",
      gray27: "#454545",
      gray28: "#474747",
      gray29: "#4a4a4a",
      gray3: "#080808",
      gray30: "#4d4d4d",
      gray31: "#4f4f4f",
      gray32: "#525252",
      gray33: "#545454",
      gray34: "#575757",
      gray35: "#595959",
      gray36: "#5c5c5c",
      gray37: "#5e5e5e",
      gray38: "#616161",
      gray39: "#636363",
      gray4: "#0a0a0a",
      gray40: "#666666",
      gray41: "#696969",
      gray42: "#6b6b6b",
      gray43: "#6e6e6e",
      gray44: "#707070",
      gray45: "#737373",
      gray46: "#757575",
      gray47: "#787878",
      gray48: "#7a7a7a",
      gray49: "#7d7d7d",
      gray5: "#0d0d0d",
      gray50: "#7f7f7f",
      gray51: "#828282",
      gray52: "#858585",
      gray53: "#878787",
      gray54: "#8a8a8a",
      gray55: "#8c8c8c",
      gray56: "#8f8f8f",
      gray57: "#919191",
      gray58: "#949494",
      gray59: "#969696",
      gray6: "#0f0f0f",
      gray60: "#999999",
      gray61: "#9c9c9c",
      gray62: "#9e9e9e",
      gray63: "#a1a1a1",
      gray64: "#a3a3a3",
      gray65: "#a6a6a6",
      gray66: "#a8a8a8",
      gray67: "#ababab",
      gray68: "#adadad",
      gray69: "#b0b0b0",
      gray7: "#121212",
      gray70: "#b3b3b3",
      gray71: "#b5b5b5",
      gray72: "#b8b8b8",
      gray73: "#bababa",
      gray74: "#bdbdbd",
      gray75: "#bfbfbf",
      gray76: "#c2c2c2",
      gray77: "#c4c4c4",
      gray78: "#c7c7c7",
      gray79: "#c9c9c9",
      gray8: "#141414",
      gray80: "#cccccc",
      gray81: "#cfcfcf",
      gray82: "#d1d1d1",
      gray83: "#d4d4d4",
      gray84: "#d6d6d6",
      gray85: "#d9d9d9",
      gray86: "#dbdbdb",
      gray87: "#dedede",
      gray88: "#e0e0e0",
      gray89: "#e3e3e3",
      gray9: "#171717",
      gray90: "#e5e5e5",
      gray91: "#e8e8e8",
      gray92: "#ebebeb",
      gray93: "#ededed",
      gray94: "#f0f0f0",
      gray95: "#f2f2f2",
      gray96: "#f5f5f5",
      gray97: "#f7f7f7",
      gray98: "#fafafa",
      gray99: "#fcfcfc",
      green1: "#00ff00",
      green2: "#00ee00",
      green3: "#00cd00",
      green4: "#008b00",
      grey: "#bebebe",
      grey0: "#000000",
      grey1: "#030303",
      grey10: "#1a1a1a",
      grey100: "#ffffff",
      grey11: "#1c1c1c",
      grey12: "#1f1f1f",
      grey13: "#212121",
      grey14: "#242424",
      grey15: "#262626",
      grey16: "#292929",
      grey17: "#2b2b2b",
      grey18: "#2e2e2e",
      grey19: "#303030",
      grey2: "#050505",
      grey20: "#333333",
      grey21: "#363636",
      grey22: "#383838",
      grey23: "#3b3b3b",
      grey24: "#3d3d3d",
      grey25: "#404040",
      grey26: "#424242",
      grey27: "#454545",
      grey28: "#474747",
      grey29: "#4a4a4a",
      grey3: "#080808",
      grey30: "#4d4d4d",
      grey31: "#4f4f4f",
      grey32: "#525252",
      grey33: "#545454",
      grey34: "#575757",
      grey35: "#595959",
      grey36: "#5c5c5c",
      grey37: "#5e5e5e",
      grey38: "#616161",
      grey39: "#636363",
      grey4: "#0a0a0a",
      grey40: "#666666",
      grey41: "#696969",
      grey42: "#6b6b6b",
      grey43: "#6e6e6e",
      grey44: "#707070",
      grey45: "#737373",
      grey46: "#757575",
      grey47: "#787878",
      grey48: "#7a7a7a",
      grey49: "#7d7d7d",
      grey5: "#0d0d0d",
      grey50: "#7f7f7f",
      grey51: "#828282",
      grey52: "#858585",
      grey53: "#878787",
      grey54: "#8a8a8a",
      grey55: "#8c8c8c",
      grey56: "#8f8f8f",
      grey57: "#919191",
      grey58: "#949494",
      grey59: "#969696",
      grey6: "#0f0f0f",
      grey60: "#999999",
      grey61: "#9c9c9c",
      grey62: "#9e9e9e",
      grey63: "#a1a1a1",
      grey64: "#a3a3a3",
      grey65: "#a6a6a6",
      grey66: "#a8a8a8",
      grey67: "#ababab",
      grey68: "#adadad",
      grey69: "#b0b0b0",
      grey7: "#121212",
      grey70: "#b3b3b3",
      grey71: "#b5b5b5",
      grey72: "#b8b8b8",
      grey73: "#bababa",
      grey74: "#bdbdbd",
      grey75: "#bfbfbf",
      grey76: "#c2c2c2",
      grey77: "#c4c4c4",
      grey78: "#c7c7c7",
      grey79: "#c9c9c9",
      grey8: "#141414",
      grey80: "#cccccc",
      grey81: "#cfcfcf",
      grey82: "#d1d1d1",
      grey83: "#d4d4d4",
      grey84: "#d6d6d6",
      grey85: "#d9d9d9",
      grey86: "#dbdbdb",
      grey87: "#dedede",
      grey88: "#e0e0e0",
      grey89: "#e3e3e3",
      grey9: "#171717",
      grey90: "#e5e5e5",
      grey91: "#e8e8e8",
      grey92: "#ebebeb",
      grey93: "#ededed",
      grey94: "#f0f0f0",
      grey95: "#f2f2f2",
      grey96: "#f5f5f5",
      grey97: "#f7f7f7",
      grey98: "#fafafa",
      grey99: "#fcfcfc",
      honeydew1: "#f0fff0",
      honeydew2: "#e0eee0",
      honeydew3: "#c1cdc1",
      honeydew4: "#838b83",
      ivory1: "#fffff0",
      ivory2: "#eeeee0",
      ivory3: "#cdcdc1",
      ivory4: "#8b8b83",
      khaki1: "#fff68f",
      khaki2: "#eee685",
      khaki3: "#cdc673",
      khaki4: "#8b864e",
      magenta1: "#ff00ff",
      magenta2: "#ee00ee",
      magenta3: "#cd00cd",
      magenta4: "#8b008b",
      maroon1: "#ff34b3",
      maroon2: "#ee30a7",
      maroon3: "#cd2990",
      maroon4: "#8b1c62",
      orange1: "#ffa500",
      orange2: "#ee9a00",
      orange3: "#cd8500",
      orange4: "#8b5a00",
      orchid1: "#ff83fa",
      orchid2: "#ee7ae9",
      orchid3: "#cd69c9",
      orchid4: "#8b4789",
      pink1: "#ffb5c5",
      pink2: "#eea9b8",
      pink3: "#cd919e",
      pink4: "#8b636c",
      plum1: "#ffbbff",
      plum2: "#eeaeee",
      plum3: "#cd96cd",
      plum4: "#8b668b",
      purple1: "#9b30ff",
      purple2: "#912cee",
      purple3: "#7d26cd",
      purple4: "#551a8b",
      red1: "#ff0000",
      red2: "#ee0000",
      red3: "#cd0000",
      red4: "#8b0000",
      salmon1: "#ff8c69",
      salmon2: "#ee8262",
      salmon3: "#cd7054",
      salmon4: "#8b4c39",
      seashell1: "#fff5ee",
      seashell2: "#eee5de",
      seashell3: "#cdc5bf",
      seashell4: "#8b8682",
      sienna1: "#ff8247",
      sienna2: "#ee7942",
      sienna3: "#cd6839",
      sienna4: "#8b4726",
      snow1: "#fffafa",
      snow2: "#eee9e9",
      snow3: "#cdc9c9",
      snow4: "#8b8989",
      tan1: "#ffa54f",
      tan2: "#ee9a49",
      tan3: "#cd853f",
      tan4: "#8b5a2b",
      thistle1: "#ffe1ff",
      thistle2: "#eed2ee",
      thistle3: "#cdb5cd",
      thistle4: "#8b7b8b",
      tomato1: "#ff6347",
      tomato2: "#ee5c42",
      tomato3: "#cd4f39",
      tomato4: "#8b3626",
      turquoise1: "#00f5ff",
      turquoise2: "#00e5ee",
      turquoise3: "#00c5cd",
      turquoise4: "#00868b",
      wheat1: "#ffe7ba",
      wheat2: "#eed8ae",
      wheat3: "#cdba96",
      wheat4: "#8b7e66",
      yellow1: "#ffff00",
      yellow2: "#eeee00",
      yellow3: "#cdcd00",
      yellow4: "#8b8b00",
    };
    if (!a) return "";
    var c = a.toLowerCase();
    return "undefined" !== typeof b[c]
      ? b[c]
      : (b = a.match(/rgb\((\d+)[,\s]+(\d+)[,\s]+(\d+)\)/i))
        ? sprintf("#%02x%02x%02x", b[1], b[2], b[3])
        : a;
  };
  a.parseStaticColors = function (c) {
    var b,
      d = [];
    if ("string" === typeof c)
      try {
        c = JSON.parse(c);
      } catch (h) {}
    $.isArray(c) || a.error("invalid input for static colors");
    for (b = 0; b < c.length; b++) {
      var e = "string" === typeof c[b] ? c[b].split(":") : c[b];
      if ($.isArray(e)) {
        e[0] || a.error("no color specified: " + c[b]);
        try {
          var f = tinycolor(e[0]);
        } catch (h) {
          a.error("invalid color: " + e[0]);
        }
        a.isNull(e[1])
          ? ((e[1] = 1), (e[2] = Infinity))
          : (e[1] = "" === e[1] ? -Infinity : parseFloat(e[1]));
        a.isNull(e[2]) ? (e[2] = e[1]) : (e[2] = "" === e[2] ? Infinity : parseFloat(e[2]));
        var g = {
          active: !0,
          red: f._r,
          green: f._g,
          blue: f._b,
          alpha: 255 * f._a,
          min: e[1],
          max: e[2],
        };
        "string" === typeof e[0] && (g.name = e[0]);
      } else "object" === typeof e && (g = e);
      d.push(g);
    }
    d.sort(function (a, b) {
      return a.min - b.min;
    });
    return d;
  };
  a.lookupStaticColor = function (a, b, d) {
    var c = { red: 0, green: 0, blue: 0, alpha: 0 };
    if (a && a.staticObj) {
      c = a.params.nocolor || c;
      if (b < a.staticObj.colors[0].min) return c;
      if (d && d[b]) return d[b];
      a: {
        var f = a.staticObj.colors;
        for (var g, h, l = 0, m = f.length - 1; l <= m; )
          if (((g = Math.floor((l + m) / 2)), (h = f[g]), b >= h.min && b <= h.max)) {
            f = g;
            break a;
          } else h.max < b ? (l = g + 1) : (m = g - 1);
        f = -1;
      }
      0 > f ? (a = c) : ((a = a.staticObj.colors[f]), a.active || (a = c));
      d && 1e7 >= b && (d[b] = a);
      return a;
    }
    return c;
  };
  a.strtoscaled = function (c) {
    c = a.saostrtod(c);
    var b = String.fromCharCode(a.saodtype());
    switch (b) {
      case '"':
        c /= 3600;
        break;
      case "'":
        c /= 60;
        break;
      case "r":
        c *= 180 / Math.PI;
    }
    return { dval: c, dtype: b };
  };
  a.cleanPath = function (c, b) {
    if (!c) return "";
    var d = c.replace(/\[.*\]/, "");
    d.match(
      /(<(animation|form|math|maction|svg|script|video)\s|<\?xml|javascript:|on.*&equals;|alert\(|alert&lpar;)|window\./i
    ) &&
      ((a.globalOpts.alerts = !0),
      a.error((b || "filename") + " is susceptible to XSS attack: " + d));
    return c
      .trim()
      .replace(/\/\.\//, "/")
      .replace(/^\.\//, "");
  };
  a.fixPath = function (c, b) {
    b = b || {};
    window.electron &&
      a.desktopOpts.currentPath &&
      !1 !== b.fixpath &&
      !c.match(a.URLEXP) &&
      (c.match(/^\${JS9_DIR}\//)
        ? (c = c.replace(/^\${JS9_DIR}\//, a.INSTALLDIR))
        : c.match(/^\${JS9_INSTALLDIR}\//)
          ? (c = c.replace(/^\${JS9_INSTALLDIR}\//, a.INSTALLDIR))
          : c.match(/^\${JS9_PAGEDIR}\//)
            ? (c = c.replace(/^\${JS9_PAGEDIR}\//, ""))
            : "/" !== c.charAt(0) && (c = window.electron.currentDir + "/" + c));
    return c;
  };
  a.localAccess = function (c) {
    if (!c || !a.globalOpts.localAccess || !a.hostFS) return null;
    c = c.replace(/\[.*\]/, "");
    var b = "." + c.split(".").pop().toLowerCase();
    c = a.hostFS + "/" + c;
    return 0 <= a.vsize(c) && 0 <= $.inArray(b, a.globalOpts.localTemplates.split(","))
      ? (2 < a.DEBUG && a.log("local access file: %s", c), c)
      : null;
  };
  a.dirname = function (a) {
    return a && a.includes("/") ? a.match(/.*\//)[0] : "";
  };
  a.mouseDownCB = function (c) {
    var b = c.data,
      d = b.image,
      e = $(document).scrollLeft(),
      f = $(document).scrollTop();
    if (d) {
      a.globalOpts.clickToFocus && (d.display.displayConjq.focus(), window.scrollTo(e, f));
      c.target && (d.posOffset = $(c.target).offset());
      d.pos0 = a.eventToDisplayPos(c, d.posOffset);
      d.pos = d.pos0;
      d.ipos0 = d.displayToImagePos(d.pos);
      d.ipos = d.ipos0;
      b.resizing = b.inResize(d.pos);
      if (!b.resizing) {
        c.preventDefault();
        Object.prototype.hasOwnProperty.call(a, "MouseTouch") && a.MouseTouch.action(d, c, "start");
        if (d.clickInRegion && "regions" === d.clickInLayer) {
          d.display.clearMessage("regions");
          return;
        }
        a.specialKey(c) || d.xeqPlugins("mouse", "onmousedown", c);
      }
      d.clickState = c.which;
      switch (c.which) {
        case 3:
          d.clickState = 2;
      }
      c.originalEvent &&
        c.originalEvent.touches &&
        c.originalEvent.touches.length &&
        (d.clickState = -c.originalEvent.touches.length);
      $(document).on("mousemove." + b.id, b, function (b) {
        return a.mouseMoveCB(b);
      });
      $(document).on("mouseup." + b.id, b, function (b) {
        return a.mouseUpCB(b);
      });
    }
  };
  a.mouseUpCB = function (c) {
    var b,
      d = c.data;
    if ((b = d.image)) {
      b.pos = a.eventToDisplayPos(c, b.posOffset);
      b.ipos = b.displayToImagePos(b.pos);
      var e = Math.abs(b.pos0.x - b.pos.x) < a.NOMOVE && Math.abs(b.pos0.y - b.pos.y) < a.NOMOVE;
      d.inResize(b.pos) || c.preventDefault();
      Object.prototype.hasOwnProperty.call(a, "MouseTouch") && a.MouseTouch.action(b, c, "stop");
      b.clickInRegion &&
        b.clickInLayer &&
        (e || b.updateShapes(b.clickInLayer, "selected", "update"));
      if (a.specialKey(c))
        e &&
          !b.clickInRegion &&
          a.globalOpts.metaClickPan &&
          (b.editAnnulus ? b._regroupAnnulus("regions", c) : b.setPan(b.ipos.x, b.ipos.y));
      else {
        b.xeqPlugins("mouse", "onmouseup", c);
        if (
          e &&
          (b.xeqPlugins("mouse", "onclick", c), Object.prototype.hasOwnProperty.call(a, "Menubar"))
        )
          a.Menubar.onclick(b.display);
        "click" === a.globalOpts.dynamicSelect &&
          a.Dysel.getDisplayOr(d) !== d &&
          a.Dysel.select(d);
      }
      b.clickInRegion = !1;
      b.clickInLayer = null;
      b.clickState = 0;
      b.posOffset = null;
      b.tmp.panzoomRefresh && (b.refreshLayers(b.tmp.panzoomRefresh), delete b.tmp.panzoomRefresh);
      d.resizing &&
        ((d.resizing = !1),
        a.bugs.webkit_resize &&
          ((c = parseInt(d.divjq.css("width"), 10)),
          (e = parseInt(d.divjq.css("height"), 10)),
          c < d.owidth && d.divjq.css("width", d.owidth + a.RESIZEFUDGE),
          e < d.oheight && d.divjq.css("height", d.oheight + a.RESIZEFUDGE)),
        a.globalOpts.resizeRedisplay || (b.displayImage("all"), b.refreshLayers()));
      $(document).off("mouseup." + d.id);
      $(document).off("mousemove." + d.id);
      for (b = 0; b < a.displays.length; b++)
        ((c = a.displays[b]),
          c !== d && c.image && c.image.clickState && c.divjq.trigger("mouseup"));
    } else if (Object.prototype.hasOwnProperty.call(a, "Menubar")) a.Menubar.onclick(c.data);
  };
  a.mouseMoveCB = function (c) {
    var b = c.data;
    var d = b.image;
    d &&
      !a.specialKey(c) &&
      ((d.pos = a.eventToDisplayPos(c, d.posOffset)),
      (d.ipos = d.displayToImagePos(d.pos)),
      d.pos0 || (d.pos0 = d.pos),
      d.ipos0 || (d.ipos0 = d.ipos),
      b.resizing ||
        (c.preventDefault(),
        (d.valpos = null),
        d.clickInRegion &&
          "regions" === d.clickInLayer &&
          (b = d.display.layers.regions.params.sel) &&
          b.params &&
          ((d.params.listonchange || b.params.listonchange || a.globalOpts.intensivePlugins) &&
            d._updateShape("regions", b, null, "move"),
          (d.params.listonchange || b.params.listonchange) &&
            d.listRegions("selected", { mode: 2 }),
          a.globalOpts.intensivePlugins && d.xeqPlugins("region", "onregionsmove", b.pub)),
        Object.prototype.hasOwnProperty.call(a, "MouseTouch") && a.MouseTouch.action(d, c),
        Object.prototype.hasOwnProperty.call(a, "Crosshair") &&
          d.tmp.arrowCrosshairVisible &&
          !d.params.crosshair &&
          a.Crosshair.hide(d, d.ipos, c),
        d.valpos || (d.valpos = d.updateValpos(d.ipos, !1)),
        a.specialKey(c) || d.xeqPlugins("mouse", "onmousemove", c)));
  };
  a.mouseEnterCB = function (c) {
    var b = c.data,
      d = b.image;
    c.preventDefault();
    d &&
      (a.specialKey(c) ||
        ("move" === a.globalOpts.dynamicSelect &&
          a.Dysel.getDisplayOr(b) !== b &&
          a.Dysel.select(b)));
  };
  a.mouseOverCB = function (c) {
    var b = c.data.image,
      d = $(document).scrollLeft(),
      e = $(document).scrollTop();
    c.preventDefault();
    b &&
      (a.globalOpts.clickToFocus || (b.display.displayConjq.focus(), window.scrollTo(d, e)),
      a.specialKey(c) ||
        ((b.pos = a.eventToDisplayPos(c)),
        (b.ipos = b.displayToImagePos(b.pos)),
        a.specialKey(c) || b.xeqPlugins("mouse", "onmouseover", c)));
  };
  a.mouseOutCB = function (c) {
    var b = c.data.image;
    c.preventDefault();
    b &&
      (a.globalOpts.clickToFocus || b.display.displayConjq.blur(),
      b.clickInRegion && b.clickInLayer && b.updateShapes(b.clickInLayer, "selected", "mouseout"),
      a.specialKey(c) ||
        ((b.pos = a.eventToDisplayPos(c)),
        (b.ipos = b.displayToImagePos(b.pos)),
        a.specialKey(c) || b.xeqPlugins("mouse", "onmouseout", c)));
  };
  a.wheelCB = function (c) {
    var b = c.data.image;
    b &&
      a.globalOpts.mousetouchZoom &&
      Object.prototype.hasOwnProperty.call(a, "MouseTouch") &&
      a.MouseTouch.Actions["wheel zoom"] &&
      (a.MouseTouch.Actions["wheel zoom"](b, c), c.preventDefault());
  };
  a.keyPressCB = function (a) {
    var b = a.data.image;
    a.preventDefault();
    b && b.xeqPlugins("keypress", "onkeypress", a);
  };
  a.keyDownCB = function (c) {
    var b = c.data.image;
    c.preventDefault();
    if (Object.prototype.hasOwnProperty.call(a, "Keyboard")) {
      var d = b ? b.ipos : { x: null, y: null };
      a.Keyboard.action(b, d, c);
    }
    b && b.xeqPlugins("keydown", "onkeydown", c);
  };
  a.keyUpCB = function (a) {
    var b = a.data.image;
    b && b.xeqPlugins("keydown", "onkeyup", a);
  };
  a.dragenterCB = function (a, b) {
    b.stopPropagation();
    b.preventDefault();
  };
  a.dragoverCB = function (a, b) {
    b.stopPropagation();
    b.preventDefault();
  };
  a.dragexitCB = function (a, b) {
    b.stopPropagation();
    b.preventDefault();
  };
  a.dragdropCB = function (c, b) {
    var d;
    b.originalEvent && (b = b.originalEvent);
    b.stopPropagation();
    b.preventDefault();
    var e = $.extend(!0, {}, a.fits.options);
    e.display = e.display || c;
    e.extlist = e.extlist || a.globalOpts.extlist;
    var f = b.target.files || b.dataTransfer.files;
    var g = a.lookupDisplay(e.display);
    f.length
      ? window.setTimeout(function () {
          for (d = 0; d < f.length; d++) {
            var b = f[d];
            var c = b.path || b.name || "";
            c.match(/\.reg$/)
              ? a.LoadRegions(b, { display: e.display })
              : c.match(/\.cat$/)
                ? a.LoadCatalog(null, b, { display: e.display })
                : c.match(/\.ses$/)
                  ? a.LoadSession(b, { display: e.display })
                  : c.match(/\.js9ses$/)
                    ? a.LoadSession(b, { display: e.display })
                    : c.match(/\.cmap$/)
                      ? a.LoadColormap(b)
                      : (a.waiting(!0, g),
                        (e.refresh = a.globalOpts.refreshDragDrop),
                        (e.localAccess = !0),
                        a.Load(b, e, { display: e.display }));
          }
        }, a.SPINOUT)
      : ((c = b.dataTransfer.getData("text")),
        c.match(a.URLEXP) && a.globalOpts.loadProxy && a.LoadProxy(c, { display: e.display }));
  };
  a.RegisterPlugin = function (c, b, d, e) {
    var f;
    if (c && b && d) {
      var g = c + b;
      e
        ? (e.viewMenuItem && (e.menuItem = e.viewMenuItem),
          e.menuItem && !e.menu && (e.menu = "view"),
          e.menu && (e.menu = e.menu.toLowerCase()))
        : (e = []);
      a.PLUGINS && (a.PLUGINS += "|");
      a.PLUGINS += g.replace(/JS9/, "");
      a.PLUGINS += "|";
      a.PLUGINS += b;
      a.plugins.push({ xclass: c, xname: b, name: g, opts: e, func: d, instances: [] });
      e.help &&
        ((d = e.help.match(/^.*[\\/]/)),
        d[0] && (f = "plugins/" + d[0].replace(/[\\/]+$/, "")),
        (d = e.help.replace(/^.*[\\/]/, "")),
        (e = e.menuItem ? e.menuItem : g),
        (a.helpOpts[b] = { type: f, url: d, heading: c, title: e }));
      a.inited && a.instantiatePlugins();
    }
  };
  a.instantiatePlugin = function (c, b, d, e) {
    var f,
      g = "visible";
    if ("string" === typeof b) {
      for (f = 0; f < a.plugins.length; f++) {
        var h = a.plugins[f];
        if (h.name === b) {
          b = h;
          break;
        }
      }
      "string" === typeof b && a.error("unknown plugin: " + b);
    }
    h = Object.create(b.func.prototype);
    h.name = b.name;
    h.isActive = function (a) {
      if (
        "active" !== this.status ||
        (a && !Object.prototype.hasOwnProperty.call(this.plugin.opts, a))
      )
        return !1;
      switch (this.winType) {
        case "virtual":
          return !0;
        default:
          return this.divjq.is(":visible");
      }
    };
    h.errLog = function (b, c) {
      a.log("error in %s: %s [%s]\n%s", b, this.name, c.message, a.strace(c));
    };
    if (c) {
      var l = c instanceof jQuery ? c : "object" === typeof c ? $(c) : $("#" + c);
      for (f = 0; f < b.instances.length; f++)
        if (l.is(b.instances[f].odivjq)) return b.instances[f];
    } else l = $("div");
    c
      ? d
        ? ((h.id = l.attr("id") || b.name),
          (h.winType = "light"),
          (h.winHandle = d),
          (h.odivjq = l),
          (h.divjq = l),
          (h.outerdivjq = h.divjq.closest(a.lightOpts[a.LIGHTWIN].top)))
        : ((h.id = l.attr("id") || b.name),
          (h.winType = "div"),
          0 <= $.inArray(h.name, a.globalOpts.hiddenPluginDivs) && (g = "hidden"),
          l.wrap("<div class='JS9PluginContainer' style='visibility: " + g + "'>"),
          (h.odivjq = l),
          (h.divjq = l),
          h.divjq.addClass(b.xclass + "Plugin").addClass("JS9Plugin"),
          h.odivjq.attr("id") || h.odivjq.attr("id", h.id),
          (h.outerdivjq = h.divjq.closest(".JS9PluginContainer")),
          !1 !== l.data("toolbarseparate") &&
            (b.opts.toolbarSeparate || l.data("toolbarseparate")) &&
            ((d = "<div class='" + a.lightOpts[a.LIGHTWIN].dragBar.substr(1) + "'>"),
            $(d).insertBefore(h.divjq)))
      : ((h.id = b.name), (h.winType = "virtual"));
    h.plugin = b;
    h.el = c;
    h.status = "active";
    b.instances.push(h);
    if ("virtual" === h.winType)
      for (f = 0; f < a.displays.length; f++)
        a.displays[f].pluginInstances[b.name] ||
          ((h.div = null),
          (h.display = a.displays[f]),
          b.func.apply(h, e),
          (a.displays[f].pluginInstances[b.name] = h));
    else {
      h.div = h.divjq[0];
      h.outerdiv = h.outerdivjq[0];
      !b.opts.winDims ||
        (h.divjq.width() && h.divjq.height()) ||
        (h.divjq.css("width", b.opts.winDims[0]), h.divjq.css("height", b.opts.winDims[1]));
      c = h.divjq.data("js9id") || h.id;
      if ("*" === c)
        if (b.opts.dynamicSelect) {
          h.display = a.displays[0];
          h.isDynamic = !0;
          a.Dysel.addPlugins(b.name);
          var m = "*";
        } else a.error(b.name + " is not dynamically selectable");
      else ((h.display = a.lookupDisplay(c)), (m = h.display.id));
      if ((l = l.data("toolbarhtml") || b.opts.toolbarHTML))
        ((l = a.Image.prototype.expandMacro.call(null, l, [
          { name: "title", value: b.opts.winTitle || "" },
        ])),
          (c = h.divjq.closest(a.lightOpts[a.LIGHTWIN].drag)),
          0 === c.length && (c = h.divjq),
          $("<div class='JS9PluginToolbar-" + h.winType + "'>")
            .css("z-index", a.BTNZINDEX)
            .html(l)
            .data("displayid", m)
            .insertAfter(c));
      h.display.pluginInstances[b.name] = h;
      b.func.apply(h, e);
      if ("*" === m)
        for (f = 0; f < a.displays.length; f++)
          a.displays[f].pluginInstances[b.name]
            ? (h.display = a.displays[f])
            : (a.displays[f].pluginInstances[b.name] = h);
    }
    return h;
  };
  a.instantiatePlugins = function () {
    var c,
      b = function (b) {
        var c, d;
        $("div." + b.name).each(function (c, d) {
          a.instantiatePlugin($(d), b, null, b.opts.divArgs);
        });
        b.opts.menuItem ||
          !b.opts.winDims ||
          b.opts.winDims[0] ||
          b.opts.winDims[1] ||
          a.instantiatePlugin(null, b, null, b.opts.divArgs);
        for (c = 0; c < b.instances.length; c++) {
          var g = b.instances[c];
          if (g.isDynamic)
            for (d = 0; d < a.displays.length; d++)
              a.displays[d].pluginInstances[b.name] || (a.displays[d].pluginInstances[b.name] = g);
        }
      };
    for (c = 0; c < a.plugins.length; c++) b(a.plugins[c]);
  };
  a.initEmscripten = function () {
    var c = { responseType: "arraybuffer", allowCache: !0 };
    if (!Object.prototype.hasOwnProperty.call(window, "Astroem"))
      if ("object" === typeof WebAssembly && a.globalOpts.useWasm)
        ((a.globalOpts.astroemWasm = a.InstallDir(Module.wasmBinaryFile || "astroemw.wasm")),
          a.fetchURL(a.globalOpts.astroemWasm, null, c, function (b) {
            Module.wasmBinary = b;
            a.globalOpts.astroemURL = a.InstallDir("astroemw.js");
            try {
              a.loadScript(a.globalOpts.astroemURL);
            } catch (d) {
              a.error("can't load " + a.globalOpts.astroemURL);
            }
          }));
      else {
        a.globalOpts.astroemURL = a.InstallDir("astroem.js");
        try {
          a.loadScript(a.globalOpts.astroemURL);
        } catch (b) {
          a.error("can't load " + a.globalOpts.astroemURL);
        }
      }
  };
  a.initFITS = function () {
    Object.prototype.hasOwnProperty.call(window, "Astroem") &&
      ((a.vmalloc = Astroem.vmalloc),
      (a.vfree = Astroem.vfree),
      (a.vheap = Astroem.vheap),
      (a.vmemcpy = Astroem.vmemcpy),
      (a.vstrcpy = Astroem.vstrcpy),
      (a.vfile = Astroem.vfile),
      (a.vread = Astroem.vread),
      (a.vunlink = Astroem.vunlink),
      (a.vsize = Astroem.vsize),
      (a.vmount = Astroem.vmount),
      (a.arrfile = Astroem.arrfile),
      (a.listhdu = Astroem.listhdu),
      (a.initwcs = Astroem.initwcs),
      (a.freewcs = Astroem.freewcs),
      (a.wcsinfo = Astroem.wcsinfo),
      (a.wcssys = Astroem.wcssys),
      (a.wcsunits = Astroem.wcsunits),
      (a.pix2wcs = Astroem.pix2wcs),
      (a.wcs2pix = Astroem.wcs2pix),
      (a.reg2wcs = Astroem.reg2wcs),
      (a.saostrtod = Astroem.saostrtod),
      (a.saodtostr = Astroem.saodtostr),
      (a.saodtype = Astroem.saodtype),
      (a.zscale = Astroem.zscale),
      (a.tanhdr = Astroem.tanhdr),
      (a.reproject = Astroem.reproject),
      (a.madd = Astroem.madd),
      (a.imgtbl = Astroem.imgtbl),
      (a.makehdr = Astroem.makehdr),
      (a.shrinkhdr = Astroem.shrinkhdr),
      (a.imsection = Astroem.imsection),
      (a.regcnts = Astroem.regcnts),
      a.fitsLibrary("cfitsio"));
  };
  a.initColormaps = function () {
    Object.prototype.hasOwnProperty.call(a, "Colormap") &&
      (a.checkNew(
        new a.Colormap(
          "grey",
          [
            [0, 0],
            [1, 1],
          ],
          [
            [0, 0],
            [1, 1],
          ],
          [
            [0, 0],
            [1, 1],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "red",
          [
            [0, 0],
            [1, 1],
          ],
          [
            [0, 0],
            [0, 0],
          ],
          [
            [0, 0],
            [0, 0],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "green",
          [
            [0, 0],
            [0, 0],
          ],
          [
            [0, 0],
            [1, 1],
          ],
          [
            [0, 0],
            [0, 0],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "blue",
          [
            [0, 0],
            [0, 0],
          ],
          [
            [0, 0],
            [0, 0],
          ],
          [
            [0, 0],
            [1, 1],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "heat",
          [
            [0, 0],
            [0.34, 1],
            [1, 1],
          ],
          [
            [0, 0],
            [1, 1],
          ],
          [
            [0, 0],
            [0.65, 0],
            [0.98, 1],
            [1, 1],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "cool",
          [
            [0, 0],
            [0.29, 0],
            [0.76, 0.1],
            [1, 1],
          ],
          [
            [0, 0],
            [0.22, 0],
            [0.96, 1],
            [1, 1],
          ],
          [
            [0, 0],
            [0.53, 1],
            [1, 1],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap("turbo", [
          [0.18995, 0.07176, 0.23217],
          [0.19483, 0.08339, 0.26149],
          [0.19956, 0.09498, 0.29024],
          [0.20415, 0.10652, 0.31844],
          [0.2086, 0.11802, 0.34607],
          [0.21291, 0.12947, 0.37314],
          [0.21708, 0.14087, 0.39964],
          [0.22111, 0.15223, 0.42558],
          [0.225, 0.16354, 0.45096],
          [0.22875, 0.17481, 0.47578],
          [0.23236, 0.18603, 0.50004],
          [0.23582, 0.1972, 0.52373],
          [0.23915, 0.20833, 0.54686],
          [0.24234, 0.21941, 0.56942],
          [0.24539, 0.23044, 0.59142],
          [0.2483, 0.24143, 0.61286],
          [0.25107, 0.25237, 0.63374],
          [0.25369, 0.26327, 0.65406],
          [0.25618, 0.27412, 0.67381],
          [0.25853, 0.28492, 0.693],
          [0.26074, 0.29568, 0.71162],
          [0.2628, 0.30639, 0.72968],
          [0.26473, 0.31706, 0.74718],
          [0.26652, 0.32768, 0.76412],
          [0.26816, 0.33825, 0.7805],
          [0.26967, 0.34878, 0.79631],
          [0.27103, 0.35926, 0.81156],
          [0.27226, 0.3697, 0.82624],
          [0.27334, 0.38008, 0.84037],
          [0.27429, 0.39043, 0.85393],
          [0.27509, 0.40072, 0.86692],
          [0.27576, 0.41097, 0.87936],
          [0.27628, 0.42118, 0.89123],
          [0.27667, 0.43134, 0.90254],
          [0.27691, 0.44145, 0.91328],
          [0.27701, 0.45152, 0.92347],
          [0.27698, 0.46153, 0.93309],
          [0.2768, 0.47151, 0.94214],
          [0.27648, 0.48144, 0.95064],
          [0.27603, 0.49132, 0.95857],
          [0.27543, 0.50115, 0.96594],
          [0.27469, 0.51094, 0.97275],
          [0.27381, 0.52069, 0.97899],
          [0.27273, 0.5304, 0.98461],
          [0.27106, 0.54015, 0.9893],
          [0.26878, 0.54995, 0.99303],
          [0.26592, 0.55979, 0.99583],
          [0.26252, 0.56967, 0.99773],
          [0.25862, 0.57958, 0.99876],
          [0.25425, 0.5895, 0.99896],
          [0.24946, 0.59943, 0.99835],
          [0.24427, 0.60937, 0.99697],
          [0.23874, 0.61931, 0.99485],
          [0.23288, 0.62923, 0.99202],
          [0.22676, 0.63913, 0.98851],
          [0.22039, 0.64901, 0.98436],
          [0.21382, 0.65886, 0.97959],
          [0.20708, 0.66866, 0.97423],
          [0.20021, 0.67842, 0.96833],
          [0.19326, 0.68812, 0.9619],
          [0.18625, 0.69775, 0.95498],
          [0.17923, 0.70732, 0.94761],
          [0.17223, 0.7168, 0.93981],
          [0.16529, 0.7262, 0.93161],
          [0.15844, 0.73551, 0.92305],
          [0.15173, 0.74472, 0.91416],
          [0.14519, 0.75381, 0.90496],
          [0.13886, 0.76279, 0.8955],
          [0.13278, 0.77165, 0.8858],
          [0.12698, 0.78037, 0.8759],
          [0.12151, 0.78896, 0.86581],
          [0.11639, 0.7974, 0.85559],
          [0.11167, 0.80569, 0.84525],
          [0.10738, 0.81381, 0.83484],
          [0.10357, 0.82177, 0.82437],
          [0.10026, 0.82955, 0.81389],
          [0.0975, 0.83714, 0.80342],
          [0.09532, 0.84455, 0.79299],
          [0.09377, 0.85175, 0.78264],
          [0.09287, 0.85875, 0.7724],
          [0.09267, 0.86554, 0.7623],
          [0.0932, 0.87211, 0.75237],
          [0.09451, 0.87844, 0.74265],
          [0.09662, 0.88454, 0.73316],
          [0.09958, 0.8904, 0.72393],
          [0.10342, 0.896, 0.715],
          [0.10815, 0.90142, 0.70599],
          [0.11374, 0.90673, 0.69651],
          [0.12014, 0.91193, 0.6866],
          [0.12733, 0.91701, 0.67627],
          [0.13526, 0.92197, 0.66556],
          [0.14391, 0.9268, 0.65448],
          [0.15323, 0.93151, 0.64308],
          [0.16319, 0.93609, 0.63137],
          [0.17377, 0.94053, 0.61938],
          [0.18491, 0.94484, 0.60713],
          [0.19659, 0.94901, 0.59466],
          [0.20877, 0.95304, 0.58199],
          [0.22142, 0.95692, 0.56914],
          [0.23449, 0.96065, 0.55614],
          [0.24797, 0.96423, 0.54303],
          [0.2618, 0.96765, 0.52981],
          [0.27597, 0.97092, 0.51653],
          [0.29042, 0.97403, 0.50321],
          [0.30513, 0.97697, 0.48987],
          [0.32006, 0.97974, 0.47654],
          [0.33517, 0.98234, 0.46325],
          [0.35043, 0.98477, 0.45002],
          [0.36581, 0.98702, 0.43688],
          [0.38127, 0.98909, 0.42386],
          [0.39678, 0.99098, 0.41098],
          [0.41229, 0.99268, 0.39826],
          [0.42778, 0.99419, 0.38575],
          [0.44321, 0.99551, 0.37345],
          [0.45854, 0.99663, 0.3614],
          [0.47375, 0.99755, 0.34963],
          [0.48879, 0.99828, 0.33816],
          [0.50362, 0.99879, 0.32701],
          [0.51822, 0.9991, 0.31622],
          [0.53255, 0.99919, 0.30581],
          [0.54658, 0.99907, 0.29581],
          [0.56026, 0.99873, 0.28623],
          [0.57357, 0.99817, 0.27712],
          [0.58646, 0.99739, 0.26849],
          [0.59891, 0.99638, 0.26038],
          [0.61088, 0.99514, 0.2528],
          [0.62233, 0.99366, 0.24579],
          [0.63323, 0.99195, 0.23937],
          [0.64362, 0.98999, 0.23356],
          [0.65394, 0.98775, 0.22835],
          [0.66428, 0.98524, 0.2237],
          [0.67462, 0.98246, 0.2196],
          [0.68494, 0.97941, 0.21602],
          [0.69525, 0.9761, 0.21294],
          [0.70553, 0.97255, 0.21032],
          [0.71577, 0.96875, 0.20815],
          [0.72596, 0.9647, 0.2064],
          [0.7361, 0.96043, 0.20504],
          [0.74617, 0.95593, 0.20406],
          [0.75617, 0.95121, 0.20343],
          [0.76608, 0.94627, 0.20311],
          [0.77591, 0.94113, 0.2031],
          [0.78563, 0.93579, 0.20336],
          [0.79524, 0.93025, 0.20386],
          [0.80473, 0.92452, 0.20459],
          [0.8141, 0.91861, 0.20552],
          [0.82333, 0.91253, 0.20663],
          [0.83241, 0.90627, 0.20788],
          [0.84133, 0.89986, 0.20926],
          [0.8501, 0.89328, 0.21074],
          [0.85868, 0.88655, 0.2123],
          [0.86709, 0.87968, 0.21391],
          [0.8753, 0.87267, 0.21555],
          [0.88331, 0.86553, 0.21719],
          [0.89112, 0.85826, 0.2188],
          [0.8987, 0.85087, 0.22038],
          [0.90605, 0.84337, 0.22188],
          [0.91317, 0.83576, 0.22328],
          [0.92004, 0.82806, 0.22456],
          [0.92666, 0.82025, 0.2257],
          [0.93301, 0.81236, 0.22667],
          [0.93909, 0.80439, 0.22744],
          [0.94489, 0.79634, 0.228],
          [0.95039, 0.78823, 0.22831],
          [0.9556, 0.78005, 0.22836],
          [0.96049, 0.77181, 0.22811],
          [0.96507, 0.76352, 0.22754],
          [0.96931, 0.75519, 0.22663],
          [0.97323, 0.74682, 0.22536],
          [0.97679, 0.73842, 0.22369],
          [0.98, 0.73, 0.22161],
          [0.98289, 0.7214, 0.21918],
          [0.98549, 0.7125, 0.2165],
          [0.98781, 0.7033, 0.21358],
          [0.98986, 0.69382, 0.21043],
          [0.99163, 0.68408, 0.20706],
          [0.99314, 0.67408, 0.20348],
          [0.99438, 0.66386, 0.19971],
          [0.99535, 0.65341, 0.19577],
          [0.99607, 0.64277, 0.19165],
          [0.99654, 0.63193, 0.18738],
          [0.99675, 0.62093, 0.18297],
          [0.99672, 0.60977, 0.17842],
          [0.99644, 0.59846, 0.17376],
          [0.99593, 0.58703, 0.16899],
          [0.99517, 0.57549, 0.16412],
          [0.99419, 0.56386, 0.15918],
          [0.99297, 0.55214, 0.15417],
          [0.99153, 0.54036, 0.1491],
          [0.98987, 0.52854, 0.14398],
          [0.98799, 0.51667, 0.13883],
          [0.9859, 0.50479, 0.13367],
          [0.9836, 0.49291, 0.12849],
          [0.98108, 0.48104, 0.12332],
          [0.97837, 0.4692, 0.11817],
          [0.97545, 0.4574, 0.11305],
          [0.97234, 0.44565, 0.10797],
          [0.96904, 0.43399, 0.10294],
          [0.96555, 0.42241, 0.09798],
          [0.96187, 0.41093, 0.0931],
          [0.95801, 0.39958, 0.08831],
          [0.95398, 0.38836, 0.08362],
          [0.94977, 0.37729, 0.07905],
          [0.94538, 0.36638, 0.07461],
          [0.94084, 0.35566, 0.07031],
          [0.93612, 0.34513, 0.06616],
          [0.93125, 0.33482, 0.06218],
          [0.92623, 0.32473, 0.05837],
          [0.92105, 0.31489, 0.05475],
          [0.91572, 0.3053, 0.05134],
          [0.91024, 0.29599, 0.04814],
          [0.90463, 0.28696, 0.04516],
          [0.89888, 0.27824, 0.04243],
          [0.89298, 0.26981, 0.03993],
          [0.88691, 0.26152, 0.03753],
          [0.88066, 0.25334, 0.03521],
          [0.87422, 0.24526, 0.03297],
          [0.8676, 0.2373, 0.03082],
          [0.86079, 0.22945, 0.02875],
          [0.8538, 0.2217, 0.02677],
          [0.84662, 0.21407, 0.02487],
          [0.83926, 0.20654, 0.02305],
          [0.83172, 0.19912, 0.02131],
          [0.82399, 0.19182, 0.01966],
          [0.81608, 0.18462, 0.01809],
          [0.80799, 0.17753, 0.0166],
          [0.79971, 0.17055, 0.0152],
          [0.79125, 0.16368, 0.01387],
          [0.7826, 0.15693, 0.01264],
          [0.77377, 0.15028, 0.01148],
          [0.76476, 0.14374, 0.01041],
          [0.75556, 0.13731, 0.00942],
          [0.74617, 0.13098, 0.00851],
          [0.73661, 0.12477, 0.00769],
          [0.72686, 0.11867, 0.00695],
          [0.71692, 0.11268, 0.00629],
          [0.7068, 0.1068, 0.00571],
          [0.6965, 0.10102, 0.00522],
          [0.68602, 0.09536, 0.00481],
          [0.67535, 0.0898, 0.00449],
          [0.66449, 0.08436, 0.00424],
          [0.65345, 0.07902, 0.00408],
          [0.64223, 0.0738, 0.00401],
          [0.63082, 0.06868, 0.00401],
          [0.61923, 0.06367, 0.0041],
          [0.60746, 0.05878, 0.00427],
          [0.5955, 0.05399, 0.00453],
          [0.58336, 0.04931, 0.00486],
          [0.57103, 0.04474, 0.00529],
          [0.55852, 0.04028, 0.00579],
          [0.54583, 0.03593, 0.00638],
          [0.53295, 0.03169, 0.00705],
          [0.51989, 0.02756, 0.0078],
          [0.50664, 0.02354, 0.00863],
          [0.49321, 0.01963, 0.00955],
          [0.4796, 0.01583, 0.01055],
        ])
      ),
      a.checkNew(
        new a.Colormap("viridis", [
          [0.267004, 0.004874, 0.329415],
          [0.26851, 0.009605, 0.335427],
          [0.269944, 0.014625, 0.341379],
          [0.271305, 0.019942, 0.347269],
          [0.272594, 0.025563, 0.353093],
          [0.273809, 0.031497, 0.358853],
          [0.274952, 0.037752, 0.364543],
          [0.276022, 0.044167, 0.370164],
          [0.277018, 0.050344, 0.375715],
          [0.277941, 0.056324, 0.381191],
          [0.278791, 0.062145, 0.386592],
          [0.279566, 0.067836, 0.391917],
          [0.280267, 0.073417, 0.397163],
          [0.280894, 0.078907, 0.402329],
          [0.281446, 0.08432, 0.407414],
          [0.281924, 0.089666, 0.412415],
          [0.282327, 0.094955, 0.417331],
          [0.282656, 0.100196, 0.42216],
          [0.28291, 0.105393, 0.426902],
          [0.283091, 0.110553, 0.431554],
          [0.283197, 0.11568, 0.436115],
          [0.283229, 0.120777, 0.440584],
          [0.283187, 0.125848, 0.44496],
          [0.283072, 0.130895, 0.449241],
          [0.282884, 0.13592, 0.453427],
          [0.282623, 0.140926, 0.457517],
          [0.28229, 0.145912, 0.46151],
          [0.281887, 0.150881, 0.465405],
          [0.281412, 0.155834, 0.469201],
          [0.280868, 0.160771, 0.472899],
          [0.280255, 0.165693, 0.476498],
          [0.279574, 0.170599, 0.479997],
          [0.278826, 0.17549, 0.483397],
          [0.278012, 0.180367, 0.486697],
          [0.277134, 0.185228, 0.489898],
          [0.276194, 0.190074, 0.493001],
          [0.275191, 0.194905, 0.496005],
          [0.274128, 0.199721, 0.498911],
          [0.273006, 0.20452, 0.501721],
          [0.271828, 0.209303, 0.504434],
          [0.270595, 0.214069, 0.507052],
          [0.269308, 0.218818, 0.509577],
          [0.267968, 0.223549, 0.512008],
          [0.26658, 0.228262, 0.514349],
          [0.265145, 0.232956, 0.516599],
          [0.263663, 0.237631, 0.518762],
          [0.262138, 0.242286, 0.520837],
          [0.260571, 0.246922, 0.522828],
          [0.258965, 0.251537, 0.524736],
          [0.257322, 0.25613, 0.526563],
          [0.255645, 0.260703, 0.528312],
          [0.253935, 0.265254, 0.529983],
          [0.252194, 0.269783, 0.531579],
          [0.250425, 0.27429, 0.533103],
          [0.248629, 0.278775, 0.534556],
          [0.246811, 0.283237, 0.535941],
          [0.244972, 0.287675, 0.53726],
          [0.243113, 0.292092, 0.538516],
          [0.241237, 0.296485, 0.539709],
          [0.239346, 0.300855, 0.540844],
          [0.237441, 0.305202, 0.541921],
          [0.235526, 0.309527, 0.542944],
          [0.233603, 0.313828, 0.543914],
          [0.231674, 0.318106, 0.544834],
          [0.229739, 0.322361, 0.545706],
          [0.227802, 0.326594, 0.546532],
          [0.225863, 0.330805, 0.547314],
          [0.223925, 0.334994, 0.548053],
          [0.221989, 0.339161, 0.548752],
          [0.220057, 0.343307, 0.549413],
          [0.21813, 0.347432, 0.550038],
          [0.21621, 0.351535, 0.550627],
          [0.214298, 0.355619, 0.551184],
          [0.212395, 0.359683, 0.55171],
          [0.210503, 0.363727, 0.552206],
          [0.208623, 0.367752, 0.552675],
          [0.206756, 0.371758, 0.553117],
          [0.204903, 0.375746, 0.553533],
          [0.203063, 0.379716, 0.553925],
          [0.201239, 0.38367, 0.554294],
          [0.19943, 0.387607, 0.554642],
          [0.197636, 0.391528, 0.554969],
          [0.19586, 0.395433, 0.555276],
          [0.1941, 0.399323, 0.555565],
          [0.192357, 0.403199, 0.555836],
          [0.190631, 0.407061, 0.556089],
          [0.188923, 0.41091, 0.556326],
          [0.187231, 0.414746, 0.556547],
          [0.185556, 0.41857, 0.556753],
          [0.183898, 0.422383, 0.556944],
          [0.182256, 0.426184, 0.55712],
          [0.180629, 0.429975, 0.557282],
          [0.179019, 0.433756, 0.55743],
          [0.177423, 0.437527, 0.557565],
          [0.175841, 0.44129, 0.557685],
          [0.174274, 0.445044, 0.557792],
          [0.172719, 0.448791, 0.557885],
          [0.171176, 0.45253, 0.557965],
          [0.169646, 0.456262, 0.55803],
          [0.168126, 0.459988, 0.558082],
          [0.166617, 0.463708, 0.558119],
          [0.165117, 0.467423, 0.558141],
          [0.163625, 0.471133, 0.558148],
          [0.162142, 0.474838, 0.55814],
          [0.160665, 0.47854, 0.558115],
          [0.159194, 0.482237, 0.558073],
          [0.157729, 0.485932, 0.558013],
          [0.15627, 0.489624, 0.557936],
          [0.154815, 0.493313, 0.55784],
          [0.153364, 0.497, 0.557724],
          [0.151918, 0.500685, 0.557587],
          [0.150476, 0.504369, 0.55743],
          [0.149039, 0.508051, 0.55725],
          [0.147607, 0.511733, 0.557049],
          [0.14618, 0.515413, 0.556823],
          [0.144759, 0.519093, 0.556572],
          [0.143343, 0.522773, 0.556295],
          [0.141935, 0.526453, 0.555991],
          [0.140536, 0.530132, 0.555659],
          [0.139147, 0.533812, 0.555298],
          [0.13777, 0.537492, 0.554906],
          [0.136408, 0.541173, 0.554483],
          [0.135066, 0.544853, 0.554029],
          [0.133743, 0.548535, 0.553541],
          [0.132444, 0.552216, 0.553018],
          [0.131172, 0.555899, 0.552459],
          [0.129933, 0.559582, 0.551864],
          [0.128729, 0.563265, 0.551229],
          [0.127568, 0.566949, 0.550556],
          [0.126453, 0.570633, 0.549841],
          [0.125394, 0.574318, 0.549086],
          [0.124395, 0.578002, 0.548287],
          [0.123463, 0.581687, 0.547445],
          [0.122606, 0.585371, 0.546557],
          [0.121831, 0.589055, 0.545623],
          [0.121148, 0.592739, 0.544641],
          [0.120565, 0.596422, 0.543611],
          [0.120092, 0.600104, 0.54253],
          [0.119738, 0.603785, 0.5414],
          [0.119512, 0.607464, 0.540218],
          [0.119423, 0.611141, 0.538982],
          [0.119483, 0.614817, 0.537692],
          [0.119699, 0.61849, 0.536347],
          [0.120081, 0.622161, 0.534946],
          [0.120638, 0.625828, 0.533488],
          [0.12138, 0.629492, 0.531973],
          [0.122312, 0.633153, 0.530398],
          [0.123444, 0.636809, 0.528763],
          [0.12478, 0.640461, 0.527068],
          [0.126326, 0.644107, 0.525311],
          [0.128087, 0.647749, 0.523491],
          [0.130067, 0.651384, 0.521608],
          [0.132268, 0.655014, 0.519661],
          [0.134692, 0.658636, 0.517649],
          [0.137339, 0.662252, 0.515571],
          [0.14021, 0.665859, 0.513427],
          [0.143303, 0.669459, 0.511215],
          [0.146616, 0.67305, 0.508936],
          [0.150148, 0.676631, 0.506589],
          [0.153894, 0.680203, 0.504172],
          [0.157851, 0.683765, 0.501686],
          [0.162016, 0.687316, 0.499129],
          [0.166383, 0.690856, 0.496502],
          [0.170948, 0.694384, 0.493803],
          [0.175707, 0.6979, 0.491033],
          [0.180653, 0.701402, 0.488189],
          [0.185783, 0.704891, 0.485273],
          [0.19109, 0.708366, 0.482284],
          [0.196571, 0.711827, 0.479221],
          [0.202219, 0.715272, 0.476084],
          [0.20803, 0.718701, 0.472873],
          [0.214, 0.722114, 0.469588],
          [0.220124, 0.725509, 0.466226],
          [0.226397, 0.728888, 0.462789],
          [0.232815, 0.732247, 0.459277],
          [0.239374, 0.735588, 0.455688],
          [0.24607, 0.73891, 0.452024],
          [0.252899, 0.742211, 0.448284],
          [0.259857, 0.745492, 0.444467],
          [0.266941, 0.748751, 0.440573],
          [0.274149, 0.751988, 0.436601],
          [0.281477, 0.755203, 0.432552],
          [0.288921, 0.758394, 0.428426],
          [0.296479, 0.761561, 0.424223],
          [0.304148, 0.764704, 0.419943],
          [0.311925, 0.767822, 0.415586],
          [0.319809, 0.770914, 0.411152],
          [0.327796, 0.77398, 0.40664],
          [0.335885, 0.777018, 0.402049],
          [0.344074, 0.780029, 0.397381],
          [0.35236, 0.783011, 0.392636],
          [0.360741, 0.785964, 0.387814],
          [0.369214, 0.788888, 0.382914],
          [0.377779, 0.791781, 0.377939],
          [0.386433, 0.794644, 0.372886],
          [0.395174, 0.797475, 0.367757],
          [0.404001, 0.800275, 0.362552],
          [0.412913, 0.803041, 0.357269],
          [0.421908, 0.805774, 0.35191],
          [0.430983, 0.808473, 0.346476],
          [0.440137, 0.811138, 0.340967],
          [0.449368, 0.813768, 0.335384],
          [0.458674, 0.816363, 0.329727],
          [0.468053, 0.818921, 0.323998],
          [0.477504, 0.821444, 0.318195],
          [0.487026, 0.823929, 0.312321],
          [0.496615, 0.826376, 0.306377],
          [0.506271, 0.828786, 0.300362],
          [0.515992, 0.831158, 0.294279],
          [0.525776, 0.833491, 0.288127],
          [0.535621, 0.835785, 0.281908],
          [0.545524, 0.838039, 0.275626],
          [0.555484, 0.840254, 0.269281],
          [0.565498, 0.84243, 0.262877],
          [0.575563, 0.844566, 0.256415],
          [0.585678, 0.846661, 0.249897],
          [0.595839, 0.848717, 0.243329],
          [0.606045, 0.850733, 0.236712],
          [0.616293, 0.852709, 0.230052],
          [0.626579, 0.854645, 0.223353],
          [0.636902, 0.856542, 0.21662],
          [0.647257, 0.8584, 0.209861],
          [0.657642, 0.860219, 0.203082],
          [0.668054, 0.861999, 0.196293],
          [0.678489, 0.863742, 0.189503],
          [0.688944, 0.865448, 0.182725],
          [0.699415, 0.867117, 0.175971],
          [0.709898, 0.868751, 0.169257],
          [0.720391, 0.87035, 0.162603],
          [0.730889, 0.871916, 0.156029],
          [0.741388, 0.873449, 0.149561],
          [0.751884, 0.874951, 0.143228],
          [0.762373, 0.876424, 0.137064],
          [0.772852, 0.877868, 0.131109],
          [0.783315, 0.879285, 0.125405],
          [0.79376, 0.880678, 0.120005],
          [0.804182, 0.882046, 0.114965],
          [0.814576, 0.883393, 0.110347],
          [0.82494, 0.88472, 0.106217],
          [0.83527, 0.886029, 0.102646],
          [0.845561, 0.887322, 0.099702],
          [0.85581, 0.888601, 0.097452],
          [0.866013, 0.889868, 0.095953],
          [0.876168, 0.891125, 0.09525],
          [0.886271, 0.892374, 0.095374],
          [0.89632, 0.893616, 0.096335],
          [0.906311, 0.894855, 0.098125],
          [0.916242, 0.896091, 0.100717],
          [0.926106, 0.89733, 0.104071],
          [0.935904, 0.89857, 0.108131],
          [0.945636, 0.899815, 0.112838],
          [0.9553, 0.901065, 0.118128],
          [0.964894, 0.902323, 0.123941],
          [0.974417, 0.90359, 0.130215],
          [0.983868, 0.904867, 0.136897],
          [0.993248, 0.906157, 0.143936],
        ])
      ),
      a.checkNew(
        new a.Colormap("magma", [
          [0.001462, 4.66e-4, 0.013866],
          [0.002258, 0.001295, 0.018331],
          [0.003279, 0.002305, 0.023708],
          [0.004512, 0.00349, 0.029965],
          [0.00595, 0.004843, 0.03713],
          [0.007588, 0.006356, 0.044973],
          [0.009426, 0.008022, 0.052844],
          [0.011465, 0.009828, 0.06075],
          [0.013708, 0.011771, 0.068667],
          [0.016156, 0.01384, 0.076603],
          [0.018815, 0.016026, 0.084584],
          [0.021692, 0.01832, 0.09261],
          [0.024792, 0.020715, 0.100676],
          [0.028123, 0.023201, 0.108787],
          [0.031696, 0.025765, 0.116965],
          [0.03552, 0.028397, 0.125209],
          [0.039608, 0.03109, 0.133515],
          [0.04383, 0.03383, 0.141886],
          [0.048062, 0.036607, 0.150327],
          [0.05232, 0.039407, 0.158841],
          [0.056615, 0.04216, 0.167446],
          [0.060949, 0.044794, 0.176129],
          [0.06533, 0.047318, 0.184892],
          [0.069764, 0.049726, 0.193735],
          [0.074257, 0.052017, 0.20266],
          [0.078815, 0.054184, 0.211667],
          [0.083446, 0.056225, 0.220755],
          [0.088155, 0.058133, 0.229922],
          [0.092949, 0.059904, 0.239164],
          [0.097833, 0.061531, 0.248477],
          [0.102815, 0.06301, 0.257854],
          [0.107899, 0.064335, 0.267289],
          [0.113094, 0.065492, 0.276784],
          [0.118405, 0.066479, 0.286321],
          [0.123833, 0.067295, 0.295879],
          [0.12938, 0.067935, 0.305443],
          [0.135053, 0.068391, 0.315],
          [0.140858, 0.068654, 0.324538],
          [0.146785, 0.068738, 0.334011],
          [0.152839, 0.068637, 0.343404],
          [0.159018, 0.068354, 0.352688],
          [0.165308, 0.067911, 0.361816],
          [0.171713, 0.067305, 0.370771],
          [0.178212, 0.066576, 0.379497],
          [0.184801, 0.065732, 0.387973],
          [0.19146, 0.064818, 0.396152],
          [0.198177, 0.063862, 0.404009],
          [0.204935, 0.062907, 0.411514],
          [0.211718, 0.061992, 0.418647],
          [0.218512, 0.061158, 0.425392],
          [0.225302, 0.060445, 0.431742],
          [0.232077, 0.059889, 0.437695],
          [0.238826, 0.059517, 0.443256],
          [0.245543, 0.059352, 0.448436],
          [0.25222, 0.059415, 0.453248],
          [0.258857, 0.059706, 0.45771],
          [0.265447, 0.060237, 0.46184],
          [0.271994, 0.060994, 0.46566],
          [0.278493, 0.061978, 0.46919],
          [0.284951, 0.063168, 0.472451],
          [0.291366, 0.064553, 0.475462],
          [0.29774, 0.066117, 0.478243],
          [0.304081, 0.067835, 0.480812],
          [0.310382, 0.069702, 0.483186],
          [0.316654, 0.07169, 0.48538],
          [0.322899, 0.073782, 0.487408],
          [0.329114, 0.075972, 0.489287],
          [0.335308, 0.078236, 0.491024],
          [0.341482, 0.080564, 0.492631],
          [0.347636, 0.082946, 0.494121],
          [0.353773, 0.085373, 0.495501],
          [0.359898, 0.087831, 0.496778],
          [0.366012, 0.090314, 0.49796],
          [0.372116, 0.092816, 0.499053],
          [0.378211, 0.095332, 0.500067],
          [0.384299, 0.097855, 0.501002],
          [0.390384, 0.100379, 0.501864],
          [0.396467, 0.102902, 0.502658],
          [0.402548, 0.10542, 0.503386],
          [0.408629, 0.10793, 0.504052],
          [0.414709, 0.110431, 0.504662],
          [0.420791, 0.11292, 0.505215],
          [0.426877, 0.115395, 0.505714],
          [0.432967, 0.117855, 0.50616],
          [0.439062, 0.120298, 0.506555],
          [0.445163, 0.122724, 0.506901],
          [0.451271, 0.125132, 0.507198],
          [0.457386, 0.127522, 0.507448],
          [0.463508, 0.129893, 0.507652],
          [0.46964, 0.132245, 0.507809],
          [0.47578, 0.134577, 0.507921],
          [0.481929, 0.136891, 0.507989],
          [0.488088, 0.139186, 0.508011],
          [0.494258, 0.141462, 0.507988],
          [0.500438, 0.143719, 0.50792],
          [0.506629, 0.145958, 0.507806],
          [0.512831, 0.148179, 0.507648],
          [0.519045, 0.150383, 0.507443],
          [0.52527, 0.152569, 0.507192],
          [0.531507, 0.154739, 0.506895],
          [0.537755, 0.156894, 0.506551],
          [0.544015, 0.159033, 0.506159],
          [0.550287, 0.161158, 0.505719],
          [0.556571, 0.163269, 0.50523],
          [0.562866, 0.165368, 0.504692],
          [0.569172, 0.167454, 0.504105],
          [0.57549, 0.16953, 0.503466],
          [0.581819, 0.171596, 0.502777],
          [0.588158, 0.173652, 0.502035],
          [0.594508, 0.175701, 0.501241],
          [0.600868, 0.177743, 0.500394],
          [0.607238, 0.179779, 0.499492],
          [0.613617, 0.181811, 0.498536],
          [0.620005, 0.18384, 0.497524],
          [0.626401, 0.185867, 0.496456],
          [0.632805, 0.187893, 0.495332],
          [0.639216, 0.189921, 0.49415],
          [0.645633, 0.191952, 0.49291],
          [0.652056, 0.193986, 0.491611],
          [0.658483, 0.196027, 0.490253],
          [0.664915, 0.198075, 0.488836],
          [0.671349, 0.200133, 0.487358],
          [0.677786, 0.202203, 0.485819],
          [0.684224, 0.204286, 0.484219],
          [0.690661, 0.206384, 0.482558],
          [0.697098, 0.208501, 0.480835],
          [0.703532, 0.210638, 0.479049],
          [0.709962, 0.212797, 0.477201],
          [0.716387, 0.214982, 0.47529],
          [0.722805, 0.217194, 0.473316],
          [0.729216, 0.219437, 0.471279],
          [0.735616, 0.221713, 0.46918],
          [0.742004, 0.224025, 0.467018],
          [0.748378, 0.226377, 0.464794],
          [0.754737, 0.228772, 0.462509],
          [0.761077, 0.231214, 0.460162],
          [0.767398, 0.233705, 0.457755],
          [0.773695, 0.236249, 0.455289],
          [0.779968, 0.238851, 0.452765],
          [0.786212, 0.241514, 0.450184],
          [0.792427, 0.244242, 0.447543],
          [0.798608, 0.24704, 0.444848],
          [0.804752, 0.249911, 0.442102],
          [0.810855, 0.252861, 0.439305],
          [0.816914, 0.255895, 0.436461],
          [0.822926, 0.259016, 0.433573],
          [0.828886, 0.262229, 0.430644],
          [0.834791, 0.26554, 0.427671],
          [0.840636, 0.268953, 0.424666],
          [0.846416, 0.272473, 0.421631],
          [0.852126, 0.276106, 0.418573],
          [0.857763, 0.279857, 0.415496],
          [0.86332, 0.283729, 0.412403],
          [0.868793, 0.287728, 0.409303],
          [0.874176, 0.291859, 0.406205],
          [0.879464, 0.296125, 0.403118],
          [0.884651, 0.30053, 0.400047],
          [0.889731, 0.305079, 0.397002],
          [0.8947, 0.309773, 0.393995],
          [0.899552, 0.314616, 0.391037],
          [0.904281, 0.31961, 0.388137],
          [0.908884, 0.324755, 0.385308],
          [0.913354, 0.330052, 0.382563],
          [0.917689, 0.3355, 0.379915],
          [0.921884, 0.341098, 0.377376],
          [0.925937, 0.346844, 0.374959],
          [0.929845, 0.352734, 0.372677],
          [0.933606, 0.358764, 0.370541],
          [0.937221, 0.364929, 0.368567],
          [0.940687, 0.371224, 0.366762],
          [0.944006, 0.377643, 0.365136],
          [0.94718, 0.384178, 0.363701],
          [0.95021, 0.39082, 0.362468],
          [0.953099, 0.397563, 0.361438],
          [0.955849, 0.4044, 0.360619],
          [0.958464, 0.411324, 0.360014],
          [0.960949, 0.418323, 0.35963],
          [0.96331, 0.42539, 0.359469],
          [0.965549, 0.432519, 0.359529],
          [0.967671, 0.439703, 0.35981],
          [0.96968, 0.446936, 0.360311],
          [0.971582, 0.45421, 0.36103],
          [0.973381, 0.46152, 0.361965],
          [0.975082, 0.468861, 0.363111],
          [0.97669, 0.476226, 0.364466],
          [0.97821, 0.483612, 0.366025],
          [0.979645, 0.491014, 0.367783],
          [0.981, 0.498428, 0.369734],
          [0.982279, 0.505851, 0.371874],
          [0.983485, 0.51328, 0.374198],
          [0.984622, 0.520713, 0.376698],
          [0.985693, 0.528148, 0.379371],
          [0.9867, 0.535582, 0.38221],
          [0.987646, 0.543015, 0.38521],
          [0.988533, 0.550446, 0.388365],
          [0.989363, 0.557873, 0.391671],
          [0.990138, 0.565296, 0.395122],
          [0.990871, 0.572706, 0.398714],
          [0.991558, 0.580107, 0.402441],
          [0.992196, 0.587502, 0.406299],
          [0.992785, 0.594891, 0.410283],
          [0.993326, 0.602275, 0.41439],
          [0.993834, 0.609644, 0.418613],
          [0.994309, 0.616999, 0.42295],
          [0.994738, 0.62435, 0.427397],
          [0.995122, 0.631696, 0.431951],
          [0.99548, 0.639027, 0.436607],
          [0.99581, 0.646344, 0.441361],
          [0.996096, 0.653659, 0.446213],
          [0.996341, 0.660969, 0.45116],
          [0.99658, 0.668256, 0.456192],
          [0.996775, 0.675541, 0.461314],
          [0.996925, 0.682828, 0.466526],
          [0.997077, 0.690088, 0.471811],
          [0.997186, 0.697349, 0.477182],
          [0.997254, 0.704611, 0.482635],
          [0.997325, 0.711848, 0.488154],
          [0.997351, 0.719089, 0.493755],
          [0.997351, 0.726324, 0.499428],
          [0.997341, 0.733545, 0.505167],
          [0.997285, 0.740772, 0.510983],
          [0.997228, 0.747981, 0.516859],
          [0.997138, 0.75519, 0.522806],
          [0.997019, 0.762398, 0.528821],
          [0.996898, 0.769591, 0.534892],
          [0.996727, 0.776795, 0.541039],
          [0.996571, 0.783977, 0.547233],
          [0.996369, 0.791167, 0.553499],
          [0.996162, 0.798348, 0.55982],
          [0.995932, 0.805527, 0.566202],
          [0.99568, 0.812706, 0.572645],
          [0.995424, 0.819875, 0.57914],
          [0.995131, 0.827052, 0.585701],
          [0.994851, 0.834213, 0.592307],
          [0.994524, 0.841387, 0.598983],
          [0.994222, 0.84854, 0.605696],
          [0.993866, 0.855711, 0.612482],
          [0.993545, 0.862859, 0.619299],
          [0.99317, 0.870024, 0.626189],
          [0.992831, 0.877168, 0.633109],
          [0.99244, 0.88433, 0.640099],
          [0.992089, 0.89147, 0.647116],
          [0.991688, 0.898627, 0.654202],
          [0.991332, 0.905763, 0.661309],
          [0.99093, 0.912915, 0.668481],
          [0.99057, 0.920049, 0.675675],
          [0.990175, 0.927196, 0.682926],
          [0.989815, 0.934329, 0.690198],
          [0.989434, 0.94147, 0.697519],
          [0.989077, 0.948604, 0.704863],
          [0.988717, 0.955742, 0.712242],
          [0.988367, 0.962878, 0.719649],
          [0.988033, 0.970012, 0.727077],
          [0.987691, 0.977154, 0.734536],
          [0.987387, 0.984288, 0.742002],
          [0.987053, 0.991438, 0.749504],
        ])
      ),
      a.checkNew(
        new a.Colormap("inferno", [
          [0.001462, 4.66e-4, 0.013866],
          [0.002267, 0.00127, 0.01857],
          [0.003299, 0.002249, 0.024239],
          [0.004547, 0.003392, 0.030909],
          [0.006006, 0.004692, 0.038558],
          [0.007676, 0.006136, 0.046836],
          [0.009561, 0.007713, 0.055143],
          [0.011663, 0.009417, 0.06346],
          [0.013995, 0.011225, 0.071862],
          [0.016561, 0.013136, 0.080282],
          [0.019373, 0.015133, 0.088767],
          [0.022447, 0.017199, 0.097327],
          [0.025793, 0.019331, 0.10593],
          [0.029432, 0.021503, 0.114621],
          [0.033385, 0.023702, 0.123397],
          [0.037668, 0.025921, 0.132232],
          [0.042253, 0.028139, 0.141141],
          [0.046915, 0.030324, 0.150164],
          [0.051644, 0.032474, 0.159254],
          [0.056449, 0.034569, 0.168414],
          [0.06134, 0.03659, 0.177642],
          [0.066331, 0.038504, 0.186962],
          [0.071429, 0.040294, 0.196354],
          [0.076637, 0.041905, 0.205799],
          [0.081962, 0.043328, 0.215289],
          [0.087411, 0.044556, 0.224813],
          [0.09299, 0.045583, 0.234358],
          [0.098702, 0.046402, 0.243904],
          [0.104551, 0.047008, 0.25343],
          [0.110536, 0.047399, 0.262912],
          [0.116656, 0.047574, 0.272321],
          [0.122908, 0.047536, 0.281624],
          [0.129285, 0.047293, 0.290788],
          [0.135778, 0.046856, 0.299776],
          [0.142378, 0.046242, 0.308553],
          [0.149073, 0.045468, 0.317085],
          [0.15585, 0.044559, 0.325338],
          [0.162689, 0.043554, 0.333277],
          [0.169575, 0.042489, 0.340874],
          [0.176493, 0.041402, 0.348111],
          [0.183429, 0.040329, 0.354971],
          [0.190367, 0.039309, 0.361447],
          [0.197297, 0.0384, 0.367535],
          [0.204209, 0.037632, 0.373238],
          [0.211095, 0.03703, 0.378563],
          [0.217949, 0.036615, 0.383522],
          [0.224763, 0.036405, 0.388129],
          [0.231538, 0.036405, 0.3924],
          [0.238273, 0.036621, 0.396353],
          [0.244967, 0.037055, 0.400007],
          [0.25162, 0.037705, 0.403378],
          [0.258234, 0.038571, 0.406485],
          [0.26481, 0.039647, 0.409345],
          [0.271347, 0.040922, 0.411976],
          [0.27785, 0.042353, 0.414392],
          [0.284321, 0.043933, 0.416608],
          [0.290763, 0.045644, 0.418637],
          [0.297178, 0.04747, 0.420491],
          [0.303568, 0.049396, 0.422182],
          [0.309935, 0.051407, 0.423721],
          [0.316282, 0.05349, 0.425116],
          [0.32261, 0.055634, 0.426377],
          [0.328921, 0.057827, 0.427511],
          [0.335217, 0.06006, 0.428524],
          [0.3415, 0.062325, 0.429425],
          [0.347771, 0.064616, 0.430217],
          [0.354032, 0.066925, 0.430906],
          [0.360284, 0.069247, 0.431497],
          [0.366529, 0.071579, 0.431994],
          [0.372768, 0.073915, 0.4324],
          [0.379001, 0.076253, 0.432719],
          [0.385228, 0.078591, 0.432955],
          [0.391453, 0.080927, 0.433109],
          [0.397674, 0.083257, 0.433183],
          [0.403894, 0.08558, 0.433179],
          [0.410113, 0.087896, 0.433098],
          [0.416331, 0.090203, 0.432943],
          [0.422549, 0.092501, 0.432714],
          [0.428768, 0.09479, 0.432412],
          [0.434987, 0.097069, 0.432039],
          [0.441207, 0.099338, 0.431594],
          [0.447428, 0.101597, 0.43108],
          [0.453651, 0.103848, 0.430498],
          [0.459875, 0.106089, 0.429846],
          [0.4661, 0.108322, 0.429125],
          [0.472328, 0.110547, 0.428334],
          [0.478558, 0.112764, 0.427475],
          [0.484789, 0.114974, 0.426548],
          [0.491022, 0.117179, 0.425552],
          [0.497257, 0.119379, 0.424488],
          [0.503493, 0.121575, 0.423356],
          [0.50973, 0.123769, 0.422156],
          [0.515967, 0.12596, 0.420887],
          [0.522206, 0.12815, 0.419549],
          [0.528444, 0.130341, 0.418142],
          [0.534683, 0.132534, 0.416667],
          [0.54092, 0.134729, 0.415123],
          [0.547157, 0.136929, 0.413511],
          [0.553392, 0.139134, 0.411829],
          [0.559624, 0.141346, 0.410078],
          [0.565854, 0.143567, 0.408258],
          [0.572081, 0.145797, 0.406369],
          [0.578304, 0.148039, 0.404411],
          [0.584521, 0.150294, 0.402385],
          [0.590734, 0.152563, 0.40029],
          [0.59694, 0.154848, 0.398125],
          [0.603139, 0.157151, 0.395891],
          [0.60933, 0.159474, 0.393589],
          [0.615513, 0.161817, 0.391219],
          [0.621685, 0.164184, 0.388781],
          [0.627847, 0.166575, 0.386276],
          [0.633998, 0.168992, 0.383704],
          [0.640135, 0.171438, 0.381065],
          [0.64626, 0.173914, 0.378359],
          [0.652369, 0.176421, 0.375586],
          [0.658463, 0.178962, 0.372748],
          [0.66454, 0.181539, 0.369846],
          [0.670599, 0.184153, 0.366879],
          [0.676638, 0.186807, 0.363849],
          [0.682656, 0.189501, 0.360757],
          [0.688653, 0.192239, 0.357603],
          [0.694627, 0.195021, 0.354388],
          [0.700576, 0.197851, 0.351113],
          [0.7065, 0.200728, 0.347777],
          [0.712396, 0.203656, 0.344383],
          [0.718264, 0.206636, 0.340931],
          [0.724103, 0.20967, 0.337424],
          [0.729909, 0.212759, 0.333861],
          [0.735683, 0.215906, 0.330245],
          [0.741423, 0.219112, 0.326576],
          [0.747127, 0.222378, 0.322856],
          [0.752794, 0.225706, 0.319085],
          [0.758422, 0.229097, 0.315266],
          [0.76401, 0.232554, 0.311399],
          [0.769556, 0.236077, 0.307485],
          [0.775059, 0.239667, 0.303526],
          [0.780517, 0.243327, 0.299523],
          [0.785929, 0.247056, 0.295477],
          [0.791293, 0.250856, 0.29139],
          [0.796607, 0.254728, 0.287264],
          [0.801871, 0.258674, 0.283099],
          [0.807082, 0.262692, 0.278898],
          [0.812239, 0.266786, 0.274661],
          [0.817341, 0.270954, 0.27039],
          [0.822386, 0.275197, 0.266085],
          [0.827372, 0.279517, 0.26175],
          [0.832299, 0.283913, 0.257383],
          [0.837165, 0.288385, 0.252988],
          [0.841969, 0.292933, 0.248564],
          [0.846709, 0.297559, 0.244113],
          [0.851384, 0.30226, 0.239636],
          [0.855992, 0.307038, 0.235133],
          [0.860533, 0.311892, 0.230606],
          [0.865006, 0.316822, 0.226055],
          [0.869409, 0.321827, 0.221482],
          [0.873741, 0.326906, 0.216886],
          [0.878001, 0.33206, 0.212268],
          [0.882188, 0.337287, 0.207628],
          [0.886302, 0.342586, 0.202968],
          [0.890341, 0.347957, 0.198286],
          [0.894305, 0.353399, 0.193584],
          [0.898192, 0.358911, 0.18886],
          [0.902003, 0.364492, 0.184116],
          [0.905735, 0.37014, 0.17935],
          [0.90939, 0.375856, 0.174563],
          [0.912966, 0.381636, 0.169755],
          [0.916462, 0.387481, 0.164924],
          [0.919879, 0.393389, 0.16007],
          [0.923215, 0.399359, 0.155193],
          [0.92647, 0.405389, 0.150292],
          [0.929644, 0.411479, 0.145367],
          [0.932737, 0.417627, 0.140417],
          [0.935747, 0.423831, 0.13544],
          [0.938675, 0.430091, 0.130438],
          [0.941521, 0.436405, 0.125409],
          [0.944285, 0.442772, 0.120354],
          [0.946965, 0.449191, 0.115272],
          [0.949562, 0.45566, 0.110164],
          [0.952075, 0.462178, 0.105031],
          [0.954506, 0.468744, 0.099874],
          [0.956852, 0.475356, 0.094695],
          [0.959114, 0.482014, 0.089499],
          [0.961293, 0.488716, 0.084289],
          [0.963387, 0.495462, 0.079073],
          [0.965397, 0.502249, 0.073859],
          [0.967322, 0.509078, 0.068659],
          [0.969163, 0.515946, 0.063488],
          [0.970919, 0.522853, 0.058367],
          [0.97259, 0.529798, 0.053324],
          [0.974176, 0.53678, 0.048392],
          [0.975677, 0.543798, 0.043618],
          [0.977092, 0.55085, 0.03905],
          [0.978422, 0.557937, 0.034931],
          [0.979666, 0.565057, 0.031409],
          [0.980824, 0.572209, 0.028508],
          [0.981895, 0.579392, 0.02625],
          [0.982881, 0.586606, 0.024661],
          [0.983779, 0.593849, 0.02377],
          [0.984591, 0.601122, 0.023606],
          [0.985315, 0.608422, 0.024202],
          [0.985952, 0.61575, 0.025592],
          [0.986502, 0.623105, 0.027814],
          [0.986964, 0.630485, 0.030908],
          [0.987337, 0.63789, 0.034916],
          [0.987622, 0.64532, 0.039886],
          [0.987819, 0.652773, 0.045581],
          [0.987926, 0.66025, 0.05175],
          [0.987945, 0.667748, 0.058329],
          [0.987874, 0.675267, 0.065257],
          [0.987714, 0.682807, 0.072489],
          [0.987464, 0.690366, 0.07999],
          [0.987124, 0.697944, 0.087731],
          [0.986694, 0.70554, 0.095694],
          [0.986175, 0.713153, 0.103863],
          [0.985566, 0.720782, 0.112229],
          [0.984865, 0.728427, 0.120785],
          [0.984075, 0.736087, 0.129527],
          [0.983196, 0.743758, 0.138453],
          [0.982228, 0.751442, 0.147565],
          [0.981173, 0.759135, 0.156863],
          [0.980032, 0.766837, 0.166353],
          [0.978806, 0.774545, 0.176037],
          [0.977497, 0.782258, 0.185923],
          [0.976108, 0.789974, 0.196018],
          [0.974638, 0.797692, 0.206332],
          [0.973088, 0.805409, 0.216877],
          [0.971468, 0.813122, 0.227658],
          [0.969783, 0.820825, 0.238686],
          [0.968041, 0.828515, 0.249972],
          [0.966243, 0.836191, 0.261534],
          [0.964394, 0.843848, 0.273391],
          [0.962517, 0.851476, 0.285546],
          [0.960626, 0.859069, 0.29801],
          [0.95872, 0.866624, 0.31082],
          [0.956834, 0.874129, 0.323974],
          [0.954997, 0.881569, 0.337475],
          [0.953215, 0.888942, 0.351369],
          [0.951546, 0.896226, 0.365627],
          [0.950018, 0.903409, 0.380271],
          [0.948683, 0.910473, 0.395289],
          [0.947594, 0.917399, 0.410665],
          [0.946809, 0.924168, 0.426373],
          [0.946392, 0.930761, 0.442367],
          [0.946403, 0.937159, 0.458592],
          [0.946903, 0.943348, 0.47497],
          [0.947937, 0.949318, 0.491426],
          [0.949545, 0.955063, 0.50786],
          [0.95174, 0.960587, 0.524203],
          [0.954529, 0.965896, 0.540361],
          [0.957896, 0.971003, 0.556275],
          [0.961812, 0.975924, 0.571925],
          [0.966249, 0.980678, 0.587206],
          [0.971162, 0.985282, 0.602154],
          [0.976511, 0.989753, 0.61676],
          [0.982257, 0.994109, 0.631017],
          [0.988362, 0.998364, 0.644924],
        ])
      ),
      a.checkNew(
        new a.Colormap("plasma", [
          [0.050383, 0.029803, 0.527975],
          [0.063536, 0.028426, 0.533124],
          [0.075353, 0.027206, 0.538007],
          [0.086222, 0.026125, 0.542658],
          [0.096379, 0.025165, 0.547103],
          [0.10598, 0.024309, 0.551368],
          [0.115124, 0.023556, 0.555468],
          [0.123903, 0.022878, 0.559423],
          [0.132381, 0.022258, 0.56325],
          [0.140603, 0.021687, 0.566959],
          [0.148607, 0.021154, 0.570562],
          [0.156421, 0.020651, 0.574065],
          [0.16407, 0.020171, 0.577478],
          [0.171574, 0.019706, 0.580806],
          [0.17895, 0.019252, 0.584054],
          [0.186213, 0.018803, 0.587228],
          [0.193374, 0.018354, 0.59033],
          [0.200445, 0.017902, 0.593364],
          [0.207435, 0.017442, 0.596333],
          [0.21435, 0.016973, 0.599239],
          [0.221197, 0.016497, 0.602083],
          [0.227983, 0.016007, 0.604867],
          [0.234715, 0.015502, 0.607592],
          [0.241396, 0.014979, 0.610259],
          [0.248032, 0.014439, 0.612868],
          [0.254627, 0.013882, 0.615419],
          [0.261183, 0.013308, 0.617911],
          [0.267703, 0.012716, 0.620346],
          [0.274191, 0.012109, 0.622722],
          [0.280648, 0.011488, 0.625038],
          [0.287076, 0.010855, 0.627295],
          [0.293478, 0.010213, 0.62949],
          [0.299855, 0.009561, 0.631624],
          [0.30621, 0.008902, 0.633694],
          [0.312543, 0.008239, 0.6357],
          [0.318856, 0.007576, 0.63764],
          [0.32515, 0.006915, 0.639512],
          [0.331426, 0.006261, 0.641316],
          [0.337683, 0.005618, 0.643049],
          [0.343925, 0.004991, 0.64471],
          [0.35015, 0.004382, 0.646298],
          [0.356359, 0.003798, 0.64781],
          [0.362553, 0.003243, 0.649245],
          [0.368733, 0.002724, 0.650601],
          [0.374897, 0.002245, 0.651876],
          [0.381047, 0.001814, 0.653068],
          [0.387183, 0.001434, 0.654177],
          [0.393304, 0.001114, 0.655199],
          [0.399411, 8.59e-4, 0.656133],
          [0.405503, 6.78e-4, 0.656977],
          [0.41158, 5.77e-4, 0.65773],
          [0.417642, 5.64e-4, 0.65839],
          [0.423689, 6.46e-4, 0.658956],
          [0.429719, 8.31e-4, 0.659425],
          [0.435734, 0.001127, 0.659797],
          [0.441732, 0.00154, 0.660069],
          [0.447714, 0.00208, 0.66024],
          [0.453677, 0.002755, 0.66031],
          [0.459623, 0.003574, 0.660277],
          [0.46555, 0.004545, 0.660139],
          [0.471457, 0.005678, 0.659897],
          [0.477344, 0.00698, 0.659549],
          [0.48321, 0.00846, 0.659095],
          [0.489055, 0.010127, 0.658534],
          [0.494877, 0.01199, 0.657865],
          [0.500678, 0.014055, 0.657088],
          [0.506454, 0.016333, 0.656202],
          [0.512206, 0.018833, 0.655209],
          [0.517933, 0.021563, 0.654109],
          [0.523633, 0.024532, 0.652901],
          [0.529306, 0.027747, 0.651586],
          [0.534952, 0.031217, 0.650165],
          [0.54057, 0.03495, 0.64864],
          [0.546157, 0.038954, 0.64701],
          [0.551715, 0.043136, 0.645277],
          [0.557243, 0.047331, 0.643443],
          [0.562738, 0.051545, 0.641509],
          [0.568201, 0.055778, 0.639477],
          [0.573632, 0.060028, 0.637349],
          [0.579029, 0.064296, 0.635126],
          [0.584391, 0.068579, 0.632812],
          [0.589719, 0.072878, 0.630408],
          [0.595011, 0.07719, 0.627917],
          [0.600266, 0.081516, 0.625342],
          [0.605485, 0.085854, 0.622686],
          [0.610667, 0.090204, 0.619951],
          [0.615812, 0.094564, 0.61714],
          [0.620919, 0.098934, 0.614257],
          [0.625987, 0.103312, 0.611305],
          [0.631017, 0.107699, 0.608287],
          [0.636008, 0.112092, 0.605205],
          [0.640959, 0.116492, 0.602065],
          [0.645872, 0.120898, 0.598867],
          [0.650746, 0.125309, 0.595617],
          [0.65558, 0.129725, 0.592317],
          [0.660374, 0.134144, 0.588971],
          [0.665129, 0.138566, 0.585582],
          [0.669845, 0.142992, 0.582154],
          [0.674522, 0.147419, 0.578688],
          [0.67916, 0.151848, 0.575189],
          [0.683758, 0.156278, 0.57166],
          [0.688318, 0.160709, 0.568103],
          [0.69284, 0.165141, 0.564522],
          [0.697324, 0.169573, 0.560919],
          [0.701769, 0.174005, 0.557296],
          [0.706178, 0.178437, 0.553657],
          [0.710549, 0.182868, 0.550004],
          [0.714883, 0.187299, 0.546338],
          [0.719181, 0.191729, 0.542663],
          [0.723444, 0.196158, 0.538981],
          [0.72767, 0.200586, 0.535293],
          [0.731862, 0.205013, 0.531601],
          [0.736019, 0.209439, 0.527908],
          [0.740143, 0.213864, 0.524216],
          [0.744232, 0.218288, 0.520524],
          [0.748289, 0.222711, 0.516834],
          [0.752312, 0.227133, 0.513149],
          [0.756304, 0.231555, 0.509468],
          [0.760264, 0.235976, 0.505794],
          [0.764193, 0.240396, 0.502126],
          [0.76809, 0.244817, 0.498465],
          [0.771958, 0.249237, 0.494813],
          [0.775796, 0.253658, 0.491171],
          [0.779604, 0.258078, 0.487539],
          [0.783383, 0.2625, 0.483918],
          [0.787133, 0.266922, 0.480307],
          [0.790855, 0.271345, 0.476706],
          [0.794549, 0.27577, 0.473117],
          [0.798216, 0.280197, 0.469538],
          [0.801855, 0.284626, 0.465971],
          [0.805467, 0.289057, 0.462415],
          [0.809052, 0.293491, 0.45887],
          [0.812612, 0.297928, 0.455338],
          [0.816144, 0.302368, 0.451816],
          [0.819651, 0.306812, 0.448306],
          [0.823132, 0.311261, 0.444806],
          [0.826588, 0.315714, 0.441316],
          [0.830018, 0.320172, 0.437836],
          [0.833422, 0.324635, 0.434366],
          [0.836801, 0.329105, 0.430905],
          [0.840155, 0.33358, 0.427455],
          [0.843484, 0.338062, 0.424013],
          [0.846788, 0.342551, 0.420579],
          [0.850066, 0.347048, 0.417153],
          [0.853319, 0.351553, 0.413734],
          [0.856547, 0.356066, 0.410322],
          [0.85975, 0.360588, 0.406917],
          [0.862927, 0.365119, 0.403519],
          [0.866078, 0.36966, 0.400126],
          [0.869203, 0.374212, 0.396738],
          [0.872303, 0.378774, 0.393355],
          [0.875376, 0.383347, 0.389976],
          [0.878423, 0.387932, 0.3866],
          [0.881443, 0.392529, 0.383229],
          [0.884436, 0.397139, 0.37986],
          [0.887402, 0.401762, 0.376494],
          [0.89034, 0.406398, 0.37313],
          [0.89325, 0.411048, 0.369768],
          [0.896131, 0.415712, 0.366407],
          [0.898984, 0.420392, 0.363047],
          [0.901807, 0.425087, 0.359688],
          [0.904601, 0.429797, 0.356329],
          [0.907365, 0.434524, 0.35297],
          [0.910098, 0.439268, 0.34961],
          [0.9128, 0.444029, 0.346251],
          [0.915471, 0.448807, 0.34289],
          [0.918109, 0.453603, 0.339529],
          [0.920714, 0.458417, 0.336166],
          [0.923287, 0.463251, 0.332801],
          [0.925825, 0.468103, 0.329435],
          [0.928329, 0.472975, 0.326067],
          [0.930798, 0.477867, 0.322697],
          [0.933232, 0.48278, 0.319325],
          [0.93563, 0.487712, 0.315952],
          [0.93799, 0.492667, 0.312575],
          [0.940313, 0.497642, 0.309197],
          [0.942598, 0.502639, 0.305816],
          [0.944844, 0.507658, 0.302433],
          [0.947051, 0.512699, 0.299049],
          [0.949217, 0.517763, 0.295662],
          [0.951344, 0.52285, 0.292275],
          [0.953428, 0.52796, 0.288883],
          [0.95547, 0.533093, 0.28549],
          [0.957469, 0.53825, 0.282096],
          [0.959424, 0.543431, 0.278701],
          [0.961336, 0.548636, 0.275305],
          [0.963203, 0.553865, 0.271909],
          [0.965024, 0.559118, 0.268513],
          [0.966798, 0.564396, 0.265118],
          [0.968526, 0.5697, 0.261721],
          [0.970205, 0.575028, 0.258325],
          [0.971835, 0.580382, 0.254931],
          [0.973416, 0.585761, 0.25154],
          [0.974947, 0.591165, 0.248151],
          [0.976428, 0.596595, 0.244767],
          [0.977856, 0.602051, 0.241387],
          [0.979233, 0.607532, 0.238013],
          [0.980556, 0.613039, 0.234646],
          [0.981826, 0.618572, 0.231287],
          [0.983041, 0.624131, 0.227937],
          [0.984199, 0.629718, 0.224595],
          [0.985301, 0.63533, 0.221265],
          [0.986345, 0.640969, 0.217948],
          [0.987332, 0.646633, 0.214648],
          [0.98826, 0.652325, 0.211364],
          [0.989128, 0.658043, 0.2081],
          [0.989935, 0.663787, 0.204859],
          [0.990681, 0.669558, 0.201642],
          [0.991365, 0.675355, 0.198453],
          [0.991985, 0.681179, 0.195295],
          [0.992541, 0.68703, 0.19217],
          [0.993032, 0.692907, 0.189084],
          [0.993456, 0.69881, 0.186041],
          [0.993814, 0.704741, 0.183043],
          [0.994103, 0.710698, 0.180097],
          [0.994324, 0.716681, 0.177208],
          [0.994474, 0.722691, 0.174381],
          [0.994553, 0.728728, 0.171622],
          [0.994561, 0.734791, 0.168938],
          [0.994495, 0.74088, 0.166335],
          [0.994355, 0.746995, 0.163821],
          [0.994141, 0.753137, 0.161404],
          [0.993851, 0.759304, 0.159092],
          [0.993482, 0.765499, 0.156891],
          [0.993033, 0.77172, 0.154808],
          [0.992505, 0.777967, 0.152855],
          [0.991897, 0.784239, 0.151042],
          [0.991209, 0.790537, 0.149377],
          [0.990439, 0.796859, 0.14787],
          [0.989587, 0.803205, 0.146529],
          [0.988648, 0.809579, 0.145357],
          [0.987621, 0.815978, 0.144363],
          [0.986509, 0.822401, 0.143557],
          [0.985314, 0.828846, 0.142945],
          [0.984031, 0.835315, 0.142528],
          [0.982653, 0.841812, 0.142303],
          [0.98119, 0.848329, 0.142279],
          [0.979644, 0.854866, 0.142453],
          [0.977995, 0.861432, 0.142808],
          [0.976265, 0.868016, 0.143351],
          [0.974443, 0.874622, 0.144061],
          [0.97253, 0.88125, 0.144923],
          [0.970533, 0.887896, 0.145919],
          [0.968443, 0.894564, 0.147014],
          [0.966271, 0.901249, 0.14818],
          [0.964021, 0.90795, 0.14937],
          [0.961681, 0.914672, 0.15052],
          [0.959276, 0.921407, 0.151566],
          [0.956808, 0.928152, 0.152409],
          [0.954287, 0.934908, 0.152921],
          [0.951726, 0.941671, 0.152925],
          [0.949151, 0.948435, 0.152178],
          [0.946602, 0.95519, 0.150328],
          [0.944152, 0.961916, 0.146861],
          [0.941896, 0.96859, 0.140956],
          [0.940015, 0.975158, 0.131326],
        ])
      ),
      a.checkNew(
        new a.Colormap("i8", [
          [0, 0, 0],
          [0, 1, 0],
          [0, 0, 1],
          [0, 1, 1],
          [1, 0, 0],
          [1, 1, 0],
          [1, 0, 1],
          [1, 1, 1],
        ])
      ),
      a.checkNew(
        new a.Colormap("aips0", [
          [0.196, 0.196, 0.196],
          [0.475, 0, 0.608],
          [0, 0, 0.785],
          [0.373, 0.655, 0.925],
          [0, 0.596, 0],
          [0, 0.965, 0],
          [1, 1, 0],
          [1, 0.694, 0],
          [1, 0, 0],
        ])
      ),
      a.checkNew(
        new a.Colormap("sls", [
          [0, 0, 0],
          [0.043442, 0, 0.052883],
          [0.086883, 0, 0.105767],
          [0.130325, 0, 0.15865],
          [0.173767, 0, 0.211533],
          [0.217208, 0, 0.264417],
          [0.26065, 0, 0.3173],
          [0.304092, 0, 0.370183],
          [0.347533, 0, 0.423067],
          [0.390975, 0, 0.47595],
          [0.434417, 0, 0.528833],
          [0.477858, 0, 0.581717],
          [0.5213, 0, 0.6346],
          [0.506742, 0, 0.640217],
          [0.492183, 0, 0.645833],
          [0.477625, 0, 0.65145],
          [0.463067, 0, 0.657067],
          [0.448508, 0, 0.662683],
          [0.43395, 0, 0.6683],
          [0.419392, 0, 0.673917],
          [0.404833, 0, 0.679533],
          [0.390275, 0, 0.68515],
          [0.375717, 0, 0.690767],
          [0.361158, 0, 0.696383],
          [0.3466, 0, 0.702],
          [0.317717, 0, 0.712192],
          [0.288833, 0, 0.722383],
          [0.25995, 0, 0.732575],
          [0.231067, 0, 0.742767],
          [0.202183, 0, 0.752958],
          [0.1733, 0, 0.76315],
          [0.144417, 0, 0.773342],
          [0.115533, 0, 0.783533],
          [0.08665, 0, 0.793725],
          [0.057767, 0, 0.803917],
          [0.028883, 0, 0.814108],
          [0, 0, 0.8243],
          [0, 0.019817, 0.838942],
          [0, 0.039633, 0.853583],
          [0, 0.05945, 0.868225],
          [0, 0.079267, 0.882867],
          [0, 0.099083, 0.897508],
          [0, 0.1189, 0.91215],
          [0, 0.138717, 0.926792],
          [0, 0.158533, 0.941433],
          [0, 0.17835, 0.956075],
          [0, 0.198167, 0.970717],
          [0, 0.217983, 0.985358],
          [0, 0.2378, 1],
          [0, 0.268533, 1],
          [0, 0.299267, 1],
          [0, 0.33, 1],
          [0, 0.360733, 1],
          [0, 0.391467, 1],
          [0, 0.4222, 1],
          [0, 0.452933, 1],
          [0, 0.483667, 1],
          [0, 0.5144, 1],
          [0, 0.545133, 1],
          [0, 0.575867, 1],
          [0, 0.6066, 1],
          [0, 0.631733, 0.9753],
          [0, 0.656867, 0.9506],
          [0, 0.682, 0.9259],
          [0, 0.707133, 0.9012],
          [0, 0.732267, 0.8765],
          [0, 0.7574, 0.8518],
          [0, 0.782533, 0.8271],
          [0, 0.807667, 0.8024],
          [0, 0.8328, 0.7777],
          [0, 0.857933, 0.753],
          [0, 0.883067, 0.7283],
          [0, 0.9082, 0.7036],
          [0, 0.901908, 0.676675],
          [0, 0.895617, 0.64975],
          [0, 0.889325, 0.622825],
          [0, 0.883033, 0.5959],
          [0, 0.876742, 0.568975],
          [0, 0.87045, 0.54205],
          [0, 0.864158, 0.515125],
          [0, 0.857867, 0.4882],
          [0, 0.851575, 0.461275],
          [0, 0.845283, 0.43435],
          [0, 0.838992, 0.407425],
          [0, 0.8327, 0.3805],
          [0, 0.832308, 0.354858],
          [0, 0.831917, 0.329217],
          [0, 0.831525, 0.303575],
          [0, 0.831133, 0.277933],
          [0, 0.830742, 0.252292],
          [0, 0.83035, 0.22665],
          [0, 0.829958, 0.201008],
          [0, 0.829567, 0.175367],
          [0, 0.829175, 0.149725],
          [0, 0.828783, 0.124083],
          [0, 0.828392, 0.098442],
          [0, 0.828, 0.0728],
          [0.033167, 0.834167, 0.066733],
          [0.066333, 0.840333, 0.060667],
          [0.0995, 0.8465, 0.0546],
          [0.132667, 0.852667, 0.048533],
          [0.165833, 0.858833, 0.042467],
          [0.199, 0.865, 0.0364],
          [0.232167, 0.871167, 0.030333],
          [0.265333, 0.877333, 0.024267],
          [0.2985, 0.8835, 0.0182],
          [0.331667, 0.889667, 0.012133],
          [0.364833, 0.895833, 0.006067],
          [0.398, 0.902, 0],
          [0.43095, 0.902, 0],
          [0.4639, 0.902, 0],
          [0.49685, 0.902, 0],
          [0.5298, 0.902, 0],
          [0.56275, 0.902, 0],
          [0.5957, 0.902, 0],
          [0.62865, 0.902, 0],
          [0.6616, 0.902, 0],
          [0.69455, 0.902, 0],
          [0.7275, 0.902, 0],
          [0.76045, 0.902, 0],
          [0.7934, 0.902, 0],
          [0.810617, 0.897133, 0.003983],
          [0.827833, 0.892267, 0.007967],
          [0.84505, 0.8874, 0.01195],
          [0.862267, 0.882533, 0.015933],
          [0.879483, 0.877667, 0.019917],
          [0.8967, 0.8728, 0.0239],
          [0.913917, 0.867933, 0.027883],
          [0.931133, 0.863067, 0.031867],
          [0.94835, 0.8582, 0.03585],
          [0.965567, 0.853333, 0.039833],
          [0.982783, 0.848467, 0.043817],
          [1, 0.8436, 0.0478],
          [0.995725, 0.824892, 0.0516],
          [0.99145, 0.806183, 0.0554],
          [0.987175, 0.787475, 0.0592],
          [0.9829, 0.768767, 0.063],
          [0.978625, 0.750058, 0.0668],
          [0.97435, 0.73135, 0.0706],
          [0.970075, 0.712642, 0.0744],
          [0.9658, 0.693933, 0.0782],
          [0.961525, 0.675225, 0.082],
          [0.95725, 0.656517, 0.0858],
          [0.952975, 0.637808, 0.0896],
          [0.9487, 0.6191, 0.0934],
          [0.952975, 0.600408, 0.085617],
          [0.95725, 0.581717, 0.077833],
          [0.961525, 0.563025, 0.07005],
          [0.9658, 0.544333, 0.062267],
          [0.970075, 0.525642, 0.054483],
          [0.97435, 0.50695, 0.0467],
          [0.978625, 0.488258, 0.038917],
          [0.9829, 0.469567, 0.031133],
          [0.987175, 0.450875, 0.02335],
          [0.99145, 0.432183, 0.015567],
          [0.995725, 0.413492, 0.007783],
          [1, 0.3948, 0],
          [0.998342, 0.3619, 0],
          [0.996683, 0.329, 0],
          [0.995025, 0.2961, 0],
          [0.993367, 0.2632, 0],
          [0.991708, 0.2303, 0],
          [0.99005, 0.1974, 0],
          [0.988392, 0.1645, 0],
          [0.986733, 0.1316, 0],
          [0.985075, 0.0987, 0],
          [0.983417, 0.0658, 0],
          [0.981758, 0.0329, 0],
          [0.9801, 0, 0],
          [0.955925, 0, 0],
          [0.93175, 0, 0],
          [0.907575, 0, 0],
          [0.8834, 0, 0],
          [0.859225, 0, 0],
          [0.83505, 0, 0],
          [0.810875, 0, 0],
          [0.7867, 0, 0],
          [0.762525, 0, 0],
          [0.73835, 0, 0],
          [0.714175, 0, 0],
          [0.69, 0, 0],
          [0.715833, 0.083333, 0.083333],
          [0.741667, 0.166667, 0.166667],
          [0.7675, 0.25, 0.25],
          [0.793333, 0.333333, 0.333333],
          [0.819167, 0.416667, 0.416667],
          [0.845, 0.5, 0.5],
          [0.870833, 0.583333, 0.583333],
          [0.896667, 0.666667, 0.666667],
          [0.9225, 0.75, 0.75],
          [0.948333, 0.833333, 0.833333],
          [0.974167, 0.916667, 0.916667],
          [1, 1, 1],
          [1, 1, 1],
          [1, 1, 1],
          [1, 1, 1],
          [1, 1, 1],
          [1, 1, 1],
          [1, 1, 1],
          [1, 1, 1],
        ])
      ),
      a.checkNew(
        new a.Colormap(
          "a",
          [
            [0, 0],
            [0.25, 0],
            [0.5, 1],
            [1, 1],
          ],
          [
            [0, 0],
            [0.25, 1],
            [0.5, 0],
            [0.77, 0],
            [1, 1],
          ],
          [
            [0, 0],
            [0.125, 0],
            [0.5, 1],
            [0.64, 0.5],
            [0.77, 0],
            [1, 0],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "b",
          [
            [0, 0],
            [0.25, 0],
            [0.5, 1],
            [1, 1],
          ],
          [
            [0, 0],
            [0.5, 0],
            [0.75, 1],
            [1, 1],
          ],
          [
            [0, 0],
            [0.25, 1],
            [0.5, 0],
            [0.75, 0],
            [1, 1],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "bb",
          [
            [0, 0],
            [0.5, 1],
            [1, 1],
          ],
          [
            [0, 0],
            [0.25, 0],
            [0.75, 1],
            [1, 1],
          ],
          [
            [0, 0],
            [0.5, 0],
            [1, 1],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "he",
          [
            [0, 0],
            [0.015, 0.5],
            [0.25, 0.5],
            [0.5, 0.75],
            [1, 1],
          ],
          [
            [0, 0],
            [0.065, 0],
            [0.125, 0.5],
            [0.25, 0.75],
            [0.5, 0.81],
            [1, 1],
          ],
          [
            [0, 0],
            [0.015, 0.125],
            [0.03, 0.375],
            [0.065, 0.625],
            [0.25, 0.25],
            [1, 1],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "hsv",
          (function () {
            var a,
              b = 0,
              d = [];
            for (a = 0; 200 > a; a++, b++) {
              var e = 1 - a / 199;
              var f = 360 * e + 270;
              var g = Math.abs(Math.sin(3.1416 * e));
              for (e = Math.pow(1 - e, 1 / 3); 360 <= f; ) f -= 360;
              f /= 60;
              var h = Math.floor(f);
              var l = f - h;
              f = e * (1 - g);
              var m = e * (1 - g * l);
              g = e * (1 - g * (1 - l));
              d[b] = [];
              switch (h) {
                case 0:
                  d[b].push(e);
                  d[b].push(g);
                  d[b].push(f);
                  break;
                case 1:
                  d[b].push(m);
                  d[b].push(e);
                  d[b].push(f);
                  break;
                case 2:
                  d[b].push(f);
                  d[b].push(e);
                  d[b].push(g);
                  break;
                case 3:
                  d[b].push(f);
                  d[b].push(m);
                  d[b].push(e);
                  break;
                case 4:
                  d[b].push(g);
                  d[b].push(f);
                  d[b].push(e);
                  break;
                case 5:
                  (d[b].push(e), d[b].push(f), d[b].push(m));
              }
            }
            return d;
          })()
        )
      ),
      a.checkNew(
        new a.Colormap(
          "rainbow",
          [
            [0, 1],
            [0.2, 0],
            [0.6, 0],
            [0.8, 1],
            [1, 1],
          ],
          [
            [0, 0],
            [0.2, 0],
            [0.4, 1],
            [0.8, 1],
            [1, 0],
          ],
          [
            [0, 1],
            [0.4, 1],
            [0.6, 0],
            [1, 0],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "standard",
          [
            [0, 0],
            [0.333, 0.3],
            [0.333, 0],
            [0.666, 0.3],
            [0.666, 0.3],
            [1, 1],
          ],
          [
            [0, 0],
            [0.333, 0.3],
            [0.333, 0.3],
            [0.666, 1],
            [0.666, 0],
            [1, 0.3],
          ],
          [
            [0, 0],
            [0.333, 1],
            [0.333, 0],
            [0.666, 0.3],
            [0.666, 0],
            [1, 0.3],
          ]
        )
      ),
      a.checkNew(
        new a.Colormap(
          "staircase",
          (function () {
            var a,
              b = 0,
              d = [];
            for (a = 1; 5 >= a; a++, b++) {
              var e = a / 5;
              d[b] = [];
              d[b].push(0.3 * e);
              d[b].push(0.3 * e);
              d[b].push(e);
            }
            for (a = 1; 5 >= a; a++, b++)
              ((e = a / 5), (d[b] = []), d[b].push(0.3 * e), d[b].push(e), d[b].push(0.3 * e));
            for (a = 1; 5 >= a; a++, b++)
              ((e = a / 5), (d[b] = []), d[b].push(e), d[b].push(0.3 * e), d[b].push(0.3 * e));
            return d;
          })()
        )
      ),
      a.checkNew(
        new a.Colormap("color", [
          [0, 0, 0],
          [0.18431, 0.18431, 0.18431],
          [0.37255, 0.37255, 0.37255],
          [0.56078, 0.56078, 0.56078],
          [0.74902, 0.74902, 0.74902],
          [0.93725, 0.93725, 0.93725],
          [0, 0.18431, 0.93725],
          [0, 0.37255, 0.74902],
          [0, 0.49804, 0.49804],
          [0, 0.74902, 0.3098],
          [0, 0.93725, 0],
          [0.3098, 0.62353, 0],
          [0.49804, 0.49804, 0],
          [0.62353, 0.3098, 0],
          [0.93725, 0, 0],
          [0.74902, 0, 0.3098],
        ])
      ));
  };
  a.initCommands = function () {
    Object.prototype.hasOwnProperty.call(a, "Command") &&
      (a.checkNew(
        new a.Command({
          name: "analysis",
          alias: "run",
          help: "list/run analysis for current image",
          get: function () {
            var a,
              b,
              d = "",
              e = this.image;
            if (e && e.analysisPackages)
              for (b = 0; b < e.analysisPackages.length; b++) {
                var f = e.analysisPackages[b];
                for (a = 0; a < f.length; a++) {
                  var g = f[a];
                  d && (d += ", ");
                  var h = g.xclass ? g.xclass + ":" + g.name : g.name;
                  d += g.title + " (" + h + ")";
                }
                b < e.analysisPackages.length - 1 && (d += "\n");
              }
            return d;
          },
          set: function (c) {
            var b,
              d = this.image;
            d &&
              ((b = d.lookupAnalysis(c[0]))
                ? b.purl
                  ? ((c = d.displayAnalysis("params", a.InstallDir(b.purl), {
                      title: b.title + ": " + d.fitsFile,
                    })),
                    $(c).data("dispid", d.display.id).data("aname", b.name))
                  : d.runAnalysis(b.name)
                : a.error("unknown analysis command '" + c[0] + "'"));
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "colormap",
          alias: "cmap",
          help: "set/get colormap for current image",
          get: function () {
            var a;
            if ((a = this.image))
              return ((a = a.getColormap()), a.colormap + " " + a.contrast + " " + a.bias);
          },
          set: function (a) {
            var b = this.image;
            b && b.setColormap.apply(b, $jscomp.arrayFromIterable(a));
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "colormaps",
          alias: "cmaps",
          help: "get list of available colormaps",
          get: function () {
            var c,
              b = "";
            for (c = 0; c < a.colormaps.length; c++) (b && (b += ", "), (b += a.colormaps[c].name));
            return b;
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "global",
          help: "set/get a JS9.globalOpts parameter",
          set: function (c) {
            if (1 == c.length) {
              if (((c = a.globalOpts[c[0]]), a.notNull(c)))
                switch (typeof c) {
                  case "boolean":
                    return c ? "true" : "false";
                  case "number":
                    return String(c);
                  case "string":
                    return c;
                  case "object":
                    return JSON.stringify(c);
                  default:
                    return "";
                }
            } else if (2 <= c.length) {
              var b = c[0];
              c = c[1];
              if ("string" === typeof b && "string" === typeof c)
                switch (typeof a.globalOpts[b]) {
                  case "boolean":
                    a.globalOpts[b] = c.match(/true/i) ? !0 : !1;
                    break;
                  case "number":
                    a.globalOpts[b] = parseFloat(c);
                    break;
                  case "string":
                    a.globalOpts[b] = c;
                    break;
                  case "object":
                    try {
                      c = JSON.parse(c);
                    } catch (d) {
                      a.error("invalid JSON for global cmd: " + c);
                    }
                    a.globalOpts[b] = c;
                }
            }
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "grid",
          help: "set/get coordinate grid for current image",
          get: function () {
            var a,
              b = this.image;
            b && (a = b.displayCoordGrid());
            return a ? "true" : "false";
          },
          set: function (a) {
            var b = this.image;
            if (b) {
              var c = a[0].match(/true/i) ? !0 : !1;
              b.displayCoordGrid(c, a[1]);
            }
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "help",
          help: "get list of available commands",
          get: function () {
            var c,
              b = "<table class='JS9CmdHelp'>";
            for (c = 0; c < a.commands.length; c++) {
              var d = a.commands[c];
              b += "<tr><td>" + d.name + "</td><td>" + d.help;
              d.alias && ((b += " (" + d.alias), d.alias2 && (b += ", " + d.alias2), (b += ")"));
              b += "</td></tr>";
            }
            return (
              b +
              '<tr><td colspan="2">&nbsp;</td></tr><tr><td colspan="2">Or execute JS9 public access routines (use spaceless args, please):</td></tr><tr><td colspan="2">&nbsp;</td></tr><tr><td colspan="2">SetColormap heat</td></tr><tr><td colspan="2">GetColormap</td></tr><tr><td colspan="2">{"colormap":"heat","contrast":3.75,"bias":0.736328125}</td></tr><tr><td colspan="2">AddRegions circle(23:23:27.9,+58:48:42.8,3") {"color":"cyan"}</td></tr></table>'
            );
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "helper",
          help: "set/get helper connection",
          get: function () {
            return a.helper.connectinfo();
          },
          set: function (c) {
            a.helper.connect(c[0].trim());
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "image",
          help: "get name of current image or display specified image",
          get: function () {
            var a = this.image;
            if (a) return a.file;
          },
          set: function (c) {
            var b;
            for (b = 0; b < a.images.length; b++) {
              var d = a.images[b];
              if (0 <= d.file.search(c[0]) && d.display === this.display) {
                d.displayImage("display");
                break;
              }
            }
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "images",
          help: "get list of currently loaded images",
          get: function () {
            var c,
              b = "";
            for (c = 0; c < a.images.length; c++) {
              var d = a.images[c];
              d.display === this.display && (b && (b += ", "), (b += d.file));
            }
            return b;
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "load",
          help: "load image(s)",
          set: function (c) {
            var b,
              d = c.length;
            for (b = 0; b < d; b++) {
              var e = null;
              var f = b + 1;
              if (f < d && c[f].startsWith("{"))
                try {
                  e = JSON.parse(c[f]);
                } catch (g) {
                  e = null;
                }
              e
                ? (a.Load(c[b], e, { display: this.display.id }), b++)
                : a.Load(c[b], { display: this.display.id });
            }
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "pan",
          help: "set/get pan location for current image",
          get: function () {
            var a;
            if ((a = this.image)) return ((a = a.getPan()), a.x + " " + a.x);
          },
          set: function (a) {
            var b = this.image;
            b && b.setPan.apply(b, $jscomp.arrayFromIterable(a));
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "pix2wcs",
          help: "get image pixel value for specified wcs position",
          set: function (c) {
            var b = this.image;
            if (b)
              return ((c = a.Pix2WCS(parseFloat(c[0]), parseFloat(c[1]), { display: b })), c.str);
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "print",
          help: "print image window",
          get: function () {
            var a = this.image;
            a && a.print();
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "refresh",
          help: "refresh image using specified file (def: use last file)",
          set: function (c) {
            var b = c.length;
            var d = this.image;
            if (0 === b) {
              var e = { refresh: d };
              a.Load(d.file, e, { display: this.display.id });
            } else
              for (d = 0; d < b; d++) {
                e = null;
                var f = d + 1;
                if (f < b && c[f].startsWith("{"))
                  try {
                    e = JSON.parse(c[f]);
                  } catch (g) {
                    e = null;
                  }
                e
                  ? ((e.refresh = !0), a.Load(c[d], e, { display: this.display.id }), d++)
                  : ((e = { refresh: !0 }), a.Load(c[d], e, { display: this.display.id }));
              }
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "regcnts",
          help: "counts in regions for current image",
          get: function () {
            var a = this.image;
            a && a.countsInRegions("$sregions", "$bregions", { lightwin: !0 });
          },
          set: function (a) {
            var b = this.image;
            if (b) return b.countsInRegions.apply(b, $jscomp.arrayFromIterable(a));
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "regions",
          alias: "reg",
          alias2: "region",
          help: "add or list region(s)",
          get: function () {
            var a = this.image;
            if (a) return a.listRegions("all", { mode: 0 }) || "";
          },
          set: function (a) {
            var b = this.image;
            b &&
              ("delete" === a[0] || "remove" === a[0]
                ? ((a = a.slice(1).join(" ")), b.removeShapes("regions", a))
                : ((a = a.join(" ")), b.addShapes("regions", a)));
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "resize",
          help: "set/get display size for current image",
          get: function () {
            var a;
            if ((a = this.image)) return ((a = a.display), a.width + " " + a.height);
          },
          set: function (a) {
            var b;
            if ((b = this.image) && a.length) {
              b = b.display;
              var c = parseInt(a[0], 10);
              a = 1 < a.length ? parseInt(a[1], 10) : c;
              b.resize(c, a);
            }
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "scale",
          help: "set/get scaling for current image",
          get: function () {
            var a;
            if ((a = this.image))
              return ((a = a.getScale()), a.scale + " " + a.scalemin + " " + a.scalemax);
          },
          set: function (a) {
            var b = this.image;
            b && b.setScale.apply(b, $jscomp.arrayFromIterable(a));
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "scales",
          help: "get list of available scales",
          get: function () {
            return a.scales.join(", ");
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "section",
          help: "display section of current image",
          set: function (c) {
            var b = this.image;
            if (1 === c.length && "full" === c[0]) b.displaySection("full");
            else if ((c = c.join(" "))) {
              try {
                var d = JSON.parse(c);
              } catch (e) {
                a.error("invalid JSON section");
              }
              b.displaySection(d);
            }
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "status",
          help: "get status for specified (or current) image",
          get: function (c) {
            var b,
              d = "";
            for (b = 0; b < a.images.length; b++) {
              var e = a.images[b];
              if (0 <= e.file.search(c[0])) {
                var f = e;
                break;
              }
            }
            f ? (b = 1) : ((b = 0), (f = this.image));
            if (f) {
              if (b > c.length) return f.status.load;
              for (; b < c.length; b++)
                switch (((e = c[b].toLowerCase().trim()), e)) {
                  case "load":
                    (d && (d += "\n"), (d += f.status.load));
                }
            }
            return d;
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "url",
          help: "display a url",
          set: function (c) {
            a.DisplayHelp(c[0]);
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "wcssys",
          help: "set/get wcs system for current image",
          get: function () {
            var a = this.image;
            if (a) return a.getWCSSys();
          },
          set: function (a) {
            var b = this.image;
            b && b.setWCSSys(a[0]);
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "wcsu",
          help: "set/get wcs units used for current image",
          get: function () {
            var a = this.image;
            if (a) return a.getWCSUnits();
          },
          set: function (a) {
            var b = this.image;
            b && b.setWCSUnits(a[0]);
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "wcssystems",
          help: "get list of available wcs systems",
          get: function () {
            return a.wcssyss.join(", ");
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "wcsunits",
          help: "get list of available wcs units",
          get: function () {
            return a.wcsunitss.join(", ");
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "wcs2pix",
          help: "get wcs position for specified image pixel",
          set: function (c) {
            var b = this.image;
            if (b)
              return ((c = a.WCS2Pix(parseFloat(c[0]), parseFloat(c[1]), { display: b })), c.str);
          },
        })
      ),
      a.checkNew(
        new a.Command({
          name: "zoom",
          help: "set/get zoom for current image",
          get: function () {
            var a = this.image;
            if (a) return a.getZoom();
          },
          set: function (a) {
            var b = this.image;
            b && b.setZoom(a[0]);
          },
        })
      ));
  };
  a.initAnalysis = function () {
    $(document).on("keypress", ".js9AnalysisForm, .js9Form, .js9Input", function (a) {
      var b;
      if (13 === (a.which || a.keyCode) && (b = $(a.currentTarget).data("enterfunc"))) {
        a.preventDefault();
        var c = $(a.currentTarget).find("[name='" + b + "']");
        c.length
          ? c.click()
          : ((c = $(a.currentTarget).siblings("[name='" + b + "']")), c.length && c.click());
        return !1;
      }
    });
  };
  a.parsePublicArgs = function (a) {
    var b = null;
    a = Array.from(a);
    var c = a[a.length - 1];
    c &&
      "object" === typeof c &&
      Object.prototype.hasOwnProperty.call(c, "display") &&
      1 === Object.keys(c).length &&
      ((b = c.display), a.pop());
    return { argv: a, display: b };
  };
  a.mkPublic = function (c, b) {
    "string" === typeof b
      ? a.Image.prototype[b]
        ? ((a[c] = function (c) {
            for (var d = [], f = 0; f < arguments.length; ++f) d[f - 0] = arguments[f];
            f = a.parsePublicArgs(d);
            d = f.argv;
            if ((f = a.getImage(f.display)))
              return (
                (d = f[b].apply(f, $jscomp.arrayFromIterable(d))),
                d === f || d === f.display ? (a.globalOpts.quietReturn ? "" : "OK") : d
              );
          }),
          (a.publics[c] = a[c]))
        : a.error("unknown image func for mkPublic: " + b)
      : "function" === typeof b
        ? ((a[c] = b), (a.publics[c] = a[c]))
        : a.error("unsupported type for mkPublic: " + typeof b);
  };
  a.mkPublic("CloseImage", "closeImage");
  a.mkPublic("DisplayImage", "displayImage");
  a.mkPublic("DisplayExtension", "displayExtension");
  a.mkPublic("DisplaySlice", "displaySlice");
  a.mkPublic("DisplaySection", "displaySection");
  a.mkPublic("BlendImage", "blendImage");
  a.mkPublic("MaskImage", "maskImage");
  a.mkPublic("GetColormap", "getColormap");
  a.mkPublic("SetColormap", "setColormap");
  a.mkPublic("GetZoom", "getZoom");
  a.mkPublic("SetZoom", "setZoom");
  a.mkPublic("GetPan", "getPan");
  a.mkPublic("SetPan", "setPan");
  a.mkPublic("AlignPanZoom", "alignPanZoom");
  a.mkPublic("GetScale", "getScale");
  a.mkPublic("SetScale", "setScale");
  a.mkPublic("GetOpacity", "getOpacity");
  a.mkPublic("SetOpacity", "setOpacity");
  a.mkPublic("SetFlip", "setFlip");
  a.mkPublic("GetFlip", "getFlip");
  a.mkPublic("SetRotate", "setRotate");
  a.mkPublic("GetRotate", "getRotate");
  a.mkPublic("SetRot90", "setRot90");
  a.mkPublic("GetRot90", "getRot90");
  a.mkPublic("GetParam", "getParam");
  a.mkPublic("SetParam", "setParam");
  a.mkPublic("CopyParams", "copyParams");
  a.mkPublic("GetValPos", "updateValpos");
  a.mkPublic("ImageToDisplayPos", "imageToDisplayPos");
  a.mkPublic("DisplayToImagePos", "displayToImagePos");
  a.mkPublic("ImageToLogicalPos", "imageToLogicalPos");
  a.mkPublic("LogicalToImagePos", "logicalToImagePos");
  a.mkPublic("GetWCSUnits", "getWCSUnits");
  a.mkPublic("SetWCSUnits", "setWCSUnits");
  a.mkPublic("GetWCS", "getWCS");
  a.mkPublic("SetWCS", "setWCS");
  a.mkPublic("GetWCSSys", "getWCSSys");
  a.mkPublic("SetWCSSys", "setWCSSys");
  a.mkPublic("ShowShapeLayer", "showShapeLayer");
  a.mkPublic("ActiveShapeLayer", "activeShapeLayer");
  a.mkPublic("ToggleShapeLayers", "toggleShapeLayers");
  a.mkPublic("AddShapes", "addShapes");
  a.mkPublic("RemoveShapes", "removeShapes");
  a.mkPublic("GetShapes", "getShapes");
  a.mkPublic("ChangeShapes", "changeShapes");
  a.mkPublic("CopyShapes", "copyShapes");
  a.mkPublic("SelectShapes", "selectShapes");
  a.mkPublic("UnselectShapes", "unselectShapes");
  a.mkPublic("GroupShapes", "groupShapes");
  a.mkPublic("UngroupShapes", "ungroupShapes");
  a.mkPublic("DisplayCoordGrid", "displayCoordGrid");
  a.mkPublic("Print", "print");
  a.mkPublic("SavePNG", "savePNG");
  a.mkPublic("SaveJPEG", "saveJPEG");
  a.mkPublic("SaveFITS", "saveFITS");
  a.mkPublic("UploadFITSFile", "uploadFITSFile");
  a.mkPublic("CountsInRegions", "countsInRegions");
  a.mkPublic("RadialProfile", "radialProfile");
  a.mkPublic("Plot3D", "plot3d");
  a.mkPublic("RunAnalysis", "runAnalysis");
  a.mkPublic("GetAnalysis", "getAnalysis");
  a.mkPublic("RawDataLayer", "rawDataLayer");
  a.mkPublic("GaussBlurData", "gaussBlurData");
  a.mkPublic("ImarithData", "imarithData");
  a.mkPublic("RotateData", "rotateData");
  a.mkPublic("ReprojectData", "reprojectData");
  a.mkPublic("ShiftData", "shiftData");
  a.mkPublic("FilterRGBImage", "filterRGBImage");
  a.mkPublic("MoveToDisplay", "moveToDisplay");
  a.mkPublic("LookupImage", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    return a.lookupImage(b.argv[0], b.display);
  });
  a.mkPublic("LookupDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    return a.lookupDisplay(b.argv[0] || b.display, b.argv[1]);
  });
  a.mkPublic("DisplayNextImage", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = a.parsePublicArgs(b);
    if ((b = a.lookupDisplay(d.display))) return ((d = parseFloat(d.argv[0]) || 1), b.nextImage(d));
  });
  a.mkPublic("RenameDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e;
    d = a.parsePublicArgs(b);
    switch (d.argv.length) {
      case 0:
        return;
      case 1:
        b = d.display;
        d = d.argv[0];
        break;
      default:
        ((b = d.argv[0]), (d = d.argv[1]));
    }
    (e = a.lookupDisplay(b)) &&
      e.id &&
      ((b = e.id),
      e.oid || (e.oid = b),
      (e.id = d),
      a.helper.send("renameDisplay", { odisplay: b, ndisplay: e.id }));
  });
  a.mkPublic("CloseDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = a.parsePublicArgs(b);
    b = a.lookupDisplay(d.argv[0], !1);
    if (!b) {
      b = a.lookupDisplay(d.display);
      var e = d.argv[0];
    }
    if ((e = d.argv[1] || e))
      try {
        var f = new RegExp(e);
      } catch (g) {
        a.error("invalid regexp for CloseDisplay: " + e);
      }
    for (e = a.images.length - 1; 0 <= e; e--)
      ((d = a.images[e]),
        d.display === b &&
          (f
            ? (d.id.match(f) || d.file.match(f) || d.fitsFile.match(f)) && d.closeImage()
            : d.closeImage()));
  });
  a.mkPublic("AddColormap", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b),
      f = function (b, c) {
        var d;
        "object" !== typeof b && a.error("invalid colormap object for JS9.AddColormap()");
        $.isArray(b) || (b = [b]);
        for (d = 0; d < b.length; d++) {
          var e = b[d];
          e.name || a.error("missing name for colormap in JS9.AddColormap()");
          e.vertices
            ? a.AddColormap(e.name, e.vertices[0], e.vertices[1], e.vertices[2], c)
            : e.colors
              ? a.AddColormap(e.name, e.colors, c)
              : a.error("unknown colormap type for JS9.AddColormap()");
        }
      };
    b = e.argv[0];
    var g = e.argv[1];
    d = e.argv[2];
    var h = e.argv[3];
    var l = e.argv[4];
    if (b instanceof Blob)
      ((d = new FileReader()),
        (d.onload = function (b) {
          try {
            m = JSON.parse(b.target.result);
          } catch (q) {
            a.error("can't parse JSON colormap", q);
          }
          f(m, g);
        }),
        d.readAsText(b));
    else if ("object" === typeof b) f(b, g);
    else
      switch (e.argv.length) {
        case 1:
          try {
            var m = JSON.parse(b);
          } catch (k) {
            a.error("can't parse JSON colormap", k);
          }
          f(m);
          break;
        case 2:
        case 3:
          if ("string" === typeof g)
            try {
              g = JSON.parse(g);
            } catch (k) {
              a.error("can't parse JSON colormap", k);
            }
          a.checkNew(new a.Colormap(b, g));
          2 === e.argv.length
            ? a.globalOpts.topColormaps.push(b)
            : ("object" !== typeof d || !1 !== d.toplevel) && a.globalOpts.topColormaps.push(b);
          break;
        case 4:
        case 5:
          if ("string" === typeof g)
            try {
              g = JSON.parse(g);
            } catch (k) {
              a.error("can't parse JSON colormap", k);
            }
          if ("string" === typeof d)
            try {
              d = JSON.parse(d);
            } catch (k) {
              a.error("can't parse JSON colormap", k);
            }
          if ("string" === typeof h)
            try {
              h = JSON.parse(h);
            } catch (k) {
              a.error("can't parse JSON colormap", k);
            }
          a.checkNew(new a.Colormap(b, g, d, h));
          4 === e.argv.length
            ? a.globalOpts.topColormaps.push(b)
            : (l && "object" === typeof l && !1 === l.toplevel) ||
              a.globalOpts.topColormaps.push(b);
          break;
        default:
          a.error("AddColormap() requires a colormap name and 1 or 3 args");
      }
  });
  a.mkPublic("LoadColormap", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = a.parsePublicArgs(b);
    b = d.argv[0];
    var e = d.argv[1];
    b || a.error("JS9.LoadColormap: no file specified for colormap load");
    "object" === typeof b
      ? a.AddColormap(b, e)
      : "string" === typeof b
        ? ((b = a.fixPath(b, e)),
          a.fetchURL(null, b, null, function (b) {
            a.AddColormap(b, e);
          }))
        : a.error("unknown file type for LoadColormap: " + typeof b);
  });
  a.mkPublic("SetRGBMode", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b),
      f = a.lookupDisplay(e.display),
      g = ["red", "green", "blue"],
      h = ["rid", "gid", "bid"];
    var l = e.argv[0];
    var m = e.argv[1];
    void 0 === l && (l = !f.rgb.active);
    if (m)
      for (b = 0; 3 > b; b++)
        ((d = m[h[b]]), "string" === typeof d && (d = a.LookupImage(d)), d && d.setColormap(g[b]));
    "true" === l ? (l = !0) : "false" === l && (l = !1);
    f.rgb.active = !!l;
    a.DisplayImage({ display: e.display });
    return f.rgb.active;
  });
  a.mkPublic("GetRGBMode", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    b = a.lookupDisplay(b.display);
    return {
      active: b.rgb.active,
      rid: b.rgb.rim ? b.rgb.rim.id : null,
      gid: b.rgb.gim ? b.rgb.gim.id : null,
      bid: b.rgb.bim ? b.rgb.bim.id : null,
    };
  });
  a.mkPublic("SetValPos", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = null;
    var e = a.parsePublicArgs(b);
    b = a.getImage(e.display);
    e = e.argv[0];
    b && ((d = b.params.valpos), (b.params.valpos = e));
    return d;
  });
  a.mkPublic("SetImageInherit", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = null;
    var e = a.parsePublicArgs(b);
    b = a.getImage(e.display);
    e = e.argv[0];
    b && ((d = b.params.inherit), (b.params.inherit = e));
    return d;
  });
  a.mkPublic("GetImageInherit", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = null;
    b = a.parsePublicArgs(b);
    if ((b = a.getImage(b.display))) d = b.params.inherit;
    return d;
  });
  a.mkPublic("Load", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e;
    d = "fits";
    var f = a.parsePublicArgs(b);
    var g = f.argv[0];
    b = f.argv[1];
    g || a.error("JS9.Load: no file specified for image load");
    f = f.display ? f.display : 0 < a.displays.length ? a.displays[0].id : a.DEFID;
    b = b || {};
    if ("object" === typeof b) b = $.extend(!0, {}, b);
    else if ("string" === typeof b)
      try {
        b = JSON.parse(b);
      } catch (m) {
        b = {};
      }
    b.display = b.display || f;
    if (b.onload) var h = b.onload;
    else a.imageOpts.onload && ((h = a.imageOpts.onload), (b.onload = h));
    delete a.fetchURL.status;
    if (g instanceof Blob) {
      if (g.path || g.name)
        if (
          ((b.file = a.cleanPath(g.path || g.name)),
          (h = "object" === typeof b.refresh ? b.refresh : a.lookupImage(b.file, b.display)))
        )
          if ((a.isNull(b.refresh) && (b.refresh = a.globalOpts.reloadRefresh), b.refresh))
            b.refresh = h;
          else {
            h.displayImage("display", b);
            h.refreshLayers();
            h.display.clearMessage();
            if (b.onload)
              try {
                a.xeqByName(b.onload, window, h);
              } catch (m) {
                a.error("in image onload callback", m, !1);
              }
            a.waiting(!1);
            return;
          }
        else delete b.refresh;
      else delete b.refresh;
      b.file || (b.file = a.ANON + a.uniqueID());
      if (g.type && g.type.includes("image/"))
        switch (g.type) {
          case "image/fits":
            break;
          default:
            d = "img";
        }
      else
        b.file
          .split(".")
          .pop()
          .match(/(png|jpg|jpeg)/i) && (d = "img");
      switch (d) {
        case "fits":
          var l = $.extend(!0, {}, a.fits.options, b);
          g.path &&
            b.localAccess &&
            (h = a.localAccess(g.path)) &&
            ((g = g.path), (l.file = g), (l.vfile = h));
          try {
            a.handleFITSFile(g, l, a.NewFitsImage);
          } catch (m) {
            a.error("can't process FITS file", m);
          }
          break;
        case "img":
          try {
            a.handleImageFile(g, b, a.Load);
          } catch (m) {
            a.error("can't process IMG file", m);
          }
      }
    } else if ("object" === typeof g) a.checkNew(new a.Image(g, b, h));
    else if (
      ("string" !== typeof g && a.error("unknown file type for Load: " + typeof g),
      "U0lNUExFICA9" === g.slice(0, 12) && (g = window.atob(g)),
      "SIMPLE  =" === g.slice(0, 9))
    ) {
      h = [];
      for (e = 0; e < g.length; e++) h[e] = g.charCodeAt(e);
      e = new Blob([new Uint8Array(h)]);
      b.file || (b.file = a.ANON + a.uniqueID());
      e.name = b.file;
      l = $.extend(!0, {}, a.fits.options, b);
      try {
        a.handleFITSFile(e, l, a.NewFitsImage);
      } catch (m) {
        a.error("can't process FITS file", m);
      }
    } else {
      a.isNull(b.refresh) && (b.refresh = a.globalOpts.reloadRefresh);
      if (b.refresh)
        if ("object" === typeof b.refresh) h = b.refresh;
        else {
          if (((h = g.split("/").reverse()[0]), (h = a.lookupImage(h, b.display)))) b.refresh = h;
        }
      else ((h = g.split("/").reverse()[0]), (h = a.lookupImage(h, b.display)));
      if (h && !b.refresh) {
        h.displayImage("all", b);
        h.display.clearMessage();
        if (b.onload)
          try {
            a.xeqByName(b.onload, window, h);
          } catch (m) {
            a.error("in image onload callback", m, !1);
          }
        a.waiting(!1);
      } else
        ((g = a.cleanPath(g)),
          a.fits2fits(b.display, g, b) ||
            (b.display && (e = a.lookupDisplay(b.display)),
            a.waiting(!0, e),
            h && b.refresh && a.cleanupFITSFile(h.raw, !0),
            (g = a.fixPath(g, b)),
            (e = g.replace(/\[.*\]/, "")),
            (h = a.localAccess(g))
              ? ((l = $.extend(!0, {}, a.fits.options, b)),
                (l.file = g),
                (l.vfile = h),
                window.setTimeout(function () {
                  try {
                    a.handleFITSFile(g, l, a.NewFitsImage);
                  } catch (m) {
                    a.error("can't process FITS file", m);
                  }
                }, 0))
              : a.fetchURL(g, e, b)));
    }
  });
  a.mkPublic("LoadWindow", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e,
      f,
      g,
      h,
      l,
      m,
      k,
      q = a.lightOpts[a.LIGHTWIN];
    var u = a.parsePublicArgs(b);
    var p = function (b) {
      b = $.inArray(b, a.displays);
      0 <= b && a.displays.splice(b, 1);
    };
    var n = function (b, c, d) {
      var f;
      c = c || {};
      c.clone && (f = a.lookupDisplay(c.clone, !1));
      d &&
        ((l = d.match(/(.*width=)([0-9]+)(px,height=)([0-9]+)(px.*)/, "$1@@H@@$3")),
        (m = parseInt(l[2], 10)),
        (k = parseInt(l[4], 10)));
      var g = "<hr class='hline0'>";
      !f || (0 < $("#" + c.clone + "Menubar").length && !f.pluginInstances.JS9Menubar.isDynamic)
        ? (g += "<div class='JS9Menubar' id='" + b + "Menubar'></div>")
        : d && (k -= 40);
      g += "<div class='JS9' id='" + b + "'></div>";
      !f ||
      (0 < $("#" + c.clone + "Colorbar").length &&
        0 === $("#" + c.clone + "Statusbar").length &&
        !f.pluginInstances.JS9Colorbar.isDynamic)
        ? ((e =
            f && f.pluginInstances.JS9Colorbar
              ? "data-showTicks='" + f.pluginInstances.JS9Colorbar.showTicks + "'"
              : ""),
          (g +=
            "<div style='margin-top: 2px;'><div class='JS9Colorbar' id='" +
            b +
            "Colorbar' " +
            e +
            "></div></div>"),
          f &&
            f.pluginInstances.JS9Colorbar &&
            !f.pluginInstances.JS9Colorbar.showTicks &&
            (k -= 15))
        : d && (k -= 44);
      !f || (0 < $("#" + c.clone + "Statusbar").length && !f.pluginInstances.JS9Statusbar.isDynamic)
        ? (g += "<div class='JS9Statusbar' id='" + b + "Statusbar'></div>")
        : d && (k -= 40);
      return d
        ? (a.Dysel.retrievePlugins().length && ((m += 2), (k += 2)),
          { html: g, winopts: l[1] + String(m) + l[3] + String(k) + l[5] })
        : g;
    };
    var x = function (b, c) {
      var d = new a.Display(z);
      d.winid = B;
      a.helper.send("addDisplay", { display: z });
      a.instantiatePlugins();
      c.display = z;
      b && a.Load(b, c);
      return d;
    };
    var w = function (b) {
      var c;
      var d = 0;
      var e = [];
      for (c = 0; c < a.images.length; c++) ((d = a.images[c]), d.display.id === z && e.push(d));
      if (!e.length) return (p(b), !0);
      if ("move" === a.globalOpts.lightWinClose) {
        if (a.isNull(a.globalOpts.lightWinMoveTo) || a.globalOpts.lightWinMoveTo === z) d = 0;
        else
          for (d = c = 0; c < a.displays.length; c++)
            if (a.displays[c].id === a.globalOpts.lightWinMoveTo) {
              d++;
              break;
            }
        d || ((a.globalOpts.lightWinClose = "ask"), delete a.globalOpts.lightWinMoveTo);
      }
      switch (a.globalOpts.lightWinClose) {
        case "close":
          p(b);
          for (c = 0; c < e.length; c++)
            try {
              e[c].closeImage();
            } catch (J) {}
          return !0;
        case "move":
          p(b);
          for (c = 0; c < e.length; c++)
            try {
              e[c].moveToDisplay(a.globalOpts.lightWinMoveTo);
            } catch (J) {}
          return !0;
        default:
          return (
            (f = "lightCloseID" + a.uniqueID()),
            a.allinone
              ? ((g = "inline"), (h = a.allinone.lightCloseHTML))
              : ((g = "ajax"), (h = a.InstallDir(a.lightOpts.lcloseURL))),
            $(a.lightOpts[a.LIGHTWIN].topid).arrive(
              "#lightWinCloseForm",
              { onceOnly: !0 },
              function () {
                var b;
                var c = $("#lightWinCloseForm").find("#lightWinCloseSel");
                for (b = 0; b < a.displays.length; b++)
                  a.displays[b].id !== z &&
                    c.append($("<option>", { value: a.displays[b].id, text: a.displays[b].id }));
              }
            ),
            (y = a.lightWin(f, g, h, "Closing a light window", q.lcloseWin)),
            $(y).data("dispid", z),
            $(y).data("winid", B),
            !1
          );
      }
    };
    d = u.argv[0];
    var t = u.argv[1];
    var v = u.argv[2];
    b = u.argv[3];
    u = u.argv[4];
    t = t || {};
    if ("object" === typeof t) t = $.extend(!0, {}, t);
    else if ("string" === typeof t)
      try {
        t = JSON.parse(t);
      } catch (D) {
        t = {};
      }
    v = v || "light";
    var r = v + "win";
    switch (v) {
      case "light":
        if (t.id) {
          var z = t.id;
          delete t.id;
        } else z = r + a.uniqueID();
        var y = "d" + z;
        if (b) u = u || q.imageWin;
        else {
          var A = n(z, t, q.imageWin);
          b = A.html;
          u = u || A.winopts;
        }
        A = sprintf("JS9 Display" + a.IDFMT, z);
        var B = a.lightWin(y, "inline", b, A, u);
        var C = x(d, t);
        B.onclose = function () {
          return w(C);
        };
        return z;
      case "new":
        t.id ? ((z = t.id), delete t.id) : (z = r + a.uniqueID());
        u =
          u || "width=" + a.globalOpts.newWindowWidth + ", height=" + a.globalOpts.newWindowHeight;
        x = document.getElementsByTagName("head")[0].innerHTML;
        x = x.replace(/src=['"].*astroemw?\.js['"]/, "");
        x.match(/src=["'].*js9\.js/) ||
          x.match(/src=["'].*js9\.min\.js/) ||
          (x += '<script type="text/javascript" src="js9.min.js">\x3c/script>');
        n = b || n(z, t);
        b = "<html><head>" + x + "</head><body";
        d && (b += sprintf(" onload='JS9.Preload(\"%s\",%s);'", d, JSON.stringify(t)));
        b += ">" + n + "</body></html>\n";
        window.electron &&
          (A =
            "data:text/html,<html><body><script>window.addEventListener('message', (ev) => {document.documentElement.innerHTML=ev.data\x3c/script><p></body></html>");
        if ((A = window.open(A, z, u)))
          return (
            A.document
              ? (A.document.open(), A.document.write(b), A.document.close())
              : A.postMessage
                ? a.error("LoadWindow('new') is disabled on the Desktop for security reasons")
                : a.error("no method available for drawing image into window"),
            z
          );
        a.error("could not create window (check your pop-up blockers)");
    }
  });
  a.mkPublic("LoadProxy", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e,
      f,
      g = a.parsePublicArgs(b);
    var h = g.argv[0];
    var l = g.argv[1];
    a.globalOpts.loadProxy || a.error("proxy load not available for server");
    a.globalOpts.workDir || a.error("proxy load requires a temp workDir for server");
    h || a.error("no url specified for proxy load");
    h = h.trim();
    h.match(/dropbox\.com/)
      ? ((h = h.replace("www.dropbox.com", "dl.dropboxusercontent.com")),
        (h = h.replace("?dl=0", "") + "?raw=1"))
      : h.match(/drive\.google\.com/) &&
        (h = h.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/, "/uc?export=download&id=$1"));
    g.display && (f = a.lookupDisplay(g.display));
    l = l || {};
    if ("object" === typeof l) l = $.extend(!0, {}, l);
    else if ("string" === typeof l)
      try {
        l = JSON.parse(l);
      } catch (m) {
        l = {};
      }
    l.ofile ? ((b = l.ofile), delete l.ofile) : (b = "");
    a.waiting(!0, f);
    a.Send("loadproxy", { cmd: "js9Xeq loadproxy " + h + " " + b }, function (b) {
      b =
        "object" === typeof b
          ? b
          : 0 <= b.search(a.analOpts.epattern)
            ? { stderr: b }
            : { stdout: b };
      b.errcode = b.errcode || 0;
      b.stderr
        ? a.error(b.stderr)
        : b.stdout
          ? (b = b.stdout.split(/\s+/)) &&
            b[0] &&
            ((e = a.cleanPath(b[0])),
            (l.proxyFile = e),
            "/" !== e.charAt(0) && (e = a.InstallDir(e)),
            b[1] && ((b = a.cleanPath(b[1])), (l.parentFile = b), (l.proxyParent = b)),
            (l.fixpath = !1),
            (l.proxyURL = h),
            a.Load(e, l, { display: g.display }))
          : a.error("internal error: no return from load proxy command");
    });
  });
  a.mkPublic("Preload", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e;
    d = "";
    var f = null,
      g = null,
      h = b.length,
      l = a.globalOpts.alerts;
    var m = a.parsePublicArgs(b);
    var k = a.URLEXP,
      q = /\.ses$/,
      u = /\.cmap$/;
    var p = m.argv[0];
    a.globalOpts.loadProxy && a.helper.baseurl && (e = new RegExp("^" + a.helper.baseurl));
    m.display && ((g = { display: m.display }), --h);
    switch (h) {
      case 0:
        p =
          (null === a.helper.connected || a.helper.connected) &&
          a.fits.name &&
          0 < a.preloads.length
            ? 2
            : 3;
        break;
      case 1:
        p =
          "boolean" === typeof p
            ? p && 0 < a.preloads.length
              ? 2
              : 3
            : (null === a.helper.connected || a.helper.connected) && a.fits.name
              ? 1
              : 0;
        break;
      default:
        p = (null === a.helper.connected || a.helper.connected) && a.fits.name ? 1 : 0;
    }
    switch (p) {
      case 0:
        for (p = 0; p < h; p++)
          if (((m = p + 1), m < h && "object" === typeof b[m]))
            ((f = $.extend(!0, {}, b[m])), a.preloads.push([b[p], f, g]), p++);
          else if (m < h && b[m].startsWith("{")) {
            try {
              f = JSON.parse(b[m]);
            } catch (x) {
              f = null;
            }
            a.preloads.push([b[p], f, g]);
            p++;
          } else a.preloads.push([b[p], null, g]);
        break;
      case 1:
        a.globalOpts.alerts = !1;
        for (p = 0; p < h; p++) {
          var n =
            e && b[p].match(k) && !b[p].match(e)
              ? a.LoadProxy
              : b[p].match(q)
                ? a.LoadSession
                : b[p].match(u)
                  ? a.LoadColormap
                  : a.Load;
          m = p + 1;
          if (m < h && "object" === typeof b[m]) {
            (n !== a.Load && n !== a.LoadProxy) ||
              a.preloadwaiting.push({ id: a.cleanPath(b[p]), loaded: !1 });
            try {
              g ? n(b[p], b[m], g) : n(b[p], b[m]);
            } catch (x) {
              d = d + " " + b[p];
            }
            p++;
          } else if (m < h && b[m].startsWith("{")) {
            try {
              f = JSON.parse(b[m]);
            } catch (x) {
              f = null;
            }
            (n !== a.Load && n !== a.LoadProxy) ||
              a.preloadwaiting.push({ id: a.cleanPath(b[p]), loaded: !1 });
            try {
              g ? n(b[p], f, g) : n(b[p], f);
            } catch (x) {
              d = d + " " + b[p];
            }
            p++;
          } else {
            (n !== a.Load && n !== a.LoadProxy) ||
              a.preloadwaiting.push({ id: a.cleanPath(b[p]), loaded: !1 });
            try {
              g ? n(b[p], null, g) : n(b[p], null);
            } catch (x) {
              d = d + " " + b[p];
            }
          }
        }
        a.globalOpts.alerts = l;
        d && a.error("could not preload image(s): " + d);
        break;
      case 2:
        a.globalOpts.alerts = !1;
        for (p = 0; p < a.preloads.length; p++) {
          n =
            e && a.preloads[p][0].match(k) && !a.preloads[p][0].match(e)
              ? a.LoadProxy
              : a.preloads[p][0].match(q)
                ? a.LoadSession
                : a.preloads[p][0].match(u)
                  ? a.LoadColormap
                  : a.Load;
          (n !== a.Load && n !== a.LoadProxy) ||
            a.preloadwaiting.push({ id: a.cleanPath(a.cleanPath(a.preloads[p][0])), loaded: !1 });
          try {
            a.preloads[p][2]
              ? n(a.preloads[p][0], a.preloads[p][1], a.preloads[p][2])
              : n(a.preloads[p][0], a.preloads[p][1]);
          } catch (x) {
            d = d + " " + a.preloads[p][0];
          }
        }
        a.globalOpts.alerts = l;
        d && a.error("could not preload image(s): " + d);
        a.preloads = [];
    }
  });
  a.mkPublic("RefreshImage", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b),
      f = a.getImage(e.display),
      g = function (a) {
        f.refreshImage(a, h);
      };
    d = e.argv[0];
    var h = e.argv[1] || {};
    if (f)
      if (((h.id = f.id), d instanceof Blob)) {
        (h.rawid && h.rawid !== f.raw.id) || a.cleanupFITSFile(f.raw, !0);
        try {
          a.handleFITSFile(d, a.fits.options, g);
        } catch (l) {
          a.error("can't refresh FITS file", l);
        }
      } else f.refreshImage(d, h);
    else d instanceof Blob && a.Load.apply(a, $jscomp.arrayFromIterable(b));
  });
  a.mkPublic("GetStatus", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    d = a.getImage(b.argv[1] || b.display);
    var e = b.argv[0] || "load";
    return b.argv.length
      ? a.fetchURL.status && e.match(/^(pre)?load$/i)
        ? a.fetchURL.status
        : d
          ? d.getStatus(e)
          : "none"
      : "Load CreateMosaic DisplaySection LoadCatalog LoadRegions ReprojectData RotateData RunAnalysis".split(
          " "
        );
  });
  a.mkPublic("GetLoadStatus", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    return a.GetStatus.apply(a, ["load"].concat($jscomp.arrayFromIterable(b)));
  });
  a.mkPublic("CopyToClipboard", function (c, b) {
    var d,
      e = $(document).scrollLeft(),
      f = $(document).scrollTop();
    a.clipboard = c;
    var g = document.createElement("textarea");
    g.style.position = "fixed";
    g.style.top = 0;
    g.style.left = 0;
    g.style.width = "2em";
    g.style.height = "2em";
    g.style.padding = 0;
    g.style.border = "none";
    g.style.outline = "none";
    g.style.boxShadow = "none";
    g.style.background = "transparent";
    g.value = c;
    document.body.appendChild(g);
    g.select();
    try {
      if ((d = document.execCommand("copy"))) var h = "OK";
      else
        ((h = "MANUAL"),
          a.BROWSER[2].match(/Mac/)
            ? window.prompt("copy to clipboard: Cmd+C", c)
            : window.prompt("copy to clipboard: Ctrl+C", c));
    } catch (l) {
      h = "ERROR";
    }
    document.body.removeChild(g);
    b && b.display && (b.display.displayConjq.focus(), window.scrollTo(e, f));
    return h;
  });
  a.mkPublic("CopyFromClipboard", function () {
    return a.clipboard || "";
  });
  a.mkPublic("OpenFileMenu", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    (b = a.lookupDisplay(b.display)) && $("#openLocalLoad-" + b.id).click();
  });
  a.mkPublic("OpenRegionsMenu", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    (b = a.lookupDisplay(b.display)) && $("#openLocalLoadRegions-" + b.id).click();
  });
  a.mkPublic("OpenSessionMenu", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    (b = a.lookupDisplay(b.display)) && $("#openLocalLoadSession-" + b.id).click();
  });
  a.mkPublic("OpenCatalogsMenu", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    (b = a.lookupDisplay(b.display)) && $("#openLocalLoadCatalog-" + b.id).click();
  });
  a.mkPublic("OpenColormapMenu", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    (b = a.lookupDisplay(b.display)) && $("#openLocalLoadColormap-" + b.id).click();
  });
  a.mkPublic("SaveColormap", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    var f = function (a) {
        var b = a;
        if ("string" === typeof a)
          try {
            b = JSON.parse(a);
          } catch (q) {}
        return b;
      },
      g = function (b) {
        var c,
          d,
          e = [];
        for (c = 0; c < b.length; c++)
          if ((d = a.lookupColormap(b[c]))) ((d = $.extend(!0, {}, d)), delete d.type, e.push(d));
        return 1 === e.length ? e[0] : e;
      };
    b = e.argv[0];
    d = e.argv[1];
    if (Object.prototype.hasOwnProperty.call(window, "saveAs")) {
      if ((e = a.getImage(e.display))) {
        b = f(b);
        d = f(d);
        if (b)
          "string" === typeof b
            ? ((h = b),
              "string" === typeof d
                ? (l = g([d]))
                : $.isArray(d)
                  ? (l = g(d))
                  : ((l = $.extend(!0, {}, e.cmapObj)), delete l.type))
            : $.isArray(b) && ((h = "js9.cmap"), (l = g(b)));
        else {
          var h = "js9.cmap";
          var l = $.extend(!0, {}, e.cmapObj);
          delete l.type;
        }
        l = JSON.stringify(l);
        l = new Blob([l], { type: "text/plain" });
        a.saveAs(l, h);
      }
    } else a.error("no saveAs() available to save colormap");
    return h;
  });
  a.mkPublic("NewFitsImage", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    b = e.argv[0];
    d = e.argv[1] || {};
    e = a.lookupDisplay(e.display || d.display || a.DEFID);
    if (d.refresh) {
      if ("object" === typeof d.refresh) var f = d.refresh;
      else e && e.image && (f = e.image);
      if (f) (d.onload && ((d.onrefresh = d.onload), delete d.onload), f.refreshImage(b, d));
      else {
        if (d.onload) var g = d.onload;
        a.checkNew(new a.Image(b, d, g));
      }
    } else (d.onload && (g = d.onload), a.checkNew(new a.Image(b, d, g)));
  });
  a.mkPublic("GetImage", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    d = b.argv[0];
    "string" !== typeof d && (d = b.display);
    return a.getImage(d);
  });
  a.mkPublic("GetImageData", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = a.parsePublicArgs(b);
    b = a.getImage(d.display);
    d = d.argv[0];
    return b ? b.getImageData(d) : null;
  });
  a.mkPublic("GetDisplayData", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = [];
    var e = a.parsePublicArgs(b);
    b = e.display || a.displays[0].id;
    var f = e.argv[0];
    for (e = 0; e < a.images.length; e++) {
      var g = a.images[e];
      g.display.id === b && d.push(g.getImageData(f));
    }
    return d;
  });
  a.mkPublic("GetFITSHeader", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = "";
    var e = a.parsePublicArgs(b);
    b = a.getImage(e.display);
    e = e.argv[0];
    b && b.raw && (d = a.raw2FITS(b.raw, { addcr: e }));
    return d;
  });
  a.mkPublic("BlendDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = [];
    var e = a.parsePublicArgs(b);
    b = e.display || a.DEFID;
    var f = a.lookupDisplay(b);
    e = e.argv[0];
    f || a.error("no JS9 display found: " + b);
    if (void 0 === e || "mode" === e) return f.blendMode;
    if ("list" === e) {
      for (e = 0; e < a.images.length; e++) {
        var g = a.images[e];
        g.display.id === b && g.blend.active && d.push(g.id);
      }
      return d;
    }
    if ("reset" === e) {
      for (e = 0; e < a.images.length; e++)
        ((g = a.images[e]), g.display.id === b && g.blend.active && g.blendImage(!1));
      e = !1;
    }
    "true" === e ? (e = !0) : "false" === e && (e = !1);
    f.blendMode = !!e;
    f.image && (f.image.xeqPlugins("image", "ondisplayblend"), f.image.displayImage());
    return f.blendMode;
  });
  a.mkPublic("LoadAuxFile", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    d = a.getImage(e.display);
    b = e.argv[0];
    e = e.argv[1];
    d ? d.loadAuxFile(b, e) : a.error("could not find image for aux file: " + b);
  });
  a.mkPublic("SubmitAnalysis", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e, f;
    var g = a.lightOpts[a.LIGHTWIN];
    var h = a.parsePublicArgs(b);
    var l = h.argv[0];
    b = h.argv[1];
    d = h.argv[2];
    b
      ? (g = a.lookupDisplay(h.display).id)
      : ((g = $(l).closest(g.top)), (b = g.data("aname")), (g = g.data("dispid")));
    b ? g && (e = a.getImage(g)) : (f = "internal error: could not find analysis task name");
    if (e) {
      l = $(l).closest("form");
      try {
        var m = l.serializeArray();
        m = m.concat(
          $("#" + l.attr("id") + " input[type=checkbox]:not(:checked)")
            .map(function () {
              return { name: this.name, value: "false" };
            })
            .get()
        );
      } catch (k) {
        m = null;
      }
      e.runAnalysis(b, m, d);
    } else f = "internal error: could not find image";
    f && a.error(f);
    return !1;
  });
  a.mkPublic("Send", function (c, b, d) {
    a.helper.connected ? a.helper.send(c, b, d) : a.error("no JS9 helper available");
  });
  a.mkPublic("EventToDisplayPos", function (c) {
    return a.eventToDisplayPos(c);
  });
  a.mkPublic("PixToWCS", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = 1;
    var e = a.parsePublicArgs(b);
    if ((b = a.getImage(e.display))) {
      var f = e.argv[0];
      if ("object" === typeof f && a.notNull(f.x) && a.notNull(f.y)) {
        var g = f.x;
        f = f.y;
      } else ((g = e.argv[0]), (f = e.argv[1]));
      (a.isNumber(g) && a.isNumber(f)) || a.error("invalid input for PixToWCS");
      if (b.validWCS())
        return (
          (g = a.pix2wcs(b.raw.wcs, g, f).trim()),
          (f = g.split(/ +/)),
          "sexagesimal" === b.params.wcsunits &&
            "galactic" !== b.params.wcssys &&
            "ecliptic" !== b.params.wcssys &&
            (d = 15),
          { ra: a.saostrtod(f[0]) * d, dec: a.saostrtod(f[1]), sys: f[2], str: g }
        );
    }
  });
  a.Pix2WCS = a.PixToWCS;
  a.mkPublic("WCSToPix", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    if ((d = a.getImage(e.display))) {
      var f = e.argv[0];
      "object" === typeof f && a.notNull(f.ra) && a.notNull(f.dec)
        ? ((b = f.ra), (f = f.dec))
        : ((b = e.argv[0]), (f = e.argv[1]));
      (a.isNumber(b) && a.isNumber(f)) || a.error("invalid input for WCSToPix");
      if (d.validWCS())
        return (
          (d = a.wcs2pix(d.raw.wcs, b, f).trim().split(/ +/)),
          (b = parseFloat(d[0])),
          (f = parseFloat(d[1])),
          (d = sprintf("%f %f", b, f)),
          { x: b, y: f, str: d }
        );
    }
    return null;
  });
  a.WCS2Pix = a.WCSToPix;
  a.mkPublic("NewShapeLayer", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    d = a.getImage(e.display);
    b = e.argv[0];
    e = e.argv[1];
    return d ? d.display.newShapeLayer(b, e) : null;
  });
  a.mkPublic("AddRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    d = a.getImage(e.display);
    b = e.argv[0];
    e = e.argv[1];
    return d
      ? (b || a.error("no region specified for AddRegions"), d.addShapes("regions", b, e))
      : null;
  });
  a.mkPublic("RemoveRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = a.parsePublicArgs(b);
    b = a.getImage(d.display);
    d = d.argv[0];
    return b
      ? (b.removeShapes("regions", d),
        b.display.clearMessage("regions"),
        a.globalOpts.quietReturn ? "" : "OK")
      : null;
  });
  a.mkPublic("CopyRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    b = a.getImage(e.display);
    d = e.argv[0];
    e = e.argv[1];
    return b ? (b.copyRegions(d, e), a.globalOpts.quietReturn ? "" : "OK") : null;
  });
  a.mkPublic("GetRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    return (d = a.getImage(b.display))
      ? (b.argv.unshift("regions"), d.getShapes.apply(d, $jscomp.arrayFromIterable(b.argv)))
      : null;
  });
  a.mkPublic("ListRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    return (d = a.getImage(e.display))
      ? ((b = e.argv[0] || "all"), (e = e.argv[1] || { mode: 2 }), d.listRegions(b, e, e.layer))
      : null;
  });
  a.mkPublic("ListGroups", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    return (d = a.getImage(e.display))
      ? ((b = e.argv[0] || "all"), (e = e.argv[1] || {}), d.listGroups(b, e, e.layer))
      : null;
  });
  a.mkPublic("EditRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    if ((b = a.getImage(b.display)))
      if ((d = b.layers.regions))
        (d = d.canvas.getActiveObject()) && "activeSelection" !== d.type
          ? b.displayRegionsForm(d)
          : b.displayRegionsForm(null, { multi: !0 });
    return null;
  });
  a.mkPublic("ChangeRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    b = a.getImage(e.display);
    d = e.argv[0];
    e = e.argv[1];
    b && b.changeShapes("regions", d, e);
    return null;
  });
  a.mkPublic("SaveRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    d = a.getImage(b.display);
    var e = b.argv[0],
      f = b.argv[1],
      g = b.argv[2];
    if (d)
      if (1 === b.argv.length && "dialogbox" === e) d.displayRegionsForm(null, { type: "save" });
      else return d.saveRegions(e, f, g);
    return null;
  });
  a.mkPublic("SelectRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    d = a.getImage(e.display);
    b = e.argv[0];
    e = e.argv[1];
    return d ? d.selectShapes("regions", b, e) : null;
  });
  a.mkPublic("UnselectRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    d = a.getImage(e.display);
    b = e.argv[0];
    e = e.argv[1];
    return d ? d.unselectShapes("regions", b, e) : null;
  });
  a.mkPublic("GroupRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    d = a.getImage(e.display);
    b = e.argv[0];
    e = e.argv[1];
    return d ? d.groupShapes("regions", b, e) : null;
  });
  a.mkPublic("UngroupRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    d = a.getImage(e.display);
    b = e.argv[0];
    e = e.argv[1];
    return d ? d.ungroupShapes("regions", b, e) : null;
  });
  a.mkPublic("ChangeRegionTags", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    b = a.getImage(e.display);
    d = e.argv[0];
    var f = e.argv[1];
    e = e.argv[2];
    return b ? b.changeRegionTags(d, f, e) : null;
  });
  a.mkPublic("ToggleRegionTags", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    b = a.getImage(e.display);
    d = e.argv[0];
    var f = e.argv[1];
    e = e.argv[2];
    return b ? b.toggleRegionTags(d, f, e) : null;
  });
  a.mkPublic("UnremoveRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    return (b = a.getImage(b.display)) ? b.unremoveRegions() : null;
  });
  a.mkPublic("LoadRegions", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = a.parsePublicArgs(b);
    var e = a.getImage(d.display),
      f = function (a, b) {
        b && void 0 !== b.display && delete b.display;
        e.addShapes("regions", a, b);
        e.setStatus("loadRegions", "complete");
        if (g && g.onload) g.onload(e);
      };
    b = d.argv[0];
    var g = d.argv[1];
    b || a.error("JS9.LoadRegions: no file specified for regions load");
    if (e) {
      e.setStatus("loadRegions", "processing");
      g = g || {};
      if ("object" === typeof g) g = $.extend(!0, {}, g);
      else if ("string" === typeof g)
        try {
          g = JSON.parse(g);
        } catch (h) {
          g = {};
        }
      if ("object" === typeof b) {
        if ((d = b.path || b.name)) g.file = d.split("/").reverse()[0];
        d = new FileReader();
        d.onload = function (a) {
          f(a.target.result, g);
        };
        d.readAsText(b);
      } else
        "string" === typeof b
          ? ((g.responseType = "text"),
            (b = a.fixPath(b, g)),
            (g.file = b.split("/").reverse()[0]),
            a.fetchURL(null, b, g, f))
          : a.error("unknown file type for LoadRegions: " + typeof b);
    }
  });
  a.mkPublic("InstallDir", function (c) {
    return c ? a.cleanPath(a.INSTALLDIR + c) : "";
  });
  a.mkPublic("AddDivs", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e,
      f = a.parsePublicArgs(b);
    for (b = 0; b < f.argv.length; b++)
      if ((e = f.argv[b]))
        if (0 === $("#" + e).length)
          a.DEBUG && a.log("warning: can't find div, skipping AddDivs(): %s", e);
        else {
          for (d = 0; d < a.displays.length; d++) {
            var g = a.displays[d];
            if (g.id === e) {
              var h = !0;
              break;
            }
          }
          h
            ? a.DEBUG && a.log("warning: div already added, skipping AddDivs(): %s", e)
            : (a.checkNew(new a.Display(e)), a.helper.send("addDisplay", { display: e }));
        }
    a.instantiatePlugins();
  });
  a.mkPublic("InstantiatePlugins", function () {
    a.instantiatePlugins();
  });
  a.mkPublic("ResizeDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = a.parsePublicArgs(b);
    "string" !== typeof d.argv[0] ||
    a.isNumber(d.argv[0]) ||
    "full" === d.argv[0] ||
    "reset" === d.argv[0] ||
    "image" === d.argv[0]
      ? (b = a.lookupDisplay(d.display))
      : ((b = a.lookupDisplay(d.argv[0] || d.display)), d.argv.splice(0, 1));
    b || a.error("invalid display for resize");
    d = b.resize.apply(b, $jscomp.arrayFromIterable(d.argv));
    return d === b ? (a.globalOpts.quietReturn ? "" : "OK") : d;
  });
  a.mkPublic("SelectDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    (b = a.lookupDisplay(b.argv[0] || b.display)) || a.error("invalid display for select");
    Object.prototype.hasOwnProperty.call(a, "Menubar") ||
      a.error("Menubar is required for display selection");
    a.Menubar.onclick(b);
  });
  a.mkPublic("GatherDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = a.parsePublicArgs(b);
    switch (d.argv.length) {
      case 0:
        b = d.display;
        var e = null;
        break;
      case 1:
        "object" === typeof d.argv[0] ||
        ("string" === typeof d.argv[0] && "{" === d.argv[0].charAt(0))
          ? ((b = d.display), (e = d.argv[0]))
          : (b = d.argv[0] || d.display);
        break;
      default:
        ((b = d.argv[0] || d.display), (e = d.argv[1]));
    }
    (b = a.lookupDisplay(b)) || a.error("invalid display for gather");
    b.gather(e);
  });
  a.mkPublic("SeparateDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = a.parsePublicArgs(b);
    switch (d.argv.length) {
      case 0:
        b = d.display;
        var e = null;
        break;
      case 1:
        "object" === typeof d.argv[0] ||
        ("string" === typeof d.argv[0] && "{" === d.argv[0].charAt(0))
          ? ((b = d.display), (e = d.argv[0]))
          : (b = d.argv[0] || d.display);
        break;
      default:
        ((b = d.argv[0] || d.display), (e = d.argv[1]));
    }
    (b = a.lookupDisplay(b)) || a.error("invalid display for separate");
    b.separate(b, e);
  });
  a.mkPublic("CenterDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    (b = a.lookupDisplay(b.argv[0] || b.display)) || a.error("invalid display for center");
    b.center();
  });
  a.mkPublic("RemoveDisplay", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    var e = a.lookupDisplay(b.argv[0] || b.display);
    e || a.error("invalid display for remove");
    b = $.inArray(e, a.displays);
    if (0 <= b) {
      d = e.divjq.closest(".JS9GridContainer");
      var f = e.divjq.closest(".JS9GridItem");
      0 < d.length && 0 < f.length
        ? 1 < d.find(".JS9GridItem").length
          ? (a.CloseDisplay(e.id), f.remove(), a.displays.splice(b, 1))
          : a.error("can't remove last display in grid: " + e.id)
        : e.winid && e.winid.close
          ? (a.CloseDisplay(e.id), e.winid.close())
          : a.error("can only remove displays within a grid or lightwins");
    } else a.error("can't find display in display list: " + e.id);
  });
  a.mkPublic("SaveSession", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    d = {};
    var e = a.parsePublicArgs(b);
    b = e.argv[0];
    var f = e.argv[1];
    if ("object" === typeof b) d = $.extend(!0, {}, b);
    else if ("string" === typeof b)
      try {
        d = JSON.parse(b);
      } catch (h) {
        var g = b;
        if (f)
          if ("object" === typeof f) d = $.extend(!0, {}, f);
          else
            try {
              d = JSON.parse(f);
            } catch (l) {
              d = {};
            }
      }
    d.mode || (d.mode = "display");
    b = a.lookupDisplay(
      e.display
        ? e.display
        : d.display
          ? d.display
          : 0 < a.displays.length
            ? a.displays[0].id
            : a.DEFID
    );
    if (!b.image) return null;
    g ||
      (g =
        "display" === d.mode
          ? "js9-" + new Date().toISOString().slice(0, 10) + ".ses"
          : b.image.id + ".ses");
    return b.image.saveSession(g, d);
  });
  a.mkPublic("LoadSession", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    var e = b.argv[0];
    var f = b.argv[1];
    e || a.error("JS9.LoadSession: no file specified for load");
    f = f || {};
    if ("object" === typeof f) f = $.extend(!0, {}, f);
    else if ("string" === typeof f)
      try {
        f = JSON.parse(f);
      } catch (h) {
        f = {};
      }
    var g = a.lookupDisplay(
      b.display
        ? b.display
        : f.display
          ? f.display
          : 0 < a.displays.length
            ? a.displays[0].id
            : a.DEFID
    );
    f.display = g.id;
    "object" === typeof e
      ? ((b = new FileReader()),
        (b.onload = function (b) {
          b = JSON.parse(b.target.result);
          f.sessionPath = a.dirname(e.path || e.name || "");
          g.loadSession(b, f);
        }),
        b.readAsText(e))
      : "string" === typeof e
        ? ((f.responseType = "text"),
          (f.display = g.id),
          (e = a.fixPath(e, f)),
          a.fetchURL(null, e, f, function (b, c) {
            b = JSON.parse(b);
            c.sessionPath = a.dirname(e);
            g.loadSession(b, c);
          }))
        : a.error("unknown file type for LoadSession: " + typeof e);
  });
  a.mkPublic("SaveCatalog", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    b = a.getImage(e.display);
    d = e.argv[0];
    e = e.argv[1];
    if (b) return b.saveCatalog(d, e);
  });
  a.mkPublic("LoadCatalog", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e;
    b = a.parsePublicArgs(b);
    var f = b.argv[0];
    var g = b.argv[1];
    var h = b.argv[2];
    f instanceof Blob && ((h = g), (g = f), (f = null));
    g || a.error("JS9.LoadCatalog: no file specified for catalog load");
    if ((e = a.getImage(b.display))) {
      e.setStatus("loadCatalog", "processing");
      h = h || {};
      if ("object" === typeof h) h = $.extend(!0, {}, h);
      else if ("string" === typeof h)
        try {
          h = JSON.parse(h);
        } catch (l) {
          h = {};
        }
      if (g instanceof Blob)
        ((b = new FileReader()),
          (b.onload = function (a) {
            !f && g.name && (f = g.name.replace(/\.[^.]*$/, ""));
            e.loadCatalog(f, a.target.result, h);
            e.setStatus("loadCatalog", "complete");
            if (h && h.onload) h.onload(e);
          }),
          b.readAsText(g));
      else if ("string" === typeof g)
        if (g.match(/\t/)) {
          if ((e.loadCatalog(f, g, h), e.setStatus("loadCatalog", "complete"), h && h.onload))
            h.onload(e);
        } else
          ((h.responseType = "text"),
            (g = a.fixPath(g, h)),
            a.fetchURL(null, g, h, function (a) {
              e.loadCatalog(f, a, h);
              e.setStatus("loadCatalog", "complete");
              if (h && h.onload) h.onload(e);
            }));
      else a.error("unknown file type for LoadCatalog: " + typeof g);
    }
  });
  a.mkPublic("CreateMosaic", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    b = a.lookupDisplay(e.display);
    d = e.argv[0];
    e = e.argv[1];
    if (b) return b.createMosaic(d, e);
  });
  a.mkPublic("DisplayPlugin", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    d = a.lookupDisplay(e.display);
    b = e.argv[0];
    if (d && e.argv[0]) {
      var f = b.toLowerCase();
      for (e = 0; e < a.plugins.length; e++) {
        var g = a.plugins[e];
        var h = g.name;
        if (h === b || h.toLowerCase().substr(-f.length) === f) {
          d.displayPlugin(g);
          return;
        }
      }
      a.error("can't find plugin: " + b);
    }
  });
  a.mkPublic("DisplayHelp", function (c) {
    var b,
      d = a.lightOpts[a.LIGHTWIN].textWin;
    if (c) {
      var e = c.split("/").reverse()[0];
      var f = "help_" + a.uniqueID();
      (b = a.helpOpts[c])
        ? ((c = a.InstallDir(b.type + "/" + b.url)), a.lightWin(f, "iframe", c, b.title || e, d))
        : a.lightWin(f, "iframe", c, e, d);
    }
  });
  a.mkPublic("LightWindow", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    var e = a.parsePublicArgs(b);
    b = e.argv[0] || "lightWindow" + a.uniqueID();
    d = e.argv[1] || "inline";
    var f = e.argv[2],
      g = e.argv[3] || "JS9 light window";
    e = e.argv[4] || a.lightOpts[a.LIGHTWIN].textWin;
    f || a.error("no content specified for LightWindow");
    return a.lightWin(b, d, f, g, e);
  });
  a.mkPublic("WindowPrint", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    var e = { cmd: "print" };
    window.electron
      ? (b.argv[0] && (e.opts = b.argv[0]),
        window.setTimeout(function () {
          try {
            window.electron.sendMsg(e);
          } catch (f) {
            a.error("could not print window", f);
          }
        }, a.TIMEOUT))
      : a.error("WindowPrint is only available for the JS9 desktop app");
  });
  a.mkPublic("WindowToPDF", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    var e = { cmd: "pdf" };
    window.electron
      ? ((e.file = b.argv[0] || "js9.pdf"),
        b.argv[1] && (e.opts = b.argv[1]),
        window.setTimeout(function () {
          try {
            window.electron.sendMsg(e);
          } catch (f) {
            a.error("could not create window pdf", f);
          }
        }, a.TIMEOUT))
      : a.error("WindowToPDF is only available for the JS9 desktop app");
  });
  a.mkPublic("SaveScript", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    var e = { cmd: "script" };
    window.electron && window.electron.app
      ? ((e.file = b.argv[0] || ""),
        window.setTimeout(function () {
          try {
            window.electron.sendMsg(e);
          } catch (f) {
            a.error("could not create messaging script", f);
          }
        }, a.TIMEOUT))
      : a.error("SaveScript is only available for the JS9 desktop app");
  });
  a.mkPublic("SaveDir", function (c) {
    for (var b = [], d = 0; d < arguments.length; ++d) b[d - 0] = arguments[d];
    b = a.parsePublicArgs(b);
    var e = { cmd: "savedir" };
    window.electron
      ? (void 0 !== b.argv[0]
          ? ((e.dirname = b.argv[0]), b.argv[1] && (e.opts = b.argv[1]))
          : a.error("SaveDir requires a directory name"),
        window.setTimeout(function () {
          try {
            window.electron.sendMsg(e);
          } catch (f) {
            a.error("could not set save directory", f);
          }
        }, a.TIMEOUT))
      : a.error("SaveDir is only available for the JS9 desktop app");
  });
  a.init = function () {
    (window.HTMLCanvasElement && JSON) ||
      a.error(
        "your browser does not support JS9 (no HTML5 canvas and/or JSON). Please try a modern version of Firefox, Chrome, Safari, Opera, or Edge."
      );
    Object.prototype.hasOwnProperty.call(window, "JS9Prefs") &&
      "object" === typeof JS9Prefs &&
      JS9Prefs.globalOpts &&
      JS9Prefs.globalOpts.installDir &&
      (a.INSTALLDIR = JS9Prefs.globalOpts.installDir);
    if (!a.INSTALLDIR) {
      try {
        $('link[href$="js9.css"]').each(function (b, c) {
          (b = $(c).attr("href")) &&
            "js9.css" === b.split("/").reverse()[0] &&
            (a.INSTALLDIR = b.replace(/js9\.css$/, ""));
        });
      } catch (h) {
        a.INSTALLDIR = "";
      }
      a.INSTALLDIR && (a.INSTALLDIR = a.cleanPath(a.INSTALLDIR));
    }
    a.INSTALLDIR && "/" !== a.INSTALLDIR.slice(-1) && (a.INSTALLDIR += "/");
    a.TOROOT = a.INSTALLDIR.replace(/([^/.])+/g, "..");
    Object.prototype.hasOwnProperty.call(window, "JS9Inline") &&
      "object" === typeof JS9Inline &&
      (a.inline = $.extend(!0, {}, JS9Inline));
    "dhtml" === a.LIGHTWIN &&
      ($("<div>")
        .attr("id", "dhtmlwindowholder")
        .appendTo($(document.body))
        .append("<span style='display:none'>.</span>"),
      (dhtmlwindow.imagefiles = a.inline
        ? [
            a.inline["images/min.gif"],
            a.inline["images/close.gif"],
            a.inline["images/restore.gif"],
            a.inline["images/resize.gif"],
          ]
        : a.allinone
          ? [a.allinone.min, a.allinone.close, a.allinone.restore, a.allinone.resize]
          : [
              a.InstallDir("images/min.gif"),
              a.InstallDir("images/close.gif"),
              a.InstallDir("images/restore.gif"),
              a.InstallDir("images/resize.gif"),
            ]),
      Object.prototype.hasOwnProperty.call(window, "Jupyter") &&
        $(a.lightOpts[a.LIGHTWIN].topid).arrive("input", function (b) {
          a.jupyterFocus($(b).parent());
        }));
    a.globalOpts.plotLibrary = a.globalOpts.plotLibrary || "flot";
    "plotly" !== a.globalOpts.plotLibrary ||
      Object.prototype.hasOwnProperty.call(window, "Plotly") ||
      (a.globalOpts.plotLibrary = "flot");
    Object.prototype.hasOwnProperty.call(window, "JS9Prefs") && "object" === typeof JS9Prefs
      ? a.mergePrefs(JS9Prefs)
      : a.PREFSFILE && (a.loadPrefs(a.InstallDir(a.PREFSFILE), 0), a.loadPrefs(a.PREFSFILE, 0));
    Object.prototype.hasOwnProperty.call(a, "Regions") &&
      $.extend(!0, a.Regions.opts, a.regionOpts);
    delete a.regionOpts;
    Object.prototype.hasOwnProperty.call(a, "Catalogs") &&
      $.extend(!0, a.Catalogs.opts, a.catalogOpts);
    delete a.catalogOpts;
    Object.prototype.hasOwnProperty.call(a, "Crosshair") &&
      $.extend(!0, a.Crosshair.opts, a.crosshairOpts);
    delete a.crosshairOpts;
    Object.prototype.hasOwnProperty.call(a, "Grid") && $.extend(!0, a.Grid.opts, a.gridOpts);
    delete a.gridOpts;
    Object.prototype.hasOwnProperty.call(a, "Module") && $.extend(!0, Module, a.emscriptenOpts);
    delete a.emscriptenOpts;
    if (Object.prototype.hasOwnProperty.call(a, "Fabric"))
      for (b in ($.extend(!0, a.Fabric.opts, a.fabricOpts), a.Fabric.opts))
        Object.prototype.hasOwnProperty.call(a.Fabric.opts, b) &&
          (fabric.Object.prototype[b] = a.Fabric.opts[b]);
    delete a.fabricOpts;
    a.globalOpts.resize || (a.globalOpts.resizeHandle = !1);
    void 0 !== a.analOpts.prependJS9Dir &&
      ((a.globalOpts.prependJS9Dir = a.analOpts.prependJS9Dir), delete a.analOpts.prependJS9Dir);
    void 0 !== a.analOpts.dataDir &&
      ((a.globalOpts.dataDir = a.analOpts.dataDir), delete a.analOpts.dataDir);
    void 0 !== a.globalOpts.regionsToClipboard &&
      void 0 === a.globalOpts.regToClipboard &&
      ((a.globalOpts.regToClipboard = a.globalOpts.regionsToClipboard),
      delete a.globalOpts.regionsToClipboard);
    void 0 !== a.globalOpts.regionDisplay &&
      void 0 === a.globalOpts.regDisplay &&
      ((a.globalOpts.regDisplay = a.globalOpts.regionDisplay), delete a.globalOpts.regionDisplay);
    void 0 !== a.globalOpts.regionConfigSize &&
      void 0 === a.globalOpts.regConfigSize &&
      ((a.globalOpts.regConfigSize = a.globalOpts.regionConfigSize),
      delete a.globalOpts.regionConfigSize);
    void 0 !== a.globalOpts.regionTemplates &&
      void 0 === a.globalOpts.regTemplates &&
      ((a.globalOpts.regTemplates = a.globalOpts.regionTemplates),
      delete a.globalOpts.regionTemplates);
    a.BROWSER[3] && (a.globalOpts.resizeHandle = !1);
    if (Object.prototype.hasOwnProperty.call(window, "localStorage") && a.globalOpts.localStorage) {
      try {
        var c = localStorage.getItem("globals");
      } catch (h) {
        c = null;
      }
      if (c) {
        try {
          a.userOpts.displays = JSON.parse(c);
        } catch (h) {}
        a.userOpts.displays && $.extend(!0, a.globalOpts, a.userOpts.displays);
      }
      try {
        c = localStorage.getItem("images");
      } catch (h) {
        c = null;
      }
      if (c) {
        try {
          a.userOpts.images = JSON.parse(c);
        } catch (h) {}
        a.userOpts.images && $.extend(!0, a.imageOpts, a.userOpts.images);
      }
      try {
        c = localStorage.getItem("fits");
      } catch (h) {
        c = null;
      }
      if (c)
        try {
          a.userOpts.fits = JSON.parse(c);
        } catch (h) {}
      try {
        c = localStorage.getItem("regions");
      } catch (h) {
        c = null;
      }
      if (c) {
        try {
          a.userOpts.regions = JSON.parse(c);
        } catch (h) {}
        a.userOpts.regions && $.extend(!0, a.Regions.opts, a.userOpts.regions);
      }
      try {
        c = localStorage.getItem("grid");
      } catch (h) {
        c = null;
      }
      if (c) {
        try {
          a.userOpts.images = JSON.parse(c);
        } catch (h) {}
        a.userOpts.images && $.extend(!0, a.Grid.opts, a.userOpts.images);
      }
      try {
        c = localStorage.getItem("catalog");
      } catch (h) {
        c = null;
      }
      if (c) {
        try {
          a.userOpts.images = JSON.parse(c);
        } catch (h) {}
        a.userOpts.images && $.extend(!0, a.Catalogs.Opts, a.userOpts.images);
      }
    }
    a.DEBUG = a.DEBUG || a.globalOpts.debug || 0;
    $("div.JS9").each(function (b, c) {
      a.checkNew(new a.Display($(c)));
    });
    if (window.Worker && !a.allinone)
      try {
        a.worker = new a.WebWorker(a.InstallDir(a.WORKERFILE));
      } catch (h) {}
    a.allinone ? a.initFITS() : a.initEmscripten();
    window.electron && (a.globalOpts.helperType = "nodejs");
    a.helper = new a.Helper();
    window.addEventListener(
      "message",
      function (b) {
        var c = b.origin || b.originalEvent.origin;
        b = b.data;
        "null" === c && (c = "unknown");
        if (a.globalOpts.postMessage) {
          if ("string" === typeof b)
            try {
              var d = JSON.parse(b);
            } catch (k) {
              a.error("can't parse msg: " + b, k);
            }
          else "object" === typeof b ? (d = b) : a.error("invalid msg from postMessage");
          a.msgHandler(d, function (a, b, c, e) {
            e = e || {};
            parent.postMessage(
              {
                cmd: d.cmd,
                res: { name: e.name, rtype: e.rtype, rdata: a, stdout: a, stderr: b, errcode: c },
              },
              "*"
            );
          });
        } else
          a.DEBUG &&
            ((c = "JS9 ignoring postMessage, origin: " + c),
            (c =
              "string" === typeof b
                ? c + (" data: " + b)
                : "object" === typeof b
                  ? c + (" obj: " + JSON.stringify(Object.keys(b)))
                  : c + (" typeof: " + typeof b)),
            a.log(c));
      },
      !1
    );
    Object.prototype.hasOwnProperty.call(window, "ImageFilters") && (a.ImageFilters = ImageFilters);
    a.initColormaps();
    a.initCommands();
    a.initAnalysis();
    a.RegisterPlugin(a.MouseTouch.CLASS, a.MouseTouch.NAME, a.MouseTouch.init, {
      menuItem: "Mouse/Touch",
      onplugindisplay: a.MouseTouch.init,
      help: "help/mousetouch.html",
      winTitle: "Mouse/Touch Actions",
      winResize: !0,
      winDims: [a.MouseTouch.WIDTH, a.MouseTouch.HEIGHT],
    });
    a.RegisterPlugin(a.Regions.CLASS, a.Regions.NAME, a.Regions.init, {
      divArgs: ["regions"],
      winDims: [0, 0],
    });
    a.RegisterPlugin(a.Crosshair.CLASS, a.Crosshair.NAME, a.Crosshair.init, {
      onmousemove: a.Crosshair.display,
      onkeyboardaction: a.Crosshair.keyaction,
      onkeyup: a.Crosshair.keyup,
      onimageload: a.Crosshair.create,
      winDims: [0, 0],
    });
    a.RegisterPlugin(a.Grid.CLASS, a.Grid.NAME, a.Grid.init, {
      onsetpan: a.Grid.regrid,
      onsetzoom: a.Grid.regrid,
      onsetwcssys: a.Grid.regrid,
      onsetwcsunits: a.Grid.regrid,
      onimageload: a.Grid.regrid,
      onupdateprefs: a.Grid.regrid,
      winDims: [0, 0],
    });
    a.RegisterPlugin(a.Dysel.CLASS, a.Dysel.NAME, a.Dysel.init, {
      onimageload: a.Dysel.imageload,
      onimageclose: a.Dysel.imageclose,
      winDims: [0, 0],
    });
    a.RegisterPlugin(a.Titlebar.CLASS, a.Titlebar.NAME, a.Titlebar.init, {
      onimageload: a.Titlebar.imageload,
      onimagedisplay: a.Titlebar.imagedisplay,
      onimageclose: a.Titlebar.imageclose,
      winDims: [0, 0],
    });
    a.instantiatePlugins();
    a.plugins.sort(function (a, b) {
      a = a.opts.menuItem;
      b = b.opts.menuItem;
      return a ? (!b || a < b ? -1 : a > b ? 1 : 0) : 1;
    });
    if (a.globalOpts.processQueryParams) {
      var b = new URL(window.location);
      if (b.searchParams) {
        c = {};
        b = $jscomp.makeIterator(b.searchParams);
        for (var d = b.next(); !d.done; d = b.next()) {
          var e = $jscomp.makeIterator(d.value);
          d = e.next().value;
          e = e.next().value;
          switch (d) {
            case "url":
            case "file":
              var f = e;
              break;
            case "display":
              var g = { display: e };
              break;
            default:
              c[d] = e;
          }
        }
        f && (g ? a.Preload(f, c, g) : a.Preload(f, c));
      }
    }
    $(document).scrollTop(0);
    a.inited = !0;
    $(document).trigger("JS9:init");
  };
  return a;
})();
$(document).ready(function () {
  $(document).on("JS9:ready", function () {
    JS9.readied || ((JS9.readied = !0), JS9.Preload(!0));
  });
  $(document).on("JS9:init", function () {
    JS9.helper.ready && JS9.fits.ready && $(document).trigger("JS9:ready", { status: "OK" });
  });
  $(document).on("astroem:ready", function () {
    JS9.initFITS();
    if (window.electron && JS9.hostFS)
      try {
        JS9.vmount("/", JS9.hostFS) || delete JS9.hostFS;
      } catch (a) {
        delete JS9.hostFS;
      }
    JS9.helper.ready && JS9.inited && $(document).trigger("JS9:ready", { status: "OK" });
  });
  $(document).on("JS9:helperReady", function () {
    JS9.fits.ready &&
      JS9.inited &&
      !JS9.readied &&
      $(document).trigger("JS9:ready", { status: "OK" });
  });
  0 === $('div[data-js9init="false"]').length && JS9.init();
});
