<CRITICAL_INSTRUCTIONS>

As you work on code, if you discover any lessons or principles about this project which in any way may help you in future coding sessions then be sure to note those lessons in the MEMORY.md file which is yours to freely edit as you see fit. Refer to this MEMORY.md file for guidance during all coding sessions with this project.

</CRITICAL_INSTRUCTIONS>

<PYTHON_ENVIRONMENT_REQUIREMENT>

:warning_sign::variation_selector-16: CRITICAL: ALL Python execution MUST use casa6. NEVER use python/python3/system Python.

REQUIRED PATH: /opt/miniforge/envs/casa6/bin/python

BEFORE ANY PYTHON EXECUTION:
1. Check: test -x /opt/miniforge/envs/casa6/bin/python || exit 1
2. Use: /opt/miniforge/envs/casa6/bin/python (NOT python3, NOT python)
3. In scripts: PYTHON_BIN="/opt/miniforge/envs/casa6/bin/python"

WHY: System Python (3.6.9) lacks CASA dependencies and required features. Pipeline WILL FAIL without casa6.

QUICK REFERENCE:
- Makefile: Use $(CASA6_PYTHON) variable
- Shell scripts: PYTHON_BIN="/opt/miniforge/envs/casa6/bin/python"
- Python code: CASA6_PYTHON = "/opt/miniforge/envs/casa6/bin/python"

DETAILS: docs/reference/CRITICAL_PYTHON_ENVIRONMENT.md

This is MANDATORY - the pipeline will not work without casa6.

</PYTHON_ENVIRONMENT_REQUIREMENT>

<CODEBASE_ORGANIZATION>

:file_folder: Before creating files, check: docs/concepts/DIRECTORY_ARCHITECTURE.md

KEY PATHS:
- Code: /data/dsa110-contimg/
- Data: /scratch/dsa110-contimg/
- Docs: docs/ structure (see .cursor/rules/documentation-location.mdc)
- State DBs: /data/dsa110-contimg/state/

DETAILS: docs/concepts/DIRECTORY_ARCHITECTURE.md

</CODEBASE_ORGANIZATION>

<AI_AGENT_TESTING_RULES>

Purpose: make testing fast, scoped, and predictable for all pipeline-related work while respecting CASA6 constraints.

General execution rules
- ALWAYS use casa6 Python for any Python command: /opt/miniforge/envs/casa6/bin/python
- NEVER run notebooks or long end-to-end scripts by default (e.g., test_forced_photometry.py, test_validation_real_data.py)
- Default time budget: 5 minutes for a full test pass per change; broaden scope only with an explicit rationale
- Prefer direct function calls over CLI subprocesses; import and test Python entrypoints where possible

Test selection strategy
- Start with quick sanity checks when touching utils/ or API:
  - python test_priority1_quick.py (fast, self-contained)
- For targeted pytest, map changes to tests instead of running the whole suite:
  - Identify changed files: git diff --name-only HEAD~1
  - For a changed src/dsa110_contimg/<pkg>/<module>.py, run tests that import that module:
    - rg -l "dsa110_contimg\.<pkg>(\.|/).*<module>" tests | xargs -r /opt/miniforge/envs/casa6/bin/python -m pytest -q -x --maxfail=1
- Default markers to include/exclude:
  - Include: unit
  - Exclude: integration, slow, casa (unless explicitly working on CASA-specific code)
  - Example: /opt/miniforge/envs/casa6/bin/python -m pytest -q -x --maxfail=1 -m "unit and not slow and not integration and not casa"
- Use Makefile targets when available:
  - make test-unit        # fast unit tests (preferred)
  - make test-validation  # only when validating enhanced pipeline with casa6 available
  - make test-integration # only when TEST_WITH_SYNTHETIC_DATA=1 and required deps are present

When touching specific areas
- pipeline/ (config, context, orchestrator, stages, state):
  - Primary: tests/integration/test_orchestrator.py, tests/test_pipeline.py
  - Use in-memory repos/fixtures (see tests/conftest.py: InMemoryStateRepository)
  - Do NOT call PipelineConfig.from_env(validate_paths=True) in tests; prefer direct PipelineConfig(...) or from_dict with validate disabled
- imaging/:
  - Primary: tests/unit/test_imaging_mocked.py
  - Always mock CASA/WSClean via fixtures (see tests/conftest.py: mock_casa_tasks, mock_wsclean_subprocess)
- calibration/:
  - Prefer unit tests with mocks; only run integration with TEST_WITH_SYNTHETIC_DATA=1
- conversion/:
  - Avoid real I/O-heavy conversion in tight loops; limit to unit scope or mocks
- qa/ (validation, HTML reports):
  - Prefer simple tests (e.g., test_html_reports_simple.py, test_validation_plots.py)
  - Skip tests requiring real FITS unless explicitly validating outputs
- catalog/:
  - Use tests/unit/test_catalog_validation.py and quick checks; avoid network calls (prefer local/mocked catalog data)

Fast-fail and reruns
- Run with -q -x --maxfail=1 for first pass; if failure occurs, rerun the single node:
  - /opt/miniforge/envs/casa6/bin/python -m pytest -q tests/<file>::<Class>::<test>
- Use -k to narrow to function/keyword when iterating

Environment and safety
- Do NOT mutate global state directories during tests; use tmp_path and in-memory repos
- If you must create databases, write under tmp_path and close connections (see tests/conftest.py: sqlite_repo)
- Avoid network calls by default; if a test requires network (e.g., catalog queries), guard with a marker and ask before enabling

Integration tests policy
- Only run integration tests when ALL of the following are true:
  - TEST_WITH_SYNTHETIC_DATA=1 is set
  - casa6 Python is available (/opt/miniforge/envs/casa6/bin/python)
  - pyuvdata and casacore are importable
- Example:
  - TEST_WITH_SYNTHETIC_DATA=1 /opt/miniforge/envs/casa6/bin/python -m pytest tests/integration/test_orchestrator.py -q -x

Search and repo hygiene
- Prefer ripgrep for search: rg -n "pattern" path/
- Keep logs minimal; increase verbosity only when debugging a failure
- Do not rebuild Docker images or containers for unit tests

Common commands
- Fast subset (fail-fast):
  - make test-fast
  - or: /opt/miniforge/envs/casa6/bin/python -m pytest tests/unit -q -x -m "unit and not slow and not integration and not casa"
- Impacted tests only:
  - bash scripts/test-impacted.sh [BASE_REF]
  - or: BASE_REF=origin/main make test-impacted
- Single focused test node rerun:
  - /opt/miniforge/envs/casa6/bin/python -m pytest -q tests/integration/test_orchestrator.py::TestOrchestratorExecution::test_linear_execution

Notes for test authors
- Mark new fast tests with @pytest.mark.unit
- Use fixtures from tests/conftest.py: mock_table_factory, mock_casa_tasks, mock_wsclean_subprocess, in_memory_repo
- When constructing PipelineConfig in tests, avoid filesystem health checks (prefer direct instance creation)

</AI_AGENT_TESTING_RULES>
