name: Output Handling Validation

on:
  push:
    paths:
      - "scripts/**"
      - ".cursor/rules/output-suppression.mdc"
      - ".github/workflows/output-handling-validation.yml"
  pull_request:
    paths:
      - "scripts/**"
      - ".cursor/rules/output-suppression.mdc"
      - ".github/workflows/output-handling-validation.yml"
  workflow_dispatch:

jobs:
  validate-output-handling:
    name: Validate Output Handling Rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate output handling rules
        run: |
          set -euo pipefail
          echo "Running output handling validation..."

          # Make script executable
          chmod +x scripts/quality/validate-output-handling.sh

          # Run validation
          if ! ./scripts/quality/validate-output-handling.sh; then
            echo ""
            echo "❌ Output handling validation failed!"
            echo ""
            echo "Please fix violations in scripts before merging."
            echo "See: .cursor/rules/output-suppression.mdc for rules"
            echo ""
            exit 1
          fi

          echo ""
          echo "✅ Output handling validation passed!"

      - name: Check for 2>&1 usage
        run: |
          set -euo pipefail
          echo "Checking for improper 2>&1 usage..."

          # Find scripts using 2>&1
          VIOLATIONS=0
          # Exclude scripts/ops, scripts/archive, .local directories
          while IFS= read -r file; do
            # Check for 2>&1 used for suppression (not with tee or pipe to command)
            # Skip lines with exception markers
            while IFS=: read -r line_num content; do
              # Skip if line has exception marker
              if echo "$content" | grep -qiE "#.*exception|#.*suppress-output-check|#.*Note:|#.*acceptable"; then
                continue
              fi
              echo "❌ VIOLATION in $file:$line_num"
              echo "   $content"
              VIOLATIONS=$((VIOLATIONS + 1))
            done < <(grep -n "2>&1.*>.*dev/null\|2>&1.*>/dev/null" "$file" 2>/dev/null || true)
          done < <(find scripts -name "*.sh" -type f ! -path "*/ops/*" ! -path "*/archive/*" ! -path "*/.local/*")

          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "❌ Found $VIOLATIONS violation(s) of 2>&1 usage"
            echo "2>&1 is only allowed when combining streams (e.g., with tee), not for suppression"
            echo "Add '# Exception: <reason>' comment to justify the suppression"
            exit 1
          fi

          echo "✅ No improper 2>&1 usage found"
