name: Environment Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  validate-environment:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check Python environment setup
        run: |
          echo "Checking if setup script exists and is executable..."
          if [ ! -f "scripts/setup-dev.sh" ]; then
            echo ":cross_mark: ERROR: setup-dev.sh not found"
            exit 1
          fi
          if [ ! -x "scripts/setup-dev.sh" ]; then
            echo ":cross_mark: ERROR: setup-dev.sh is not executable"
            exit 1
          fi
          echo ":check_mark: Setup script exists and is executable"

      - name: Check git hooks
        run: |
          echo "Checking git hooks..."
          if [ ! -d ".husky" ]; then
            echo ":cross_mark: ERROR: .husky directory not found"
            exit 1
          fi
          if [ ! -x ".husky/pre-commit" ]; then
            echo ":cross_mark: ERROR: Pre-commit hook is not executable"
            echo "  This suggests setup-dev.sh was not run"
            exit 1
          fi
          echo ":check_mark: Git hooks are set up correctly"

      - name: Check Prettier installation
        run: |
          echo "Checking Prettier installation..."
          cd frontend
          if [ ! -f "package.json" ]; then
            echo ":warning_sign::variation_selector-16:  WARNING: frontend/package.json not found"
            exit 0  # Not a blocker, might be backend-only change
          fi
          if ! npm list prettier >/dev/null 2>&1; then
            echo ":cross_mark: ERROR: Prettier not installed in frontend dependencies"
            echo "  Run: cd frontend && npm install"
            exit 1
          fi
          echo ":check_mark: Prettier is installed"

      - name: Check for markdown files in root
        run: |
          echo "Checking for markdown files in root..."
          ROOT_MD=$(find . -maxdepth 1 -name "*.md" -type f ! -name "README.md" 2>/dev/null | wc -l)
          if [ "$ROOT_MD" -gt 0 ]; then
            echo ":warning_sign::variation_selector-16:  WARNING: Found $ROOT_MD markdown file(s) in root directory"
            echo "  Documentation should be in docs/ structure"
            find . -maxdepth 1 -name "*.md" -type f ! -name "README.md" 2>/dev/null | while read -r file; do
              echo "    - $file"
            done
            # Don't fail, but warn
          else
            echo ":check_mark: No markdown files in root (except README.md)"
          fi

      - name: Check code quality
        run: |
          echo "Running code quality checks..."
          if [ -f "scripts/check-code-quality.sh" ]; then
            bash scripts/check-code-quality.sh || {
              echo ":warning_sign::variation_selector-16:  Code quality issues found (see output above)"
              # Don't fail CI, but report issues
            }
          else
            echo ":warning_sign::variation_selector-16:  WARNING: check-code-quality.sh not found"
          fi

      - name: Validate environment check script
        run: |
          echo "Validating environment check script..."
          if [ -f "scripts/check-environment.sh" ]; then
            if ! bash -n scripts/check-environment.sh; then
              echo ":cross_mark: ERROR: check-environment.sh has syntax errors"
              exit 1
            fi
            echo ":check_mark: Environment check script is valid"
          else
            echo ":warning_sign::variation_selector-16:  WARNING: check-environment.sh not found"
          fi
