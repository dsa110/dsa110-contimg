# Prometheus Alerting Rules for DSA-110 Continuum Imaging Pipeline
#
# These rules define alert conditions that will be evaluated by Prometheus
# and routed to Alertmanager for notification dispatch.
#
# Installation:
#   1. Add this file to your Prometheus rules directory
#   2. Update prometheus.yml to include: rule_files: ["alerting_rules.yml"]
#   3. Configure Alertmanager for your notification channels

groups:
  - name: contimg_storage
    rules:
      # Alert when storage sync drops below 95%
      - alert: StorageSyncLow
        expr: contimg_storage_sync_percentage < 95
        for: 5m
        labels:
          severity: warning
          service: contimg
          component: storage
        annotations:
          summary: "Storage synchronization below threshold"
          description: 'HDF5 storage sync is at {{ $value | printf "%.1f" }}%, below 95% threshold. Files may not be indexed.'
          runbook_url: "https://dsa110-contimg.readthedocs.io/troubleshooting/storage-sync"

      # Alert when storage sync is critically low
      - alert: StorageSyncCritical
        expr: contimg_storage_sync_percentage < 80
        for: 5m
        labels:
          severity: critical
          service: contimg
          component: storage
        annotations:
          summary: "Storage synchronization critically low"
          description: 'HDF5 storage sync is at {{ $value | printf "%.1f" }}%, significantly below threshold. Immediate investigation required.'
          runbook_url: "https://dsa110-contimg.readthedocs.io/troubleshooting/storage-sync"

      # Alert when many orphaned files detected
      - alert: OrphanedFilesHigh
        expr: (contimg_storage_files_on_disk - contimg_storage_files_indexed) > 1000
        for: 10m
        labels:
          severity: warning
          service: contimg
          component: storage
        annotations:
          summary: "High number of orphaned files"
          description: "{{ $value }} files on disk are not indexed in the database."

  - name: contimg_services
    rules:
      # API service down
      - alert: ContimagAPIDown
        expr: contimg_systemd_service_status{service="contimg-api"} != 1
        for: 1m
        labels:
          severity: critical
          service: contimg
          component: api
        annotations:
          summary: "Contimg API service is down"
          description: "The contimg-api systemd service is not running. The web UI and API will be unavailable."
          runbook_url: "https://dsa110-contimg.readthedocs.io/troubleshooting/service-down"

      # Streaming service down
      - alert: ContimagStreamDown
        expr: contimg_systemd_service_status{service="contimg-stream"} != 1
        for: 1m
        labels:
          severity: critical
          service: contimg
          component: streaming
        annotations:
          summary: "Contimg streaming service is down"
          description: "The contimg-stream systemd service is not running. Real-time data ingestion is stopped."
          runbook_url: "https://dsa110-contimg.readthedocs.io/troubleshooting/service-down"

      # RAGFlow container issues
      - alert: RAGFlowContainerDown
        expr: contimg_docker_container_status{container="ragflow-ragflow-1"} == 0
        for: 5m
        labels:
          severity: warning
          service: contimg
          component: ragflow
        annotations:
          summary: "RAGFlow container is down"
          description: "The RAGFlow documentation search container is not running."

      # Elasticsearch container issues
      - alert: ElasticsearchContainerDown
        expr: contimg_docker_container_status{container="ragflow-elasticsearch01-1"} == 0
        for: 5m
        labels:
          severity: warning
          service: contimg
          component: ragflow
        annotations:
          summary: "Elasticsearch container is down"
          description: "The Elasticsearch container (RAGFlow dependency) is not running."

  - name: contimg_collection
    rules:
      # Metrics collection failing
      - alert: MetricsCollectionSlow
        expr: contimg_metrics_collection_duration_seconds > 30
        for: 5m
        labels:
          severity: warning
          service: contimg
          component: monitoring
        annotations:
          summary: "Metrics collection is slow"
          description: 'Metrics collection is taking {{ $value | printf "%.1f" }}s, which may indicate system performance issues.'

  - name: contimg_pipeline
    rules:
      # Stale calibration - no valid calibration in 24+ hours
      - alert: StaleCalibration
        expr: time() - contimg_calibration_last_valid_timestamp > 86400
        for: 30m
        labels:
          severity: critical
          service: contimg
          component: calibration
        annotations:
          summary: "No valid calibration in 24+ hours"
          description: "The calibration registry has not had a valid calibration update in over 24 hours. Imaging quality may be degraded."
          runbook_url: "https://dsa110-contimg.readthedocs.io/troubleshooting/stale-calibration"

      # Queue depth too high
      - alert: ConversionQueueBacklog
        expr: contimg_ingest_queue_pending_count > 100
        for: 15m
        labels:
          severity: warning
          service: contimg
          component: conversion
        annotations:
          summary: "Conversion queue backlog exceeds 100 pending"
          description: "There are {{ $value }} observation groups pending conversion. Processing may be falling behind data arrival rate."

      # High failure rate
      - alert: PipelineFailureRate
        expr: rate(contimg_pipeline_failures_total[1h]) / rate(contimg_pipeline_runs_total[1h]) > 0.1
        for: 10m
        labels:
          severity: critical
          service: contimg
          component: pipeline
        annotations:
          summary: "Pipeline failure rate exceeds 10%"
          description: "More than 10% of pipeline runs in the last hour have failed. Immediate investigation required."

      # Disk space critical
      - alert: DiskSpaceCritical
        expr: node_filesystem_avail_bytes{mountpoint=~"/data|/stage"} / node_filesystem_size_bytes{mountpoint=~"/data|/stage"} < 0.15
        for: 5m
        labels:
          severity: critical
          service: contimg
          component: storage
        annotations:
          summary: "Disk space critically low on {{ $labels.mountpoint }}"
          description: "Disk space on {{ $labels.mountpoint }} is below 15% available. Pipeline may fail due to lack of space."

      # API response time degraded
      - alert: APIResponseTimeSlow
        expr: histogram_quantile(0.95, rate(contimg_api_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: contimg
          component: api
        annotations:
          summary: "API p95 response time exceeds 2 seconds"
          description: 'The 95th percentile API response time is {{ $value | printf "%.1f" }}s. Users may experience slow dashboard loading.'

      # Processing stuck
      - alert: ProcessingStuck
        expr: contimg_ingest_queue_in_progress_count > 0 and changes(contimg_ingest_queue_completed_count[30m]) == 0
        for: 30m
        labels:
          severity: warning
          service: contimg
          component: conversion
        annotations:
          summary: "Processing appears stuck"
          description: "Jobs are in progress but no completions in 30 minutes. A job may be hung."
