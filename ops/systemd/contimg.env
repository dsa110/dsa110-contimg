# Common environment for contimg services
# Edit these paths for your deployment

CONTIMG_INPUT_DIR=/data/incoming
CONTIMG_OUTPUT_DIR=/stage/dsa110-contimg/ms
CONTIMG_SCRATCH_DIR=/stage/dsa110-contimg

# Scratch subdirectories (default to $CONTIMG_SCRATCH_DIR/{subdir} if not set)
CONTIMG_MS_DIR=${CONTIMG_SCRATCH_DIR}/ms
CONTIMG_CALTABLES_DIR=${CONTIMG_SCRATCH_DIR}/caltables
CONTIMG_IMAGES_DIR=${CONTIMG_SCRATCH_DIR}/images
CONTIMG_MOSAICS_DIR=${CONTIMG_SCRATCH_DIR}/mosaics
CONTIMG_LOGS_DIR=${CONTIMG_SCRATCH_DIR}/logs

CONTIMG_QUEUE_DB=/data/dsa110-contimg/state/db/ingest.sqlite3
CONTIMG_REGISTRY_DB=/data/dsa110-contimg/state/db/cal_registry.sqlite3
CONTIMG_PRODUCTS_DB=/data/dsa110-contimg/state/db/products.sqlite3
CONTIMG_STATE_DIR=/data/dsa110-contimg/state/db

# Threading and CASA/HDF5 stability
OMP_NUM_THREADS=4
MKL_NUM_THREADS=4
HDF5_DB_PATH=/data/dsa110-contimg/state/db/hdf5.sqlite3
HDF5_USE_FILE_LOCKING=FALSE

# Ensure all temporary files (e.g., casacore TempLattice*) go to scratch
TMPDIR=${CONTIMG_SCRATCH_DIR}/tmp
TMP=${CONTIMG_SCRATCH_DIR}/tmp
TEMP=${CONTIMG_SCRATCH_DIR}/tmp
CASA_TMPDIR=${CONTIMG_SCRATCH_DIR}/tmp

# Streaming config
CONTIMG_EXPECTED_SUBBANDS=16
CONTIMG_CHUNK_MINUTES=5
CONTIMG_LOG_LEVEL=INFO
CONTIMG_MONITOR_INTERVAL=60

# Port Configuration
# All ports follow centralized port organization system (see config/ports.yaml)
# Ports can be overridden via environment variables
# See docs/operations/port_organization_recommendations.md for details

# Core Application Services (8000-8099)
CONTIMG_API_PORT=8000
CONTIMG_DOCS_PORT=8001

# Script paths (can be overridden if scripts are moved)
# To change the wrapper location, update this path and restart the service
CONTIMG_CASA_WRAPPER=/data/dsa110-contimg/scripts/casa/casa_wrapper.sh

# Development Servers
CONTIMG_FRONTEND_DEV_PORT=3000

# Dashboard Services (3200-3299)
CONTIMG_DASHBOARD_PORT=3210
CONTIMG_DASHBOARD_DOCKER_PORT=3000

# External Integrations (9000-9099)
CONTIMG_MCP_HTTP_PORT=3111
# CONTIMG_MCP_WS_PORT=9009  # Hardcoded in extension, not configurable
CONTIMG_CHROME_DEBUG_PORT=9222

# Optional Services (6000-6099)
# REDIS_PORT=6379  # Standard Redis port

# Telescope identity
# Use DSA_110 for EveryBeam compatibility (recognized by EveryBeam 0.7.4+)
PIPELINE_TELESCOPE_NAME=DSA_110
# Optional: if using a local Measures overlay, set CASACORE_DATA to that root
# CASACORE_DATA=/data/dsa110-contimg/data/measures

# Staging optimization (default: enabled for performance)
# tmpfs staging provides 3-5x speedup over SSD-only
# Set to false only if tmpfs space is constrained
CONTIMG_STAGE_TO_TMPFS=true
CONTIMG_TMPFS_PATH=/dev/shm

# Disk space monitoring
CONTIMG_DISK_WARN_GB=200
CONTIMG_DISK_CRITICAL_GB=100
CONTIMG_TMPFS_WARN_PERCENT=90
CONTIMG_TMPFS_CRITICAL_PERCENT=95

# Data retention policy
# CRITICAL: Currently INDEFINITE - no automatic deletion
CONTIMG_AUTO_CLEANUP_ENABLED=false
# Future retention settings (not currently enforced):
# CONTIMG_INCOMING_RETENTION_DAYS=7
# CONTIMG_MS_RETENTION_DAYS=30
# CONTIMG_IMAGE_RETENTION_DAYS=90

# CASA log directory - CASA writes logs to current working directory
# This is set in code, but can be overridden here if needed
CASALOGFILE=/data/dsa110-contimg/state/logs/casa.log

# Calibration strategy
CONTIMG_CAL_BANDPASS_INTERVAL_HOURS=24
CONTIMG_CAL_GAIN_INTERVAL_HOURS=1
CONTIMG_CAL_USE_NVSS_SKYMODEL=true

# Quality assurance thresholds
# MS quality
CONTIMG_QA_MS_MAX_FLAGGED=0.5
CONTIMG_QA_MS_MAX_ZEROS=0.3
CONTIMG_QA_MS_MIN_AMP=1e-6

# Calibration quality
CONTIMG_QA_CAL_MAX_FLAGGED=0.3
CONTIMG_QA_CAL_MIN_AMP=0.1
CONTIMG_QA_CAL_MAX_AMP=10.0
CONTIMG_QA_CAL_MAX_PHASE_SCATTER=90.0

# Image quality
CONTIMG_QA_IMG_MIN_DYNAMIC_RANGE=5.0
CONTIMG_QA_IMG_MIN_PEAK_SNR=5.0
CONTIMG_QA_IMG_MIN_5SIGMA_PIXELS=10

# Notification / alerting for ops scripts (monitor-containers.sh, etc.)
NOTIFICATION_METHOD=slack,email,log
# Configure Slack webhook via deployment secrets; placeholder keeps repo free of real URLs
SLACK_WEBHOOK_URL=https://example.invalid/slack-webhook-placeholder
EMAIL_RECIPIENTS=ops@dsa110.org,alerts@dsa110.org
# Optional webhook for generic integrations
# NOTIFICATION_WEBHOOK_URL=https://example.com/webhook
NOTIFICATION_TITLE_PREFIX=[contimg]
NOTIFY_LOG_FILE=/data/dsa110-contimg/state/logs/notifications.log
# After editing Slack/email values: sudo systemctl daemon-reload && sudo systemctl restart contimg-stream.service contimg-api.service

# Alerting configuration
# To enable Slack alerts, set webhook URL (get from Slack app settings)
# CONTIMG_SLACK_WEBHOOK_URL=https://example.invalid/slack-webhook-placeholder
# Minimum severity for Slack: DEBUG, INFO, WARNING, ERROR, CRITICAL
CONTIMG_SLACK_MIN_SEVERITY=WARNING

# Email alerts (optional)
# CONTIMG_SMTP_HOST=smtp.example.com
# CONTIMG_SMTP_PORT=587
# CONTIMG_SMTP_USER=pipeline@example.com
# CONTIMG_SMTP_PASSWORD=your_password
# CONTIMG_ALERT_FROM_EMAIL=dsa110-pipeline@example.com
# CONTIMG_ALERT_TO_EMAILS=ops@example.com,admin@example.com

# API compatibility (explicit values for API-consumed names)
# The API reads PIPELINE_* and CAL_REGISTRY_DB variables; mirror values here explicitly.
PIPELINE_QUEUE_DB=/data/dsa110-contimg/state/db/ingest.sqlite3
PIPELINE_PRODUCTS_DB=/data/dsa110-contimg/state/db/products.sqlite3
PIPELINE_STATE_DIR=/data/dsa110-contimg/state/db
PIPELINE_HDF5_DB=/data/dsa110-contimg/state/db/hdf5.sqlite3
PIPELINE_CAL_REGISTRY_DB=/data/dsa110-contimg/state/db/cal_registry.sqlite3
PIPELINE_CALIBRATORS_DB=/data/dsa110-contimg/state/db/calibrators.sqlite3
PIPELINE_DATA_REGISTRY_DB=/data/dsa110-contimg/state/db/data_registry.sqlite3
PIPELINE_EXPECTED_SUBBANDS=16
CAL_REGISTRY_DB=/data/dsa110-contimg/state/db/cal_registry.sqlite3

# Absurd Workflow Manager Configuration
ABSURD_ENABLED=true
ABSURD_DATABASE_URL=postgresql:///dsa110_absurd?host=/var/run/postgresql&port=5433
ABSURD_QUEUE_NAME=dsa110-pipeline
ABSURD_WORKER_CONCURRENCY=4
ABSURD_WORKER_POLL_INTERVAL_SEC=1.0
ABSURD_TASK_TIMEOUT_SEC=3600
ABSURD_MAX_RETRIES=3

# GPU Acceleration Configuration
# Enable GPU acceleration for imaging (auto-detects GPU availability)
PIPELINE_GPU_ENABLED=true
# GPU device IDs to use (comma-separated, empty = all GPUs)
# PIPELINE_GPU_DEVICES=0,1
# WSClean gridder: idg (GPU), wgridder (CPU), wstacking (CPU)
PIPELINE_GPU_GRIDDER=idg
# IDG mode: cpu, gpu, or hybrid (best balance of speed and memory)
PIPELINE_GPU_IDG_MODE=hybrid
# Max fraction of GPU memory to use (0.0-1.0)
PIPELINE_GPU_MEMORY_FRACTION=0.9

# Matplotlib configuration to avoid permission errors
MPLCONFIGDIR=/tmp/matplotlib-cache
