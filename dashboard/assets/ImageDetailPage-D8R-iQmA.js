import{r as n,j as e,u as T,R as $,L as S}from"./index-CPQ429lP.js";import{E as F,C as u,P as M,a as E}from"./CoordinateDisplay-CA5mD9fj.js";import{u as V,L as A}from"./appStore-D_762BMt.js";import{M as P}from"./Modal-B_3ngamN.js";import{Q as R}from"./QAMetrics-iJdHXRXg.js";import{A as q}from"./AladinLiteViewer-BTBtuHJ3.js";import{F as U}from"./FitsViewer-B8fQ9RIf.js";import{m as B}from"./provenanceMappers-Dk7u1RY2.js";import{r as O}from"./relativeTime-Dp84ug83.js";import{c as z}from"./useQueries-CHD14y58.js";const Q={sm:"w-24 h-24",md:"w-48 h-48",lg:"w-72 h-72"},H=({imageId:l,alt:t="Image preview",size:w="md",onClick:r,expandable:c=!0,apiUrl:p="https://ronnie-unsectarian-antone.ngrok-free.dev/api"})=>{const[o,k]=n.useState(!0),[m,h]=n.useState(!1),[x,i]=n.useState(!1),b=`${p}/images/${l}/thumbnail`,j=()=>{k(!1),h(!1)},f=()=>{k(!1),h(!0)},N=()=>{r?r():c&&i(!x)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`relative ${Q[w]} bg-gray-100 rounded-lg overflow-hidden border border-gray-200 ${r||c?"cursor-pointer hover:border-blue-400 transition-colors":""}`,onClick:N,role:r||c?"button":void 0,tabIndex:r||c?0:void 0,onKeyDown:g=>{(g.key==="Enter"||g.key===" ")&&(r||c)&&N()},children:[o&&!m&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"animate-pulse flex flex-col items-center",children:[e.jsx("svg",{className:"w-8 h-8 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("span",{className:"text-xs text-gray-400 mt-1",children:"Loading..."})]})}),m&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"flex flex-col items-center text-gray-400",children:[e.jsx("svg",{className:"w-8 h-8",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("span",{className:"text-xs mt-1",children:"No preview"})]})}),e.jsx("img",{src:b,alt:t,className:`w-full h-full object-cover ${o||m?"hidden":""}`,onLoad:j,onError:f}),c&&!m&&!o&&e.jsx("div",{className:"absolute bottom-1 right-1 bg-black/50 rounded p-1",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"})})})]}),x&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80",onClick:()=>i(!1),role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh] p-4",children:[e.jsx("img",{src:b,alt:t,className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),e.jsx("button",{className:"absolute top-2 right-2 bg-white/90 rounded-full p-2 hover:bg-white transition-colors",onClick:()=>i(!1),"aria-label":"Close",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})]})},W=[{value:"true",label:"True",color:"bg-green-500"},{value:"false",label:"False",color:"bg-red-500"},{value:"unsure",label:"Unsure",color:"bg-yellow-500"}],J=({itemId:l,itemName:t,tags:w,previousRating:r,onSubmit:c,onNextUnrated:p,onCreateTag:o,isLoading:k=!1,className:m=""})=>{const[h,x]=n.useState(r?.confidence||"false"),[i,b]=n.useState(r?.tag.id||w[0]?.id||""),[j,f]=n.useState(r?.notes||""),[N,g]=n.useState(!1),[C,a]=n.useState(!1),[y,v]=n.useState(""),[d,_]=n.useState(""),I=n.useCallback(async s=>{if(s.preventDefault(),!!i){g(!0);try{await c({itemId:l,confidence:h,tagId:i,notes:j})}finally{g(!1)}}},[l,h,i,j,c]),D=n.useCallback(async()=>{if(!(!y.trim()||!o))try{const s=await o(y.trim(),d.trim());b(s.id),v(""),_(""),a(!1)}catch(s){console.error("Failed to create tag:",s)}},[y,d,o]),L=s=>new Date(s).toLocaleString();return e.jsxs("div",{className:`card ${m}`,children:[e.jsx("div",{className:"card-header",children:e.jsxs("h4",{className:"text-lg font-semibold",children:["Rate: ",t]})}),e.jsxs("div",{className:"card-body space-y-4",children:[r&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 border border-gray-200",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Your previous rating:"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("span",{className:"font-medium",children:"Real variable?"}),e.jsx("span",{className:`badge ${r.confidence==="true"?"badge-success":r.confidence==="false"?"badge-error":"badge-warning"}`,children:r.confidence.charAt(0).toUpperCase()+r.confidence.slice(1)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("span",{className:"font-medium",children:"Tag:"}),e.jsx("span",{className:"badge badge-info",children:r.tag.name})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("span",{className:"font-medium",children:"Date:"}),e.jsx("span",{children:L(r.date)})]}),r.notes&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Notes:"}),e.jsx("p",{className:"mt-1 text-gray-600 bg-white p-2 rounded border max-h-24 overflow-y-auto",children:r.notes})]})]})]}),e.jsx("hr",{className:"border-gray-200"}),e.jsxs("form",{onSubmit:I,className:"space-y-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Real variable?"}),e.jsx("div",{className:"flex gap-2",children:W.map(s=>e.jsx("button",{type:"button",onClick:()=>x(s.value),className:`flex-1 py-2 px-3 rounded-md font-medium transition-all ${h===s.value?`${s.color} text-white shadow-md`:"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:s.label},s.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Classification Tag"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:i,onChange:s=>b(s.target.value),className:"form-select flex-1",children:[e.jsx("option",{value:"",children:"Select a tag..."}),w.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),o&&e.jsx("button",{type:"button",onClick:()=>a(!C),className:"btn btn-success btn-sm",title:"Create new tag",children:"+"})]})]}),C&&o&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 border border-gray-200 space-y-2",children:[e.jsx("input",{type:"text",value:y,onChange:s=>v(s.target.value),placeholder:"Tag name",className:"form-control"}),e.jsx("textarea",{value:d,onChange:s=>_(s.target.value),placeholder:"Description (optional)",rows:2,className:"form-control"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>a(!1),className:"btn btn-secondary btn-sm",children:"Cancel"}),e.jsx("button",{type:"button",onClick:D,disabled:!y.trim(),className:"btn btn-primary btn-sm",children:"Add Tag"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Notes"}),e.jsx("textarea",{value:j,onChange:s=>f(s.target.value),placeholder:"Add any observations or notes...",rows:4,className:"form-control"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{type:"submit",disabled:N||k||!i,className:"btn btn-primary w-full",children:N?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):r?"Update Rating":"Submit Rating"}),p&&e.jsx("button",{type:"button",onClick:p,className:"btn btn-success w-full",children:"Next Unrated Candidate â†’"})]})]})]})]})},ne=()=>{const{imageId:l}=T(),{data:t,isLoading:w,error:r,refetch:c}=z(l),p=V(d=>d.addRecentImage),[o,k]=n.useState(!0),[m,h]=n.useState(!1),x=l?encodeURIComponent(l):"",[i,b]=n.useState(!1),[j,f]=n.useState(!1),N=async()=>{const d="https://ronnie-unsectarian-antone.ngrok-free.dev/api";try{await fetch(`${d}/images/${x}`,{method:"DELETE"}),window.location.href="/images"}catch(_){console.error("Failed to delete image:",_)}},g=[{id:"artifact",name:"Artifact",color:"#EF4444",description:"Image contains artifacts"},{id:"good",name:"Good Quality",color:"#22C55E",description:"Image passes QA"},{id:"marginal",name:"Marginal",color:"#F59E0B",description:"Borderline quality"},{id:"rfi",name:"RFI",color:"#8B5CF6",description:"Radio frequency interference"}],C=async d=>{await fetch(`https://ronnie-unsectarian-antone.ngrok-free.dev/api/images/${d.itemId}/rating`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}),c()};if($.useEffect(()=>{t&&l&&p(l)},[t,l,p]),w)return e.jsx(A,{label:"Loading image details..."});if(r)return e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsx(F,{error:r,onRetry:()=>c()})});if(!t)return e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsxs(u,{children:[e.jsx("p",{className:"text-gray-500 mb-4",children:"Image not found."}),e.jsx(S,{to:"/images",className:"link",children:"Back to Images"})]})});const a=t,y=B(a),v=t.path?.split("/").pop()||t.id;return e.jsxs("div",{className:"max-w-6xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx(S,{to:"/images",className:"text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block",children:"Back to Images"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:v}),e.jsx(M,{...y})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 sticky-sidebar",children:[e.jsx(u,{title:"Preview",children:e.jsx("div",{className:"flex justify-center",children:e.jsx(H,{imageId:l||"",size:"lg",alt:v})})}),e.jsx(u,{title:"Actions",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("a",{href:`https://ronnie-unsectarian-antone.ngrok-free.dev/api/images/${x}/fits`,target:"_blank",rel:"noreferrer",className:"btn btn-primary text-center",children:"Download FITS"}),e.jsxs("button",{type:"button",className:`btn ${m?"btn-primary":"btn-secondary"}`,onClick:()=>h(!m),children:[m?"Hide":"Show"," FITS Viewer"]}),e.jsxs("button",{type:"button",className:`btn ${i?"btn-primary":"btn-secondary"}`,onClick:()=>b(!i),children:[i?"Hide":"Show"," Rating"]}),a.qa_grade&&e.jsx(S,{to:`/qa/image/${x}`,className:"btn btn-secondary text-center",children:"View QA Report"}),e.jsx("button",{type:"button",className:"btn bg-red-100 text-red-700 hover:bg-red-200",onClick:()=>f(!0),children:"Delete Image"})]})}),e.jsx(P,{isOpen:j,onClose:()=>f(!1),title:"Delete Image",size:"sm",footer:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>f(!1),className:"px-4 py-2 text-sm text-gray-700 bg-gray-100 rounded hover:bg-gray-200",children:"Cancel"}),e.jsx("button",{onClick:N,className:"px-4 py-2 text-sm text-white bg-red-600 rounded hover:bg-red-700",children:"Delete"})]}),children:e.jsxs("p",{className:"text-gray-600",children:["Are you sure you want to delete ",e.jsx("strong",{children:v}),"? This action cannot be undone."]})})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[m&&e.jsx(u,{title:"FITS Viewer",children:e.jsx(U,{fitsUrl:`https://ronnie-unsectarian-antone.ngrok-free.dev/api/images/${x}/fits`,displayId:`fits-${x}`,width:600,height:500,showControls:!0,initialCenter:a.pointing_ra_deg!=null&&a.pointing_dec_deg!=null?{ra:a.pointing_ra_deg,dec:a.pointing_dec_deg}:void 0})}),i&&e.jsx(u,{title:"Image Rating",children:e.jsx(J,{itemId:l||"",itemName:v,tags:g,previousRating:a.qa_grade?{id:`rating-${l}`,confidence:a.qa_grade==="good"?"true":a.qa_grade==="fail"?"false":"unsure",tag:g.find(d=>d.id===(a.qa_grade==="good"?"good":a.qa_grade==="fail"?"artifact":"marginal"))||g[0],user:"system",date:a.created_at||new Date().toISOString()}:void 0,onSubmit:C})}),(a.qa_grade||a.noise_jy||a.dynamic_range)&&e.jsx(u,{title:"Quality Assessment",children:e.jsx(R,{grade:a.qa_grade,summary:a.qa_summary,noiseJy:a.noise_jy,dynamicRange:a.dynamic_range,beamMajorArcsec:a.beam_major_arcsec,beamMinorArcsec:a.beam_minor_arcsec,beamPaDeg:a.beam_pa_deg})}),a.pointing_ra_deg!=null&&a.pointing_dec_deg!=null&&e.jsxs(u,{title:"Pointing",subtitle:e.jsx("button",{type:"button",onClick:()=>k(!o),className:"text-xs text-blue-600 hover:text-blue-800",children:o?"Hide Sky View":"Show Sky View"}),children:[e.jsx(E,{raDeg:a.pointing_ra_deg,decDeg:a.pointing_dec_deg,showDecimal:!0,allowFormatToggle:!0}),o&&e.jsx("div",{className:"mt-4",children:e.jsx(q,{raDeg:a.pointing_ra_deg,decDeg:a.pointing_dec_deg,fov:.5,height:250,className:"rounded-lg overflow-hidden"})})]}),e.jsx(u,{title:"Metadata",children:e.jsxs("dl",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Image ID"}),e.jsx("dd",{className:"font-mono text-sm text-gray-900 break-all",children:t.id})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("dd",{className:"text-sm text-gray-900",children:t.created_at?e.jsxs(e.Fragment,{children:[new Date(t.created_at).toLocaleString(),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",O(t.created_at),")"]})]}):e.jsx("span",{className:"text-gray-400",children:"Unknown"})})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("dt",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Path"}),e.jsx("dd",{className:"font-mono text-sm text-gray-900 break-all",children:t.path})]}),t.ms_path&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("dt",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Source Measurement Set"}),e.jsx("dd",{className:"font-mono text-sm break-all",children:e.jsx(S,{to:`/ms/${encodeURIComponent(t.ms_path)}`,className:"text-blue-600 hover:text-blue-800 hover:underline",children:t.ms_path})})]}),t.cal_table&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("dt",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Calibration Table"}),e.jsx("dd",{className:"font-mono text-sm text-gray-900 break-all",children:t.cal_table})]}),t.run_id&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Pipeline Run"}),e.jsx("dd",{className:"text-sm",children:e.jsx(S,{to:`/jobs/${t.run_id}`,className:"text-blue-600 hover:text-blue-800 hover:underline",children:t.run_id})})]})]})})]})]})]})};export{ne as default};
//# sourceMappingURL=ImageDetailPage-D8R-iQmA.js.map
