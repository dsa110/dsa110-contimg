import{r as o,j as e,L as V}from"./index-DVX6Veo3.js";import{u as G}from"./useQueries-LzJhzr89.js";import{a as k,L}from"./appStore-C_UcZAt-.js";import{u as A,S as J}from"./SortableTableHeader-dSztKu9P.js";import{F as D}from"./FitsViewer-BrtRqYF1.js";import"./aladin-xl9YHuqu.js";import{R as I}from"./RangeSlider-DlBl9Jvu.js";const E=({fitsUrls:n,columns:l=2,viewerSize:m=300,syncViews:g=!0,labels:p,onCoordinateClick:h,className:x=""})=>{const[u,b]=o.useState(0),[j,w]=o.useState(g),[y,c]=o.useState({}),S=o.useCallback(()=>{if(!j||!window.JS9)return;const a="JS9Grid_0";try{const t=window.JS9.GetZoom({display:a}),r=window.JS9.GetPan({display:a});if(t&&r)for(let d=1;d<n.length;d++){const v=`JS9Grid_${d}`;window.JS9.SetZoom(t,{display:v}),window.JS9.SetPan(r.x,r.y,{display:v})}}catch(t){console.warn("Failed to sync views:",t)}},[syncViews,n.length]);o.useEffect(()=>{if(!j||u<n.length)return;const a=()=>{S()};return window.JS9&&(window.JS9.SetCallback("onzoom",a,{display:"JS9Grid_0"}),window.JS9.SetCallback("onpan",a,{display:"JS9Grid_0"})),()=>{window.JS9&&(window.JS9.SetCallback("onzoom",null,{display:"JS9Grid_0"}),window.JS9.SetCallback("onpan",null,{display:"JS9Grid_0"}))}},[syncViews,u,n.length,S]);const f=()=>{b(a=>a+1)},i=()=>{switch(l){case 1:return"grid-cols-1";case 2:return"grid-cols-2";case 3:return"grid-cols-3";case 4:return"grid-cols-4";default:return"grid-cols-2"}};return n.length===0?e.jsx("div",{className:"text-center text-gray-500 py-8",children:"No FITS files to display"}):e.jsxs("div",{className:x,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:[u,"/",n.length," images loaded"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:j,onChange:a=>w(a.target.checked),className:"w-4 h-4 rounded accent-primary"}),e.jsx("span",{children:"Sync views"})]})]}),e.jsx("div",{className:`grid ${i()} gap-4`,children:n.map((a,t)=>e.jsxs("div",{className:"relative",children:[p&&p[t]&&e.jsx("div",{className:"absolute top-2 left-2 z-10 bg-black/70 text-white text-xs px-2 py-1 rounded",children:p[t]}),e.jsx(D,{fitsUrl:a,displayId:`JS9Grid_${t}`,width:m,height:m,showControls:!1,onLoad:f,onCoordinateClick:h?(r,d)=>h(r,d,t):void 0})]},`${a}-${t}`))}),e.jsx("div",{className:"mt-4 p-3 bg-gray-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Grid Controls:"}),e.jsx("button",{onClick:()=>{if(window.JS9)for(let a=0;a<n.length;a++)window.JS9.SetZoom("tofit",{display:`JS9Grid_${a}`})},className:"px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors",children:"Fit All"}),e.jsx("button",{onClick:()=>{if(window.JS9)for(let a=0;a<n.length;a++)window.JS9.SetZoom("in",{display:`JS9Grid_${a}`})},className:"px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors",children:"Zoom In All"}),e.jsx("button",{onClick:()=>{if(window.JS9)for(let a=0;a<n.length;a++)window.JS9.SetZoom("out",{display:`JS9Grid_${a}`})},className:"px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors",children:"Zoom Out All"}),e.jsxs("select",{onChange:a=>{if(window.JS9&&a.target.value)for(let t=0;t<n.length;t++)window.JS9.SetColormap(a.target.value,{display:`JS9Grid_${t}`})},className:"px-2 py-1 text-sm border border-gray-300 rounded",defaultValue:"",children:[e.jsx("option",{value:"",disabled:!0,children:"Color map..."}),e.jsx("option",{value:"grey",children:"Grey"}),e.jsx("option",{value:"heat",children:"Heat"}),e.jsx("option",{value:"cool",children:"Cool"}),e.jsx("option",{value:"viridis",children:"Viridis"}),e.jsx("option",{value:"rainbow",children:"Rainbow"})]})]})})]})},M=[{value:"fits",label:"FITS"},{value:"csv",label:"CSV"},{value:"json",label:"JSON"},{value:"zip",label:"ZIP Archive"}],P=({items:n,selectedIds:l,onSelectionChange:m,onDownload:g,className:p="",disabled:h=!1})=>{const[x,u]=o.useState("fits"),[b,j]=o.useState(!1),w=o.useCallback(()=>{l.length===n.length?m([]):m(n.map(i=>i.id))},[n,l.length,m]),y=o.useCallback(i=>{l.includes(i)?m(l.filter(a=>a!==i)):m([...l,i])},[l,m]),c=o.useCallback(async()=>{if(l.length!==0){j(!0);try{await g(l,x)}finally{j(!1)}}},[l,x,g]),S=l.length===n.length&&n.length>0,f=l.length>0&&l.length<n.length;return e.jsxs("div",{className:`card ${p}`,children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Bulk Download"}),e.jsxs("span",{className:"text-sm text-gray-500",children:[l.length," of ",n.length," selected"]})]}),e.jsxs("div",{className:"card-body space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:S,ref:i=>{i&&(i.indeterminate=f)},onChange:w,disabled:h||n.length===0,className:"w-4 h-4 text-vast-green rounded border-gray-300 focus:ring-vast-green"}),e.jsx("span",{className:"text-sm",children:"Select All"})]}),l.length>0&&e.jsx("button",{onClick:()=>m([]),className:"text-sm text-gray-500 hover:text-red-500",children:"Clear selection"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Export Format"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:M.map(i=>e.jsx("button",{onClick:()=>u(i.value),disabled:h,className:`py-2 px-3 rounded-md text-sm font-medium transition-all ${x===i.value?"bg-vast-green text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:i.label},i.value))})]}),l.length>0&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 max-h-40 overflow-y-auto",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Selected items:"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[l.slice(0,10).map(i=>{const a=n.find(t=>t.id===i);return e.jsxs("span",{className:"badge badge-secondary flex items-center gap-1",children:[a?.name||i,e.jsx("button",{onClick:()=>y(i),className:"hover:text-red-500",children:"×"})]},i)}),l.length>10&&e.jsxs("span",{className:"badge badge-info",children:["+",l.length-10," more"]})]})]}),e.jsx("button",{onClick:c,disabled:h||l.length===0||b,className:"btn btn-primary w-full",children:b?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Preparing Download..."]}):e.jsxs(e.Fragment,{children:["Download ",l.length," item",l.length!==1?"s":""," as"," ",x.toUpperCase()]})}),e.jsxs("div",{className:"text-xs text-gray-500",children:[x==="fits"&&"Download raw FITS files individually.",x==="csv"&&"Export metadata as CSV spreadsheet.",x==="json"&&"Export metadata as JSON.",x==="zip"&&"Download all files in a single ZIP archive."]})]})]})},q=({filters:n,values:l,onChange:m,title:g="Filters",collapsible:p=!0,defaultCollapsed:h=!1,className:x=""})=>{const[u,b]=o.useState(h),[j,w]=o.useState({}),y=o.useCallback((a,t)=>{m({...l,[a]:t})},[l,m]),c=o.useCallback((a,t,r)=>{m({...l,[a]:[t,r]})},[l,m]),S=o.useCallback(()=>{const a={};n.forEach(t=>{t.defaultValue!==void 0&&(a[t.id]=t.defaultValue)}),m(a)},[n,m]);o.useCallback(a=>{w(t=>({...t,[a]:!t[a]}))},[]);const f=o.useMemo(()=>Object.entries(l).filter(([a,t])=>{const r=n.find(d=>d.id===a);return r?r.type==="range"&&Array.isArray(t)?t[0]!==r.min||t[1]!==r.max:r.defaultValue!==void 0?t!==r.defaultValue:t!==void 0&&t!==""&&t!==!1:!1}).length,[l,n]),i=a=>{const t=l[a.id];switch(a.type){case"range":{const r=Array.isArray(t)?t:[a.min??0,a.max??100];return e.jsx(I,{min:a.min??0,max:a.max??100,step:a.step??1,minValue:r[0],maxValue:r[1],label:a.label,unit:a.unit,histogram:a.histogram,onChange:(d,v)=>c(a.id,d,v),showInputs:!0},a.id)}case"select":return e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a.label}),e.jsxs("select",{value:String(t??""),onChange:r=>y(a.id,r.target.value||void 0),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"All"}),a.options?.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})]},a.id);case"checkbox":return e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:!!t,onChange:r=>y(a.id,r.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:a.label})]},a.id);case"text":return e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a.label}),e.jsx("input",{type:"text",value:String(t??""),onChange:r=>y(a.id,r.target.value||void 0),placeholder:`Filter by ${a.label.toLowerCase()}...`,className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500"})]},a.id);default:return null}};return e.jsxs("div",{className:`bg-white rounded-lg border border-gray-200 shadow-sm ${x}`,children:[e.jsxs("div",{className:`flex items-center justify-between px-4 py-3 ${p?"cursor-pointer hover:bg-gray-50":""} ${u?"":"border-b border-gray-200"}`,onClick:p?()=>b(!u):void 0,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[p&&e.jsx("svg",{className:`w-4 h-4 text-gray-500 transition-transform ${u?"":"rotate-90"}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:g}),f>0&&e.jsx("span",{className:"px-2 py-0.5 text-xs font-medium text-blue-700 bg-blue-100 rounded-full",children:f})]}),!u&&f>0&&e.jsx("button",{type:"button",onClick:a=>{a.stopPropagation(),S()},className:"text-xs text-blue-600 hover:text-blue-800",children:"Reset all"})]}),!u&&e.jsx("div",{className:"p-4 space-y-4",children:n.map(a=>i(a))})]})},H=()=>{const{data:n,isLoading:l,error:m}=G(),[g,p]=o.useState("list"),[h,x]=o.useState({}),u=[{id:"qa_grade",label:"QA Grade",type:"select",options:[{value:"good",label:"Good"},{value:"warn",label:"Warning"},{value:"fail",label:"Fail"}]},{id:"search",label:"Search",type:"text"}],b=k(s=>s.selectedImages),j=k(s=>s.toggleImageSelection),w=k(s=>s.selectAllImages),y=k(s=>s.clearImageSelection),c=o.useMemo(()=>Array.from(b),[b]),S=o.useCallback(s=>{s.length===0?y():w(s)},[y,w]),f=o.useCallback(async(s,N)=>{const F=`https://ronnie-unsectarian-antone.ngrok-free.dev/api/images/bulk-download?ids=${s.join(",")}&format=${N}`;window.open(F,"_blank")},[]),i=o.useMemo(()=>{if(!n)return[];let s=n;if(h.qa_grade&&(s=s.filter(N=>N.qa_grade===h.qa_grade)),h.search&&typeof h.search=="string"){const N=h.search.toLowerCase();s=s.filter(C=>C.path?.toLowerCase().includes(N)||C.id.toLowerCase().includes(N))}return s},[n,h]),{sortColumn:a,sortDirection:t,handleSort:r,sortedData:d}=A(i,"created_at","desc");if(l)return e.jsx(L,{label:"Loading images..."});if(m)return e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg",children:["Failed to load images: ",m.message]});const v=o.useMemo(()=>d.map(s=>({id:s.id,name:s.path?.split("/").pop()||s.id,type:"FITS"})),[d]),_=o.useMemo(()=>{const s="https://ronnie-unsectarian-antone.ngrok-free.dev/api";return c.map(N=>`${s}/images/${N}/fits`)},[c]),$=o.useMemo(()=>c.map(s=>d.find(C=>C.id===s)?.path?.split("/").pop()||s),[c,d]);return e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Images"}),c.length>0&&e.jsxs("span",{className:"text-sm text-gray-500",children:[c.length," selected"]})]}),e.jsx("div",{className:"flex gap-2",children:c.length>=2&&c.length<=4&&e.jsx("button",{onClick:()=>p(g==="compare"?"list":"compare"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${g==="compare"?"bg-purple-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:g==="compare"?"Back to List":"Compare Selected"})})]}),e.jsx("div",{className:"mb-4",children:e.jsx(q,{filters:u,values:h,onChange:x,title:"Filter Images",collapsible:!0,defaultCollapsed:!0})}),g==="compare"&&c.length>=2&&e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"card p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Image Comparison"}),e.jsx(E,{fitsUrls:_,labels:$,columns:c.length<=2?2:c.length<=3?3:4,viewerSize:350,syncViews:!0})]})}),d.length>0&&e.jsx("div",{className:"mb-6",children:e.jsx(P,{items:v,selectedIds:c,onSelectionChange:S,onDownload:f})}),d&&d.length>0?e.jsx("div",{className:"card overflow-hidden",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-10 px-3 py-3",children:e.jsx("input",{type:"checkbox",checked:c.length===d.length&&d.length>0,ref:s=>{s&&(s.indeterminate=c.length>0&&c.length<d.length)},onChange:()=>{c.length===d.length?y():w(d.map(s=>s.id))},className:"h-4 w-4 text-blue-600 rounded"})}),e.jsx(J,{columnKey:"path",sortColumn:a,sortDirection:t,onSort:r,children:"Name"}),e.jsx(J,{columnKey:"qa_grade",sortColumn:a,sortDirection:t,onSort:r,className:"text-center",children:"QA Grade"}),e.jsx(J,{columnKey:"created_at",sortColumn:a,sortDirection:t,onSort:r,className:"text-right",children:"Created"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:d.map(s=>e.jsxs("tr",{className:b.has(s.id)?"bg-blue-50":"",children:[e.jsx("td",{className:"px-3",children:e.jsx("input",{type:"checkbox",checked:b.has(s.id),onChange:()=>j(s.id),className:"h-4 w-4 text-blue-600 rounded"})}),e.jsx("td",{children:e.jsx(V,{to:`/images/${s.id}`,className:"text-blue-600 hover:text-blue-800 font-medium",children:s.path?.split("/").pop()||s.id})}),e.jsx("td",{className:"text-center",children:s.qa_grade&&e.jsx("span",{className:`badge ${s.qa_grade==="good"?"badge-success":s.qa_grade==="warn"?"badge-warning":"badge-error"}`,children:s.qa_grade})}),e.jsx("td",{className:"text-right text-gray-500",children:s.created_at?new Date(s.created_at).toLocaleDateString():"—"})]},s.id))})]})}):e.jsx("p",{className:"text-gray-500",children:"No images found."})]})};export{H as default};
//# sourceMappingURL=ImagesListPage-BKj4j8Sg.js.map
