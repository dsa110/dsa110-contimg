import{r as c,j as e,R as q,L as J}from"./index-a6McjROp.js";import{a as W}from"./useQueries-Cs64MlL7.js";import{a as U,L as Q}from"./appStore-B5qSIe6K.js";import{u as G,S as P}from"./SortableTableHeader-B2zAa41v.js";import{init as Z}from"./echarts-BlxdVhSE.js";const O=new Map,X=({onResolved:d,className:y=""})=>{const[h,u]=c.useState(""),[m,o]=c.useState("all"),[a,n]=c.useState(!1),[i,p]=c.useState(null),[x,N]=c.useState(null),$=c.useRef(null),M=c.useCallback(async()=>{const f=h.trim();if(!f){p("Please enter an object name");return}const g=`${m}:${f.toLowerCase()}`,b=O.get(g);if(b){N(b),p(null),d(b.ra,b.dec,b.objectName);return}$.current&&$.current.abort(),$.current=new AbortController,n(!0),p(null),N(null);try{const l=`https://cdsweb.u-strasbg.fr/cgi-bin/nph-sesame/-oI/${m==="all"?"A":m.charAt(0).toUpperCase()}?${encodeURIComponent(f)}`,j=await fetch(l,{signal:$.current.signal});if(!j.ok)throw new Error(`HTTP error: ${j.status}`);const R=(await j.text()).split(`
`).find(t=>t.startsWith("%J"));if(!R)throw new Error("Could not resolve object. Please check the name and try again.");const I=R.match(/%J\s+([\d.+-]+)\s+([\d.+-]+)/);if(!I)throw new Error("Failed to parse coordinates from response.");const A=parseFloat(I[1]),r=parseFloat(I[2]),w={ra:A,dec:r,objectName:f,service:m};O.set(g,w),N(w),d(A,r,f)}catch(v){if(v instanceof Error&&v.name==="AbortError")return;const l=v instanceof Error?v.message:"Resolution failed";l.includes("fetch")||l.includes("network")?p("Network error. CORS may be blocking the request. Try using a backend proxy."):p(l)}finally{n(!1)}},[h,m,d]),C=f=>{f.key==="Enter"&&M()};return e.jsxs("div",{className:`space-y-3 ${y}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:h,onChange:f=>u(f.target.value),onKeyDown:C,placeholder:"Object name (e.g., M31, Crab Nebula, PSR J0534+2200)",className:"form-control flex-1"}),e.jsx("button",{onClick:M,disabled:a||!h.trim(),className:"btn btn-primary",children:a?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Resolving..."]}):"Resolve"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Service:"}),["all","simbad","ned","vizier"].map(f=>e.jsxs("label",{className:"flex items-center gap-1 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"sesame-service",value:f,checked:m===f,onChange:()=>o(f),className:"w-4 h-4 text-vast-green"}),e.jsx("span",{className:"capitalize",children:f==="all"?"All":f.toUpperCase()})]},f))]}),i&&e.jsxs("div",{className:"text-red-600 text-sm flex items-center gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),i]}),x&&e.jsxs("div",{className:"text-green-600 text-sm flex items-center gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsxs("span",{children:["Resolved: RA=",x.ra.toFixed(6),"°, Dec=",x.dec.toFixed(6),"°"]})]})]})},Y=({values:d,onChange:y,className:h=""})=>{const u=(o,a,n)=>{const i=d[o]||{type:"peak"};y({...d,[o]:{...i,[a]:a==="type"?n:n===""?void 0:Number(n)}})},m=(o,a,n)=>{const i=d[a]||{type:"peak"};return e.jsxs("div",{className:"form-group",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("label",{className:"form-label mb-0 font-semibold",children:o}),e.jsx("span",{className:"text-gray-400 cursor-help",title:n,children:e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("input",{type:"number",value:i.min??"",onChange:p=>u(a,"min",p.target.value),placeholder:"Min (mJy)",step:"0.01",className:"form-control"}),e.jsx("input",{type:"number",value:i.max??"",onChange:p=>u(a,"max",p.target.value),placeholder:"Max (mJy)",step:"0.01",className:"form-control"}),e.jsxs("select",{value:i.type||"peak",onChange:p=>u(a,"type",p.target.value),className:"form-select",children:[e.jsx("option",{value:"peak",children:"Peak Flux"}),e.jsx("option",{value:"int",children:"Int Flux"})]})]})]})};return e.jsxs("div",{className:`space-y-4 ${h}`,children:[m("Min. Flux","minFlux","The minimum flux of a source. Peak or integrated flux can be selected."),m("Max. Flux","maxFlux","The maximum flux of a source. Peak or integrated flux can be selected."),m("Avg. Flux","avgFlux","The average flux of a source. Peak or integrated flux can be selected.")]})},ee=({values:d,onChange:y,className:h=""})=>{const u=(o,a,n)=>{const i=d[o]||{type:"peak"};y({...d,[o]:{...i,[a]:a==="type"?n:n===""?void 0:Number(n)}})},m=(o,a,n,i=!0)=>{const p=d[a]||{type:"peak"};return e.jsxs("div",{className:"form-group",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("label",{className:"form-label mb-0 font-semibold",children:o}),e.jsx("span",{className:"text-gray-400 cursor-help",title:n,children:e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:`grid ${i?"grid-cols-3":"grid-cols-2"} gap-2`,children:[e.jsx("input",{type:"number",value:p.min??"",onChange:x=>u(a,"min",x.target.value),placeholder:"Min",step:"0.01",className:"form-control"}),e.jsx("input",{type:"number",value:p.max??"",onChange:x=>u(a,"max",x.target.value),placeholder:"Max",step:"0.01",className:"form-control"}),i&&e.jsxs("select",{value:p.type||"peak",onChange:x=>u(a,"type",x.target.value),className:"form-select",children:[e.jsx("option",{value:"peak",children:"Peak Flux"}),e.jsx("option",{value:"int",children:"Int Flux"})]})]})]})};return e.jsxs("div",{className:`space-y-4 ${h}`,children:[m("η (Eta) Metric","eta","The weighted reduced chi-squared variability metric. Higher values indicate more variability."),m("V Metric","v","The variability index, equivalent to fractional variability. V = σ/μ."),m("Max |Vs| Metric","vs","The maximum two-epoch variability t-statistic value derived from the source."),m("Max |m| Metric","m","The maximum two-epoch modulation index derived from the source (measure of variability).")]})},te=({availableTags:d,includeTags:y,excludeTags:h,onIncludeChange:u,onExcludeChange:m,className:o=""})=>{const[a,n]=c.useState(""),[i,p]=c.useState(""),[x,N]=c.useState(!1),[$,M]=c.useState(!1),C=(v,l)=>{if(!v.trim())return[];const j=v.toLowerCase();return d.filter(k=>k.toLowerCase().includes(j)&&!l.includes(k)).slice(0,10)},f=(v,l,j,k)=>{l.includes(v)||j([...l,v]),k("")},g=(v,l,j)=>{j(l.filter(k=>k!==v))},b=(v,l,j,k,R,I,A,r)=>{const w=C(l,k);return e.jsxs("div",{className:"form-group",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("label",{className:"form-label mb-0 font-semibold",children:v}),e.jsx("span",{className:"text-gray-400 cursor-help",title:r,children:e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})})})]}),k.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mb-2",children:k.map(t=>e.jsxs("span",{className:"badge badge-secondary flex items-center gap-1",children:[t,e.jsx("button",{onClick:()=>g(t,k,R),className:"hover:text-red-500",children:"×"})]},t))}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:l,onChange:t=>{j(t.target.value),A(!0)},onFocus:()=>A(!0),onBlur:()=>setTimeout(()=>A(!1),200),onKeyDown:t=>{t.key==="Enter"&&l.trim()&&(t.preventDefault(),w.length>0?f(w[0],k,R,j):d.includes(l.trim())&&f(l.trim(),k,R,j))},placeholder:"Type to search tags...",className:"form-control w-full"}),I&&w.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-48 overflow-auto",children:w.map(t=>e.jsx("button",{onClick:()=>f(t,k,R,j),className:"w-full text-left px-3 py-2 hover:bg-gray-100 text-sm",children:t},t))})]})]})};return e.jsxs("div",{className:`space-y-4 ${o}`,children:[b("Include Tags",a,n,y,u,x,N,"Only return sources that have the given tags."),b("Exclude Tags",i,p,h,m,$,M,"Only return sources that do NOT have the given tags.")]})};function se(d){if(!d||typeof d!="string")return null;const y=d.trim();if(!y)return null;const h=parseFloat(y);if(!isNaN(h)&&!y.includes(":")&&!y.match(/[hms°'"]/i))return h>=0&&h<360?h:h>=0&&h<24?h*15:null;const u=y.match(/^(\d{1,2})(?:h|:|\s)\s*(\d{1,2})(?:m|:|\s)\s*(\d{1,2}(?:\.\d+)?)\s*s?$/i);if(u){const o=parseInt(u[1],10),a=parseInt(u[2],10),n=parseFloat(u[3]);if(o>=0&&o<24&&a>=0&&a<60&&n>=0&&n<60)return(o+a/60+n/3600)*15}const m=y.match(/^(\d{1,2})(?:h|:|\s)\s*(\d{1,2})(?:m)?$/i);if(m){const o=parseInt(m[1],10),a=parseInt(m[2],10);if(o>=0&&o<24&&a>=0&&a<60)return(o+a/60)*15}return null}function ae(d){if(!d||typeof d!="string")return null;const y=d.trim();if(!y)return null;let h=1,u=y;u.startsWith("-")?(h=-1,u=u.slice(1).trim()):u.startsWith("+")&&(u=u.slice(1).trim());const m=parseFloat(u);if(!isNaN(m)&&!u.includes(":")&&!u.match(/[dms°'"]/i)){const n=h*m;return n>=-90&&n<=90?n:null}const o=u.match(/^(\d{1,2})(?:d|°|:|\s)\s*(\d{1,2})(?:m|'|:|\s)\s*(\d{1,2}(?:\.\d+)?)\s*(?:s|")?$/i);if(o){const n=parseInt(o[1],10),i=parseInt(o[2],10),p=parseFloat(o[3]);if(n>=0&&n<=90&&i>=0&&i<60&&p>=0&&p<60){const x=n+i/60+p/3600,N=h*x;if(N>=-90&&N<=90)return N}}const a=u.match(/^(\d{1,2})(?:d|°|:|\s)\s*(\d{1,2})(?:m|')?$/i);if(a){const n=parseInt(a[1],10),i=parseInt(a[2],10);if(n>=0&&n<=90&&i>=0&&i<60){const p=n+i/60,x=h*p;if(x>=-90&&x<=90)return x}}return null}const B={radiusUnit:"arcmin",coordFrame:"icrs",includeTags:[],excludeTags:[]},ne=({runs:d=[],availableTags:y=[],onSubmit:h,onReset:u,initialParams:m,className:o=""})=>{const[a,n]=c.useState({...B,...m}),[i,p]=c.useState(new Set(["cone","filters"])),[x,N]=c.useState({}),[$,M]=c.useState(m?.ra?.toString()??""),[C,f]=c.useState(m?.dec?.toString()??""),g=q.useRef(null),b=c.useCallback(()=>{const t=window.location.hash.slice(1);if(!t)return{};const s={};return t.split("&").forEach(F=>{const[T,L]=F.split("=");if(!T||!L)return;const S=decodeURIComponent(L);switch(T){case"ra":s.ra=parseFloat(S);break;case"dec":s.dec=parseFloat(S);break;case"radius":s.radius=parseFloat(S);break;case"radius_unit":["arcsec","arcmin","deg"].includes(S)&&(s.radiusUnit=S);break;case"coord_frame":["icrs","galactic"].includes(S)&&(s.coordFrame=S);break;case"new_source":s.newSource=S==="true";break;case"no_siblings":s.noSiblings=S==="true";break;case"run_name":s.runName=S;break;case"include_tags":s.includeTags=S.split(",").filter(Boolean);break;case"exclude_tags":s.excludeTags=S.split(",").filter(Boolean);break;case"min_flux_min":s.minFlux={...s.minFlux,min:parseFloat(S),type:"peak"};break;case"min_flux_max":s.minFlux={...s.minFlux,max:parseFloat(S),type:"peak"};break;case"max_flux_min":s.maxFlux={...s.maxFlux,min:parseFloat(S),type:"peak"};break;case"max_flux_max":s.maxFlux={...s.maxFlux,max:parseFloat(S),type:"peak"};break;case"eta_min":s.eta={...s.eta,min:parseFloat(S),type:"peak"};break;case"eta_max":s.eta={...s.eta,max:parseFloat(S),type:"peak"};break;case"v_min":s.v={...s.v,min:parseFloat(S),type:"peak"};break;case"v_max":s.v={...s.v,max:parseFloat(S),type:"peak"};break}}),s},[]),v=c.useCallback(t=>{const s=[];t.ra!=null&&s.push(`ra=${t.ra.toFixed(6)}`),t.dec!=null&&s.push(`dec=${t.dec.toFixed(6)}`),t.radius!=null&&s.push(`radius=${t.radius}`),t.radiusUnit!==B.radiusUnit&&s.push(`radius_unit=${t.radiusUnit}`),t.coordFrame!==B.coordFrame&&s.push(`coord_frame=${t.coordFrame}`),t.newSource&&s.push("new_source=true"),t.noSiblings&&s.push("no_siblings=true"),t.runName&&s.push(`run_name=${encodeURIComponent(t.runName)}`),t.includeTags.length>0&&s.push(`include_tags=${t.includeTags.map(encodeURIComponent).join(",")}`),t.excludeTags.length>0&&s.push(`exclude_tags=${t.excludeTags.map(encodeURIComponent).join(",")}`),t.minFlux?.min!=null&&s.push(`min_flux_min=${t.minFlux.min}`),t.minFlux?.max!=null&&s.push(`min_flux_max=${t.minFlux.max}`),t.maxFlux?.min!=null&&s.push(`max_flux_min=${t.maxFlux.min}`),t.maxFlux?.max!=null&&s.push(`max_flux_max=${t.maxFlux.max}`),t.eta?.min!=null&&s.push(`eta_min=${t.eta.min}`),t.eta?.max!=null&&s.push(`eta_max=${t.eta.max}`),t.v?.min!=null&&s.push(`v_min=${t.v.min}`),t.v?.max!=null&&s.push(`v_max=${t.v.max}`);const F=s.length>0?`#${s.join("&")}`:"";window.location.hash!==F&&window.history.replaceState(null,"",F||window.location.pathname)},[]),l=c.useCallback(t=>{const s={};return t.ra!=null&&(t.ra<0||t.ra>360)&&(s.ra="RA must be between 0 and 360 degrees"),t.dec!=null&&(t.dec<-90||t.dec>90)&&(s.dec="Dec must be between -90 and 90 degrees"),t.radius!=null&&t.radius<0&&(s.radius="Radius must be non-negative"),(t.ra!=null||t.dec!=null||t.radius!=null)&&(t.ra==null||t.dec==null||t.radius==null)&&(t.ra==null&&(s.ra="RA required for cone search"),t.dec==null&&(s.dec="Dec required for cone search"),t.radius==null&&(s.radius="Radius required for cone search")),s},[]);c.useEffect(()=>{const t=b();Object.keys(t).length>0&&n(s=>({...s,...t}))},[b]),c.useEffect(()=>(g.current&&window.clearTimeout(g.current),g.current=window.setTimeout(()=>{v(a),N(l(a))},500),()=>{g.current&&window.clearTimeout(g.current)}),[a,v,l]);const j=c.useCallback(t=>{p(s=>{const F=new Set(s);return F.has(t)?F.delete(t):F.add(t),F})},[]),k=c.useCallback((t,s)=>{n(F=>({...F,ra:t,dec:s})),M(t.toFixed(6)),f(s.toFixed(6))},[]),R=c.useCallback(()=>{n({...B}),N({}),M(""),f(""),window.history.replaceState(null,"",window.location.pathname),u?.()},[u]),I=c.useCallback(()=>{const t=l(a);N(t),Object.keys(t).length===0&&h(a)},[a,h,l]),A=c.useMemo(()=>{let t=0;return a.ra!=null&&a.dec!=null&&t++,(a.minFlux?.min!=null||a.minFlux?.max!=null)&&t++,(a.maxFlux?.min!=null||a.maxFlux?.max!=null)&&t++,(a.avgFlux?.min!=null||a.avgFlux?.max!=null)&&t++,(a.eta?.min!=null||a.eta?.max!=null)&&t++,(a.v?.min!=null||a.v?.max!=null)&&t++,(a.snrMin?.min!=null||a.snrMin?.max!=null)&&t++,(a.snrMax?.min!=null||a.snrMax?.max!=null)&&t++,(a.datapoints?.min!=null||a.datapoints?.max!=null)&&t++,a.newSource&&t++,a.noSiblings&&t++,a.includeTags.length>0&&t++,a.excludeTags.length>0&&t++,a.runName&&t++,t},[a]),r=Object.keys(x).length>0,w=(t,s,F)=>{const T=i.has(t);return e.jsxs("div",{className:"border-b border-gray-200",children:[e.jsxs("button",{onClick:()=>j(t),className:"w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:s}),e.jsx("svg",{className:`w-5 h-5 text-gray-500 transition-transform ${T?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),T&&e.jsx("div",{className:"p-4 space-y-4",children:F})]})};return e.jsxs("div",{className:`card ${o}`,children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsxs("h4",{className:"text-lg font-semibold flex items-center gap-2",children:["Source Query",A>0&&e.jsxs("span",{className:"badge badge-primary",children:[A," filters"]})]}),e.jsx("button",{onClick:R,className:"text-sm text-gray-500 hover:text-red-500",children:"Reset all"})]}),e.jsxs("div",{className:"divide-y divide-gray-200",children:[w("source","Data Source",e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Pipeline Run"}),e.jsxs("select",{value:a.runName||"",onChange:t=>n(s=>({...s,runName:t.target.value||void 0})),className:"form-select w-full",children:[e.jsx("option",{value:"",children:"All Runs"}),d.map(t=>e.jsx("option",{value:t.name,children:t.name},t.id))]})]})),w("cone","Cone Search",e.jsxs(e.Fragment,{children:[e.jsx(X,{onResolved:k}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"RA (deg or HMS)"}),e.jsx("input",{type:"text",value:$,onChange:t=>{const s=t.target.value;M(s);const F=se(s);n(T=>({...T,ra:F??void 0}))},onBlur:()=>{a.ra!=null&&M(a.ra.toFixed(6))},placeholder:"180.0 or 12:00:00",className:`form-control ${x.ra?"border-red-500":""}`}),x.ra&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:x.ra})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Dec (deg or DMS)"}),e.jsx("input",{type:"text",value:C,onChange:t=>{const s=t.target.value;f(s);const F=ae(s);n(T=>({...T,dec:F??void 0}))},onBlur:()=>{a.dec!=null&&f(a.dec.toFixed(6))},placeholder:"+45.0 or +45:00:00",className:`form-control ${x.dec?"border-red-500":""}`}),x.dec&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:x.dec})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Radius"}),e.jsx("input",{type:"number",value:a.radius??"",onChange:t=>n(s=>({...s,radius:t.target.value?parseFloat(t.target.value):void 0})),placeholder:"2",min:0,step:.1,className:`form-control ${x.radius?"border-red-500":""}`}),x.radius&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:x.radius})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Unit"}),e.jsxs("select",{value:a.radiusUnit,onChange:t=>n(s=>({...s,radiusUnit:t.target.value})),className:"form-select",children:[e.jsx("option",{value:"arcsec",children:"arcsec"}),e.jsx("option",{value:"arcmin",children:"arcmin"}),e.jsx("option",{value:"deg",children:"deg"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Frame"}),e.jsxs("select",{value:a.coordFrame,onChange:t=>n(s=>({...s,coordFrame:t.target.value})),className:"form-select",children:[e.jsx("option",{value:"icrs",children:"ICRS"}),e.jsx("option",{value:"galactic",children:"Galactic"})]})]})]})]})),w("flux","Flux Filters",e.jsx(Y,{values:{minFlux:a.minFlux,maxFlux:a.maxFlux,avgFlux:a.avgFlux},onChange:t=>n(s=>({...s,...t}))})),w("variability","Variability Metrics",e.jsx(ee,{values:{eta:a.eta,v:a.v,vs:a.vs,m:a.m},onChange:t=>n(s=>({...s,...t}))})),w("snr","SNR & Data Counts",e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Min SNR"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"number",value:a.snrMin?.min??"",onChange:t=>n(s=>({...s,snrMin:{...s.snrMin,min:t.target.value?Number(t.target.value):void 0}})),placeholder:"Min",className:"form-control"}),e.jsx("input",{type:"number",value:a.snrMin?.max??"",onChange:t=>n(s=>({...s,snrMin:{...s.snrMin,max:t.target.value?Number(t.target.value):void 0}})),placeholder:"Max",className:"form-control"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Max SNR"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"number",value:a.snrMax?.min??"",onChange:t=>n(s=>({...s,snrMax:{...s.snrMax,min:t.target.value?Number(t.target.value):void 0}})),placeholder:"Min",className:"form-control"}),e.jsx("input",{type:"number",value:a.snrMax?.max??"",onChange:t=>n(s=>({...s,snrMax:{...s.snrMax,max:t.target.value?Number(t.target.value):void 0}})),placeholder:"Max",className:"form-control"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Datapoints"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"number",value:a.datapoints?.min??"",onChange:t=>n(s=>({...s,datapoints:{...s.datapoints,min:t.target.value?Number(t.target.value):void 0}})),placeholder:"Min",min:1,className:"form-control"}),e.jsx("input",{type:"number",value:a.datapoints?.max??"",onChange:t=>n(s=>({...s,datapoints:{...s.datapoints,max:t.target.value?Number(t.target.value):void 0}})),placeholder:"Max",min:1,className:"form-control"})]})]})]})),w("flags","Source Type",e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.newSource||!1,onChange:t=>n(s=>({...s,newSource:t.target.checked})),className:"w-4 h-4 text-vast-green rounded"}),e.jsx("span",{children:"New source"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"(appeared after first observation)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.noSiblings||!1,onChange:t=>n(s=>({...s,noSiblings:t.target.checked})),className:"w-4 h-4 text-vast-green rounded"}),e.jsx("span",{children:"No siblings"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"(no multi-component islands)"})]})]})),w("tags","Tags",e.jsx(te,{availableTags:y,includeTags:a.includeTags,excludeTags:a.excludeTags,onIncludeChange:t=>n(s=>({...s,includeTags:t})),onExcludeChange:t=>n(s=>({...s,excludeTags:t}))}))]}),r&&e.jsx("div",{className:"px-4 py-2 bg-red-50 border-t border-red-200",children:e.jsx("ul",{className:"text-sm text-red-600 list-disc list-inside",children:Object.entries(x).map(([t,s])=>e.jsx("li",{children:s},t))})}),e.jsxs("div",{className:"p-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-2",children:[e.jsx("button",{onClick:R,className:"btn btn-secondary",children:"Reset"}),e.jsx("button",{onClick:I,className:`btn btn-primary ${r?"opacity-75":""}`,disabled:r,children:"Search"})]})]})},le=({etaThreshold:d,vThreshold:y,etaSigma:h,vSigma:u,useSigmaThreshold:m,minDataPoints:o,colorBy:a,onChange:n})=>e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:m,onChange:i=>n({useSigmaThreshold:i.target.checked}),className:"w-4 h-4 rounded"}),e.jsx("span",{className:"text-sm",children:"Use σ-based thresholds"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Calculate thresholds dynamically based on standard deviation"})]}),m&&e.jsxs("div",{className:"space-y-3 pl-2 border-l-2 border-primary",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center justify-between text-sm mb-1",children:[e.jsxs("span",{children:["η threshold: ",h,"σ"]}),e.jsx("span",{className:"text-gray-500 text-xs",children:"above mean"})]}),e.jsx("input",{type:"range",min:1,max:5,step:.5,value:h,onChange:i=>n({etaSigma:parseFloat(i.target.value)}),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center justify-between text-sm mb-1",children:[e.jsxs("span",{children:["V threshold: ",u,"σ"]}),e.jsx("span",{className:"text-gray-500 text-xs",children:"above mean"})]}),e.jsx("input",{type:"range",min:1,max:5,step:.5,value:u,onChange:i=>n({vSigma:parseFloat(i.target.value)}),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"})]})]}),!m&&e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"η threshold"}),e.jsx("input",{type:"number",value:d,onChange:i=>n({etaThreshold:parseFloat(i.target.value)||0}),step:.1,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"V threshold"}),e.jsx("input",{type:"number",value:y,onChange:i=>n({vThreshold:parseFloat(i.target.value)||0}),step:.01,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-1",children:["Min data points: ",o]}),e.jsx("input",{type:"range",min:2,max:20,value:o,onChange:i=>n({minDataPoints:parseInt(i.target.value,10)}),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-400",children:[e.jsx("span",{children:"2"}),e.jsx("span",{children:"20"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Color by"}),e.jsxs("select",{value:a,onChange:i=>n({colorBy:i.target.value}),className:"w-full px-2 py-1 border border-gray-300 rounded text-sm",children:[e.jsx("option",{value:"variability",children:"Variability (η × V)"}),e.jsx("option",{value:"flux",children:"Peak Flux"}),e.jsx("option",{value:"measurements",children:"N Measurements"}),e.jsx("option",{value:"none",children:"No color gradient"})]})]})]}),K=({sourceId:d,name:y,ra:h,dec:u,eta:m,v:o,peakFlux:a,nMeasurements:n,position:i,isHover:p=!0,onNavigate:x,onClose:N})=>{const $=(C,f)=>{if(f){const g=C/15,b=Math.floor(g),v=Math.floor((g-b)*60),l=((g-b-v/60)*3600).toFixed(2);return`${b}h ${v}m ${l}s`}else{const g=C>=0?"+":"",b=Math.floor(Math.abs(C)),v=Math.floor((Math.abs(C)-b)*60),l=((Math.abs(C)-b-v/60)*3600).toFixed(1);return`${g}${b}° ${v}' ${l}"`}},M=i?{position:"absolute",left:i.x+10,top:i.y+10,zIndex:1e3}:{};return e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg shadow-lg p-3 ${p?"min-w-48":"min-w-64"}`,style:M,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-800 truncate",children:y||d}),!p&&N&&e.jsx("button",{onClick:N,className:"text-gray-400 hover:text-gray-600 text-lg leading-none",children:"×"})]}),e.jsxs("div",{className:"text-xs text-gray-500 mb-2",children:[e.jsxs("div",{children:["RA: ",$(h,!0)]}),e.jsxs("div",{children:["Dec: ",$(u,!1)]})]}),e.jsxs("div",{className:"flex gap-4 mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-primary",children:m.toFixed(2)}),e.jsx("div",{className:"text-xs text-gray-500",children:"η"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-primary",children:o.toFixed(3)}),e.jsx("div",{className:"text-xs text-gray-500",children:"V"})]}),a!==void 0&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-700",children:a.toFixed(2)}),e.jsx("div",{className:"text-xs text-gray-500",children:"mJy"})]}),n!==void 0&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-700",children:n}),e.jsx("div",{className:"text-xs text-gray-500",children:"pts"})]})]}),!p&&x&&e.jsx("button",{onClick:()=>x(d),className:"w-full text-sm bg-primary text-white py-1.5 rounded hover:bg-primary-dark transition-colors",children:"View Source Details"})]})},re=({sources:d,isLoading:y=!1,onSourceSelect:h,height:u=500,className:m=""})=>{const o=c.useRef(null),a=c.useRef(null),[n,i]=c.useState({etaThreshold:1.5,vThreshold:.1,etaSigma:2,vSigma:2,useSigmaThreshold:!0,minDataPoints:3,colorBy:"variability"}),[p,x]=c.useState(null),[N,$]=c.useState({x:0,y:0}),[M,C]=c.useState(null);c.useEffect(()=>{const r=w=>{w.key==="Escape"&&M&&C(null)};if(M)return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[M]);const f=c.useCallback(()=>{if(!n.useSigmaThreshold||d.length===0)return{etaLine:n.etaThreshold,vLine:n.vThreshold};const r=d.map(E=>E.eta),w=d.map(E=>E.v),t=E=>E.reduce((z,D)=>z+D,0)/E.length,s=E=>{const z=t(E);return Math.sqrt(E.reduce((D,V)=>D+(V-z)**2,0)/E.length)},F=t(r),T=s(r),L=t(w),S=s(w);return{etaLine:F+n.etaSigma*T,vLine:L+n.vSigma*S}},[d,n]),g=c.useMemo(()=>d.filter(r=>(r.nMeasurements??10)>=n.minDataPoints&&r.eta>0&&r.v>0),[d,n.minDataPoints]),b=d.length-g.length,{etaLine:v,vLine:l}=f(),j=c.useMemo(()=>g.filter(r=>r.eta>v&&r.v>l),[g,v,l]),k=c.useMemo(()=>g.length===0?{variability:1,flux:1,measurements:1}:{variability:Math.max(...g.map(r=>r.eta*r.v),1),flux:Math.max(...g.map(r=>r.peakFlux??0),1),measurements:Math.max(...g.map(r=>r.nMeasurements??0),1)},[g]),R=c.useCallback((r,w)=>{if(w)return"#ff0000";if(n.colorBy==="none")return"rgba(79, 195, 161, 0.6)";let t=0,s=1;switch(n.colorBy){case"variability":t=r.eta*r.v,s=k.variability;break;case"flux":t=r.peakFlux??0,s=k.flux;break;case"measurements":t=r.nMeasurements??0,s=k.measurements;break}const F=Math.min(t/s,1),T=Math.round(79+F*161),L=Math.round(195+F*3),S=Math.round(161-F*45);return`rgba(${T}, ${L}, ${S}, 0.7)`},[n.colorBy,k]);c.useEffect(()=>{if(!o.current)return;a.current=Z(o.current);const r=()=>{a.current?.resize()};return window.addEventListener("resize",r),()=>{window.removeEventListener("resize",r),a.current?.dispose()}},[]),c.useEffect(()=>{if(!a.current||y)return;const r=new Set(j.map(_=>_.id)),w=g.map(_=>({value:[_.eta,_.v],itemStyle:{color:R(_,r.has(_.id))},symbolSize:r.has(_.id)?10:6,source:_})),t=g.map(_=>_.eta),s=g.map(_=>_.v),F=Math.min(...t)*.5,T=Math.max(...t)*2,L=Math.min(...s)*.5,S=Math.max(...s)*2,E=b>0?` (${b} excluded: η≤0 or v≤0)`:"",D={title:{text:"η-V Variability Plot",subtext:`${g.length} sources, ${j.length} candidates${E}`,left:"center",textStyle:{color:"#324960",fontSize:16},subtextStyle:{color:"#666"}},tooltip:{trigger:"item",formatter:()=>"",show:!1},xAxis:{name:"η (eta)",nameLocation:"middle",nameGap:30,type:"log",axisLabel:{formatter:"{value}"}},yAxis:{name:"V",nameLocation:"middle",nameGap:40,type:"log"},series:[{type:"scatter",data:w,emphasis:{itemStyle:{borderColor:"#324960",borderWidth:2}}},{type:"line",markLine:{silent:!0,symbol:"none",lineStyle:{color:"#ff6b6b",type:"dashed",width:2},data:[[{xAxis:v,yAxis:L},{xAxis:v,yAxis:S}]],label:{formatter:`η = ${v.toFixed(2)}`,position:"end"}}},{type:"line",markLine:{silent:!0,symbol:"none",lineStyle:{color:"#ff6b6b",type:"dashed",width:2},data:[[{xAxis:F,yAxis:l},{xAxis:T,yAxis:l}]],label:{formatter:`V = ${l.toFixed(3)}`,position:"end"}}}],toolbox:{right:20,feature:{dataZoom:{title:{zoom:"Zoom",back:"Reset"}},restore:{title:"Reset"},saveAsImage:{title:"Save"}}},dataZoom:[{type:"inside",xAxisIndex:0},{type:"inside",yAxisIndex:0}]};a.current.setOption(D,{notMerge:!1});const V=a.current;V.off("mouseover"),V.off("mouseout"),V.off("click"),V.on("mouseover",_=>{if(_.componentType==="series"&&_.data?.source){const H=_.event?.event;x(_.data.source),H&&$({x:H.clientX,y:H.clientY})}}),V.on("mouseout",()=>{x(null)}),V.on("click",_=>{_.componentType==="series"&&_.data?.source&&(C(_.data.source),x(null))})},[g,b,j,n,y,v,l,R]);const I=r=>{i(w=>({...w,...r}))},A=r=>{h?.(r),C(null)};return e.jsxs("div",{className:`${m}`,children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[y?e.jsx("div",{className:"flex items-center justify-center bg-gray-50 rounded-lg",style:{height:u},children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"}),e.jsx("span",{className:"text-gray-500",children:"Loading sources..."})]})}):e.jsx("div",{ref:o,style:{height:u,width:"100%"}}),p&&e.jsx(K,{...p,sourceId:p.id,position:N,isHover:!0})]}),e.jsxs("div",{className:"w-64 flex-shrink-0",children:[e.jsx(le,{...n,onChange:I}),j.length>0&&e.jsxs("div",{className:"mt-4 bg-red-50 border border-red-200 rounded-lg p-3",children:[e.jsxs("h4",{className:"font-semibold text-red-700 text-sm mb-2",children:["Candidates (",j.length,")"]}),e.jsxs("div",{className:"max-h-40 overflow-y-auto space-y-1",children:[j.slice(0,10).map(r=>e.jsxs("button",{onClick:()=>C(r),className:"w-full text-left text-xs p-1.5 bg-white rounded hover:bg-red-100 transition-colors",children:[e.jsx("span",{className:"font-medium",children:r.name||r.id}),e.jsxs("span",{className:"text-gray-500 ml-2",children:["η=",r.eta.toFixed(2),", V=",r.v.toFixed(3)]})]},r.id)),j.length>10&&e.jsxs("p",{className:"text-xs text-red-500",children:["+",j.length-10," more"]})]})]})]})]}),M&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsx(K,{...M,sourceId:M.id,isHover:!1,onNavigate:A,onClose:()=>C(null)})})]})},me=()=>{const{data:d,isLoading:y,error:h}=W(),[u,m]=c.useState("list"),[o,a]=c.useState({}),n=U(l=>l.selectedSources),i=U(l=>l.toggleSourceSelection),p=U(l=>l.selectAllSources),x=U(l=>l.clearSourceSelection),N=c.useMemo(()=>Array.from(n),[n]),$=c.useCallback(()=>{if(N.length===0)return;window.open(`https://ronnie-unsectarian-antone.ngrok-free.dev/api/sources/export?ids=${N.join(",")}`,"_blank")},[N]),M=c.useMemo(()=>{if(!d)return[];let l=d;if(o.ra!==void 0&&o.dec!==void 0&&o.radius){const{ra:j,dec:k,radius:R}=o;l=l.filter(I=>{if(I.ra_deg===void 0||I.dec_deg===void 0)return!1;const A=(I.ra_deg-j)*Math.cos(k*Math.PI/180),r=I.dec_deg-k;return Math.sqrt(A*A+r*r)*60<=R})}return o.minFlux!==void 0&&(l=l.filter(j=>(j.peak_flux_jy??0)>=(o.minFlux??0))),o.maxFlux!==void 0&&(l=l.filter(j=>(j.peak_flux_jy??1/0)<=(o.maxFlux??1/0))),l},[d,o]),{sortColumn:C,sortDirection:f,handleSort:g,sortedData:b}=G(M),v=c.useMemo(()=>d?d.filter(l=>l.eta!==void 0&&l.v!==void 0&&l.ra_deg!==void 0&&l.dec_deg!==void 0).map(l=>({id:l.id,name:l.name||l.id,ra:l.ra_deg,dec:l.dec_deg,eta:l.eta,v:l.v,peakFlux:l.peak_flux_jy,nMeasurements:l.num_images})):[],[d]);return y?e.jsx(Q,{label:"Loading sources..."}):h?e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg",children:["Failed to load sources: ",h.message]}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Sources"}),N.length>0&&e.jsxs("span",{className:"text-sm text-gray-500",children:[N.length," selected"]})]}),e.jsxs("div",{className:"flex gap-2",children:[N.length>0&&e.jsx("button",{onClick:$,className:"px-4 py-2 rounded-lg text-sm font-medium bg-green-600 text-white hover:bg-green-700 transition-colors",children:"Export Selected"}),e.jsx("button",{className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${u==="list"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,onClick:()=>m("list"),children:"List View"}),e.jsx("button",{className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${u==="variability"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,onClick:()=>m("variability"),children:"Variability Plot"})]})]}),e.jsx("div",{className:"mb-6",children:e.jsx(ne,{onQueryChange:a})}),u==="variability"?e.jsx("div",{className:"card p-4",children:v.length>0?e.jsx(re,{sources:v,onSourceSelect:l=>window.location.href=`/sources/${l}`,height:500}):e.jsx("p",{className:"text-gray-500 text-center py-8",children:"No variability data available. Sources need η and V values to display the variability plot."})}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["Showing ",M.length," of ",d?.length??0," sources"]}),b&&b.length>0?e.jsx("div",{className:"card overflow-hidden",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-10 px-3 py-3",children:e.jsx("input",{type:"checkbox",checked:N.length===b.length&&b.length>0,ref:l=>{l&&(l.indeterminate=N.length>0&&N.length<b.length)},onChange:()=>{N.length===b.length?x():p(b.map(l=>l.id))},className:"h-4 w-4 text-blue-600 rounded"})}),e.jsx(P,{columnKey:"id",sortColumn:C,sortDirection:f,onSort:g,children:"ID"}),e.jsx(P,{columnKey:"name",sortColumn:C,sortDirection:f,onSort:g,children:"Name"}),e.jsx(P,{columnKey:"ra_deg",sortColumn:C,sortDirection:f,onSort:g,className:"text-right",children:"RA (deg)"}),e.jsx(P,{columnKey:"dec_deg",sortColumn:C,sortDirection:f,onSort:g,className:"text-right",children:"Dec (deg)"}),e.jsx(P,{columnKey:"num_images",sortColumn:C,sortDirection:f,onSort:g,className:"text-center",children:"Images"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:b.map(l=>e.jsxs("tr",{className:n.has(l.id)?"bg-blue-50":"",children:[e.jsx("td",{className:"px-3",children:e.jsx("input",{type:"checkbox",checked:n.has(l.id),onChange:()=>i(l.id),className:"h-4 w-4 text-blue-600 rounded"})}),e.jsx("td",{children:e.jsx(J,{to:`/sources/${l.id}`,className:"text-blue-600 hover:text-blue-800 font-medium",children:l.id})}),e.jsx("td",{children:l.name||"—"}),e.jsx("td",{className:"text-right font-mono",children:l.ra_deg?.toFixed(4)}),e.jsx("td",{className:"text-right font-mono",children:l.dec_deg?.toFixed(4)}),e.jsx("td",{className:"text-center",children:l.num_images??"—"})]},l.id))})]})}):e.jsx("p",{className:"text-gray-500",children:"No sources found."})]})]})};export{me as default};
//# sourceMappingURL=SourcesListPage-BdmH7HxR.js.map
