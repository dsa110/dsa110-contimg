import{r as c,j as e,R as K,L as q}from"./index-BOrBXAqY.js";import{a as G}from"./useQueries-DFTIwMW8.js";import{a as U,L as W}from"./appStore-B80PI1oS.js";import{M as Q}from"./Modal-D4Tjwaza.js";import{u as Z,S as z}from"./SortableTableHeader-BnZKltvY.js";import{init as Y}from"./echarts-BlxdVhSE.js";import{R as X}from"./RangeSlider-BA6L0Hbu.js";const ee=({filters:o,values:v,onChange:y,onApply:h,onReset:f,className:u=""})=>{const[a,n]=c.useState(new Set(["all"])),d=c.useMemo(()=>{const r={};return o.forEach(b=>{const l=b.group||"General";r[l]||(r[l]=[]),r[l].push(b)}),r},[o]),g=c.useCallback(r=>{n(b=>{const l=new Set(b);return l.has(r)?l.delete(r):l.add(r),l})},[]),m=c.useCallback((r,b)=>{y({...v,[r]:b})},[v,y]),M=c.useMemo(()=>{let r=0;return Object.entries(v).forEach(([b,l])=>{const p=o.find(j=>j.id===b);if(p)if(p.type==="range"){const j=l;j&&(j.min!==p.min||j.max!==p.max)&&r++}else if(p.type==="checkbox")Array.isArray(l)&&l.length>0&&r++;else if(p.type==="cone-search"){const j=l;(j?.ra||j?.dec||j?.radius)&&r++}else l&&r++}),r},[v,o]),$=r=>{switch(r.type){case"range":{const l=v[r.id];return e.jsx(X,{min:r.min??0,max:r.max??100,step:r.step,unit:r.unit,minValue:l?.min,maxValue:l?.max,onChange:(p,j)=>m(r.id,{min:p,max:j}),histogram:r.histogram})}case"select":return e.jsxs("select",{value:v[r.id]||"",onChange:l=>m(r.id,l.target.value),className:"form-select w-full",children:[e.jsx("option",{value:"",children:"All"}),r.options?.map(l=>e.jsxs("option",{value:l.value,children:[l.label,l.count!==void 0&&` (${l.count})`]},l.value))]});case"checkbox":return e.jsx("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:r.options?.map(l=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:(v[r.id]||[]).includes(l.value),onChange:p=>{const j=v[r.id]||[],x=p.target.checked?[...j,l.value]:j.filter(N=>N!==l.value);m(r.id,x)},className:"w-4 h-4 text-vast-green rounded border-gray-300 focus:ring-vast-green"}),e.jsx("span",{children:l.label}),l.count!==void 0&&e.jsxs("span",{className:"text-gray-400",children:["(",l.count,")"]})]},l.value))});case"text":return e.jsx("input",{type:"text",value:v[r.id]||"",onChange:l=>m(r.id,l.target.value),placeholder:r.placeholder||`Search ${r.label.toLowerCase()}...`,className:"form-control w-full"});case"cone-search":const b=v[r.id]||{ra:"",dec:"",radius:"2"};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"RA (deg or HMS)"}),e.jsx("input",{type:"text",value:b.ra,onChange:l=>m(r.id,{...b,ra:l.target.value}),placeholder:"180.0 or 12:00:00",className:"form-control w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Dec (deg or DMS)"}),e.jsx("input",{type:"text",value:b.dec,onChange:l=>m(r.id,{...b,dec:l.target.value}),placeholder:"+45.0 or +45:00:00",className:"form-control w-full"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Radius (arcmin)"}),e.jsx("input",{type:"number",value:b.radius,onChange:l=>m(r.id,{...b,radius:l.target.value}),min:.1,max:60,step:.5,className:"form-control w-full"})]})]});default:return null}};return e.jsxs("div",{className:`card ${u}`,children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsxs("h4",{className:"text-lg font-semibold flex items-center gap-2",children:["Filters",M>0&&e.jsxs("span",{className:"badge badge-primary",children:[M," active"]})]}),e.jsx("button",{onClick:f,className:"text-sm text-gray-500 hover:text-red-500",children:"Reset all"})]}),e.jsx("div",{className:"divide-y divide-gray-200",children:Object.entries(d).map(([r,b])=>e.jsxs("div",{className:"accordion-group",children:[e.jsxs("button",{onClick:()=>g(r),className:"w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsx("span",{className:"font-medium text-gray-700",children:r}),e.jsx("svg",{className:`w-5 h-5 text-gray-500 transition-transform ${a.has(r)?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),a.has(r)&&e.jsx("div",{className:"p-4 space-y-4",children:b.map(l=>e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"form-label",children:l.label}),$(l)]},l.id))})]},r))}),e.jsx("div",{className:"p-4 border-t border-gray-200 bg-gray-50",children:e.jsx("button",{onClick:h,className:"btn btn-primary w-full",children:"Apply Filters"})})]})},H=new Map,se=({onResolved:o,className:v=""})=>{const[y,h]=c.useState(""),[f,u]=c.useState("all"),[a,n]=c.useState(!1),[d,g]=c.useState(null),[m,M]=c.useState(null),$=c.useRef(null),r=c.useCallback(async()=>{const l=y.trim();if(!l){g("Please enter an object name");return}const p=`${f}:${l.toLowerCase()}`,j=H.get(p);if(j){M(j),g(null),o(j.ra,j.dec,j.objectName);return}$.current&&$.current.abort(),$.current=new AbortController,n(!0),g(null),M(null);try{const N=`https://cdsweb.u-strasbg.fr/cgi-bin/nph-sesame/-oI/${f==="all"?"A":f.charAt(0).toUpperCase()}?${encodeURIComponent(l)}`,F=await fetch(N,{signal:$.current.signal});if(!F.ok)throw new Error(`HTTP error: ${F.status}`);const _=(await F.text()).split(`
`).find(s=>s.startsWith("%J"));if(!_)throw new Error("Could not resolve object. Please check the name and try again.");const I=_.match(/%J\s+([\d.+-]+)\s+([\d.+-]+)/);if(!I)throw new Error("Failed to parse coordinates from response.");const T=parseFloat(I[1]),i=parseFloat(I[2]),k={ra:T,dec:i,objectName:l,service:f};H.set(p,k),M(k),o(T,i,l)}catch(x){if(x instanceof Error&&x.name==="AbortError")return;const N=x instanceof Error?x.message:"Resolution failed";N.includes("fetch")||N.includes("network")?g("Network error. CORS may be blocking the request. Try using a backend proxy."):g(N)}finally{n(!1)}},[y,f,o]),b=l=>{l.key==="Enter"&&r()};return e.jsxs("div",{className:`space-y-3 ${v}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:y,onChange:l=>h(l.target.value),onKeyDown:b,placeholder:"Object name (e.g., M31, Crab Nebula, PSR J0534+2200)",className:"form-control flex-1"}),e.jsx("button",{onClick:r,disabled:a||!y.trim(),className:"btn btn-primary",children:a?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Resolving..."]}):"Resolve"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Service:"}),["all","simbad","ned","vizier"].map(l=>e.jsxs("label",{className:"flex items-center gap-1 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"sesame-service",value:l,checked:f===l,onChange:()=>u(l),className:"w-4 h-4 text-vast-green"}),e.jsx("span",{className:"capitalize",children:l==="all"?"All":l.toUpperCase()})]},l))]}),d&&e.jsxs("div",{className:"text-red-600 text-sm flex items-center gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),d]}),m&&e.jsxs("div",{className:"text-green-600 text-sm flex items-center gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsxs("span",{children:["Resolved: RA=",m.ra.toFixed(6),"°, Dec=",m.dec.toFixed(6),"°"]})]})]})},te=({values:o,onChange:v,className:y=""})=>{const h=(u,a,n)=>{const d=o[u]||{type:"peak"};v({...o,[u]:{...d,[a]:a==="type"?n:n===""?void 0:Number(n)}})},f=(u,a,n)=>{const d=o[a]||{type:"peak"};return e.jsxs("div",{className:"form-group",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("label",{className:"form-label mb-0 font-semibold",children:u}),e.jsx("span",{className:"text-gray-400 cursor-help",title:n,children:e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("input",{type:"number",value:d.min??"",onChange:g=>h(a,"min",g.target.value),placeholder:"Min (mJy)",step:"0.01",className:"form-control"}),e.jsx("input",{type:"number",value:d.max??"",onChange:g=>h(a,"max",g.target.value),placeholder:"Max (mJy)",step:"0.01",className:"form-control"}),e.jsxs("select",{value:d.type||"peak",onChange:g=>h(a,"type",g.target.value),className:"form-select",children:[e.jsx("option",{value:"peak",children:"Peak Flux"}),e.jsx("option",{value:"int",children:"Int Flux"})]})]})]})};return e.jsxs("div",{className:`space-y-4 ${y}`,children:[f("Min. Flux","minFlux","The minimum flux of a source. Peak or integrated flux can be selected."),f("Max. Flux","maxFlux","The maximum flux of a source. Peak or integrated flux can be selected."),f("Avg. Flux","avgFlux","The average flux of a source. Peak or integrated flux can be selected.")]})},ae=({values:o,onChange:v,className:y=""})=>{const h=(u,a,n)=>{const d=o[u]||{type:"peak"};v({...o,[u]:{...d,[a]:a==="type"?n:n===""?void 0:Number(n)}})},f=(u,a,n,d=!0)=>{const g=o[a]||{type:"peak"};return e.jsxs("div",{className:"form-group",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("label",{className:"form-label mb-0 font-semibold",children:u}),e.jsx("span",{className:"text-gray-400 cursor-help",title:n,children:e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:`grid ${d?"grid-cols-3":"grid-cols-2"} gap-2`,children:[e.jsx("input",{type:"number",value:g.min??"",onChange:m=>h(a,"min",m.target.value),placeholder:"Min",step:"0.01",className:"form-control"}),e.jsx("input",{type:"number",value:g.max??"",onChange:m=>h(a,"max",m.target.value),placeholder:"Max",step:"0.01",className:"form-control"}),d&&e.jsxs("select",{value:g.type||"peak",onChange:m=>h(a,"type",m.target.value),className:"form-select",children:[e.jsx("option",{value:"peak",children:"Peak Flux"}),e.jsx("option",{value:"int",children:"Int Flux"})]})]})]})};return e.jsxs("div",{className:`space-y-4 ${y}`,children:[f("η (Eta) Metric","eta","The weighted reduced chi-squared variability metric. Higher values indicate more variability."),f("V Metric","v","The variability index, equivalent to fractional variability. V = σ/μ."),f("Max |Vs| Metric","vs","The maximum two-epoch variability t-statistic value derived from the source."),f("Max |m| Metric","m","The maximum two-epoch modulation index derived from the source (measure of variability).")]})},ne=({availableTags:o,includeTags:v,excludeTags:y,onIncludeChange:h,onExcludeChange:f,className:u=""})=>{const[a,n]=c.useState(""),[d,g]=c.useState(""),[m,M]=c.useState(!1),[$,r]=c.useState(!1),b=(x,N)=>{if(!x.trim())return[];const F=x.toLowerCase();return o.filter(C=>C.toLowerCase().includes(F)&&!N.includes(C)).slice(0,10)},l=(x,N,F,C)=>{N.includes(x)||F([...N,x]),C("")},p=(x,N,F)=>{F(N.filter(C=>C!==x))},j=(x,N,F,C,_,I,T,i)=>{const k=b(N,C);return e.jsxs("div",{className:"form-group",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("label",{className:"form-label mb-0 font-semibold",children:x}),e.jsx("span",{className:"text-gray-400 cursor-help",title:i,children:e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})})})]}),C.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mb-2",children:C.map(s=>e.jsxs("span",{className:"badge badge-secondary flex items-center gap-1",children:[s,e.jsx("button",{onClick:()=>p(s,C,_),className:"hover:text-red-500",children:"×"})]},s))}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:N,onChange:s=>{F(s.target.value),T(!0)},onFocus:()=>T(!0),onBlur:()=>setTimeout(()=>T(!1),200),onKeyDown:s=>{s.key==="Enter"&&N.trim()&&(s.preventDefault(),k.length>0?l(k[0],C,_,F):o.includes(N.trim())&&l(N.trim(),C,_,F))},placeholder:"Type to search tags...",className:"form-control w-full"}),I&&k.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-48 overflow-auto",children:k.map(s=>e.jsx("button",{onClick:()=>l(s,C,_,F),className:"w-full text-left px-3 py-2 hover:bg-gray-100 text-sm",children:s},s))})]})]})};return e.jsxs("div",{className:`space-y-4 ${u}`,children:[j("Include Tags",a,n,v,h,m,M,"Only return sources that have the given tags."),j("Exclude Tags",d,g,y,f,$,r,"Only return sources that do NOT have the given tags.")]})};function le(o){if(!o||typeof o!="string")return null;const v=o.trim();if(!v)return null;const y=parseFloat(v);if(!isNaN(y)&&!v.includes(":")&&!v.match(/[hms°'"]/i))return y>=0&&y<360?y:y>=0&&y<24?y*15:null;const h=v.match(/^(\d{1,2})(?:h|:|\s)\s*(\d{1,2})(?:m|:|\s)\s*(\d{1,2}(?:\.\d+)?)\s*s?$/i);if(h){const u=parseInt(h[1],10),a=parseInt(h[2],10),n=parseFloat(h[3]);if(u>=0&&u<24&&a>=0&&a<60&&n>=0&&n<60)return(u+a/60+n/3600)*15}const f=v.match(/^(\d{1,2})(?:h|:|\s)\s*(\d{1,2})(?:m)?$/i);if(f){const u=parseInt(f[1],10),a=parseInt(f[2],10);if(u>=0&&u<24&&a>=0&&a<60)return(u+a/60)*15}return null}function re(o){if(!o||typeof o!="string")return null;const v=o.trim();if(!v)return null;let y=1,h=v;h.startsWith("-")?(y=-1,h=h.slice(1).trim()):h.startsWith("+")&&(h=h.slice(1).trim());const f=parseFloat(h);if(!isNaN(f)&&!h.includes(":")&&!h.match(/[dms°'"]/i)){const n=y*f;return n>=-90&&n<=90?n:null}const u=h.match(/^(\d{1,2})(?:d|°|:|\s)\s*(\d{1,2})(?:m|'|:|\s)\s*(\d{1,2}(?:\.\d+)?)\s*(?:s|")?$/i);if(u){const n=parseInt(u[1],10),d=parseInt(u[2],10),g=parseFloat(u[3]);if(n>=0&&n<=90&&d>=0&&d<60&&g>=0&&g<60){const m=n+d/60+g/3600,M=y*m;if(M>=-90&&M<=90)return M}}const a=h.match(/^(\d{1,2})(?:d|°|:|\s)\s*(\d{1,2})(?:m|')?$/i);if(a){const n=parseInt(a[1],10),d=parseInt(a[2],10);if(n>=0&&n<=90&&d>=0&&d<60){const g=n+d/60,m=y*g;if(m>=-90&&m<=90)return m}}return null}const B={radiusUnit:"arcmin",coordFrame:"icrs",includeTags:[],excludeTags:[]},ie=({runs:o=[],availableTags:v=[],onSubmit:y,onReset:h,initialParams:f,className:u=""})=>{const[a,n]=c.useState({...B,...f}),[d,g]=c.useState(new Set(["cone","filters"])),[m,M]=c.useState({}),[$,r]=c.useState(f?.ra?.toString()??""),[b,l]=c.useState(f?.dec?.toString()??""),p=K.useRef(null),j=c.useCallback(()=>{const s=window.location.hash.slice(1);if(!s)return{};const t={};return s.split("&").forEach(w=>{const[A,V]=w.split("=");if(!A||!V)return;const S=decodeURIComponent(V);switch(A){case"ra":t.ra=parseFloat(S);break;case"dec":t.dec=parseFloat(S);break;case"radius":t.radius=parseFloat(S);break;case"radius_unit":["arcsec","arcmin","deg"].includes(S)&&(t.radiusUnit=S);break;case"coord_frame":["icrs","galactic"].includes(S)&&(t.coordFrame=S);break;case"new_source":t.newSource=S==="true";break;case"no_siblings":t.noSiblings=S==="true";break;case"run_name":t.runName=S;break;case"include_tags":t.includeTags=S.split(",").filter(Boolean);break;case"exclude_tags":t.excludeTags=S.split(",").filter(Boolean);break;case"min_flux_min":t.minFlux={...t.minFlux,min:parseFloat(S),type:"peak"};break;case"min_flux_max":t.minFlux={...t.minFlux,max:parseFloat(S),type:"peak"};break;case"max_flux_min":t.maxFlux={...t.maxFlux,min:parseFloat(S),type:"peak"};break;case"max_flux_max":t.maxFlux={...t.maxFlux,max:parseFloat(S),type:"peak"};break;case"eta_min":t.eta={...t.eta,min:parseFloat(S),type:"peak"};break;case"eta_max":t.eta={...t.eta,max:parseFloat(S),type:"peak"};break;case"v_min":t.v={...t.v,min:parseFloat(S),type:"peak"};break;case"v_max":t.v={...t.v,max:parseFloat(S),type:"peak"};break}}),t},[]),x=c.useCallback(s=>{const t=[];s.ra!=null&&t.push(`ra=${s.ra.toFixed(6)}`),s.dec!=null&&t.push(`dec=${s.dec.toFixed(6)}`),s.radius!=null&&t.push(`radius=${s.radius}`),s.radiusUnit!==B.radiusUnit&&t.push(`radius_unit=${s.radiusUnit}`),s.coordFrame!==B.coordFrame&&t.push(`coord_frame=${s.coordFrame}`),s.newSource&&t.push("new_source=true"),s.noSiblings&&t.push("no_siblings=true"),s.runName&&t.push(`run_name=${encodeURIComponent(s.runName)}`),s.includeTags.length>0&&t.push(`include_tags=${s.includeTags.map(encodeURIComponent).join(",")}`),s.excludeTags.length>0&&t.push(`exclude_tags=${s.excludeTags.map(encodeURIComponent).join(",")}`),s.minFlux?.min!=null&&t.push(`min_flux_min=${s.minFlux.min}`),s.minFlux?.max!=null&&t.push(`min_flux_max=${s.minFlux.max}`),s.maxFlux?.min!=null&&t.push(`max_flux_min=${s.maxFlux.min}`),s.maxFlux?.max!=null&&t.push(`max_flux_max=${s.maxFlux.max}`),s.eta?.min!=null&&t.push(`eta_min=${s.eta.min}`),s.eta?.max!=null&&t.push(`eta_max=${s.eta.max}`),s.v?.min!=null&&t.push(`v_min=${s.v.min}`),s.v?.max!=null&&t.push(`v_max=${s.v.max}`);const w=t.length>0?`#${t.join("&")}`:"";window.location.hash!==w&&window.history.replaceState(null,"",w||window.location.pathname)},[]),N=c.useCallback(s=>{const t={};return s.ra!=null&&(s.ra<0||s.ra>360)&&(t.ra="RA must be between 0 and 360 degrees"),s.dec!=null&&(s.dec<-90||s.dec>90)&&(t.dec="Dec must be between -90 and 90 degrees"),s.radius!=null&&s.radius<0&&(t.radius="Radius must be non-negative"),(s.ra!=null||s.dec!=null||s.radius!=null)&&(s.ra==null||s.dec==null||s.radius==null)&&(s.ra==null&&(t.ra="RA required for cone search"),s.dec==null&&(t.dec="Dec required for cone search"),s.radius==null&&(t.radius="Radius required for cone search")),t},[]);c.useEffect(()=>{const s=j();Object.keys(s).length>0&&n(t=>({...t,...s}))},[j]),c.useEffect(()=>(p.current&&window.clearTimeout(p.current),p.current=window.setTimeout(()=>{x(a),M(N(a))},500),()=>{p.current&&window.clearTimeout(p.current)}),[a,x,N]);const F=c.useCallback(s=>{g(t=>{const w=new Set(t);return w.has(s)?w.delete(s):w.add(s),w})},[]),C=c.useCallback((s,t)=>{n(w=>({...w,ra:s,dec:t})),r(s.toFixed(6)),l(t.toFixed(6))},[]),_=c.useCallback(()=>{n({...B}),M({}),r(""),l(""),window.history.replaceState(null,"",window.location.pathname),h?.()},[h]),I=c.useCallback(()=>{const s=N(a);M(s),Object.keys(s).length===0&&y(a)},[a,y,N]),T=c.useMemo(()=>{let s=0;return a.ra!=null&&a.dec!=null&&s++,(a.minFlux?.min!=null||a.minFlux?.max!=null)&&s++,(a.maxFlux?.min!=null||a.maxFlux?.max!=null)&&s++,(a.avgFlux?.min!=null||a.avgFlux?.max!=null)&&s++,(a.eta?.min!=null||a.eta?.max!=null)&&s++,(a.v?.min!=null||a.v?.max!=null)&&s++,(a.snrMin?.min!=null||a.snrMin?.max!=null)&&s++,(a.snrMax?.min!=null||a.snrMax?.max!=null)&&s++,(a.datapoints?.min!=null||a.datapoints?.max!=null)&&s++,a.newSource&&s++,a.noSiblings&&s++,a.includeTags.length>0&&s++,a.excludeTags.length>0&&s++,a.runName&&s++,s},[a]),i=Object.keys(m).length>0,k=(s,t,w)=>{const A=d.has(s);return e.jsxs("div",{className:"border-b border-gray-200",children:[e.jsxs("button",{onClick:()=>F(s),className:"w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:t}),e.jsx("svg",{className:`w-5 h-5 text-gray-500 transition-transform ${A?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),A&&e.jsx("div",{className:"p-4 space-y-4",children:w})]})};return e.jsxs("div",{className:`card ${u}`,children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsxs("h4",{className:"text-lg font-semibold flex items-center gap-2",children:["Source Query",T>0&&e.jsxs("span",{className:"badge badge-primary",children:[T," filters"]})]}),e.jsx("button",{onClick:_,className:"text-sm text-gray-500 hover:text-red-500",children:"Reset all"})]}),e.jsxs("div",{className:"divide-y divide-gray-200",children:[k("source","Data Source",e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Pipeline Run"}),e.jsxs("select",{value:a.runName||"",onChange:s=>n(t=>({...t,runName:s.target.value||void 0})),className:"form-select w-full",children:[e.jsx("option",{value:"",children:"All Runs"}),o.map(s=>e.jsx("option",{value:s.name,children:s.name},s.id))]})]})),k("cone","Cone Search",e.jsxs(e.Fragment,{children:[e.jsx(se,{onResolved:C}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"RA (deg or HMS)"}),e.jsx("input",{type:"text",value:$,onChange:s=>{const t=s.target.value;r(t);const w=le(t);n(A=>({...A,ra:w??void 0}))},onBlur:()=>{a.ra!=null&&r(a.ra.toFixed(6))},placeholder:"180.0 or 12:00:00",className:`form-control ${m.ra?"border-red-500":""}`}),m.ra&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:m.ra})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Dec (deg or DMS)"}),e.jsx("input",{type:"text",value:b,onChange:s=>{const t=s.target.value;l(t);const w=re(t);n(A=>({...A,dec:w??void 0}))},onBlur:()=>{a.dec!=null&&l(a.dec.toFixed(6))},placeholder:"+45.0 or +45:00:00",className:`form-control ${m.dec?"border-red-500":""}`}),m.dec&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:m.dec})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Radius"}),e.jsx("input",{type:"number",value:a.radius??"",onChange:s=>n(t=>({...t,radius:s.target.value?parseFloat(s.target.value):void 0})),placeholder:"2",min:0,step:.1,className:`form-control ${m.radius?"border-red-500":""}`}),m.radius&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:m.radius})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Unit"}),e.jsxs("select",{value:a.radiusUnit,onChange:s=>n(t=>({...t,radiusUnit:s.target.value})),className:"form-select",children:[e.jsx("option",{value:"arcsec",children:"arcsec"}),e.jsx("option",{value:"arcmin",children:"arcmin"}),e.jsx("option",{value:"deg",children:"deg"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Frame"}),e.jsxs("select",{value:a.coordFrame,onChange:s=>n(t=>({...t,coordFrame:s.target.value})),className:"form-select",children:[e.jsx("option",{value:"icrs",children:"ICRS"}),e.jsx("option",{value:"galactic",children:"Galactic"})]})]})]})]})),k("flux","Flux Filters",e.jsx(te,{values:{minFlux:a.minFlux,maxFlux:a.maxFlux,avgFlux:a.avgFlux},onChange:s=>n(t=>({...t,...s}))})),k("variability","Variability Metrics",e.jsx(ae,{values:{eta:a.eta,v:a.v,vs:a.vs,m:a.m},onChange:s=>n(t=>({...t,...s}))})),k("snr","SNR & Data Counts",e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Min SNR"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"number",value:a.snrMin?.min??"",onChange:s=>n(t=>({...t,snrMin:{...t.snrMin,min:s.target.value?Number(s.target.value):void 0}})),placeholder:"Min",className:"form-control"}),e.jsx("input",{type:"number",value:a.snrMin?.max??"",onChange:s=>n(t=>({...t,snrMin:{...t.snrMin,max:s.target.value?Number(s.target.value):void 0}})),placeholder:"Max",className:"form-control"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Max SNR"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"number",value:a.snrMax?.min??"",onChange:s=>n(t=>({...t,snrMax:{...t.snrMax,min:s.target.value?Number(s.target.value):void 0}})),placeholder:"Min",className:"form-control"}),e.jsx("input",{type:"number",value:a.snrMax?.max??"",onChange:s=>n(t=>({...t,snrMax:{...t.snrMax,max:s.target.value?Number(s.target.value):void 0}})),placeholder:"Max",className:"form-control"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Datapoints"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"number",value:a.datapoints?.min??"",onChange:s=>n(t=>({...t,datapoints:{...t.datapoints,min:s.target.value?Number(s.target.value):void 0}})),placeholder:"Min",min:1,className:"form-control"}),e.jsx("input",{type:"number",value:a.datapoints?.max??"",onChange:s=>n(t=>({...t,datapoints:{...t.datapoints,max:s.target.value?Number(s.target.value):void 0}})),placeholder:"Max",min:1,className:"form-control"})]})]})]})),k("flags","Source Type",e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.newSource||!1,onChange:s=>n(t=>({...t,newSource:s.target.checked})),className:"w-4 h-4 text-vast-green rounded"}),e.jsx("span",{children:"New source"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"(appeared after first observation)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.noSiblings||!1,onChange:s=>n(t=>({...t,noSiblings:s.target.checked})),className:"w-4 h-4 text-vast-green rounded"}),e.jsx("span",{children:"No siblings"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"(no multi-component islands)"})]})]})),k("tags","Tags",e.jsx(ne,{availableTags:v,includeTags:a.includeTags,excludeTags:a.excludeTags,onIncludeChange:s=>n(t=>({...t,includeTags:s})),onExcludeChange:s=>n(t=>({...t,excludeTags:s}))}))]}),i&&e.jsx("div",{className:"px-4 py-2 bg-red-50 border-t border-red-200",children:e.jsx("ul",{className:"text-sm text-red-600 list-disc list-inside",children:Object.entries(m).map(([s,t])=>e.jsx("li",{children:t},s))})}),e.jsxs("div",{className:"p-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-2",children:[e.jsx("button",{onClick:_,className:"btn btn-secondary",children:"Reset"}),e.jsx("button",{onClick:I,className:`btn btn-primary ${i?"opacity-75":""}`,disabled:i,children:"Search"})]})]})},ce=({etaThreshold:o,vThreshold:v,etaSigma:y,vSigma:h,useSigmaThreshold:f,minDataPoints:u,colorBy:a,onChange:n})=>e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:d=>n({useSigmaThreshold:d.target.checked}),className:"w-4 h-4 rounded"}),e.jsx("span",{className:"text-sm",children:"Use σ-based thresholds"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Calculate thresholds dynamically based on standard deviation"})]}),f&&e.jsxs("div",{className:"space-y-3 pl-2 border-l-2 border-primary",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center justify-between text-sm mb-1",children:[e.jsxs("span",{children:["η threshold: ",y,"σ"]}),e.jsx("span",{className:"text-gray-500 text-xs",children:"above mean"})]}),e.jsx("input",{type:"range",min:1,max:5,step:.5,value:y,onChange:d=>n({etaSigma:parseFloat(d.target.value)}),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center justify-between text-sm mb-1",children:[e.jsxs("span",{children:["V threshold: ",h,"σ"]}),e.jsx("span",{className:"text-gray-500 text-xs",children:"above mean"})]}),e.jsx("input",{type:"range",min:1,max:5,step:.5,value:h,onChange:d=>n({vSigma:parseFloat(d.target.value)}),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"})]})]}),!f&&e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"η threshold"}),e.jsx("input",{type:"number",value:o,onChange:d=>n({etaThreshold:parseFloat(d.target.value)||0}),step:.1,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"V threshold"}),e.jsx("input",{type:"number",value:v,onChange:d=>n({vThreshold:parseFloat(d.target.value)||0}),step:.01,className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-1",children:["Min data points: ",u]}),e.jsx("input",{type:"range",min:2,max:20,value:u,onChange:d=>n({minDataPoints:parseInt(d.target.value,10)}),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-400",children:[e.jsx("span",{children:"2"}),e.jsx("span",{children:"20"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Color by"}),e.jsxs("select",{value:a,onChange:d=>n({colorBy:d.target.value}),className:"w-full px-2 py-1 border border-gray-300 rounded text-sm",children:[e.jsx("option",{value:"variability",children:"Variability (η × V)"}),e.jsx("option",{value:"flux",children:"Peak Flux"}),e.jsx("option",{value:"measurements",children:"N Measurements"}),e.jsx("option",{value:"none",children:"No color gradient"})]})]})]}),J=({sourceId:o,name:v,ra:y,dec:h,eta:f,v:u,peakFlux:a,nMeasurements:n,position:d,isHover:g=!0,onNavigate:m,onClose:M})=>{const $=(b,l)=>{if(l){const p=b/15,j=Math.floor(p),x=Math.floor((p-j)*60),N=((p-j-x/60)*3600).toFixed(2);return`${j}h ${x}m ${N}s`}else{const p=b>=0?"+":"",j=Math.floor(Math.abs(b)),x=Math.floor((Math.abs(b)-j)*60),N=((Math.abs(b)-j-x/60)*3600).toFixed(1);return`${p}${j}° ${x}' ${N}"`}},r=d?{position:"absolute",left:d.x+10,top:d.y+10,zIndex:1e3}:{};return e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg shadow-lg p-3 ${g?"min-w-48":"min-w-64"}`,style:r,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-800 truncate",children:v||o}),!g&&M&&e.jsx("button",{onClick:M,className:"text-gray-400 hover:text-gray-600 text-lg leading-none",children:"×"})]}),e.jsxs("div",{className:"text-xs text-gray-500 mb-2",children:[e.jsxs("div",{children:["RA: ",$(y,!0)]}),e.jsxs("div",{children:["Dec: ",$(h,!1)]})]}),e.jsxs("div",{className:"flex gap-4 mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-primary",children:f.toFixed(2)}),e.jsx("div",{className:"text-xs text-gray-500",children:"η"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-primary",children:u.toFixed(3)}),e.jsx("div",{className:"text-xs text-gray-500",children:"V"})]}),a!==void 0&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-700",children:a.toFixed(2)}),e.jsx("div",{className:"text-xs text-gray-500",children:"mJy"})]}),n!==void 0&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-700",children:n}),e.jsx("div",{className:"text-xs text-gray-500",children:"pts"})]})]}),!g&&m&&e.jsx("button",{onClick:()=>m(o),className:"w-full text-sm bg-primary text-white py-1.5 rounded hover:bg-primary-dark transition-colors",children:"View Source Details"})]})},oe=({sources:o,isLoading:v=!1,onSourceSelect:y,height:h=500,className:f=""})=>{const u=c.useRef(null),a=c.useRef(null),[n,d]=c.useState({etaThreshold:1.5,vThreshold:.1,etaSigma:2,vSigma:2,useSigmaThreshold:!0,minDataPoints:3,colorBy:"variability"}),[g,m]=c.useState(null),[M,$]=c.useState({x:0,y:0}),[r,b]=c.useState(null);c.useEffect(()=>{const i=k=>{k.key==="Escape"&&r&&b(null)};if(r)return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[r]);const l=c.useCallback(()=>{if(!n.useSigmaThreshold||o.length===0)return{etaLine:n.etaThreshold,vLine:n.vThreshold};const i=o.map(E=>E.eta),k=o.map(E=>E.v),s=E=>E.reduce((D,P)=>D+P,0)/E.length,t=E=>{const D=s(E);return Math.sqrt(E.reduce((P,L)=>P+(L-D)**2,0)/E.length)},w=s(i),A=t(i),V=s(k),S=t(k);return{etaLine:w+n.etaSigma*A,vLine:V+n.vSigma*S}},[o,n]),p=c.useMemo(()=>o.filter(i=>(i.nMeasurements??10)>=n.minDataPoints&&i.eta>0&&i.v>0),[o,n.minDataPoints]),j=o.length-p.length,{etaLine:x,vLine:N}=l(),F=c.useMemo(()=>p.filter(i=>i.eta>x&&i.v>N),[p,x,N]),C=c.useMemo(()=>p.length===0?{variability:1,flux:1,measurements:1}:{variability:Math.max(...p.map(i=>i.eta*i.v),1),flux:Math.max(...p.map(i=>i.peakFlux??0),1),measurements:Math.max(...p.map(i=>i.nMeasurements??0),1)},[p]),_=c.useCallback((i,k)=>{if(k)return"#ff0000";if(n.colorBy==="none")return"rgba(79, 195, 161, 0.6)";let s=0,t=1;switch(n.colorBy){case"variability":s=i.eta*i.v,t=C.variability;break;case"flux":s=i.peakFlux??0,t=C.flux;break;case"measurements":s=i.nMeasurements??0,t=C.measurements;break}const w=Math.min(s/t,1),A=Math.round(79+w*161),V=Math.round(195+w*3),S=Math.round(161-w*45);return`rgba(${A}, ${V}, ${S}, 0.7)`},[n.colorBy,C]);c.useEffect(()=>{if(!u.current)return;a.current=Y(u.current);const i=()=>{a.current?.resize()};return window.addEventListener("resize",i),()=>{window.removeEventListener("resize",i),a.current?.dispose()}},[]),c.useEffect(()=>{if(!a.current||v)return;const i=new Set(F.map(R=>R.id)),k=p.map(R=>({value:[R.eta,R.v],itemStyle:{color:_(R,i.has(R.id))},symbolSize:i.has(R.id)?10:6,source:R})),s=p.map(R=>R.eta),t=p.map(R=>R.v),w=Math.min(...s)*.5,A=Math.max(...s)*2,V=Math.min(...t)*.5,S=Math.max(...t)*2,E=j>0?` (${j} excluded: η≤0 or v≤0)`:"",P={title:{text:"η-V Variability Plot",subtext:`${p.length} sources, ${F.length} candidates${E}`,left:"center",textStyle:{color:"#324960",fontSize:16},subtextStyle:{color:"#666"}},tooltip:{trigger:"item",formatter:()=>"",show:!1},xAxis:{name:"η (eta)",nameLocation:"middle",nameGap:30,type:"log",axisLabel:{formatter:"{value}"}},yAxis:{name:"V",nameLocation:"middle",nameGap:40,type:"log"},series:[{type:"scatter",data:k,emphasis:{itemStyle:{borderColor:"#324960",borderWidth:2}}},{type:"line",markLine:{silent:!0,symbol:"none",lineStyle:{color:"#ff6b6b",type:"dashed",width:2},data:[[{xAxis:x,yAxis:V},{xAxis:x,yAxis:S}]],label:{formatter:`η = ${x.toFixed(2)}`,position:"end"}}},{type:"line",markLine:{silent:!0,symbol:"none",lineStyle:{color:"#ff6b6b",type:"dashed",width:2},data:[[{xAxis:w,yAxis:N},{xAxis:A,yAxis:N}]],label:{formatter:`V = ${N.toFixed(3)}`,position:"end"}}}],toolbox:{right:20,feature:{dataZoom:{title:{zoom:"Zoom",back:"Reset"}},restore:{title:"Reset"},saveAsImage:{title:"Save"}}},dataZoom:[{type:"inside",xAxisIndex:0},{type:"inside",yAxisIndex:0}]};a.current.setOption(P,{notMerge:!1});const L=a.current;L.off("mouseover"),L.off("mouseout"),L.off("click"),L.on("mouseover",R=>{if(R.componentType==="series"&&R.data?.source){const O=R.event?.event;m(R.data.source),O&&$({x:O.clientX,y:O.clientY})}}),L.on("mouseout",()=>{m(null)}),L.on("click",R=>{R.componentType==="series"&&R.data?.source&&(b(R.data.source),m(null))})},[p,j,F,n,v,x,N,_]);const I=i=>{d(k=>({...k,...i}))},T=i=>{y?.(i),b(null)};return e.jsxs("div",{className:`${f}`,children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[v?e.jsx("div",{className:"flex items-center justify-center bg-gray-50 rounded-lg",style:{height:h},children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"}),e.jsx("span",{className:"text-gray-500",children:"Loading sources..."})]})}):e.jsx("div",{ref:u,style:{height:h,width:"100%"}}),g&&e.jsx(J,{...g,sourceId:g.id,position:M,isHover:!0})]}),e.jsxs("div",{className:"w-64 flex-shrink-0",children:[e.jsx(ce,{...n,onChange:I}),F.length>0&&e.jsxs("div",{className:"mt-4 bg-red-50 border border-red-200 rounded-lg p-3",children:[e.jsxs("h4",{className:"font-semibold text-red-700 text-sm mb-2",children:["Candidates (",F.length,")"]}),e.jsxs("div",{className:"max-h-40 overflow-y-auto space-y-1",children:[F.slice(0,10).map(i=>e.jsxs("button",{onClick:()=>b(i),className:"w-full text-left text-xs p-1.5 bg-white rounded hover:bg-red-100 transition-colors",children:[e.jsx("span",{className:"font-medium",children:i.name||i.id}),e.jsxs("span",{className:"text-gray-500 ml-2",children:["η=",i.eta.toFixed(2),", V=",i.v.toFixed(3)]})]},i.id)),F.length>10&&e.jsxs("p",{className:"text-xs text-red-500",children:["+",F.length-10," more"]})]})]})]})]}),r&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsx(J,{...r,sourceId:r.id,isHover:!1,onNavigate:T,onClose:()=>b(null)})})]})},fe=()=>{const{data:o,isLoading:v,error:y}=G(),[h,f]=c.useState("list"),[u,a]=c.useState({}),[n,d]=c.useState(!1),[g,m]=c.useState({}),[M,$]=c.useState(!1),r=[{id:"name",label:"Name Search",type:"text",group:"Basic",placeholder:"Search by name..."},{id:"minFlux",label:"Min Flux (Jy)",type:"range",group:"Flux",min:0,max:1,step:.001,unit:"Jy"},{id:"maxFlux",label:"Max Flux (Jy)",type:"range",group:"Flux",min:0,max:1,step:.001,unit:"Jy"},{id:"minImages",label:"Min Detections",type:"range",group:"Variability",min:1,max:100,step:1},{id:"variable",label:"Variable Only",type:"checkbox",group:"Variability"}],b=U(s=>s.selectedSources),l=U(s=>s.toggleSourceSelection),p=U(s=>s.selectAllSources),j=U(s=>s.clearSourceSelection),x=c.useMemo(()=>Array.from(b),[b]),N=c.useCallback(()=>{x.length!==0&&$(!0)},[x]),F=c.useCallback(()=>{window.open(`https://ronnie-unsectarian-antone.ngrok-free.dev/api/sources/export?ids=${x.join(",")}`,"_blank"),$(!1)},[x]),C=c.useMemo(()=>{if(!o)return[];let s=o;if(u.ra!==void 0&&u.dec!==void 0&&u.radius){const{ra:t,dec:w,radius:A}=u;s=s.filter(V=>{if(V.ra_deg===void 0||V.dec_deg===void 0)return!1;const S=(V.ra_deg-t)*Math.cos(w*Math.PI/180),E=V.dec_deg-w;return Math.sqrt(S*S+E*E)*60<=A})}if(u.minFlux!==void 0&&(s=s.filter(t=>(t.peak_flux_jy??0)>=(u.minFlux??0))),u.maxFlux!==void 0&&(s=s.filter(t=>(t.peak_flux_jy??1/0)<=(u.maxFlux??1/0))),g.name&&typeof g.name=="string"){const t=g.name.toLowerCase();s=s.filter(w=>w.name?.toLowerCase().includes(t)||w.id.toLowerCase().includes(t))}return g.minImages&&typeof g.minImages=="number"&&(s=s.filter(t=>(t.num_images??0)>=g.minImages)),g.variable===!0&&(s=s.filter(t=>t.eta!==void 0&&t.v!==void 0&&(t.eta>2||t.v>.1))),s},[o,u,g]),{sortColumn:_,sortDirection:I,handleSort:T,sortedData:i}=Z(C),k=c.useMemo(()=>o?o.filter(s=>s.eta!==void 0&&s.v!==void 0&&s.ra_deg!==void 0&&s.dec_deg!==void 0).map(s=>({id:s.id,name:s.name||s.id,ra:s.ra_deg,dec:s.dec_deg,eta:s.eta,v:s.v,peakFlux:s.peak_flux_jy,nMeasurements:s.num_images})):[],[o]);return v?e.jsx(W,{label:"Loading sources..."}):y?e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg",children:["Failed to load sources: ",y.message]}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Sources"}),x.length>0&&e.jsxs("span",{className:"text-sm text-gray-500",children:[x.length," selected"]})]}),e.jsxs("div",{className:"flex gap-2",children:[x.length>0&&e.jsx("button",{onClick:N,className:"px-4 py-2 rounded-lg text-sm font-medium bg-green-600 text-white hover:bg-green-700 transition-colors",children:"Export Selected"}),e.jsx("button",{className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${h==="list"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,onClick:()=>f("list"),children:"List View"}),e.jsx("button",{className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${h==="variability"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,onClick:()=>f("variability"),children:"Variability Plot"})]})]}),e.jsx("div",{className:"mb-6",children:e.jsx(ie,{onQueryChange:a})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("button",{onClick:()=>d(!n),className:"text-sm text-blue-600 hover:text-blue-800 mb-2",children:n?"Hide Advanced Filters":"Show Advanced Filters"}),n&&e.jsx(ee,{filters:r,values:g,onChange:m,onApply:()=>{},onReset:()=>m({})})]}),e.jsx(Q,{isOpen:M,onClose:()=>$(!1),title:"Export Sources",size:"sm",footer:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>$(!1),className:"px-4 py-2 text-sm text-gray-700 bg-gray-100 rounded hover:bg-gray-200",children:"Cancel"}),e.jsxs("button",{onClick:F,className:"px-4 py-2 text-sm text-white bg-green-600 rounded hover:bg-green-700",children:["Export ",x.length," Sources"]})]}),children:e.jsxs("p",{className:"text-gray-600",children:["You are about to export ",e.jsx("strong",{children:x.length})," selected sources. This will download a CSV file with all source data."]})}),h==="variability"?e.jsx("div",{className:"card p-4",children:k.length>0?e.jsx(oe,{sources:k,onSourceSelect:s=>window.location.href=`/sources/${s}`,height:500}):e.jsx("p",{className:"text-gray-500 text-center py-8",children:"No variability data available. Sources need η and V values to display the variability plot."})}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["Showing ",C.length," of ",o?.length??0," sources"]}),i&&i.length>0?e.jsx("div",{className:"card overflow-hidden",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-10 px-3 py-3",children:e.jsx("input",{type:"checkbox",checked:x.length===i.length&&i.length>0,ref:s=>{s&&(s.indeterminate=x.length>0&&x.length<i.length)},onChange:()=>{x.length===i.length?j():p(i.map(s=>s.id))},className:"h-4 w-4 text-blue-600 rounded"})}),e.jsx(z,{columnKey:"id",sortColumn:_,sortDirection:I,onSort:T,children:"ID"}),e.jsx(z,{columnKey:"name",sortColumn:_,sortDirection:I,onSort:T,children:"Name"}),e.jsx(z,{columnKey:"ra_deg",sortColumn:_,sortDirection:I,onSort:T,className:"text-right",children:"RA (deg)"}),e.jsx(z,{columnKey:"dec_deg",sortColumn:_,sortDirection:I,onSort:T,className:"text-right",children:"Dec (deg)"}),e.jsx(z,{columnKey:"num_images",sortColumn:_,sortDirection:I,onSort:T,className:"text-center",children:"Images"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:i.map(s=>e.jsxs("tr",{className:b.has(s.id)?"bg-blue-50":"",children:[e.jsx("td",{className:"px-3",children:e.jsx("input",{type:"checkbox",checked:b.has(s.id),onChange:()=>l(s.id),className:"h-4 w-4 text-blue-600 rounded"})}),e.jsx("td",{children:e.jsx(q,{to:`/sources/${s.id}`,className:"text-blue-600 hover:text-blue-800 font-medium",children:s.id})}),e.jsx("td",{children:s.name||"—"}),e.jsx("td",{className:"text-right font-mono",children:s.ra_deg?.toFixed(4)}),e.jsx("td",{className:"text-right font-mono",children:s.dec_deg?.toFixed(4)}),e.jsx("td",{className:"text-center",children:s.num_images??"—"})]},s.id))})]})}):e.jsx("p",{className:"text-gray-500",children:"No sources found."})]})]})};export{fe as default};
//# sourceMappingURL=SourcesListPage-C7AHSAaC.js.map
