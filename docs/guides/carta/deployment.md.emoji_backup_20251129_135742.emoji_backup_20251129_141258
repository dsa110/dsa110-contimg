# CARTA Deployment Guide

Complete deployment and configuration guide for CARTA integration.

---

## Docker Deployment

### Basic Deployment

```bash
docker run -d \
  --name carta-backend \
  --restart unless-stopped \
  -p 9002:3002 \
  -v /stage/dsa110-contimg:/stage/dsa110-contimg:ro \
  -v /data/dsa110-contimg:/data/dsa110-contimg:ro \
  cartavis/carta:latest
```

### Production Deployment (Localhost Only)

```bash
docker run -d \
  --name carta-backend \
  --restart unless-stopped \
  -p 127.0.0.1:9002:3002 \
  -v /stage/dsa110-contimg:/stage/dsa110-contimg:ro \
  -v /data/dsa110-contimg:/data/dsa110-contimg:ro \
  cartavis/carta:latest
```

### Persistence

The container is configured with `--restart unless-stopped`:

- :white_heavy_check_mark: Survives system reboots
- :white_heavy_check_mark: Restarts automatically if it crashes
- :white_heavy_check_mark: Stays stopped only if manually stopped

---

## Container Management

```bash
# Check status
docker ps --filter "name=carta-backend"

# Stop/Start/Restart
docker stop carta-backend
docker start carta-backend
docker restart carta-backend

# View logs
docker logs carta-backend
docker logs -f carta-backend  # Follow

# Remove container
docker rm -f carta-backend
```

---

## Dashboard Configuration

### Development Environment

Edit `frontend/.env`:

```bash
VITE_CARTA_BACKEND_URL=http://localhost:9002
VITE_CARTA_FRONTEND_URL=http://localhost:9002
```

### Production Environment

Edit `frontend/.env.production`:

```bash
# Local machine
VITE_CARTA_BACKEND_URL=ws://localhost:9002
VITE_CARTA_FRONTEND_URL=http://localhost:9002

# Remote machine (example)
VITE_CARTA_BACKEND_URL=ws://lxd110h17:9002
VITE_CARTA_FRONTEND_URL=http://lxd110h17:9002
```

### Rebuild After Configuration

Vite environment variables are embedded at build time:

```bash
cd /data/dsa110-contimg
./scripts/build-dashboard-production.sh
```

### Restart Dashboard Service

```bash
# Systemd service
sudo systemctl restart contimg-dashboard

# Docker Compose
docker compose restart dashboard

# Manual script
pkill -f "serve-dashboard-production"
./scripts/serve-dashboard-production.sh
```

---

## API Endpoints

The dashboard backend provides CARTA control endpoints:

| Endpoint                           | Method | Description            |
| ---------------------------------- | ------ | ---------------------- |
| `/api/visualization/carta/status`  | GET    | Check CARTA status     |
| `/api/visualization/carta/start`   | POST   | Start CARTA services   |
| `/api/visualization/carta/stop`    | POST   | Stop CARTA services    |
| `/api/visualization/carta/restart` | POST   | Restart CARTA services |

---

## Port Conflict Resolution

If port 9002 is already in use:

```bash
# Find process using port
sudo ss -tlnp | grep :9002

# Use different port
docker rm -f carta-backend
docker run -d \
  --name carta-backend \
  --restart unless-stopped \
  -p 9010:3002 \
  -v /stage/dsa110-contimg:/stage/dsa110-contimg:ro \
  -v /data/dsa110-contimg:/data/dsa110-contimg:ro \
  cartavis/carta:latest

# Update dashboard configuration to use new port
```

---

## Updating CARTA

```bash
# Stop and remove current container
docker stop carta-backend
docker rm carta-backend

# Pull latest image
docker pull cartavis/carta:latest

# Recreate container
docker run -d \
  --name carta-backend \
  --restart unless-stopped \
  -p 9002:3002 \
  -v /stage/dsa110-contimg:/stage/dsa110-contimg:ro \
  -v /data/dsa110-contimg:/data/dsa110-contimg:ro \
  cartavis/carta:latest

# Verify new version
docker logs carta-backend | grep "Version"
```

---

## Security Considerations

### Data Access

- CARTA container has **read-only** access to data directories
- Container runs as non-root user (`cartauser`)
- No write access to pipeline data

### Network Exposure

- Default: exposed on all interfaces (0.0.0.0:9002)
- Production: use `127.0.0.1:9002` for localhost only
- Remote access: use SSH tunneling or reverse proxy
- Authentication: token-based access available (see logs for URL)

---

## Monitoring

```bash
# Check container health
docker ps --filter "name=carta-backend"

# Resource usage
docker stats carta-backend

# Internal logs
docker exec carta-backend cat /home/cartauser/.carta/log/carta.log
```

---

## Architecture

```text
carta-backend container
├── Backend WebSocket Server (port 3002 -> host 9002)
├── Frontend Static Files (/usr/share/carta/frontend)
├── Data Mounts (read-only)
│   ├── /stage/dsa110-contimg
│   └── /data/dsa110-contimg
└── Logs: /home/cartauser/.carta/log/carta.log

User -> Dashboard (/carta) -> CARTAIframe/CARTAViewer -> CARTA Backend (9002)
                                                           |
                                                           v
                                                    FITS Files (mounted volumes)
```

---

## Related Files

- `frontend/src/components/CARTA/CARTAIframe.tsx` - Iframe component
- `frontend/src/components/CARTA/CARTAViewer.tsx` - WebSocket component
- `frontend/src/pages/CARTAPage.tsx` - CARTA dashboard page
- `backend/src/dsa110_contimg/api/carta_service.py` - Backend service
- `backend/src/dsa110_contimg/api/visualization_routes.py` - API endpoints
