================================================================================
                    DSA-110 MOSAIC PIPELINE - CIRCUIT BOARD LAYOUT
                        10-Minute Mosaic Test Case Flow
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                          INPUT CONNECTOR HEADER                             │
│                              (User Trigger)                                  │
│                          create_10min_mosaic.py                             │
└────────────────────────┬────────────────────────────────────────────────────┘
                         │
                         │ [Config Bus]
                         │ IMG_IMSIZE=1024
                         │ IMG_ROBUST=0.0
                         │ IMG_NITER=1000
                         │
                         ▼
         ┌─────────────────────────────────────┐
         │     CONFIG REGISTER (U1)            │
         │  ┌─────────────────────────────┐   │
         │  │ write_status()              │   │
         │  │ log_error()                 │   │
         │  │ Environment Variables       │   │
         │  └─────────────────────────────┘   │
         └───────────────┬─────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         POWER SUPPLY RAIL (+5V)                              │
│                         Transit Database Check                               │
└────────────────────────┬────────────────────────────────────────────────────┘
                         │
         ┌───────────────┴─────────────────────┐
         │                                      │
         ▼                                      ▼
┌──────────────────┐              ┌──────────────────────┐
│  DB READOUT      │              │  ON-DEMAND CALC      │
│  IC: U2          │              │  IC: U3              │
│                  │              │                      │
│  get_calibrator_ │              │  calibrator_service  │
│  _transits()     │              │  .list_available_    │
│                  │              │    transits()        │
└────────┬─────────┘              └──────────┬───────────┘
         │                                   │
         └───────────────┬───────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    MUX (U4) - Transit Selection                              │
│              Pre-calc ──────┼─────── On-Demand                               │
└─────────────────────────────┼───────────────────────────────────────────────┘
                              │
                              ▼
         ┌─────────────────────────────────────┐
         │   ORCHESTRATOR INIT (U5)            │
         │  ┌─────────────────────────────┐   │
         │  │ MosaicOrchestrator()        │   │
         │  │ ├─ products_db_path         │   │
         │  │ ├─ ms_output_dir            │   │
         │  │ ├─ images_dir               │   │
         │  │ └─ mosaic_output_dir        │   │
         │  └─────────────────────────────┘   │
         └───────────────┬─────────────────────┘
                         │
                         │ [Control Bus]
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    MAIN PROCESSOR - MOSAIC ORCHESTRATOR                       │
│                           IC: U6 (MCPU)                                      │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │ create_mosaic_centered_on_calibrator()                             │    │
│  │  ├─ Input: calibrator_name="0834+555"                              │    │
│  │  ├─ Input: timespan_minutes=12                                     │    │
│  │  └─ Input: wait_for_published=False                                │    │
│  └────────────────────────────────────────────────────────────────────┘    │
└────────────────────────┬─────────────────────────────────────────────────────┘
                         │
                         │ [Address/Data Bus]
                         ▼
         ┌─────────────────────────────────────┐
         │   WINDOW FINDER (U7)                │
         │  ┌─────────────────────────────┐   │
         │  │ find_transit_centered_      │   │
         │  │   window()                  │   │
         │  │  ├─ Find earliest transit   │   │
         │  │  ├─ Calculate window        │   │
         │  │  │    (transit ± 6 min)     │   │
         │  │  └─ Query MS count          │   │
         │  └─────────────────────────────┘   │
         └───────────────┬─────────────────────┘
                         │
                         │ [Window Info Bus]
                         │ transit_time, start_time, end_time
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MS FILE MANAGER - IC: U8                                │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │ ensure_ms_files_in_window()                                        │    │
│  │                                                                     │    │
│  │  ┌──────────────┐              ┌──────────────┐                   │    │
│  │  │ MS CHECKER   │              │ HDF5:arrow_right:MS      │                   │    │
│  │  │ (U8A)        │              │ CONVERTER    │                   │    │
│  │  │              │              │ (U8B)        │                   │    │
│  │  │ Query DB     │              │              │                   │    │
│  │  │ Scan disk    │              │ convert_     │                   │    │
│  │  │ Register MS  │              │ subband_     │                   │    │
│  │  └──────┬───────┘              │ groups_to_ms │                   │    │
│  │         │                       │              │                   │    │
│  │         │ <3 files? ────────────┼─── YES       │                   │    │
│  │         │                       │              │                   │    │
│  │         │ >=3 files             │              │                   │    │
│  │         │                       │              │                   │    │
│  │         └───────────┬───────────┘              │                   │    │
│  │                     │                          │                   │    │
│  │                     ▼                          │                   │    │
│  │              [MS Paths List]                   │                   │    │
│  └────────────────────────────────────────────────────────────────────┘    │
└────────────────────────┬─────────────────────────────────────────────────────┘
                         │
                         │ [MS Paths Bus]
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DRY-RUN SWITCH (U9)                                       │
│                                                                              │
│         ┌─────────────────────────────────────┐                             │
│         │  dry_run?                           │                             │
│         │  ┌─────┐      ┌─────┐              │                             │
│         │  │ YES │      │ NO  │              │                             │
│         │  └──┬──┘      └──┬──┘              │                             │
│         └─────┼────────────┼─────────────────┘                             │
│               │            │                                                │
│               │            │                                                │
│               ▼            ▼                                                │
│    ┌─────────────────┐   ┌────────────────────────────────────────┐        │
│    │ VALIDATOR (U10) │   │ EXECUTOR (U11)                        │        │
│    │                 │   │                                        │        │
│    │ _validate_      │   │ _execute_mosaic_creation()            │        │
│    │  mosaic_plan()  │   │                                        │        │
│    │                 │   │  ├─ Check MS count                    │        │
│    │ Returns:        │   │  ├─ Form group                        │        │
│    │ "DRY_RUN"       │   │  └─ Process workflow                  │        │
│    └─────────────────┘   └───────────────┬───────────────────────┘        │
│                                          │                                 │
└──────────────────────────────────────────┼─────────────────────────────────┘
                                           │
                                           │ [Group ID Bus]
                                           ▼
                    ┌─────────────────────────────────────┐
                    │   GROUP FORMATION (U12)             │
                    │  ┌─────────────────────────────┐   │
                    │  │ _form_group_from_ms_paths() │   │
                    │  │                             │   │
                    │  │ INSERT INTO mosaic_groups   │   │
                    │  │   (group_id, ms_paths, ...) │   │
                    │  └─────────────────────────────┘   │
                    └───────────────┬─────────────────────┘
                                    │
                                    │ [Control Signal]
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   PROCESSOR - GROUP WORKFLOW (U13)                           │
│                      _process_group_workflow()                               │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │ STAGE 1: CALIBRATION SELECTION                                     │    │
│  │ ┌──────────────────────────────────────────────────────────────┐  │    │
│  │ │ select_calibration_ms()                                       │  │    │
│  │ │  └─ Returns: 5th MS (index 4) ──────┐                        │  │    │
│  │ └──────────────────────────────────────┼────────────────────┐   │    │
│  │                                        │                    │   │    │
│  │ ┌──────────────────────────────────────▼────────────────────┘   │    │
│  │ │ STAGE 2: CALIBRATION SOLVING                                    │    │
│  │ │ ┌────────────────────────────────────────────────────────┐    │    │
│  │ │ │ solve_calibration_for_group()                           │    │    │
│  │ │ │  ├─ solve_bandpass() ───────────┐                       │    │    │
│  │ │ │  │   (IC: U14 - BP SOLVER)      │                       │    │    │
│  │ │ │  │                              │                       │    │    │
│  │ │ │  │                              ▼                       │    │    │
│  │ │ │  └─ solve_gains() ──────────────┼──> IC: U15 (GAIN)    │    │    │
│  │ │ │                                │                       │    │    │
│  │ │ │                                │ [Cal Tables]          │    │    │
│  │ │ └────────────────────────────────┼───────────────────────┘    │    │
│  │ │                                  │                            │    │
│  │ │ ┌────────────────────────────────▼───────────────────────┐    │    │
│  │ │ │ STAGE 3: CALIBRATION APPLICATION                       │    │    │
│  │ │ │ ┌────────────────────────────────────────────────┐    │    │    │
│  │ │ │ │ apply_calibration_to_group()                   │    │    │    │
│  │ │ │ │  ├─ apply_to_target() for each MS              │    │    │    │
│  │ │ │ │  └─ Update MS status :arrow_right: 'calibrated'            │    │    │    │
│  │ │ │ └────────────────────────────────────────────────┘    │    │    │
│  │ │ └────────────────────────────────────────────────────┘    │    │    │
│  │ │                                                            │    │    │
│  │ │ ┌─────────────────────────────────────────────────────────┐  │    │
│  │ │ STAGE 4: IMAGING (Parallel Processing)                    │  │    │
│  │ │ ┌────────────────────────────────────────────────────┐   │  │    │
│  │ │ │ image_group()                                       │   │  │    │
│  │ │ │                                                      │   │  │    │
│  │ │ │  MS[0] ──┐                                          │   │  │    │
│  │ │ │  MS[1] ──┼──> image_ms() ──┐                        │   │  │    │
│  │ │ │  MS[2] ──┼──> image_ms() ──┼──> [Images]           │   │  │    │
│  │ │ │  ...     ┼──> image_ms() ──┘                        │   │  │    │
│  │ │ │  MS[n] ──┘                                          │   │  │    │
│  │ │ │                                                      │   │  │    │
│  │ │ │  IC: U16 (IMAGING ENGINE)                           │   │  │    │
│  │ │ └────────────────────────────────────────────────────┘   │    │    │
│  │ └─────────────────────────────────────────────────────────┘  │    │    │
│  │                                                               │    │    │
│  │ ┌─────────────────────────────────────────────────────────┐  │    │    │
│  │ │ STAGE 5: MOSAIC CREATION                                 │  │    │    │
│  │ │ ┌────────────────────────────────────────────────────┐  │  │    │    │
│  │ │ │ create_mosaic()                                     │  │  │    │    │
│  │ │ │  ├─ _build_weighted_mosaic()                        │  │  │    │    │
│  │ │ │  │   (Method: pbweighted)                           │  │  │    │    │
│  │ │ │  │                                                  │  │  │    │    │
│  │ │ │  │  Tile[0] ──┐                                     │  │  │    │    │
│  │ │ │  │  Tile[1] ──┼──> Combine with weights ──┐         │  │  │    │    │
│  │ │ │  │  Tile[2] ──┼──> (PB weighting)         │         │  │  │    │    │
│  │ │ │  │  ...       ┼                           ▼         │  │  │    │    │
│  │ │ │  │  Tile[n] ──┘                    [Mosaic FITS]    │  │  │    │    │
│  │ │ │  │                                                  │  │  │    │    │
│  │ │ │  │  IC: U17 (MOSAIC BUILDER)                        │  │  │    │    │
│  │ │ │  └──────────────────────────────────────────────────┘  │  │    │    │
│  │ │ └────────────────────────────────────────────────────┘  │    │    │    │
│  │ └─────────────────────────────────────────────────────────┘  │    │    │
│  │                                                               │    │    │
│  │ ┌─────────────────────────────────────────────────────────┐  │    │    │
│  │ │ OPTIONAL: PHOTOMETRY (U18)                               │  │    │    │
│  │ │  └─ _trigger_photometry_for_mosaic()                     │  │    │    │
│  │ └─────────────────────────────────────────────────────────┘  │    │    │
│  └────────────────────────────────────────────────────────────────────┘    │
└────────────────────────┬─────────────────────────────────────────────────────┘
                         │
                         │ [Mosaic Path Bus]
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    OUTPUT CONDITIONER (U19)                                  │
│                                                                              │
│         ┌─────────────────────────────────────┐                             │
│         │  wait_for_published?                │                             │
│         │  ┌─────┐      ┌─────┐              │                             │
│         │  │ YES │      │ NO  │              │                             │
│         │  └──┬──┘      └──┬──┘              │                             │
│         └─────┼────────────┼─────────────────┘                             │
│               │            │                                                │
│               │            │                                                │
│               ▼            ▼                                                │
│    ┌─────────────────┐   ┌────────────────────────────────────────┐        │
│    │ PUBLISH WAITER  │   │ DIRECT OUTPUT                          │        │
│    │ (U20)           │   │                                        │        │
│    │                 │   │ Returns: mosaic_path                   │        │
│    │ wait_for_       │   │ Location: /stage/.../mosaics/         │        │
│    │  published()    │   │                                        │        │
│    │                 │   │ ┌──────────────────────────────────┐   │        │
│    │ Polls until     │   │ │ STATUS LED (U21)                 │   │        │
│    │ published or    │   │ │  ├─ write_status("SUCCESS")      │   │        │
│    │ timeout         │   │ │  └─ Print success message        │   │        │
│    │                 │   │ └──────────────────────────────────┘   │        │
│    │                 │   └────────────────────────────────────────┘        │
│    └────────┬────────┘                                                     │
│             │                                                               │
│             ▼                                                               │
│    ┌────────────────────────────────────────┐                              │
│    │ Returns: published_path                │                              │
│    └────────────────────────────────────────┘                              │
└────────────────────────┬─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          OUTPUT CONNECTOR                                    │
│                           (Final Mosaic)                                     │
│                    /stage/dsa110-contimg/mosaics/                            │
│                         *.fits file                                          │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                    DATABASE BUS (Multi-Drop)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ├──> [products.sqlite3] ──── IC: U22 (PRODUCTS DB)
         │      ├─ ms_index
         │      ├─ mosaic_groups
         │      ├─ images
         │      └─ mosaics
         │
         ├──> [cal_registry.sqlite3] ──── IC: U23 (CAL REGISTRY)
         │      └─ calibration tables
         │
         └──> [data_registry.sqlite3] ──── IC: U24 (DATA REGISTRY)
                └─ data products linking


┌─────────────────────────────────────────────────────────────────────────────┐
│                         CLOCK/RESET CIRCUIT                                  │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ├──> Error Handler ────> log_error() ────> ERROR_LOG
         │
         └──> Status Monitor ────> write_status() ────> STATUS_FILE


┌─────────────────────────────────────────────────────────────────────────────┐
│                         POWER RAIL SPECIFICATIONS                            │
│                                                                              │
│  +5V Logic:      Main orchestrator control                                   │
│  +3.3V Data:     MS files, images, mosaics                                   │
│  +12V Compute:   Calibration solving, imaging                                │
│  GND:            Error paths, logging                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                         SIGNAL FLOW SUMMARY                                  │
│                                                                              │
│  1. Power On:    Script execution                                           │
│  2. Config:      Environment variables set                                   │
│  3. Transit:     Find window (pre-calc or on-demand)                        │
│  4. MS Check:    Ensure files exist (convert if needed)                     │
│  5. Validation:  Dry-run check (optional)                                   │
│  6. Grouping:    Form MS group in database                                  │
│  7. Calibration: Solve :arrow_right: Apply                                              │
│  8. Imaging:     Parallel tile creation                                     │
│  9. Mosaic:      Weighted combination                                       │
│ 10. Photometry:  Optional measurement                                       │
│ 11. Publish:     Wait for final location (optional)                         │
│ 12. Complete:    Return mosaic path                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================
                              END OF CIRCUIT LAYOUT
================================================================================

