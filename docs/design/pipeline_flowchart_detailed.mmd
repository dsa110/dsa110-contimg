flowchart TD
    Start([create_10min_mosaic.py<br/>User Trigger]) --> Config[Config Register<br/>IMG_IMSIZE=1024<br/>IMG_ROBUST=0.0<br/>IMG_NITER=1000]
    
    Config --> TransitCheck{Transit DB<br/>Check}
    TransitCheck -->|Has Data| DBReadout[Pre-calc Transits]
    TransitCheck -->|No Data| OnDemandCalc[Calculate On-Demand]
    
    DBReadout --> TransitSelect[Find Earliest Transit<br/>calibrator: 0834+555]
    OnDemandCalc --> TransitSelect
    
    TransitSelect --> OrchestratorInit[Init Orchestrator<br/>MosaicOrchestrator]
    
    OrchestratorInit --> MainProcessor[create_mosaic_centered_on_calibrator<br/>timespan: 12 min]
    
    MainProcessor --> WindowFinder[Find Transit Window<br/>transit ± 6 min<br/>Query MS count]
    
    WindowFinder --> MSManager{MS Files<br/>Available?}
    MSManager -->|>= 3 files| MSList[MS Paths List]
    MSManager -->|< 3 files| HDF5Converter[Convert HDF5→MS<br/>convert_subband_groups_to_ms]
    HDF5Converter --> MSList
    
    MSList --> DryRunSwitch{dry_run?}
    DryRunSwitch -->|Yes| Validator[Validate Plan<br/>Return DRY_RUN]
    DryRunSwitch -->|No| Executor[Execute Creation]
    
    Executor --> GroupForm[Form Group<br/>_form_group_from_ms_paths<br/>INSERT mosaic_groups]
    
    GroupForm --> Workflow[Process Group Workflow]
    
    Workflow --> CalSelect[STAGE 1: Select Cal MS<br/>5th MS index 4]
    
    CalSelect --> CalSolve[STAGE 2: Solve Calibration<br/>solve_bandpass<br/>solve_gains]
    
    CalSolve --> CalApply[STAGE 3: Apply Calibration<br/>apply_to_target each MS<br/>Update status: calibrated]
    
    CalApply --> Imaging[STAGE 4: Image Group<br/>Parallel: image_ms<br/>for each MS]
    
    Imaging --> MosaicBuild[STAGE 5: Create Mosaic<br/>_build_weighted_mosaic<br/>Method: pbweighted]
    
    MosaicBuild --> MosaicFITS[Mosaic FITS File]
    
    MosaicFITS --> PhotometryOpt{Photometry<br/>Enabled?}
    PhotometryOpt -->|Yes| Photometry[Trigger Photometry<br/>Link to registry]
    PhotometryOpt -->|No| OutputCheck
    
    Photometry --> OutputCheck{wait_for_published?}
    OutputCheck -->|Yes| PublishWaiter[Wait for Publish<br/>Poll until ready]
    OutputCheck -->|No| DirectOutput[Return mosaic_path<br/>/stage/.../mosaics/]
    
    PublishWaiter --> PublishedPath[Published Path]
    DirectOutput --> StatusLED[Status: SUCCESS<br/>write_status]
    PublishedPath --> StatusLED
    
    StatusLED --> End([Final Mosaic<br/>/stage/dsa110-contimg/mosaics/*.fits])
    
    %% Database connections
    DBReadout -.->|Query| ProductsDB[(products.sqlite3<br/>ms_index, mosaic_groups)]
    MSManager -.->|Query/Update| ProductsDB
    GroupForm -.->|INSERT| ProductsDB
    CalSolve -.->|Store| CalRegistry[(cal_registry.sqlite3<br/>calibration tables)]
    
    %% Error handling
    Validator -.->|Errors| ErrorLog[Error Handler<br/>log_error]
    Executor -.->|Errors| ErrorLog
    Workflow -.->|Errors| ErrorLog
    
    %% Styling
    classDef startEnd fill:#90EE90,stroke:#006400,stroke-width:3px
    classDef process fill:#87CEEB,stroke:#4682B4,stroke-width:2px
    classDef decision fill:#FFD700,stroke:#FF8C00,stroke-width:2px
    classDef database fill:#DDA0DD,stroke:#9370DB,stroke-width:2px
    classDef stage fill:#F0E68C,stroke:#B8860B,stroke-width:2px
    
    class Start,End startEnd
    class Config,OrchestratorInit,MainProcessor,WindowFinder,MSList,GroupForm,CalSelect,CalSolve,CalApply,Imaging,MosaicBuild,MosaicFITS,Photometry,PublishWaiter,DirectOutput,StatusLED process
    class TransitCheck,MSManager,DryRunSwitch,PhotometryOpt,OutputCheck decision
    class ProductsDB,CalRegistry database
    class CalSelect,CalSolve,CalApply,Imaging,MosaicBuild stage

