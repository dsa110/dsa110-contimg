# TIME and TIME_RANGE Investigation Report
## Comprehensive Analysis of MS Time Handling

**Date:** 2025-11-06  
**Investigator:** AI Assistant  
**Scope:** Complete investigation of TIME, TIME_RANGE, and time-related handling throughout MS generation and processing pipeline

---

## Executive Summary

This investigation reveals a **critical inconsistency** in TIME format assumptions across the codebase. The actual MS files generated by `pyuvdata.write_ms()` use **TIME in seconds since MJD 0**, but significant portions of the codebase assume **TIME in seconds since MJD 51544.0** (the CASA standard). This has led to:

1. **Incorrect time conversions** in multiple locations
2. **RA calculation errors** (since RA = LST(time))
3. **Phase center misalignment** for time-dependent phasing
4. **Data quality validation failures**

---

## 1. Actual MS File Format (Empirically Determined)

### Test Files Analyzed
- `/scratch/ms/timesetv0/2025-10-29T13:32:03.ms` (old)
- `/scratch/ms/timesetv1/2025-10-29T13:32:03.ms` (new, post-fix)

### Findings

**TIME Column Format:**
- **Actual format:** Seconds since MJD 0 (not MJD 51544.0)
- **Evidence:**
  - TIME min: `5268461621.088441` seconds
  - As MJD 0: `60977.56505889` = `2025-10-29T13:33:41.088` ✓ **CORRECT**
  - As MJD 51544: `112521.56505889` = `2166-12-13T13:33:41.088` ✗ **WRONG**

**OBSERVATION TIME_RANGE Format:**
- **Actual format:** Seconds since MJD 0 (matches TIME column)
- **Shape:** `(2, 1)` array
- **Values:** `[5268461621.088441, 5268461917.441209]` seconds
- **Interpretation:** Same as TIME column (seconds since MJD 0)

**Conclusion:** `pyuvdata.write_ms()` writes TIME as **seconds since MJD 0**, not the CASA standard of seconds since MJD 51544.0.

---

## 2. CASA Standard vs. Actual Implementation

### CASA Standard (According to Documentation)

According to CASA/casacore documentation:
- **CASA TIME** should be in **seconds since MJD 51544.0** (2000-01-01 00:00:00 UTC)
- Conversion: `mjd = 51544.0 + casa_time_sec / 86400.0`
- This is the "official" CASA Measurement Set format

### Actual pyuvdata Implementation

**pyuvdata.write_ms() behavior:**
- Writes TIME as **seconds since MJD 0** (not MJD 51544.0)
- This is **inconsistent with CASA standard** but is what pyuvdata actually does
- Reason: pyuvdata converts from JD (Julian Date) to seconds, and JD = MJD + 2400000.5, so:
  - `time_sec = (JD - 2400000.5) * 86400.0 = MJD * 86400.0`
  - This results in seconds since MJD 0, not seconds since MJD 51544.0

### Impact

This creates a **fundamental incompatibility**:
- CASA tools expect TIME in seconds since MJD 51544.0
- pyuvdata writes TIME in seconds since MJD 0
- Our codebase has mixed assumptions about which format is used

---

## 3. Codebase Inconsistencies

### Files Assuming MJD 51544.0 Offset (INCORRECT for our MS files)

1. **`conversion/ms_utils.py:279-280`**
   ```python
   # CASA TIME = (MJD - 51544.0) * 86400.0
   time_mjd = 51544.0 + time_sec / 86400.0
   ```
   **Status:** ❌ **WRONG** - Our MS files use seconds since MJD 0

2. **`api/routes.py:1468-1469`**
   ```python
   # CASA times are in seconds since MJD epoch (51544.0 = 2000-01-01)
   mid_mjd = 51544.0 + mid_time / 86400.0
   ```
   **Status:** ❌ **WRONG** - Fixed in recent updates, but comment is misleading

3. **`utils/time_utils.py`** (Documentation)
   - Module documentation states CASA TIME is seconds since MJD 51544.0
   - But `detect_casa_time_format()` correctly handles both formats
   - **Status:** ⚠️ **MISLEADING** - Documentation doesn't match reality

### Files Correctly Handling Both Formats

1. **`utils/time_utils.py:extract_ms_time_range()`**
   - Uses `detect_casa_time_format()` to auto-detect
   - **Status:** ✅ **CORRECT** - Handles both formats

2. **`conversion/ms_utils.py:_fix_observation_time_range()`**
   - Uses `detect_casa_time_format()` for format detection
   - **Status:** ✅ **CORRECT** - Handles both formats

3. **`calibration/cli.py`**
   - Uses `extract_ms_time_range()` which handles both formats
   - **Status:** ✅ **CORRECT**

### Files with Unclear/Inconsistent Handling

1. **`pointing/utils.py:_time_from_seconds()`**
   - Now uses `casa_time_to_astropy_time()` from time_utils
   - But `casa_time_to_astropy_time()` assumes MJD 51544.0 offset
   - **Status:** ⚠️ **POTENTIALLY WRONG** - Needs verification

2. **`conversion/streaming/streaming_converter.py:608-611`**
   ```python
   t0 = _obs.getcol("TIME_RANGE")[0][0] / 86400.0
   t1 = _obs.getcol("TIME_RANGE")[1][0] / 86400.0
   mid_mjd = 0.5 * (float(t0) + float(t1))
   ```
   **Status:** ✅ **CORRECT** - Assumes seconds since MJD 0 (no offset)

---

## 4. Root Cause Analysis

### Why the Inconsistency Exists

1. **pyuvdata Implementation:**
   - pyuvdata stores time as JD (Julian Date) in `time_array`
   - When writing MS, it converts: `TIME = (JD - 2400000.5) * 86400.0 = MJD * 86400.0`
   - This results in seconds since MJD 0, not MJD 51544.0

2. **CASA Documentation:**
   - CASA documentation states TIME should be seconds since MJD 51544.0
   - But pyuvdata doesn't follow this convention

3. **Codebase Evolution:**
   - Early code assumed CASA standard (MJD 51544.0)
   - Later discovered actual files use MJD 0
   - Created `time_utils.py` with format detection, but not all code updated

### The Fix Strategy

We have two options:

**Option A: Fix at Source (pyuvdata)**
- Modify pyuvdata to write TIME as seconds since MJD 51544.0
- **Pros:** Aligns with CASA standard, fixes all downstream code
- **Cons:** Requires pyuvdata modification, may break other tools

**Option B: Handle in Our Codebase (Current Approach)**
- Use format detection to handle both formats
- Standardize on `extract_ms_time_range()` for all time extraction
- **Pros:** Works with existing files, no external dependencies
- **Cons:** More complex, requires careful handling everywhere

**Current Status:** We're using Option B (format detection).

---

## 5. Recommendations

### Immediate Actions

1. **✅ DONE:** Created `utils/time_utils.py` with format detection
2. **✅ DONE:** Updated `extract_ms_time_range()` to handle both formats
3. **✅ DONE:** Fixed `_fix_observation_time_range()` to use format detection
4. **⚠️ TODO:** Update all remaining code to use `extract_ms_time_range()`
5. **⚠️ TODO:** Fix `pointing/utils.py:_time_from_seconds()` if needed
6. **⚠️ TODO:** Update documentation to reflect actual format

### Long-term Solutions

1. **Standardize on Format Detection:**
   - All time extraction should use `extract_ms_time_range()`
   - Remove hardcoded epoch assumptions
   - Use `detect_casa_time_format()` when direct conversion needed

2. **Documentation Updates:**
   - Update `time_utils.py` docs to explain both formats exist
   - Add comments explaining why format detection is necessary
   - Document that pyuvdata writes MJD 0 format, not CASA standard

3. **Validation:**
   - Add tests to verify format detection works correctly
   - Test with both MJD 0 and MJD 51544.0 formats
   - Validate against actual MS files

4. **Consider pyuvdata Fix:**
   - Investigate if pyuvdata can be configured to write CASA-standard format
   - If not, consider submitting issue/PR to pyuvdata
   - Evaluate impact of changing pyuvdata behavior

---

## 6. Testing and Validation

### Test Cases

1. **Format Detection:**
   - ✅ Tested with actual MS files (MJD 0 format)
   - ⚠️ Need to test with MJD 51544.0 format (if such files exist)

2. **Time Extraction:**
   - ✅ `extract_ms_time_range()` correctly extracts from MJD 0 format
   - ✅ Returns correct 2025 dates
   - ✅ Handles OBSERVATION table TIME_RANGE correctly

3. **OBSERVATION Table Fix:**
   - ✅ `_fix_observation_time_range()` correctly updates TIME_RANGE
   - ✅ Preserves original format (doesn't convert)
   - ✅ Only updates invalid (zero) values

### Remaining Issues

1. **msmetadata.timerangeforobs() Failure:**
   - Fails with "Observation ID -1 out of range"
   - This is a separate issue (OBSERVATION_ID problem)
   - Not related to TIME format, but prevents using this method

2. **Inconsistent Comments:**
   - Many comments still say "CASA TIME = seconds since MJD 51544.0"
   - Should be updated to reflect actual format or mention both formats

---

## 7. Conclusion

The investigation reveals that:

1. **Actual MS files** use TIME in **seconds since MJD 0** (not MJD 51544.0)
2. **pyuvdata.write_ms()** writes in MJD 0 format, not CASA standard
3. **Our codebase** has mixed assumptions, but format detection handles this
4. **Current fixes** (time_utils.py, extract_ms_time_range) are working correctly
5. **Remaining work** is to update all code to use standardized functions

The standardized approach using `extract_ms_time_range()` and format detection is the correct solution for handling this inconsistency.

---

## 8. References

- CASA Documentation: [casacore Time class](https://casa.nrao.edu/doxygen/classcasacore_1_1Time.html)
- pyuvdata: [GitHub Repository](https://github.com/RadioAstronomySoftwareGroup/pyuvdata)
- Astropy Time: [Astropy Time Documentation](https://docs.astropy.org/en/stable/time/)
- Investigation Date: 2025-11-06
- Test Files: `/scratch/ms/timesetv0/` and `/scratch/ms/timesetv1/`

