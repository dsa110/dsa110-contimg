# Frontend Code Search with DocSearch

**Date:** 2025-11-27  
**Purpose:** Semantic search over frontend TypeScript/React code

> **:warning_sign::variation_selector-16: Migration Note:** The frontend is being rewritten. The new `frontend/`
> contains a minimal scaffold. See `legacy.frontend/` for the full reference
> implementation. API endpoint examples below reference `legacy.backend`.

> **:electric_light_bulb: Quick Start Guide:** For a simplified task-oriented guide, see
> **[Frontend Code Search Guide](../../guides/code-search.md)**.  
> This document provides comprehensive reference material for advanced usage and
> troubleshooting.

---

## Overview

The DocSearch system has been extended to index and search frontend source code.
This enables:

- **Component discovery**: Find React components by functionality
- **Hook search**: Locate custom hooks and their usage
- **API tracking**: Find where API endpoints are called
- **Code navigation**: Semantic search for functions, types, utilities

## Architecture

### Databases

- `/data/dsa110-contimg/state/docsearch.sqlite3` - Documentation index
- `/data/dsa110-contimg/state/docsearch_code.sqlite3` - Frontend code index
- `/data/dsa110-contimg/state/embedding_cache.sqlite3` - Shared embedding cache

### Indexed Files

- `frontend/src/**/*.ts` - TypeScript modules
- `frontend/src/**/*.tsx` - React components
- Excludes: `node_modules/`, `dist/`, `build/`, test files

### Index Contents

- Exported functions, components, hooks
- Type definitions, interfaces
- API client functions
- JSDoc comments for context

---

## Indexing Frontend Code

### Initial Indexing

```bash
conda activate casa6
cd /data/dsa110-contimg/docs/docsearch

# Index all frontend code
python cli.py index-frontend

# Example output:
# Indexing frontend code in /data/dsa110-contimg/frontend/src...
# INFO: Indexed 42 blocks from queries.ts
# INFO: Indexed 8 blocks from DashboardPage.tsx
# INFO: Indexed 15 blocks from ControlPage.tsx
# ...
# Indexing complete!
#   Files processed: 87
#   Chunks indexed: 456
#   Files skipped: 23
```

**Time estimate**: 2-5 minutes for initial indexing (depends on HDD I/O and
OpenAI API latency)

### Incremental Indexing

After modifying frontend code:

```bash
# Re-index (only changed files are re-embedded)
cd /data/dsa110-contimg/docs/docsearch
python cli.py index-frontend
```

**Time estimate**: <30 seconds for typical incremental updates

**Note:** The system uses file modification time tracking. Only files changed
since last indexing are re-processed. The embedding cache prevents redundant API
calls.

### Custom Indexing Options

```bash
cd /data/dsa110-contimg/docs/docsearch

# Index specific directory
python cli.py index-frontend \
  --frontend-dir /data/dsa110-contimg/frontend/src/components

# Include only .tsx files
python cli.py index-frontend \
  --extensions .tsx

# Custom exclusions
python cli.py index-frontend \
  --exclude node_modules dist build .test. .spec. __tests__ .stories.

# Force re-index all files (ignores mtime)
python cli.py index-frontend --force
```

---

## Searching Frontend Code

### Search Components

Find React components by functionality:

```bash
cd /data/dsa110-contimg/docs/docsearch

# Find components related to pipeline monitoring
python cli.py search-components "pipeline status monitoring"

# Example output:
# Found 3 components:
#
# ━━━ 1. export const PipelineStatusCard ━━━
# File: frontend/src/components/Pipeline/PipelineStatusCard.tsx:12
# Score: 0.876
#
# Real-time pipeline queue status display with WebSocket updates.
# Shows active conversions, pending observations, and system health.
#
# ━━━ 2. export default function DashboardPage ━━━
# File: frontend/src/pages/DashboardPage.tsx:45
# Score: 0.823
#
# Main dashboard page showing system overview and active operations.
# Includes pipeline status, recent observations, and monitoring panels.
```

**More results:**

```bash
python cli.py search-components "ESE detection panel" --top-k 10
```

### Search Hooks

Find React hooks for data fetching, state management, etc.:

```bash
cd /data/dsa110-contimg/docs/docsearch

# Find hooks for fetching data
python cli.py search-hooks "fetch measurement sets"

# Example output:
# Found 2 hooks:
#
# ━━━ 1. export function useMSList ━━━
# File: frontend/src/api/queries.ts:342
# Score: 0.912
#
# Fetch list of Measurement Sets with optional filters.
# Uses React Query for automatic caching and background updates.
#
# ━━━ 2. export function useMSMetadata ━━━
# File: frontend/src/api/queries.ts:358
# Score: 0.845
#
# Get metadata for a specific Measurement Set including scan info,
# field names, and calibration status.
```

**More results:**

```bash
python cli.py search-hooks "streaming service status" --top-k 10
```

### Find API Usage

Track where API endpoints are called across the codebase:

```bash
cd /data/dsa110-contimg/docs/docsearch

# Find where an API endpoint is called
python cli.py find-api "/api/sources/search"

# Example output:
# Found 3 usages of /api/sources/search
#
# ━━━ 1. frontend/src/api/queries.ts:250 ━━━
# Context: export function useSourceSearch
# Score: 0.945
#
# const response = await apiClient.post<SourceSearchResponse>(
#   "/api/sources/search",
#   { source_id: sourceId, filters: { catalog: 'NVSS' }, limit: 100 }
# );
#
# ━━━ 2. frontend/src/pages/SourceMonitoringPage.tsx:89 ━━━
# Context: const handleSearch
# Score: 0.834
#
# // Trigger source search
# setSearchRequest({ source_id: sourceId, limit: 100 });
# refetch(); // Uses useSourceSearch hook
```

**More results:**

```bash
python cli.py find-api "/api/streaming/status" --top-k 15
```

### General Code Search

For broader queries not limited to components/hooks:

```bash
cd /data/dsa110-contimg/docs/docsearch

# General search across all indexed code
python cli.py search "WebSocket real-time updates" --top-k 10

# Note: This searches the CODE index, not documentation
# For documentation search, use: python cli.py search "..." (without index-frontend)
```

---

## Python API

### Basic Usage

```python
import sys
sys.path.insert(0, "/data/dsa110-contimg/docs/docsearch")

from code_indexer import CodeDocSearch

# Initialize
code_search = CodeDocSearch()

# Search components
results = code_search.search_components("ESE detection panel", top_k=5)
for r in results:
    print(f"{r['component']} - {r['file']}:{r['line']}")

# Search hooks
results = code_search.search_hooks("streaming service status", top_k=5)
for r in results:
    print(f"{r['hook']} - {r['file']}:{r['line']}")

# Find API usage
results = code_search.search_api_calls("/api/streaming/status", top_k=10)
for r in results:
    print(f"{r['location']} - {r['context']}")
```

### Advanced Usage

```python
import sys
sys.path.insert(0, "/data/dsa110-contimg/docs/docsearch")

from code_indexer import CodeDocSearch
from pathlib import Path

code_search = CodeDocSearch()

# Index specific file
file_path = Path("/data/dsa110-contimg/frontend/src/components/MyComponent.tsx")
chunks = code_search.index_code_file(file_path)
print(f"Indexed {chunks} chunks")

# Custom search with lower-level access
from search import DocSearch

search = DocSearch(
    db_path="/data/dsa110-contimg/state/docsearch_code.sqlite3"
)
results = search.search("React Query mutation", top_k=10)

for r in results:
    print(f"{r.heading} ({r.file_path}:{r.start_line})")
    print(f"  Score: {r.score:.3f}")
    print(f"  {r.content[:150]}...\n")
```

---

## Integration with AI Agents

### Use in AI Agent Workflows

AI agents should use DocSearch for code navigation:

```python
import sys
sys.path.insert(0, "/data/dsa110-contimg/docs/docsearch")

# Example: Find where a component is defined
def find_component_definition(component_name: str) -> str:
    """Find where a React component is defined."""
    from code_indexer import CodeDocSearch

    code_search = CodeDocSearch()
    results = code_search.search_components(component_name, top_k=1)

    if results:
        r = results[0]
        return f"{r['file']}:{r['line']}"
    return "Component not found"

# Example: Find hook usage examples
def find_hook_examples(hook_name: str) -> list:
    """Find examples of hook usage."""
    from code_indexer import CodeDocSearch

    code_search = CodeDocSearch()
    results = code_search.search(f"{hook_name} usage example", top_k=5)

    return [
        {
            'file': r.file_path,
            'line': r.start_line,
            'snippet': r.content[:200]
        }
        for r in results
    ]
```

### Recommended AI Agent Patterns

1. **Before modifying code**: Search for similar implementations
2. **When debugging**: Find related components/hooks
3. **For API changes**: Find all usage sites with `find-api`
4. **Code review**: Search for best practices examples

---

## Maintenance

### Re-indexing

Re-index after:

- Adding new components/hooks
- Major refactoring
- Adding significant comments/documentation

```bash
cd /data/dsa110-contimg/docs/docsearch

# Incremental re-index (only changed files)
python cli.py index-frontend

# Full re-index (force all files)
python cli.py index-frontend --force
```

### Complete Index Rebuild

If index corruption occurs or major changes require clean slate:

```bash
cd /data/dsa110-contimg/docs/docsearch

# Remove old index
rm /data/dsa110-contimg/state/docsearch_code.sqlite3

# Re-index from scratch
python cli.py index-frontend
```

**Note:** The embedding cache (`embedding_cache.sqlite3`) is shared with
documentation search and should NOT be deleted unless necessary.

### Monitoring Index Size

```bash
# Check database size
du -h /data/dsa110-contimg/state/docsearch_code.sqlite3

# Check indexed chunks
sqlite3 /data/dsa110-contimg/state/docsearch_code.sqlite3 \
  "SELECT COUNT(*) FROM documents;"

# Check indexed files
sqlite3 /data/dsa110-contimg/state/docsearch_code.sqlite3 \
  "SELECT COUNT(DISTINCT file_path) FROM documents;"

# Sample indexed content
sqlite3 /data/dsa110-contimg/state/docsearch_code.sqlite3 \
  "SELECT file_path, heading FROM documents LIMIT 20;"
```

### Performance Tips

- **Index size**: ~50-100 chunks per file is normal
- **Search speed**: <2s for most queries
- **Re-indexing time**: ~2-5 minutes for full frontend
- **Embedding cache**: Prevents redundant API calls (check hit rate with
  `search.embedder.get_cache_stats()`)

---

## Troubleshooting

### No Results Found

**Possible causes:**

1. Index not created - run `index-frontend` first
2. Query too specific - try broader terms
3. Code not in indexed files - check exclusions

**Solutions:**

```bash
cd /data/dsa110-contimg/docs/docsearch

# Verify index exists
ls -lh /data/dsa110-contimg/state/docsearch_code.sqlite3

# Check indexed files
sqlite3 /data/dsa110-contimg/state/docsearch_code.sqlite3 \
  "SELECT DISTINCT file_path FROM documents LIMIT 20;"

# Try broader query
python cli.py search-components "status"

# Check what was indexed
sqlite3 /data/dsa110-contimg/state/docsearch_code.sqlite3 \
  "SELECT COUNT(*) as chunks, COUNT(DISTINCT file_path) as files FROM documents;"
```

### Slow Indexing

**Causes:**

- First-time indexing with cold embedding cache
- Network issues with OpenAI API
- HDD I/O bottlenecks (source files on `/data/`)

**Solutions:**

```bash
cd /data/dsa110-contimg/docs/docsearch

# Check embedding cache hit rate
sqlite3 /data/dsa110-contimg/state/embedding_cache.sqlite3 \
  "SELECT COUNT(*) FROM embeddings;"

# Check OpenAI API connectivity
python -c "import os; from embedder import Embedder; e = Embedder(); print('OK')"

# Monitor progress with verbose logging
python -c "
import logging
logging.basicConfig(level=logging.INFO)
import sys
sys.path.insert(0, '/data/dsa110-contimg/docs/docsearch')
from code_indexer import CodeDocSearch
code_search = CodeDocSearch()
stats = code_search.index_frontend_directory()
print(stats)
"
```

### API Key Issues

```bash
# Verify API key is set
echo $OPENAI_API_KEY

# Or check .env file
cat /data/dsa110-contimg/backend/.env | grep OPENAI_API_KEY

# Test embedder directly
cd /data/dsa110-contimg/docs/docsearch
python -c "from embedder import Embedder; e = Embedder(); print('API key OK')"
```

### Import Errors

If you see `ModuleNotFoundError` when running from outside the docsearch
directory:

```python
import sys
sys.path.insert(0, "/data/dsa110-contimg/docs/docsearch")

# Now imports will work
from code_indexer import CodeDocSearch
from search import DocSearch
```

**Note:** DocSearch is standalone code in `docs/docsearch/`, not part of the
`dsa110_contimg` package.

---

## Performance Metrics

### Expected Indexing Performance

**Full frontend indexing** (~87 files, ~500 chunks):

- **First run**: 2-5 minutes
  - File reading: ~30-60s (HDD-bound)
  - Embedding generation: ~60-180s (OpenAI API calls)
  - Database writes: ~10-20s

- **Incremental updates**: <30 seconds
  - Changed files only (~5-10 files typical)
  - Embedding cache hits: ~80-95%

### Search Performance

- **Component search**: 1-2 seconds
- **Hook search**: 1-2 seconds
- **API usage search**: 1-2 seconds
- **General code search**: 1-3 seconds

### Database Sizes

| Database                  | Size     | Contents                   |
| ------------------------- | -------- | -------------------------- |
| `docsearch_code.sqlite3`  | 5-10 MB  | ~500 code chunks + vectors |
| `embedding_cache.sqlite3` | 20-30 MB | Cached embeddings (shared) |

### Resource Usage

- **Disk I/O**: Light (source files on `/data/` HDD, ~10-20 MB/s reads)
- **Network**: Moderate (OpenAI API calls, ~1-2 MB total for full index)
- **Memory**: Low (~50-100 MB peak during indexing)
- **CPU**: Light (mostly I/O-bound)

---

## See Also

- [DocSearch Documentation](../../docsearch/README.md) - Core DocSearch system
- [code_indexer.py](../../docsearch/code_indexer.py) - Implementation details
- [Frontend Architecture](../../../frontend/docs/FRONTEND_CODEBASE_ANALYSIS.md) -
  Frontend structure
- [API Client Reference](../../../frontend/src/api/README.md) - API client
  documentation

---

## Summary

Frontend code search enables semantic discovery of components, hooks, and API
usage across the codebase:

:white_heavy_check_mark: **Index once, search anytime**: `python cli.py index-frontend`  
:white_heavy_check_mark: **Find components**: `python cli.py search-components "query"`  
:white_heavy_check_mark: **Find hooks**: `python cli.py search-hooks "query"`  
:white_heavy_check_mark: **Track API usage**: `python cli.py find-api "/api/status"`  
:white_heavy_check_mark: **Incremental updates**: Only changed files are re-indexed  
:white_heavy_check_mark: **Shared cache**: Minimizes OpenAI API costs
