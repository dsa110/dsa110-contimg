# HTML Reports Generated in the Pipeline

## Overview

The DSA-110 pipeline generates HTML reports in multiple locations for different
purposes:

1. **QA Validation Reports** (Backend) - Image validation reports
2. **Playwright E2E Test Reports** (Frontend) - Test execution reports

## 1. QA Validation HTML Reports (Backend)

### Location

- **Module:** `src/dsa110_contimg/qa/html_reports.py`
- **Main Function:** `generate_html_report()`
- **Report Format:** `{image_name}_validation_report.html`

### When Generated

#### A. During Pipeline Validation Stage

- **File:** `src/dsa110_contimg/pipeline/stages_impl.py`
- **Stage:** Validation stage (`validate_image()`)
- **Trigger:** When `validation_config.generate_html_report = True` (default:
  `True`)
- **Output Location:** QA output directory (typically `{output_dir}/qa/`)
- **Report Name:** `{image_name}_validation_report.html`

**Example:**

```python
# In pipeline/stages_impl.py
if validation_config.generate_html_report:
    html_report_path = str(
        output_dir / f"{image_name}_validation_report.html"
    )
    # ... validation runs ...
    generate_html=validation_config.generate_html_report,
    html_output_path=html_report_path,
```

#### B. Via API Endpoints

- **File:** `src/dsa110_contimg/api/routes.py`
- **Endpoints:**
  1. `GET /qa/images/{image_id}/validation-report.html`
     - Generates and returns HTML report on-demand
     - Query param: `save=true` to save to file
  2. `POST /qa/images/{image_id}/generate-validation-report`
     - Generates HTML report and saves to QA directory
     - Returns path to saved report

**Example API Usage:**

```bash
# Get HTML report (on-demand)
curl http://localhost:8000/api/qa/images/{image_id}/validation-report.html

# Generate and save report
curl -X POST http://localhost:8000/api/qa/images/{image_id}/generate-validation-report
```

#### C. Via Catalog Validation

- **File:** `src/dsa110_contimg/qa/catalog_validation.py`
- **Function:** `run_all_validations()`
- **Parameter:** `generate_html=True` with `html_output_path` provided

### Report Contents

QA validation HTML reports include:

- **Validation Summary**
  - Overall pass/fail status
  - Test execution timestamp
  - Image metadata

- **Astrometry Validation**
  - Position accuracy statistics
  - Scatter plots
  - Spatial distribution maps

- **Flux Scale Validation**
  - Flux ratio histograms
  - Flux vs offset plots
  - Comparison with reference catalog

- **Source Counts Validation**
  - Completeness curves
  - Source count statistics
  - Detection efficiency

- **Image Visualization**
  - Embedded image viewer (JS9)
  - Thumbnail previews
  - Metadata tables

### Configuration

**Pipeline Config** (`src/dsa110_contimg/pipeline/config.py`):

```python
class ValidationConfig:
    generate_html_report: bool = Field(
        default=True,
        description="Generate HTML validation report"
    )
```

**Default:** `True` (HTML reports generated by default)

### Report Storage

- **Default Location:** `{qa_output_dir}/{image_name}_validation_report.html`
- **Example:**
  `/stage/dsa110-contimg/qa/reports/image_2025-01-11T12:00:00_validation_report.html`
- **State DB:** Report path stored in pipeline state metadata

## 2. Playwright E2E Test Reports (Frontend)

### Location

- **Config:** `frontend/playwright.config.ts`
- **Reporter:** `['html']` in reporter configuration
- **Report Format:** `playwright-report/index.html`

### When Generated

- **Automatically** after every test run
- **Location:** `frontend/playwright-report/index.html`
- **Trigger:** Any Playwright test execution

### Report Contents

Playwright HTML reports include:

- **Test Results Overview**
  - Pass/fail/skip counts
  - Execution time
  - Test timeline

- **Individual Test Details**
  - Test name and status
  - Execution duration
  - Error messages (if failed)

- **Artifacts** (on failure)
  - Screenshots
  - Videos
  - Traces (when enabled)

- **Filtering & Search**
  - Filter by status
  - Search tests
  - View by project/browser

### Viewing Reports

```bash
# Using npm script
npm run test:e2e:report

# Or manually
npx playwright show-report

# Or open directly
open frontend/playwright-report/index.html
```

## Comparison

| Feature        | QA Validation Reports                              | Playwright Reports                |
| -------------- | -------------------------------------------------- | --------------------------------- |
| **Purpose**    | Image quality validation                           | E2E test results                  |
| **Generated**  | During pipeline validation                         | After test execution              |
| **Location**   | QA output directory                                | `playwright-report/`              |
| **Format**     | `{image_name}_validation_report.html`              | `index.html`                      |
| **Content**    | Validation metrics, plots, images                  | Test results, screenshots, videos |
| **Automatic**  | Yes (if enabled in config)                         | Yes (always)                      |
| **API Access** | Yes (via `/qa/images/{id}/validation-report.html`) | No (file system only)             |

## Related Documentation

- [QA Validation Guide](../how-to/validation_guide.md)
- [Pipeline Configuration](../concepts/pipeline_overview.md)
- E2E Testing Guide: `../frontend/tests/e2e/README.md` (external file)
- HTML Reports Module: `../../src/dsa110_contimg/qa/html_reports.py` (external
  file)

## Notes

- Both report types are standalone HTML files (no server required)
- QA reports include embedded plots and images (base64 encoded)
- Playwright reports are interactive with filtering/search capabilities
- Both can be archived/shared as static HTML files
