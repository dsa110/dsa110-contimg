#!/usr/bin/env python3
"""Render Mermaid diagram to SVG using mermaid.ink API"""

import urllib.parse
import urllib.request
import base64
import sys

MERMAID_CODE = """flowchart TB
    subgraph Backend["backend/"]
        Root["Root Files<br/>README.md, pyproject.toml<br/>setup.py, scripts/"]
        
        subgraph Src["src/dsa110_contimg/"]
            API["api/<br/>REST API Layer<br/>app.py, routes.py<br/>schemas.py, repositories.py"]
            Conversion["conversion/<br/>UVH5 :arrow_right: MS<br/>cli.py, strategies/<br/>streaming/"]
            Calibration["calibration/<br/>Calibration Routines<br/>applycal.py, flagging.py<br/>refant_selection.py"]
            Imaging["imaging/<br/>Imaging Pipeline<br/>cli.py, fast_imaging.py<br/>spw_imaging.py"]
            Database["database/<br/>Data Persistence<br/>models.py, repositories.py<br/>jobs.py, products.py"]
            Catalog["catalog/<br/>Source Catalogs<br/>query.py, crossmatch.py<br/>calibrator_registry.py"]
            Photometry["photometry/<br/>Source Detection<br/>forced.py, ese_detection.py<br/>adaptive_photometry.py"]
            Pipeline["pipeline/<br/>Orchestration<br/>stages_impl.py"]
            Utils["utils/<br/>Utilities<br/>logging.py, coordinates.py<br/>ms_helpers.py"]
            Simulation["simulation/<br/>Test Data<br/>generate_uvh5.py"]
            DocSearch["docsearch/<br/>Documentation<br/>cli.py"]
        end
        
        subgraph Tests["tests/"]
            Unit["unit/<br/>Unit Tests<br/>test_*.py"]
            Integration["integration/<br/>Integration Tests"]
            Fixtures["fixtures/<br/>Test Data<br/>writers.py"]
        end
        
        Docs["docs/<br/>Documentation<br/>runbooks/"]
        Scripts["scripts/<br/>Utility Scripts<br/>run_api.py, health_check.py"]
    end
    
    API --> Database
    API --> Conversion
    Conversion --> Calibration
    Calibration --> Imaging
    Imaging --> Photometry
    Photometry --> Catalog
    Pipeline --> Conversion
    Pipeline --> Calibration
    Pipeline --> Imaging
    Utils --> Conversion
    Utils --> Calibration
    Utils --> Imaging
    
    style Backend fill:#e1f5ff
    style API fill:#ffeb3b
    style Conversion fill:#4caf50
    style Calibration fill:#ff9800
    style Imaging fill:#9c27b0
    style Database fill:#f44336
    style Catalog fill:#00bcd4
    style Photometry fill:#8bc34a
    style Pipeline fill:#ff5722"""

def render_to_svg(mermaid_code, output_file):
    """Render Mermaid diagram to SVG using mermaid.ink API"""
    # Base64 encode the Mermaid code
    mermaid_bytes = mermaid_code.encode('utf-8')
    encoded = base64.urlsafe_b64encode(mermaid_bytes).decode('utf-8').rstrip('=')
    
    # Use mermaid.ink API with base64
    url = f"https://mermaid.ink/svg/{encoded}"
    
    try:
        print(f"Fetching SVG from mermaid.ink...")
        req = urllib.request.Request(url)
        req.add_header('User-Agent', 'Mozilla/5.0')
        
        with urllib.request.urlopen(req, timeout=30) as response:
            svg_content = response.read().decode('utf-8')
        
        # Write to file
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(svg_content)
        
        print(f":check_mark: SVG saved to: {output_file}")
        return True
    except Exception as e:
        print(f":ballot_x: Error rendering SVG: {e}", file=sys.stderr)
        print(f"  URL: {url[:100]}...", file=sys.stderr)
        # Try alternative: save as mermaid file and suggest manual conversion
        mermaid_file = output_file.replace('.svg', '.mmd')
        with open(mermaid_file, 'w', encoding='utf-8') as f:
            f.write(mermaid_code)
        print(f"  Saved Mermaid source to: {mermaid_file}", file=sys.stderr)
        print(f"  You can convert it manually using: https://mermaid.live/", file=sys.stderr)
        return False

if __name__ == "__main__":
    output_file = sys.argv[1] if len(sys.argv) > 1 else "backend_structure.svg"
    success = render_to_svg(MERMAID_CODE, output_file)
    sys.exit(0 if success else 1)
