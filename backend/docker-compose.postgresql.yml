# PostgreSQL configuration for DSA-110 Continuum Imaging Pipeline
#
# This extends the base docker-compose.yml with PostgreSQL support.
# Usage:
#   docker-compose -f docker-compose.postgresql.yml up -d postgres
#
# Environment variables can be set in .env.postgresql or passed directly.

version: "2.2"

services:
  postgres:
    image: postgres:16-alpine
    container_name: dsa110-postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    environment:
      POSTGRES_DB: dsa110
      POSTGRES_USER: dsa110
      POSTGRES_PASSWORD: dsa110_dev_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dsa110 -d dsa110"]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 1g
    memswap_limit: 1g

  # API service configured for PostgreSQL
  api-pg:
    build:
      context: ..
      dockerfile: ops/docker/Dockerfile
    container_name: dsa110-api-pg
    ports:
      - "8001:8000"  # Different port to avoid conflict with SQLite API
    volumes:
      - ./src:/app/src
      - ../state:/app/state
      - /scratch:/scratch
      - /stage:/stage:ro
      - /data:/data:ro
    environment:
      - PYTHONPATH=/app/src
      # PostgreSQL configuration
      - DSA110_DB_BACKEND=postgresql
      - DSA110_DB_PG_HOST=postgres
      - DSA110_DB_PG_PORT=5432
      - DSA110_DB_PG_DATABASE=dsa110
      - DSA110_DB_PG_USER=dsa110
      - DSA110_DB_PG_PASSWORD=dsa110_dev_password
      - DSA110_DB_PG_POOL_MIN=2
      - DSA110_DB_PG_POOL_MAX=10
      # Keep SQLite path for fallback/comparison
      - PIPELINE_PRODUCTS_DB=/app/state/db/products.sqlite3
      - PIPELINE_STATE_DIR=/app/state
    restart: unless-stopped
    depends_on:
      - postgres
    command: uvicorn dsa110_contimg.api:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:

networks:
  default:
