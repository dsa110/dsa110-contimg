#!/bin/bash
# Fix Git Lock File
# Safely removes .git/index.lock if no git process is using it

set -e

LOCK_FILE=".git/index.lock"

if [ ! -f "$LOCK_FILE" ]; then
    echo ":white_heavy_check_mark: No lock file found - nothing to fix"
    exit 0
fi

echo ":warning_sign::variation_selector-16:  Git lock file found: $LOCK_FILE"
echo ""

# Check if any process is using the lock file
PROCESSES=$(lsof "$LOCK_FILE" 2>/dev/null || true)

if [ -n "$PROCESSES" ]; then
    echo ":cross_mark: ERROR: Lock file is in use by running process:"
    echo "$PROCESSES"
    echo ""
    echo "DO NOT remove the lock file while a process is using it!"
    echo "Wait for the git operation to complete, or kill the process first."
    exit 1
fi

# Check for running git processes
GIT_PROCESSES=$(ps aux | grep -E "[g]it|pre-commit" | grep -v "grep" || true)

if [ -n "$GIT_PROCESSES" ]; then
    echo ":warning_sign::variation_selector-16:  WARNING: Git processes are running:"
    echo "$GIT_PROCESSES"
    echo ""
    echo "It's safer to wait for these to complete."
    echo "If you're sure they're not using the lock, you can remove it."
    read -p "Remove lock file anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# Safe to remove
echo "Removing lock file..."
rm -f "$LOCK_FILE"

if [ ! -f "$LOCK_FILE" ]; then
    echo ":white_heavy_check_mark: Lock file removed successfully"
    exit 0
else
    echo ":cross_mark: Failed to remove lock file"
    exit 1
fi

