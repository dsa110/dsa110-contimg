#!/bin/bash
# Validate developer environment setup
# Usage: ./scripts/validate-environment.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

ERRORS=0
WARNINGS=0

echo ":left-pointing_magnifying_glass: Validating developer environment..."
echo ""

# 1. Check casa6 Python
if [ ! -f "/opt/miniforge/envs/casa6/bin/python" ]; then
    echo ":cross_mark: ERROR: casa6 Python not found"
    echo "   Expected: /opt/miniforge/envs/casa6/bin/python"
    ERRORS=$((ERRORS + 1))
else
    echo ":white_heavy_check_mark: casa6 Python found"
fi

# 2. Check error detection
if [ -z "$(type -t _run_with_error_detection 2>/dev/null)" ]; then
    echo ":warning_sign::variation_selector-16:  WARNING: Error detection not enabled"
    echo "   Run: source scripts/developer-setup.sh"
    WARNINGS=$((WARNINGS + 1))
else
    echo ":white_heavy_check_mark: Error detection enabled"
fi

# 3. Check CASA environment
if ! /opt/miniforge/envs/casa6/bin/python -c "import casacore" 2>/dev/null; then
    echo ":warning_sign::variation_selector-16:  WARNING: casacore not importable"
    echo "   CASA environment may need setup"
    WARNINGS=$((WARNINGS + 1))
else
    echo ":white_heavy_check_mark: CASA environment OK"
fi

# 4. Check pre-commit hooks
if [ ! -f "$PROJECT_ROOT/.githooks/pre-commit" ]; then
    echo ":warning_sign::variation_selector-16:  WARNING: Pre-commit hook not found"
    WARNINGS=$((WARNINGS + 1))
else
    if [ ! -x "$PROJECT_ROOT/.githooks/pre-commit" ]; then
        echo ":warning_sign::variation_selector-16:  WARNING: Pre-commit hook not executable"
        WARNINGS=$((WARNINGS + 1))
    else
        echo ":white_heavy_check_mark: Pre-commit hooks configured"
    fi
fi

# 5. Check pytest-safe wrapper
if [ ! -f "$SCRIPT_DIR/pytest-safe.sh" ]; then
    echo ":cross_mark: ERROR: pytest-safe.sh not found"
    ERRORS=$((ERRORS + 1))
else
    if [ ! -x "$SCRIPT_DIR/pytest-safe.sh" ]; then
        echo ":warning_sign::variation_selector-16:  WARNING: pytest-safe.sh not executable"
        WARNINGS=$((WARNINGS + 1))
    else
        echo ":white_heavy_check_mark: pytest-safe.sh available"
    fi
fi

# 6. Check test directories
for dir in tests/smoke tests/unit tests/integration tests/science tests/e2e; do
    if [ ! -d "$PROJECT_ROOT/$dir" ]; then
        echo ":warning_sign::variation_selector-16:  WARNING: Test directory missing: $dir"
        WARNINGS=$((WARNINGS + 1))
    fi
done
if [ $WARNINGS -eq 0 ] || [ $WARNINGS -lt 6 ]; then
    echo ":white_heavy_check_mark: Test directories exist"
fi

# Summary
echo ""
if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo ":white_heavy_check_mark: Environment validation passed!"
    exit 0
elif [ $ERRORS -eq 0 ]; then
    echo ":warning_sign::variation_selector-16:  Validation passed with $WARNINGS warning(s)"
    echo "   Run: ./scripts/auto-fix-common-issues.sh to fix warnings"
    exit 0
else
    echo ":cross_mark: Validation failed with $ERRORS error(s) and $WARNINGS warning(s)"
    echo "   Run: ./scripts/auto-fix-common-issues.sh to fix issues"
    exit 1
fi
