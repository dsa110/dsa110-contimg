#!/bin/bash
# Verification script for implemented fixes
# Date: 2025-11-19

echo "=========================================="
echo "Integration Fixes Verification"
echo "=========================================="
echo ""

# 1. CARTA Service
echo "1. CARTA Service Status"
echo "----------------------"
if docker ps | grep -q carta-backend; then
    echo ":white_heavy_check_mark: CARTA container running"
    if curl -s http://localhost:9002 | grep -q "CARTA"; then
        echo ":white_heavy_check_mark: CARTA frontend responding on port 9002"
    else
        echo ":warning_sign::variation_selector-16:  CARTA frontend not responding"
    fi
    if curl -s http://localhost:9003 | grep -q "CARTA"; then
        echo ":white_heavy_check_mark: CARTA UI responding on port 9003"
    else
        echo ":warning_sign::variation_selector-16:  CARTA UI not responding"
    fi
else
    echo ":cross_mark: CARTA container not running"
    echo "   Fix: docker start carta-backend"
fi
echo ""

# 2. Metadata Registration Code
echo "2. Metadata Registration Code"
echo "----------------------------"
if [ -f "/data/dsa110-contimg/src/dsa110_contimg/database/register_products.py" ]; then
    echo ":white_heavy_check_mark: register_products.py exists"
    
    # Check if it's valid Python
    if /opt/miniforge/envs/casa6/bin/python -m py_compile /data/dsa110-contimg/src/dsa110_contimg/database/register_products.py 2>/dev/null; then
        echo ":white_heavy_check_mark: register_products.py compiles successfully"
        
        # Check for key functions
        if grep -q "def register_image_with_metadata" /data/dsa110-contimg/src/dsa110_contimg/database/register_products.py; then
            echo ":white_heavy_check_mark: register_image_with_metadata() function defined"
        fi
        if grep -q "def register_ms_with_metadata" /data/dsa110-contimg/src/dsa110_contimg/database/register_products.py; then
            echo ":white_heavy_check_mark: register_ms_with_metadata() function defined"
        fi
    else
        echo ":warning_sign::variation_selector-16:  register_products.py has syntax errors"
    fi
else
    echo ":cross_mark: register_products.py not found"
fi
echo ""

# 3. Backend API Status
echo "3. Backend API Status"
echo "--------------------"
if curl -s http://localhost:8000/api/status > /dev/null 2>&1; then
    echo ":white_heavy_check_mark: Backend API responding"
    STATUS=$(curl -s http://localhost:8000/api/status | head -1)
    echo "   Status: $STATUS"
else
    echo ":cross_mark: Backend API not responding"
    if docker ps | grep -q dsa110-api; then
        echo "   Docker container: Running (but unhealthy)"
        docker logs dsa110-api 2>&1 | grep -E "ERROR|CRITICAL" | tail -3
    else
        echo "   Docker container: Not running"
    fi
    echo "   See: BACKEND_RESTART_ISSUE.md"
fi
echo ""

# 4. Database Check
echo "4. Database Status"
echo "-----------------"
if [ -f "/data/dsa110-contimg/state/db/products.sqlite3" ]; then
    echo ":white_heavy_check_mark: products.sqlite3 exists"
    
    # Check if we can query it
    IMAGE_COUNT=$(sqlite3 /data/dsa110-contimg/state/db/products.sqlite3 "SELECT COUNT(*) FROM images;" 2>/dev/null)
    if [ -n "$IMAGE_COUNT" ]; then
        echo ":white_heavy_check_mark: Database accessible: $IMAGE_COUNT images registered"
        
        # Check for metadata completeness
        METADATA_COUNT=$(sqlite3 /data/dsa110-contimg/state/db/products.sqlite3 "SELECT COUNT(*) FROM images WHERE center_ra_deg IS NOT NULL;" 2>/dev/null)
        echo "   Images with metadata: $METADATA_COUNT / $IMAGE_COUNT"
    else
        echo ":warning_sign::variation_selector-16:  Cannot query database"
    fi
else
    echo ":cross_mark: products.sqlite3 not found"
fi
echo ""

# 5. Absurd Status
echo "5. Absurd Workflow Manager"
echo "-------------------------"
if curl -s http://localhost:8000/api/absurd/health > /dev/null 2>&1; then
    echo ":white_heavy_check_mark: Absurd responding"
else
    echo ":cross_mark: Absurd not responding"
    if grep -q "ABSURD_ENABLED=true" /data/dsa110-contimg/.env 2>/dev/null; then
        echo "   Config: ABSURD_ENABLED=true (in .env)"
        echo "   Status: Requires PostgreSQL database"
        echo "   See: IMPLEMENTATION_TEST_SUMMARY.md"
    else
        echo "   Config: Not enabled"
    fi
fi
echo ""

# 6. Frontend Status
echo "6. Frontend Status"
echo "-----------------"
if curl -s http://localhost:3210 | grep -q "DSA-110"; then
    echo ":white_heavy_check_mark: Frontend accessible at http://localhost:3210"
else
    echo ":warning_sign::variation_selector-16:  Frontend not responding"
    echo "   Start with: cd frontend && npm run preview:local"
fi
echo ""

# Summary
echo "=========================================="
echo "Summary"
echo "=========================================="
echo ""
echo ":white_heavy_check_mark: Working:"
echo "   - CARTA service (Docker)"
echo "   - Metadata registration code"
echo "   - Frontend UI"
echo ""
echo ":cross_mark: Blocked:"
echo "   - Backend API (Docker Python version issue)"
echo "   - Absurd (requires PostgreSQL)"
echo ""
echo ":open_book: Documentation:"
echo "   - IMPLEMENTATION_TEST_SUMMARY.md - Full test report"
echo "   - BACKEND_RESTART_ISSUE.md - Backend fix instructions"
echo "   - INTEGRATION_FIXES_QUICK_START.md - Quick start guide"
echo ""
