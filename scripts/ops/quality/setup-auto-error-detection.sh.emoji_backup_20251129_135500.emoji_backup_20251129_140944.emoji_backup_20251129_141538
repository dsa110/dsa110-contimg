#!/bin/bash
# Setup script to enable auto error detection
# This adds the error detection wrapper to your shell profile

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Detect shell
if [ -n "${ZSH_VERSION:-}" ]; then
    SHELL_RC="$HOME/.zshrc"
    SHELL_NAME="zsh"
elif [ -n "${BASH_VERSION:-}" ]; then
    SHELL_RC="$HOME/.bashrc"
    SHELL_NAME="bash"
else
    echo "Error: Unsupported shell. Please use bash or zsh." >&2
    exit 1
fi

# Check if already configured
if grep -q "auto-error-detection" "$SHELL_RC" 2>/dev/null; then
    echo ":warning_sign::variation_selector-16:  Auto error detection already configured in $SHELL_RC"
    echo ""
    echo "Current configuration:"
    grep -A 3 "auto-error-detection" "$SHELL_RC" | head -5
    echo ""
    read -p "Reinstall? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Keeping existing configuration."
        exit 0
    fi
    # Remove old configuration
    sed -i '/# Auto Error Detection/,/^fi$/d' "$SHELL_RC" 2>/dev/null || \
    sed -i '/auto-error-detection/,/^fi$/d' "$SHELL_RC" 2>/dev/null || true
    echo "Removed old configuration."
fi

# Create backup
BACKUP_FILE="${SHELL_RC}.backup.$(date +%Y%m%d_%H%M%S)"
cp "$SHELL_RC" "$BACKUP_FILE"
echo ":white_heavy_check_mark: Created backup: $BACKUP_FILE"

# Create BASH_ENV script for non-interactive shells
BASH_ENV_SCRIPT="$PROJECT_ROOT/scripts/auto-error-detection-env.sh"
cat > "$BASH_ENV_SCRIPT" << 'BASHENVEOF'
#!/bin/bash
# Auto Error Detection Environment Script
# This file is sourced by BASH_ENV for non-interactive shells
# It ensures error detection is always enabled in agentic/automated sessions

if [ -f "/data/dsa110-contimg/scripts/auto-error-detection.sh" ]; then
    source "/data/dsa110-contimg/scripts/auto-error-detection.sh" >/dev/null 2>&1
fi
BASHENVEOF
chmod +x "$BASH_ENV_SCRIPT"
echo ":white_heavy_check_mark: Created BASH_ENV script: $BASH_ENV_SCRIPT"

# Set BASH_ENV in ~/.profile (sourced for login shells, including agentic sessions)
PROFILE_FILE="$HOME/.profile"
if [ ! -f "$PROFILE_FILE" ]; then
    touch "$PROFILE_FILE"
fi

# Check if BASH_ENV is already set in ~/.profile
if ! grep -q "BASH_ENV.*auto-error-detection-env.sh" "$PROFILE_FILE" 2>/dev/null; then
    cat >> "$PROFILE_FILE" << PROFILEEOF

# Auto Error Detection - Set BASH_ENV for all shells (including non-interactive/agentic)
# This ensures error detection works in agentic sessions, CI/CD, and automated scripts
export BASH_ENV="$BASH_ENV_SCRIPT"
PROFILEEOF
    echo ":white_heavy_check_mark: Added BASH_ENV to $PROFILE_FILE"
else
    echo ":warning_sign::variation_selector-16:  BASH_ENV already configured in $PROFILE_FILE"
fi

# Add configuration to shell RC
cat >> "$SHELL_RC" << EOF

# Auto Error Detection (added by setup-auto-error-detection.sh)
# Automatically wraps commands with error detection
if [ -f "$PROJECT_ROOT/scripts/auto-error-detection.sh" ]; then
    source "$PROJECT_ROOT/scripts/auto-error-detection.sh"
fi

# Set BASH_ENV for non-interactive shells (agentic/automated sessions)
# This ensures error detection works even when ~/.bashrc is not sourced
export BASH_ENV="$BASH_ENV_SCRIPT"
EOF

# Create agent setup script for explicit agentic session setup
AGENT_SETUP_SCRIPT="$PROJECT_ROOT/scripts/developer-setup.sh"
cat > "$AGENT_SETUP_SCRIPT" << 'AGENTSETUPEOF'
#!/bin/bash
# Agent Setup Script
# Source this at the start of any agentic session to ensure error detection is enabled
# This is the MOST RELIABLE way to ensure error detection works in agentic sessions

# Set BASH_ENV if not already set
if [ -z "${BASH_ENV:-}" ]; then
    export BASH_ENV="/data/dsa110-contimg/scripts/auto-error-detection-env.sh"
fi

# Source error detection if not already enabled
if [ -z "${AUTO_ERROR_DETECTION:-}" ]; then
    if [ -f "/data/dsa110-contimg/scripts/auto-error-detection.sh" ]; then
        source "/data/dsa110-contimg/scripts/auto-error-detection.sh" >/dev/null 2>&1
    fi
fi

echo ":white_heavy_check_mark: Error detection enabled for agentic session"
echo "   BASH_ENV=${BASH_ENV}"
echo "   AUTO_ERROR_DETECTION=${AUTO_ERROR_DETECTION:-not set}"
AGENTSETUPEOF
chmod +x "$AGENT_SETUP_SCRIPT"
echo ":white_heavy_check_mark: Created agent setup script: $AGENT_SETUP_SCRIPT"

echo ":white_heavy_check_mark: Auto error detection configured!"
echo ""
echo "Configuration added to:"
echo "  - $SHELL_RC (for interactive shells)"
echo "  - BASH_ENV=$BASH_ENV_SCRIPT (for non-interactive shells)"
echo ""
echo "To activate:"
echo "  source $SHELL_RC"
echo "  # Or restart your terminal"
echo ""
echo "To disable temporarily:"
echo "  unset AUTO_ERROR_DETECTION"
echo ""
echo "To disable permanently:"
echo "  Remove the auto-error-detection section from $SHELL_RC"
echo "  Unset BASH_ENV: unset BASH_ENV"

