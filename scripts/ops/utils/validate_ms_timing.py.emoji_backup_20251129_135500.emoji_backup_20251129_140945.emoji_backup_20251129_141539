#!/opt/miniforge/envs/casa6/bin/python
"""
Command-line script for validating MS file timing correctness.

This script performs comprehensive validation of TIME extraction from MS files,
checking consistency and correctness against multiple sources.
"""

import argparse
import json
import sys
from pathlib import Path

# Add src to path
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from dsa110_contimg.utils.time_validation import comprehensive_time_validation


def main():
    parser = argparse.ArgumentParser(
        description="Validate MS file timing correctness",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Basic validation
  python validate_ms_timing.py /stage/dsa110-contimg/ms/science/2025-10-29/2025-10-29T13:32:03.ms

  # With UVH5 source file
  python validate_ms_timing.py /stage/dsa110-contimg/ms/science/2025-10-29/2025-10-29T13:32:03.ms \\
    --uvh5 /data/incoming/2025-10-29T13:30:00/2025-10-29T13:32:03.uvh5

  # With pointing RA for LST validation
  python validate_ms_timing.py /stage/dsa110-contimg/ms/science/2025-10-29/2025-10-29T13:32:03.ms \\
    --pointing-ra 123.45

  # JSON output
  python validate_ms_timing.py /stage/dsa110-contimg/ms/science/2025-10-29/2025-10-29T13:32:03.ms --json
        """
    )
    parser.add_argument(
        "ms_path",
        type=str,
        help="Path to Measurement Set file"
    )
    parser.add_argument(
        "--uvh5",
        type=str,
        help="Path to source UVH5 file (for cross-validation)"
    )
    parser.add_argument(
        "--pointing-ra",
        type=float,
        help="Pointing RA in degrees (for LST validation)"
    )
    parser.add_argument(
        "--expected-duration",
        type=float,
        help="Expected observation duration in minutes"
    )
    parser.add_argument(
        "--json",
        action="store_true",
        help="Output results as JSON"
    )
    
    args = parser.parse_args()
    
    # Run validation
    results = comprehensive_time_validation(
        args.ms_path,
        uvh5_path=args.uvh5,
        pointing_ra_deg=args.pointing_ra,
        expected_duration_minutes=args.expected_duration
    )
    
    # Output results
    if args.json:
        print(json.dumps(results, indent=2))
    else:
        print("=" * 80)
        print("MS TIME VALIDATION RESULTS")
        print("=" * 80)
        print(f"\nMS File: {args.ms_path}")
        
        if results['extracted_time']:
            print(f"\nExtracted Time:")
            print(f"  Start: {results['extracted_time']['start_iso']}")
            print(f"  End:   {results['extracted_time']['end_iso']}")
            print(f"  Mid:   {results['extracted_time']['mid_iso']}")
        
        print(f"\nValidation Checks:")
        for check_name, check_result in results['checks'].items():
            status = ":check_mark: PASS" if check_result['valid'] else ":ballot_x: FAIL"
            print(f"  {check_name:20s} {status}")
            if check_result.get('error'):
                print(f"    Error: {check_result['error']}")
            if 'time_diff_hours' in check_result and check_result['time_diff_hours'] is not None:
                print(f"    Time difference: {check_result['time_diff_hours']:.3f} hours")
            if 'time_diff_seconds' in check_result and check_result['time_diff_seconds'] is not None:
                print(f"    Time difference: {check_result['time_diff_seconds']:.3f} seconds")
            if 'lst_diff_deg' in check_result and check_result['lst_diff_deg'] is not None:
                print(f"    LST difference: {check_result['lst_diff_deg']:.3f} degrees")
            if 'duration_minutes' in check_result and check_result['duration_minutes'] is not None:
                print(f"    Duration: {check_result['duration_minutes']:.2f} minutes")
        
        if results['warnings']:
            print(f"\nWarnings:")
            for warning in results['warnings']:
                print(f"  :warning_sign: {warning}")
        
        if results['errors']:
            print(f"\nErrors:")
            for error in results['errors']:
                print(f"  :ballot_x: {error}")
        
        print(f"\n{'=' * 80}")
        if results['all_valid']:
            print("OVERALL: :check_mark: ALL CHECKS PASSED")
            return 0
        else:
            print("OVERALL: :ballot_x: VALIDATION FAILED")
            return 1


if __name__ == "__main__":
    sys.exit(main())

