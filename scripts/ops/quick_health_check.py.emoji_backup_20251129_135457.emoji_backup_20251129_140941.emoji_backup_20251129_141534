#!/opt/miniforge/envs/casa6/bin/python
# -*- coding: utf-8 -*-
"""
Quick health check for calibrators system.

Efficiently verifies:
1. Database accessibility
2. Calibrator registration
3. Query functionality
4. Recent log errors
"""

import sqlite3
import sys
from datetime import datetime
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from dsa110_contimg.database.calibrators import (
    get_bandpass_calibrators,
    get_calibrators_db_path,
)


def check_database():
    """Check database exists and is accessible."""
    db_path = get_calibrators_db_path()

    if not db_path.exists():
        return False, f"Database not found: {db_path}"

    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.execute("SELECT COUNT(*) FROM bandpass_calibrators")
        count = cursor.fetchone()[0]
        conn.close()
        return True, f"Database OK ({count} calibrators)"
    except Exception as e:
        return False, f"Database error: {e}"


def check_queries():
    """Test calibrator queries at key declinations."""
    test_points = [
        (30.0, "3C286 region"),
        (33.0, "3C48 region"),
        (50.0, "Mid-northern"),
        (55.0, "0834+555 region"),
    ]

    results = []
    for dec_deg, desc in test_points:
        try:
            calibrators = get_bandpass_calibrators(dec_deg=dec_deg, status="active")
            # Verify results are actually in range
            valid = [
                cal
                for cal in calibrators
                if cal.get("dec_range_min") is None
                or (cal.get("dec_range_min") <= dec_deg <= cal.get("dec_range_max"))
            ]
            results.append((dec_deg, len(valid), len(calibrators)))
        except Exception as e:
            results.append((dec_deg, -1, str(e)))

    return results


def check_recent_logs():
    """Check for recent errors in logs."""
    log_dir = Path("state/logs")
    if not log_dir.exists():
        return []

    errors = []
    # Check last 3 days of logs
    for log_file in sorted(log_dir.glob("*.log"), key=lambda p: p.stat().st_mtime, reverse=True)[
        :5
    ]:
        try:
            # Quick check - just last 100 lines
            with open(log_file, "r") as f:
                lines = f.readlines()[-100:]
                for i, line in enumerate(lines):
                    if any(keyword in line.lower() for keyword in ["error", "exception", "fail"]):
                        if "calibrator" in line.lower() or "database" in line.lower():
                            errors.append((log_file.name, len(lines) - i, line.strip()[:100]))
                            if len(errors) >= 5:
                                return errors
        except Exception:
            pass

    return errors


def main():
    print("=" * 70)
    print("Calibrators System Health Check")
    print("=" * 70)
    print(f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print()

    # 1. Database check
    print("1. Database Status:")
    ok, msg = check_database()
    status = ":white_heavy_check_mark:" if ok else ":cross_mark:"
    print(f"   {status} {msg}")
    print()

    if not ok:
        print(":cross_mark: Database check failed. Stopping.")
        return 1

    # 2. Query check
    print("2. Query Functionality:")
    results = check_queries()
    all_ok = True
    for dec_deg, valid_count, total_count in results:
        if valid_count == -1:
            print(f"   :cross_mark: Dec {dec_deg:6.1f}째: Error - {total_count}")
            all_ok = False
        elif valid_count == 0:
            print(f"   :warning_sign::variation_selector-16:  Dec {dec_deg:6.1f}째: No calibrators found")
        elif valid_count < total_count:
            print(f"   :warning_sign::variation_selector-16:  Dec {dec_deg:6.1f}째: {valid_count}/{total_count} valid (filtering issue)")
            all_ok = False
        else:
            print(f"   :white_heavy_check_mark: Dec {dec_deg:6.1f}째: {valid_count} calibrator(s)")

    print()

    # 3. Recent errors
    print("3. Recent Log Errors:")
    errors = check_recent_logs()
    if errors:
        print(f"   :warning_sign::variation_selector-16:  Found {len(errors)} recent error(s):")
        for log_file, line_num, error_msg in errors[:5]:
            print(f"      {log_file}:{line_num} - {error_msg}")
    else:
        print("   :white_heavy_check_mark: No recent errors found")

    print()
    print("=" * 70)

    if ok and all_ok and not errors:
        print(":white_heavy_check_mark: System Health: GOOD")
        return 0
    else:
        print(":warning_sign::variation_selector-16:  System Health: ISSUES DETECTED")
        return 1


if __name__ == "__main__":
    sys.exit(main())
