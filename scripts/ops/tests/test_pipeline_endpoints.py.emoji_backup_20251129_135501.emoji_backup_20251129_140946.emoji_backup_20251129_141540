#!/opt/miniforge/envs/casa6/bin/python
"""Test script for pipeline monitoring API endpoints."""

import json
import sys
import time
from pathlib import Path

# Add project root to path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root / "src"))

from dsa110_contimg.database.jobs import ensure_jobs_table
from dsa110_contimg.pipeline.state import JobState, SQLiteStateRepository


def create_test_execution(
    repo: SQLiteStateRepository, job_type: str = "workflow", status: str = "running"
):
    """Create a test pipeline execution."""
    context = {
        "ms_path": "/test/path/to/test.ms",
        "stage_results": {
            "catalog_setup": {
                "status": "completed",
                "duration_seconds": 5.2,
                "attempt": 1,
                "started_at": time.time() - 100,
                "completed_at": time.time() - 95,
            },
            "conversion": {
                "status": "completed",
                "duration_seconds": 120.5,
                "attempt": 1,
                "started_at": time.time() - 90,
                "completed_at": time.time() - 30,
            },
            "calibration_solve": {
                "status": status,
                "duration_seconds": 30.0 if status == "completed" else None,
                "attempt": 1,
                "started_at": time.time() - 30,
                "completed_at": time.time() if status == "completed" else None,
            },
        },
    }

    job_id = repo.create_job(job_type, context)

    if status == "running":
        repo.update_job(job_id, {"status": "running", "started_at": time.time() - 30})
    elif status == "completed":
        repo.update_job(
            job_id,
            {
                "status": "completed",
                "started_at": time.time() - 100,
                "finished_at": time.time(),
            },
        )
    elif status == "failed":
        repo.update_job(
            job_id,
            {
                "status": "failed",
                "started_at": time.time() - 100,
                "finished_at": time.time(),
                "error_message": "Test error: Calibration solve failed",
            },
        )
        # Update stage to failed
        context["stage_results"]["calibration_solve"]["status"] = "failed"
        context["stage_results"]["calibration_solve"]["error_message"] = "Test error"
        repo.update_job(job_id, {"context": context})

    return job_id


def main():
    """Main test function."""
    import os
    from pathlib import Path

    # Get database path from environment or use default
    products_db = Path(os.getenv("PRODUCTS_DB", "/data/dsa110-contimg/state/db/products.sqlite3"))

    if not products_db.exists():
        print(f"ERROR: Database not found at {products_db}")
        print("Creating database...")
        products_db.parent.mkdir(parents=True, exist_ok=True)
        ensure_jobs_table(products_db)

    repo = SQLiteStateRepository(products_db)

    print("=" * 60)
    print("Pipeline API Endpoint Testing")
    print("=" * 60)

    # Create test executions
    print("\n1. Creating test pipeline executions...")
    running_id = create_test_execution(repo, "workflow", "running")
    print(f"   :check_mark: Created running execution: {running_id}")

    completed_id = create_test_execution(repo, "workflow", "completed")
    print(f"   :check_mark: Created completed execution: {completed_id}")

    failed_id = create_test_execution(repo, "calibration", "failed")
    print(f"   :check_mark: Created failed execution: {failed_id}")

    # List existing jobs
    print("\n2. Listing existing jobs...")
    all_jobs = repo.list_jobs(limit=10)
    print(f"   Found {len(all_jobs)} total jobs")
    for job in all_jobs[:5]:
        print(f"   - Job {job.id}: {job.type} - {job.status}")

    print("\n" + "=" * 60)
    print("Test data created successfully!")
    print("=" * 60)
    print(f"\nTest execution IDs:")
    print(f"  Running: {running_id}")
    print(f"  Completed: {completed_id}")
    print(f"  Failed: {failed_id}")
    print(f"\nYou can now test the API endpoints:")
    print(f"  GET /api/pipeline/executions")
    print(f"  GET /api/pipeline/executions/active")
    print(f"  GET /api/pipeline/executions/{running_id}")
    print(f"  GET /api/pipeline/stages/metrics")
    print(f"  GET /api/pipeline/dependency-graph")
    print(f"  GET /api/pipeline/metrics/summary")


if __name__ == "__main__":
    main()
