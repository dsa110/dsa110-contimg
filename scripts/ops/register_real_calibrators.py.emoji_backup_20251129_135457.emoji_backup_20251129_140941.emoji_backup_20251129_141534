#!/opt/miniforge/envs/casa6/bin/python
# -*- coding: utf-8 -*-
"""
Register real VLA calibrators in calibrators.sqlite3

This script registers commonly used VLA calibrators for production use.
"""

import sys
from pathlib import Path

# Add src to path
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from dsa110_contimg.database.calibrators import (
    ensure_calibrators_db,
    get_bandpass_calibrators,
    get_calibrators_db_path,
    register_bandpass_calibrator,
)

# Common VLA calibrators with their properties
# Format: (name, ra_deg, dec_deg, flux_jy, dec_range_tolerance)
VLA_CALIBRATORS = [
    # Bright northern calibrators
    ("3C286", 202.7845, 30.5092, 14.9, 5.0),  # Standard flux calibrator
    ("3C48", 24.4221, 33.1597, 5.5, 5.0),  # Northern calibrator
    ("3C147", 85.6542, 49.8522, 22.0, 5.0),  # Bright northern calibrator
    ("3C138", 79.3608, 16.5075, 8.0, 5.0),  # Northern calibrator
    # Mid-declination calibrators
    ("3C295", 212.8354, 52.2028, 22.0, 5.0),  # Bright calibrator
    ("3C196", 123.4008, 48.2172, 12.0, 5.0),  # Northern calibrator
    # Southern calibrators
    ("3C48", 24.4221, 33.1597, 5.5, 5.0),  # Already listed above
    ("3C286", 202.7845, 30.5092, 14.9, 5.0),  # Already listed above
    # Specific calibrator mentioned in tests
    ("0834+555", 129.2758, 55.2456, 2.5, 5.0),  # VLA calibrator from tests
]

# Additional calibrators for broader coverage
ADDITIONAL_CALIBRATORS = [
    ("3C84", 49.9507, 41.5117, 28.0, 5.0),  # Very bright northern
    ("3C123", 69.2375, 29.6725, 20.0, 5.0),  # Bright northern
    ("3C161", 97.0000, -5.0000, 15.0, 5.0),  # Equatorial
    ("3C273", 187.2779, 2.0524, 50.0, 5.0),  # Very bright equatorial
]


def register_calibrators(calibrators_db=None, dry_run=False):
    """Register all calibrators in the database.

    Args:
        calibrators_db: Path to calibrators database (None = auto-detect)
        dry_run: If True, only print what would be registered
    """
    if calibrators_db is None:
        calibrators_db = get_calibrators_db_path()

    print(f"Using database: {calibrators_db}")

    if not dry_run:
        ensure_calibrators_db(calibrators_db)

    registered_count = 0
    skipped_count = 0

    # Combine all calibrators
    all_calibrators = VLA_CALIBRATORS + ADDITIONAL_CALIBRATORS

    # Remove duplicates (keep first occurrence)
    seen = set()
    unique_calibrators = []
    for cal in all_calibrators:
        if cal[0] not in seen:
            seen.add(cal[0])
            unique_calibrators.append(cal)

    print(f"\nRegistering {len(unique_calibrators)} unique calibrators...")
    print("-" * 70)

    for name, ra_deg, dec_deg, flux_jy, dec_tolerance in unique_calibrators:
        dec_range_min = dec_deg - dec_tolerance
        dec_range_max = dec_deg + dec_tolerance

        # Check if already registered
        if not dry_run:
            # Query by declination and check if name matches
            existing = get_bandpass_calibrators(dec_deg=dec_deg, calibrators_db=calibrators_db)
            if existing and any(cal["calibrator_name"] == name for cal in existing):
                print(
                    f"⏭:variation_selector-16:  SKIP: {name:12s} (RA={ra_deg:8.4f}, Dec={dec_deg:7.4f}) - Already registered"
                )
                skipped_count += 1
                continue

        if dry_run:
            print(
                f":memo: WOULD REGISTER: {name:12s} (RA={ra_deg:8.4f}, Dec={dec_deg:7.4f}, "
                f"Flux={flux_jy:5.1f} Jy, Dec range=[{dec_range_min:5.1f}, {dec_range_max:5.1f}])"
            )
        else:
            try:
                register_bandpass_calibrator(
                    calibrator_name=name,
                    ra_deg=ra_deg,
                    dec_deg=dec_deg,
                    dec_range_min=dec_range_min,
                    dec_range_max=dec_range_max,
                    source_catalog="VLA",
                    flux_jy=flux_jy,
                    registered_by="register_real_calibrators.py",
                    status="active",
                    notes=f"Standard VLA calibrator, flux={flux_jy} Jy",
                    calibrators_db=calibrators_db,
                )
                print(
                    f":white_heavy_check_mark: REGISTERED: {name:12s} (RA={ra_deg:8.4f}, Dec={dec_deg:7.4f}, "
                    f"Flux={flux_jy:5.1f} Jy)"
                )
                registered_count += 1
            except Exception as e:
                print(f":cross_mark: ERROR: {name:12s} - {e}")

    print("-" * 70)
    if dry_run:
        print(f"\nDry-run complete. Would register {len(unique_calibrators)} calibrators.")
    else:
        print(f"\nRegistration complete:")
        print(f"  :white_heavy_check_mark: Registered: {registered_count}")
        print(f"  ⏭:variation_selector-16:  Skipped: {skipped_count}")
        print(f"  :bar_chart: Total: {len(unique_calibrators)}")

        # Verify registration
        total_in_db = len(get_bandpass_calibrators(calibrators_db=calibrators_db))
        print(f"\nTotal calibrators in database: {total_in_db}")


def verify_registration(calibrators_db=None):
    """Verify calibrators are registered and queryable.

    Args:
        calibrators_db: Path to calibrators database (None = auto-detect)
    """
    if calibrators_db is None:
        calibrators_db = get_calibrators_db_path()

    print(f"\n{'='*70}")
    print("Verification: Testing calibrator queries")
    print(f"{'='*70}\n")

    # Test queries at various declinations
    test_decs = [30.0, 33.0, 50.0, 55.0, 0.0, -5.0]

    for dec_deg in test_decs:
        calibrators = get_bandpass_calibrators(
            dec_deg=dec_deg, status="active", calibrators_db=calibrators_db
        )

        if calibrators:
            print(f"Dec {dec_deg:6.1f}°: Found {len(calibrators)} calibrator(s)")
            for cal in calibrators[:3]:  # Show first 3
                print(
                    f"  - {cal['calibrator_name']:12s} "
                    f"(RA={cal['ra_deg']:8.4f}, Dec={cal['dec_deg']:7.4f}, "
                    f"Flux={cal.get('flux_jy', 'N/A')} Jy)"
                )
        else:
            print(f"Dec {dec_deg:6.1f}°: No calibrators found")

    print()


def main():
    import argparse

    parser = argparse.ArgumentParser(
        description="Register real VLA calibrators in calibrators.sqlite3"
    )
    parser.add_argument(
        "--calibrators-db",
        type=Path,
        default=None,
        help="Path to calibrators database (default: auto-detect)",
    )
    parser.add_argument(
        "--dry-run", action="store_true", help="Perform a dry run without making changes"
    )
    parser.add_argument(
        "--verify", action="store_true", help="Verify registration after completion"
    )

    args = parser.parse_args()

    register_calibrators(calibrators_db=args.calibrators_db, dry_run=args.dry_run)

    if args.verify and not args.dry_run:
        verify_registration(calibrators_db=args.calibrators_db)


if __name__ == "__main__":
    main()
