#!/bin/bash
# Diagnostic script to test API endpoints and identify failures

BASE_URL="http://localhost:8000/api"
echo "=========================================="
echo "API Endpoint Diagnostic Tool"
echo "=========================================="
echo ""

test_endpoint() {
  local endpoint=$1
  echo -n "Testing $endpoint ... "
  response=$(curl -s -w "\n%{http_code}" "$BASE_URL$endpoint" 2>&1)
  http_code=$(echo "$response" | tail -1)
  body=$(echo "$response" | sed '$d')
  
  if [ "$http_code" = "200" ]; then
    echo ":check_mark: OK"
    return 0
  elif [ "$http_code" = "404" ]; then
    echo ":ballot_x: 404 Not Found"
    return 1
  elif [ "$http_code" = "500" ]; then
    error_msg=$(echo "$body" | grep -o '"detail":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "Internal Server Error")
    echo ":ballot_x: 500 Error: $error_msg"
    return 1
  elif [ "$http_code" = "422" ]; then
    error_msg=$(echo "$body" | grep -o '"detail"[^}]*' | head -1 | cut -c1-60 || echo "Validation Error")
    echo ":warning_sign: 422 Validation: $error_msg"
    return 1
  elif [ "$http_code" = "000" ]; then
    echo ":ballot_x: Connection Failed (Backend not running?)"
    return 1
  else
    echo ":warning_sign: $http_code"
    return 1
  fi
}

echo "=== Core Status ==="
test_endpoint "/status"
test_endpoint "/health/summary"
echo ""

echo "=== System Metrics ==="
test_endpoint "/metrics/system"
echo ""

echo "=== Streaming ==="
test_endpoint "/streaming/status"
test_endpoint "/streaming/health"
test_endpoint "/streaming/config"
test_endpoint "/streaming/metrics"
echo ""

echo "=== Pipeline ==="
test_endpoint "/pipeline/executions/active"
test_endpoint "/pipeline/dependency-graph"
test_endpoint "/pipeline/metrics/summary"
echo ""

echo "=== Events ==="
test_endpoint "/events/stats"
test_endpoint "/events/types"
echo ""

echo "=== Cache ==="
test_endpoint "/cache/stats"
test_endpoint "/cache/performance"
echo ""

echo "=== Operations ==="
test_endpoint "/operations/dlq/stats"
test_endpoint "/operations/circuit-breakers"
echo ""

echo "=== Visualization ==="
test_endpoint "/visualization/browse?path=state"
test_endpoint "/visualization/browse?path=/data"
echo ""

echo "=== Pointing Monitor ==="
test_endpoint "/pointing-monitor/status"
echo ""
echo "Done! Check output above for failures."
