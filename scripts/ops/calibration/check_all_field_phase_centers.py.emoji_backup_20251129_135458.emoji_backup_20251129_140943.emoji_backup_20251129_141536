#!/opt/miniforge/envs/casa6/bin/python
"""
Quick diagnostic script to verify phase center alignment for all fields.

Usage:
    python check_all_field_phase_centers.py <ms_path> <cal_ra_deg> <cal_dec_deg>
    
Example:
    python check_all_field_phase_centers.py /stage/dsa110-contimg/ms/2025-10-29T13:54:17.ms 128.7287 55.5725
"""

import sys

import astropy.units as u
import numpy as np
from astropy.coordinates import SkyCoord
from casacore.tables import table


def check_field_phase_centers(ms_path, cal_ra_deg, cal_dec_deg):
    """Check phase centers for all fields in MS."""
    
    print("=" * 100)
    print(f"Phase Center Diagnostic: {ms_path}")
    print("=" * 100)
    
    cal_coord = SkyCoord(ra=cal_ra_deg*u.deg, dec=cal_dec_deg*u.deg)
    
    with table(f"{ms_path}::FIELD", readonly=True) as tf:
        nfields = tf.nrows()
        
        if "PHASE_DIR" in tf.colnames():
            phase_dir = tf.getcol("PHASE_DIR")  # Shape: (nfields, 1, 2)
        else:
            print("WARNING: PHASE_DIR not found, using REFERENCE_DIR")
            phase_dir = tf.getcol("REFERENCE_DIR")
        
        ref_dir = tf.getcol("REFERENCE_DIR") if "REFERENCE_DIR" in tf.colnames() else phase_dir
        
        print(f"\nCalibrator position: RA={cal_ra_deg:.6f}°, Dec={cal_dec_deg:.6f}°")
        print(f"Total fields: {nfields}")
        print("\nField\tPHASE_DIR RA\t\tPHASE_DIR Dec\t\tREFERENCE_DIR RA\tREFERENCE_DIR Dec\tSeparation (arcmin)")
        print("-" * 100)
        
        separations = []
        mismatches = []
        
        for field_idx in range(nfields):
            pc_ra_rad = phase_dir[field_idx][0][0]
            pc_dec_rad = phase_dir[field_idx][0][1]
            pc_ra_deg = np.rad2deg(pc_ra_rad)
            pc_dec_deg = np.rad2deg(pc_dec_rad)
            
            ref_ra_rad = ref_dir[field_idx][0][0]
            ref_dec_rad = ref_dir[field_idx][0][1]
            ref_ra_deg = np.rad2deg(ref_ra_rad)
            ref_dec_deg = np.rad2deg(ref_dec_rad)
            
            pc_coord = SkyCoord(ra=pc_ra_deg*u.deg, dec=pc_dec_deg*u.deg)
            separation = pc_coord.separation(cal_coord)
            sep_arcmin = separation.to(u.arcmin).value
            separations.append(sep_arcmin)
            
            # Check if PHASE_DIR matches REFERENCE_DIR
            pc_ref_diff = np.sqrt((pc_ra_rad - ref_ra_rad)**2 + (pc_dec_rad - ref_dec_rad)**2)
            if pc_ref_diff > 2.9e-5:  # > 1 arcmin
                mismatches.append(field_idx)
            
            status = ":check_mark:" if sep_arcmin < 0.1 else ":ballot_x:"
            print(f"{field_idx}\t{pc_ra_deg:.6f}\t{pc_dec_deg:.6f}\t{ref_ra_deg:.6f}\t{ref_dec_deg:.6f}\t{sep_arcmin:.2f} {status}")
        
        print("-" * 100)
        print(f"\nSummary:")
        print(f"  Maximum separation: {max(separations):.2f} arcmin")
        print(f"  Minimum separation: {min(separations):.2f} arcmin")
        print(f"  Mean separation: {np.mean(separations):.2f} arcmin")
        print(f"  Fields with separation > 1 arcmin: {sum(1 for s in separations if s > 1.0)}")
        print(f"  Fields with separation > 0.1 arcmin: {sum(1 for s in separations if s > 0.1)}")
        
        if mismatches:
            print(f"\n  WARNING: PHASE_DIR != REFERENCE_DIR for fields: {mismatches}")
        
        if max(separations) > 1.0:
            print(f"\n  :ballot_x: PHASE CENTER INCOHERENCE DETECTED")
            print(f"    Maximum separation ({max(separations):.2f} arcmin) exceeds 1 arcmin tolerance")
            print(f"    This is likely causing MODEL_DATA phase structure errors and high phase scatter")
            print(f"    :arrow_right: Run phase center alignment fix (see PHASE_CENTER_FIX_SOLUTION_PATH.md)")
        else:
            print(f"\n  :check_mark: All phase centers aligned (within 1 arcmin tolerance)")
        
        return max(separations), separations

if __name__ == "__main__":
    if len(sys.argv) < 4:
        print(__doc__)
        sys.exit(1)
    
    ms_path = sys.argv[1]
    cal_ra_deg = float(sys.argv[2])
    cal_dec_deg = float(sys.argv[3])
    
    max_sep, separations = check_field_phase_centers(ms_path, cal_ra_deg, cal_dec_deg)
    
    sys.exit(0 if max_sep < 1.0 else 1)

