#!/opt/miniforge/envs/casa6/bin/python
"""
Solve bandpass WITHOUT pre-bandpass phase correction.

Usage:
    python scripts/solve_bandpass_only.py --ms /path/to/ms.ms --field 0 --refant 103
"""

import argparse
import sys
from pathlib import Path

# Add src to path
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

import numpy as np
from casacore.tables import table

from dsa110_contimg.calibration.calibration import solve_bandpass


def main():
    parser = argparse.ArgumentParser(description='Solve bandpass without pre-bandpass phase correction')
    parser.add_argument('--ms', required=True, help='Path to Measurement Set')
    parser.add_argument('--field', default='0', help='Field selection (default: 0)')
    parser.add_argument('--refant', required=True, help='Reference antenna')
    parser.add_argument('--combine-spw', action='store_true', help='Combine SPWs during solve')
    parser.add_argument('--bp-minsnr', type=float, default=3.0, help='Minimum SNR for bandpass (default: 3.0)')
    parser.add_argument('--uvrange', default='', help='UV range selection (default: none)')
    
    args = parser.parse_args()
    
    ms_path = args.ms
    refant = args.refant
    field = args.field
    
    print('=' * 70)
    print('Solving Bandpass (NO pre-bandpass phase correction)')
    print('=' * 70)
    print(f'MS: {ms_path}')
    print(f'Field: {field}')
    print(f'Refant: {refant}')
    print(f'Combine SPW: {args.combine_spw}')
    print(f'Min SNR: {args.bp_minsnr}')
    print()
    
    # Verify MODEL_DATA exists and is populated
    print('1. Verifying MODEL_DATA...')
    with table(ms_path, readonly=True) as tb:
        if 'MODEL_DATA' not in tb.colnames():
            print(':ballot_x: MODEL_DATA column not found!')
            sys.exit(1)
        
        n_sample = min(1000, tb.nrows())
        model_sample = tb.getcol('MODEL_DATA', startrow=0, nrow=n_sample)
        flags = tb.getcol('FLAG', startrow=0, nrow=n_sample)
        unflagged = ~flags.any(axis=(1, 2))
        
        if unflagged.sum() == 0:
            print(':ballot_x: All MODEL_DATA is flagged!')
            sys.exit(1)
        
        model_unflagged = model_sample[unflagged]
        amps = np.abs(model_unflagged)
        phases_rad = np.angle(model_unflagged[:, 0, 0])
        phases_deg = np.degrees(phases_rad)
        
        print(f'   Amplitude: median={np.median(amps):.3f} Jy, std={np.std(amps):.3f} Jy')
        print(f'   Phase scatter: std={np.std(phases_deg):.2f}°')
        if np.std(phases_deg) < 10.0:
            print(f'   :check_mark: MODEL_DATA phase structure is correct (<10° scatter)')
        else:
            print(f'   :warning_sign: WARNING: MODEL_DATA phase scatter is high ({np.std(phases_deg):.2f}°)')
    
    # Run bandpass solve WITHOUT pre-bandpass phase correction
    print('\n2. Solving bandpass (no pre-bandpass phase)...')
    try:
        bp_tables = solve_bandpass(
            ms_path,
            field,
            refant,
            ktable=None,
            combine_fields=False,
            combine_spw=args.combine_spw,
            minsnr=args.bp_minsnr,
            uvrange=args.uvrange,
            prebandpass_phase_table=None,  # No pre-bandpass phase correction
        )
        print(f':check_mark: Bandpass solve completed')
        print(f'   Output table: {bp_tables[0] if bp_tables else "None"}')
        
        # Check bandpass quality
        if bp_tables:
            try:
                from dsa110_contimg.qa.calibration_quality import \
                  validate_caltable_quality
                metrics = validate_caltable_quality(bp_tables[0])
                print(f'\n3. Bandpass Quality Metrics:')
                print(f'   Flagged fraction: {metrics.fraction_flagged*100:.1f}%')
                print(f'   Median SNR: {metrics.median_snr:.2f}')
                if metrics.fraction_flagged < 0.5:
                    print('   :check_mark: Bandpass solutions look good (<50% flagged)')
                elif metrics.fraction_flagged < 0.7:
                    print('   :warning_sign: Moderate flagging rate (50-70%)')
                else:
                    print('   :ballot_x: High flagging rate (>70%)')
            except Exception as e:
                print(f'   Could not compute quality metrics: {e}')
                
    except Exception as e:
        print(f':ballot_x: Bandpass solve failed: {e}')
        import traceback
        traceback.print_exc()
        sys.exit(1)
    
    print('\n' + '=' * 70)
    print('Bandpass solve complete!')
    print('=' * 70)

if __name__ == '__main__':
    main()

