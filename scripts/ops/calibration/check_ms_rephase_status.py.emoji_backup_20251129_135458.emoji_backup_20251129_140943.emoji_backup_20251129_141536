#!/opt/miniforge/envs/casa6/bin/python
"""
Check if MS is safe to use with --skip-rephase workflow.

This script checks:
1. Current MS phase center (meridian vs calibrator)
2. Whether rephasing was done
3. Whether it's safe to skip rephasing

Usage:
    python check_ms_rephase_status.py <ms_path> [cal_ra_deg] [cal_dec_deg]
    
Example:
    python check_ms_rephase_status.py /stage/dsa110-contimg/ms/2025-10-29T13:54:17.ms 128.7287 55.5725
"""

import sys

import astropy.units as u
import numpy as np
from astropy.coordinates import SkyCoord
from casacore.tables import table


def check_ms_rephase_status(ms_path, cal_ra_deg=None, cal_dec_deg=None):
    """Check if MS is safe to use with --skip-rephase."""
    
    print("=" * 100)
    print(f"Checking MS Rephase Status: {ms_path}")
    print("=" * 100)
    
    # Check phase center
    with table(f"{ms_path}::FIELD", readonly=True) as field_tb:
        n_fields = field_tb.nrows()
        print(f"\nNumber of fields: {n_fields}")
        
        ref_dirs = field_tb.getcol("REFERENCE_DIR")
        phase_dirs = field_tb.getcol("PHASE_DIR")
        
        # Check if REFERENCE_DIR and PHASE_DIR match
        ref_match = np.allclose(ref_dirs, phase_dirs, rtol=1e-10)
        
        print(f"\nREFERENCE_DIR vs PHASE_DIR:")
        print(f"  Match: {ref_match}")
        
        # Get phase center for field 0
        ref_ra_rad = ref_dirs[0][0][0]
        ref_dec_rad = ref_dirs[0][0][1]
        phase_ra_rad = phase_dirs[0][0][0]
        phase_dec_rad = phase_dirs[0][0][1]
        
        ref_ra_deg = np.degrees(ref_ra_rad)
        ref_dec_deg = np.degrees(ref_dec_rad)
        phase_ra_deg = np.degrees(phase_ra_rad)
        phase_dec_deg = np.degrees(phase_dec_rad)
        
        print(f"\nField 0 Phase Center:")
        print(f"  REFERENCE_DIR: RA={ref_ra_deg:.6f}°, Dec={ref_dec_deg:.6f}°")
        print(f"  PHASE_DIR:     RA={phase_ra_deg:.6f}°, Dec={phase_dec_deg:.6f}°")
        
        # Check if calibrator position provided
        if cal_ra_deg is not None and cal_dec_deg is not None:
            print(f"\nCalibrator Position:")
            print(f"  RA={cal_ra_deg:.6f}°, Dec={cal_dec_deg:.6f}°")
            
            # Calculate separation
            ref_coord = SkyCoord(ra=ref_ra_deg * u.deg, dec=ref_dec_deg * u.deg, frame='icrs')
            phase_coord = SkyCoord(ra=phase_ra_deg * u.deg, dec=phase_dec_deg * u.deg, frame='icrs')
            cal_coord = SkyCoord(ra=cal_ra_deg * u.deg, dec=cal_dec_deg * u.deg, frame='icrs')
            
            ref_sep = ref_coord.separation(cal_coord)
            phase_sep = phase_coord.separation(cal_coord)
            
            ref_sep_arcmin = ref_sep.arcmin
            phase_sep_arcmin = phase_sep.arcmin
            
            print(f"\nSeparation from Calibrator:")
            print(f"  REFERENCE_DIR: {ref_sep_arcmin:.2f} arcmin")
            print(f"  PHASE_DIR:     {phase_sep_arcmin:.2f} arcmin")
            
            # Determine if MS is phased to calibrator or meridian
            if ref_sep_arcmin < 1.0 and phase_sep_arcmin < 1.0:
                print(f"\n:check_mark: MS is phased to CALIBRATOR position (< 1 arcmin)")
                print(f"  :arrow_right: NOT SAFE to use --skip-rephase")
                print(f"  :arrow_right: MS needs to be rephased BACK to meridian, OR")
                print(f"  :arrow_right: Use rephasing workflow (default)")
            elif ref_sep_arcmin > 10.0 and phase_sep_arcmin > 10.0:
                print(f"\n:check_mark: MS is phased to MERIDIAN position (> 10 arcmin from calibrator)")
                print(f"  :arrow_right: SAFE to use --skip-rephase")
                print(f"  :arrow_right: ft() will work correctly with meridian phase center")
            else:
                print(f"\n:warning_sign: MS phase center is INTERMEDIATE (between meridian and calibrator)")
                print(f"  :arrow_right: Uncertain - check manually")
        else:
            print(f"\n:warning_sign: No calibrator position provided")
            print(f"  :arrow_right: Cannot determine if MS is phased to calibrator or meridian")
            print(f"  :arrow_right: Provide calibrator RA/Dec to check")
    
    # Check if MODEL_DATA exists and its phase structure
    print(f"\n" + "=" * 100)
    print("MODEL_DATA Status")
    print("=" * 100)
    try:
        with table(ms_path, readonly=True) as tb:
            if "MODEL_DATA" in tb.colnames():
                print(f"  :check_mark: MODEL_DATA column exists")
                
                # Sample MODEL_DATA phase scatter
                n_sample = min(5000, tb.nrows())
                model_data = tb.getcol("MODEL_DATA", startrow=0, nrow=n_sample)
                flags = tb.getcol("FLAG", startrow=0, nrow=n_sample)
                
                unflagged_mask = ~flags.any(axis=(1, 2))
                if unflagged_mask.sum() > 0:
                    model_unflagged = model_data[unflagged_mask]
                    model_phases = np.angle(model_unflagged[:, 0, 0])
                    model_phases_deg = np.degrees(model_phases)
                    model_phases_deg = (model_phases_deg + 180) % 360 - 180  # Wrap to [-180, 180]
                    model_phase_scatter = np.std(model_phases_deg)
                    
                    print(f"  Phase scatter: {model_phase_scatter:.2f}°")
                    
                    if model_phase_scatter < 10:
                        print(f"  :check_mark: Low phase scatter - MODEL_DATA correctly phased")
                    elif model_phase_scatter > 100:
                        print(f"  :ballot_x: High phase scatter - MODEL_DATA may be incorrectly phased")
                        print(f"    This suggests MS was rephased but ft() used wrong phase center")
                else:
                    print(f"  :warning_sign: All MODEL_DATA is flagged - cannot check phase structure")
            else:
                print(f"  :warning_sign: MODEL_DATA column does not exist")
                print(f"  :arrow_right: Will be populated during calibration")
    except Exception as e:
        print(f"  ERROR: Could not check MODEL_DATA: {e}")
    
    # Summary
    print(f"\n" + "=" * 100)
    print("Summary")
    print("=" * 100)
    
    if cal_ra_deg is not None and cal_dec_deg is not None:
        if ref_sep_arcmin < 1.0:
            print(f":warning_sign: MS is ALREADY REPHASED to calibrator position")
            print(f"  :arrow_right: Using --skip-rephase will NOT help")
            print(f"  :arrow_right: Options:")
            print(f"     1. Use default workflow (rephasing enabled)")
            print(f"     2. Rephase BACK to meridian first, then use --skip-rephase")
        elif ref_sep_arcmin > 10.0:
            print(f":check_mark: MS is at MERIDIAN phase center")
            print(f"  :arrow_right: SAFE to use --skip-rephase")
            print(f"  :arrow_right: ft() will work correctly")
        else:
            print(f":warning_sign: MS phase center is INTERMEDIATE")
            print(f"  :arrow_right: Manual verification needed")
    else:
        print(f":warning_sign: Cannot determine safety without calibrator position")
        print(f"  :arrow_right: Provide calibrator RA/Dec to check")
    
    print("=" * 100)

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(__doc__)
        sys.exit(1)
    
    ms_path = sys.argv[1]
    cal_ra_deg = float(sys.argv[2]) if len(sys.argv) > 2 else None
    cal_dec_deg = float(sys.argv[3]) if len(sys.argv) > 3 else None
    
    check_ms_rephase_status(ms_path, cal_ra_deg, cal_dec_deg)

