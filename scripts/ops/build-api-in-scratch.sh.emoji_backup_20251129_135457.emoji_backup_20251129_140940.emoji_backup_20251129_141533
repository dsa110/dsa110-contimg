#!/bin/bash
# Build API Docker image in /scratch/ for faster I/O
# Only copies minimal files needed for Docker build (src/, scripts/, ops/, environment.yml)

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SCRATCH_DIR="/scratch/dsa110-contimg-build/api"

echo ":hammer: Building API Docker image in /scratch/ for faster I/O..."
echo "   Source: $PROJECT_ROOT"
echo "   Scratch: $SCRATCH_DIR"

# Check if /scratch/ is available
if [ ! -d "/scratch" ]; then
    echo ":cross_mark: Error: /scratch/ directory not available"
    echo "   Falling back to building in /data/..."
    cd "$PROJECT_ROOT"
    docker compose build api "$@"
    exit $?
fi

# Create scratch directory structure
mkdir -p "$SCRATCH_DIR/ops/docker"
mkdir -p "$SCRATCH_DIR/src"
mkdir -p "$SCRATCH_DIR/scripts"
mkdir -p "$SCRATCH_DIR/ops"

echo ":package: Copying minimal build context to /scratch/..."
# Copy only what Dockerfile needs (from Dockerfile: COPY ops/docker/environment.yml, COPY src, COPY scripts, COPY ops)
# Exclude cache directories and build artifacts for faster rsync
rsync -av --delete \
    --exclude '__pycache__' \
    --exclude '*.pyc' \
    --exclude '.mypy_cache' \
    --exclude '.pytest_cache' \
    --exclude '.ruff_cache' \
    --exclude '*.egg-info' \
    --exclude '.coverage' \
    --exclude 'htmlcov' \
    "$PROJECT_ROOT/src/" "$SCRATCH_DIR/src/" \
    "$PROJECT_ROOT/scripts/" "$SCRATCH_DIR/scripts/" \
    "$PROJECT_ROOT/ops/" "$SCRATCH_DIR/ops/"

# Copy docker-compose.yml for build context
cp "$PROJECT_ROOT/docker-compose.yml" "$SCRATCH_DIR/"

echo ":spouting_whale: Building Docker image in /scratch/..."
cd "$SCRATCH_DIR"

# Enable BuildKit for better progress output
export DOCKER_BUILDKIT=1
export BUILDKIT_PROGRESS=plain

# Show start time
START_TIME=$(date +%s)
echo "   Started at: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# Build using the scratch directory as context with progress output
# Use 'tty' progress for interactive terminal, 'plain' for logs
if [ -t 1 ]; then
    # Interactive terminal - use tty progress with colors
    docker compose build \
        --progress=tty \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        api "$@"
else
    # Non-interactive (e.g., in script) - use plain progress with timestamps
    docker compose build \
        --progress=plain \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        api "$@" 2>&1 | while IFS= read -r line; do
        echo "[$(date '+%H:%M:%S')] $line"
    done
fi

# Show elapsed time
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
MINUTES=$((ELAPSED / 60))
SECONDS=$((ELAPSED % 60))
echo ""
echo "   Completed at: $(date '+%Y-%m-%d %H:%M:%S')"
echo "   Build time: ${MINUTES}m ${SECONDS}s"

echo ":white_heavy_check_mark: Build complete!"
echo "   Docker image is now in Docker's registry"
echo "   You can start it with: cd $PROJECT_ROOT && docker compose up -d api"

# Cleanup scratch directory
echo ":broom: Cleaning up /scratch/ build directory..."
rm -rf "$SCRATCH_DIR"

echo ":sparkles: Done!"

